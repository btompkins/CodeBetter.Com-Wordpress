<!DOCTYPE html>
<html dir="ltr" lang="en-US">
<head>
	<meta charset="UTF-8" />
    <title>F# and the Dynamic Lookup Operator ala C# | Matthew Podwysocki</title>
	<link rel="profile" href="http://gmpg.org/xfn/11" />
	
	<link href="http://feeds.feedburner.com/CodeBetter" title="CodeBetter.Com &raquo; Feed" type="application/rss+xml" rel="alternate">
	
		<link rel="pingback" href="http://codebetter.com/matthewpodwysocki/xmlrpc.php" />
	                <link rel="stylesheet" href="http://cdn1.codebetter.com/wp-content/uploads/spacker-cache/ea73517eb74a545f51c376487c94dc9f.css?v=3912785705" type="text/css" media="all" /><!-- Is Cache! -->
                <script type='text/javascript' src='https://ajax.googleapis.com/ajax/libs/jquery/1.6.0/jquery.min.js?ver=3.4.2'></script>
<script type='text/javascript' src='http://dtym7iokkjlif.cloudfront.net/dough/1.0/recipe.js'></script>
<link rel="EditURI" type="application/rsd+xml" title="RSD" href="http://codebetter.com/matthewpodwysocki/xmlrpc.php?rsd" />
<link rel="wlwmanifest" type="application/wlwmanifest+xml" href="http://cdn1.codebetter.com/wp-includes/wlwmanifest.xml" /> 
<link rel='prev' title='Exploring MongoDB with F#' href='http://codebetter.com/matthewpodwysocki/2010/02/09/exploring-mongodb-with-f/' />
<link rel='next' title='Upcoming Release of F# 2.0' href='http://codebetter.com/matthewpodwysocki/2010/02/10/upcoming-release-of-f-2-0/' />
<meta name="generator" content="WordPress 3.4.2" />
<link rel='shortlink' href='http://codebetter.com/matthewpodwysocki/?p=199' />

<!-- All in One SEO Pack 1.6.13.2 by Michael Torbert of Semper Fi Web Design[83,152] -->
<link rel="canonical" href="http://codebetter.com/matthewpodwysocki/2010/02/10/f-and-the-dynamic-lookup-operator-ala-c/" />
<!-- /all in one seo pack -->
<link rel="stylesheet" href="http://cdn1.codebetter.com/wp-content/plugins/digg-digg/include/../css/diggdigg-style.css?ver=4.5.3.3" type="text/css" media="screen" />

<!-- Start Shareaholic OgTags -->

	<!-- Shareaholic Notice: There is neither a featured nor gallery image set -->

<!-- End Shareaholic OgTags -->

<meta id="syntaxhighlighteranchor" name="syntaxhighlighter-version" content="3.1.3" />
                <script type="text/javascript" src="http://cdn1.codebetter.com/wp-content/uploads/spacker-cache/dc168cf39155d7b5d39f696ca94d5980.js?v=5302176208">/*Is Cache!*/</script>
                	
	<script type='text/javascript' src='http://d1.openx.org/spcjs.php?id=7744&amp;target=_blank'></script>
	<style type="text/css">body { padding-top:0px !important; } html { margin-top: 0px !important; }</style>
<!-- BuySellAds Ad Code -->
<script type="text/javascript">
(function(){
  var bsa = document.createElement('script');
     bsa.type = 'text/javascript';
     bsa.async = true;
     bsa.src = 'http://s3.buysellads.com/ac/bsa.js';
  (document.getElementsByTagName('head')[0]||document.getElementsByTagName('body')[0]).appendChild(bsa);
})();
</script>
<!-- End BuySellAds Ad Code -->
</head>

<body>

			
		<div class="container_12 ui-tabs ui-widget ui-widget-content ui-corner-all" id="tabs">			
			<ul class="ui-tabs-nav ui-helper-reset ui-helper-clearfix ui-widget-header ui-corner-all">
				<li class="ui-state-default ui-corner-top ui-tabs-selected ui-state-active"><a href="#ui-tabs-1">CodeBetter.Com</a></li>
				<li class="ui-state-default ui-corner-top"><a href="http://devlicio.us">Devlicio.Us</a></li>				
				<div id="top-search">
				<form action="http://codebetter.com/globalsearch/" id="cse-search-box">
  <div>
   <fieldset id="search">
		<input type="hidden" name="cx" value="005178204031477491434:2bg5jtwgsfe" />
		<input type="hidden" name="cof" value="FORID:9" />
		<input type="hidden" name="ie" value="UTF-8" />
		<input type="text"  class="text-input" id="s" name="q" size="31" />
		<input type="image" src="http://cdn1.codebetter.com/wp-content/themes/codebetter/images/search-img.png" class="form-button" id="searchsubmit" value="GO" name="">				   	
	</fieldset>
  </div>
</form>
<script type="text/javascript" src="http://www.google.com/cse/brand?form=cse-search-box&lang=en&sitesearch=true"></script>
				</div>				
			</ul><div id="ui-tabs-1" class="ui-tabs-panel ui-widget-content ui-corner-bottom"></div><div id="ui-tabs-2" class="ui-tabs-panel ui-widget-content ui-corner-bottom ui-tabs-hide"></div>
		</div>
			
		<div id="main" class="container_12">
		
			<div id="logo" class="grid_3"><a href="/" title="CodeBetter.Com - Stuff you need to Code Better!"><image src="http://cdn1.codebetter.com/wp-content/themes/codebetter/images/codebetter_logo.png" height="48" width="223"></image></a></div>
			<div id="ad_leaderboard" class="grid_9">
			<!-- BuySellAds Zone Code -->
<div id="bsap_1276080" class="bsarocks bsap_4fe632babdccc2b4b049e4f08cc3c549"></div>
<!-- End BuySellAds Zone Code --></div>
			
			<div id="globalNav" class="grid_12">
				<ul>
					<li><a href="http://codebetter.com" title="home">Home</a></li>
					<li class="page_item page-item-2"><a href="http://codebetter.com/about/">About</a></li>
<li class="page_item page-item-8"><a href="http://codebetter.com/codebetter-ci/">CodeBetter CI</a></li>
<li class="page_item page-item-6"><a href="http://codebetter.com/community/">Community</a></li>
<li class="page_item page-item-10"><a href="http://codebetter.com/editors/">Editors</a></li>
					<li><a href="http://feeds.feedburner.com/CodeBetter" rel="alternate" type="application/rss+xml"><img src="http://www.feedburner.com/fb/images/pub/feed-icon16x16.png" alt="" style="vertical-align:middle;border:0"/></a><a href="http://feeds.feedburner.com/CodeBetter"><img src="http://feeds.feedburner.com/~fc/CodeBetter?bg=EFEFEF&amp;fg=2E9BD2&amp;anim=1" height="26" width="88" style="vertical-align:middle;border:0"/></a></li>
				</ul>
								
			</div><!-- end div#globalNav.container_12 -->				
	
		<div id="content" class="container_12">
			<div id="main" class="grid_8">


				<div id="post-199" class="post-199 post type-post status-publish format-standard hentry category-c category-dlr category-f">
					<h1 class="entry-title">F# and the Dynamic Lookup Operator ala C#</h1>

					<div class="entry-meta">
						<span class="meta-prep meta-prep-author">Posted by </span>
						<span class="author vcard"><a class="url fn n" href="http://codebetter.com/matthewpodwysocki/author/matthewpodwysocki/" title="View all posts by Matthew Podwysocki">Matthew Podwysocki</a></span>
						<span class="meta-sep"> on  </span>
						<a href="http://codebetter.com/matthewpodwysocki/2010/02/10/f-and-the-dynamic-lookup-operator-ala-c/" title="7:24 pm" rel="bookmark"><span class="entry-date">February 10, 2010</span></a>
											</div><!-- .entry-meta -->

					<div class="entry-content">
						<div id="greet_block"><noscript><div class="greet_block wpgb_cornered"><div class="greet_text"><div class="greet_image"><a href="http://codebetter.com/matthewpodwysocki/feed/rss/"  rel="nofollow"><img src="http://cdn1.codebetter.com/wp-content/plugins/wp-greet-box/images/rss_icon.png" alt="WP Greet Box icon"/></a></div>Hello there! If you are new here, you might want to <a href="http://codebetter.com/matthewpodwysocki/feed/rss/" rel="nofollow"><strong>subscribe to the RSS feed</strong></a> for updates on this topic.<div style="clear:both"></div><div class="greet_block_powered_by">Powered by <a href="http://omninoggin.com/projects/wordpress-plugins/wp-greet-box-wordpress-plugin/" title="WP Greet Box WordPress Plugin" style="text-decoration:none;">WP Greet Box</a> <a href="http://omninoggin.com/" title="WordPress Plugin" style="text-decoration:none;">WordPress Plugin</a></div><div style="clear:both"></div></div></div></noscript></div><!-- Start Shareaholic LikeButtonSetTop Automatic --><!-- End Shareaholic LikeButtonSetTop Automatic --><p>In <a href="http://codebetter.com/blogs/matthew.podwysocki/archive/2010/02/09/exploring-mongodb-with-f.aspx">the previous post</a>, we covered various scenarios around how we’d make the syntax around using the MongoDB C# Driver a little nicer and less stringy.&#160; And before that we looked at <a href="http://codebetter.com/blogs/matthew.podwysocki/archive/2010/02/05/using-and-abusing-the-f-dynamic-lookup-operator.aspx">using and abusing these so called dynamic lookup operators</a>.&#160; In the F# language, we have the ability to define two “dynamic” operators, a get member operator denoted by the ( ? ), and the set member operator denoted by the ( ?&lt;- ).&#160; The F# language and its associated libraries do not have an actual implementation of these operators, but instead allow you to implement them as you see fit.&#160; Previously, we tried two approaches…</p>
<h2>Where We’ve Come From</h2>
<p>We covered two basic scenarios, both of which have their plusses and minuses.&#160; The first approach was to wrap all calls to the get ( ? ) and set ( ?&lt;- ) operators around the use of an IDictionary instance.&#160; The idea is that we treat the keys in the hash as if they were actual public members of our class.&#160; We can enable this behavior by implementing the operators as such:</p>
<div style="padding-bottom: 0px;margin: 0px;padding-left: 0px;padding-right: 0px;float: none;padding-top: 0px" class="wlWriterEditableSmartContent">
<pre style="background-color:#FFFFFF;overflow: auto"><span style="color: #0000FF">let</span><span style="color: #000000"> (</span><span style="color: #000000">?</span><span style="color: #000000">) (target : IDictionary</span><span style="color: #000000">&lt;</span><span style="color: #0000FF">string</span><span style="color: #000000">,</span><span style="color: #800000">'</span><span style="color: #800000">Value&gt;) targetKey =</span><span style="color: #800000">
</span><span style="color: #000000">  target.[targetKey]

</span><span style="color: #0000FF">let</span><span style="color: #000000"> (</span><span style="color: #000000">?&lt;-</span><span style="color: #000000">) (target : IDictionary</span><span style="color: #000000">&lt;</span><span style="color: #0000FF">string</span><span style="color: #000000">, </span><span style="color: #800000">'</span><span style="color: #800000">Value&gt;) targetKey value =</span><span style="color: #800000">
</span><span style="color: #000000">  target.[targetKey] </span><span style="color: #000000">&lt;-</span><span style="color: #000000"> value</span></pre>
<p><!-- Code inserted with Steve Dunn's Windows Live Writer Code Formatter Plugin.  http://dunnhq.com --></div>
<p>That allows for some simple behavior such as getting and setting values in a Dictionary.</p>
<div style="padding-bottom: 0px;margin: 0px;padding-left: 0px;padding-right: 0px;float: none;padding-top: 0px" class="wlWriterEditableSmartContent">
<pre style="background-color:#FFFFFF;overflow: auto"><span style="color: #0000FF">let</span><span style="color: #000000"> d </span><span style="color: #000000">=</span><span style="color: #000000"> Dictionary</span><span style="color: #000000">&lt;</span><span style="color: #0000FF">string</span><span style="color: #000000">, Dictionary</span><span style="color: #000000">&lt;</span><span style="color: #0000FF">string</span><span style="color: #000000">, </span><span style="color: #0000FF">string</span><span style="color: #000000">&gt;&gt;</span><span style="color: #000000">()

d</span><span style="color: #000000">?</span><span style="color: #000000">Value1 </span><span style="color: #000000">&lt;-</span><span style="color: #000000"> Dictionary</span><span style="color: #000000">&lt;</span><span style="color: #0000FF">string</span><span style="color: #000000">, </span><span style="color: #0000FF">string</span><span style="color: #000000">&gt;</span><span style="color: #000000">()
d</span><span style="color: #000000">?</span><span style="color: #000000">Value1</span><span style="color: #000000">?</span><span style="color: #000000">Value2 </span><span style="color: #000000">&lt;-</span><span style="color: #000000"> </span><span style="color: #800000">"</span><span style="color: #800000">Dynamic!</span><span style="color: #800000">"</span><span style="color: #000000"> 

printfn </span><span style="color: #800000">"</span><span style="color: #800000">Value: %s</span><span style="color: #800000">"</span><span style="color: #000000"> d</span><span style="color: #000000">?</span><span style="color: #000000">Value1</span><span style="color: #000000">?</span><span style="color: #000000">Value2 </span><span style="color: #008000">//</span><span style="color: #008000"> prints Value: Dynamic!</span></pre>
<p><!-- Code inserted with Steve Dunn's Windows Live Writer Code Formatter Plugin.  http://dunnhq.com --></div>
<p>This could be useful in quite a few scenarios, especially given that the MongoDB C# Driver’s Document class is based off an IDictionary.&#160; Just as well, you might imagine dealing with configuration values in a more DSL like fashion instead of indexer property syntax.&#160; But, I think we could do better than this.</p>
<p>The next idea was to use member restrictions to put some syntactic sugar around indexer properties.&#160; This way, any class which has the Item or this property in C#, could take advantage.&#160; As you may remember, member restrictions are a way of providing a form of duck typing, which is to allow us to restrict parameters based upon their method signatures.&#160; We could enable this kind of feature by implementing the operators as such:</p>
<div style="padding-bottom: 0px;margin: 0px;padding-left: 0px;padding-right: 0px;float: none;padding-top: 0px" class="wlWriterEditableSmartContent">
<pre style="background-color:#FFFFFF;overflow: auto"><span style="color: #0000FF">let</span><span style="color: #000000"> </span><span style="color: #0000FF">inline</span><span style="color: #000000"> (</span><span style="color: #000000">?</span><span style="color: #000000">) this key </span><span style="color: #000000">=</span><span style="color: #000000">
  ( </span><span style="color: #000000">^</span><span style="color: #000000">a : (</span><span style="color: #0000FF">member</span><span style="color: #000000"> get_Item : </span><span style="color: #000000">^</span><span style="color: #000000">b </span><span style="color: #0000FF">-&gt;</span><span style="color: #000000"> </span><span style="color: #000000">^</span><span style="color: #000000">c) (this,key))
 
</span><span style="color: #0000FF">let</span><span style="color: #000000"> </span><span style="color: #0000FF">inline</span><span style="color: #000000"> (</span><span style="color: #000000">?&lt;-</span><span style="color: #000000">) this key value </span><span style="color: #000000">=</span><span style="color: #000000">
  ( </span><span style="color: #000000">^</span><span style="color: #000000">a : (</span><span style="color: #0000FF">member</span><span style="color: #000000"> set_Item : </span><span style="color: #000000">^</span><span style="color: #000000">b </span><span style="color: #000000">*</span><span style="color: #000000"> </span><span style="color: #000000">^</span><span style="color: #000000">c </span><span style="color: #0000FF">-&gt;</span><span style="color: #000000"> </span><span style="color: #000000">^</span><span style="color: #000000">d) (this,key,value))</span></pre>
<p><!-- Code inserted with Steve Dunn's Windows Live Writer Code Formatter Plugin.  http://dunnhq.com --></div>
<p>And once again, this enables our same example above as the IDictionary&lt;Key,Value&gt; has an Item property.&#160; But this comes with quite a few downsides that I’ve already mentioned, and in fact the F# compiler warms that you might be stepping into trouble while doing so.&#160; So, what other options do we have?</p>
<h2>Where We’re Going</h2>
<p>What about some of the features that are coming in .NET 4.0 revolving around the System.Dynamic namespace?&#160; Could we in fact take advantage of some of the work done there to enable dynamic behavior in our operators?&#160; The answer is unsurprisingly yes, although there is a little work, so prepare to get your hands a little dirty.&#160; In order to make this work, we’re going to need to understand how <a href="http://msdn.microsoft.com/en-us/library/dd264736(VS.100).aspx">dynamic</a> works in C# 4.0 as well as a bit about the Dynamic Language Runtime (DLR).&#160; So, read up there just a little bit and come back.&#160; I’ll wait…&#160; Just as well, we’re going to need two classes in particular, <a href="http://msdn.microsoft.com/en-us/library/dd402854(VS.100).aspx">System.Runtime.CompilerServices.CallSite&lt;T&gt;</a> and <a href="http://msdn.microsoft.com/en-us/library/microsoft.csharp.runtimebinder.binder(VS.100).aspx">Microsoft.CSharp.RuntimeBinder.Binder</a>, so best to study what they are what and they do (albeit limited in documentation as they are).</p>
<p>For example, if we have an object which inherits from System.Dynamic.DynamicObject and we’d like to use the TryGetMember and TrySetMember, how could we do it?</p>
<div style="padding-bottom: 0px;margin: 0px;padding-left: 0px;padding-right: 0px;float: none;padding-top: 0px" class="wlWriterEditableSmartContent">
<pre style="background-color:#FFFFFF;overflow: auto"><span style="color: #0000FF">type</span><span style="color: #000000"> DynamicDictionary() </span><span style="color: #000000">=</span><span style="color: #000000">
  inherit DynamicObject()

  </span><span style="color: #0000FF">let</span><span style="color: #000000"> dictionary </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #0000FF">new</span><span style="color: #000000"> Dictionary</span><span style="color: #000000">&lt;</span><span style="color: #0000FF">string</span><span style="color: #000000">, obj</span><span style="color: #000000">&gt;</span><span style="color: #000000">()

  </span><span style="color: #0000FF">override</span><span style="color: #000000"> __.TryGetMember(binder : GetMemberBinder, result : byref</span><span style="color: #000000">&lt;</span><span style="color: #000000">obj</span><span style="color: #000000">&gt;</span><span style="color: #000000">) </span><span style="color: #000000">=</span><span style="color: #000000">
    </span><span style="color: #0000FF">if</span><span style="color: #000000"> dictionary.ContainsKey binder.Name </span><span style="color: #0000FF">then</span><span style="color: #000000">
      result </span><span style="color: #000000">&lt;-</span><span style="color: #000000"> dictionary.[binder.Name]
      </span><span style="color: #0000FF">true</span><span style="color: #000000">
    </span><span style="color: #0000FF">else</span><span style="color: #000000"> </span><span style="color: #0000FF">base</span><span style="color: #000000">.TryGetMember(binder, </span><span style="color: #000000">&amp;</span><span style="color: #000000">result)

  </span><span style="color: #0000FF">override</span><span style="color: #000000"> __.TrySetMember(binder : SetMemberBinder, value : obj) </span><span style="color: #000000">=</span><span style="color: #000000">
    dictionary.[binder.Name] </span><span style="color: #000000">&lt;-</span><span style="color: #000000"> value
    </span><span style="color: #0000FF">true</span></pre>
<p><!-- Code inserted with Steve Dunn's Windows Live Writer Code Formatter Plugin.  http://dunnhq.com --></div>
<p>Or just as well, could we enable the behavior on the System.Dynamic.ExpandoObject as well?&#160; </p>
<p>Let’s first tackle the get member operator.&#160; To enable this feature, we’re going to use the work that the C# team has done for us.&#160; What I mean by that is that we’re going to use the binders that C# uses for the DLR.&#160; So, if you’re following along at home with me, add a reference to Microsoft.CSharp.dll or observe in the code below and open the following namespaces.</p>
<div style="padding-bottom: 0px;margin: 0px;padding-left: 0px;padding-right: 0px;float: none;padding-top: 0px" class="wlWriterEditableSmartContent">
<pre style="background-color:#FFFFFF;overflow: auto"><span style="color: #0000FF">#if</span><span style="color: #000000"> INTERACTIVE</span><span style="color: #000000">
#r </span><span style="color: #800000">"</span><span style="color: #800000">Microsoft.CSharp.dll</span><span style="color: #800000">"</span><span style="color: #000000">
</span><span style="color: #0000FF">#endif</span><span style="color: #000000">

</span><span style="color: #0000FF">open</span><span style="color: #000000"> System
</span><span style="color: #0000FF">open</span><span style="color: #000000"> System.Dynamic
</span><span style="color: #0000FF">open</span><span style="color: #000000"> System.Linq.Expressions
</span><span style="color: #0000FF">open</span><span style="color: #000000"> System.Reflection
</span><span style="color: #0000FF">open</span><span style="color: #000000"> System.Runtime.CompilerServices
</span><span style="color: #0000FF">open</span><span style="color: #000000"> Microsoft.CSharp.RuntimeBinder
</span><span style="color: #0000FF">open</span><span style="color: #000000"> Microsoft.FSharp.Reflection</span></pre>
<p><!-- Code inserted with Steve Dunn's Windows Live Writer Code Formatter Plugin.  http://dunnhq.com --></div>
<p>The next thing we’re going to do is create our method signature which takes in our object to invoke and a string target member, and we’re going to return a ‘TargetResult.&#160; This result could be simply a property name such as “Value”, or it could be an actual method such as Substring(0, 3).&#160; </p>
<div style="padding-bottom: 0px;margin: 0px;padding-left: 0px;padding-right: 0px;float: none;padding-top: 0px" class="wlWriterEditableSmartContent">
<pre style="background-color:#FFFFFF;overflow: auto"><span style="color: #0000FF">let</span><span style="color: #000000"> (</span><span style="color: #000000">?</span><span style="color: #000000">)  (targetObject : obj) (targetMember:</span><span style="color: #0000FF">string</span><span style="color: #000000">)  : </span><span style="color: #800000">'</span><span style="color: #800000">TargetResult  = </span><span style="color: #800000">
</span><span style="color: #000000">  </span><span style="color: #0000FF">let</span><span style="color: #000000"> targetResultType </span><span style="color: #000000">=</span><span style="color: #000000"> typeof</span><span style="color: #000000">&lt;</span><span style="color: #800000">'</span><span style="color: #800000">TargetResult&gt;</span></pre>
<p><!-- Code inserted with Steve Dunn's Windows Live Writer Code Formatter Plugin.  http://dunnhq.com --></div>
<p>Once we have established the type, we can take one of two paths.&#160; Either our result type is a value such as string, integer, etc, or it is a function, and the two of them must be handled differently.&#160; Let’s take the case of the value return first.</p>
<div style="padding-bottom: 0px;margin: 0px;padding-left: 0px;padding-right: 0px;float: none;padding-top: 0px" class="wlWriterEditableSmartContent">
<pre style="background-color:#FFFFFF;overflow: auto"><span style="color: #000000">  </span><span style="color: #0000FF">if</span><span style="color: #000000"> not (FSharpType.IsFunction targetResultType) </span><span style="color: #0000FF">then</span><span style="color: #000000"> 
        
    </span><span style="color: #0000FF">let</span><span style="color: #000000"> argInfos </span><span style="color: #000000">=</span><span style="color: #000000"> [</span><span style="color: #000000">|</span><span style="color: #000000"> CSharpArgumentInfo.Create(CSharpArgumentInfoFlags.None, 
                                                </span><span style="color: #0000FF">null</span><span style="color: #000000">) </span><span style="color: #000000">|</span><span style="color: #000000">]
    </span><span style="color: #0000FF">let</span><span style="color: #000000"> getMemberBinder </span><span style="color: #000000">=</span><span style="color: #000000"> Binder.GetMember(CSharpBinderFlags.None, 
                                           targetMember, 
                                           </span><span style="color: #0000FF">null</span><span style="color: #000000">, 
                                           argInfos)
    </span><span style="color: #0000FF">let</span><span style="color: #000000"> cs </span><span style="color: #000000">=</span><span style="color: #000000"> CallSite</span><span style="color: #000000">&lt;</span><span style="color: #000000">Func</span><span style="color: #000000">&lt;</span><span style="color: #000000">CallSite, obj, obj</span><span style="color: #000000">&gt;&gt;</span><span style="color: #000000">.Create(getMemberBinder)
    cs.Target.Invoke(cs, targetObject) </span><span style="color: #000000">|&gt;</span><span style="color: #000000"> unbox</span></pre>
<p><!-- Code inserted with Steve Dunn's Windows Live Writer Code Formatter Plugin.  http://dunnhq.com --></div>
<p>To determine whether our result type is not a function, we can call the FSharpType.IsFunction method from the Microsoft.FSharp.Reflection namespace.&#160; Inside, we create an array of CSharpArgumentInfos with no additional information nor name.&#160; Next, we create a get member binder with no additional information, our target member, no context, and our argInfos from above.&#160; After that we create our CallSite of a function that takes a CallSite and an object and returns an object with our getMemberBinder.&#160; Finally, we invoke the target of our CallSite with our CallSite and our target object and cast it to our ‘TargetResult.&#160; With this functionality implemented so far, we’ve enabled the following:</p>
<div style="padding-bottom: 0px;margin: 0px;padding-left: 0px;padding-right: 0px;float: none;padding-top: 0px" class="wlWriterEditableSmartContent">
<pre style="background-color:#FFFFFF;overflow: auto"><span style="color: #0000FF">let</span><span style="color: #000000"> len : </span><span style="color: #0000FF">int</span><span style="color: #000000"> </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #800000">"</span><span style="color: #800000">dynamic</span><span style="color: #800000">"</span><span style="color: #000000">?</span><span style="color: #000000">Length

</span><span style="color: #0000FF">let</span><span style="color: #000000"> now : DateTime </span><span style="color: #000000">=</span><span style="color: #000000"> DateTime</span><span style="color: #000000">?</span><span style="color: #000000">Now

</span><span style="color: #0000FF">let</span><span style="color: #000000"> e </span><span style="color: #000000">=</span><span style="color: #000000"> System.Dynamic.ExpandoObject()
e</span><span style="color: #000000">?</span><span style="color: #000000">Dynamic </span><span style="color: #000000">&lt;-</span><span style="color: #000000"> </span><span style="color: #800000">"</span><span style="color: #800000">Totally</span><span style="color: #800000">"</span></pre>
<p><!-- Code inserted with Steve Dunn's Windows Live Writer Code Formatter Plugin.  http://dunnhq.com --></div>
<p>But not all of our dynamic invocations are going to be simple properties and since we need to enable actual functions, we need to follow a slightly more difficult path.&#160; Because F# treats functions differently than C# does, we have to create a translation layer between the languages.&#160; Therefore a little bit of work is ahead of us.</p>
<p>Let’s start down the else path.&#160; First we need to get the domain type from our function elements.&#160; This domain type could be either a tuple of multiple arguments, null (or an empty tuple) or just a single argument.&#160; We then create a domain types array based upon our domain type to ensure that we have all the parameter types.</p>
<div style="padding-bottom: 0px;margin: 0px;padding-left: 0px;padding-right: 0px;float: none;padding-top: 0px" class="wlWriterEditableSmartContent">
<pre style="background-color:#FFFFFF;overflow: auto"><span style="color: #000000">  </span><span style="color: #0000FF">else</span><span style="color: #000000">
    </span><span style="color: #0000FF">let</span><span style="color: #000000"> (domainType, _) </span><span style="color: #000000">=</span><span style="color: #000000"> FSharpType.GetFunctionElements targetResultType
    
    </span><span style="color: #0000FF">let</span><span style="color: #000000"> domainTypes </span><span style="color: #000000">=</span><span style="color: #000000"> 
        </span><span style="color: #0000FF">if</span><span style="color: #000000"> FSharpType.IsTuple domainType </span><span style="color: #0000FF">then</span><span style="color: #000000">
          FSharpType.GetTupleElements domainType 
        
        </span><span style="color: #0000FF">elif</span><span style="color: #000000"> domainType </span><span style="color: #000000">=</span><span style="color: #000000"> typeof</span><span style="color: #000000">&lt;</span><span style="color: #000000">unit</span><span style="color: #000000">&gt;</span><span style="color: #000000"> </span><span style="color: #0000FF">then</span><span style="color: #000000"> [</span><span style="color: #000000">|</span><span style="color: #000000"> </span><span style="color: #000000">|</span><span style="color: #000000">]
        
        </span><span style="color: #0000FF">else</span><span style="color: #000000"> [</span><span style="color: #000000">|</span><span style="color: #000000">domainType</span><span style="color: #000000">|</span><span style="color: #000000">]</span></pre>
<p><!-- Code inserted with Steve Dunn's Windows Live Writer Code Formatter Plugin.  http://dunnhq.com --></div>
<p>Next, we need to create a function which actually handles the handles the dynamic invocation of our target member.&#160; This is rather long code so we’ll step through it carefully.&#160; I have comments along the way to help you navigate your way.&#160; First we need to get the arguments to our function from our domain types from above.&#160; If our domain types indicate that there are no values, then we yield nothing, else if one type, wrap our argument in the array, else if it’s a tuple, then break the tuple apart into an array.&#160; Secondly, like in our value scenario, we need to create our CallSite, and call Invoke on the Target field (note field and not property) with our binder, but we can only do this via reflection because we’re dealing with a CallSite and not a CallSite&lt;T&gt; since the Target is not exposed via the CallSite, but only its generic counterpart.&#160; Just as well, we’re doing a lot of this via reflection because we don’t know what our types will be until runtime anyhow.</p>
<div style="padding-bottom: 0px;margin: 0px;padding-left: 0px;padding-right: 0px;float: none;padding-top: 0px" class="wlWriterEditableSmartContent">
<pre style="background-color:#FFFFFF;overflow: auto"><span style="color: #000000">    </span><span style="color: #0000FF">let</span><span style="color: #000000"> objToObjFunction </span><span style="color: #000000">=</span><span style="color: #000000"> 
       (</span><span style="color: #0000FF">fun</span><span style="color: #000000"> argObj </span><span style="color: #0000FF">-&gt;</span><span style="color: #000000">
       
          </span><span style="color: #008000">//</span><span style="color: #008000"> Get the real argument values</span><span style="color: #008000">
</span><span style="color: #000000">          </span><span style="color: #0000FF">let</span><span style="color: #000000"> realArgs </span><span style="color: #000000">=</span><span style="color: #000000"> 
            </span><span style="color: #0000FF">match</span><span style="color: #000000"> domainTypes </span><span style="color: #0000FF">with</span><span style="color: #000000"> 
            </span><span style="color: #000000">|</span><span style="color: #000000"> [</span><span style="color: #000000">|</span><span style="color: #000000">  </span><span style="color: #000000">|</span><span style="color: #000000">] </span><span style="color: #0000FF">-&gt;</span><span style="color: #000000"> [</span><span style="color: #000000">|</span><span style="color: #000000"> </span><span style="color: #000000">|</span><span style="color: #000000">]
            </span><span style="color: #000000">|</span><span style="color: #000000"> [</span><span style="color: #000000">|</span><span style="color: #000000"> argTy </span><span style="color: #000000">|</span><span style="color: #000000">] </span><span style="color: #0000FF">-&gt;</span><span style="color: #000000"> [</span><span style="color: #000000">|</span><span style="color: #000000"> argObj </span><span style="color: #000000">|</span><span style="color: #000000">]
            </span><span style="color: #000000">|</span><span style="color: #000000"> argTys </span><span style="color: #0000FF">-&gt;</span><span style="color: #000000"> FSharpValue.GetTupleFields(argObj)
          
          </span><span style="color: #008000">//</span><span style="color: #008000"> Get our function type for the CallSite</span><span style="color: #008000">
</span><span style="color: #000000">          </span><span style="color: #0000FF">let</span><span style="color: #000000"> funcTypeArgs </span><span style="color: #000000">=</span><span style="color: #000000"> [</span><span style="color: #000000">|</span><span style="color: #000000"> </span><span style="color: #0000FF">yield</span><span style="color: #000000"> typeof</span><span style="color: #000000">&lt;</span><span style="color: #000000">CallSite</span><span style="color: #000000">&gt;</span><span style="color: #000000">; 
                                </span><span style="color: #0000FF">yield</span><span style="color: #000000"> typeof</span><span style="color: #000000">&lt;</span><span style="color: #000000">obj</span><span style="color: #000000">&gt;</span><span style="color: #000000">; 
                                </span><span style="color: #0000FF">yield</span><span style="color: #000000">!</span><span style="color: #000000"> domainTypes; 
                                </span><span style="color: #0000FF">yield</span><span style="color: #000000"> typeof</span><span style="color: #000000">&lt;</span><span style="color: #000000">obj</span><span style="color: #000000">&gt;</span><span style="color: #000000"> </span><span style="color: #000000">|</span><span style="color: #000000">]
          </span><span style="color: #0000FF">let</span><span style="color: #000000"> funcType </span><span style="color: #000000">=</span><span style="color: #000000"> Expression.GetFuncType funcTypeArgs
             
          </span><span style="color: #0000FF">let</span><span style="color: #000000"> cty </span><span style="color: #000000">=</span><span style="color: #000000"> typedefof</span><span style="color: #000000">&lt;</span><span style="color: #000000">CallSite</span><span style="color: #000000">&lt;</span><span style="color: #000000">_</span><span style="color: #000000">&gt;&gt;</span><span style="color: #000000">.MakeGenericType [</span><span style="color: #000000">|</span><span style="color: #000000"> funcType </span><span style="color: #000000">|</span><span style="color: #000000">]
             
          </span><span style="color: #008000">//</span><span style="color: #008000"> Create our CallSite</span><span style="color: #008000">
</span><span style="color: #000000">          </span><span style="color: #0000FF">let</span><span style="color: #000000"> createFlags </span><span style="color: #000000">=</span><span style="color: #000000"> BindingFlags.Public </span><span style="color: #000000">|||</span><span style="color: #000000"> 
                            BindingFlags.Static </span><span style="color: #000000">|||</span><span style="color: #000000"> 
                            BindingFlags.InvokeMethod
          </span><span style="color: #0000FF">let</span><span style="color: #000000"> targetMemberArgs </span><span style="color: #000000">=</span><span style="color: #000000"> 
            Array.create (realArgs.Length </span><span style="color: #000000">+</span><span style="color: #000000"> </span><span style="color: #800080">1</span><span style="color: #000000">) 
                         (CSharpArgumentInfo.Create(CSharpArgumentInfoFlags.None, 
                                                    targetMember))
          </span><span style="color: #0000FF">let</span><span style="color: #000000"> createArgs </span><span style="color: #000000">=</span><span style="color: #000000"> [</span><span style="color: #000000">|</span><span style="color: #000000">(box(Binder.InvokeMember(CSharpBinderFlags.None, 
                                                      targetMember, 
                                                      </span><span style="color: #0000FF">null</span><span style="color: #000000">, 
                                                      </span><span style="color: #0000FF">null</span><span style="color: #000000">, 
                                                      targetMemberArgs)))</span><span style="color: #000000">|</span><span style="color: #000000">]
          </span><span style="color: #0000FF">let</span><span style="color: #000000"> cs </span><span style="color: #000000">=</span><span style="color: #000000"> cty.InvokeMember(</span><span style="color: #800000">"</span><span style="color: #800000">Create</span><span style="color: #800000">"</span><span style="color: #000000">, 
                                    createFlags, 
                                    </span><span style="color: #0000FF">null</span><span style="color: #000000">, 
                                    </span><span style="color: #0000FF">null</span><span style="color: #000000">, 
                                    createArgs)
                        </span><span style="color: #000000">|&gt;</span><span style="color: #000000"> unbox</span><span style="color: #000000">&lt;</span><span style="color: #000000">CallSite</span><span style="color: #000000">&gt;</span><span style="color: #000000">
             
          </span><span style="color: #008000">//</span><span style="color: #008000"> Get the target for our CallSite</span><span style="color: #008000">
</span><span style="color: #000000">          </span><span style="color: #0000FF">let</span><span style="color: #000000"> target </span><span style="color: #000000">=</span><span style="color: #000000"> cs.GetType().GetField(</span><span style="color: #800000">"</span><span style="color: #800000">Target</span><span style="color: #800000">"</span><span style="color: #000000">).GetValue(cs)
             
          </span><span style="color: #008000">//</span><span style="color: #008000"> Invoke our CallSite target</span><span style="color: #008000">
</span><span style="color: #000000">          </span><span style="color: #0000FF">let</span><span style="color: #000000"> invokeFlags </span><span style="color: #000000">=</span><span style="color: #000000"> BindingFlags.Public </span><span style="color: #000000">|||</span><span style="color: #000000"> 
                            BindingFlags.Instance </span><span style="color: #000000">|||</span><span style="color: #000000"> 
                            BindingFlags.InvokeMethod
          </span><span style="color: #0000FF">let</span><span style="color: #000000"> invokeArgs </span><span style="color: #000000">=</span><span style="color: #000000"> [</span><span style="color: #000000">|</span><span style="color: #000000"> </span><span style="color: #0000FF">yield</span><span style="color: #000000"> cs; 
                              </span><span style="color: #0000FF">yield</span><span style="color: #000000"> targetObject; 
                              </span><span style="color: #0000FF">yield</span><span style="color: #000000">!</span><span style="color: #000000"> realArgs </span><span style="color: #000000">|</span><span style="color: #000000">]
          target.GetType().InvokeMember(</span><span style="color: #800000">"</span><span style="color: #800000">Invoke</span><span style="color: #800000">"</span><span style="color: #000000">, 
                                        invokeFlags, 
                                        </span><span style="color: #0000FF">null</span><span style="color: #000000">, 
                                        target, 
                                        invokeArgs))</span></pre>
<p><!-- Code inserted with Steve Dunn's Windows Live Writer Code Formatter Plugin.  http://dunnhq.com --></div>
<p>Finally, we need to create an F# function which invokes our object to object function from above with our desired return type and return it to the caller.</p>
<div style="padding-bottom: 0px;margin: 0px;padding-left: 0px;padding-right: 0px;float: none;padding-top: 0px" class="wlWriterEditableSmartContent">
<pre style="background-color:#FFFFFF;overflow: auto"><span style="color: #000000">    FSharpValue.MakeFunction(targetResultType,objToObjFunction) 
      </span><span style="color: #000000">|&gt;</span><span style="color: #000000"> unbox</span><span style="color: #000000">&lt;</span><span style="color: #800000">'</span><span style="color: #800000">TargetResult&gt;</span></pre>
<p><!-- Code inserted with Steve Dunn's Windows Live Writer Code Formatter Plugin.  http://dunnhq.com --></div>
<p>Once this is complete, we now have the capability of invoking both properties and methods just as if they were normal.&#160; For example, we can get a substring of a word and also check its length.</p>
<div style="padding-bottom: 0px;margin: 0px;padding-left: 0px;padding-right: 0px;float: none;padding-top: 0px" class="wlWriterEditableSmartContent">
<pre style="background-color:#FFFFFF;overflow: auto"><span style="color: #0000FF">let</span><span style="color: #000000"> sub : </span><span style="color: #0000FF">string</span><span style="color: #000000"> </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #800000">"</span><span style="color: #800000">dynamic</span><span style="color: #800000">"</span><span style="color: #000000">?</span><span style="color: #000000">Substring(</span><span style="color: #800080">0</span><span style="color: #000000">,</span><span style="color: #800080">3</span><span style="color: #000000">)
</span><span style="color: #0000FF">let</span><span style="color: #000000"> len : </span><span style="color: #0000FF">int</span><span style="color: #000000"> </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #800000">"</span><span style="color: #800000">dynamic</span><span style="color: #800000">"</span><span style="color: #000000">?</span><span style="color: #000000">Length</span></pre>
<p><!-- Code inserted with Steve Dunn's Windows Live Writer Code Formatter Plugin.  http://dunnhq.com --></div>
<p>Now let’s address the dynamic set operator.&#160; Luckily this is a much simpler operator to implement as we needn’t worry about the other case of a function, and instead can concentrate solely on setting a property.&#160; First, let’s look at the signature required for this operator:</p>
<div style="padding-bottom: 0px;margin: 0px;padding-left: 0px;padding-right: 0px;float: none;padding-top: 0px" class="wlWriterEditableSmartContent">
<pre style="background-color:#FFFFFF;overflow: auto"><span style="color: #0000FF">let</span><span style="color: #000000"> (</span><span style="color: #000000">?&lt;-</span><span style="color: #000000">) (targetObject : obj) (targetMember : </span><span style="color: #0000FF">string</span><span style="color: #000000">) (args : </span><span style="color: #800000">'</span><span style="color: #800000">Args) : unit =</span></pre>
<p><!-- Code inserted with Steve Dunn's Windows Live Writer Code Formatter Plugin.  http://dunnhq.com --></div>
<p>As you can see, this operator takes a target object, a target member and some arguments of type ‘Args and returns unit (void).&#160; Now, let’s look at the actual implementation.&#160; First, we need to create a set member binder with our binder flag with no additional information, our target member name, our target object type and our list of argument information.&#160; Next, we create a setter CallSite of type Func&lt;obj, ‘Args, obj&gt; which is to say that it takes our targetObject and our arguments and returns an object.&#160; Finally, we invoke the setter CallSite’s target with our setter CallSite, our target object and our arguments and ignore the return value.</p>
<div style="padding-bottom: 0px;margin: 0px;padding-left: 0px;padding-right: 0px;float: none;padding-top: 0px" class="wlWriterEditableSmartContent">
<pre style="background-color:#FFFFFF;overflow: auto"><span style="color: #000000">  </span><span style="color: #0000FF">let</span><span style="color: #000000"> flags </span><span style="color: #000000">=</span><span style="color: #000000"> CSharpArgumentInfoFlags.Constant </span><span style="color: #000000">|||</span><span style="color: #000000"> 
              CSharpArgumentInfoFlags.UseCompileTimeType
  </span><span style="color: #0000FF">let</span><span style="color: #000000"> argumentInfos </span><span style="color: #000000">=</span><span style="color: #000000"> [</span><span style="color: #000000">|</span><span style="color: #000000"> CSharpArgumentInfo.Create(CSharpArgumentInfoFlags.None, </span><span style="color: #0000FF">null</span><span style="color: #000000">); 
                         CSharpArgumentInfo.Create(flags, </span><span style="color: #0000FF">null</span><span style="color: #000000">) </span><span style="color: #000000">|</span><span style="color: #000000">]

  </span><span style="color: #0000FF">let</span><span style="color: #000000"> binder </span><span style="color: #000000">=</span><span style="color: #000000"> Binder.SetMember(CSharpBinderFlags.None, 
                                targetMember, 
                                targetObject.GetType(),
                                argumentInfos)

  </span><span style="color: #0000FF">let</span><span style="color: #000000"> setterSite </span><span style="color: #000000">=</span><span style="color: #000000"> CallSite</span><span style="color: #000000">&lt;</span><span style="color: #000000">Func</span><span style="color: #000000">&lt;</span><span style="color: #000000">CallSite, obj, </span><span style="color: #800000">'</span><span style="color: #800000">Args, obj&gt;&gt;.Create(binder)</span><span style="color: #800000">
</span><span style="color: #000000">  setterSite.Target.Invoke(setterSite, targetObject, args) </span><span style="color: #000000">|&gt;</span><span style="color: #000000"> ignore</span></pre>
<p><!-- Code inserted with Steve Dunn's Windows Live Writer Code Formatter Plugin.  http://dunnhq.com --></div>
<p>For a complete source listing of both the get and set dynamic lookup operators, please refer to this <a href="http://gist.github.com/300628">Gist on my GitHub</a>.</p>
<p>Having this in place, we’re able to both get and set values on such things as an ExpandoObject, our DynamicDictionary from above, and even custom classes such as an F# record.</p>
<div style="padding-bottom: 0px;margin: 0px;padding-left: 0px;padding-right: 0px;float: none;padding-top: 0px" class="wlWriterEditableSmartContent">
<pre style="background-color:#FFFFFF;overflow: auto"><span style="color: #008000">//</span><span style="color: #008000"> Expando object example</span><span style="color: #008000">
</span><span style="color: #0000FF">let</span><span style="color: #000000"> e </span><span style="color: #000000">=</span><span style="color: #000000"> ExpandoObject()
e</span><span style="color: #000000">?</span><span style="color: #000000">Property1 </span><span style="color: #000000">&lt;-</span><span style="color: #000000"> ExpandoObject()
e</span><span style="color: #000000">?</span><span style="color: #000000">Property1</span><span style="color: #000000">?</span><span style="color: #000000">Property2 </span><span style="color: #000000">&lt;-</span><span style="color: #000000"> </span><span style="color: #800000">"</span><span style="color: #800000">Expando man!</span><span style="color: #800000">"</span><span style="color: #000000">
printfn </span><span style="color: #800000">"</span><span style="color: #800000">%s</span><span style="color: #800000">"</span><span style="color: #000000"> e</span><span style="color: #000000">?</span><span style="color: #000000">Property1</span><span style="color: #000000">?</span><span style="color: #000000">Property2

</span><span style="color: #008000">//</span><span style="color: #008000"> Dynamic dictionary</span><span style="color: #008000">
</span><span style="color: #0000FF">let</span><span style="color: #000000"> d </span><span style="color: #000000">=</span><span style="color: #000000"> DynamicDictionary()
d</span><span style="color: #000000">?</span><span style="color: #000000">Dynamic </span><span style="color: #000000">&lt;-</span><span style="color: #000000"> </span><span style="color: #0000FF">true</span><span style="color: #000000">
printfn </span><span style="color: #800000">"</span><span style="color: #800000">Dynamic? %b</span><span style="color: #800000">"</span><span style="color: #000000"> d</span><span style="color: #000000">?</span><span style="color: #000000">Dynamic

</span><span style="color: #008000">//</span><span style="color: #008000"> Record type</span><span style="color: #008000">
</span><span style="color: #0000FF">type</span><span style="color: #000000"> Person </span><span style="color: #000000">=</span><span style="color: #000000"> { Name : </span><span style="color: #0000FF">string</span><span style="color: #000000">; mutable Age : </span><span style="color: #0000FF">int</span><span style="color: #000000"> }
</span><span style="color: #0000FF">let</span><span style="color: #000000"> me </span><span style="color: #000000">=</span><span style="color: #000000"> { Name </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #800000">"</span><span style="color: #800000">Matt</span><span style="color: #800000">"</span><span style="color: #000000">; Age </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #800080">22</span><span style="color: #000000"> }
me</span><span style="color: #000000">?</span><span style="color: #000000">Age </span><span style="color: #000000">&lt;-</span><span style="color: #000000"> me</span><span style="color: #000000">?</span><span style="color: #000000">Age </span><span style="color: #000000">+</span><span style="color: #000000"> </span><span style="color: #800080">1</span><span style="color: #000000">
printfn </span><span style="color: #800000">"</span><span style="color: #800000">What's my age again? %d</span><span style="color: #800000">"</span><span style="color: #000000"> me</span><span style="color: #000000">?</span><span style="color: #000000">Age</span></pre>
<p><!-- Code inserted with Steve Dunn's Windows Live Writer Code Formatter Plugin.  http://dunnhq.com --></div>
<p>With this in place, the possibilities are expanded just a little bit.&#160; You might imagine a lot of the upcoming code such as the <a href="http://github.com/samus/mongodb-csharp">MongoDB C# Driver</a> moving towards dynamic to provide some syntactic sugar, or even such things as <a href="http://github.com/foretagsplatsen/Divan/">Divan</a> for <a href="http://couchdb.org">CouchDB</a> as well.&#160; </p>
<p>Do we also get the goodies of dealing with COM as well?&#160; The answer there is of course we do.&#160; For example, I’ll show the difference between the old and new ways of dealing with Excel.&#160; Instead of having to cast our worksheet to the _Worksheet interface, we get instead use the ? operator to say we know it’s there and I don’t feel like casting to it.</p>
<div style="padding-bottom: 0px;margin: 0px;padding-left: 0px;padding-right: 0px;float: none;padding-top: 0px" class="wlWriterEditableSmartContent">
<pre style="background-color:#FFFFFF;overflow: auto"><span style="color: #0000FF">#if</span><span style="color: #000000"> INTERACTIVE</span><span style="color: #000000">
#r </span><span style="color: #800000">"</span><span style="color: #800000">Microsoft.Office.Interop.Excel.dll</span><span style="color: #800000">"</span><span style="color: #000000">
</span><span style="color: #0000FF">#endif</span><span style="color: #000000">

</span><span style="color: #0000FF">open</span><span style="color: #000000"> Microsoft.Office.Interop.Excel

</span><span style="color: #0000FF">let</span><span style="color: #000000"> app </span><span style="color: #000000">=</span><span style="color: #000000"> ApplicationClass(Visible</span><span style="color: #000000">=</span><span style="color: #0000FF">true</span><span style="color: #000000">)

</span><span style="color: #008000">//</span><span style="color: #008000"> Old</span><span style="color: #008000">
</span><span style="color: #0000FF">let</span><span style="color: #000000"> sheet1 </span><span style="color: #000000">=</span><span style="color: #000000"> 
  app.Workbooks.Add().Worksheets.[</span><span style="color: #800080">1</span><span style="color: #000000">] :</span><span style="color: #000000">?&gt;</span><span style="color: #000000"> _Worksheet
sheet.Range(</span><span style="color: #800000">"</span><span style="color: #800000">A1</span><span style="color: #800000">"</span><span style="color: #000000">).Value2 </span><span style="color: #000000">&lt;-</span><span style="color: #000000"> </span><span style="color: #800000">"</span><span style="color: #800000">12345</span><span style="color: #800000">"</span><span style="color: #000000">

</span><span style="color: #008000">//</span><span style="color: #008000"> New</span><span style="color: #008000">
</span><span style="color: #0000FF">let</span><span style="color: #000000"> sheet2 </span><span style="color: #000000">=</span><span style="color: #000000"> app.Workbooks.Add().Worksheets.[</span><span style="color: #800080">2</span><span style="color: #000000">]
sheet2</span><span style="color: #000000">?</span><span style="color: #000000">Range(</span><span style="color: #800000">"</span><span style="color: #800000">A1</span><span style="color: #800000">"</span><span style="color: #000000">)</span><span style="color: #000000">?</span><span style="color: #000000">Value2 </span><span style="color: #000000">&lt;-</span><span style="color: #000000"> </span><span style="color: #800000">"</span><span style="color: #800000">12345</span><span style="color: #800000">"</span><span style="color: #000000">

app.Quit()</span></pre>
<p><!-- Code inserted with Steve Dunn's Windows Live Writer Code Formatter Plugin.  http://dunnhq.com --></div>
<p>So, as you can see, we get most of the benefits of what C# has, although they do a bit more optimization than I have done here such as caching.</p>
<h2>Conclusion</h2>
<p>Implementing these dynamic operators for using the C# dynamic binders was not trivial and took a little understanding of how the DLR works and what magic the C# compiler does to make this happen.&#160; These are not well documented APIs from the C# binder perspective, so understanding a bit of this can be tricky.</p>
<p>One question that could come from this post would be, should this be the official implementation for F#, just as there is some compiler magic for C#?&#160; And would it make sense to have a separate operator for doing more “custom” dynamic operations such as our IDictionary lookups among other items?&#160; Through the use of Modules, certainly you could decide which operator implementation you which to use, which would then allow us to have many implementations of our operator and we decide which one we need.</p>
<div class="shr-publisher-199"></div><!-- Start Shareaholic LikeButtonSetBottom Automatic --><!-- End Shareaholic LikeButtonSetBottom Automatic -->											</div><!-- .entry-content -->


					<div class="entry-utility">
					This entry was posted in <a href="http://codebetter.com/matthewpodwysocki/category/c/" title="View all posts in C#" rel="category tag">C#</a>, <a href="http://codebetter.com/matthewpodwysocki/category/dlr/" title="View all posts in DLR" rel="category tag">DLR</a>, <a href="http://codebetter.com/matthewpodwysocki/category/f/" title="View all posts in F#" rel="category tag">F#</a>. Bookmark the <a href="http://codebetter.com/matthewpodwysocki/2010/02/10/f-and-the-dynamic-lookup-operator-ala-c/" title="Permalink to F# and the Dynamic Lookup Operator ala C#" rel="bookmark">permalink</a>. Follow any comments here with the <a href="http://codebetter.com/matthewpodwysocki/2010/02/10/f-and-the-dynamic-lookup-operator-ala-c/feed/" title="Comments RSS to F# and the Dynamic Lookup Operator ala C#" rel="alternate" type="application/rss+xml">RSS feed for this post</a>.
					</div><!-- .entry-utility -->
				</div><!-- #post-199 -->

				<div id="nav-below" class="navigation">
					<div class="nav-previous"><a href="http://codebetter.com/matthewpodwysocki/2010/02/09/exploring-mongodb-with-f/" rel="prev"><span class="meta-nav">&larr;</span> Exploring MongoDB with F#</a></div>
					<div class="nav-next"><a href="http://codebetter.com/matthewpodwysocki/2010/02/10/upcoming-release-of-f-2-0/" rel="next">Upcoming Release of F# 2.0 <span class="meta-nav">&rarr;</span></a></div>
				</div><!-- #nav-below -->

				
<div id="disqus_thread">
                    <div id="dsq-content">
            <ul id="dsq-comments">
                    <li id="dsq-comment-729">
                    <div id="dsq-comment-header-729" class="dsq-comment-header">
                        <cite id="dsq-cite-729">
                                <span id="dsq-author-user-729">Stephen Swensen</span>
                            </cite>
                    </div>
                    <div id="dsq-comment-body-729" class="dsq-comment-body">
                        <div id="dsq-comment-message-729" class="dsq-comment-message"><p>Hi Matthew &#8212; this is good stuff, but I find it difficult to follow and copy and paste the code when it&#8217;s all broken up here: do you have someplace I could download or view whole source files of your dynamic operator implementations?</p>
</div>
                    </div>
                </li>
                </ul>
        </div>
    </div>

<script type="text/javascript">
/* <![CDATA[ */
    var disqus_url = 'http://codebetter.com/matthewpodwysocki/2010/02/10/f-and-the-dynamic-lookup-operator-ala-c/';
    var disqus_identifier = '199 /blogs/matthew.podwysocki/archive/2010/02/10/f-and-the-dynamic-lookup-operator-ala-c.aspx';
    var disqus_container_id = 'disqus_thread';
    var disqus_domain = 'disqus.com';
    var disqus_shortname = 'matthewpodwysocki';
    var disqus_title = "F# and the Dynamic Lookup Operator ala C#";
        var disqus_config = function () {
        var config = this; // Access to the config object

        /* 
           All currently supported events:
            * preData — fires just before we request for initial data
            * preInit - fires after we get initial data but before we load any dependencies
            * onInit  - fires when all dependencies are resolved but before dtpl template is rendered
            * afterRender - fires when template is rendered but before we show it
            * onReady - everything is done
         */

        config.callbacks.preData.push(function() {
            // clear out the container (its filled for SEO/legacy purposes)
            document.getElementById(disqus_container_id).innerHTML = '';
        });
                config.callbacks.onReady.push(function() {
            // sync comments in the background so we don't block the page
            DISQUS.request.get('?cf_action=sync_comments&post_id=199');
        });
                    };
    var facebookXdReceiverPath = 'http://cdn1.codebetter.com/wp-content/plugins/disqus-comment-system/xd_receiver.htm';
/* ]]> */
</script>

<script type="text/javascript">
/* <![CDATA[ */
    var DsqLocal = {
        'trackbacks': [
        ],
        'trackback_url': "http:\/\/codebetter.com\/matthewpodwysocki\/2010\/02\/10\/f-and-the-dynamic-lookup-operator-ala-c\/trackback\/"    };
/* ]]> */
</script>

<script type="text/javascript">
/* <![CDATA[ */
(function() {
    var dsq = document.createElement('script'); dsq.type = 'text/javascript';
    dsq.async = true;
    dsq.src = 'http://' + disqus_shortname + '.' + disqus_domain + '/embed.js?pname=wordpress&pver=2.67';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();
/* ]]> */
</script>

		</div><!-- #main -->
			<div id="sidebar" class="grid_4">

		<div id="primary" class="widget-area">
			<ul class="xoxo">
				<div class="ad-container">
<script type='text/javascript'><!--// <![CDATA[
    OA_show(29416);
// ]]> --></script><noscript><a target='_blank' href='http://d1.openx.org/ck.php?n=2782afb'><img border='0' alt='' src='http://d1.openx.org/avw.php?zoneid=29416&amp;n=2782afb' /></a></noscript><script type='text/javascript'><!--// <![CDATA[
    OA_show(29417);
// ]]> --></script><noscript><a target='_blank' href='http://d1.openx.org/ck.php?n=e94cea6'><img border='0' alt='' src='http://d1.openx.org/avw.php?zoneid=29417&amp;n=e94cea6' /></a></noscript><script type='text/javascript'><!--// <![CDATA[
    OA_show(29418);
// ]]> --></script><noscript><a target='_blank' href='http://d1.openx.org/ck.php?n=9ba3022'><img border='0' alt='' src='http://d1.openx.org/avw.php?zoneid=29418&amp;n=9ba3022' /></a></noscript><script type='text/javascript'><!--// <![CDATA[
    OA_show(29419);
// ]]> --></script><noscript><a target='_blank' href='http://d1.openx.org/ck.php?n=f467b52'><img border='0' alt='' src='http://d1.openx.org/avw.php?zoneid=29419&amp;n=f467b52' /></a></noscript>
				</div>
			
				<li id="user_bio-2" class="widget-container widget_user_bio"><h3 class="widget-title"></h3>One of these days I will add something to my user profile! For now, I shall remain mysterious.
</li>		
						
			</ul>
			
		</div><!-- #primary .widget-area -->
		
		<div id="secondary" class="widget-area">
				
<script type='text/javascript'><!--// <![CDATA[
    OA_show(220407);
// ]]> --></script><noscript><a target='_blank' href='http://d1.openx.org/ck.php?n=68b8307'><img border='0' alt='' src='http://d1.openx.org/avw.php?zoneid=220407&amp;n=68b8307' /></a></noscript>				
				
				<ul class="xoxo">		
									</ul>	
				
<script type='text/javascript'><!--// <![CDATA[
    OA_show(29421);
// ]]> --></script><noscript><a target='_blank' href='http://d1.openx.org/ck.php?n=3f8e353'><img border='0' alt='' src='http://d1.openx.org/avw.php?zoneid=29421&amp;n=3f8e353' /></a></noscript>
				
		</div><!-- #secondary .widget-area -->			</div><!--sidebar-->
		</div><!-- #container -->
</div><!-- end div tabs see header.php -->
	
	<div id="footer">
		<div class="container_12">
		<div id="footer-widget-area">
				<div class="grid_4">					
					<ul>
					<li><a href="http://codebetter.com" title="home">Home</a></li>
					<li class="page_item page-item-2"><a href="http://codebetter.com/about/">About</a></li>
<li class="page_item page-item-8"><a href="http://codebetter.com/codebetter-ci/">CodeBetter CI</a></li>
<li class="page_item page-item-6"><a href="http://codebetter.com/community/">Community</a></li>
<li class="page_item page-item-10"><a href="http://codebetter.com/editors/">Editors</a></li>
<li class="page_item page-item-41"><a href="http://codebetter.com/globalsearch/">Search Results</a></li>
					<li><a href="http://feeds.feedburner.com/CodeBetter" rel="alternate" type="application/rss+xml"><img src="http://www.feedburner.com/fb/images/pub/feed-icon16x16.png" alt="" style="vertical-align:middle;border:0"/></a><a href="http://feeds.feedburner.com/CodeBetter"><img src="http://feeds.feedburner.com/~fc/CodeBetter?bg=FFFFFF&amp;fg=2E9BD2&amp;anim=1" height="26" width="88" style="vertical-align:middle;border:0"/></a></li>
					</ul>
				</div><!-- #second .widget-area -->
				<div class="grid_4">
					
					<h3>Friends of CodeBetter.Com</h3>
<ul>

<li><a href="http://red-gate.com/">Red-Gate Tools For SQL and .NET</a></li>
<li><a href="http://telerik.com">Telerik .NET Tools</a></li>
<li><a href="http://jetbrains.com/resharper/">JetBrains - ReSharper</a></li>
<li><a href="http://scootersoftware.com">Beyond Compare</a></li>
<li><a href="http://www.ndepend.com/">NDepend</a></li>
<li><a href="http://www.sapphiresteel.com/">Ruby In Steel</a></li>
<li><a href="http://www.slickedit.com/">SlickEdit</a></li>
<li><a href="http://www.gurock.com/products/smartinspect/">SmartInspect .NET Logging</a></li>
<li>NGEDIT: <a href="http://www.viemu.com/">ViEmu</a> and <a href="http://www.codekana.com/">Codekana</a> </li>
<li><a href="http://www.devexpress.com/" target="_blank">DevExpress</a></li>
<li><a href="http://nhprof.com" target="_blank">NHibernate Profiler</a></li>
<li><a href="http://unfuddle.com" target="_blank">Unfuddle</a></li>
<li><a href="http://www.balsamiq.com/products/mockups" target="_blank">Balsamiq Mockups</a></li>
<li><a href="http://scrumy.com" target="_blank">Scrumy</a></li>
<li><a href="http://umbraco.com" target="_blank">Umbraco</a></li>
<li><a href="http://nservicebus.com" target="_blank">NServiceBus</a></li>
<li><a href="http://ravendb.net" target="_blank">RavenDb</a></li>
<li><a href="http://www.websequencediagrams.com/" target="_blank">Web Sequence Diagrams</a></li>
	</ul>				
				</div><!-- #third .widget-area -->
				<div class="grid_4">
					CodeBetter.Com &copy; '12<br />
						Stuff you need to Code Better!<br />
				Proudly powered by <span id="generator-link"><a href="http://wordpress.org/" title="Semantic Personal Publishing Platform" rel="generator">WordPress</a></span>.					
				</div><!-- #fourth .widget-area -->
			</div><!-- #footer-widget-area -->		
		
			</div><!-- end div.container_12 -->

	</div><!-- end div#footer -->
		
<script type="text/javascript">

  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-531207-1']);
  _gaq.push(['_trackPageview']);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();

</script>
<script type='text/javascript' src='http://cdn1.codebetter.com/wp-content/plugins/syntaxhighlighter/syntaxhighlighter3/scripts/shCore.js?ver=3.0.83b'></script>
<script type='text/javascript' src='http://cdn1.codebetter.com/wp-content/plugins/syntaxhighlighter/syntaxhighlighter3/scripts/shBrushCSharp.js?ver=3.0.83b'></script>
<script type='text/javascript' src='http://cdn1.codebetter.com/wp-content/plugins/syntaxhighlighter/syntaxhighlighter3/scripts/shBrushRuby.js?ver=3.0.83b'></script>
<script type='text/javascript' src='http://cdn1.codebetter.com/wp-content/plugins/syntaxhighlighter/syntaxhighlighter3/scripts/shBrushJScript.js?ver=3.0.83b'></script>
<script type='text/javascript' src='http://cdn1.codebetter.com/wp-content/plugins/syntaxhighlighter/syntaxhighlighter3/scripts/shBrushXml.js?ver=3.0.83b'></script>
<script type='text/javascript' src='http://cdn1.codebetter.com/wp-content/plugins/syntaxhighlighter/syntaxhighlighter3/scripts/shBrushPython.js?ver=3.0.83b'></script>
<script type='text/javascript' src='http://cdn1.codebetter.com/wp-content/plugins/syntaxhighlighter/third-party-brushes/shBrushFSharp.js?ver=3.0.83b'></script>
<script type='text/javascript'>
	(function(){
		var corecss = document.createElement('link');
		var themecss = document.createElement('link');
		var corecssurl = "http://cdn1.codebetter.com/wp-content/plugins/syntaxhighlighter/syntaxhighlighter3/styles/shCore.css?ver=3.0.83b";
		if ( corecss.setAttribute ) {
				corecss.setAttribute( "rel", "stylesheet" );
				corecss.setAttribute( "type", "text/css" );
				corecss.setAttribute( "href", corecssurl );
		} else {
				corecss.rel = "stylesheet";
				corecss.href = corecssurl;
		}
		document.getElementsByTagName("head")[0].insertBefore( corecss, document.getElementById("syntaxhighlighteranchor") );
		var themecssurl = "http://cdn1.codebetter.com/wp-content/plugins/syntaxhighlighter/syntaxhighlighter3/styles/shThemeDefault.css?ver=3.0.83b";
		if ( themecss.setAttribute ) {
				themecss.setAttribute( "rel", "stylesheet" );
				themecss.setAttribute( "type", "text/css" );
				themecss.setAttribute( "href", themecssurl );
		} else {
				themecss.rel = "stylesheet";
				themecss.href = themecssurl;
		}
		//document.getElementById("syntaxhighlighteranchor").appendChild(themecss);
		document.getElementsByTagName("head")[0].insertBefore( themecss, document.getElementById("syntaxhighlighteranchor") );
	})();
	SyntaxHighlighter.config.strings.expandSource = '+ expand source';
	SyntaxHighlighter.config.strings.help = '?';
	SyntaxHighlighter.config.strings.alert = 'SyntaxHighlighter\n\n';
	SyntaxHighlighter.config.strings.noBrush = 'Can\'t find brush for: ';
	SyntaxHighlighter.config.strings.brushNotHtmlScript = 'Brush wasn\'t configured for html-script option: ';
	SyntaxHighlighter.defaults['gutter'] = false;
    SyntaxHighlighter.defaults['tab-size'] = 2;
    SyntaxHighlighter.defaults['toolbar'] = false;
    SyntaxHighlighter.defaults['wrap-lines'] = true; 
	SyntaxHighlighter.defaults['pad-line-numbers'] = false;
	SyntaxHighlighter.all();
</script>

<script type='text/javascript'>//<![CDATA[
    if (typeof jQuery == 'undefined') {
        document.write(unescape("%3Cscript src='http://ajax.aspnetcdn.com/ajax/jQuery/jquery-1.4.2.min.js' type='text/javascript' %3E%3C/script%3E"));
    }//]]></script>
<script type='text/javascript' language='Javascript' src='http://s1.lqcdn.com/m.min.js?dt=2.3.110202.1'></script>
<script type='text/javascript' language='Javascript'> if(jQuery.LqmAds)jQuery.LqmAds();</script>
 
</body>
</html>
<!-- Dynamic page generated in 4.532 seconds. -->
<!-- Cached page generated by WP-Super-Cache on 2012-11-09 18:02:58 -->
<!-- super cache -->