<!DOCTYPE html>
<html dir="ltr" lang="en-US">
<head>
	<meta charset="UTF-8" />
    <title>Fast Serialization | Greg Young</title>
	<link rel="profile" href="http://gmpg.org/xfn/11" />
	
	<link href="http://feeds.feedburner.com/CodeBetter" title="CodeBetter.Com &raquo; Feed" type="application/rss+xml" rel="alternate">
	
		<link rel="pingback" href="http://codebetter.com/gregyoung/xmlrpc.php" />
	                <link rel="stylesheet" href="http://codebetter.com/gregyoung/wp-content/uploads/spacker-cache/ea73517eb74a545f51c376487c94dc9f.css" type="text/css" media="all" /><!-- Is Cache! -->
                <script type='text/javascript' src='http://codebetter.com/gregyoung/wp-includes/js/l10n.js?ver=20101110'></script>
<link rel="EditURI" type="application/rsd+xml" title="RSD" href="http://codebetter.com/gregyoung/xmlrpc.php?rsd" />
<link rel="wlwmanifest" type="application/wlwmanifest+xml" href="http://codebetter.com/gregyoung/wp-includes/wlwmanifest.xml" /> 
<link rel='index' title='Greg Young' href='http://codebetter.com/gregyoung/' />
<link rel='start' title='Howdy and Viewing Unmanaged Code in VS.NET' href='http://codebetter.com/gregyoung/2006/06/09/howdy-and-viewing-unmanaged-code-in-vs-net/' />
<link rel='prev' title='DevTeach' href='http://codebetter.com/gregyoung/2008/08/18/devteach/' />
<link rel='next' title='Required Course' href='http://codebetter.com/gregyoung/2008/09/22/required-course/' />
<meta name="generator" content="WordPress 3.1-beta1-16732" />
<link rel='canonical' href='http://codebetter.com/gregyoung/2008/08/24/fast-serialization/' />
<link rel='shortlink' href='http://codebetter.com/gregyoung/?p=101' />
<link rel="stylesheet" href="http://codebetter.com/gregyoung/wp-content/plugins/digg-digg/include/../css/diggdigg-style.css?ver=4.5.0.7" type="text/css" media="screen" /><meta id="syntaxhighlighteranchor" name="syntaxhighlighter-version" content="3.1.1" />
                <script type="text/javascript" src="http://codebetter.com/gregyoung/wp-content/uploads/spacker-cache/a8046d2f1fc1c08af413701218a11c1d.js">/*Is Cache!*/</script>
                	<style type="text/css">body { padding-top:0px !important; } html { margin-top: 0px !important; }</style>

</head>

<body>

			
		<div class="container_12 ui-tabs ui-widget ui-widget-content ui-corner-all" id="tabs">			
			<ul class="ui-tabs-nav ui-helper-reset ui-helper-clearfix ui-widget-header ui-corner-all">
				<li class="ui-state-default ui-corner-top ui-tabs-selected ui-state-active"><a href="#ui-tabs-1">CodeBetter.Com</a></li>
				<li class="ui-state-default ui-corner-top"><a href="http://devlicio.us">Devlicio.Us</a></li>				
				<div id="top-search">
				<form action="http://codebetter.com/globalsearch/" id="cse-search-box">
  <div>
   <fieldset id="search">
		<input type="hidden" name="cx" value="005178204031477491434:2bg5jtwgsfe" />
		<input type="hidden" name="cof" value="FORID:9" />
		<input type="hidden" name="ie" value="UTF-8" />
		<input type="text"  class="text-input" id="s" name="q" size="31" />
		<input type="image" src="/wp-content/themes/codebetter/images/search-img.png" class="form-button" id="searchsubmit" value="GO" name="">				   	
	</fieldset>
  </div>
</form>
<script type="text/javascript" src="http://www.google.com/cse/brand?form=cse-search-box&lang=en&sitesearch=true"></script>
				</div>				
			</ul><div id="ui-tabs-1" class="ui-tabs-panel ui-widget-content ui-corner-bottom"></div><div id="ui-tabs-2" class="ui-tabs-panel ui-widget-content ui-corner-bottom ui-tabs-hide"></div>
		</div>
			
		<div id="main" class="container_12">
		
			<div id="logo" class="grid_3"><a href="/" title="CodeBetter.Com - Stuff you need to Code Better!"><image src="/wp-content/themes/codebetter/images/codebetter_logo.png" height="48" width="223"></image></a></div>
			<div id="ad_leaderboard" class="grid_9">			</div>
			
			<div id="globalNav" class="grid_12">
				<ul>
					<li><a href="http://codebetter.com" title="home">Home</a></li>
					<li class="page_item page-item-2"><a href="http://codebetter.com/about/" title="About">About</a></li>
<li class="page_item page-item-8"><a href="http://codebetter.com/codebetter-ci/" title="CodeBetter CI">CodeBetter CI</a></li>
<li class="page_item page-item-6"><a href="http://codebetter.com/community/" title="Community">Community</a></li>
<li class="page_item page-item-10"><a href="http://codebetter.com/editors/" title="Editors">Editors</a></li>
					<li><a href="http://feeds.feedburner.com/CodeBetter" rel="alternate" type="application/rss+xml"><img src="http://www.feedburner.com/fb/images/pub/feed-icon16x16.png" alt="" style="vertical-align:middle;border:0"/></a><a href="http://feeds.feedburner.com/CodeBetter"><img src="http://feeds.feedburner.com/~fc/CodeBetter?bg=EFEFEF&amp;fg=2E9BD2&amp;anim=1" height="26" width="88" style="vertical-align:middle;border:0"/></a></li>
				</ul>
								
			</div><!-- end div#globalNav.container_12 -->				
	
		<div id="content" class="container_12">
			<div id="main" class="grid_8">


				<div id="post-101" class="post-101 post type-post status-publish format-standard hentry category-uncategorized">
					<h1 class="entry-title">Fast Serialization</h1>

					<div class="entry-meta">
						<span class="meta-prep meta-prep-author">Posted by </span>
						<span class="author vcard"><a class="url fn n" href="http://codebetter.com/gregyoung/author/gregyoung/" title="View all posts by gregyoung">gregyoung</a></span>
						<span class="meta-sep"> on  </span>
						<a href="http://codebetter.com/gregyoung/2008/08/24/fast-serialization/" title="10:13 pm" rel="bookmark"><span class="entry-date">August 24, 2008</span></a>
											</div><!-- .entry-meta -->

					<div class="entry-content">
						<div id="greet_block"><noscript><div class="greet_block wpgb_cornered"><div class="greet_text"><div class="greet_image"><a href="http://codebetter.com/gregyoung/feed/rss/"  rel="nofollow"><img src="http://codebetter.com/gregyoung/wp-content/plugins/wp-greet-box/images/rss_icon.png" alt="WP Greet Box icon"/></a></div>Hello there! If you are new here, you might want to <a href="http://codebetter.com/gregyoung/feed/rss/" rel="nofollow"><strong>subscribe to the RSS feed</strong></a> for updates on this topic.<div style="clear:both"></div><div class="greet_block_powered_by">Powered by <a href="http://omninoggin.com/projects/wordpress-plugins/wp-greet-box-wordpress-plugin/" title="WP Greet Box WordPress Plugin" style="text-decoration:none;">WP Greet Box</a> <a href="http://omninoggin.com/" title="WordPress Plugin" style="text-decoration:none;">WordPress Plugin</a></div><div style="clear:both"></div></div></div></noscript></div><p><a href="http://codebetter.com/blogs/gregyoung/WindowsLiveWriter/FastSerialization_D602/lileBook_4.jpg"><img style="border-top-width: 0px;border-left-width: 0px;border-bottom-width: 0px;border-right-width: 0px" height="244" alt="lileBook" src="http://codebetter.com/blogs/gregyoung/WindowsLiveWriter/FastSerialization_D602/lileBook_thumb_1.jpg" width="197" align="left" border="0" /></a> We use <strong>ALOT </strong>of serialization in the current system I work with. Serializing/deserializing 100,000,000 objects in a day is pretty common. For a long time we knew that the binary formatter was fat and slow but never rationalized writing something custom as we were always fast enough. Unfortunately our data throughput has raised 400% in the last year (when you start with gigs and gigs of messages this is a huge gain) and our little three or four year old dual xeon 2.2 has turned into the little engine that could during peaks lately so we finally bit the big one and threw something together quickly. </p>
<p><em><strong></strong></em></p>
<p><em><strong>A toast &#8230; to the little server that could!</strong></em></p>
<p><em></em></p>
<p><em></em></p>
<p><em>This solution is for a fairly niche condition and is heavily optimized so please read the explanations below to see if it will be good for your scenario before using it.</em></p>
<p><em></em></p>
<p>&#160;</p>
<p>This is the first of a series of posts dealing with this &#8230; Let&#8217;s start with introducing a new interface to our system</p>
<pre>    public interface ICustomBinarySerializable
    {
        void WriteDataTo(BinaryWriter _Writer);
        void SetDataFrom(BinaryReader _Reader);
    }</pre>
<p>You would then implement this interface in your object like this, only write out exactly what you need and write it in the simplest way possible.</p>
<pre>    class TestObject : ICustomBinarySerializable
    {
        public int Integer;
        public TestObject(){}

        public TestObject(int _Integer)
        {
            Integer = _Integer;
        }

        public virtual void WriteDataTo(BinaryWriter _Writer)
        {
            _Writer.Write((int) Integer);
        }

        public virtual void SetDataFrom(BinaryReader _Reader)
        {
            Integer = _Reader.ReadInt32();
        }
    }</pre>
<p>Then I wrote a custom formatter that operates on objects that are ICustomBinaryObjectSerializable. You may note that for the index that represents the type I use an integer. This is probably more appropriate to be a short than an integer and we could save a few bytes here.</p>
<pre>    public class CustomBinaryFormatter : IFormatter
    {
        private SerializationBinder m_Binder;
        private StreamingContext m_StreamingContext;
        private ISurrogateSelector m_SurrogateSelector;
        private readonly MemoryStream m_WriteStream;
        private readonly MemoryStream m_ReadStream;
        private readonly BinaryWriter m_Writer;
        private readonly BinaryReader m_Reader;
        private readonly Dictionary&lt;type, int&gt; m_ByType = new Dictionary&lt;type int &gt;();
        private readonly Dictionary m_ById = new Dictionary();
        private readonly byte[] m_LengthBuffer = new byte[4];
        private readonly byte[] m_CopyBuffer;

        public CustomBinaryFormatter()
        {
            m_CopyBuffer = new byte[20000];
            m_WriteStream = new MemoryStream(10000);
            m_ReadStream = new MemoryStream(10000);
            m_Writer = new BinaryWriter(m_WriteStream);
            m_Reader = new BinaryReader(m_ReadStream);
        }

        public void Register(int _TypeId) where T:ICustomBinarySerializable
        {
            m_ById.Add(_TypeId, typeof(T));
            m_ByType.Add(typeof (T), _TypeId);
        }

        public object Deserialize(Stream serializationStream)
        {
            if(serializationStream.Read(m_LengthBuffer, 0, 4) != 4)
                throw new SerializationException(&quot;Could not read length from the stream.&quot;);
            IntToBytes length = new IntToBytes(m_LengthBuffer[0], m_LengthBuffer[1], m_LengthBuffer[2], m_LengthBuffer[3]);
            //TODO make this support partial reads from stream
            if(serializationStream.Read(m_CopyBuffer, 0, length.i32) != length.i32)
                throw new SerializationException(&quot;Could not read &quot; + length + &quot; bytes from the stream.&quot;);
            m_ReadStream.Seek(0L, SeekOrigin.Begin);
            m_ReadStream.Write(m_CopyBuffer, 0, length.i32);
            m_ReadStream.Seek(0L, SeekOrigin.Begin);
            int typeid = m_Reader.ReadInt32();
            Type t;
            if(!m_ById.TryGetValue(typeid, out t))
                throw new SerializationException(&quot;TypeId &quot; + typeid + &quot; is not a registerred type id&quot;);
            object obj = FormatterServices.GetUninitializedObject(t);
            ICustomBinarySerializable deserialize = (ICustomBinarySerializable) obj;
            deserialize.SetDataFrom(m_Reader);
            if(m_ReadStream.Position != length.i32)
                throw new SerializationException(&quot;object of type &quot; + t + &quot; did not read its entire buffer during deserialization. This is most likely an inbalance between the writes and the reads of the object.&quot;);
            return deserialize;
        }

        public void Serialize(Stream serializationStream, object graph)
        {
            int key;
            if (!m_ByType.TryGetValue(graph.GetType(), out key))
                throw new SerializationException(graph.GetType() + &quot; has not been registered with the serializer&quot;);
            ICustomBinarySerializable c = (ICustomBinarySerializable) graph; //this will always work due to generic constraint on the Register
            m_WriteStream.Seek(0L, SeekOrigin.Begin);
            m_Writer.Write((int) key);
            c.WriteDataTo(m_Writer);
            IntToBytes length = new IntToBytes((int) m_WriteStream.Position);
            serializationStream.WriteByte(length.b0);
            serializationStream.WriteByte(length.b1);
            serializationStream.WriteByte(length.b2);
            serializationStream.WriteByte(length.b3);
            serializationStream.Write(m_WriteStream.GetBuffer(), 0, (int) m_WriteStream.Position);
        }

        public ISurrogateSelector SurrogateSelector
        {
            get { return m_SurrogateSelector; }
            set { m_SurrogateSelector = value; }
        }

        public SerializationBinder Binder
        {
            get { return m_Binder; }
            set { m_Binder = value; }
        }

        public StreamingContext Context
        {
            get { return m_StreamingContext; }
            set { m_StreamingContext = value; }
        }
    }</pre>
<p>So that it is clear how this works &#8230; when you instantiate a custom formatter, you associate types back to integer ids. Example from my tests:</p>
<p>formatter.Register&lt;TestObject&gt;(1);</p>
<p>This says when you get a type id of 1 it should be a TestObject and vice versa when you write a TestObject give it a type id of 1.</p>
<p>&#160;</p>
<p>When writing an object the format is</p>
<p>&lt;4 bytes length&gt;&lt;4 bytes type id&gt;&lt;object data&gt;</p>
<p>&#160;</p>
<p>When we read the data we first read the 4 bytes of length (n), then read n bytes off the stream. We then copy that into our local buffer (<em>see notes below)</em>. We then seek to the beginning of the buffer and tell the object to read its state using the binary reader we provide to it.</p>
<p>&#160;</p>
<p>&#160;</p>
<h1>Performance</h1>
<p>Before we look at all of the bad an evil things this is doing let&#8217;s try some basic performance tests. To run tests I used the following simple object (what this library was designed to be really fast with). <em>I grabbed this object off someone&#8217;s blog who was also playing with serialization and added the interface but can&#8217;t seem to find the link of which one it was to give credit for saving me a good minutes worth of typing <img src='http://codebetter.com/gregyoung/wp-includes/images/smilies/icon_smile.gif' alt=':)' class='wp-smiley' /> .</em></p>
<p>&#160;</p>
<pre>[Serializable]
public class Customer : ICustomBinarySerializable {
     private String _lastname;
     private String _firstname;
     private String _address;
     private int _age;
     private int _code;

    public Customer()
    {

    }
    public Customer(String lastName, String firstName, String address, int age, int code)
    {
        _lastname = lastName;
        _firstname = firstName;
        _address = address;
        _age = age;
        _code = code;
    }

    public String LastName {
           get {return _lastname;}
           set {_lastname = value;}
     }
     public String FirstName
     {
           get {return _firstname;}
           set {_firstname = value;}
     }
     public String Address
     {
           get {return _address;}
           set {_address = value;}
     }

     public int Age
     {
           get {return _age;}
           set {_age = value;}
     }

     public int Code
     {
           get {return _code;}
           set {_code = value;}
     }

    public void WriteDataTo(BinaryWriter _Writer)
    {
        _Writer.Write((string)_lastname);
        _Writer.Write((string)_firstname);
        _Writer.Write((string)_address);
        _Writer.Write((Int32)_age);
        _Writer.Write((Int32)_code);
    }

    public void SetDataFrom(BinaryReader _Reader)
    {
        _lastname = _Reader.ReadString();
        _firstname = _Reader.ReadString();
        _address = _Reader.ReadString();
        _age = _Reader.ReadInt32();
        _code = _Reader.ReadInt32();
    }
}</pre>
<p>&#160;</p>
<h2>Speed</h2>
<p>To test the speed of the serializer I chose to serialize / deserialize one of these objects 10,000,000 times to/from a MemoryStream.</p>
<table cellspacing="0" cellpadding="2" width="400" border="1">
<tbody>
<tr>
<td valign="top" width="200">Test</td>
<td valign="top" width="200">Time (lower is better)</td>
</tr>
<tr>
<td valign="top" width="200">Serialize (Binary)</td>
<td valign="top" width="200">01:48.54</td>
</tr>
<tr>
<td valign="top" width="200">Serialize (Custom)</td>
<td valign="top" width="200">00:06.73</td>
</tr>
<tr>
<td valign="top" width="200">Deserialize (Binary)</td>
<td valign="top" width="200">2:01.29</td>
</tr>
<tr>
<td valign="top" width="200">Deserialize (Custom)</td>
<td valign="top" width="200">0:08.55</td>
</tr>
</tbody>
</table>
<p>So on serializing the custom one is a whopping 1612% faster and on deserializing it is 1418% faster. That&#8217;s not too bad as both are more than an order of magnitude.</p>
<p>&#160;</p>
<h2>Size</h2>
<p>The other area I really wanted to optimize as it is common for us to have 40+ gb transaction files for a day (disk IO is expensive) is the size of each message. Because we are not writing the same kind of schema information that the binary formatter does we can also be quite a bit smaller than its output. For the object given the binaryformatter results in 232 bytes of output while the custom formatter results in 41. This message has quite a few string which add into the amount of serialized data (on our messages (about 40) we average about a 1/10 ratio between the two). Even so its still a 500% gain in storage space required. Don&#8217;t let this fool you though there are some&#160; &#8230;.</p>
<p>&#160;</p>
<h1>Problems</h1>
<p>There are a number of problems with this type of strategy. It is imperative that you know about the tradeoffs involved with this code before using it. This was written for a niche situation and it may really hurt you if you aren&#8217;t careful!</p>
<h3>&#160;</h3>
<h2>Versioning</h2>
<p>There is no versioning information provided by default in the data. One could easily provide this in their custom serialization implementation but the formatter does not provide it by default for you.</p>
<p>&#160;</p>
<h2>Endianess</h2>
<p>One of the interesting things here is dealing with the length. I have done this using a quite unsafe (but faster) solution. </p>
<pre>    [StructLayout(LayoutKind.Explicit)]
    public struct IntToBytes
    {
        public IntToBytes(Int32 _value) { b0 = b1 = b2 = b3 = 0; i32 = _value; }
        public IntToBytes(byte _b0, byte _b1, byte _b2, byte _b3) {
            i32 = 0;
            b0 = _b0;
            b1 = _b1;
            b2 = _b2;
            b3 = _b3;
        }
        [FieldOffset(0)]
        public Int32 i32;
        [FieldOffset(0)]
        public byte b0;
        [FieldOffset(1)]
        public byte b1;
        [FieldOffset(2)]
        public byte b2;
        [FieldOffset(3)]
        public byte b3;
    }</pre>
<p>This has <strong>endian </strong>problems if you use it on multiple machines that have different endianess like say mono on a ppc vs clr on x86. One could easily get around this by just using BitConverter instead (or doing some binary arithmetic if you miss having real reasons for doing so <img src='http://codebetter.com/gregyoung/wp-includes/images/smilies/icon_smile.gif' alt=':)' class='wp-smiley' /> ). For us however most of these objects are being serialized between processes on the same machine so its not an issue for us.</p>
<h3>&#160;</h3>
<h2>Copying of Data</h2>
<p>Another problem (read: decision) has to do with how the formatter deals with the stream itself internally. It copies data off the stream into an internal memory buffer, it does this so it can reuse the same binaryreader/writer every time. This makes it non-reentrant and forces the copy but in testing with many very small messages the copying of the data turned out to be faster than creating a new Reader/Writer to the original stream on every iteration. This may turn out different for you, I will leave it as an exercise for the reader to change this (<em>I promise it won&#8217;t take more than 5 minutes</em>)</p>
<p>&#160;</p>
<h2>Typing</h2>
<p>Its a lot of typing in your objects (we can work around this with some IL generation) but that&#8217;s a whole other post isn&#8217;t it.</p>
<p>&#160;</p>
<p>Anyways I hope people enjoy this and can find a niche place of their own to use such a strategy.</p>
											</div><!-- .entry-content -->


					<div class="entry-utility">
					This entry was posted in <a href="http://codebetter.com/gregyoung/category/uncategorized/" title="View all posts in Uncategorized" rel="category tag">Uncategorized</a>. Bookmark the <a href="http://codebetter.com/gregyoung/2008/08/24/fast-serialization/" title="Permalink to Fast Serialization" rel="bookmark">permalink</a>. Follow any comments here with the <a href="http://codebetter.com/gregyoung/2008/08/24/fast-serialization/feed/" title="Comments RSS to Fast Serialization" rel="alternate" type="application/rss+xml">RSS feed for this post</a>.
					</div><!-- .entry-utility -->
				</div><!-- #post-101 -->

				<div id="nav-below" class="navigation">
					<div class="nav-previous"><a href="http://codebetter.com/gregyoung/2008/08/18/devteach/" rel="prev"><span class="meta-nav">&larr;</span> DevTeach</a></div>
					<div class="nav-next"><a href="http://codebetter.com/gregyoung/2008/09/22/required-course/" rel="next">Required Course <span class="meta-nav">&rarr;</span></a></div>
				</div><!-- #nav-below -->

							<div id="comments">


			<h3 id="comments-title">28 Responses to <em>Fast Serialization</em> </h3>


			<ol class="commentlist">
						<li class="comment even thread-even depth-1" id="li-comment-2423">
		<div id="comment-2423">
		<div class="comment-author vcard">
			<img alt='' src='http://0.gravatar.com/avatar/ad516503a11cd5ca435acc9bb6523536?s=40' class='avatar avatar-40 photo avatar-default' height='40' width='40' />			<cite class="fn"><a href='http://fajbsyxi.com/' rel='external nofollow' class='url'>Ikpuzsop</a></cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="http://codebetter.com/gregyoung/2008/08/24/fast-serialization/#comment-2423">July 14, 2009 at 11:45 pm</a></div>

		<div class="comment-body"><p>wpubqE</p>
</div>

		<div class="reply">
					</div>
	</div>

	</li>
		<li class="comment odd alt thread-odd thread-alt depth-1" id="li-comment-2422">
		<div id="comment-2422">
		<div class="comment-author vcard">
			<img alt='' src='http://0.gravatar.com/avatar/ad516503a11cd5ca435acc9bb6523536?s=40' class='avatar avatar-40 photo avatar-default' height='40' width='40' />			<cite class="fn"><a href='http://ypxoiea.com/ovyrrov/5.html' rel='external nofollow' class='url'>Pharmc422</a></cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="http://codebetter.com/gregyoung/2008/08/24/fast-serialization/#comment-2422">July 2, 2009 at 6:22 am</a></div>

		<div class="comment-body"><p>Very nice site!</p>
</div>

		<div class="reply">
					</div>
	</div>

	</li>
		<li class="comment even thread-even depth-1" id="li-comment-2421">
		<div id="comment-2421">
		<div class="comment-author vcard">
			<img alt='' src='http://0.gravatar.com/avatar/ad516503a11cd5ca435acc9bb6523536?s=40' class='avatar avatar-40 photo avatar-default' height='40' width='40' />			<cite class="fn"><a href='http://opxyiea.com/yoyrryo/5.html' rel='external nofollow' class='url'>Pharme832</a></cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="http://codebetter.com/gregyoung/2008/08/24/fast-serialization/#comment-2421">June 17, 2009 at 3:02 pm</a></div>

		<div class="comment-body"><p>Very nice site!</p>
</div>

		<div class="reply">
					</div>
	</div>

	</li>
		<li class="comment odd alt thread-odd thread-alt depth-1" id="li-comment-2420">
		<div id="comment-2420">
		<div class="comment-author vcard">
			<img alt='' src='http://0.gravatar.com/avatar/ad516503a11cd5ca435acc9bb6523536?s=40' class='avatar avatar-40 photo avatar-default' height='40' width='40' />			<cite class="fn"><a href='http://marcgravell.blogspot.com/' rel='external nofollow' class='url'>Marc Gravell</a></cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="http://codebetter.com/gregyoung/2008/08/24/fast-serialization/#comment-2420">March 4, 2009 at 1:49 am</a></div>

		<div class="comment-body"><p>For info, you might want to compare/contrast to protobuf-net; this works a lot more simply re POCO &#8211; it is largely attribute based (meaning: less code to get wrong), and has the advantages of being a portable (i.e. agreed) wire format, with extensibility etc baked in. It is of course optimized etc, and works on all framework versions.<br />
<a href="http://code.google.com/p/protobuf-net/" rel="nofollow">http://code.google.com/p/protobuf-net/</a></p>
</div>

		<div class="reply">
					</div>
	</div>

	</li>
		<li class="comment even thread-even depth-1" id="li-comment-2419">
		<div id="comment-2419">
		<div class="comment-author vcard">
			<img alt='' src='http://0.gravatar.com/avatar/ad516503a11cd5ca435acc9bb6523536?s=40' class='avatar avatar-40 photo avatar-default' height='40' width='40' />			<cite class="fn"><a href='http://www.xnlab.com' rel='external nofollow' class='url'>unruledboy</a></cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="http://codebetter.com/gregyoung/2008/08/24/fast-serialization/#comment-2419">October 7, 2008 at 8:05 am</a></div>

		<div class="comment-body"><p>I agree, but it&#8217;s easier to implement within the serializer <img src='http://codebetter.com/gregyoung/wp-includes/images/smilies/icon_smile.gif' alt=':)' class='wp-smiley' /> </p>
</div>

		<div class="reply">
					</div>
	</div>

	</li>
		<li class="comment odd alt thread-odd thread-alt depth-1" id="li-comment-2418">
		<div id="comment-2418">
		<div class="comment-author vcard">
			<img alt='' src='http://0.gravatar.com/avatar/ad516503a11cd5ca435acc9bb6523536?s=40' class='avatar avatar-40 photo avatar-default' height='40' width='40' />			<cite class="fn">Greg</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="http://codebetter.com/gregyoung/2008/08/24/fast-serialization/#comment-2418">September 23, 2008 at 4:50 pm</a></div>

		<div class="comment-body"><p>unruledboy:</p>
<p>Why is it a responsibility of the formatter to handle the indexing? I think this would be better served with an abstraction outside of the formatter (and it could as such be used with any formatter)</p>
</div>

		<div class="reply">
					</div>
	</div>

	</li>
		<li class="comment even thread-even depth-1" id="li-comment-2417">
		<div id="comment-2417">
		<div class="comment-author vcard">
			<img alt='' src='http://0.gravatar.com/avatar/ad516503a11cd5ca435acc9bb6523536?s=40' class='avatar avatar-40 photo avatar-default' height='40' width='40' />			<cite class="fn"><a href='http://www.xnlab.com' rel='external nofollow' class='url'>unruledboy</a></cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="http://codebetter.com/gregyoung/2008/08/24/fast-serialization/#comment-2417">September 23, 2008 at 8:58 am</a></div>

		<div class="comment-body"><p>I added the index feature, anyone who like to have a look, check out the following link:</p>
<p><a href="http://files.cnblogs.com/unruledboy/Serializer.zip" rel="nofollow">http://files.cnblogs.com/unruledboy/Serializer.zip</a></p>
</div>

		<div class="reply">
					</div>
	</div>

	</li>
		<li class="comment odd alt thread-odd thread-alt depth-1" id="li-comment-2416">
		<div id="comment-2416">
		<div class="comment-author vcard">
			<img alt='' src='http://0.gravatar.com/avatar/ad516503a11cd5ca435acc9bb6523536?s=40' class='avatar avatar-40 photo avatar-default' height='40' width='40' />			<cite class="fn"><a href='http://petesbloggerama.blogspot.com' rel='external nofollow' class='url'>Peter Bromberg</a></cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="http://codebetter.com/gregyoung/2008/08/24/fast-serialization/#comment-2416">August 26, 2008 at 11:19 pm</a></div>

		<div class="comment-body"><p>Ah, cool. Works in Silverlight and you can even do this:</p>
<p>using System.Windows;<br />
using System.Windows.Controls;<br />
using System.Windows.Documents;<br />
using System.Windows.Ink;<br />
using System.Windows.Input;<br />
using System.Windows.Media;<br />
using System.Windows.Media.Animation;<br />
using System.Windows.Shapes;<br />
using CustomBinarySerializer;</p>
<p>namespace SerializerTest<br />
{<br />
    [Serializable]<br />
    public class CustomerList: ICustomBinarySerializable<br />
    {<br />
        public List<customer> Customers;</p>
<p>        public CustomerList()<br />
        {<br />
            Customers = new List</customer><customer>();<br />
        }</p>
<p>        public void WriteDataTo(BinaryWriter _Writer)<br />
        {<br />
            foreach(Customer c in this.Customers )<br />
            {<br />
                _Writer.Write(c.LastName);<br />
                _Writer.Write(c.FirstName);<br />
                _Writer.Write(c.Address);<br />
                _Writer.Write(c.Age);<br />
                _Writer.Write(c.Code);<br />
            }<br />
        }</p>
<p>        public void SetDataFrom(BinaryReader _Reader)<br />
        {<br />
            while (_Reader.BaseStream.Position < _Reader.BaseStream.Length )<br />
            {<br />
                Customer c = new Customer();</p>
<p>                c.LastName = _Reader.ReadString();<br />
                c.FirstName = _Reader.ReadString();<br />
                c.Address = _Reader.ReadString();<br />
                c.Age = _Reader.ReadInt32();<br />
                c.Code = _Reader.ReadInt32();<br />
                this.Customers.Add(c);<br />
            }<br />
        }</p>
<p>    }<br />
}</customer></p>
</div>

		<div class="reply">
					</div>
	</div>

	</li>
		<li class="comment even thread-even depth-1" id="li-comment-2415">
		<div id="comment-2415">
		<div class="comment-author vcard">
			<img alt='' src='http://0.gravatar.com/avatar/ad516503a11cd5ca435acc9bb6523536?s=40' class='avatar avatar-40 photo avatar-default' height='40' width='40' />			<cite class="fn">Greg</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="http://codebetter.com/gregyoung/2008/08/24/fast-serialization/#comment-2415">August 26, 2008 at 6:45 pm</a></div>

		<div class="comment-body"><p>unruledboy:</p>
<p>You would want to do your own indexing in such a scenario (i.e. with a file). It is pretty easily done outside of the formatter.</p>
<p>Cheers,</p>
<p>Greg</p>
</div>

		<div class="reply">
					</div>
	</div>

	</li>
		<li class="comment odd alt thread-odd thread-alt depth-1" id="li-comment-2414">
		<div id="comment-2414">
		<div class="comment-author vcard">
			<img alt='' src='http://0.gravatar.com/avatar/ad516503a11cd5ca435acc9bb6523536?s=40' class='avatar avatar-40 photo avatar-default' height='40' width='40' />			<cite class="fn">Greg</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="http://codebetter.com/gregyoung/2008/08/24/fast-serialization/#comment-2414">August 26, 2008 at 6:04 pm</a></div>

		<div class="comment-body"><p>change of TODO:</p>
<p> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;int read = 1;</p>
<p> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;int total = 0;</p>
<p> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;m_ReadStream.Seek(0L, SeekOrigin.Begin);</p>
<p> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;while (total &lt; length.i32 &amp;&amp; read &gt; 0)</p>
<p> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;{</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; int left = length.i32 &#8211; total;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; int toRead = left &gt; m_CopyBuffer.Length ? m_CopyBuffer.Length : left;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; int read = serializationStream.Read(m_CopyBuffer, 0, toRead);
<p> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;total += read;</p>
<p> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;m_ReadStream.Write(m_CopyBuffer, 0, read);</p>
<p> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;}</p>
</div>

		<div class="reply">
					</div>
	</div>

	</li>
		<li class="comment even thread-even depth-1" id="li-comment-2413">
		<div id="comment-2413">
		<div class="comment-author vcard">
			<img alt='' src='http://0.gravatar.com/avatar/ad516503a11cd5ca435acc9bb6523536?s=40' class='avatar avatar-40 photo avatar-default' height='40' width='40' />			<cite class="fn"><a href='http://www.xnlab.com' rel='external nofollow' class='url'>unruledboy</a></cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="http://codebetter.com/gregyoung/2008/08/24/fast-serialization/#comment-2413">August 26, 2008 at 10:19 am</a></div>

		<div class="comment-body"><p>@Greg</p>
<p>what I mean is: if I serialize a lot of biz objects, lets say 100,000, then if we specifically need the number 89,002 object, we have to go through all the objects until we reach it, right?</p>
</div>

		<div class="reply">
					</div>
	</div>

	</li>
		<li class="comment odd alt thread-odd thread-alt depth-1" id="li-comment-2412">
		<div id="comment-2412">
		<div class="comment-author vcard">
			<img alt='' src='http://0.gravatar.com/avatar/ad516503a11cd5ca435acc9bb6523536?s=40' class='avatar avatar-40 photo avatar-default' height='40' width='40' />			<cite class="fn"><a href='http://www.xnlab.com' rel='external nofollow' class='url'>unruledboy</a></cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="http://codebetter.com/gregyoung/2008/08/24/fast-serialization/#comment-2412">August 26, 2008 at 10:16 am</a></div>

		<div class="comment-body"><p>silverlight version, but extremely slow, only a dozon times per second, strange, eh?</p>
<p>using System;<br />
using System.IO;<br />
using System.Runtime.Serialization;<br />
using System.Collections;<br />
using System.Collections.Generic;<br />
using System.Linq;<br />
using System.Text;</p>
<p>namespace Serializer<br />
{<br />
    public class CustomBinaryFormatter<br />
    {<br />
        private readonly MemoryStream m_WriteStream;<br />
        private readonly MemoryStream m_ReadStream;<br />
        private readonly BinaryWriter m_Writer;<br />
        private readonly BinaryReader m_Reader;<br />
        private readonly Dictionary<type , int> m_ByType = new Dictionary</type><type , int>();<br />
        private readonly Dictionary<int , Type> m_ById = new Dictionary</int><int , Type>();<br />
        private readonly byte[] m_LengthBuffer = new byte[4];<br />
        private readonly byte[] m_CopyBuffer;</p>
<p>        public CustomBinaryFormatter()<br />
        {<br />
            m_CopyBuffer = new byte[20000];<br />
            m_WriteStream = new MemoryStream(10000);<br />
            m_ReadStream = new MemoryStream(10000);<br />
            m_Writer = new BinaryWriter(m_WriteStream);<br />
            m_Reader = new BinaryReader(m_ReadStream);<br />
        }</p>
<p>        public void Register<t>(int _TypeId) where T:ICustomBinarySerializable<br />
        {<br />
            m_ById.Add(_TypeId, typeof(T));<br />
            m_ByType.Add(typeof (T), _TypeId);<br />
        }</p>
<p>        public object Deserialize(Stream serializationStream)<br />
        {<br />
            if(serializationStream.Read(m_LengthBuffer, 0, 4) != 4)<br />
                throw new SerializationException(&#8220;Could not read length from the stream.&#8221;);<br />
            IntToBytes length = new IntToBytes(m_LengthBuffer[0], m_LengthBuffer[1], m_LengthBuffer[2], m_LengthBuffer[3]);<br />
            //TODO make this support partial reads from stream<br />
            if(serializationStream.Read(m_CopyBuffer, 0, length.i32) != length.i32)<br />
                throw new SerializationException(&#8220;Could not read &#8221; + length + &#8221; bytes from the stream.&#8221;);<br />
            m_ReadStream.Seek(0L, SeekOrigin.Begin);<br />
            m_ReadStream.Write(m_CopyBuffer, 0, length.i32);<br />
            m_ReadStream.Seek(0L, SeekOrigin.Begin);<br />
            int typeid = m_Reader.ReadInt32();<br />
            Type t;<br />
            if(!m_ById.TryGetValue(typeid, out t))<br />
                throw new SerializationException(&#8220;TypeId &#8221; + typeid + &#8221; is not a registerred type id&#8221;);<br />
            //object obj = FormatterServices.GetUninitializedObject(t);<br />
            object obj = Activator.CreateInstance(t);<br />
            ICustomBinarySerializable deserialize = (ICustomBinarySerializable) obj;<br />
            deserialize.SetDataFrom(m_Reader);<br />
            if(m_ReadStream.Position != length.i32)<br />
                throw new SerializationException(&#8220;object of type &#8221; + t + &#8221; did not read its entire buffer during deserialization. This is most likely an inbalance between the writes and the reads of the object.&#8221;);<br />
            return deserialize;<br />
        }</p>
<p>        public void Serialize(Stream serializationStream, object graph)<br />
        {<br />
            int key;<br />
            if (!m_ByType.TryGetValue(graph.GetType(), out key))<br />
                throw new SerializationException(graph.GetType() + &#8221; has not been registered with the serializer&#8221;);<br />
            ICustomBinarySerializable c = (ICustomBinarySerializable) graph; //this will always work due to generic constraint on the Register<br />
            m_WriteStream.Seek(0L, SeekOrigin.Begin);<br />
            m_Writer.Write((int) key);<br />
            c.WriteDataTo(m_Writer);<br />
            IntToBytes length = new IntToBytes((int) m_WriteStream.Position);<br />
            serializationStream.WriteByte(length.b0);<br />
            serializationStream.WriteByte(length.b1);<br />
            serializationStream.WriteByte(length.b2);<br />
            serializationStream.WriteByte(length.b3);<br />
            serializationStream.Write(m_WriteStream.GetBuffer(), 0, (int) m_WriteStream.Position);<br />
        }<br />
    }<br />
}</t></int></type></p>
</div>

		<div class="reply">
					</div>
	</div>

	</li>
		<li class="comment even thread-even depth-1" id="li-comment-2411">
		<div id="comment-2411">
		<div class="comment-author vcard">
			<img alt='' src='http://0.gravatar.com/avatar/ad516503a11cd5ca435acc9bb6523536?s=40' class='avatar avatar-40 photo avatar-default' height='40' width='40' />			<cite class="fn">Greg</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="http://codebetter.com/gregyoung/2008/08/24/fast-serialization/#comment-2411">August 26, 2008 at 9:30 am</a></div>

		<div class="comment-body"><p>@unruledboy I dont understand what you asked.</p>
<p>@gael<br />
1) under problems section &#8220;Versioning&#8221;. This was for a very specific scenario where its not much of an issue</p>
<p>2)  was gonna use reflection.emit instead as an example (I alluded to it at the end) but hmm postsharp could also be interesting.</p>
<p>Greg</p>
</div>

		<div class="reply">
					</div>
	</div>

	</li>
		<li class="comment odd alt thread-odd thread-alt depth-1" id="li-comment-2410">
		<div id="comment-2410">
		<div class="comment-author vcard">
			<img alt='' src='http://0.gravatar.com/avatar/ad516503a11cd5ca435acc9bb6523536?s=40' class='avatar avatar-40 photo avatar-default' height='40' width='40' />			<cite class="fn"><a href='http://gael.fraiteur.net/' rel='external nofollow' class='url'>Gael Fraiteur</a></cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="http://codebetter.com/gregyoung/2008/08/24/fast-serialization/#comment-2410">August 26, 2008 at 9:24 am</a></div>

		<div class="comment-body"><p>Two remarks.</p>
<p>- A problem with that is versioning: you should have exactly the same object definition on both sides. If not, you need a protocol negotiation phase, which will result in serializer/deserializer methods to be generated using System.Reflection.Emit.</p>
<p>- If you dont want to support protocol negotiation (which I would understand), why not automatically generating the WriteDataTo and ReadDataFrom? PostSharp could help, although you would have to use PostSharp Core directly!</p>
<p>Good article!</p>
<p>-gael</p>
</div>

		<div class="reply">
					</div>
	</div>

	</li>
		<li class="comment even thread-even depth-1" id="li-comment-2409">
		<div id="comment-2409">
		<div class="comment-author vcard">
			<img alt='' src='http://0.gravatar.com/avatar/ad516503a11cd5ca435acc9bb6523536?s=40' class='avatar avatar-40 photo avatar-default' height='40' width='40' />			<cite class="fn"><a href='http://www.xnlab.com' rel='external nofollow' class='url'>unruledboy</a></cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="http://codebetter.com/gregyoung/2008/08/24/fast-serialization/#comment-2409">August 26, 2008 at 8:14 am</a></div>

		<div class="comment-body"><p>since it does not have an index, it has to iterate the whole file for a speficy item, right?</p>
</div>

		<div class="reply">
					</div>
	</div>

	</li>
		<li class="comment odd alt thread-odd thread-alt depth-1" id="li-comment-2408">
		<div id="comment-2408">
		<div class="comment-author vcard">
			<img alt='' src='http://0.gravatar.com/avatar/ad516503a11cd5ca435acc9bb6523536?s=40' class='avatar avatar-40 photo avatar-default' height='40' width='40' />			<cite class="fn">stephenpatten</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="http://codebetter.com/gregyoung/2008/08/24/fast-serialization/#comment-2408">August 25, 2008 at 8:46 pm</a></div>

		<div class="comment-body"><p>public class CustomBinaryFormatter : IFormatter<br />
    {<br />
        private SerializationBinder m_Binder;<br />
        private StreamingContext m_StreamingContext;<br />
        private ISurrogateSelector m_SurrogateSelector;<br />
        private readonly MemoryStream m_WriteStream;<br />
        private readonly MemoryStream m_ReadStream;<br />
        private readonly BinaryWriter m_Writer;<br />
        private readonly BinaryReader m_Reader;<br />
        private readonly Dictionary<type , int> m_ByType = new Dictionary</type><type , int>();<br />
        private readonly Dictionary<int , Type> m_ById = new Dictionary</int><int , Type>();<br />
        private readonly byte[] m_LengthBuffer = new byte[4];<br />
        private readonly byte[] m_CopyBuffer;</p>
<p>        public CustomBinaryFormatter()<br />
        {<br />
            m_CopyBuffer = new byte[20000];<br />
            m_WriteStream = new MemoryStream(10000);<br />
            m_ReadStream = new MemoryStream(10000);<br />
            m_Writer = new BinaryWriter(m_WriteStream);<br />
            m_Reader = new BinaryReader(m_ReadStream);<br />
        }</p>
<p>        public void Register<t>(int _TypeId) where T : ICustomBinarySerializable<br />
        {<br />
            m_ById.Add(_TypeId, typeof(T));<br />
            m_ByType.Add(typeof (T), _TypeId);<br />
        }</p>
<p>        public object Deserialize(Stream serializationStream)<br />
        {<br />
            if(serializationStream.Read(m_LengthBuffer, 0, 4) != 4)<br />
                throw new SerializationException(&#8220;Could not read length from the stream.&#8221;);<br />
            IntToBytes length = new IntToBytes(m_LengthBuffer[0], m_LengthBuffer[1], m_LengthBuffer[2], m_LengthBuffer[3]);<br />
            //TODO make this support partial reads from stream<br />
            if(serializationStream.Read(m_CopyBuffer, 0, length.i32) != length.i32)<br />
                throw new SerializationException(&#8220;Could not read &#8221; + length + &#8221; bytes from the stream.&#8221;);<br />
            m_ReadStream.Seek(0L, SeekOrigin.Begin);<br />
            m_ReadStream.Write(m_CopyBuffer, 0, length.i32);<br />
            m_ReadStream.Seek(0L, SeekOrigin.Begin);<br />
            int typeid = m_Reader.ReadInt32();<br />
            Type t;<br />
            if(!m_ById.TryGetValue(typeid, out t))<br />
                throw new SerializationException(&#8220;TypeId &#8221; + typeid + &#8221; is not a registerred type id&#8221;);<br />
            object obj = FormatterServices.GetUninitializedObject(t);<br />
            ICustomBinarySerializable deserialize = (ICustomBinarySerializable) obj;<br />
            deserialize.SetDataFrom(m_Reader);<br />
            if(m_ReadStream.Position != length.i32)<br />
                throw new SerializationException(&#8220;object of type &#8221; + t + &#8221; did not read its entire buffer during deserialization. This is most likely an inbalance between the writes and the reads of the object.&#8221;);<br />
            return deserialize;<br />
        }</p>
<p>        public void Serialize(Stream serializationStream, object graph)<br />
        {<br />
            int key;<br />
            if (!m_ByType.TryGetValue(graph.GetType(), out key))<br />
                throw new SerializationException(graph.GetType() + &#8221; has not been registered with the serializer&#8221;);<br />
            ICustomBinarySerializable c = (ICustomBinarySerializable) graph; //this will always work due to generic constraint on the Register<br />
            m_WriteStream.Seek(0L, SeekOrigin.Begin);<br />
            m_Writer.Write((int) key);<br />
            c.WriteDataTo(m_Writer);<br />
            IntToBytes length = new IntToBytes((int) m_WriteStream.Position);<br />
            serializationStream.WriteByte(length.b0);<br />
            serializationStream.WriteByte(length.b1);<br />
            serializationStream.WriteByte(length.b2);<br />
            serializationStream.WriteByte(length.b3);<br />
            serializationStream.Write(m_WriteStream.GetBuffer(), 0, (int) m_WriteStream.Position);<br />
        }</p>
<p>        public ISurrogateSelector SurrogateSelector<br />
        {<br />
            get { return m_SurrogateSelector; }<br />
            set { m_SurrogateSelector = value; }<br />
        }</p>
<p>        public SerializationBinder Binder<br />
        {<br />
            get { return m_Binder; }<br />
            set { m_Binder = value; }<br />
        }</p>
<p>        public StreamingContext Context<br />
        {<br />
            get { return m_StreamingContext; }<br />
            set { m_StreamingContext = value; }<br />
        }<br />
    }</t></int></type></p>
</div>

		<div class="reply">
					</div>
	</div>

	</li>
		<li class="comment even thread-even depth-1" id="li-comment-2407">
		<div id="comment-2407">
		<div class="comment-author vcard">
			<img alt='' src='http://0.gravatar.com/avatar/ad516503a11cd5ca435acc9bb6523536?s=40' class='avatar avatar-40 photo avatar-default' height='40' width='40' />			<cite class="fn"><a href='http://blogs.catalystss.com/blogs/josh_heyse' rel='external nofollow' class='url'>Josh Heyse</a></cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="http://codebetter.com/gregyoung/2008/08/24/fast-serialization/#comment-2407">August 25, 2008 at 8:31 pm</a></div>

		<div class="comment-body"><p>Greg,</p>
<p>Check this out.  The XBox Live team uses reflection to accomplish a similar approach.  They Dynamicly Generate delegates to do the serailization.</p>
<p><a href="http://msdn.microsoft.com/en-us/magazine/cc163960.aspx" rel="nofollow">http://msdn.microsoft.com/en-us/magazine/cc163960.aspx</a></p>
</div>

		<div class="reply">
					</div>
	</div>

	</li>
		<li class="comment odd alt thread-odd thread-alt depth-1" id="li-comment-2406">
		<div id="comment-2406">
		<div class="comment-author vcard">
			<img alt='' src='http://0.gravatar.com/avatar/ad516503a11cd5ca435acc9bb6523536?s=40' class='avatar avatar-40 photo avatar-default' height='40' width='40' />			<cite class="fn">stephenpatten</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="http://codebetter.com/gregyoung/2008/08/24/fast-serialization/#comment-2406">August 25, 2008 at 4:17 pm</a></div>

		<div class="comment-body"><p>Michael DiBernardo,</p>
<p>I beleive the Jon Skeet has already tackled that task, or is quite close to calling his port to C# baked.</p>
<p>Stephen</p>
</div>

		<div class="reply">
					</div>
	</div>

	</li>
		<li class="comment even thread-even depth-1" id="li-comment-2405">
		<div id="comment-2405">
		<div class="comment-author vcard">
			<img alt='' src='http://0.gravatar.com/avatar/ad516503a11cd5ca435acc9bb6523536?s=40' class='avatar avatar-40 photo avatar-default' height='40' width='40' />			<cite class="fn">Stephen Patten</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="http://codebetter.com/gregyoung/2008/08/24/fast-serialization/#comment-2405">August 25, 2008 at 3:28 pm</a></div>

		<div class="comment-body"><p>Greg,</p>
<p>Veiwing the &#8220;html sourc&#8221;  and copy to the clipboard yeild the same results. I know the problem is between the keyboard and chair, so would you be kind enough to provide the source to me either?</p>
<p>stephenpatten&#8230;&#8230;remove&#8230;..@&#8230;&#8230;.remove&#8230;..gmail.com</p>
</div>

		<div class="reply">
					</div>
	</div>

	</li>
		<li class="comment odd alt thread-odd thread-alt depth-1" id="li-comment-2404">
		<div id="comment-2404">
		<div class="comment-author vcard">
			<img alt='' src='http://0.gravatar.com/avatar/ad516503a11cd5ca435acc9bb6523536?s=40' class='avatar avatar-40 photo avatar-default' height='40' width='40' />			<cite class="fn"><a href='http://mikedebo.ca' rel='external nofollow' class='url'>Michael DiBernardo</a></cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="http://codebetter.com/gregyoung/2008/08/24/fast-serialization/#comment-2404">August 25, 2008 at 1:58 pm</a></div>

		<div class="comment-body"><p>Google&#8217;s recent release of protocol buffers might be useful in this context as well&#8230; If they haven&#8217;t already been ported to C#, I wouldn&#8217;t expect it to be long until they are.</p>
<p><a href="http://code.google.com/p/protobuf/" rel="nofollow">http://code.google.com/p/protobuf/</a></p>
</div>

		<div class="reply">
					</div>
	</div>

	</li>
		<li class="comment even thread-even depth-1" id="li-comment-2403">
		<div id="comment-2403">
		<div class="comment-author vcard">
			<img alt='' src='http://0.gravatar.com/avatar/ad516503a11cd5ca435acc9bb6523536?s=40' class='avatar avatar-40 photo avatar-default' height='40' width='40' />			<cite class="fn"><a href='http://bloggingabout.net/blogs/ramon/' rel='external nofollow' class='url'>Ramon Smits</a></cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="http://codebetter.com/gregyoung/2008/08/24/fast-serialization/#comment-2403">August 25, 2008 at 8:41 am</a></div>

		<div class="comment-body"><p>Nice short article that proofs custom binary serialization is worth the effort.</p>
</div>

		<div class="reply">
					</div>
	</div>

	</li>
		<li class="comment odd alt thread-odd thread-alt depth-1" id="li-comment-2402">
		<div id="comment-2402">
		<div class="comment-author vcard">
			<img alt='' src='http://0.gravatar.com/avatar/ad516503a11cd5ca435acc9bb6523536?s=40' class='avatar avatar-40 photo avatar-default' height='40' width='40' />			<cite class="fn"><a href='http://weblogs.asp.net/fbouma' rel='external nofollow' class='url'>FransBouma</a></cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="http://codebetter.com/gregyoung/2008/08/24/fast-serialization/#comment-2402">August 25, 2008 at 8:00 am</a></div>

		<div class="comment-body"><p>For people who need a more generic approach which uses the same underlying idea:<br />
<a href="http://www.codeproject.com/KB/dotnet/FastSerializer.asp" rel="nofollow">http://www.codeproject.com/KB/dotnet/FastSerializer.asp</a><br />
<a href="http://www.codeproject.com/KB/dotnet/OptimizingSerialization2.aspx" rel="nofollow">http://www.codeproject.com/KB/dotnet/OptimizingSerialization2.aspx</a></p>
<p>It definitely is worth the effort to implement custom binary serialization if you use it a lot. In line of business applications, where graphs of entities are passed back and forth between service and client, it can often be night and day between normal serialization using the binary formatter and a fast serialization approach. </p>
<p>Often another nice benefit of custom serialization is that the resulting block of data is much smaller than the block of data produced by the normal binary formatter. </p>
<p>Also, if you don&#8217;t want to go very deep with a custom serializer, do at least one thing: string caching. Strings are making things phat. Using string caching (by using a simple table which you place at the start of the block returned and you then simply place an index in the output stream) you can make the block of data very compact without a lot of effort, which already reduces the overall time a message is sent, because the block of data is smaller.</p>
</div>

		<div class="reply">
					</div>
	</div>

	</li>
		<li class="comment even thread-even depth-1" id="li-comment-2401">
		<div id="comment-2401">
		<div class="comment-author vcard">
			<img alt='' src='http://0.gravatar.com/avatar/ad516503a11cd5ca435acc9bb6523536?s=40' class='avatar avatar-40 photo avatar-default' height='40' width='40' />			<cite class="fn">Greg</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="http://codebetter.com/gregyoung/2008/08/24/fast-serialization/#comment-2401">August 25, 2008 at 5:45 am</a></div>

		<div class="comment-body"><p>its the generics, it tends to not like them when I copy/paste &#8230; if you view source you can see them. Sorry about that.</p>
</div>

		<div class="reply">
					</div>
	</div>

	</li>
		<li class="comment odd alt thread-odd thread-alt depth-1" id="li-comment-2400">
		<div id="comment-2400">
		<div class="comment-author vcard">
			<img alt='' src='http://0.gravatar.com/avatar/ad516503a11cd5ca435acc9bb6523536?s=40' class='avatar avatar-40 photo avatar-default' height='40' width='40' />			<cite class="fn">Stephen Patten</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="http://codebetter.com/gregyoung/2008/08/24/fast-serialization/#comment-2400">August 25, 2008 at 5:40 am</a></div>

		<div class="comment-body"><p>Greg,</p>
<p>Was the sample code supposed to compile?</p>
</div>

		<div class="reply">
					</div>
	</div>

	</li>
		<li class="comment even thread-even depth-1" id="li-comment-2399">
		<div id="comment-2399">
		<div class="comment-author vcard">
			<img alt='' src='http://0.gravatar.com/avatar/ad516503a11cd5ca435acc9bb6523536?s=40' class='avatar avatar-40 photo avatar-default' height='40' width='40' />			<cite class="fn">Greg</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="http://codebetter.com/gregyoung/2008/08/24/fast-serialization/#comment-2399">August 25, 2008 at 1:00 am</a></div>

		<div class="comment-body"><p>Anthony that is one use.</p>
<p>We also do alot of interprocess message exchange through either a transaction file or shared memory.</p>
<p>Cheers,</p>
<p>Greg</p>
</div>

		<div class="reply">
					</div>
	</div>

	</li>
		<li class="comment odd alt thread-odd thread-alt depth-1" id="li-comment-2398">
		<div id="comment-2398">
		<div class="comment-author vcard">
			<img alt='' src='http://0.gravatar.com/avatar/ad516503a11cd5ca435acc9bb6523536?s=40' class='avatar avatar-40 photo avatar-default' height='40' width='40' />			<cite class="fn"><a href='http://www.58bits.com' rel='external nofollow' class='url'>Anthony Bouch</a></cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="http://codebetter.com/gregyoung/2008/08/24/fast-serialization/#comment-2398">August 25, 2008 at 12:08 am</a></div>

		<div class="comment-body"><p>Nice one.  Out of curiosity &#8211; is this being used to serialize/deserialize objects sent over the wire using your fast TCP server?</p>
</div>

		<div class="reply">
					</div>
	</div>

	</li>
		<li class="comment even thread-even depth-1" id="li-comment-2397">
		<div id="comment-2397">
		<div class="comment-author vcard">
			<img alt='' src='http://0.gravatar.com/avatar/ad516503a11cd5ca435acc9bb6523536?s=40' class='avatar avatar-40 photo avatar-default' height='40' width='40' />			<cite class="fn">Stephen Patten</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="http://codebetter.com/gregyoung/2008/08/24/fast-serialization/#comment-2397">August 25, 2008 at 12:00 am</a></div>

		<div class="comment-body"><p>Thank you, Greg. Will post my own results alter tomorrow.</p>
</div>

		<div class="reply">
					</div>
	</div>

	</li>
		<li class="comment odd alt thread-odd thread-alt depth-1" id="li-comment-2396">
		<div id="comment-2396">
		<div class="comment-author vcard">
			<img alt='' src='http://0.gravatar.com/avatar/ad516503a11cd5ca435acc9bb6523536?s=40' class='avatar avatar-40 photo avatar-default' height='40' width='40' />			<cite class="fn"><a href='http://petesbloggerama.blogspot.com' rel='external nofollow' class='url'>Peter Bromberg</a></cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="http://codebetter.com/gregyoung/2008/08/24/fast-serialization/#comment-2396">August 24, 2008 at 10:49 pm</a></div>

		<div class="comment-body"><p>Nice, Greg. Glad you got around to it!</p>
</div>

		<div class="reply">
					</div>
	</div>

	</li>
			</ol>



								<div id="respond">
				<h3 id="reply-title">Leave a Reply <small><a rel="nofollow" id="cancel-comment-reply-link" href="/gregyoung/2008/08/24/fast-serialization/#respond" style="display:none;">Cancel reply</a></small></h3>
									<p class="must-log-in">You must be <a href="http://codebetter.com/gregyoung/wp-login.php?redirect_to=http%3A%2F%2Fcodebetter.com%2Fgregyoung%2F2008%2F08%2F24%2Ffast-serialization%2F">logged in</a> to post a comment.</p>												</div><!-- #respond -->
						
</div><!-- #comments -->

		</div><!-- #main -->
			<div id="sidebar" class="grid_4">

		<div id="primary" class="widget-area">
			<ul class="xoxo">
				<div class="ad-container">
					<a target="_blank" href="http://www.red-gate.com/products/dotnet-development/ants-performance-profiler/entrypage/version-6-new-features?utm_source=cb&utm_medium=button&utm_term=4328&utm_content=app6release&utm_campaign=antsperformanceprofiler"><img width="125" height="125" border="0" title="" alt="" src="http://s3.amazonaws.com/CodeBetter/Creative/ANTSPP5_125x125_M1.gif"></a>
					<embed width="125" height="125" flashvars="clickTARGET=_blank&amp;clickTAG=http%3A%2F%2Fd1.openx.org%2Fck.php%3Foaparams%3D2__bannerid%3D62753__zoneid%3D29419__cb%3Da0471ce5e8__r_id%3Dd42118811971f057012db20aa261c5c1__r_ts%3Dldef6x__oadest%3Dhttp%253A%252F%252Fwww.jetbrains.com%252Fresharper%252F%253Frs4cb125" allowscriptaccess="always" quality="high" name="Advertisement" id="Advertisement" style="" src="http://s3.amazonaws.com/CodeBetter/Creative/tc_125x125_simple2.swf" type="application/x-shockwave-flash">
				</div>
			
				<li id="user_bio-2" class="widget-container widget_user_bio"><h3 class="widget-title"></h3>One of these days I will add something to my user profile! For now, I shall remain mysterious.
</li>		
						
			</ul>
			
		</div><!-- #primary .widget-area -->
		
		<div id="secondary" class="widget-area">
				<script type="text/javascript" src="http://engine.theloungenet.com/z/15/adzerk1_2_5"></script>
				<div id="adzerk1"></div>
				
				<ul class="xoxo">		
									</ul>	
				
				<a target="_blank" href="http://www.red-gate.com/products/dotnet-development/ants-performance-profiler/entrypage/version-6-csharp?utm_source=cb&utm_medium=rectangle&utm_term=4327&utm_content=app6release&utm_campaign=antsperformanceprofiler"><img width="300" height="250" border="0" title="" alt="" src="http://s3.amazonaws.com/CodeBetter/Creative/APP6_Launch_C%23_Jun10_300x250_M1.gif?AWSAccessKeyId=0KMA35HT86EVXB99Z302&amp;Expires=1458095516&amp;Signature=BIBDilUaLnZe1uKfVKyyTBxr%2BvE%3D"></a>
				
		</div><!-- #secondary .widget-area -->			</div><!--sidebar-->
		</div><!-- #container -->
</div><!-- end div tabs see header.php -->
	
	<div id="footer">
		<div class="container_12">
		<div id="footer-widget-area">
				<div class="grid_4">					
					<ul>
					<li><a href="http://codebetter.com" title="home">Home</a></li>
					<li class="page_item page-item-2"><a href="http://codebetter.com/about/" title="About">About</a></li>
<li class="page_item page-item-8"><a href="http://codebetter.com/codebetter-ci/" title="CodeBetter CI">CodeBetter CI</a></li>
<li class="page_item page-item-6"><a href="http://codebetter.com/community/" title="Community">Community</a></li>
<li class="page_item page-item-10"><a href="http://codebetter.com/editors/" title="Editors">Editors</a></li>
<li class="page_item page-item-41"><a href="http://codebetter.com/globalsearch/" title="Search Results">Search Results</a></li>
					<li><a href="http://feeds.feedburner.com/CodeBetter" rel="alternate" type="application/rss+xml"><img src="http://www.feedburner.com/fb/images/pub/feed-icon16x16.png" alt="" style="vertical-align:middle;border:0"/></a><a href="http://feeds.feedburner.com/CodeBetter"><img src="http://feeds.feedburner.com/~fc/CodeBetter?bg=FFFFFF&amp;fg=2E9BD2&amp;anim=1" height="26" width="88" style="vertical-align:middle;border:0"/></a></li>
					</ul>
				</div><!-- #second .widget-area -->
				<div class="grid_4">
					
					<h3>Friends of CodeBetter.Com</h3>
<ul>

<li><a href="/blogs/products/pages/64386.aspx">Red-Gate Tools For SQL and .NET</a></li>
<li><a href="/blogs/products/pages/64615.aspx">Telerik</a></li>
<li><a href="/blogs/products/pages/142174.aspx">JetBrains - ReSharper</a></li>
<li><a href="/blogs/products/pages/Beyond-Compare.aspx">Beyond Compare</a></li>
<li><a href="/blogs/products/pages/.NET-Memory-Profiler.aspx">.NET Memory Profiler</a></li>
<li><a href="http://www.ndepend.com/">NDepend</a></li>
<li><a href="http://www.sapphiresteel.com/">Ruby In Steel</a></li>
<li><a href="http://www.slickedit.com/">SlickEdit</a></li>
<li><a href="http://www.gurock.com/products/smartinspect/">SmartInspect .NET Logging</a></li>
<li>NGEDIT: <a href="http://www.viemu.com/">ViEmu</a> and <a href="http://www.codekana.com/">Codekana</a> </li>
<li><a href="http://www.devexpress.com/" target="_blank">DevExpress</a></li>
<li><a href="http://nhprof.com" target="_blank">NHibernate Profiler</a></li>
<li><a href="http://unfuddle.com" target="_blank">Unfuddle</a></li>
<li><a href="http://www.balsamiq.com/products/mockups" target="_blank">Balsamiq Mockups</a></li>
<li><a href="http://scrumy.com" target="_blank">Scrumy</a> &lt;-- NEW Friend!</li>

	</ul>				
				</div><!-- #third .widget-area -->
				<div class="grid_4">
					CodeBetter.Com &copy; '11<br />
						Stuff you need to Code Better!<br />
				Proudly powered by <span id="generator-link"><a href="http://wordpress.org/" title="Semantic Personal Publishing Platform" rel="generator">WordPress</a></span>.					
				</div><!-- #fourth .widget-area -->
			</div><!-- #footer-widget-area -->		
		
			</div><!-- end div.container_12 -->

	</div><!-- end div#footer -->
		
<script type="text/javascript">

  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-531207-1']);
  _gaq.push(['_trackPageview']);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();

</script>
<script type='text/javascript' src='/wp-content/plugins/syntaxhighlighter/syntaxhighlighter3/scripts/shCore.js?ver=3.0.83b'></script>
<script type='text/javascript' src='/wp-content/plugins/syntaxhighlighter/syntaxhighlighter3/scripts/shBrushCSharp.js?ver=3.0.83b'></script>
<script type='text/javascript' src='/wp-content/plugins/syntaxhighlighter/syntaxhighlighter3/scripts/shBrushRuby.js?ver=3.0.83b'></script>
<script type='text/javascript' src='/wp-content/plugins/syntaxhighlighter/syntaxhighlighter3/scripts/shBrushJScript.js?ver=3.0.83b'></script>
<script type='text/javascript' src='/wp-content/plugins/syntaxhighlighter/syntaxhighlighter3/scripts/shBrushXml.js?ver=3.0.83b'></script>
<script type='text/javascript' src='/wp-content/plugins/syntaxhighlighter//third-party-brushes/shBrushFSharp.js?ver=3.0.83b'></script>
<script type='text/javascript'>
	(function(){
		var corecss = document.createElement('link');
		var themecss = document.createElement('link');
		var corecssurl = "/wp-content/plugins/syntaxhighlighter/syntaxhighlighter3/styles/shCore.css?ver=3.0.83b";
		if ( corecss.setAttribute ) {
				corecss.setAttribute( "rel", "stylesheet" );
				corecss.setAttribute( "type", "text/css" );
				corecss.setAttribute( "href", corecssurl );
		} else {
				corecss.rel = "stylesheet";
				corecss.href = corecssurl;
		}
		document.getElementsByTagName("head")[0].insertBefore( corecss, document.getElementById("syntaxhighlighteranchor") );
		var themecssurl = "/wp-content/plugins/syntaxhighlighter/syntaxhighlighter3/styles/shThemeDefault.css?ver=3.0.83b";
		if ( themecss.setAttribute ) {
				themecss.setAttribute( "rel", "stylesheet" );
				themecss.setAttribute( "type", "text/css" );
				themecss.setAttribute( "href", themecssurl );
		} else {
				themecss.rel = "stylesheet";
				themecss.href = themecssurl;
		}
		//document.getElementById("syntaxhighlighteranchor").appendChild(themecss);
		document.getElementsByTagName("head")[0].insertBefore( themecss, document.getElementById("syntaxhighlighteranchor") );
	})();
	SyntaxHighlighter.config.strings.expandSource = '+ expand source';
	SyntaxHighlighter.config.strings.help = '?';
	SyntaxHighlighter.config.strings.alert = 'SyntaxHighlighter\n\n';
	SyntaxHighlighter.config.strings.noBrush = 'Can\'t find brush for: ';
	SyntaxHighlighter.config.strings.brushNotHtmlScript = 'Brush wasn\'t configured for html-script option: ';
	SyntaxHighlighter.defaults['gutter'] = false;
    SyntaxHighlighter.defaults['tab-size'] = 2;
    SyntaxHighlighter.defaults['toolbar'] = false;
    SyntaxHighlighter.defaults['wrap-lines'] = false; 
	SyntaxHighlighter.defaults['pad-line-numbers'] = false;
	SyntaxHighlighter.all();
</script>
 
</body>
</html>
<!-- Dynamic page generated in 0.348 seconds. -->
<!-- Cached page generated by WP-Super-Cache on 2011-01-25 14:52:08 -->
<!-- super cache -->