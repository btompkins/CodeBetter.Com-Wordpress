<!DOCTYPE html>
<html dir="ltr" lang="en-US">
<head>
	<meta charset="UTF-8" />
    <title>Creating a functional programming model for MEF | Glenn Block</title>
	<link rel="profile" href="http://gmpg.org/xfn/11" />
	
	<link href="http://feeds.feedburner.com/CodeBetter" title="CodeBetter.Com &raquo; Feed" type="application/rss+xml" rel="alternate">
	
		<link rel="pingback" href="http://codebetter.com/glennblock/xmlrpc.php" />
	                <link rel="stylesheet" href="http://cdn1.codebetter.com/wp-content/uploads/spacker-cache/ea73517eb74a545f51c376487c94dc9f.css?v=3912785705" type="text/css" media="all" /><!-- Is Cache! -->
                <script type='text/javascript' src='https://ajax.googleapis.com/ajax/libs/jquery/1.6.0/jquery.min.js?ver=3.4.2'></script>
<script type='text/javascript' src='http://dtym7iokkjlif.cloudfront.net/dough/1.0/recipe.js'></script>
<link rel="EditURI" type="application/rsd+xml" title="RSD" href="http://codebetter.com/glennblock/xmlrpc.php?rsd" />
<link rel="wlwmanifest" type="application/wlwmanifest+xml" href="http://cdn1.codebetter.com/wp-includes/wlwmanifest.xml" /> 
<link rel='prev' title='Why doesn’t MEF support open-generics for exports? Because MEF is not type based.' href='http://codebetter.com/glennblock/2009/03/21/why-doesn-t-mef-support-open-generics-for-exports-because-mef-is-not-type-based/' />
<link rel='next' title='MEF Preview 5, changes and enhancements' href='http://codebetter.com/glennblock/2009/04/12/mef-preview-5-changes-and-enhancements/' />
<meta name="generator" content="WordPress 3.4.2" />
<link rel='shortlink' href='http://codebetter.com/glennblock/?p=89' />

<!-- All in One SEO Pack 1.6.13.2 by Michael Torbert of Semper Fi Web Design[83,151] -->
<link rel="canonical" href="http://codebetter.com/glennblock/2009/04/03/creating-a-functional-programming-model-for-mef/" />
<!-- /all in one seo pack -->
<link rel="stylesheet" href="http://cdn1.codebetter.com/wp-content/plugins/digg-digg/include/../css/diggdigg-style.css?ver=4.5.3.3" type="text/css" media="screen" />

<!-- Start Shareaholic OgTags -->

	<meta property='og:image' content='http://s3.amazonaws.com:80/CodeBetter/CommunityServer.Blogs.Components.WeblogFiles/glenn/block/image_thumb_1D725A15.png?AWSAccessKeyId=0KMA35HT86EVXB99Z302&amp;Expires=1920566609&amp;Signature=v1GEVYNXo4RCgUaydhtb9sCd4Fc%3d' />

<!-- End Shareaholic OgTags -->

<meta id="syntaxhighlighteranchor" name="syntaxhighlighter-version" content="3.1.3" />
                <script type="text/javascript" src="http://cdn1.codebetter.com/wp-content/uploads/spacker-cache/dc168cf39155d7b5d39f696ca94d5980.js?v=3981720249">/*Is Cache!*/</script>
                	
	<script type='text/javascript' src='http://d1.openx.org/spcjs.php?id=7744&amp;target=_blank'></script>
	<style type="text/css">body { padding-top:0px !important; } html { margin-top: 0px !important; }</style>
<!-- BuySellAds Ad Code -->
<script type="text/javascript">
(function(){
  var bsa = document.createElement('script');
     bsa.type = 'text/javascript';
     bsa.async = true;
     bsa.src = 'http://s3.buysellads.com/ac/bsa.js';
  (document.getElementsByTagName('head')[0]||document.getElementsByTagName('body')[0]).appendChild(bsa);
})();
</script>
<!-- End BuySellAds Ad Code -->
</head>

<body>

			
		<div class="container_12 ui-tabs ui-widget ui-widget-content ui-corner-all" id="tabs">			
			<ul class="ui-tabs-nav ui-helper-reset ui-helper-clearfix ui-widget-header ui-corner-all">
				<li class="ui-state-default ui-corner-top ui-tabs-selected ui-state-active"><a href="#ui-tabs-1">CodeBetter.Com</a></li>
				<li class="ui-state-default ui-corner-top"><a href="http://devlicio.us">Devlicio.Us</a></li>				
				<div id="top-search">
				<form action="http://codebetter.com/globalsearch/" id="cse-search-box">
  <div>
   <fieldset id="search">
		<input type="hidden" name="cx" value="005178204031477491434:2bg5jtwgsfe" />
		<input type="hidden" name="cof" value="FORID:9" />
		<input type="hidden" name="ie" value="UTF-8" />
		<input type="text"  class="text-input" id="s" name="q" size="31" />
		<input type="image" src="http://cdn1.codebetter.com/wp-content/themes/codebetter/images/search-img.png" class="form-button" id="searchsubmit" value="GO" name="">				   	
	</fieldset>
  </div>
</form>
<script type="text/javascript" src="http://www.google.com/cse/brand?form=cse-search-box&lang=en&sitesearch=true"></script>
				</div>				
			</ul><div id="ui-tabs-1" class="ui-tabs-panel ui-widget-content ui-corner-bottom"></div><div id="ui-tabs-2" class="ui-tabs-panel ui-widget-content ui-corner-bottom ui-tabs-hide"></div>
		</div>
			
		<div id="main" class="container_12">
		
			<div id="logo" class="grid_3"><a href="/" title="CodeBetter.Com - Stuff you need to Code Better!"><image src="http://cdn1.codebetter.com/wp-content/themes/codebetter/images/codebetter_logo.png" height="48" width="223"></image></a></div>
			<div id="ad_leaderboard" class="grid_9">
			<!-- BuySellAds Zone Code -->
<div id="bsap_1276080" class="bsarocks bsap_4fe632babdccc2b4b049e4f08cc3c549"></div>
<!-- End BuySellAds Zone Code --></div>
			
			<div id="globalNav" class="grid_12">
				<ul>
					<li><a href="http://codebetter.com" title="home">Home</a></li>
					<li class="page_item page-item-2"><a href="http://codebetter.com/about/">About</a></li>
<li class="page_item page-item-8"><a href="http://codebetter.com/codebetter-ci/">CodeBetter CI</a></li>
<li class="page_item page-item-6"><a href="http://codebetter.com/community/">Community</a></li>
<li class="page_item page-item-10"><a href="http://codebetter.com/editors/">Editors</a></li>
					<li><a href="http://feeds.feedburner.com/CodeBetter" rel="alternate" type="application/rss+xml"><img src="http://www.feedburner.com/fb/images/pub/feed-icon16x16.png" alt="" style="vertical-align:middle;border:0"/></a><a href="http://feeds.feedburner.com/CodeBetter"><img src="http://feeds.feedburner.com/~fc/CodeBetter?bg=EFEFEF&amp;fg=2E9BD2&amp;anim=1" height="26" width="88" style="vertical-align:middle;border:0"/></a></li>
				</ul>
								
			</div><!-- end div#globalNav.container_12 -->				
	
		<div id="content" class="container_12">
			<div id="main" class="grid_8">


				<div id="post-89" class="post-89 post type-post status-publish format-standard hentry category-mef">
					<h1 class="entry-title">Creating a functional programming model for MEF</h1>

					<div class="entry-meta">
						<span class="meta-prep meta-prep-author">Posted by </span>
						<span class="author vcard"><a class="url fn n" href="http://codebetter.com/glennblock/author/glennblock/" title="View all posts by Glenn Block">Glenn Block</a></span>
						<span class="meta-sep"> on  </span>
						<a href="http://codebetter.com/glennblock/2009/04/03/creating-a-functional-programming-model-for-mef/" title="10:00 am" rel="bookmark"><span class="entry-date">April 3, 2009</span></a>
											</div><!-- .entry-meta -->

					<div class="entry-content">
						<div id="greet_block"><noscript><div class="greet_block wpgb_cornered"><div class="greet_text"><div class="greet_image"><a href="http://codebetter.com/glennblock/feed/rss/"  rel="nofollow"><img src="http://cdn1.codebetter.com/wp-content/plugins/wp-greet-box/images/rss_icon.png" alt="WP Greet Box icon"/></a></div>Hello there! If you are new here, you might want to <a href="http://codebetter.com/glennblock/feed/rss/" rel="nofollow"><strong>subscribe to the RSS feed</strong></a> for updates on this topic.<div style="clear:both"></div><div class="greet_block_powered_by">Powered by <a href="http://omninoggin.com/projects/wordpress-plugins/wp-greet-box-wordpress-plugin/" title="WP Greet Box WordPress Plugin" style="text-decoration:none;">WP Greet Box</a> <a href="http://omninoggin.com/" title="WordPress Plugin" style="text-decoration:none;">WordPress Plugin</a></div><div style="clear:both"></div></div></div></noscript></div><!-- Start Shareaholic LikeButtonSetTop Automatic --><!-- End Shareaholic LikeButtonSetTop Automatic --><p><strong>Disclaimer:</strong> This is a prototype, not production ready code. It is more illustrative of what you can do with MEF, and how things work under the covers.</p>
<p>The other day I was working one of our internal partners who is looking to integrate MEF into their framework stack. One of the interesting ideas that came out of that discussion was around a need they had to add POCO instances directly to a catalog (in addition to using our standard attributed part). </p>
<p>Now MEF supports the ability to add existing instances to the container through the AddExportedObject method, but that did not suit their need.&nbsp; Instead they wanted these instances to actually be parts. Primarily because the types they were instantiating were not attributed MEF parts, and they did not want to incur the reflection cost.</p>
<p>I started thinking down the path of creating a programming model where the part definitions are actually wrapping instances. What I mean by programming model, is teach MEF a new way to represent parts, exports and imports. In MEF parlance, a programming model is almost like a type system, though far less complex. For more on programming models themselves, i&#8217;d refer you to Daniel&#8217;s nice post on programming models themselves <a href="http://blogs.msdn.com/dsplaisted/archive/2009/06/08/a-crash-course-on-the-mef-primitives.aspx">here</a>.</p>
<p>Out of the box, MEF ships with an attributed programming model, however others can be created by implementing on top of a set of abstractions we call the primitives. What&rsquo;s really nice about MEF is that all of the models can safely interact with one another in the container. </p>
<p>Building an instance model however is problematic in that parts in MEF should be lazily instantiated. I realized (probably due much influence of my <a href="http://code.google.com/p/autofac/">Autofac</a> workmate <a href="http://blogs.msdn.com/nblumhardt">Nick Blumhardt</a>) that the right way to go was not build an instance model, but rather build a model for representing functions as parts. And so, the FuncCatalog was born. </p>
<h1>FuncCatalog</h1>
<p>The FuncCatalog allows you to add functions directly to itself, and to associate those functions with a type to be exported. Each function gets a single parameter which is an ExportProvider. This allows you to build up an instance within your function, that can have constructor parameters pulled from the EP, similar to the registration style in Autofac.</p>
<p>Below is a sample acceptance test that illustrates how this works. In the example I am adding a function to funcCatalog which creates an OrderService. In the OrderService&rsquo;s constructor, I am passing in an ILogger that I retrieved from the Export Provider.</p>
<p>[<span style="color: #2b91af">TestMethod</span>] <br /><span style="color: blue">public void </span>FuncPartCanImportFromTheContainer() <br />{ <br />&nbsp;&nbsp;&nbsp; <span style="color: blue">var </span>catalog = <span style="color: blue">new</span><span style="color: #2b91af">AggregateCatalog</span>(); <br />&nbsp;&nbsp;&nbsp; catalog.Catalogs.Add(<span style="color: blue">new</span><span style="color: #2b91af">TypeCatalog</span>(<span style="color: blue">typeof </span>(<span style="color: #2b91af">AttributedLogger</span>)));</p>
<p>&nbsp;&nbsp;&nbsp; <span style="color: blue">var </span>funcCatalog = <span style="color: blue">new </span><span style="color: #2b91af">FuncCatalog</span>(); <br />&nbsp;&nbsp;&nbsp; funcCatalog.AddPart&lt;<span style="color: #2b91af">OrderService</span>&gt;( <br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ep =&gt; <span style="color: blue">new </span><span style="color: #2b91af">OrderService</span>(ep.GetExportedObject&lt;<span style="color: #2b91af">ILogger</span>&gt;())); <br />&nbsp;&nbsp;&nbsp; catalog.Catalogs.Add(funcCatalog); <br />&nbsp;&nbsp;&nbsp; <br />&nbsp;&nbsp;&nbsp; <span style="color: blue">var </span>container = <span style="color: blue">new </span><span style="color: #2b91af">CompositionContainer</span>(catalog); <br />&nbsp;&nbsp;&nbsp; <span style="color: blue">var </span>batch = <span style="color: blue">new </span><span style="color: #2b91af">CompositionBatch</span>(); <br />&nbsp;&nbsp;&nbsp; batch.AddExportedObject&lt;<span style="color: #2b91af">ExportProvider</span>&gt;(container); <br />&nbsp;&nbsp;&nbsp; container.Compose(batch); <br />&nbsp;&nbsp;&nbsp; <br />&nbsp;&nbsp;&nbsp; <span style="color: blue">var </span>service = container.GetExportedObject&lt;<span style="color: #2b91af">OrderService</span>&gt;(); <br />&nbsp;&nbsp;&nbsp; <span style="color: #2b91af">Assert</span>.IsNotNull(service.Logger); <br />}</p>
<p><a href="http://11011.net/software/vspaste"></a></p>
<p>In terms of what the code is doing, I am first creating an aggregate catalog (a catalog of catalogs). Then I am adding to it a type catalog which contains an AttributedLogger (that is a logger with an ExportAttribute on it). Next I am creating a FuncCatalog which I am adding the new func part to. Notice how the lambda passes ep.</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ep =&gt; <span style="color: blue">new </span><span style="color: #2b91af">OrderService</span>(ep.GetExportedObject&lt;<span style="color: #2b91af">ILogger</span>&gt;())</p>
<p>Next I am creating the container, and then adding itself to itself (via the batch) with ExportProvider as the contract. This is to allow the FuncPart to import the ExportProvider so it can use it to resolve other dependencies. </p>
<p>Finally I am asking the container to grab me an OrderService, which I am then checking to see if there is a logger present. Remember the logger actually was an attributed part that was added through MEF&rsquo;s normal catalogs. So right here we have an illustration of multiple models living side by side.</p>
<h1></h1>
<h1></h1>
<h1>How is it done?</h1>
<p>As I mentioned above, I created a custom programming model. Depending on the model, this can be a lot or a little work. <a href="http://www.thecodejunkie.com/">Andreas Haakanson</a> has a project on CodePlex that simplifies creating such programming models, but that is for another overdue post <img src='http://cdn1.codebetter.com/wp-includes/images/smilies/icon_smile.gif' alt=':-)' class='wp-smiley' /> &nbsp; Below I&rsquo;ll detail the approach I took in order to give you a view into how programming models work. </p>
<h1>Programming model players</h1>
<p>Below are the main abstractions you&nbsp; need to implement for building your own programming model which live in the System.ComponentModel.Composition.Primitives namespace.</p>
<p><a href="/cfs-file.ashx/__key/CommunityServer.Blogs.Components.WeblogFiles/glenn.block/image_5F00_031266FE.png"><img height="293" width="532" src="http://s3.amazonaws.com:80/CodeBetter/CommunityServer.Blogs.Components.WeblogFiles/glenn/block/image_thumb_1D725A15.png?AWSAccessKeyId=0KMA35HT86EVXB99Z302&amp;Expires=1920566609&amp;Signature=v1GEVYNXo4RCgUaydhtb9sCd4Fc%3d" alt="image" border="0" style="border-bottom: 0px;border-left: 0px;border-top: 0px;border-right: 0px" /></a> </p>
<p>Here&rsquo;s&nbsp; a quick summary of the responsibilities for each of these classes.</p>
<ul>
<li><strong>ComposablePartDefinition</strong> &ndash; Schema for a part, analogous to a type in many respects. As a matter of fact in our default Attributed Programming Model (APM), the Composable Part Definition wraps a type. Aside from being schema, the other main responsibility for CPD is to create a composable part. </li>
<li><strong>ImportDefinition</strong> &ndash; An import definition is carries information about a contract that a part needs, it&rsquo;s import. In the APM, import definitions are created for properties decorated with the ImportAttribute, or constructor parameters if the constructor has an ImportingConstructorAttribute.</li>
<li><strong>ExportDefinition</strong> &#8211; An export definition carries information about a contract that a part offers up, it&rsquo;s export. In the APM, an export definition is created for each member that is decorated with the ExportAttribute. This includes the class itself, or methods / properties.</li>
<li><strong>ComposablePartCatalog</strong> &ndash; The catalog aggregates part definitions, which the container will query during composition in order to find available exports. The catalog does not create any parts, it only returns requested definitions. In our APM, the catalogs read assemblies and types in order to create these definitions. </li>
<li><strong>ComposablePart &ndash;</strong> The part itself. If the CPD is the schema, then the part is the instance. This does not mean it is the actual instance that is being returned from the container. No. The part contains an instance which will get created only at the time when the first exported object actually pulled from it. There&rsquo;s a difference between an export and an exported object, but I&rsquo;ll resist to go deeper and try to explain it for now.</li>
</ul>
<p>In my new model I implemented FuncCatalog, FuncExportDefinition, FuncPart, and FuncPartDefinition. I did not need a new ImportDefinition as the standard one was fine. Also my parts only support a single import, namely an ExportProvider.</p>
<p><a href="/cfs-file.ashx/__key/CommunityServer.Blogs.Components.WeblogFiles/glenn.block/image_5F00_27574B80.png"><img height="310" width="538" src="http://s3.amazonaws.com:80/CodeBetter/CommunityServer.Blogs.Components.WeblogFiles/glenn/block/image_thumb_0663D8D9.png?AWSAccessKeyId=0KMA35HT86EVXB99Z302&amp;Expires=1920566609&amp;Signature=dO26SKCOTe0GvFU8OZc2rLyb6Qg%3d" alt="image" border="0" style="border-bottom: 0px;border-left: 0px;border-top: 0px;border-right: 0px" /></a> </p>
<h1>FuncExportDefinition</h1>
<p>Ok, so first stop is to build a FuncExportDefinition. In my case I need a definition that carries a custom function. So here it is.</p>
<pre><span style="color: blue">public class </span><span style="color: #2b91af">FuncExportDefinition </span>: <span style="color: #2b91af">ExportDefinition
</span>{
    <span style="color: blue">public </span>FuncExportDefinition(<span style="color: blue">string </span>contractName, 
        <span style="color: #2b91af">Func</span>&lt;<span style="color: #2b91af">ExportProvider</span>,<span style="color: blue">object</span>&gt; factory) :
        <span style="color: blue">base</span>(contractName, <span style="color: blue">null</span>)
    {
        Factory = factory;
    }

    <span style="color: blue">public </span><span style="color: #2b91af">Func</span>&lt;<span style="color: #2b91af">ExportProvider</span>, <span style="color: blue">object</span>&gt; Factory { <span style="color: blue">get</span>; <span style="color: blue">private set</span>; }
}</pre>
<p><a href="http://11011.net/software/vspaste"></a><a href="http://11011.net/software/vspaste"></a></p>
<p>&nbsp;</p>
<p>&nbsp;</p>
<p>Pretty simple, I basically allow associating a contract and an additional func which accepts an ExportProvider as a parameter and returns object. Now notice the second parameter I pass to the base class is null. That represents metadata. I decided for simplicity to not allow support of metadata, though that could easily be added back.</p>
<h1>FuncPartDefinition</h1>
<p>Now that I can define Funcs as exports, I need a PartDefinition which can carry that information, and manufacture a part. This one was a bit tricky, below are the important pieces.</p>
<pre><span style="color: blue">public abstract class </span><span style="color: #2b91af">FuncPartDefinition </span>: <span style="color: #2b91af">ComposablePartDefinition
</span>{}

<span style="color: blue">public class </span><span style="color: #2b91af">FuncPartDefinition</span>&lt;TContract&gt; : <span style="color: #2b91af">FuncPartDefinition 
</span>{
    <span style="color: blue">private static </span><span style="color: #2b91af">ContractBasedImportDefinition 
        </span>_exportProviderImportDefinition;


    <span style="color: blue">static </span>FuncPartDefinition()
    {
        <span style="color: blue">string </span>importContractName = <span style="color: #2b91af">CompositionServices</span>.GetContractName
            (<span style="color: blue">typeof</span>(<span style="color: #2b91af">ExportProvider</span>));
        _exportProviderImportDefinition = <span style="color: blue">new 
            </span><span style="color: #2b91af">ContractBasedImportDefinition</span>(
            importContractName, <span style="color: blue">null</span>,
            <span style="color: #2b91af">ImportCardinality</span>.ZeroOrOne, <span style="color: blue">false</span>, <span style="color: blue">false</span>,
            <span style="color: #2b91af">CreationPolicy</span>.Any);
    }

    <span style="color: blue">public </span>FuncPartDefinition(<span style="color: #2b91af">Func</span>&lt;<span style="color: #2b91af">ExportProvider</span>, <span style="color: blue">object</span>&gt; factory)
    {
        _exportDefinitions.Add(<span style="color: blue">new </span><span style="color: #2b91af">FuncExportDefinition
            </span>(<span style="color: #2b91af">CompositionServices</span>.GetContractName(<span style="color: blue">typeof</span>(TContract)),
            factory));
        _importDefinitions.Add(_exportProviderImportDefinition);
    }

    <span style="color: blue">public </span>FuncPartDefinition()
        : <span style="color: blue">this</span>((ep)=&gt;(TContract) <span style="color: #2b91af">Activator</span>.
            CreateInstance(<span style="color: blue">typeof </span>(TContract)))
    {
    }

    <span style="color: blue">public override </span><span style="color: #2b91af">ComposablePart </span>CreatePart()
    {
        <span style="color: blue">return new </span><span style="color: #2b91af">FuncPart</span>&lt;TContract&gt;(<span style="color: blue">this</span>);
    }
}</pre>
<h1></h1>
<p>As I mentioned earlier, my func parts need to access an ExportProvider so they can retrieve things from the container. The question was how to do this. I could make the ExportProvider a parameter on the constructor of the part. Then however, I would have to pass it in to the catalog, which would pass it in to the part. This is further problematic as catalogs can actually be passed to several containers. So I decided the easiest way to do it, was to have the part actually import the ExportProvider through MEF&rsquo;s composition, that is similar to the way I would import on an attributed part through a constructor param. </p>
<p>In order to do this, all I need is to add a single ImportDefinition to every part instance. The static constructor of FuncPartDefinition does the work of creating this definition. The definition never changes, and it is cheaper to create it once, which is&nbsp; why I made it static.</p>
<p>The instance constructor accepts the&nbsp; func. It then goes and creates a FuncExportDefinition which it adds to the collection of export definitions. Next it adds the export provider import. I added an additional overload just as a convenience which simply creates the type. Probably just being gratuitous <img src='http://cdn1.codebetter.com/wp-includes/images/smilies/icon_wink.gif' alt=';-)' class='wp-smiley' /> </p>
<p>Finally the CreatePart method goes and creates a FuncPart passing in the definition (the part&rsquo;s schema) which leads us to our next suspect.</p>
<h1>FuncPart</h1>
<p>This guys job is to pass back export definitions of our func, to the container on request. Those definitions can later be activated to invoke the actual func.</p>
<pre><span style="color: blue">public class </span><span style="color: #2b91af">FuncPart</span>&lt;TContract&gt; : <span style="color: #2b91af">ComposablePart 
</span>{
    <span style="color: blue">private </span><span style="color: #2b91af">FuncPartDefinition</span>&lt;TContract&gt; _definition;
    <span style="color: blue">private </span><span style="color: #2b91af">ExportProvider </span>_provider;

    <span style="color: blue">public </span>FuncPart(<span style="color: #2b91af">FuncPartDefinition</span>&lt;TContract&gt; definition)
    {
        _definition = definition;
    }

    <span style="color: blue">public override object </span>GetExportedObject(<span style="color: #2b91af">ExportDefinition </span>definition)
    {
        <span style="color: blue">var </span>funcExportDefinition = definition <span style="color: blue">as </span><span style="color: #2b91af">FuncExportDefinition</span>;
        <span style="color: blue">return </span>funcExportDefinition.Factory(_provider);
    }

    <span style="color: blue">public override void </span>SetImport(<span style="color: #2b91af">ImportDefinition </span>definition, 
        <span style="color: #2b91af">IEnumerable</span>&lt;<span style="color: #2b91af">Export</span>&gt; exports)
    {
        _provider = exports.First().GetExportedObject() <span style="color: blue">as </span><span style="color: #2b91af">ExportProvider</span>;
    }

    <span style="color: blue">public override </span><span style="color: #2b91af">IEnumerable</span>&lt;<span style="color: #2b91af">ExportDefinition</span>&gt; ExportDefinitions
    {
        <span style="color: blue">get </span>{ <span style="color: blue">return </span>_definition.ExportDefinitions; }
    }

    <span style="color: blue">public override </span><span style="color: #2b91af">IEnumerable</span>&lt;<span style="color: #2b91af">ImportDefinition</span>&gt; ImportDefinitions
    {
        <span style="color: blue">get </span>{ <span style="color: blue">return </span>_definition.ImportDefinitions; }
    }
}</pre>
<p><a href="http://11011.net/software/vspaste"></a></p>
<p>When the part gets constructed, it stores a copy of it&rsquo;s definition. The ExportDefinitions and ImportDefinitions delegate directly to the part definitions members. In the SetImport method I have got a bit of a hack going on. This method will get called by the composition engine to set the imports. In the method, I am grabbing the first export passed in and then assuming it is the export provider. This is actually an OK assumption in my case, since there is only a single import that I allow in my programming model. However, I really should be verifying that it is passing me the right definition.</p>
<p>And just when you thought I was done with hacks, another one <img src='http://cdn1.codebetter.com/wp-includes/images/smilies/icon_smile.gif' alt=':-)' class='wp-smiley' />  GetExportedObject takes the definition passed to it and assumes it is a FuncExportDefinition. Again, this is an ok assumption in the cases where I am using it, but it should be more bullet proof and not make those assumptions. Anyway, once it has the definition&nbsp; unwrapped, it grabs the factory and invokes it passing in the provider.</p>
<h1>FuncCatalog</h1>
<p>Last stop on our journey is the func catalog.&nbsp; He&rsquo;s actually pretty straightforward. I added a few convenience methods on him so that you don&rsquo;t have to create parts a head of time.</p>
<pre><span style="color: blue">public class </span><span style="color: #2b91af">FuncCatalog </span>: <span style="color: #2b91af">ComposablePartCatalog</span>,     
    <span style="color: #2b91af">INotifyComposablePartCatalogChanged
</span>{
    <span style="color: blue">private </span><span style="color: #2b91af">List</span>&lt;<span style="color: #2b91af">ComposablePartDefinition</span>&gt; _parts = <span style="color: blue">new </span><span style="color: #2b91af">List</span>&lt;<span style="color: #2b91af">ComposablePartDefinition</span>&gt;();

    <span style="color: blue">public </span><span style="color: #2b91af">FuncPartDefinition </span>AddPart&lt;T&gt;(
        <span style="color: #2b91af">Func</span>&lt;<span style="color: #2b91af">ExportProvider</span>, <span style="color: blue">object</span>&gt; factory)
    {
        <span style="color: blue">var </span>addedParts = <span style="color: blue">new </span><span style="color: #2b91af">List</span>&lt;<span style="color: #2b91af">FuncPartDefinition</span>&gt;();
        <span style="color: blue">var </span>definition = <span style="color: blue">new </span><span style="color: #2b91af">FuncPartDefinition</span>&lt;T&gt;(factory);
        _parts.Add(definition);
        
        addedParts.Add(definition);
        OnChanged(addedParts);
        <span style="color: blue">return </span>definition;

    }

    <span style="color: blue">public void </span>AddParts(<span style="color: blue">params </span><span style="color: #2b91af">FuncPartDefinition</span>[] parts)
    {
        _parts.AddRange(parts);
        OnChanged(parts);
    }

    <span style="color: blue">public void </span>RemoveParts(<span style="color: blue">params </span><span style="color: #2b91af">FuncPartDefinition</span>[] parts)
    {
        _parts.RemoveAll(c =&gt; parts.Contains(c));
        OnChanged(parts);
    }
    
    <span style="color: blue">public override </span><span style="color: #2b91af">IQueryable</span>&lt;<span style="color: #2b91af">ComposablePartDefinition</span>&gt; Parts
    {
        <span style="color: blue">get
        </span>{
            <span style="color: blue">return </span>_parts.AsQueryable();
        }
    }

    <span style="color: blue">private void </span>OnChanged(<span style="color: #2b91af">IEnumerable</span>&lt;<span style="color: #2b91af">FuncPartDefinition</span>&gt; parts)
    {
        <span style="color: blue">var </span>args = <span style="color: blue">new </span><span style="color: #2b91af">ComposablePartCatalogChangedEventArgs</span>(
            parts.Cast&lt;<span style="color: #2b91af">ComposablePartDefinition</span>&gt;());
        Changed(<span style="color: blue">this</span>, args);
    }

    <span style="color: blue">public event </span><span style="color: #2b91af">EventHandler</span>&lt;<span style="color: #2b91af">ComposablePartCatalogChangedEventArgs</span>&gt; 
        Changed = <span style="color: blue">delegate </span>{ };
}</pre>
<p><a href="http://11011.net/software/vspaste"></a></p>
<p>First thing is the catalog implements INotifyComposablePartCatalogChanged. This is to allow the catalog to notify the container when parts are added or removed from it. Implementing a catalog only requires to to override one property, namely the Parts property, which as you can see returns a queryable of Parts. The rest of the methods are concerned with the mutability of the container. Now catalogs do not have to be mutable, as you can handle loading up all the part defs in the constructor. However, for usability sake, I wanted mine to&nbsp; be mutable. This means that I need to have methods for adding, removing, and I need to support notification.&nbsp; The code should be pretty easy to follow.</p>
<h1></h1>
<h1>So what have we learned?</h1>
<p>Well first thing we learned that MEF supports alternative programming models other than the attributed model we ship in the box. Next, we learned about the key concepts involved in authoring your own programming model. In this case the model was very, very simple, which is why I was able to cover it in a single post. I am not recommending every one go out an author their own model. Lastly we saw learned that parts can be functions <img src='http://cdn1.codebetter.com/wp-includes/images/smilies/icon_smile.gif' alt=':-)' class='wp-smiley' /> </p>
<p>If your interested in other applications of programming models in MEF, I recommend you check out Nick Blumhart&rsquo;s posts on Ruby. Also don&rsquo;t forget to check out <a href="http://www.thecodejunkie.com">Andreas&rsquo;s</a> <a href="http://mefcontrib.codeplex.com/Wiki/View.aspx?title=Documentation%20%26%20Features&amp;referringTitle=Home">provider based programming model</a> on MefContrib. </p>
<div class="shr-publisher-89"></div><!-- Start Shareaholic LikeButtonSetBottom Automatic --><!-- End Shareaholic LikeButtonSetBottom Automatic -->											</div><!-- .entry-content -->


					<div class="entry-utility">
					This entry was posted in <a href="http://codebetter.com/glennblock/category/mef/" title="View all posts in MEF" rel="category tag">MEF</a>. Bookmark the <a href="http://codebetter.com/glennblock/2009/04/03/creating-a-functional-programming-model-for-mef/" title="Permalink to Creating a functional programming model for MEF" rel="bookmark">permalink</a>. Follow any comments here with the <a href="http://codebetter.com/glennblock/2009/04/03/creating-a-functional-programming-model-for-mef/feed/" title="Comments RSS to Creating a functional programming model for MEF" rel="alternate" type="application/rss+xml">RSS feed for this post</a>.
					</div><!-- .entry-utility -->
				</div><!-- #post-89 -->

				<div id="nav-below" class="navigation">
					<div class="nav-previous"><a href="http://codebetter.com/glennblock/2009/03/21/why-doesn-t-mef-support-open-generics-for-exports-because-mef-is-not-type-based/" rel="prev"><span class="meta-nav">&larr;</span> Why doesn’t MEF support open-generics for exports? Because MEF is not type based.</a></div>
					<div class="nav-next"><a href="http://codebetter.com/glennblock/2009/04/12/mef-preview-5-changes-and-enhancements/" rel="next">MEF Preview 5, changes and enhancements <span class="meta-nav">&rarr;</span></a></div>
				</div><!-- #nav-below -->

				
<div id="disqus_thread">
    </div>

<script type="text/javascript">
/* <![CDATA[ */
    var disqus_url = 'http://codebetter.com/glennblock/2009/04/03/creating-a-functional-programming-model-for-mef/';
    var disqus_identifier = '89 /blogs/glenn.block/archive/2009/04/03/creating-a-functional-programming-model-for-mef.aspx';
    var disqus_container_id = 'disqus_thread';
    var disqus_domain = 'disqus.com';
    var disqus_shortname = 'mytechnobabble';
    var disqus_title = "Creating a functional programming model for MEF";
        var disqus_config = function () {
        var config = this; // Access to the config object

        /* 
           All currently supported events:
            * preData — fires just before we request for initial data
            * preInit - fires after we get initial data but before we load any dependencies
            * onInit  - fires when all dependencies are resolved but before dtpl template is rendered
            * afterRender - fires when template is rendered but before we show it
            * onReady - everything is done
         */

        config.callbacks.preData.push(function() {
            // clear out the container (its filled for SEO/legacy purposes)
            document.getElementById(disqus_container_id).innerHTML = '';
        });
                config.callbacks.onReady.push(function() {
            // sync comments in the background so we don't block the page
            DISQUS.request.get('?cf_action=sync_comments&post_id=89');
        });
                    };
    var facebookXdReceiverPath = 'http://cdn1.codebetter.com/wp-content/plugins/disqus-comment-system/xd_receiver.htm';
/* ]]> */
</script>

<script type="text/javascript">
/* <![CDATA[ */
    var DsqLocal = {
        'trackbacks': [
        ],
        'trackback_url': "http:\/\/codebetter.com\/glennblock\/2009\/04\/03\/creating-a-functional-programming-model-for-mef\/trackback\/"    };
/* ]]> */
</script>

<script type="text/javascript">
/* <![CDATA[ */
(function() {
    var dsq = document.createElement('script'); dsq.type = 'text/javascript';
    dsq.async = true;
    dsq.src = 'http://' + disqus_shortname + '.' + disqus_domain + '/embed.js?pname=wordpress&pver=2.67';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();
/* ]]> */
</script>

		</div><!-- #main -->
			<div id="sidebar" class="grid_4">

		<div id="primary" class="widget-area">
			<ul class="xoxo">
				<div class="ad-container">
<script type='text/javascript'><!--// <![CDATA[
    OA_show(29416);
// ]]> --></script><noscript><a target='_blank' href='http://d1.openx.org/ck.php?n=2782afb'><img border='0' alt='' src='http://d1.openx.org/avw.php?zoneid=29416&amp;n=2782afb' /></a></noscript><script type='text/javascript'><!--// <![CDATA[
    OA_show(29417);
// ]]> --></script><noscript><a target='_blank' href='http://d1.openx.org/ck.php?n=e94cea6'><img border='0' alt='' src='http://d1.openx.org/avw.php?zoneid=29417&amp;n=e94cea6' /></a></noscript><script type='text/javascript'><!--// <![CDATA[
    OA_show(29418);
// ]]> --></script><noscript><a target='_blank' href='http://d1.openx.org/ck.php?n=9ba3022'><img border='0' alt='' src='http://d1.openx.org/avw.php?zoneid=29418&amp;n=9ba3022' /></a></noscript><script type='text/javascript'><!--// <![CDATA[
    OA_show(29419);
// ]]> --></script><noscript><a target='_blank' href='http://d1.openx.org/ck.php?n=f467b52'><img border='0' alt='' src='http://d1.openx.org/avw.php?zoneid=29419&amp;n=f467b52' /></a></noscript>
				</div>
			
				<li id="user_bio-2" class="widget-container widget_user_bio"><h3 class="widget-title"></h3>One of these days I will add something to my user profile! For now, I shall remain mysterious.
</li>		
						
			</ul>
			
		</div><!-- #primary .widget-area -->
		
		<div id="secondary" class="widget-area">
				
<script type='text/javascript'><!--// <![CDATA[
    OA_show(220407);
// ]]> --></script><noscript><a target='_blank' href='http://d1.openx.org/ck.php?n=68b8307'><img border='0' alt='' src='http://d1.openx.org/avw.php?zoneid=220407&amp;n=68b8307' /></a></noscript>				
				
				<ul class="xoxo">		
									</ul>	
				
<script type='text/javascript'><!--// <![CDATA[
    OA_show(29421);
// ]]> --></script><noscript><a target='_blank' href='http://d1.openx.org/ck.php?n=3f8e353'><img border='0' alt='' src='http://d1.openx.org/avw.php?zoneid=29421&amp;n=3f8e353' /></a></noscript>
				
		</div><!-- #secondary .widget-area -->			</div><!--sidebar-->
		</div><!-- #container -->
</div><!-- end div tabs see header.php -->
	
	<div id="footer">
		<div class="container_12">
		<div id="footer-widget-area">
				<div class="grid_4">					
					<ul>
					<li><a href="http://codebetter.com" title="home">Home</a></li>
					<li class="page_item page-item-2"><a href="http://codebetter.com/about/">About</a></li>
<li class="page_item page-item-8"><a href="http://codebetter.com/codebetter-ci/">CodeBetter CI</a></li>
<li class="page_item page-item-6"><a href="http://codebetter.com/community/">Community</a></li>
<li class="page_item page-item-10"><a href="http://codebetter.com/editors/">Editors</a></li>
<li class="page_item page-item-41"><a href="http://codebetter.com/globalsearch/">Search Results</a></li>
					<li><a href="http://feeds.feedburner.com/CodeBetter" rel="alternate" type="application/rss+xml"><img src="http://www.feedburner.com/fb/images/pub/feed-icon16x16.png" alt="" style="vertical-align:middle;border:0"/></a><a href="http://feeds.feedburner.com/CodeBetter"><img src="http://feeds.feedburner.com/~fc/CodeBetter?bg=FFFFFF&amp;fg=2E9BD2&amp;anim=1" height="26" width="88" style="vertical-align:middle;border:0"/></a></li>
					</ul>
				</div><!-- #second .widget-area -->
				<div class="grid_4">
					
					<h3>Friends of CodeBetter.Com</h3>
<ul>

<li><a href="http://red-gate.com/">Red-Gate Tools For SQL and .NET</a></li>
<li><a href="http://telerik.com">Telerik .NET Tools</a></li>
<li><a href="http://jetbrains.com/resharper/">JetBrains - ReSharper</a></li>
<li><a href="http://scootersoftware.com">Beyond Compare</a></li>
<li><a href="http://www.ndepend.com/">NDepend</a></li>
<li><a href="http://www.sapphiresteel.com/">Ruby In Steel</a></li>
<li><a href="http://www.slickedit.com/">SlickEdit</a></li>
<li><a href="http://www.gurock.com/products/smartinspect/">SmartInspect .NET Logging</a></li>
<li>NGEDIT: <a href="http://www.viemu.com/">ViEmu</a> and <a href="http://www.codekana.com/">Codekana</a> </li>
<li><a href="http://www.devexpress.com/" target="_blank">DevExpress</a></li>
<li><a href="http://nhprof.com" target="_blank">NHibernate Profiler</a></li>
<li><a href="http://unfuddle.com" target="_blank">Unfuddle</a></li>
<li><a href="http://www.balsamiq.com/products/mockups" target="_blank">Balsamiq Mockups</a></li>
<li><a href="http://scrumy.com" target="_blank">Scrumy</a></li>
<li><a href="http://umbraco.com" target="_blank">Umbraco</a></li>
<li><a href="http://nservicebus.com" target="_blank">NServiceBus</a></li>
<li><a href="http://ravendb.net" target="_blank">RavenDb</a></li>
<li><a href="http://www.websequencediagrams.com/" target="_blank">Web Sequence Diagrams</a></li>
	</ul>				
				</div><!-- #third .widget-area -->
				<div class="grid_4">
					CodeBetter.Com &copy; '12<br />
						Stuff you need to Code Better!<br />
				Proudly powered by <span id="generator-link"><a href="http://wordpress.org/" title="Semantic Personal Publishing Platform" rel="generator">WordPress</a></span>.					
				</div><!-- #fourth .widget-area -->
			</div><!-- #footer-widget-area -->		
		
			</div><!-- end div.container_12 -->

	</div><!-- end div#footer -->
		
<script type="text/javascript">

  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-531207-1']);
  _gaq.push(['_trackPageview']);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();

</script>
<script type='text/javascript' src='http://cdn1.codebetter.com/wp-content/plugins/syntaxhighlighter/syntaxhighlighter3/scripts/shCore.js?ver=3.0.83b'></script>
<script type='text/javascript' src='http://cdn1.codebetter.com/wp-content/plugins/syntaxhighlighter/syntaxhighlighter3/scripts/shBrushCSharp.js?ver=3.0.83b'></script>
<script type='text/javascript' src='http://cdn1.codebetter.com/wp-content/plugins/syntaxhighlighter/syntaxhighlighter3/scripts/shBrushRuby.js?ver=3.0.83b'></script>
<script type='text/javascript' src='http://cdn1.codebetter.com/wp-content/plugins/syntaxhighlighter/syntaxhighlighter3/scripts/shBrushJScript.js?ver=3.0.83b'></script>
<script type='text/javascript' src='http://cdn1.codebetter.com/wp-content/plugins/syntaxhighlighter/syntaxhighlighter3/scripts/shBrushXml.js?ver=3.0.83b'></script>
<script type='text/javascript' src='http://cdn1.codebetter.com/wp-content/plugins/syntaxhighlighter/syntaxhighlighter3/scripts/shBrushPython.js?ver=3.0.83b'></script>
<script type='text/javascript' src='http://cdn1.codebetter.com/wp-content/plugins/syntaxhighlighter/third-party-brushes/shBrushFSharp.js?ver=3.0.83b'></script>
<script type='text/javascript'>
	(function(){
		var corecss = document.createElement('link');
		var themecss = document.createElement('link');
		var corecssurl = "http://cdn1.codebetter.com/wp-content/plugins/syntaxhighlighter/syntaxhighlighter3/styles/shCore.css?ver=3.0.83b";
		if ( corecss.setAttribute ) {
				corecss.setAttribute( "rel", "stylesheet" );
				corecss.setAttribute( "type", "text/css" );
				corecss.setAttribute( "href", corecssurl );
		} else {
				corecss.rel = "stylesheet";
				corecss.href = corecssurl;
		}
		document.getElementsByTagName("head")[0].insertBefore( corecss, document.getElementById("syntaxhighlighteranchor") );
		var themecssurl = "http://cdn1.codebetter.com/wp-content/plugins/syntaxhighlighter/syntaxhighlighter3/styles/shThemeDefault.css?ver=3.0.83b";
		if ( themecss.setAttribute ) {
				themecss.setAttribute( "rel", "stylesheet" );
				themecss.setAttribute( "type", "text/css" );
				themecss.setAttribute( "href", themecssurl );
		} else {
				themecss.rel = "stylesheet";
				themecss.href = themecssurl;
		}
		//document.getElementById("syntaxhighlighteranchor").appendChild(themecss);
		document.getElementsByTagName("head")[0].insertBefore( themecss, document.getElementById("syntaxhighlighteranchor") );
	})();
	SyntaxHighlighter.config.strings.expandSource = '+ expand source';
	SyntaxHighlighter.config.strings.help = '?';
	SyntaxHighlighter.config.strings.alert = 'SyntaxHighlighter\n\n';
	SyntaxHighlighter.config.strings.noBrush = 'Can\'t find brush for: ';
	SyntaxHighlighter.config.strings.brushNotHtmlScript = 'Brush wasn\'t configured for html-script option: ';
	SyntaxHighlighter.defaults['gutter'] = false;
    SyntaxHighlighter.defaults['tab-size'] = 2;
    SyntaxHighlighter.defaults['toolbar'] = false;
    SyntaxHighlighter.defaults['wrap-lines'] = true; 
	SyntaxHighlighter.defaults['pad-line-numbers'] = false;
	SyntaxHighlighter.all();
</script>

<script type='text/javascript'>//<![CDATA[
    if (typeof jQuery == 'undefined') {
        document.write(unescape("%3Cscript src='http://ajax.aspnetcdn.com/ajax/jQuery/jquery-1.4.2.min.js' type='text/javascript' %3E%3C/script%3E"));
    }//]]></script>
<script type='text/javascript' language='Javascript' src='http://s1.lqcdn.com/m.min.js?dt=2.3.110202.1'></script>
<script type='text/javascript' language='Javascript'> if(jQuery.LqmAds)jQuery.LqmAds();</script>
 
</body>
</html>
<!-- Dynamic page generated in 0.778 seconds. -->
<!-- Cached page generated by WP-Super-Cache on 2012-11-09 18:51:00 -->
<!-- super cache -->