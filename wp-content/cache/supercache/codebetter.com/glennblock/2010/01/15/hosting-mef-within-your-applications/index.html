<!DOCTYPE html>
<html dir="ltr" lang="en-US">
<head>
	<meta charset="UTF-8" />
    <title>Hosting MEF within application and libraries. | Glenn Block</title>
	<link rel="profile" href="http://gmpg.org/xfn/11" />
	
	<link href="http://feeds.feedburner.com/CodeBetter" title="CodeBetter.Com &raquo; Feed" type="application/rss+xml" rel="alternate">
	
		<link rel="pingback" href="http://codebetter.com/glennblock/xmlrpc.php" />
	                <link rel="stylesheet" href="http://codebetter.com/glennblock/wp-content/uploads/spacker-cache/ea73517eb74a545f51c376487c94dc9f.css" type="text/css" media="all" /><!-- Is Cache! -->
                <script type='text/javascript' src='http://codebetter.com/glennblock/wp-includes/js/l10n.js?ver=20101110'></script>
<link rel="EditURI" type="application/rsd+xml" title="RSD" href="http://codebetter.com/glennblock/xmlrpc.php?rsd" />
<link rel="wlwmanifest" type="application/wlwmanifest+xml" href="http://codebetter.com/glennblock/wp-includes/wlwmanifest.xml" /> 
<link rel='index' title='Glenn Block' href='http://codebetter.com/glennblock/' />
<link rel='start' title='IoC.AddComponent&lt;IBloggingStrategy, CodeBetterBloggingStrategy&gt;();' href='http://codebetter.com/glennblock/2008/01/03/ioc-addcomponent-lt-ibloggingstrategy-codebetterbloggingstrategy-gt/' />
<link rel='prev' title='MEF and Prism exploration, MEF module loading' href='http://codebetter.com/glennblock/2010/01/03/mef-and-prism-exploration-mef-module-loading/' />
<link rel='next' title='How do I expose configuration information through MEF?' href='http://codebetter.com/glennblock/2010/01/27/how-do-i-expose-configuration-information-through-mef/' />
<meta name="generator" content="WordPress 3.1-beta1-16732" />
<link rel='canonical' href='http://codebetter.com/glennblock/2010/01/15/hosting-mef-within-your-applications/' />
<link rel='shortlink' href='http://codebetter.com/glennblock/?p=114' />
<link rel="stylesheet" href="http://codebetter.com/glennblock/wp-content/plugins/digg-digg/include/../css/diggdigg-style.css?ver=4.5.0.7" type="text/css" media="screen" /><link rel="stylesheet" href="http://disqus.com/stylesheets/mytechnobabble/disqus.css?v=2.0" type="text/css" media="screen" /><meta id="syntaxhighlighteranchor" name="syntaxhighlighter-version" content="3.1.1" />
                <script type="text/javascript" src="http://codebetter.com/glennblock/wp-content/uploads/spacker-cache/a8046d2f1fc1c08af413701218a11c1d.js">/*Is Cache!*/</script>
                	<style type="text/css">body { padding-top:0px !important; } html { margin-top: 0px !important; }</style>

</head>

<body>

			
		<div class="container_12 ui-tabs ui-widget ui-widget-content ui-corner-all" id="tabs">			
			<ul class="ui-tabs-nav ui-helper-reset ui-helper-clearfix ui-widget-header ui-corner-all">
				<li class="ui-state-default ui-corner-top ui-tabs-selected ui-state-active"><a href="#ui-tabs-1">CodeBetter.Com</a></li>
				<li class="ui-state-default ui-corner-top"><a href="http://devlicio.us">Devlicio.Us</a></li>				
				<div id="top-search">
				<form action="http://codebetter.com/globalsearch/" id="cse-search-box">
  <div>
   <fieldset id="search">
		<input type="hidden" name="cx" value="005178204031477491434:2bg5jtwgsfe" />
		<input type="hidden" name="cof" value="FORID:9" />
		<input type="hidden" name="ie" value="UTF-8" />
		<input type="text"  class="text-input" id="s" name="q" size="31" />
		<input type="image" src="/wp-content/themes/codebetter/images/search-img.png" class="form-button" id="searchsubmit" value="GO" name="">				   	
	</fieldset>
  </div>
</form>
<script type="text/javascript" src="http://www.google.com/cse/brand?form=cse-search-box&lang=en&sitesearch=true"></script>
				</div>				
			</ul><div id="ui-tabs-1" class="ui-tabs-panel ui-widget-content ui-corner-bottom"></div><div id="ui-tabs-2" class="ui-tabs-panel ui-widget-content ui-corner-bottom ui-tabs-hide"></div>
		</div>
			
		<div id="main" class="container_12">
		
			<div id="logo" class="grid_3"><a href="/" title="CodeBetter.Com - Stuff you need to Code Better!"><image src="/wp-content/themes/codebetter/images/codebetter_logo.png" height="48" width="223"></image></a></div>
			<div id="ad_leaderboard" class="grid_9">			</div>
			
			<div id="globalNav" class="grid_12">
				<ul>
					<li><a href="http://codebetter.com" title="home">Home</a></li>
					<li class="page_item page-item-2"><a href="http://codebetter.com/about/" title="About">About</a></li>
<li class="page_item page-item-8"><a href="http://codebetter.com/codebetter-ci/" title="CodeBetter CI">CodeBetter CI</a></li>
<li class="page_item page-item-6"><a href="http://codebetter.com/community/" title="Community">Community</a></li>
<li class="page_item page-item-10"><a href="http://codebetter.com/editors/" title="Editors">Editors</a></li>
					<li><a href="http://feeds.feedburner.com/CodeBetter" rel="alternate" type="application/rss+xml"><img src="http://www.feedburner.com/fb/images/pub/feed-icon16x16.png" alt="" style="vertical-align:middle;border:0"/></a><a href="http://feeds.feedburner.com/CodeBetter"><img src="http://feeds.feedburner.com/~fc/CodeBetter?bg=EFEFEF&amp;fg=2E9BD2&amp;anim=1" height="26" width="88" style="vertical-align:middle;border:0"/></a></li>
				</ul>
								
			</div><!-- end div#globalNav.container_12 -->				
	
		<div id="content" class="container_12">
			<div id="main" class="grid_8">


				<div id="post-114" class="post-114 post type-post status-publish format-standard hentry category-mef">
					<h1 class="entry-title">Hosting MEF within application and libraries.</h1>

					<div class="entry-meta">
						<span class="meta-prep meta-prep-author">Posted by </span>
						<span class="author vcard"><a class="url fn n" href="http://codebetter.com/glennblock/author/glennblock/" title="View all posts by Glenn Block">Glenn Block</a></span>
						<span class="meta-sep"> on  </span>
						<a href="http://codebetter.com/glennblock/2010/01/15/hosting-mef-within-your-applications/" title="7:26 pm" rel="bookmark"><span class="entry-date">January 15, 2010</span></a>
											</div><!-- .entry-meta -->

					<div class="entry-content">
						<div id="greet_block"><noscript><div class="greet_block wpgb_cornered"><div class="greet_text"><div class="greet_image"><a href="http://codebetter.com/glennblock/feed/rss/"  rel="nofollow"><img src="http://codebetter.com/glennblock/wp-content/plugins/wp-greet-box/images/rss_icon.png" alt="WP Greet Box icon"/></a></div>Hello there! If you are new here, you might want to <a href="http://codebetter.com/glennblock/feed/rss/" rel="nofollow"><strong>subscribe to the RSS feed</strong></a> for updates on this topic.<div style="clear:both"></div><div class="greet_block_powered_by">Powered by <a href="http://omninoggin.com/projects/wordpress-plugins/wp-greet-box-wordpress-plugin/" title="WP Greet Box WordPress Plugin" style="text-decoration:none;">WP Greet Box</a> <a href="http://omninoggin.com/" title="WordPress Plugin" style="text-decoration:none;">WordPress Plugin</a></div><div style="clear:both"></div></div></div></noscript></div><p>As you start to work with MEF one of the fundamental decisions you have to make is how MEF will be hosted. There are several factors which will impact your decision including whether you are building on Silverlight or the Desktop and whether you are building an application or a library.</p>
<p>The first concern you hit around MEF is how and where composition starts. MEF parts at the end of the day are simply classes (in our attributed model). Simply adding an Export attribute to a class does not cause it to get composed as something has to start the composition. That responsibility falls on the CompositionContainer. It uses one or more catalogs to discover the available parts in the system. Once the container is created, composition can begin. But it doesn&rsquo;t begin until the container is asked to do work. This normally happens in the entry point of the application or application root, which in a WPF/Silverlight application would be the Application class.</p>
<p>There are several approaches to composition in MEF.</p>
<h1>Composing an existing part</h1>
<p>The first approach is to pass an existing instance to MEF and ask it to compose it. The advantage of this approach is that it lets you declare imports on the existing application instance.</p>
<pre>
<pre style="background-color: #ffffff;margin: 0em;width: 100%;font-family: consolas,'Courier New',courier,monospace;font-size: 10px">[Import]
</pre>
<pre style="background-color: #ffffff;margin: 0em;width: 100%;font-family: consolas,'Courier New',courier,monospace;font-size: 10px"><span style="color: #0000ff">public</span> Window MainWindow { <span style="color: #0000ff">get</span>; <span style="color: #0000ff">set</span>; }
</pre>
<pre style="background-color: #ffffff;margin: 0em;width: 100%;font-family: consolas,'Courier New',courier,monospace;font-size: 10px"></pre>
<pre style="background-color: #ffffff;margin: 0em;width: 100%;font-family: consolas,'Courier New',courier,monospace;font-size: 10px"><span style="color: #0000ff">void</span> App_Startup(<span style="color: #0000ff">object</span> sender, StartupEventArgs e)
</pre>
<pre style="background-color: #ffffff;margin: 0em;width: 100%;font-family: consolas,'Courier New',courier,monospace;font-size: 10px">{
</pre>
<pre style="background-color: #ffffff;margin: 0em;width: 100%;font-family: consolas,'Courier New',courier,monospace;font-size: 10px">    var catalog = <span style="color: #0000ff">new</span> AssemblyCatalog(<span style="color: #0000ff">typeof</span>(App).Assembly);
</pre>
<pre style="background-color: #ffffff;margin: 0em;width: 100%;font-family: consolas,'Courier New',courier,monospace;font-size: 10px">    var container = <span style="color: #0000ff">new</span> CompositionContainer(catalog);
</pre>
<pre style="background-color: #ffffff;margin: 0em;width: 100%;font-family: consolas,'Courier New',courier,monospace;font-size: 10px">    container.ComposeParts(<span style="color: #0000ff">this</span>);
</pre>
<pre style="background-color: #ffffff;margin: 0em;width: 100%;font-family: consolas,'Courier New',courier,monospace;font-size: 10px">    <span style="color: #0000ff">base</span>.MainWindow = Window;
</pre>
<pre style="background-color: #ffffff;margin: 0em;width: 100%;font-family: consolas,'Courier New',courier,monospace;font-size: 10px">    MainWindow.Show();
</pre>
<pre style="background-color: #ffffff;margin: 0em;width: 100%;font-family: consolas,'Courier New',courier,monospace;font-size: 10px">}
</pre>
</pre>
<h1>Pulling on the container for an export</h1>
<p>In this approach you pull on the container and ask MEF to create a part.</p>
<pre>
<pre style="background-color: #ffffff;margin: 0em;width: 100%;font-family: consolas,'Courier New',courier,monospace;font-size: 10px"><span style="color: #0000ff">void</span> App_Startup(<span style="color: #0000ff">object</span> sender, StartupEventArgs e)
</pre>
<pre style="background-color: #ffffff;margin: 0em;width: 100%;font-family: consolas,'Courier New',courier,monospace;font-size: 10px">{
</pre>
<pre style="background-color: #ffffff;margin: 0em;width: 100%;font-family: consolas,'Courier New',courier,monospace;font-size: 10px">    var catalog = <span style="color: #0000ff">new</span> AssemblyCatalog(<span style="color: #0000ff">typeof</span> (App).Assembly);
</pre>
<pre style="background-color: #ffffff;margin: 0em;width: 100%;font-family: consolas,'Courier New',courier,monospace;font-size: 10px">    var container = <span style="color: #0000ff">new</span> CompositionContainer(catalog);
</pre>
<pre style="background-color: #ffffff;margin: 0em;width: 100%;font-family: consolas,'Courier New',courier,monospace;font-size: 10px">    <span style="color: #0000ff">this</span>.MainWindow = container.GetExportedValue&lt;Window&gt;();
</pre>
<pre style="background-color: #ffffff;margin: 0em;width: 100%;font-family: consolas,'Courier New',courier,monospace;font-size: 10px">    MainWindow.Show();
</pre>
<pre style="background-color: #ffffff;margin: 0em;width: 100%;font-family: consolas,'Courier New',courier,monospace;font-size: 10px">}</pre>
</pre>
<p>In the startup method above I am creating a catalog with the current assembly, adding it to a container and then querying for the MainWindow. During the querying, MEF discovers the MainWindow (assuming it was exported) </p>
<h1>Creating a standardized class for starting composition</h1>
<p>In the previous examples, bootstrapping code is introduced into the startup of the application. This kind of approach works well for client / server applications that have a centralized initialization point. In the previous case the initialization code is very specific. With some refactoring I can create a standardized initialization mechanism such as CompositionStarter below which can be reused across different UI mediums including on the server.</p>
<pre>
<pre style="background-color: #ffffff;margin: 0em;width: 100%;font-family: consolas,'Courier New',courier,monospace;font-size: 10px"><span style="color: #0000ff">public</span> <span style="color: #0000ff">class</span> CompositionStarter&lt;TParams&gt;
</pre>
<pre style="background-color: #ffffff;margin: 0em;width: 100%;font-family: consolas,'Courier New',courier,monospace;font-size: 10px">{
</pre>
<pre style="background-color: #ffffff;margin: 0em;width: 100%;font-family: consolas,'Courier New',courier,monospace;font-size: 10px">    <span style="color: #0000ff">private</span> CompositionContainer _container;
</pre>
<pre style="background-color: #ffffff;margin: 0em;width: 100%;font-family: consolas,'Courier New',courier,monospace;font-size: 10px"></pre>
<pre style="background-color: #ffffff;margin: 0em;width: 100%;font-family: consolas,'Courier New',courier,monospace;font-size: 10px">    <span style="color: #0000ff">public</span> CompositionStarter(<span style="color: #0000ff">params</span> ComposablePartCatalog[] catalogs)
</pre>
<pre style="background-color: #ffffff;margin: 0em;width: 100%;font-family: consolas,'Courier New',courier,monospace;font-size: 10px">    {
</pre>
<pre style="background-color: #ffffff;margin: 0em;width: 100%;font-family: consolas,'Courier New',courier,monospace;font-size: 10px">        var aggregate = <span style="color: #0000ff">new</span> AggregateCatalog(catalogs);</pre>
<pre style="background-color: #ffffff;margin: 0em;width: 100%;font-family: consolas,'Courier New',courier,monospace;font-size: 10px">        _container = <span style="color: #0000ff">new</span> CompositionContainer(aggregate);</pre>
<pre style="background-color: #ffffff;margin: 0em;width: 100%;font-family: consolas,'Courier New',courier,monospace;font-size: 10px">    }
</pre>
<pre style="background-color: #ffffff;margin: 0em;width: 100%;font-family: consolas,'Courier New',courier,monospace;font-size: 10px">
</pre>
<pre style="background-color: #ffffff;margin: 0em;width: 100%;font-family: consolas,'Courier New',courier,monospace;font-size: 10px">    <span style="color: #0000ff">public</span> CompositionStarter(CompositionContainer container)
</pre>
<pre style="background-color: #ffffff;margin: 0em;width: 100%;font-family: consolas,'Courier New',courier,monospace;font-size: 10px">    {
</pre>
<pre style="background-color: #ffffff;margin: 0em;width: 100%;font-family: consolas,'Courier New',courier,monospace;font-size: 10px">        <span style="color: #0000ff">if</span> (container == <span style="color: #0000ff">null</span>)
</pre>
<pre style="background-color: #ffffff;margin: 0em;width: 100%;font-family: consolas,'Courier New',courier,monospace;font-size: 10px">            <span style="color: #0000ff">throw</span> <span style="color: #0000ff">new</span> ArgumentNullException("<span style="color: #8b0000">container</span>");
</pre>
<pre style="background-color: #ffffff;margin: 0em;width: 100%;font-family: consolas,'Courier New',courier,monospace;font-size: 10px"></pre>
<pre style="background-color: #ffffff;margin: 0em;width: 100%;font-family: consolas,'Courier New',courier,monospace;font-size: 10px">        _container = container;
</pre>
<pre style="background-color: #ffffff;margin: 0em;width: 100%;font-family: consolas,'Courier New',courier,monospace;font-size: 10px">    }
</pre>
<pre style="background-color: #ffffff;margin: 0em;width: 100%;font-family: consolas,'Courier New',courier,monospace;font-size: 10px"></pre>
<pre style="background-color: #ffffff;margin: 0em;width: 100%;font-family: consolas,'Courier New',courier,monospace;font-size: 10px">    <span style="color: #0000ff">public</span> CompositionStarter()
</pre>
<pre style="background-color: #ffffff;margin: 0em;width: 100%;font-family: consolas,'Courier New',courier,monospace;font-size: 10px">    {
</pre>
<pre style="background-color: #ffffff;margin: 0em;width: 100%;font-family: consolas,'Courier New',courier,monospace;font-size: 10px">        _container = <span style="color: #0000ff">new</span> CompositionContainer(<span style="color: #0000ff">new</span> AssemblyCatalog(Assembly.GetCallingAssembly()));
</pre>
<pre style="background-color: #ffffff;margin: 0em;width: 100%;font-family: consolas,'Courier New',courier,monospace;font-size: 10px">    }
</pre>
<pre style="background-color: #ffffff;margin: 0em;width: 100%;font-family: consolas,'Courier New',courier,monospace;font-size: 10px"></pre>
<pre style="background-color: #ffffff;margin: 0em;width: 100%;font-family: consolas,'Courier New',courier,monospace;font-size: 10px">    <span style="color: #0000ff">public</span> <span style="color: #0000ff">void</span> Start(TParams parameters)
</pre>
<pre style="background-color: #ffffff;margin: 0em;width: 100%;font-family: consolas,'Courier New',courier,monospace;font-size: 10px">    {
</pre>
<pre style="background-color: #ffffff;margin: 0em;width: 100%;font-family: consolas,'Courier New',courier,monospace;font-size: 10px">        var startables = _container.GetExportedValues&lt;IStartable&lt;TParams&gt;&gt;();
</pre>
<pre style="background-color: #ffffff;margin: 0em;width: 100%;font-family: consolas,'Courier New',courier,monospace;font-size: 10px">        <span style="color: #0000ff">foreach</span>(var startable <span style="color: #0000ff">in</span> startables)
</pre>
<pre style="background-color: #ffffff;margin: 0em;width: 100%;font-family: consolas,'Courier New',courier,monospace;font-size: 10px">        {
</pre>
<pre style="background-color: #ffffff;margin: 0em;width: 100%;font-family: consolas,'Courier New',courier,monospace;font-size: 10px">            startable.Start(parameters);
</pre>
<pre style="background-color: #ffffff;margin: 0em;width: 100%;font-family: consolas,'Courier New',courier,monospace;font-size: 10px">        }
</pre>
<pre style="background-color: #ffffff;margin: 0em;width: 100%;font-family: consolas,'Courier New',courier,monospace;font-size: 10px">    }
</pre>
<pre style="background-color: #ffffff;margin: 0em;width: 100%;font-family: consolas,'Courier New',courier,monospace;font-size: 10px"></pre>
<pre style="background-color: #ffffff;margin: 0em;width: 100%;font-family: consolas,'Courier New',courier,monospace;font-size: 10px">    <span style="color: #0000ff">public</span> <span style="color: #0000ff">void</span> Start()
</pre>
<pre style="background-color: #ffffff;margin: 0em;width: 100%;font-family: consolas,'Courier New',courier,monospace;font-size: 10px">    {
</pre>
<pre style="background-color: #ffffff;margin: 0em;width: 100%;font-family: consolas,'Courier New',courier,monospace;font-size: 10px">        Start(<span style="color: #0000ff">default</span>(TParams));
</pre>
<pre style="background-color: #ffffff;margin: 0em;width: 100%;font-family: consolas,'Courier New',courier,monospace;font-size: 10px">    }
</pre>
<pre style="background-color: #ffffff;margin: 0em;width: 100%;font-family: consolas,'Courier New',courier,monospace;font-size: 10px"></pre>
<pre style="background-color: #ffffff;margin: 0em;width: 100%;font-family: consolas,'Courier New',courier,monospace;font-size: 10px">    <span style="color: #0000ff">public</span> <span style="color: #0000ff">void</span> Stop()
</pre>
<pre style="background-color: #ffffff;margin: 0em;width: 100%;font-family: consolas,'Courier New',courier,monospace;font-size: 10px">    {
</pre>
<pre style="background-color: #ffffff;margin: 0em;width: 100%;font-family: consolas,'Courier New',courier,monospace;font-size: 10px">        <span style="color: #0000ff">if</span> (_container == <span style="color: #0000ff">null</span>)
</pre>
<pre style="background-color: #ffffff;margin: 0em;width: 100%;font-family: consolas,'Courier New',courier,monospace;font-size: 10px">        {
</pre>
<pre style="background-color: #ffffff;margin: 0em;width: 100%;font-family: consolas,'Courier New',courier,monospace;font-size: 10px">            <span style="color: #0000ff">throw</span> <span style="color: #0000ff">new</span> InvalidOperationException("<span style="color: #8b0000">Stop can only be called once</span>");
</pre>
<pre style="background-color: #ffffff;margin: 0em;width: 100%;font-family: consolas,'Courier New',courier,monospace;font-size: 10px">        }
</pre>
<pre style="background-color: #ffffff;margin: 0em;width: 100%;font-family: consolas,'Courier New',courier,monospace;font-size: 10px"></pre>
<pre style="background-color: #ffffff;margin: 0em;width: 100%;font-family: consolas,'Courier New',courier,monospace;font-size: 10px">        _container.Dispose();
</pre>
<pre style="background-color: #ffffff;margin: 0em;width: 100%;font-family: consolas,'Courier New',courier,monospace;font-size: 10px">        _container = <span style="color: #0000ff">null</span>;
</pre>
<pre style="background-color: #ffffff;margin: 0em;width: 100%;font-family: consolas,'Courier New',courier,monospace;font-size: 10px">
</pre>
<pre style="background-color: #ffffff;margin: 0em;width: 100%;font-family: consolas,'Courier New',courier,monospace;font-size: 10px">    }
</pre>
<pre style="background-color: #ffffff;margin: 0em;width: 100%;font-family: consolas,'Courier New',courier,monospace;font-size: 10px">}
</pre>
<pre style="background-color: #ffffff;margin: 0em;width: 100%;font-family: consolas,'Courier New',courier,monospace;font-size: 10px"></pre>
<pre style="background-color: #ffffff;margin: 0em;width: 100%;font-family: consolas,'Courier New',courier,monospace;font-size: 10px">[InheritedExport]
</pre>
<pre style="background-color: #ffffff;margin: 0em;width: 100%;font-family: consolas,'Courier New',courier,monospace;font-size: 10px"><span style="color: #0000ff">public</span> <span style="color: #0000ff">interface</span> IStartable&lt;TParams&gt;
</pre>
<pre style="background-color: #ffffff;margin: 0em;width: 100%;font-family: consolas,'Courier New',courier,monospace;font-size: 10px">{
</pre>
<pre style="background-color: #ffffff;margin: 0em;width: 100%;font-family: consolas,'Courier New',courier,monospace;font-size: 10px">    <span style="color: #0000ff">void</span> Start(TParams parameters);
</pre>
<pre style="background-color: #ffffff;margin: 0em;width: 100%;font-family: consolas,'Courier New',courier,monospace;font-size: 10px">}</pre>
</pre>
<p>CompositionStarter&lt;TParam&gt; creates a container (or uses the one that you pass in). On the Start method it pulls all IStartable&lt;TParam&gt; exports from the container and invokes their Start methods passing in the parameters. With CompositionStarter in place, I can now introduce a WpfStartable and move the code for importing and displaying the window there.</p>
<pre>
<pre style="background-color: #ffffff;margin: 0em;width: 100%;font-family: consolas,'Courier New',courier,monospace;font-size: 10px"><span style="color: #0000ff">public</span> <span style="color: #0000ff">class</span> WpfStartable : IStartable&lt;<span style="color: #0000ff">object</span>&gt;
</pre>
<pre style="background-color: #ffffff;margin: 0em;width: 100%;font-family: consolas,'Courier New',courier,monospace;font-size: 10px">{
</pre>
<pre style="background-color: #ffffff;margin: 0em;width: 100%;font-family: consolas,'Courier New',courier,monospace;font-size: 10px">    [Import]
</pre>
<pre style="background-color: #ffffff;margin: 0em;width: 100%;font-family: consolas,'Courier New',courier,monospace;font-size: 10px">    <span style="color: #0000ff">public</span> Window Window { <span style="color: #0000ff">get</span>; <span style="color: #0000ff">set</span>; }
</pre>
<pre style="background-color: #ffffff;margin: 0em;width: 100%;font-family: consolas,'Courier New',courier,monospace;font-size: 10px"></pre>
<pre style="background-color: #ffffff;margin: 0em;width: 100%;font-family: consolas,'Courier New',courier,monospace;font-size: 10px">    <span style="color: #0000ff">public</span> <span style="color: #0000ff">void</span> Start(<span style="color: #0000ff">object</span> parameters)
</pre>
<pre style="background-color: #ffffff;margin: 0em;width: 100%;font-family: consolas,'Courier New',courier,monospace;font-size: 10px">    {
</pre>
<pre style="background-color: #ffffff;margin: 0em;width: 100%;font-family: consolas,'Courier New',courier,monospace;font-size: 10px">        Application.Current.MainWindow = Window;
</pre>
<pre style="background-color: #ffffff;margin: 0em;width: 100%;font-family: consolas,'Courier New',courier,monospace;font-size: 10px">        Window.Show();
</pre>
<pre style="background-color: #ffffff;margin: 0em;width: 100%;font-family: consolas,'Courier New',courier,monospace;font-size: 10px">    }
</pre>
<pre style="background-color: #ffffff;margin: 0em;width: 100%;font-family: consolas,'Courier New',courier,monospace;font-size: 10px">}</pre>
</pre>
<p>&nbsp;</p>
<p>&nbsp;</p>
<p>&nbsp;</p>
<p>The app class can then be updated to use the following starter code:</p>
<pre>
<pre style="background-color: #ffffff;margin: 0em;width: 100%;font-family: consolas,'Courier New',courier,monospace;font-size: 10px"><span style="color: #0000ff">void</span> App_Startup(<span style="color: #0000ff">object</span> sender, StartupEventArgs e)
</pre>
<pre style="background-color: #ffffff;margin: 0em;width: 100%;font-family: consolas,'Courier New',courier,monospace;font-size: 10px">{
</pre>
<pre style="background-color: #ffffff;margin: 0em;width: 100%;font-family: consolas,'Courier New',courier,monospace;font-size: 10px">    var starter = <span style="color: #0000ff">new</span> CompositionStarter&lt;<span style="color: #0000ff">object</span>&gt;();
</pre>
<pre style="background-color: #ffffff;margin: 0em;width: 100%;font-family: consolas,'Courier New',courier,monospace;font-size: 10px">    starter.Start();
</pre>
<pre style="background-color: #ffffff;margin: 0em;width: 100%;font-family: consolas,'Courier New',courier,monospace;font-size: 10px">}</pre>
</pre>
<p>The code is no longer app-specific, nor is it specific to a particular UI platform. The same code pattern also works for a Silverlight application, a WinForms application or a console app.</p>
<p>Notice that CompositionStarter pulls multiple IStartable implementations. This allows me to introduce other pluggable startup operations. </p>
<h3></h3>
<h3>A note about Silverlight and PartInitializer</h3>
<p>In Silverlight we have introduced PartInitializer which automatically bootstraps a shared container and composes an existing instance. This is primarily for usage in places such as XAML where objects are created by the XAML parser, but need to get composed. PartInitializer may be sufficient for your startup needs in Silverlight so if it works, don&rsquo;t feel compelled that must use CompositionStarter, you don&rsquo;t.</p>
<p>You may want to combine the two approaches. The benefits of doing this are you could have CompositionStarter bootstrap your app, while still using PartInitializer within XAML elements that need composition.</p>
<p>PartInitializer allows you to override its default container through the CompositionHost.InitializeContainer method. This means you can create a container that is shared by both PartInitializer and the CompositionStarter class.</p>
<pre>
<pre style="background-color: #ffffff;margin: 0em;width: 100%;font-family: consolas,'Courier New',courier,monospace;font-size: 10px"></pre>
<pre style="background-color: #ffffff;margin: 0em;width: 100%;font-family: consolas,'Courier New',courier,monospace;font-size: 10px"><span style="color: #0000ff">void</span> App_Startup(<span style="color: #0000ff">object</span> sender, StartupEventArgs e)
</pre>
<pre style="background-color: #ffffff;margin: 0em;width: 100%;font-family: consolas,'Courier New',courier,monospace;font-size: 10px">{
</pre>
<pre style="background-color: #ffffff;margin: 0em;width: 100%;font-family: consolas,'Courier New',courier,monospace;font-size: 10px">    var catalog = <span style="color: #0000ff">new</span> AggregateCatalog(<span style="color: #0000ff">new</span> AssemblyCatalog(Assembly.GetCallingAssembly()));</pre>
<pre style="background-color: #ffffff;margin: 0em;width: 100%;font-family: consolas,'Courier New',courier,monospace;font-size: 10px">    var container = <span style="color: #0000ff">new</span> CompositionContainer(catalog);
</pre>
<pre style="background-color: #ffffff;margin: 0em;width: 100%;font-family: consolas,'Courier New',courier,monospace;font-size: 10px">    CompositionHost.InitializeContainer(container);
</pre>
<pre style="background-color: #ffffff;margin: 0em;width: 100%;font-family: consolas,'Courier New',courier,monospace;font-size: 10px">    var starter = <span style="color: #0000ff">new</span> CompositionStarter&lt;<span style="color: #0000ff">object</span>&gt;();
</pre>
<pre style="background-color: #ffffff;margin: 0em;width: 100%;font-family: consolas,'Courier New',courier,monospace;font-size: 10px">    starter.Start();
</pre>
<pre style="background-color: #ffffff;margin: 0em;width: 100%;font-family: consolas,'Courier New',courier,monospace;font-size: 10px">}
</pre>
<pre style="background-color: #ffffff;margin: 0em;width: 100%;font-family: consolas,'Courier New',courier,monospace;font-size: 10px"></pre>
</pre>
<h1>Using MEF within XAML in WPF</h1>
<p>In the previous section I spoke about the PartInitializer API which we baked into Silverlight for composition in XAML, it lets you write code such as the following:</p>
<pre>
<pre style="background-color: #ffffff;margin: 0em;width: 100%;font-family: consolas,'Courier New',courier,monospace;font-size: 10px"><span style="color: #0000ff">public</span> partial <span style="color: #0000ff">class</span> Dashboard : UserControl
</pre>
<pre style="background-color: #ffffff;margin: 0em;width: 100%;font-family: consolas,'Courier New',courier,monospace;font-size: 10px">{
</pre>
<pre style="background-color: #ffffff;margin: 0em;width: 100%;font-family: consolas,'Courier New',courier,monospace;font-size: 10px">    <span style="color: #0000ff">public</span> MainPage()
</pre>
<pre style="background-color: #ffffff;margin: 0em;width: 100%;font-family: consolas,'Courier New',courier,monospace;font-size: 10px">    {
</pre>
<pre style="background-color: #ffffff;margin: 0em;width: 100%;font-family: consolas,'Courier New',courier,monospace;font-size: 10px">        InitializeComponent();
</pre>
<pre style="background-color: #ffffff;margin: 0em;width: 100%;font-family: consolas,'Courier New',courier,monospace;font-size: 10px">        PartInitializer.SatisfyImports(<span style="color: #0000ff">this</span>);
</pre>
<pre style="background-color: #ffffff;margin: 0em;width: 100%;font-family: consolas,'Courier New',courier,monospace;font-size: 10px">        <span style="color: #0000ff">foreach</span> (var widget <span style="color: #0000ff">in</span> Widgets)
</pre>
<pre style="background-color: #ffffff;margin: 0em;width: 100%;font-family: consolas,'Courier New',courier,monospace;font-size: 10px">            TopWidgets.Items.Add(widget);
</pre>
<pre style="background-color: #ffffff;margin: 0em;width: 100%;font-family: consolas,'Courier New',courier,monospace;font-size: 10px">    }
</pre>
<pre style="background-color: #ffffff;margin: 0em;width: 100%;font-family: consolas,'Courier New',courier,monospace;font-size: 10px"></pre>
<pre style="background-color: #ffffff;margin: 0em;width: 100%;font-family: consolas,'Courier New',courier,monospace;font-size: 10px">    [ImportMany]
</pre>
<pre style="background-color: #ffffff;margin: 0em;width: 100%;font-family: consolas,'Courier New',courier,monospace;font-size: 10px">    <span style="color: #0000ff">public</span> UserControl[] Widgets { <span style="color: #0000ff">get</span>; <span style="color: #0000ff">set</span>; }
</pre>
<pre style="background-color: #ffffff;margin: 0em;width: 100%;font-family: consolas,'Courier New',courier,monospace;font-size: 10px">}
</pre>
<pre style="background-color: #ffffff;margin: 0em;width: 100%;font-family: consolas,'Courier New',courier,monospace;font-size: 10px"></pre>
</pre>
<p>Above Dashboard is a user control that is created within XAML. It imports a collection of widgets. It forces itself to be composed by calling PartInitializer.SatisfyImports(). </p>
<p>This is great for Silverlight, but what about WPF? Although we don&rsquo;t yet have it in the box, I&rsquo;ve ported our PartInitializer implementation to WPF. The functionality is almost identical though instead of looking in the main application XAP, it looks in the bin folder of the application and an optional extensions folder. You can get it on my skydrive <a href="http://cid-f8b2fd72406fb218.skydrive.live.com/self.aspx/blog/Composition.Initialization.Desktop.zip">here</a>.</p>
<p>Alternatively you can have the control which hosts Dashboard compose it by calling ComposeParts on the container and pass it in. Another option is to pass a container through the visual tree as an attached property and then have a helper method / another attached property which allows Dashboard to get composed without depending on a static container. More on this in another post.</p>
<h1>Hosting MEF within a library</h1>
<p>We&rsquo;ve discussed an approach for hosting within an application, but what about a library? Should you use CompositionStarter then? I would err against that as it&rsquo;s not ideal. For example take the case of a rules engine that uses MEF to discover rules. The rules engine itself needs the rules, so delegating off to IStartables to get the rules adds extra complexity with little gain. Having the rules engine host a container which it uses to get the rules is not at all a problem. Here is one way to implement it.</p>
<pre>
<pre style="background-color: #ffffff;margin: 0em;width: 100%;font-family: consolas,'Courier New',courier,monospace;font-size: 10px"><span style="color: #0000ff">public</span> <span style="color: #0000ff">class</span> RulesEngine
</pre>
<pre style="background-color: #ffffff;margin: 0em;width: 100%;font-family: consolas,'Courier New',courier,monospace;font-size: 10px">{
</pre>
<pre style="background-color: #ffffff;margin: 0em;width: 100%;font-family: consolas,'Courier New',courier,monospace;font-size: 10px">    <span style="color: #0000ff">private</span> <span style="color: #0000ff">readonly</span> CompositionContainer _container;
</pre>
<pre style="background-color: #ffffff;margin: 0em;width: 100%;font-family: consolas,'Courier New',courier,monospace;font-size: 10px">    <span style="color: #0000ff">private</span> RulesEngineImports _rulesEngineImports;
</pre>
<pre style="background-color: #ffffff;margin: 0em;width: 100%;font-family: consolas,'Courier New',courier,monospace;font-size: 10px"></pre>
<pre style="background-color: #ffffff;margin: 0em;width: 100%;font-family: consolas,'Courier New',courier,monospace;font-size: 10px">    <span style="color: #0000ff">public</span> RulesEngine()
</pre>
<pre style="background-color: #ffffff;margin: 0em;width: 100%;font-family: consolas,'Courier New',courier,monospace;font-size: 10px">    {
</pre>
<pre style="background-color: #ffffff;margin: 0em;width: 100%;font-family: consolas,'Courier New',courier,monospace;font-size: 10px">        <span style="color: #0000ff">if</span> (_container == <span style="color: #0000ff">null</span>)
</pre>
<pre style="background-color: #ffffff;margin: 0em;width: 100%;font-family: consolas,'Courier New',courier,monospace;font-size: 10px">            _container = <span style="color: #0000ff">new</span> CompositionContainer(<span style="color: #0000ff">new</span> AssemblyCatalog(Assembly.GetCallingAssembly()));
</pre>
<pre style="background-color: #ffffff;margin: 0em;width: 100%;font-family: consolas,'Courier New',courier,monospace;font-size: 10px"></pre>
<pre style="background-color: #ffffff;margin: 0em;width: 100%;font-family: consolas,'Courier New',courier,monospace;font-size: 10px">        var imports = <span style="color: #0000ff">new</span> RulesEngineImports();
</pre>
<pre style="background-color: #ffffff;margin: 0em;width: 100%;font-family: consolas,'Courier New',courier,monospace;font-size: 10px">        _container.ComposeParts(imports);
</pre>
<pre style="background-color: #ffffff;margin: 0em;width: 100%;font-family: consolas,'Courier New',courier,monospace;font-size: 10px">    }
</pre>
<pre style="background-color: #ffffff;margin: 0em;width: 100%;font-family: consolas,'Courier New',courier,monospace;font-size: 10px"></pre>
<pre style="background-color: #ffffff;margin: 0em;width: 100%;font-family: consolas,'Courier New',courier,monospace;font-size: 10px">    <span style="color: #0000ff">public</span> RulesEngine(CompositionContainer container)
</pre>
<pre style="background-color: #ffffff;margin: 0em;width: 100%;font-family: consolas,'Courier New',courier,monospace;font-size: 10px">    {
</pre>
<pre style="background-color: #ffffff;margin: 0em;width: 100%;font-family: consolas,'Courier New',courier,monospace;font-size: 10px">        _container = container;
</pre>
<pre style="background-color: #ffffff;margin: 0em;width: 100%;font-family: consolas,'Courier New',courier,monospace;font-size: 10px">    }
</pre>
<pre style="background-color: #ffffff;margin: 0em;width: 100%;font-family: consolas,'Courier New',courier,monospace;font-size: 10px"></pre>
<pre style="background-color: #ffffff;margin: 0em;width: 100%;font-family: consolas,'Courier New',courier,monospace;font-size: 10px">    <span style="color: #0000ff">public</span> RulesEngine(<span style="color: #0000ff">params</span> ComposablePartCatalog[] catalogs)
</pre>
<pre style="background-color: #ffffff;margin: 0em;width: 100%;font-family: consolas,'Courier New',courier,monospace;font-size: 10px">    {
</pre>
<pre style="background-color: #ffffff;margin: 0em;width: 100%;font-family: consolas,'Courier New',courier,monospace;font-size: 10px">        var aggregate = <span style="color: #0000ff">new</span> AggregateCatalog(catalogs);
</pre>
<pre style="background-color: #ffffff;margin: 0em;width: 100%;font-family: consolas,'Courier New',courier,monospace;font-size: 10px">        _container = <span style="color: #0000ff">new</span> CompositionContainer(aggregate);
</pre>
<pre style="background-color: #ffffff;margin: 0em;width: 100%;font-family: consolas,'Courier New',courier,monospace;font-size: 10px">    }
</pre>
<pre style="background-color: #ffffff;margin: 0em;width: 100%;font-family: consolas,'Courier New',courier,monospace;font-size: 10px"></pre>
<pre style="background-color: #ffffff;margin: 0em;width: 100%;font-family: consolas,'Courier New',courier,monospace;font-size: 10px">    <span style="color: #0000ff">private</span> <span style="color: #0000ff">class</span> RulesEngineImports
</pre>
<pre style="background-color: #ffffff;margin: 0em;width: 100%;font-family: consolas,'Courier New',courier,monospace;font-size: 10px">    {
</pre>
<pre style="background-color: #ffffff;margin: 0em;width: 100%;font-family: consolas,'Courier New',courier,monospace;font-size: 10px">        [ImportMany]
</pre>
<pre style="background-color: #ffffff;margin: 0em;width: 100%;font-family: consolas,'Courier New',courier,monospace;font-size: 10px">        <span style="color: #0000ff">public</span> IRule[] Rules { <span style="color: #0000ff">get</span>; <span style="color: #0000ff">set</span>; }
</pre>
<pre style="background-color: #ffffff;margin: 0em;width: 100%;font-family: consolas,'Courier New',courier,monospace;font-size: 10px">    }
</pre>
<pre style="background-color: #ffffff;margin: 0em;width: 100%;font-family: consolas,'Courier New',courier,monospace;font-size: 10px">}
</pre>
</pre>
<p>RulesEngine&rsquo;s default ctor creates a default container though it accepts overrides for passing in a container and catalogs, this allows containers to be shared across other libraries that might use MEF. Once RulesEngine is created, the default ctor then creates a new RulesEngineImports class which it then composes. This class is basically a buddy class to get the imports that RulesEngine needs. </p>
<p><strong>Note:</strong> I could have put the imports directly on RulesEngine, but in Silverlight these have to be public members as private reflection is not supported. I don&rsquo;t want to expose the engines internal implementation to the outside and I want the engine to be reused in SL and WPF. Using this approach allows that reuse by keeping the imports as an internal implementation detail.</p>
<h2>Why not use CommonServiceLocator?</h2>
<p>I know there are going to be a bunch of folks reading this saying why should you couple the RulesEngine to MEF? Can&rsquo;t you just use <a href="http://commonservicelocator.codeplex.com/">CommonServiceLocator</a> to get the rules the engine needs? Yes you absolutely could do that, though it will limit the capabilities you can leverage from a specific container. For example MEF currently supports metadata views on imports, something that is currently specific to MEF, though Autofac is catching up quickly <img src='http://codebetter.com/glennblock/wp-includes/images/smilies/icon_smile.gif' alt=':-)' class='wp-smiley' />  Additionally using CSL often results in icky service locatorish code all over the place, something we (the founders of CSL) never intended but which has happened.</p>
<p>An alternative to using CSL that supports any container is to have an app-specific IRulesEngineServiceAdapter export which returns all the dependencies / imports that the engine needs. The service adapter can use whichever IoC it chooses, and it can leverage the full capabilities of that container. The engine could still use MEF to discover the adapter and then use the adapter from there on. </p>
<pre>
<pre style="background-color: #ffffff;margin: 0em;width: 100%;font-family: consolas,'Courier New',courier,monospace;font-size: 10px"><span style="color: #0000ff">public</span> <span style="color: #0000ff">class</span> RulesEngine
</pre>
<pre style="background-color: #ffffff;margin: 0em;width: 100%;font-family: consolas,'Courier New',courier,monospace;font-size: 10px">{
</pre>
<pre style="background-color: #ffffff;margin: 0em;width: 100%;font-family: consolas,'Courier New',courier,monospace;font-size: 10px">    <span style="color: #0000ff">private</span> <span style="color: #0000ff">readonly</span> CompositionContainer _container;
</pre>
<pre style="background-color: #ffffff;margin: 0em;width: 100%;font-family: consolas,'Courier New',courier,monospace;font-size: 10px">    <span style="color: #0000ff">private</span> IRulesEngineServiceAdapter _adapter;
</pre>
<pre style="background-color: #ffffff;margin: 0em;width: 100%;font-family: consolas,'Courier New',courier,monospace;font-size: 10px"></pre>
<pre style="background-color: #ffffff;margin: 0em;width: 100%;font-family: consolas,'Courier New',courier,monospace;font-size: 10px">    <span style="color: #0000ff">public</span> RulesEngine()
</pre>
<pre style="background-color: #ffffff;margin: 0em;width: 100%;font-family: consolas,'Courier New',courier,monospace;font-size: 10px">    {
</pre>
<pre style="background-color: #ffffff;margin: 0em;width: 100%;font-family: consolas,'Courier New',courier,monospace;font-size: 10px">        <span style="color: #0000ff">if</span> (_container == <span style="color: #0000ff">null</span>)
</pre>
<pre style="background-color: #ffffff;margin: 0em;width: 100%;font-family: consolas,'Courier New',courier,monospace;font-size: 10px">            _container = <span style="color: #0000ff">new</span> CompositionContainer(<span style="color: #0000ff">new</span> AssemblyCatalog(Assembly.GetCallingAssembly()));
</pre>
<pre style="background-color: #ffffff;margin: 0em;width: 100%;font-family: consolas,'Courier New',courier,monospace;font-size: 10px"></pre>
<pre style="background-color: #ffffff;margin: 0em;width: 100%;font-family: consolas,'Courier New',courier,monospace;font-size: 10px">        _adapter = _container.GetExportedValue&lt;IRulesEngineServiceAdapter&gt;();
</pre>
<pre style="background-color: #ffffff;margin: 0em;width: 100%;font-family: consolas,'Courier New',courier,monospace;font-size: 10px">    }
</pre>
<pre style="background-color: #ffffff;margin: 0em;width: 100%;font-family: consolas,'Courier New',courier,monospace;font-size: 10px"></pre>
<pre style="background-color: #ffffff;margin: 0em;width: 100%;font-family: consolas,'Courier New',courier,monospace;font-size: 10px">    <span style="color: #0000ff">public</span> RulesEngine(CompositionContainer container)
</pre>
<pre style="background-color: #ffffff;margin: 0em;width: 100%;font-family: consolas,'Courier New',courier,monospace;font-size: 10px">    {
</pre>
<pre style="background-color: #ffffff;margin: 0em;width: 100%;font-family: consolas,'Courier New',courier,monospace;font-size: 10px">        _container = container;
</pre>
<pre style="background-color: #ffffff;margin: 0em;width: 100%;font-family: consolas,'Courier New',courier,monospace;font-size: 10px">    }
</pre>
<pre style="background-color: #ffffff;margin: 0em;width: 100%;font-family: consolas,'Courier New',courier,monospace;font-size: 10px"></pre>
<pre style="background-color: #ffffff;margin: 0em;width: 100%;font-family: consolas,'Courier New',courier,monospace;font-size: 10px">    <span style="color: #0000ff">public</span> RulesEngine(<span style="color: #0000ff">params</span> ComposablePartCatalog[] catalogs)
</pre>
<pre style="background-color: #ffffff;margin: 0em;width: 100%;font-family: consolas,'Courier New',courier,monospace;font-size: 10px">    {
</pre>
<pre style="background-color: #ffffff;margin: 0em;width: 100%;font-family: consolas,'Courier New',courier,monospace;font-size: 10px">        var aggregate = <span style="color: #0000ff">new</span> AggregateCatalog(catalogs);
</pre>
<pre style="background-color: #ffffff;margin: 0em;width: 100%;font-family: consolas,'Courier New',courier,monospace;font-size: 10px">        _container = <span style="color: #0000ff">new</span> CompositionContainer(aggregate);
</pre>
<pre style="background-color: #ffffff;margin: 0em;width: 100%;font-family: consolas,'Courier New',courier,monospace;font-size: 10px">    }
</pre>
<pre style="background-color: #ffffff;margin: 0em;width: 100%;font-family: consolas,'Courier New',courier,monospace;font-size: 10px">}
</pre>
<pre style="background-color: #ffffff;margin: 0em;width: 100%;font-family: consolas,'Courier New',courier,monospace;font-size: 10px"></pre>
</pre>
<p>In the MEF case, the adapter would simply be a part which imports the rules. For other containers the implementation would differ.</p>
<pre>
<pre style="background-color: #ffffff;margin: 0em;width: 100%;font-family: consolas,'Courier New',courier,monospace;font-size: 10px">[InheritedExport]
</pre>
<pre style="background-color: #ffffff;margin: 0em;width: 100%;font-family: consolas,'Courier New',courier,monospace;font-size: 10px"><span style="color: #0000ff">public</span> <span style="color: #0000ff">interface</span> IRulesEngineServiceAdapter
</pre>
<pre style="background-color: #ffffff;margin: 0em;width: 100%;font-family: consolas,'Courier New',courier,monospace;font-size: 10px">{
</pre>
<pre style="background-color: #ffffff;margin: 0em;width: 100%;font-family: consolas,'Courier New',courier,monospace;font-size: 10px">   IRule[] Rules { <span style="color: #0000ff">get</span>; <span style="color: #0000ff">set</span>; }
</pre>
<pre style="background-color: #ffffff;margin: 0em;width: 100%;font-family: consolas,'Courier New',courier,monospace;font-size: 10px">}
</pre>
<pre style="background-color: #ffffff;margin: 0em;width: 100%;font-family: consolas,'Courier New',courier,monospace;font-size: 10px"></pre>
<pre style="background-color: #ffffff;margin: 0em;width: 100%;font-family: consolas,'Courier New',courier,monospace;font-size: 10px"><span style="color: #0000ff">public</span> <span style="color: #0000ff">class</span> MefRulesEngineServiceAdapter : IRulesEngineServiceAdapter
</pre>
<pre style="background-color: #ffffff;margin: 0em;width: 100%;font-family: consolas,'Courier New',courier,monospace;font-size: 10px">{
</pre>
<pre style="background-color: #ffffff;margin: 0em;width: 100%;font-family: consolas,'Courier New',courier,monospace;font-size: 10px">    [ImportMany]
</pre>
<pre style="background-color: #ffffff;margin: 0em;width: 100%;font-family: consolas,'Courier New',courier,monospace;font-size: 10px">    <span style="color: #0000ff">public</span> IRule[] Rules { <span style="color: #0000ff">get</span>; <span style="color: #0000ff">set</span>;}
</pre>
<pre style="background-color: #ffffff;margin: 0em;width: 100%;font-family: consolas,'Courier New',courier,monospace;font-size: 10px">}
</pre>
</pre>
<p>&nbsp;</p>
<h1>Hosting MEF within a web application or a web service</h1>
<p>Using MEF within a multi-request server application such as a web app or a WCF service is a whole other ball of wax. You can use CompositionStarter in limited scenarios as long as you are dealing with singletons shared across all requests.&nbsp; For more sophisticated scenarios you will need to create scoped per-request containers. That is outside of the scope of this post, but we will likely have future posts on this topic. </p>
<p><strong>Update: </strong></p>
<ul>
<li>We&#8217;ve&nbsp;posted a sample using MEF with web forms here: <a href="http://is.gd/cjysJ">http://is.gd/cjysJ</a></li>
<li>Scott Hanselman has a post on porting MVC&#8217;s Nerd Dinner to use MEF here: <a href="http://www.hanselman.com/blog/ExtendingNerdDinnerAddingMEFAndPluginsToASPNETMVC.aspx">http://www.hanselman.com/blog/ExtendingNerdDinnerAddingMEFAndPluginsToASPNETMVC.aspx</a></li>
</ul>
<p>&nbsp;</p>
<h1>Recap</h1>
<p>We&rsquo;ve just dug in to what it means to host MEF within an application / library, and various approaches for doing so. My goal for this post was simply to illustrate a range of options, use them or leave them depending on whether or not they work for your scenario. Don&rsquo;t try to force a square peg into a round hole!</p>
											</div><!-- .entry-content -->


					<div class="entry-utility">
					This entry was posted in <a href="http://codebetter.com/glennblock/category/mef/" title="View all posts in MEF" rel="category tag">MEF</a>. Bookmark the <a href="http://codebetter.com/glennblock/2010/01/15/hosting-mef-within-your-applications/" title="Permalink to Hosting MEF within application and libraries." rel="bookmark">permalink</a>. Follow any comments here with the <a href="http://codebetter.com/glennblock/2010/01/15/hosting-mef-within-your-applications/feed/" title="Comments RSS to Hosting MEF within application and libraries." rel="alternate" type="application/rss+xml">RSS feed for this post</a>.
					</div><!-- .entry-utility -->
				</div><!-- #post-114 -->

				<div id="nav-below" class="navigation">
					<div class="nav-previous"><a href="http://codebetter.com/glennblock/2010/01/03/mef-and-prism-exploration-mef-module-loading/" rel="prev"><span class="meta-nav">&larr;</span> MEF and Prism exploration, MEF module loading</a></div>
					<div class="nav-next"><a href="http://codebetter.com/glennblock/2010/01/27/how-do-i-expose-configuration-information-through-mef/" rel="next">How do I expose configuration information through MEF? <span class="meta-nav">&rarr;</span></a></div>
				</div><!-- #nav-below -->

				
<div id="disqus_thread">
					<div id="dsq-content">
			<ul id="dsq-comments">
					<li id="dsq-comment-503">
					<div id="dsq-comment-header-503" class="dsq-comment-header">
						<cite id="dsq-cite-503">
	http://blogs.us.sogeti.com/eswanson							<span id="dsq-author-user-503">Eric Swanson</span>
							</cite>
					</div>
					<div id="dsq-comment-body-503" class="dsq-comment-body">
						<div id="dsq-comment-message-503" class="dsq-comment-message"><p>I &#8220;kinda&#8221; found what I was looking for here. I was specifically looking for ways to resolve types at run-time within a library without exposing a static CSL everywhere. The specific case I have is a method that internally populates a list with new items. I want the type creation to come from MEF and it is not a list I want exposed directly (publically) to MEF to instantiate.</p>
<p>The current solution I have is a single, static &#8220;IoC&#8221; class that encapsulates MEF container logic, an interface &#8220;IDependencyManager&#8221; that exposes IoC methods like &#8220;ResolveDependencies(params object[] objectsWithDependencies)&#8221; and &#8220;CreateInstance<t>()&#8221;. The implementation of DependencyManager delegates its calls directly to the static &#8220;IoC&#8221; instance (a CSL pattern), which hides the CSL pattern for all other classes by allowing those classes to use [Import] IDependencyManager when they need CSL-type functionality.</p>
<p>Thus, populating my list with new items is as simple as providing an &#8220;InitializingConstructor&#8221; instance that receives and stores the reference to &#8220;IDependencyManager&#8221; and the populating method calls: list.Add(this.dependencyManager.CreateInstance<imyentity>());</p>
<p>Thoughts?</imyentity></t></p>
</div>
					</div>
				</li>
					<li id="dsq-comment-504">
					<div id="dsq-comment-header-504" class="dsq-comment-header">
						<cite id="dsq-cite-504">
								<span id="dsq-author-user-504">Gonzalo Gatti</span>
							</cite>
					</div>
					<div id="dsq-comment-body-504" class="dsq-comment-body">
						<div id="dsq-comment-message-504" class="dsq-comment-message"><p>Hi!<br />
Do you have any sample on hosting MEF within a web application?<br />
I&#8217;m really intrested in it.</p>
</div>
					</div>
				</li>
					<li id="dsq-comment-505">
					<div id="dsq-comment-header-505" class="dsq-comment-header">
						<cite id="dsq-cite-505">
	http://codebetter.com/members/gblock/default.aspx							<span id="dsq-author-user-505">Glenn Block</span>
							</cite>
					</div>
					<div id="dsq-comment-body-505" class="dsq-comment-body">
						<div id="dsq-comment-message-505" class="dsq-comment-message"><p>@Gonzalo</p>
<p>Good question and timing. Hamilton has posted samples using Web Forms here: <a href="http://mef.codeplex.com/releases/view/44166" rel="nofollow">http://mef.codeplex.com/releases/view/44166</a> and recently posted a port of MVC&#8217;s Nerd Dinner which uses MEF here: <a href="http://www.hanselman.com/blog/ExtendingNerdDinnerAddingMEFAndPluginsToASPNETMVC.aspx" rel="nofollow">http://www.hanselman.com/blog/ExtendingNerdDinnerAddingMEFAndPluginsToASPNETMVC.aspx</a></p>
</div>
					</div>
				</li>
					<li id="dsq-comment-506">
					<div id="dsq-comment-header-506" class="dsq-comment-header">
						<cite id="dsq-cite-506">
	http://www.jenasysdesign.com.au							<span id="dsq-author-user-506">Jamie Clayton</span>
							</cite>
					</div>
					<div id="dsq-comment-body-506" class="dsq-comment-body">
						<div id="dsq-comment-message-506" class="dsq-comment-message"><p>Glenn,<br />
Excellent article. Do you have a link to a download code sample?</p>
</div>
					</div>
				</li>
				</ul>
		</div>
	</div>

<a href="http://disqus.com" class="dsq-brlink">blog comments powered by <span class="logo-disqus">Disqus</span></a>

<script type="text/javascript">
/* <![CDATA[ */
	var disqus_url = 'http://codebetter.com/glennblock/2010/01/15/hosting-mef-within-your-applications/ ';
	var disqus_identifier = '114 /blogs/glenn.block/archive/2010/01/15/hosting-mef-within-your-applications.aspx';
	var disqus_container_id = 'disqus_thread';
	var disqus_domain = 'disqus.com';
	var disqus_shortname = 'mytechnobabble';
	var disqus_title = "Hosting MEF within application and libraries.";
		var disqus_config = function () {
	    var config = this; // Access to the config object

	    /* 
	       All currently supported events:
	        * preData  fires just before we request for initial data
	        * preInit - fires after we get initial data but before we load any dependencies
	        * onInit  - fires when all dependencies are resolved but before dtpl template is rendered
	        * afterRender - fires when template is rendered but before we show it
	        * onReady - everything is done
	     */

		config.callbacks.preData.push(function() {
			// clear out the container (its filled for SEO/legacy purposes)
			document.getElementById(disqus_container_id).innerHTML = '';
		});
				config.callbacks.onReady.push(function() {
			// sync comments in the background so we don't block the page
			DISQUS.request.get('?cf_action=sync_comments&post_id=114');
		});
					};
	var facebookXdReceiverPath = 'http://codebetter.com/glennblock/wp-content/plugins/disqus-comment-system/xd_receiver.htm';
/* ]]> */
</script>

<script type="text/javascript">
/* <![CDATA[ */
	var DsqLocal = {
		'trackbacks': [
		],
		'trackback_url': "http:\/\/codebetter.com\/glennblock\/2010\/01\/15\/hosting-mef-within-your-applications\/trackback\/"	};
/* ]]> */
</script>

<script type="text/javascript">
/* <![CDATA[ */
(function() {
	var dsq = document.createElement('script'); dsq.type = 'text/javascript';
	dsq.async = true;
	dsq.src = 'http://' + disqus_shortname + '.' + disqus_domain + '/embed.js?pname=wordpress&pver=2.61';
	(document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();
/* ]]> */
</script>

		</div><!-- #main -->
			<div id="sidebar" class="grid_4">

		<div id="primary" class="widget-area">
			<ul class="xoxo">
				<div class="ad-container">
					<a target="_blank" href="http://www.red-gate.com/products/dotnet-development/ants-performance-profiler/entrypage/version-6-new-features?utm_source=cb&utm_medium=button&utm_term=4328&utm_content=app6release&utm_campaign=antsperformanceprofiler"><img width="125" height="125" border="0" title="" alt="" src="http://s3.amazonaws.com/CodeBetter/Creative/ANTSPP5_125x125_M1.gif"></a>
					<embed width="125" height="125" flashvars="clickTARGET=_blank&amp;clickTAG=http%3A%2F%2Fd1.openx.org%2Fck.php%3Foaparams%3D2__bannerid%3D62753__zoneid%3D29419__cb%3Da0471ce5e8__r_id%3Dd42118811971f057012db20aa261c5c1__r_ts%3Dldef6x__oadest%3Dhttp%253A%252F%252Fwww.jetbrains.com%252Fresharper%252F%253Frs4cb125" allowscriptaccess="always" quality="high" name="Advertisement" id="Advertisement" style="" src="http://s3.amazonaws.com/CodeBetter/Creative/tc_125x125_simple2.swf" type="application/x-shockwave-flash">
				</div>
			
				<li id="user_bio-2" class="widget-container widget_user_bio"><h3 class="widget-title"></h3>One of these days I will add something to my user profile! For now, I shall remain mysterious.
</li>		
						
			</ul>
			
		</div><!-- #primary .widget-area -->
		
		<div id="secondary" class="widget-area">
				<script type="text/javascript" src="http://engine.theloungenet.com/z/15/adzerk1_2_5"></script>
				<div id="adzerk1"></div>
				
				<ul class="xoxo">		
									</ul>	
				
				<a target="_blank" href="http://www.red-gate.com/products/dotnet-development/ants-performance-profiler/entrypage/version-6-csharp?utm_source=cb&utm_medium=rectangle&utm_term=4327&utm_content=app6release&utm_campaign=antsperformanceprofiler"><img width="300" height="250" border="0" title="" alt="" src="http://s3.amazonaws.com/CodeBetter/Creative/APP6_Launch_C%23_Jun10_300x250_M1.gif?AWSAccessKeyId=0KMA35HT86EVXB99Z302&amp;Expires=1458095516&amp;Signature=BIBDilUaLnZe1uKfVKyyTBxr%2BvE%3D"></a>
				
		</div><!-- #secondary .widget-area -->			</div><!--sidebar-->
		</div><!-- #container -->
</div><!-- end div tabs see header.php -->
	
	<div id="footer">
		<div class="container_12">
		<div id="footer-widget-area">
				<div class="grid_4">					
					<ul>
					<li><a href="http://codebetter.com" title="home">Home</a></li>
					<li class="page_item page-item-2"><a href="http://codebetter.com/about/" title="About">About</a></li>
<li class="page_item page-item-8"><a href="http://codebetter.com/codebetter-ci/" title="CodeBetter CI">CodeBetter CI</a></li>
<li class="page_item page-item-6"><a href="http://codebetter.com/community/" title="Community">Community</a></li>
<li class="page_item page-item-10"><a href="http://codebetter.com/editors/" title="Editors">Editors</a></li>
<li class="page_item page-item-41"><a href="http://codebetter.com/globalsearch/" title="Search Results">Search Results</a></li>
					<li><a href="http://feeds.feedburner.com/CodeBetter" rel="alternate" type="application/rss+xml"><img src="http://www.feedburner.com/fb/images/pub/feed-icon16x16.png" alt="" style="vertical-align:middle;border:0"/></a><a href="http://feeds.feedburner.com/CodeBetter"><img src="http://feeds.feedburner.com/~fc/CodeBetter?bg=FFFFFF&amp;fg=2E9BD2&amp;anim=1" height="26" width="88" style="vertical-align:middle;border:0"/></a></li>
					</ul>
				</div><!-- #second .widget-area -->
				<div class="grid_4">
					
					<h3>Friends of CodeBetter.Com</h3>
<ul>

<li><a href="/blogs/products/pages/64386.aspx">Red-Gate Tools For SQL and .NET</a></li>
<li><a href="/blogs/products/pages/64615.aspx">Telerik</a></li>
<li><a href="/blogs/products/pages/142174.aspx">JetBrains - ReSharper</a></li>
<li><a href="/blogs/products/pages/Beyond-Compare.aspx">Beyond Compare</a></li>
<li><a href="/blogs/products/pages/.NET-Memory-Profiler.aspx">.NET Memory Profiler</a></li>
<li><a href="http://www.ndepend.com/">NDepend</a></li>
<li><a href="http://www.sapphiresteel.com/">Ruby In Steel</a></li>
<li><a href="http://www.slickedit.com/">SlickEdit</a></li>
<li><a href="http://www.gurock.com/products/smartinspect/">SmartInspect .NET Logging</a></li>
<li>NGEDIT: <a href="http://www.viemu.com/">ViEmu</a> and <a href="http://www.codekana.com/">Codekana</a> </li>
<li><a href="http://www.devexpress.com/" target="_blank">DevExpress</a></li>
<li><a href="http://nhprof.com" target="_blank">NHibernate Profiler</a></li>
<li><a href="http://unfuddle.com" target="_blank">Unfuddle</a></li>
<li><a href="http://www.balsamiq.com/products/mockups" target="_blank">Balsamiq Mockups</a></li>
<li><a href="http://scrumy.com" target="_blank">Scrumy</a> &lt;-- NEW Friend!</li>

	</ul>				
				</div><!-- #third .widget-area -->
				<div class="grid_4">
					CodeBetter.Com &copy; '11<br />
						Stuff you need to Code Better!<br />
				Proudly powered by <span id="generator-link"><a href="http://wordpress.org/" title="Semantic Personal Publishing Platform" rel="generator">WordPress</a></span>.					
				</div><!-- #fourth .widget-area -->
			</div><!-- #footer-widget-area -->		
		
			</div><!-- end div.container_12 -->

	</div><!-- end div#footer -->
		
<script type="text/javascript">

  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-531207-1']);
  _gaq.push(['_trackPageview']);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();

</script>
<script type='text/javascript' src='/wp-content/plugins/syntaxhighlighter/syntaxhighlighter3/scripts/shCore.js?ver=3.0.83b'></script>
<script type='text/javascript' src='/wp-content/plugins/syntaxhighlighter/syntaxhighlighter3/scripts/shBrushCSharp.js?ver=3.0.83b'></script>
<script type='text/javascript' src='/wp-content/plugins/syntaxhighlighter/syntaxhighlighter3/scripts/shBrushRuby.js?ver=3.0.83b'></script>
<script type='text/javascript' src='/wp-content/plugins/syntaxhighlighter/syntaxhighlighter3/scripts/shBrushJScript.js?ver=3.0.83b'></script>
<script type='text/javascript' src='/wp-content/plugins/syntaxhighlighter/syntaxhighlighter3/scripts/shBrushXml.js?ver=3.0.83b'></script>
<script type='text/javascript' src='/wp-content/plugins/syntaxhighlighter//third-party-brushes/shBrushFSharp.js?ver=3.0.83b'></script>
<script type='text/javascript'>
	(function(){
		var corecss = document.createElement('link');
		var themecss = document.createElement('link');
		var corecssurl = "/wp-content/plugins/syntaxhighlighter/syntaxhighlighter3/styles/shCore.css?ver=3.0.83b";
		if ( corecss.setAttribute ) {
				corecss.setAttribute( "rel", "stylesheet" );
				corecss.setAttribute( "type", "text/css" );
				corecss.setAttribute( "href", corecssurl );
		} else {
				corecss.rel = "stylesheet";
				corecss.href = corecssurl;
		}
		document.getElementsByTagName("head")[0].insertBefore( corecss, document.getElementById("syntaxhighlighteranchor") );
		var themecssurl = "/wp-content/plugins/syntaxhighlighter/syntaxhighlighter3/styles/shThemeDefault.css?ver=3.0.83b";
		if ( themecss.setAttribute ) {
				themecss.setAttribute( "rel", "stylesheet" );
				themecss.setAttribute( "type", "text/css" );
				themecss.setAttribute( "href", themecssurl );
		} else {
				themecss.rel = "stylesheet";
				themecss.href = themecssurl;
		}
		//document.getElementById("syntaxhighlighteranchor").appendChild(themecss);
		document.getElementsByTagName("head")[0].insertBefore( themecss, document.getElementById("syntaxhighlighteranchor") );
	})();
	SyntaxHighlighter.config.strings.expandSource = '+ expand source';
	SyntaxHighlighter.config.strings.help = '?';
	SyntaxHighlighter.config.strings.alert = 'SyntaxHighlighter\n\n';
	SyntaxHighlighter.config.strings.noBrush = 'Can\'t find brush for: ';
	SyntaxHighlighter.config.strings.brushNotHtmlScript = 'Brush wasn\'t configured for html-script option: ';
	SyntaxHighlighter.defaults['gutter'] = false;
    SyntaxHighlighter.defaults['tab-size'] = 2;
    SyntaxHighlighter.defaults['toolbar'] = false;
    SyntaxHighlighter.defaults['wrap-lines'] = false; 
	SyntaxHighlighter.defaults['pad-line-numbers'] = false;
	SyntaxHighlighter.all();
</script>
 
</body>
</html>
<!-- Dynamic page generated in 0.278 seconds. -->
<!-- Cached page generated by WP-Super-Cache on 2011-01-25 15:02:21 -->
<!-- super cache -->