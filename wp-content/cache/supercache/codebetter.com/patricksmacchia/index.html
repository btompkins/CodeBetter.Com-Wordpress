<!DOCTYPE html>
<html dir="ltr" lang="en-US">
<head>
	<meta charset="UTF-8" />
    <title>Patrick Smacchia</title>
	<link rel="profile" href="http://gmpg.org/xfn/11" />
	
	<link href="http://feeds.feedburner.com/CodeBetter" title="CodeBetter.Com &raquo; Feed" type="application/rss+xml" rel="alternate">
	
		<link rel="pingback" href="http://codebetter.com/patricksmacchia/xmlrpc.php" />
	                <link rel="stylesheet" href="http://cdn1.codebetter.com/wp-content/uploads/spacker-cache/9c948bdd2f1091a54122a72f9e6211ad.css" type="text/css" media="all" /><!-- Cache! -->
                <link rel="EditURI" type="application/rsd+xml" title="RSD" href="http://codebetter.com/patricksmacchia/xmlrpc.php?rsd" />
<link rel="wlwmanifest" type="application/wlwmanifest+xml" href="http://cdn1.codebetter.com/wp-includes/wlwmanifest.xml" /> 
<meta name="generator" content="WordPress 3.4.2" />

<!-- All in One SEO Pack 1.6.15.2 by Michael Torbert of Semper Fi Web Design[83,162] -->
<link rel="canonical" href="http://codebetter.com/patricksmacchia/" />
<!-- /all in one seo pack -->
<link rel="stylesheet" href="http://cdn1.codebetter.com/wp-content/plugins/digg-digg/include/../css/diggdigg-style.css?ver=5.2.9" type="text/css" media="screen" /><meta id="syntaxhighlighteranchor" name="syntaxhighlighter-version" content="3.1.3" />
                <script type="text/javascript" src="http://cdn1.codebetter.com/wp-content/uploads/spacker-cache/387916efa7250d5fe9e3c56f33a32233.js">/*Cache!*/</script>
                	
	<script type='text/javascript' src='http://d1.openx.org/spcjs.php?id=7744&amp;target=_blank'></script>
	<style type="text/css">body { padding-top:0px !important; } html { margin-top: 0px !important; }</style>
<!-- BuySellAds Ad Code -->
<script type="text/javascript">
(function(){
  var bsa = document.createElement('script');
     bsa.type = 'text/javascript';
     bsa.async = true;
     bsa.src = 'http://s3.buysellads.com/ac/bsa.js';
  (document.getElementsByTagName('head')[0]||document.getElementsByTagName('body')[0]).appendChild(bsa);
})();
</script>
<!-- End BuySellAds Ad Code -->
</head>

<body>

			
		<div class="container_12 ui-tabs ui-widget ui-widget-content ui-corner-all" id="tabs">			
			<ul class="ui-tabs-nav ui-helper-reset ui-helper-clearfix ui-widget-header ui-corner-all">
				<li class="ui-state-default ui-corner-top ui-tabs-selected ui-state-active"><a href="#ui-tabs-1">CodeBetter.Com</a></li>
				<li class="ui-state-default ui-corner-top"><a href="http://devlicio.us">Devlicio.Us</a></li>				
				<div id="top-search">
				<form action="http://codebetter.com/globalsearch/" id="cse-search-box">
  <div>
   <fieldset id="search">
		<input type="hidden" name="cx" value="005178204031477491434:2bg5jtwgsfe" />
		<input type="hidden" name="cof" value="FORID:9" />
		<input type="hidden" name="ie" value="UTF-8" />
		<input type="text"  class="text-input" id="s" name="q" size="31" />
		<input type="image" src="http://cdn1.codebetter.com/wp-content/themes/codebetter/images/search-img.png" class="form-button" id="searchsubmit" value="GO" name="">				   	
	</fieldset>
  </div>
</form>
<script type="text/javascript" src="http://www.google.com/cse/brand?form=cse-search-box&lang=en&sitesearch=true"></script>
				</div>				
			</ul><div id="ui-tabs-1" class="ui-tabs-panel ui-widget-content ui-corner-bottom"></div><div id="ui-tabs-2" class="ui-tabs-panel ui-widget-content ui-corner-bottom ui-tabs-hide"></div>
		</div>
			
		<div id="main" class="container_12">
		
			<div id="logo" class="grid_3"><a href="/" title="CodeBetter.Com - Stuff you need to Code Better!"><image src="http://cdn1.codebetter.com/wp-content/themes/codebetter/images/codebetter_logo.png" height="48" width="223"></image></a></div>
			<div id="ad_leaderboard" class="grid_9">
			<!-- BuySellAds Zone Code -->
<div id="bsap_1276080" class="bsarocks bsap_4fe632babdccc2b4b049e4f08cc3c549"></div>
<!-- End BuySellAds Zone Code --></div>
			
			<div id="globalNav" class="grid_12">
				<ul>
					<li><a href="http://codebetter.com" title="home">Home</a></li>
					<li class="page_item page-item-2"><a href="http://codebetter.com/about/">About</a></li>
<li class="page_item page-item-8"><a href="http://codebetter.com/codebetter-ci/">CodeBetter CI</a></li>
<li class="page_item page-item-6"><a href="http://codebetter.com/community/">Community</a></li>
<li class="page_item page-item-10"><a href="http://codebetter.com/editors/">Editors</a></li>
					<li><a href="http://feeds.feedburner.com/CodeBetter" rel="alternate" type="application/rss+xml"><img src="http://www.feedburner.com/fb/images/pub/feed-icon16x16.png" alt="" style="vertical-align:middle;border:0"/></a><a href="http://feeds.feedburner.com/CodeBetter"><img src="http://feeds.feedburner.com/~fc/CodeBetter?bg=EFEFEF&amp;fg=2E9BD2&amp;anim=1" height="26" width="88" style="vertical-align:middle;border:0"/></a></li>
				</ul>
								
			</div><!-- end div#globalNav.container_12 -->				
		<div id="content">
		<div id="main" class="grid_8">
		<div id="greet_block"><noscript><div class="greet_block wpgb_cornered"><div class="greet_text"><div class="greet_image"><a href="http://codebetter.com/patricksmacchia/feed/rss/"  rel="nofollow"><img src="http://cdn1.codebetter.com/wp-content/plugins/wp-greet-box/images/rss_icon.png" alt="WP Greet Box icon"/></a></div>Hello there! If you are new here, you might want to <a href="http://codebetter.com/patricksmacchia/feed/rss/" rel="nofollow"><strong>subscribe to the RSS feed</strong></a> for updates on this topic.<div style="clear:both"></div><div class="greet_block_powered_by">Powered by <a href="http://omninoggin.com/projects/wordpress-plugins/wp-greet-box-wordpress-plugin/" title="WP Greet Box WordPress Plugin" style="text-decoration:none;">WP Greet Box</a> <a href="http://omninoggin.com/" title="WordPress Plugin" style="text-decoration:none;">WordPress Plugin</a></div><div style="clear:both"></div></div></div></noscript></div>		
	<div id="nav-above" class="navigation">
		<div class="nav-next"><a href="?page=1" > Next Page &raquo;</a></div>
		
	</div><!-- #nav-above -->


				
			<div id="post-752" class="post-752 post type-post status-publish format-standard hentry category-net-assemblies category-net-framework category-net-fx category-acyclic-componentization category-code-dependency category-component category-cqlinq category-cycle category-dag category-dependencies category-dependency-cycle category-dependency-graph category-dependency-matrix category-graph-of-callers category-graph-of-dependencies category-indirect-dependency category-pattern category-patterns">
			<h2 class="entry-title"><a href="http://codebetter.com/patricksmacchia/2012/10/31/two-screencasts-on-how-to-demystify-spaghetti-code/" title="Permalink to Two Screencasts on How to Demystify Spaghetti Code" rel="bookmark">Two Screencasts on How to Demystify Spaghetti Code</a></h2>

			<div class="entry-meta">
				<span class="meta-prep meta-prep-author">Posted on </span><a href="http://codebetter.com/patricksmacchia/2012/10/31/two-screencasts-on-how-to-demystify-spaghetti-code/" title="3:14 pm" rel="bookmark"><span class="entry-date">October 31, 2012</span></a> <span class="meta-sep"> by </span> <span class="author vcard"><a class="url fn n" href="http://codebetter.com/patricksmacchia" title="View all posts by Patrick Smacchia">Patrick Smacchia</a></span>			</div><!-- .entry-meta -->

				<div class="entry-content">
				<p>In my consultant career, no matter the kind of company I visited, from the tiny startup to the largest fortune 500 corporation, they all have in common to be entangled in spaghetti. Spaghetti means poorly structured code. Spaghetti means high maintenance and evolution cost. Spaghetti means frustration, friction and lack of motivation for everyone in the team. And often, spaghetti means project failure.</p>
<p>Mastering code structure means demystifying and getting rid of spaghetti code! With <a href="http://blog.filipekberg.se/" target="_blank">Filip Ekberg</a>, we propose you to cover in-depth code dependencies management through two 30 minutes screencasts. The tool <a href="http://www.NDepend.com" target="_blank">NDepend</a> is used to shed light on the structure of real-world code bases.</p>
<p>The first screencast shows how to make the best of dependency graph and dependency matrix tooling to explore the structure of a .NET application. This includes detecting at a glance good patterns or smelly patterns, buried in the code. In this screencast, we also explain how to master interaction between code query LINQ generation and dependency graph and matrix. Doing so constitutes a very powerful way to generate all custom graph you really need to visualize, like custom call graphs and inheritance graphs.</p>
<p>The second screencast starts with focusing on dependency code rules. This is especially useful to write rules related to Object-Oriented tenets, like <em>base class shouldn&#8217;t use derivatives</em>, or to list <em>instance method that could be made static</em>. We then continue with rules concerned with layered architecture, like <em>UI layer shouldn&#8217;t use the DAL layer</em> or <em>components dependency cycles </em>detection. We finally explore entangled layering in the real-world, and explain how to get rid of spaghetti and achieve well structured code bases.</p>
<p>These screencats contain many original and useful <em>haha</em> hints that will improve the way you and your team manage your .NET code base dependencies.</p>
<p>Enjoy <img src='http://cdn1.codebetter.com/wp-includes/images/smilies/icon_smile.gif' alt=':)' class='wp-smiley' /> </p>
<p><strong>Part I</strong></p>
<p><iframe src="http://player.vimeo.com/video/52020901" width="640" height="360" frameborder="0" webkitAllowFullScreen mozallowfullscreen allowFullScreen></iframe></p>
<p><strong>Part II</strong></p>
<p><iframe src="http://player.vimeo.com/video/52423676" width="640" height="360" frameborder="0" webkitAllowFullScreen mozallowfullscreen allowFullScreen></iframe></p>
							</div><!-- .entry-content -->
	
			<div class="entry-utility">
				<span class="cat-links"><span class="entry-utility-prep entry-utility-prep-cat-links">Posted in <a href="http://codebetter.com/patricksmacchia/category/net-assemblies/" title="View all posts in .NET assemblies" rel="category">.NET assemblies</a>, <a href="http://codebetter.com/patricksmacchia/category/net-framework/" title="View all posts in .NET Framework" rel="category">.NET Framework</a>, <a href="http://codebetter.com/patricksmacchia/category/net-fx/" title="View all posts in .NET Fx" rel="category">.NET Fx</a>, <a href="http://codebetter.com/patricksmacchia/category/acyclic-componentization/" title="View all posts in Acyclic componentization" rel="category">Acyclic componentization</a>, <a href="http://codebetter.com/patricksmacchia/category/code-dependency/" title="View all posts in Code Dependency" rel="category">Code Dependency</a>, <a href="http://codebetter.com/patricksmacchia/category/component/" title="View all posts in Component" rel="category">Component</a>, <a href="http://codebetter.com/patricksmacchia/category/cqlinq/" title="View all posts in CQLinq" rel="category">CQLinq</a>, <a href="http://codebetter.com/patricksmacchia/category/cycle/" title="View all posts in Cycle" rel="category">Cycle</a>, <a href="http://codebetter.com/patricksmacchia/category/dag/" title="View all posts in DAG" rel="category">DAG</a>, <a href="http://codebetter.com/patricksmacchia/category/dependencies/" title="View all posts in Dependencies" rel="category">Dependencies</a>, <a href="http://codebetter.com/patricksmacchia/category/dependency-cycle/" title="View all posts in Dependency Cycle" rel="category">Dependency Cycle</a>, <a href="http://codebetter.com/patricksmacchia/category/dependency-graph/" title="View all posts in Dependency Graph" rel="category">Dependency Graph</a>, <a href="http://codebetter.com/patricksmacchia/category/dependency-matrix/" title="View all posts in Dependency Matrix" rel="category">Dependency Matrix</a>, <a href="http://codebetter.com/patricksmacchia/category/graph-of-callers/" title="View all posts in graph of callers" rel="category">graph of callers</a>, <a href="http://codebetter.com/patricksmacchia/category/graph-of-dependencies/" title="View all posts in Graph of Dependencies" rel="category">Graph of Dependencies</a>, <a href="http://codebetter.com/patricksmacchia/category/indirect-dependency/" title="View all posts in Indirect Dependency" rel="category">Indirect Dependency</a>, <a href="http://codebetter.com/patricksmacchia/category/pattern/" title="View all posts in Pattern" rel="category">Pattern</a>, <a href="http://codebetter.com/patricksmacchia/category/patterns/" title="View all posts in Patterns" rel="category">Patterns</a></span></span>
				<span class="meta-sep"> | </span>
												<span class="comments-link"><a href="http://codebetter.com/patricksmacchia/2012/10/31/two-screencasts-on-how-to-demystify-spaghetti-code/#comments" title="Comment on Two Screencasts on How to Demystify Spaghetti Code"><span class="dsq-postid" rel="752 http://codebetter.com/patricksmacchia/?p=752">1 Comment</span></a></span>
							</div><!-- #entry-utility -->
		</div><!-- #post-752 -->

		
						
			<div id="post-731" class="post-731 post type-post status-publish format-standard hentry category-c category-code-dependency category-code-query category-code-rule category-code-structure category-code-visualization category-cqlinq category-dependency-matrix category-layer category-linq category-namespace category-namespaces category-ndepend category-pattern category-patterns category-performance">
			<h2 class="entry-title"><a href="http://codebetter.com/patricksmacchia/2012/10/26/validating-architecture-through-one-linq-query/" title="Permalink to Validating Architecture through LINQ Query" rel="bookmark">Validating Architecture through LINQ Query</a></h2>

			<div class="entry-meta">
				<span class="meta-prep meta-prep-author">Posted on </span><a href="http://codebetter.com/patricksmacchia/2012/10/26/validating-architecture-through-one-linq-query/" title="9:53 am" rel="bookmark"><span class="entry-date">October 26, 2012</span></a> <span class="meta-sep"> by </span> <span class="author vcard"><a class="url fn n" href="http://codebetter.com/patricksmacchia" title="View all posts by Patrick Smacchia">Patrick Smacchia</a></span>			</div><!-- .entry-meta -->

				<div class="entry-content">
				<p>These days we are restructuring the NDepend code base to make it more suited to welcome future features implementation. Here is below the new architecture of the NDepend.UI assembly, made of around 50.000 lines of code, shown through a <a href="http://www.ndepend.com/Doc_Matrix.aspx" target="_blank">Dependency Structure Matrix</a>:</p>
<p><a href="http://codebetter.com/patricksmacchia/files/2012/10/Matrix1.png"><img class="alignnone size-full wp-image-743" src="http://codebetter.com/patricksmacchia/files/2012/10/Matrix1.png" alt="" width="595" height="429" /></a></p>
<p>As always, the dependency matrix naturally exhibits architectural patterns. Keep in mind that a <span style="color: #0000ff">blue cell</span> means: the namespace in column is using the namespace in row. The number on a <span style="color: #0000ff">blue cell</span> represents the number of members used (see the option in the matrix menu: <em>Weight on Cells</em> set to <em>Direct: # members</em>). This cell number is then a measure of the coupling between the two namespaces.</p>
<p>Here are architecture patterns emerging from this dependency matrix:</p>
<ul>
<li>There is one <strong>Top</strong> namespace, that is using all namespaces (<span style="color: #0000ff">blue column #0</span>)</li>
<li>There is one <strong>Base</strong> namespace, that is used by all namespaces (<span style="color: #0000ff">blue row #17</span>)</li>
<li>The <strong>Panels</strong> namespaces don&#8217;t use each others (<span style="color: #ff0000">empty big red square</span>, rows/columns [1-12])</li>
<li>The <strong>Shared</strong> namespaces don&#8217;t use each others (<span style="color: #ff0000">empty small red square</span>, rows/columns [13-16])</li>
<li>The <span style="color: #0000ff">blue cells</span> in the rectangle rows [13,16] x columns [1,12], represents the usage of shared features by the panels. For example, on row #15 we can see that the <strong>DependencyContextMenu</strong> feature is used by the <strong>Top</strong>, <strong>Graph</strong> and <strong>Matrix</strong> impl.</li>
</ul>
<p>I found this NDepend.UI architecture pretty neat. Whether we will add a new panel or a new shared feature in the future, it will be inserted naturally in this structure. And this architecture is simple enough to get validated at a glance. But at a glance is not enough. What about defining custom rules that take care of validating this architecture and inform us <em>automatically</em> of any violation?</p>
<p>Each of this architecture pattern could be actually validated through a <a href="http://www.ndepend.com/Features.aspx#CQL" target="_blank">Code Query LINQ</a> rule. Let&#8217;s go through 5 steps to write the rule <strong>Panels shouldn&#8217;t use each others</strong> through a LINQ query.</p>
<h2><strong>5 steps to write the rule: Panels shouldn&#8217;t use each others</strong></h2>
<p><span style="text-decoration: underline"><strong>Step 1:</strong></span> First, let&#8217;s match all panels namespaces. Here we are using the extension method <a href="http://www.ndepend.com/API/webframe.html?NDepend.API~NDepend.CodeModel.ExtensionMethodsNaming~WithNameWildcardMatch.html" target="_blank">WithNameWildcardMatch()</a> to match the panels namespaces by name. We can see that some panels (<em>Matrix, QueryEdit, Search</em>&#8230;) are made of several sub-namespaces. The rule must be smart enough to both:</p>
<ul>
<li>let sub-namespaces of a panel use each others,</li>
<li>forbid sub-namespaces of different panels use each others:</li>
</ul>
<p><a href="http://codebetter.com/patricksmacchia/files/2012/10/Query1.png"><img class="alignnone size-full wp-image-734" src="http://codebetter.com/patricksmacchia/files/2012/10/Query1.png" alt="" width="563" height="715" /></a></p>
<p><strong><span style="text-decoration: underline">Step 2:</span> </strong>Now let&#8217;s use the method <a href="http://www.ndepend.com/API/webframe.html?NDepend.API~NDepend.CodeModel.IUser~IsUsing.html" target="_blank">IUser.IsUsing()</a> to list the couples of [namespace user, namespace used]. Notice that to improve the query performance:</p>
<ul>
<li>we are restraining the set of namespaces <em>user</em> only to the panels namespaces that are indeed <em>using</em> another panel namespace (with the extension method <a href="http://www.ndepend.com/API/webframe.html?NDepend.API~NDepend.CodeModel.ExtensionMethodsSequenceUsage~UsingAny.html" target="_blank">UsingAny()</a> )</li>
<li>we are restraining the set of namespaces <em>used</em> only to the panels namespaces that are indeed <em>used by</em> another panel namespace (with the extension method <a href="http://www.ndepend.com/API/webframe.html?NDepend.API~NDepend.CodeModel.ExtensionMethodsSequenceUsage~UsedByAny.html" target="_blank">UsedByAny()</a> )</li>
</ul>
<div><span style="font-size: medium"><span style="line-height: 24px">And indeed the query runs fast: 5 milli-seconds on a more than 130.000 lines of code code base! There are 45 couples of [namespace user, namespace used] listed:</span></span></div>
<p><a href="http://codebetter.com/patricksmacchia/files/2012/10/Query2.png"><img class="alignnone size-full wp-image-740" src="http://codebetter.com/patricksmacchia/files/2012/10/Query2.png" alt="" width="559" height="854" /></a></p>
<p><strong><span style="text-decoration: underline">Step 3:</span> </strong>Now, we need to validate for each couple of [namespace user, namespace used], that both user/used namespaces belong to the same panel. For that we have to work on the namespace name string. Let&#8217;s first get rid of the prefix <em>&#8220;NDepend.UI.Panels.&#8221;</em> and obtain for each namespace what we call its<em> sub-name</em>:</p>
<p><a href="http://codebetter.com/patricksmacchia/files/2012/10/Query3.png"><img class="alignnone size-full wp-image-740" src="http://codebetter.com/patricksmacchia/files/2012/10/Query3.png" alt="" width="556" height="814" /></a></p>
<p><span style="text-decoration: underline"><strong>Step 4:</strong></span> Let&#8217;s get the panel name from the namespace sub-name. For that we are using the ternary operator: if the namespace sub-name doens&#8217;t contain any dot, it is already the panel name. Else, the panel name is the sub-string until the first dot met in the sub-name:</p>
<p><a href="http://codebetter.com/patricksmacchia/files/2012/10/Query4.png"><img class="alignnone size-full wp-image-740" src="http://codebetter.com/patricksmacchia/files/2012/10/Query4.png" alt="" width="558" height="827" /></a></p>
<p><span style="text-decoration: underline"><strong>Step 5:</strong></span> <em>Et voila!</em> We now just have to make sure that for each couple of [namespace user, namespace used] they have the same panel name! This is as simple as adding the where clause: <em>where nUserPanel != nUsedPanel</em>.</p>
<p>We then add the prefix <em>warnif count &gt; 0</em> to transform our code query into a code rule. Plus, we set the name of the rule to <em>Panels shouldn&#8217;t use each others</em>. And the rule is ready to be saved, and to be run continuously in Visual Studio and/or on the build machine.</p>
<p><a href="http://codebetter.com/patricksmacchia/files/2012/10/Query5.png"><img class="alignnone size-full wp-image-739" src="http://codebetter.com/patricksmacchia/files/2012/10/Query5.png" alt="" width="560" height="563" /></a></p>
<p>Note that this rule gets compiled and executed in only 7 milli-seconds (see <em>7 ms</em> on the screenshot). This means that a typical machine can run in one second more than 140 of such complex rules against a large code base!</p>
<p>And also, <strong>when new panels will be developed, this rule won&#8217;t have to be updated</strong>. It&#8217;ll just work!</p>
<p>Could it be easier or faster to validate the architecture of a big lump of code?</p>
<p>Btw, just a quick side remark: The fact that panels <em>implementations</em> are not <em>using</em> each other doesn&#8217;t mean that panel shouldn&#8217;t <em>interact</em> with each other. They actually do interact <em>a lot</em> with each others. But they do interact through using a <a href="http://en.wikipedia.org/wiki/Mediator_pattern" target="_blank">mediator implementation</a> that lives in the <strong>Base</strong> namespace. This mediator then calls the <strong>Top</strong> implementation (through inversion of control) that takes care of dispatching any interaction to the right panel.</p>
							</div><!-- .entry-content -->
	
			<div class="entry-utility">
				<span class="cat-links"><span class="entry-utility-prep entry-utility-prep-cat-links">Posted in <a href="http://codebetter.com/patricksmacchia/category/c/" title="View all posts in C#" rel="category">C#</a>, <a href="http://codebetter.com/patricksmacchia/category/code-dependency/" title="View all posts in Code Dependency" rel="category">Code Dependency</a>, <a href="http://codebetter.com/patricksmacchia/category/code-query/" title="View all posts in Code Query" rel="category">Code Query</a>, <a href="http://codebetter.com/patricksmacchia/category/code-rule/" title="View all posts in Code Rule" rel="category">Code Rule</a>, <a href="http://codebetter.com/patricksmacchia/category/code-structure/" title="View all posts in code structure" rel="category">code structure</a>, <a href="http://codebetter.com/patricksmacchia/category/code-visualization/" title="View all posts in Code visualization" rel="category">Code visualization</a>, <a href="http://codebetter.com/patricksmacchia/category/cqlinq/" title="View all posts in CQLinq" rel="category">CQLinq</a>, <a href="http://codebetter.com/patricksmacchia/category/dependency-matrix/" title="View all posts in Dependency Matrix" rel="category">Dependency Matrix</a>, <a href="http://codebetter.com/patricksmacchia/category/layer/" title="View all posts in Layer" rel="category">Layer</a>, <a href="http://codebetter.com/patricksmacchia/category/linq/" title="View all posts in LINQ" rel="category">LINQ</a>, <a href="http://codebetter.com/patricksmacchia/category/namespace/" title="View all posts in namespace" rel="category">namespace</a>, <a href="http://codebetter.com/patricksmacchia/category/namespaces/" title="View all posts in namespaces" rel="category">namespaces</a>, <a href="http://codebetter.com/patricksmacchia/category/ndepend/" title="View all posts in NDepend" rel="category">NDepend</a>, <a href="http://codebetter.com/patricksmacchia/category/pattern/" title="View all posts in Pattern" rel="category">Pattern</a>, <a href="http://codebetter.com/patricksmacchia/category/patterns/" title="View all posts in Patterns" rel="category">Patterns</a>, <a href="http://codebetter.com/patricksmacchia/category/performance/" title="View all posts in Performance" rel="category">Performance</a></span></span>
				<span class="meta-sep"> | </span>
												<span class="comments-link"><a href="http://codebetter.com/patricksmacchia/2012/10/26/validating-architecture-through-one-linq-query/#comments" title="Comment on Validating Architecture through LINQ Query"><span class="dsq-postid" rel="731 http://codebetter.com/patricksmacchia/?p=731">2 Comments</span></a></span>
							</div><!-- #entry-utility -->
		</div><!-- #post-731 -->

		
						
			<div id="post-721" class="post-721 post type-post status-publish format-standard hentry category-cc category-code-diff category-code-metrics category-code-rule category-cyclomatic-complexity">
			<h2 class="entry-title"><a href="http://codebetter.com/patricksmacchia/2012/10/15/screencast-inspecting-code-quality-and-code-complexity/" title="Permalink to Screencast: Inspecting Code Quality and Code Complexity" rel="bookmark">Screencast: Inspecting Code Quality and Code Complexity</a></h2>

			<div class="entry-meta">
				<span class="meta-prep meta-prep-author">Posted on </span><a href="http://codebetter.com/patricksmacchia/2012/10/15/screencast-inspecting-code-quality-and-code-complexity/" title="11:56 am" rel="bookmark"><span class="entry-date">October 15, 2012</span></a> <span class="meta-sep"> by </span> <span class="author vcard"><a class="url fn n" href="http://codebetter.com/patricksmacchia" title="View all posts by Patrick Smacchia">Patrick Smacchia</a></span>			</div><!-- .entry-meta -->

				<div class="entry-content">
				<p>Recently I had a chance to record a screencast on Inspecting Code Quality and Code Complexity with <a href="http://blog.filipekberg.se/" target="_blank">Filip Ekberg</a>. In this half-hour video we inspect the NUnit v2.5.8 code base quality and complexity with NDepend v4.0:</p>
<ul>
<li>We first use the popular Cyclomatic Complexity code metric&#8230;</li>
<li>&#8230;we then refine our findings by focusing on code quality regression since NUnit v2.5.3.</li>
<li>&#8230;some more code metrics are then involved, including the code coverage ratio by tests, the C.R.A.P metric and the code coupling ratio.</li>
</ul>
<div><span style="font-size: medium"><span style="line-height: 24px">We plan to do more screencast on other programming related topics. Your feedbacks and suggestions are welcomed.</span></span></div>
<div></div>
<div><span style="font-size: medium"><span style="line-height: 24px">Enjoy!</span></span></div>
<p><iframe src="http://player.vimeo.com/video/51204579?title=1&amp;byline=1&amp;portrait=1" width="640" height="360" frameborder="0" webkitAllowFullScreen mozallowfullscreen allowFullScreen></iframe></p>
							</div><!-- .entry-content -->
	
			<div class="entry-utility">
				<span class="cat-links"><span class="entry-utility-prep entry-utility-prep-cat-links">Posted in <a href="http://codebetter.com/patricksmacchia/category/cc/" title="View all posts in CC" rel="category">CC</a>, <a href="http://codebetter.com/patricksmacchia/category/code-diff/" title="View all posts in Code Diff" rel="category">Code Diff</a>, <a href="http://codebetter.com/patricksmacchia/category/code-metrics/" title="View all posts in Code metrics" rel="category">Code metrics</a>, <a href="http://codebetter.com/patricksmacchia/category/code-rule/" title="View all posts in Code Rule" rel="category">Code Rule</a>, <a href="http://codebetter.com/patricksmacchia/category/cyclomatic-complexity/" title="View all posts in Cyclomatic complexity" rel="category">Cyclomatic complexity</a></span></span>
				<span class="meta-sep"> | </span>
												<span class="comments-link"><a href="http://codebetter.com/patricksmacchia/2012/10/15/screencast-inspecting-code-quality-and-code-complexity/#comments" title="Comment on Screencast: Inspecting Code Quality and Code Complexity"><span class="dsq-postid" rel="721 http://codebetter.com/patricksmacchia/?p=721">1 Comment</span></a></span>
							</div><!-- #entry-utility -->
		</div><!-- #post-721 -->

		
						
			<div id="post-702" class="post-702 post type-post status-publish format-standard hentry category-net-framework category-net-fx category-c category-code-query category-code-rule category-cqlinq">
			<h2 class="entry-title"><a href="http://codebetter.com/patricksmacchia/2012/10/02/beware-mixing-list-sort-and-thread-abort/" title="Permalink to Beware mixing List.Sort() and Thread.Abort()" rel="bookmark">Beware mixing List.Sort() and Thread.Abort()</a></h2>

			<div class="entry-meta">
				<span class="meta-prep meta-prep-author">Posted on </span><a href="http://codebetter.com/patricksmacchia/2012/10/02/beware-mixing-list-sort-and-thread-abort/" title="2:24 pm" rel="bookmark"><span class="entry-date">October 2, 2012</span></a> <span class="meta-sep"> by </span> <span class="author vcard"><a class="url fn n" href="http://codebetter.com/patricksmacchia" title="View all posts by Patrick Smacchia">Patrick Smacchia</a></span>			</div><!-- .entry-meta -->

				<div class="entry-content">
				<p>After more than a decade of full-time development with .NET, I still discover surprising unfixed bugs in the heart of the framework. Today, while I was smoke-testing new stuff in the NDepend UI, I stumbled on an <a href="http://msdn.microsoft.com/en-us/library/system.invalidoperationexception.aspx" target="_blank">InvalidOperationException</a> thrown by a call to <a href="http://msdn.microsoft.com/en-us/library/b0zbh7b6.aspx" target="_blank">List&lt;T&gt;.Sort()</a> ?!</p>
<p>After 15 minutes of searching the cause of the bug, I found this unfixed bug on Microsoft Connect: <a href="http://connect.microsoft.com/VisualStudio/feedback/details/605536/list-sort-throws-invalidoperationexception-instead-of-re-throw-threadabortexception-while-thread-is-being-aborted" target="_blank">List.Sort() throws InvalidOperationException (instead of re-throw ThreadAbortException) while thread is being aborted</a></p>
<p>In other words, if your application is using <a href="http://msdn.microsoft.com/en-us/library/system.threading.thread.abort.aspx" target="_blank">Thread.Abort()</a> somehow, and that the abortable code is calling <em>List&lt;T&gt;.Sort()</em>, you are exposed to the risk of getting an <em>InvalidOperationException</em> instead of a <em>ThreadAbortException</em>.</p>
<p>I already hear that it is a good practice to avoid calling <em>Thread.Abort()</em>, but the fact is that if one wants a responsive UI, one needs some sort of abortable/timed-out background work, and at a point <em>Thread.Abort()</em> will have to be called for that. As long as calling <em>Thread.Abort() </em>is done in a safe way (see this <a href="http://www.bluebytesoftware.com/blog/2009/03/13/ManagedCodeAndAsynchronousExceptionHardening.aspx" target="_blank">Joe Duffy detailled post</a>) we didn&#8217;t meet any problems so far. On millions of production runs logged, we cannot see any problem except &#8230; that <em>List&lt;T&gt;.Sort()</em> throws an <em>InvalidOperationException</em> with the frequency of around one on every 50K production runs. And today, this bug just popped to me in a <em>reproductible</em> way thanks to some refactoring I was doing.</p>
<p>To workaround this problem once for all, I enclosed all calls to any override of <em>List&lt;T&gt;.Sort()</em> in some extension methods in a dedicated class. These <em>BugFreeSort() methods </em>catch the <em>InvalidOperationException. </em>This is fine because anyway the thread is in a <a href="http://msdn.microsoft.com/en-us/library/system.threading.threadstate.aspx" target="_blank">ThreadState.AbortRequested</a> and the CLR will throw the <em>ThreadAbortException </em>at the end of the catch block. Also, attached to this class through an attribute, I declare a <a href="http://www.ndepend.com/ConstraintsExtractedFromCode.aspx" target="_blank">CQLinq code rule in the source code</a> to make sure that all calls to <em>List&lt;T&gt;.Sort()</em> are made through one of these <em>BugFreeSort()</em> methods. Here is the code:</p>
<script src="http://gist.github.com/3819116.js"></script><noscript><link rel="stylesheet" href="https://gist.github.com/stylesheets/gist/embed.css"><div id="gist-3819116" class="gist">
    

        <div class="gist-file">
          <div class="gist-data gist-syntax">
              <div class="highlight"><pre><div class='line' id='LC1'><span class="k">using</span> <span class="nn">System</span><span class="p">;</span></div><div class='line' id='LC2'><span class="k">using</span> <span class="nn">System.Collections.Generic</span><span class="p">;</span></div><div class='line' id='LC3'><span class="k">using</span> <span class="nn">System.Diagnostics</span><span class="p">;</span></div><div class='line' id='LC4'><span class="k">using</span> <span class="nn">System.Threading</span><span class="p">;</span></div><div class='line' id='LC5'><span class="k">using</span> <span class="nn">NDepend.Attributes</span><span class="p">;</span></div><div class='line' id='LC6'><span class="k">using</span> <span class="nn">ThreadState</span> <span class="p">=</span> <span class="n">System</span><span class="p">.</span><span class="n">Threading</span><span class="p">.</span><span class="n">ThreadState</span><span class="p">;</span></div><div class='line' id='LC7'><br/></div><div class='line' id='LC8'><span class="k">namespace</span> <span class="nn">NDepend.Helpers.Collections</span> <span class="p">{</span></div><div class='line' id='LC9'>&nbsp;&nbsp;&nbsp;<span class="c1">//</span></div><div class='line' id='LC10'>&nbsp;&nbsp;&nbsp;<span class="c1">// These extension methods are paliative to a bug of the .NET Fx described here:</span></div><div class='line' id='LC11'>&nbsp;&nbsp;&nbsp;<span class="c1">// http://connect.microsoft.com/VisualStudio/feedback/details/605536/list-sort-throws-invalidoperationexception-instead-of-re-throw-threadabortexception-while-thread-is-being-aborted</span></div><div class='line' id='LC12'>&nbsp;&nbsp;&nbsp;<span class="c1">// List.Sort() throws InvalidOperationException (instead of re-throw ThreadAbortException) while thread is being aborted</span></div><div class='line' id='LC13'>&nbsp;&nbsp;&nbsp;<span class="c1">//</span></div><div class='line' id='LC14'><span class="cp">#if DEBUG</span></div><div class='line' id='LC15'><span class="na">   [CodeRule(@&quot;// &lt;Name&gt;Use List&lt;T&gt;.BugFreeSort() instead of List&lt;T&gt;.Sort()&lt;/Name&gt;</span></div><div class='line' id='LC16'><span class="na">warnif count &gt; 0</span></div><div class='line' id='LC17'><span class="na">let listSortMethods = ThirdParty.Methods</span></div><div class='line' id='LC18'><span class="na">  .WithFullNameWildcardMatch(@&quot;&quot;System.Collections.Generic.List&lt;T&gt;.Sort*&quot;&quot;)</span></div><div class='line' id='LC19'><span class="na">from m in Application.Methods.UsingAny(listSortMethods)  </span></div><div class='line' id='LC20'><span class="na">where m.ParentType.FullName != &quot;&quot;NDepend.Helpers.Collections.ListSortExtensionMethods&quot;&quot;</span></div><div class='line' id='LC21'><span class="na">select new { m, sortMethodCalled = m.MethodsCalled.Intersect(listSortMethods) }&quot;,</span></div><div class='line' id='LC22'><span class="na">      Active = true,</span></div><div class='line' id='LC23'><span class="na">      DisplayStatInReport = true,</span></div><div class='line' id='LC24'><span class="na">      DisplayListInReport = true,</span></div><div class='line' id='LC25'><span class="na">      DisplaySelectionViewInReport = true,</span></div><div class='line' id='LC26'><span class="na">      IsCriticalRule = false)]</span></div><div class='line' id='LC27'><span class="cp">#endif</span></div><div class='line' id='LC28'>&nbsp;&nbsp;&nbsp;<span class="k">public</span> <span class="k">static</span> <span class="k">class</span> <span class="nc">ListSortExtensionMethods</span> <span class="p">{</span></div><div class='line' id='LC29'><br/></div><div class='line' id='LC30'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="k">public</span> <span class="k">static</span> <span class="k">void</span> <span class="n">BugFreeSort</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;(</span><span class="k">this</span> <span class="n">List</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span></div><div class='line' id='LC31'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="n">Debug</span><span class="p">.</span><span class="n">Assert</span><span class="p">(</span><span class="n">list</span> <span class="p">!=</span> <span class="k">null</span><span class="p">);</span></div><div class='line' id='LC32'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="k">try</span> <span class="p">{</span></div><div class='line' id='LC33'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="n">list</span><span class="p">.</span><span class="n">Sort</span><span class="p">();</span></div><div class='line' id='LC34'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="p">}</span> <span class="k">catch</span><span class="p">(</span><span class="n">InvalidOperationException</span><span class="p">)</span> <span class="p">{</span></div><div class='line' id='LC35'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="n">Debug</span><span class="p">.</span><span class="n">Assert</span><span class="p">((</span><span class="n">Thread</span><span class="p">.</span><span class="n">CurrentThread</span><span class="p">.</span><span class="n">ThreadState</span> <span class="p">&amp;</span> <span class="n">ThreadState</span><span class="p">.</span><span class="n">AbortRequested</span><span class="p">)</span> <span class="p">!=</span> <span class="m">0</span><span class="p">);</span></div><div class='line' id='LC36'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="c1">// The exception ThreadAbortException is propagated when closing this catch blok</span></div><div class='line' id='LC37'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="p">}</span></div><div class='line' id='LC38'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="p">}</span></div><div class='line' id='LC39'><br/></div><div class='line' id='LC40'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="k">public</span> <span class="k">static</span> <span class="k">void</span> <span class="n">BugFreeSort</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;(</span><span class="k">this</span> <span class="n">List</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;</span> <span class="n">list</span><span class="p">,</span> <span class="n">Comparison</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;</span> <span class="n">comparison</span><span class="p">)</span> <span class="p">{</span></div><div class='line' id='LC41'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="n">Debug</span><span class="p">.</span><span class="n">Assert</span><span class="p">(</span><span class="n">list</span> <span class="p">!=</span> <span class="k">null</span><span class="p">);</span></div><div class='line' id='LC42'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="n">Debug</span><span class="p">.</span><span class="n">Assert</span><span class="p">(</span><span class="n">comparison</span> <span class="p">!=</span> <span class="k">null</span><span class="p">);</span></div><div class='line' id='LC43'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="k">try</span> <span class="p">{</span></div><div class='line' id='LC44'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="n">list</span><span class="p">.</span><span class="n">Sort</span><span class="p">(</span><span class="n">comparison</span><span class="p">);</span></div><div class='line' id='LC45'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="n">InvalidOperationException</span><span class="p">)</span> <span class="p">{</span></div><div class='line' id='LC46'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="n">Debug</span><span class="p">.</span><span class="n">Assert</span><span class="p">((</span><span class="n">Thread</span><span class="p">.</span><span class="n">CurrentThread</span><span class="p">.</span><span class="n">ThreadState</span> <span class="p">&amp;</span> <span class="n">ThreadState</span><span class="p">.</span><span class="n">AbortRequested</span><span class="p">)</span> <span class="p">!=</span> <span class="m">0</span><span class="p">);</span></div><div class='line' id='LC47'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="c1">// The exception ThreadAbortException is propagated when closing this catch blok</span></div><div class='line' id='LC48'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="p">}</span></div><div class='line' id='LC49'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="p">}</span></div><div class='line' id='LC50'><br/></div><div class='line' id='LC51'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="k">public</span> <span class="k">static</span> <span class="k">void</span> <span class="n">BugFreeSort</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;(</span><span class="k">this</span> <span class="n">List</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;</span> <span class="n">list</span><span class="p">,</span> <span class="n">IComparer</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;</span> <span class="n">comparer</span><span class="p">)</span> <span class="p">{</span></div><div class='line' id='LC52'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="n">Debug</span><span class="p">.</span><span class="n">Assert</span><span class="p">(</span><span class="n">list</span> <span class="p">!=</span> <span class="k">null</span><span class="p">);</span></div><div class='line' id='LC53'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="n">Debug</span><span class="p">.</span><span class="n">Assert</span><span class="p">(</span><span class="n">comparer</span> <span class="p">!=</span> <span class="k">null</span><span class="p">);</span></div><div class='line' id='LC54'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="k">try</span> <span class="p">{</span></div><div class='line' id='LC55'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="n">list</span><span class="p">.</span><span class="n">Sort</span><span class="p">(</span><span class="n">comparer</span><span class="p">);</span></div><div class='line' id='LC56'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="n">InvalidOperationException</span><span class="p">)</span> <span class="p">{</span></div><div class='line' id='LC57'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="n">Debug</span><span class="p">.</span><span class="n">Assert</span><span class="p">((</span><span class="n">Thread</span><span class="p">.</span><span class="n">CurrentThread</span><span class="p">.</span><span class="n">ThreadState</span> <span class="p">&amp;</span> <span class="n">ThreadState</span><span class="p">.</span><span class="n">AbortRequested</span><span class="p">)</span> <span class="p">!=</span> <span class="m">0</span><span class="p">);</span></div><div class='line' id='LC58'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="c1">// The exception ThreadAbortException is propagated when closing this catch blok</span></div><div class='line' id='LC59'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="p">}</span></div><div class='line' id='LC60'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="p">}</span></div><div class='line' id='LC61'><br/></div><div class='line' id='LC62'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="k">public</span> <span class="k">static</span> <span class="k">void</span> <span class="n">BugFreeSort</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;(</span><span class="k">this</span> <span class="n">List</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;</span> <span class="n">list</span><span class="p">,</span> <span class="kt">int</span> <span class="n">index</span><span class="p">,</span> <span class="kt">int</span> <span class="n">count</span><span class="p">,</span> <span class="n">IComparer</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;</span> <span class="n">comparer</span><span class="p">)</span> <span class="p">{</span></div><div class='line' id='LC63'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="n">Debug</span><span class="p">.</span><span class="n">Assert</span><span class="p">(</span><span class="n">list</span> <span class="p">!=</span> <span class="k">null</span><span class="p">);</span></div><div class='line' id='LC64'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="n">Debug</span><span class="p">.</span><span class="n">Assert</span><span class="p">(</span><span class="n">index</span> <span class="p">&gt;=</span> <span class="m">0</span><span class="p">);</span></div><div class='line' id='LC65'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="n">Debug</span><span class="p">.</span><span class="n">Assert</span><span class="p">(</span><span class="n">count</span> <span class="p">&gt;=</span><span class="m">0</span><span class="p">);</span></div><div class='line' id='LC66'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="n">Debug</span><span class="p">.</span><span class="n">Assert</span><span class="p">(</span><span class="n">list</span><span class="p">.</span><span class="n">Count</span> <span class="p">==</span> <span class="m">0</span> <span class="p">||</span> <span class="n">index</span><span class="p">+</span><span class="n">count</span> <span class="p">&lt;</span> <span class="n">list</span><span class="p">.</span><span class="n">Count</span><span class="p">);</span></div><div class='line' id='LC67'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="n">Debug</span><span class="p">.</span><span class="n">Assert</span><span class="p">(</span><span class="n">comparer</span> <span class="p">!=</span> <span class="k">null</span><span class="p">);</span></div><div class='line' id='LC68'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="k">try</span> <span class="p">{</span></div><div class='line' id='LC69'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="n">list</span><span class="p">.</span><span class="n">Sort</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="n">comparer</span><span class="p">);</span></div><div class='line' id='LC70'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="n">InvalidOperationException</span><span class="p">)</span> <span class="p">{</span></div><div class='line' id='LC71'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="n">Debug</span><span class="p">.</span><span class="n">Assert</span><span class="p">((</span><span class="n">Thread</span><span class="p">.</span><span class="n">CurrentThread</span><span class="p">.</span><span class="n">ThreadState</span> <span class="p">&amp;</span> <span class="n">ThreadState</span><span class="p">.</span><span class="n">AbortRequested</span><span class="p">)</span> <span class="p">!=</span> <span class="m">0</span><span class="p">);</span></div><div class='line' id='LC72'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="c1">// The exception ThreadAbortException is propagated when closing this catch blok</span></div><div class='line' id='LC73'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="p">}</span></div><div class='line' id='LC74'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="p">}</span></div><div class='line' id='LC75'>&nbsp;&nbsp;&nbsp;<span class="p">}</span></div><div class='line' id='LC76'><span class="p">}</span></div><div class='line' id='LC77'><br/></div></pre></div>
          </div>

          <div class="gist-meta">
            <a href="https://gist.github.com/raw/3819116/19fc0ebb683253b9c2e3d78876a8348e3b97d69e/gistfile1.cs" style="float:right;">view raw</a>
            <a href="https://gist.github.com/3819116#file_gistfile1.cs" style="float:right;margin-right:10px;color:#666">gistfile1.cs</a>
            <a href="https://gist.github.com/3819116">This Gist</a> brought to you by <a href="http://github.com">GitHub</a>.
          </div>
        </div>
</div>
</noscript>
<p>Here is the code rule declared in the code. Hopefully any .NET developer acquainted with the LINQ syntax, should be able to read this piece to code:</p>
<script src="http://gist.github.com/3819157.js"></script><noscript><link rel="stylesheet" href="https://gist.github.com/stylesheets/gist/embed.css"><div id="gist-3819157" class="gist">
    

        <div class="gist-file">
          <div class="gist-data gist-syntax">
              <div class="highlight"><pre><div class='line' id='LC1'><span class="c1">// &lt;Name&gt;Use List&lt;T&gt;.BugFreeSort() instead of List&lt;T&gt;.Sort()&lt;/Name&gt;</span></div><div class='line' id='LC2'><span class="n">warnif</span> <span class="n">count</span> <span class="p">&gt;</span> <span class="m">0</span></div><div class='line' id='LC3'><span class="n">let</span> <span class="n">listSortMethods</span> <span class="p">=</span> <span class="n">ThirdParty</span><span class="p">.</span><span class="n">Methods</span></div><div class='line' id='LC4'>&nbsp;&nbsp;<span class="p">.</span><span class="n">WithFullNameWildcardMatch</span><span class="p">(</span><span class="s">@&quot;System.Collections.Generic.List&lt;T&gt;.Sort*&quot;</span><span class="p">)</span></div><div class='line' id='LC5'><br/></div><div class='line' id='LC6'><span class="k">from</span> <span class="n">m</span> <span class="k">in</span> <span class="n">Application</span><span class="p">.</span><span class="n">Methods</span><span class="p">.</span><span class="n">UsingAny</span><span class="p">(</span><span class="n">listSortMethods</span><span class="p">)</span>  </div><div class='line' id='LC7'><span class="k">where</span> <span class="n">m</span><span class="p">.</span><span class="n">ParentType</span><span class="p">.</span><span class="n">FullName</span> <span class="p">!=</span> <span class="s">&quot;NDepend.Helpers.Collections.ListSortExtensionMethods&quot;</span></div><div class='line' id='LC8'><span class="k">select</span> <span class="k">new</span> <span class="p">{</span> <span class="n">m</span><span class="p">,</span> <span class="n">sortMethodCalled</span> <span class="p">=</span> <span class="n">m</span><span class="p">.</span><span class="n">MethodsCalled</span><span class="p">.</span><span class="n">Intersect</span><span class="p">(</span><span class="n">listSortMethods</span><span class="p">)</span> <span class="p">}</span></div></pre></div>
          </div>

          <div class="gist-meta">
            <a href="https://gist.github.com/raw/3819157/22e3d5c2198bce7b68ce067977fe44da20a88c7b/gistfile1.cs" style="float:right;">view raw</a>
            <a href="https://gist.github.com/3819157#file_gistfile1.cs" style="float:right;margin-right:10px;color:#666">gistfile1.cs</a>
            <a href="https://gist.github.com/3819157">This Gist</a> brought to you by <a href="http://github.com">GitHub</a>.
          </div>
        </div>
</div>
</noscript>
<p>And here is a screenshot of the NDepend methods violating the code rule <em>before</em> refactoring:</p>
<p><a href="http://codebetter.com/patricksmacchia/files/2012/10/Match.png"><img class="alignnone size-full wp-image-705" src="http://codebetter.com/patricksmacchia/files/2012/10/Match.png" alt="" width="580" height="783" /></a></p>
<p>We have almost 200 code rules declared in source code like this newly added one. They protect us from stumbling <em>again and again</em> in tricky identified scenarios. In other words with these rules we abide by the tenet: <strong>Fool me once, don&#8217;t fool me twice</strong>.</p>
<p>In a team context, doing so is especially useful since such rule is warning a developer when he&#8217;s doing something wrong. Such warning is actually a <strong>just-in-time</strong> <strong>automatic piece of education</strong> for <em>newcomers</em> developers, about how things must be done. Communication in the team is enhanced, the overall friction is decreased, and I found this pretty cool <img src='http://cdn1.codebetter.com/wp-includes/images/smilies/icon_smile.gif' alt=':)' class='wp-smiley' /> </p>
							</div><!-- .entry-content -->
	
			<div class="entry-utility">
				<span class="cat-links"><span class="entry-utility-prep entry-utility-prep-cat-links">Posted in <a href="http://codebetter.com/patricksmacchia/category/net-framework/" title="View all posts in .NET Framework" rel="category">.NET Framework</a>, <a href="http://codebetter.com/patricksmacchia/category/net-fx/" title="View all posts in .NET Fx" rel="category">.NET Fx</a>, <a href="http://codebetter.com/patricksmacchia/category/c/" title="View all posts in C#" rel="category">C#</a>, <a href="http://codebetter.com/patricksmacchia/category/code-query/" title="View all posts in Code Query" rel="category">Code Query</a>, <a href="http://codebetter.com/patricksmacchia/category/code-rule/" title="View all posts in Code Rule" rel="category">Code Rule</a>, <a href="http://codebetter.com/patricksmacchia/category/cqlinq/" title="View all posts in CQLinq" rel="category">CQLinq</a></span></span>
				<span class="meta-sep"> | </span>
												<span class="comments-link"><a href="http://codebetter.com/patricksmacchia/2012/10/02/beware-mixing-list-sort-and-thread-abort/#comments" title="Comment on Beware mixing List.Sort() and Thread.Abort()"><span class="dsq-postid" rel="702 http://codebetter.com/patricksmacchia/?p=702">6 Comments</span></a></span>
							</div><!-- #entry-utility -->
		</div><!-- #post-702 -->

		
						
			<div id="post-689" class="post-689 post type-post status-publish format-standard hentry category-net-framework category-api-usage category-breaking-changes category-code-rule">
			<h2 class="entry-title"><a href="http://codebetter.com/patricksmacchia/2012/08/06/the-consequence-of-a-net-framework-api-design-flaw/" title="Permalink to The consequence of a.NET Framework API design flaw" rel="bookmark">The consequence of a.NET Framework API design flaw</a></h2>

			<div class="entry-meta">
				<span class="meta-prep meta-prep-author">Posted on </span><a href="http://codebetter.com/patricksmacchia/2012/08/06/the-consequence-of-a-net-framework-api-design-flaw/" title="12:41 pm" rel="bookmark"><span class="entry-date">August 6, 2012</span></a> <span class="meta-sep"> by </span> <span class="author vcard"><a class="url fn n" href="http://codebetter.com/patricksmacchia" title="View all posts by Patrick Smacchia">Patrick Smacchia</a></span>			</div><!-- .entry-meta -->

				<div class="entry-content">
				<p>Last week, a user reported a bug on NDepend (hopefully it happens in a very rare situation!). After mulling over a bit on the bug stack trace, it appears that the bug is the consequence of a call to <a href="http://msdn.microsoft.com/en-us/library/63ywd54z.aspx" target="_blank">ICollection&lt;T&gt;.Add()</a> while the underlying collection is an array!</p>
<p>Here I felt bad, because really the bug is a consequence of a .NET Framework API design flaw. Or better said, to take our responsibility, the bug is the consequence of us, not providing a work around seriously enough on this  .NET Framework API design flaw. <strong>Why the hell some read-only collection implements the Add() method?</strong> It is even getting worse if considering the documentation of <em><a href="http://msdn.microsoft.com/en-US/library/system.array.system.collections.ilist.add(v=vs.80)" target="_blank">Array.Add()</a></em> (as a <em>IList&lt;T&gt;</em> explicit implementation method) and <a href="http://msdn.microsoft.com/en-en/library/cc672239.aspx" target="_blank">ReadOnlyCollection.ICollection&lt;T&gt;.Add()</a>.</p>
<p style="text-align: center"><em> <strong>This implementation always throws <a href="http://msdn.microsoft.com/en-us/library/system.notsupportedexception">NotSupportedException</a></strong>. </em>OUCH!</p>
<p>It appears that finally, a decade after .NET 1.0 has been release, 3 interfaces <a href="http://msdn.microsoft.com/en-us/library/ee537802.aspx" target="_blank">IReadOnlyCollection&lt;T&gt;</a>, <a href="http://msdn.microsoft.com/en-us/library/hh192385(v=vs.110).aspx" target="_blank">IReadOnlyList&lt;T&gt;</a>, <a href="http://msdn.microsoft.com/en-us/library/hh136548(v=vs.110).aspx" target="_blank">IReadOnlyDictionary&lt;T&gt;</a> will be presented by the .NET v4.5. As commonly said, <em>it is never too late to do things right</em>, but in the case of an API with ascendant compatibility used by millions of developers world-wide, this proverb doesn&#8217;t fit that well.</p>
<p>The fact is that the brand new <a href="http://www.ndepend.com/API/webframe.html" target="_blank">NDepend.API</a> actually uses the interface <em>ICollection&lt;T&gt;</em> to return read-only lists. I wouldn&#8217;t like us or some users stumble on this API design flaw again! Hence a decision was taken to change the API policy, even though this will introduce breaking-change (the API is still young enough for that). First, I wrote the following CQLinq query to evaluate the problem:</p>
<script src="http://gist.github.com/3247870.js"></script><noscript><link rel="stylesheet" href="https://gist.github.com/stylesheets/gist/embed.css"><div id="gist-3247870" class="gist">
    

        <div class="gist-file">
          <div class="gist-data gist-syntax">
              <div class="highlight"><pre><div class='line' id='LC1'><span class="n">let</span> <span class="n">seqTypes</span> <span class="p">=</span> <span class="n">Types</span><span class="p">.</span><span class="n">Where</span><span class="p">(</span></div><div class='line' id='LC2'>&nbsp;&nbsp;<span class="n">t</span> <span class="p">=&gt;</span> <span class="n">t</span><span class="p">.</span><span class="n">Implement</span><span class="p">(</span><span class="s">&quot;System.Collections.Generic.IEnumerable&lt;T&gt;&quot;</span><span class="p">)</span> <span class="p">&amp;&amp;</span></div><div class='line' id='LC3'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="n">t</span><span class="p">.</span><span class="n">Name</span> <span class="p">!=</span> <span class="s">&quot;String&quot;</span> <span class="c1">// We don&#39;t string as collection!</span></div><div class='line' id='LC4'><span class="p">).</span><span class="n">ToHashSet</span><span class="p">()</span></div><div class='line' id='LC5'><br/></div><div class='line' id='LC6'><span class="k">from</span> <span class="n">m</span> <span class="k">in</span> <span class="n">Assemblies</span><span class="p">.</span><span class="n">WithNameIn</span><span class="p">(</span> <span class="s">&quot;NDepend.API&quot;</span><span class="p">).</span><span class="n">ChildMethods</span><span class="p">()</span></div><div class='line' id='LC7'><span class="k">where</span> <span class="n">m</span><span class="p">.</span><span class="n">IsPubliclyVisible</span> <span class="p">&amp;&amp;</span></div><div class='line' id='LC8'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="n">m</span><span class="p">.</span><span class="n">ReturnType</span> <span class="p">!=</span> <span class="k">null</span> <span class="p">&amp;&amp;</span></div><div class='line' id='LC9'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="n">seqTypes</span><span class="p">.</span><span class="n">Contains</span><span class="p">(</span><span class="n">m</span><span class="p">.</span><span class="n">ReturnType</span><span class="p">)</span></div><div class='line' id='LC10'><span class="k">select</span> <span class="k">new</span> <span class="p">{</span> <span class="n">m</span><span class="p">,</span> <span class="n">m</span><span class="p">.</span><span class="n">ReturnType</span> <span class="p">}</span></div></pre></div>
          </div>

          <div class="gist-meta">
            <a href="https://gist.github.com/raw/3247870/8bdf5bc0d8bd07100fd4272777cb586eace7417b/gistfile1.cs" style="float:right;">view raw</a>
            <a href="https://gist.github.com/3247870#file_gistfile1.cs" style="float:right;margin-right:10px;color:#666">gistfile1.cs</a>
            <a href="https://gist.github.com/3247870">This Gist</a> brought to you by <a href="http://github.com">GitHub</a>.
          </div>
        </div>
</div>
</noscript>
<p>Here is the result, 40 methods (or property getters) returns something that implement <em>IEnumerable&lt;T&gt;</em> and many of them returns a <em>ICollection&lt;T&gt;</em>.</p>
<p><a href="http://codebetter.com/patricksmacchia/files/2012/08/Query1.png"><img src="http://codebetter.com/patricksmacchia/files/2012/08/Query1.png" alt="" width="557" height="991" /></a></p>
<p>So what the API should return instead of <em>ICollection&lt;T&gt;?</em> Knowing that NDepend is still compatible with VS2008 and hence is compiled with .NET 3.5, it cannot use the brand new .NET v4.5 <em>IReadOnlyList&lt;T&gt; </em>(but it will certainly use these in several years, when we will compile against .NET v4.5 and above).</p>
<ul>
<li>Returning arrays instead of <em>ICollection&lt;T&gt;</em> could be an idea. The problem is that array is an implementation, and it is not read-only since the user can update each slot of the array.</li>
<li>I never really liked the class <em>ReadOnlyCollection&lt;T&gt;</em> that wraps a <em>IList&lt;T&gt;</em>. First it is a class and not an interface. Second it has the property getter <em>Items</em> that can returns the wrapped <em>IList&lt;T&gt;</em>, so it is not that read-only and not a good wrapper at all! Third it implements <em>IList&lt;T&gt;</em>, and all mutable members are not supported, so it can lead to the same kind of confusion we are now faced with.</li>
<li>Returning some <em>IEnumerable&lt;T&gt;</em> would be a better choice than the two above. It is not ideal through. While <em>IEnumerable&lt;T&gt;</em> conveys well the read-only idea, it has no <em>Count</em> nor an item access by index property. Hence it is not really suited to return a well-sized list. LINQ provides the adequate extension methods <em>Count()</em> and <em>ElementAt()</em>, but  <em>IEnumerable&lt;T&gt; </em>has a strong taste of <strong>sequence</strong>, while we&#8217;d really like to provide users with proper <strong>lists</strong>!</li>
</ul>
<div>
<p>So we choose to provide our own interfaces <em>IReadOnlyCollection&lt;T&gt;</em> and <em>IReadOnlyList&lt;T&gt;</em>! Same as the ones released soon in .NET v4.5, but defined in another namespace <em>NDepend.Helpers</em>, this will discard most naming collisions for clients. Thanks to this choice, the API is as clean as possible for now, and the transition will be simplified once NDepend will be compiled for .NET v4.5 and above, sooner or later.</p>
<p>As more and more often, I found inspiration in a <em>stackoverflow.com</em> response <a href="http://stackoverflow.com/a/343506/27194" target="_blank">here</a>. Find below the whole interfaces declarations and implementations. This is not an ideal solution, since <em>List&lt;T&gt;</em> and <em>Array</em> of course doesn&#8217;t implement our interfaces, but I found it to be a good design compromise.</p>
<p>Notice the four factory extension methods, that make a clear distinction at creation time, between <strong>Wrapped</strong> and <strong>Cloned </strong>read-only collection. Notice as well that the <em>Cloned</em> factories, take any sequence as argument, while the <em>Wrapped</em> factories, need collections and lists as argument:</p>
<ul>
<li><em>ToReadOnlyWrappedCollection(this ICollection&lt;T&gt;), </em></li>
<li><em>ToReadOnlyClonedCollection(this IEnumerable&lt;T&gt;),</em></li>
<li><em>ToReadOnlyWrappedList(this IList&lt;T&gt;), </em></li>
<li><em>ToReadOnlyClonedList(this IEnumerable&lt;T&gt;),</em></li>
</ul>
</div>
<p>Also, we&#8217;ve added the <em>IndexOf()</em> extension method over our two interfaces, because we needed it, and because the .NET Framework doesn&#8217;t provide <em>IndexOf(this IEnumerable&lt;T&gt;) </em>because a sequence is not necessarily ordered (like <em>hashset</em> or <em>dictionary</em>).</p>
<script src="http://gist.github.com/3247559.js"></script><noscript><link rel="stylesheet" href="https://gist.github.com/stylesheets/gist/embed.css"><div id="gist-3247559" class="gist">
    

        <div class="gist-file">
          <div class="gist-data gist-syntax">
              <div class="highlight"><pre><div class='line' id='LC1'>&nbsp;&nbsp;<span class="c1">///&lt;summary&gt;</span></div><div class='line' id='LC2'>&nbsp;&nbsp;&nbsp;<span class="c1">///Defines the property getter Count that defines a read-only collections.</span></div><div class='line' id='LC3'>&nbsp;&nbsp;&nbsp;<span class="c1">///&lt;/summary&gt;</span></div><div class='line' id='LC4'>&nbsp;&nbsp;&nbsp;<span class="c1">///&lt;remarks&gt;A &lt;see cref=&quot;IReadOnlyCollection{T}&quot;/&gt; object can be obtain through the extension methods &lt;see cref=&quot;ExtensionMethodsEnumerable.ToReadOnlyWrappedCollection{T}&quot;/&gt; or  &lt;see cref=&quot;ExtensionMethodsEnumerable.ToReadOnlyClonedCollection{T}&quot;/&gt;.&lt;/remarks&gt;</span></div><div class='line' id='LC5'>&nbsp;&nbsp;&nbsp;<span class="c1">///&lt;typeparam name=&quot;T&quot;&gt;The type parameter of the items in the collection.&lt;/typeparam&gt;</span></div><div class='line' id='LC6'>&nbsp;&nbsp;&nbsp;<span class="k">public</span> <span class="k">interface</span> <span class="n">IReadOnlyCollection</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;</span> <span class="p">:</span> <span class="n">IEnumerable</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;</span> <span class="p">{</span></div><div class='line' id='LC7'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="c1">///&lt;summary&gt;</span></div><div class='line' id='LC8'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="c1">///Gets the number of elements contained in the collection.</span></div><div class='line' id='LC9'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="c1">///&lt;/summary&gt;</span></div><div class='line' id='LC10'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kt">int</span> <span class="n">Count</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="p">}</span></div><div class='line' id='LC11'>&nbsp;&nbsp;&nbsp;<span class="p">}</span></div><div class='line' id='LC12'><br/></div><div class='line' id='LC13'><br/></div><div class='line' id='LC14'>&nbsp;&nbsp;&nbsp;<span class="c1">///&lt;summary&gt;</span></div><div class='line' id='LC15'>&nbsp;&nbsp;&nbsp;<span class="c1">///Represents a read-only collection of elements that can be accessed by index.</span></div><div class='line' id='LC16'>&nbsp;&nbsp;&nbsp;<span class="c1">///&lt;/summary&gt;</span></div><div class='line' id='LC17'>&nbsp;&nbsp;&nbsp;<span class="c1">///&lt;remarks&gt;A &lt;see cref=&quot;IReadOnlyList{T}&quot;/&gt; object can be obtain through the extension methods &lt;see cref=&quot;ExtensionMethodsEnumerable.ToReadOnlyWrappedList{T}&quot;/&gt; or  &lt;see cref=&quot;ExtensionMethodsEnumerable.ToReadOnlyClonedList{T}&quot;/&gt;.&lt;/remarks&gt;</span></div><div class='line' id='LC18'>&nbsp;&nbsp;&nbsp;<span class="c1">///&lt;typeparam name=&quot;T&quot;&gt;The type parameter of the items in the collection.&lt;/typeparam&gt;</span></div><div class='line' id='LC19'>&nbsp;&nbsp;&nbsp;<span class="k">public</span> <span class="k">interface</span> <span class="n">IReadOnlyList</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;</span> <span class="p">:</span> <span class="n">IReadOnlyCollection</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;</span> <span class="p">{</span></div><div class='line' id='LC20'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="c1">///&lt;summary&gt;</span></div><div class='line' id='LC21'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="c1">///Gets the element at the specified index in the read-only list.</span></div><div class='line' id='LC22'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="c1">///&lt;/summary&gt;</span></div><div class='line' id='LC23'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="c1">///&lt;param name=&quot;index&quot;&gt;The zero-based index of the element to get.&lt;/param&gt;</span></div><div class='line' id='LC24'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="n">T</span> <span class="k">this</span><span class="p">[</span><span class="kt">int</span> <span class="n">index</span><span class="p">]</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="p">}</span></div><div class='line' id='LC25'>&nbsp;&nbsp;&nbsp;<span class="p">}</span></div><div class='line' id='LC26'><br/></div><div class='line' id='LC27'><br/></div><div class='line' id='LC28'><br/></div><div class='line' id='LC29'>&nbsp;&nbsp;&nbsp;<span class="k">public</span> <span class="k">static</span> <span class="k">class</span> <span class="nc">ExtensionMethodsEnumerable</span> <span class="p">{</span></div><div class='line' id='LC30'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="c1">/// &lt;summary&gt;</span></div><div class='line' id='LC31'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="c1">/// Creates a &lt;see cref=&quot;IReadOnlyCollection{T}&quot;/&gt; wrapper collection around &lt;paramref name=&quot;collection&quot;/&gt;. </span></div><div class='line' id='LC32'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="c1">/// &lt;/summary&gt;</span></div><div class='line' id='LC33'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="c1">/// &lt;typeparam name=&quot;T&quot;&gt;The type parameter of the items in the collection.&lt;/typeparam&gt;</span></div><div class='line' id='LC34'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="c1">/// &lt;param name=&quot;collection&quot;&gt;A collection object.&lt;/param&gt;</span></div><div class='line' id='LC35'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="k">public</span> <span class="k">static</span> <span class="n">IReadOnlyCollection</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;</span> <span class="n">ToReadOnlyWrappedCollection</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;(</span><span class="k">this</span> <span class="n">ICollection</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;</span> <span class="n">collection</span><span class="p">)</span> <span class="p">{</span></div><div class='line' id='LC36'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="n">Contract</span><span class="p">.</span><span class="n">Requires</span><span class="p">(</span><span class="n">collection</span> <span class="p">!=</span> <span class="k">null</span><span class="p">,</span> <span class="s">&quot;collection must not be null&quot;</span><span class="p">);</span></div><div class='line' id='LC37'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="n">Contract</span><span class="p">.</span><span class="n">Ensures</span><span class="p">(</span><span class="n">Contract</span><span class="p">.</span><span class="n">Result</span><span class="p">&lt;</span><span class="n">IReadOnlyCollection</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;&gt;()</span> <span class="p">!=</span> <span class="k">null</span><span class="p">,</span> <span class="s">&quot;returned read-only collection is not null&quot;</span><span class="p">);</span></div><div class='line' id='LC38'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="n">Contract</span><span class="p">.</span><span class="n">Ensures</span><span class="p">(</span><span class="n">Contract</span><span class="p">.</span><span class="n">Result</span><span class="p">&lt;</span><span class="n">IReadOnlyCollection</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;&gt;().</span><span class="n">Count</span> <span class="p">==</span> <span class="n">collection</span><span class="p">.</span><span class="n">Count</span><span class="p">,</span> <span class="s">&quot;returned read-only collection has the same number of elements as collection&quot;</span><span class="p">);</span></div><div class='line' id='LC39'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="k">return</span> <span class="k">new</span> <span class="n">CollectionReadOnlyWrapper</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;(</span><span class="n">collection</span><span class="p">);</span></div><div class='line' id='LC40'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="p">}</span></div><div class='line' id='LC41'><br/></div><div class='line' id='LC42'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="c1">/// &lt;summary&gt;</span></div><div class='line' id='LC43'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="c1">/// Creates a &lt;see cref=&quot;IReadOnlyCollection{T}&quot;/&gt; cloned collection around &lt;paramref name=&quot;collection&quot;/&gt;. </span></div><div class='line' id='LC44'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="c1">/// &lt;/summary&gt;</span></div><div class='line' id='LC45'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="c1">/// &lt;typeparam name=&quot;T&quot;&gt;The type parameter of the items in the collection.&lt;/typeparam&gt;</span></div><div class='line' id='LC46'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="c1">/// &lt;param name=&quot;collection&quot;&gt;A collection object.&lt;/param&gt;</span></div><div class='line' id='LC47'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="k">public</span> <span class="k">static</span> <span class="n">IReadOnlyCollection</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;</span> <span class="n">ToReadOnlyClonedCollection</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;(</span><span class="k">this</span> <span class="n">IEnumerable</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;</span> <span class="n">collection</span><span class="p">)</span> <span class="p">{</span></div><div class='line' id='LC48'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="n">Contract</span><span class="p">.</span><span class="n">Requires</span><span class="p">(</span><span class="n">collection</span> <span class="p">!=</span> <span class="k">null</span><span class="p">,</span> <span class="s">&quot;collection must not be null&quot;</span><span class="p">);</span></div><div class='line' id='LC49'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="n">Contract</span><span class="p">.</span><span class="n">Ensures</span><span class="p">(</span><span class="n">Contract</span><span class="p">.</span><span class="n">Result</span><span class="p">&lt;</span><span class="n">IReadOnlyCollection</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;&gt;()</span> <span class="p">!=</span> <span class="k">null</span><span class="p">,</span> <span class="s">&quot;returned read-only collection is not null&quot;</span><span class="p">);</span></div><div class='line' id='LC50'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="n">Contract</span><span class="p">.</span><span class="n">Ensures</span><span class="p">(</span><span class="n">Contract</span><span class="p">.</span><span class="n">Result</span><span class="p">&lt;</span><span class="n">IReadOnlyCollection</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;&gt;().</span><span class="n">Count</span> <span class="p">==</span> <span class="n">collection</span><span class="p">.</span><span class="n">Count</span><span class="p">(),</span> <span class="s">&quot;returned read-only collection has the same number of elements as collection&quot;</span><span class="p">);</span></div><div class='line' id='LC51'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="k">return</span> <span class="k">new</span> <span class="n">CollectionReadOnlyWrapper</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;(</span><span class="n">collection</span><span class="p">.</span><span class="n">ToArray</span><span class="p">());</span></div><div class='line' id='LC52'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="p">}</span></div><div class='line' id='LC53'><br/></div><div class='line' id='LC54'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="c1">/// &lt;summary&gt;</span></div><div class='line' id='LC55'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="c1">/// Creates a &lt;see cref=&quot;IReadOnlyCollection{T}&quot;/&gt; wrapper collection around &lt;paramref name=&quot;list&quot;/&gt;. </span></div><div class='line' id='LC56'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="c1">/// &lt;/summary&gt;</span></div><div class='line' id='LC57'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="c1">/// &lt;typeparam name=&quot;T&quot;&gt;The type parameter of the items in the list.&lt;/typeparam&gt;</span></div><div class='line' id='LC58'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="c1">/// &lt;param name=&quot;list&quot;&gt;A list object.&lt;/param&gt;</span></div><div class='line' id='LC59'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="k">public</span> <span class="k">static</span> <span class="n">IReadOnlyList</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;</span> <span class="n">ToReadOnlyWrappedList</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;(</span><span class="k">this</span> <span class="n">IList</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span></div><div class='line' id='LC60'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="n">Contract</span><span class="p">.</span><span class="n">Requires</span><span class="p">(</span><span class="n">list</span> <span class="p">!=</span> <span class="k">null</span><span class="p">,</span> <span class="s">&quot;collection must not be null&quot;</span><span class="p">);</span></div><div class='line' id='LC61'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="n">Contract</span><span class="p">.</span><span class="n">Ensures</span><span class="p">(</span><span class="n">Contract</span><span class="p">.</span><span class="n">Result</span><span class="p">&lt;</span><span class="n">IReadOnlyList</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;&gt;()</span> <span class="p">!=</span> <span class="k">null</span><span class="p">,</span> <span class="s">&quot;returned read-only list is not null&quot;</span><span class="p">);</span></div><div class='line' id='LC62'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="n">Contract</span><span class="p">.</span><span class="n">Ensures</span><span class="p">(</span><span class="n">Contract</span><span class="p">.</span><span class="n">Result</span><span class="p">&lt;</span><span class="n">IReadOnlyList</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;&gt;().</span><span class="n">Count</span> <span class="p">==</span> <span class="n">list</span><span class="p">.</span><span class="n">Count</span><span class="p">,</span> <span class="s">&quot;returned read-only list has the same number of elements as list&quot;</span><span class="p">);</span></div><div class='line' id='LC63'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="k">return</span> <span class="k">new</span> <span class="n">ListReadOnlyWrapper</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;(</span><span class="n">list</span><span class="p">);</span></div><div class='line' id='LC64'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="p">}</span></div><div class='line' id='LC65'><br/></div><div class='line' id='LC66'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="c1">/// &lt;summary&gt;</span></div><div class='line' id='LC67'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="c1">/// Creates a &lt;see cref=&quot;IReadOnlyCollection{T}&quot;/&gt; cloned collection around &lt;paramref name=&quot;list&quot;/&gt;. </span></div><div class='line' id='LC68'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="c1">/// &lt;/summary&gt;</span></div><div class='line' id='LC69'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="c1">/// &lt;typeparam name=&quot;T&quot;&gt;The type parameter of the items in the list.&lt;/typeparam&gt;</span></div><div class='line' id='LC70'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="c1">/// &lt;param name=&quot;list&quot;&gt;A list object.&lt;/param&gt;</span></div><div class='line' id='LC71'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="k">public</span> <span class="k">static</span> <span class="n">IReadOnlyList</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;</span> <span class="n">ToReadOnlyClonedList</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;(</span><span class="k">this</span> <span class="n">IEnumerable</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span></div><div class='line' id='LC72'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="n">Contract</span><span class="p">.</span><span class="n">Requires</span><span class="p">(</span><span class="n">list</span> <span class="p">!=</span> <span class="k">null</span><span class="p">,</span> <span class="s">&quot;collection must not be null&quot;</span><span class="p">);</span></div><div class='line' id='LC73'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="n">Contract</span><span class="p">.</span><span class="n">Ensures</span><span class="p">(</span><span class="n">Contract</span><span class="p">.</span><span class="n">Result</span><span class="p">&lt;</span><span class="n">IReadOnlyList</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;&gt;()</span> <span class="p">!=</span> <span class="k">null</span><span class="p">,</span> <span class="s">&quot;returned read-only list is not null&quot;</span><span class="p">);</span></div><div class='line' id='LC74'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="n">Contract</span><span class="p">.</span><span class="n">Ensures</span><span class="p">(</span><span class="n">Contract</span><span class="p">.</span><span class="n">Result</span><span class="p">&lt;</span><span class="n">IReadOnlyList</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;&gt;().</span><span class="n">Count</span> <span class="p">==</span> <span class="n">list</span><span class="p">.</span><span class="n">Count</span><span class="p">(),</span> <span class="s">&quot;returned read-only list has the same number of elements as list&quot;</span><span class="p">);</span></div><div class='line' id='LC75'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="k">return</span> <span class="k">new</span> <span class="n">ListReadOnlyWrapper</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;(</span><span class="n">list</span><span class="p">.</span><span class="n">ToArray</span><span class="p">());</span></div><div class='line' id='LC76'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="p">}</span></div><div class='line' id='LC77'><br/></div><div class='line' id='LC78'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="k">private</span> <span class="k">class</span> <span class="nc">CollectionReadOnlyWrapper</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;</span> <span class="p">:</span> <span class="n">IReadOnlyCollection</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;</span> <span class="p">{</span></div><div class='line' id='LC79'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="k">internal</span> <span class="nf">CollectionReadOnlyWrapper</span><span class="p">(</span><span class="n">ICollection</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;</span> <span class="n">collection</span><span class="p">)</span> <span class="p">{</span></div><div class='line' id='LC80'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="n">Debug</span><span class="p">.</span><span class="n">Assert</span><span class="p">(</span><span class="n">collection</span> <span class="p">!=</span> <span class="k">null</span><span class="p">);</span></div><div class='line' id='LC81'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="n">m_Collection</span> <span class="p">=</span> <span class="n">collection</span><span class="p">;</span></div><div class='line' id='LC82'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="p">}</span></div><div class='line' id='LC83'><br/></div><div class='line' id='LC84'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="k">readonly</span> <span class="n">ICollection</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;</span> <span class="n">m_Collection</span><span class="p">;</span></div><div class='line' id='LC85'><br/></div><div class='line' id='LC86'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="k">public</span> <span class="kt">int</span> <span class="n">Count</span> <span class="p">{</span></div><div class='line' id='LC87'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="k">get</span> <span class="p">{</span> <span class="k">return</span> <span class="n">m_Collection</span><span class="p">.</span><span class="n">Count</span><span class="p">;</span> <span class="p">}</span></div><div class='line' id='LC88'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="p">}</span></div><div class='line' id='LC89'><br/></div><div class='line' id='LC90'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="k">public</span> <span class="n">IEnumerator</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;</span> <span class="n">GetEnumerator</span><span class="p">()</span> <span class="p">{</span></div><div class='line' id='LC91'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="k">return</span> <span class="n">m_Collection</span><span class="p">.</span><span class="n">GetEnumerator</span><span class="p">();</span></div><div class='line' id='LC92'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="p">}</span></div><div class='line' id='LC93'><br/></div><div class='line' id='LC94'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="n">IEnumerator</span> <span class="n">IEnumerable</span><span class="p">.</span><span class="n">GetEnumerator</span><span class="p">()</span> <span class="p">{</span></div><div class='line' id='LC95'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="k">return</span> <span class="p">((</span><span class="n">IEnumerable</span><span class="p">)</span><span class="n">m_Collection</span><span class="p">).</span><span class="n">GetEnumerator</span><span class="p">();</span></div><div class='line' id='LC96'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="p">}</span></div><div class='line' id='LC97'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="p">}</span></div><div class='line' id='LC98'><br/></div><div class='line' id='LC99'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="k">private</span> <span class="k">class</span> <span class="nc">ListReadOnlyWrapper</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;</span> <span class="p">:</span> <span class="n">CollectionReadOnlyWrapper</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;,</span> <span class="n">IReadOnlyList</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;</span> <span class="p">{</span></div><div class='line' id='LC100'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="k">internal</span> <span class="nf">ListReadOnlyWrapper</span><span class="p">(</span><span class="n">IList</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;</span> <span class="n">list</span><span class="p">)</span> <span class="p">:</span> <span class="k">base</span><span class="p">(</span><span class="n">list</span><span class="p">)</span> <span class="p">{</span></div><div class='line' id='LC101'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="n">Debug</span><span class="p">.</span><span class="n">Assert</span><span class="p">(</span><span class="n">list</span> <span class="p">!=</span> <span class="k">null</span><span class="p">);</span></div><div class='line' id='LC102'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="n">m_List</span> <span class="p">=</span> <span class="n">list</span><span class="p">;</span></div><div class='line' id='LC103'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="p">}</span></div><div class='line' id='LC104'><br/></div><div class='line' id='LC105'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="k">private</span> <span class="k">readonly</span> <span class="n">IList</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;</span> <span class="n">m_List</span><span class="p">;</span></div><div class='line' id='LC106'><br/></div><div class='line' id='LC107'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="k">public</span> <span class="n">T</span> <span class="k">this</span><span class="p">[</span><span class="kt">int</span> <span class="n">index</span><span class="p">]</span> <span class="p">{</span></div><div class='line' id='LC108'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="k">get</span> <span class="p">{</span> <span class="k">return</span> <span class="n">m_List</span><span class="p">[</span><span class="n">index</span><span class="p">];</span> <span class="p">}</span></div><div class='line' id='LC109'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="p">}</span></div><div class='line' id='LC110'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="p">}</span></div><div class='line' id='LC111'><br/></div><div class='line' id='LC112'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="c1">///&lt;summary&gt;</span></div><div class='line' id='LC113'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="c1">///Determines the index of a specific item in &lt;paramref name=&quot;readOnlyList&quot;/&gt;.</span></div><div class='line' id='LC114'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="c1">///&lt;/summary&gt;</span></div><div class='line' id='LC115'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="c1">///&lt;typeparam name=&quot;T&quot;&gt;The type parameter of the items in the read-only list.&lt;/typeparam&gt;</span></div><div class='line' id='LC116'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="c1">///&lt;param name=&quot;readOnlyList&quot;&gt;&lt;/param&gt;</span></div><div class='line' id='LC117'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="c1">///&lt;param name=&quot;value&quot;&gt;The object to locate in &lt;paramref name=&quot;readOnlyList&quot;/&gt;.&lt;/param&gt;</span></div><div class='line' id='LC118'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="c1">///&lt;returns&gt;The index of value if found in the list; otherwise, -1.&lt;/returns&gt;</span></div><div class='line' id='LC119'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="c1">///&lt;remarks&gt;This method uses the EqualityComparer$lt;T&amp;gt;.Default.Equals() method on &lt;paramref name=&quot;value&quot;/&gt; to determine whether item exists&lt;/remarks&gt;</span></div><div class='line' id='LC120'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="k">public</span> <span class="k">static</span> <span class="kt">int</span> <span class="n">IndexOf</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;(</span><span class="k">this</span> <span class="n">IReadOnlyList</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;</span> <span class="n">readOnlyList</span><span class="p">,</span> <span class="n">T</span> <span class="k">value</span><span class="p">)</span> <span class="p">{</span></div><div class='line' id='LC121'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="n">Contract</span><span class="p">.</span><span class="n">Requires</span><span class="p">(</span><span class="n">readOnlyList</span> <span class="p">!=</span> <span class="k">null</span><span class="p">,</span> <span class="s">&quot;readOnlyList must not be null&quot;</span><span class="p">);</span></div><div class='line' id='LC122'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kt">var</span> <span class="n">count</span> <span class="p">=</span> <span class="n">readOnlyList</span><span class="p">.</span><span class="n">Count</span><span class="p">;</span></div><div class='line' id='LC123'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kt">var</span> <span class="n">equalityComparer</span> <span class="p">=</span> <span class="n">EqualityComparer</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;.</span><span class="n">Default</span><span class="p">;</span></div><div class='line' id='LC124'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="k">for</span><span class="p">(</span><span class="kt">var</span> <span class="n">i</span> <span class="p">=</span><span class="m">0</span><span class="p">;</span> <span class="n">i</span><span class="p">&lt;</span> <span class="n">count</span><span class="p">;</span> <span class="n">i</span><span class="p">++)</span> <span class="p">{</span></div><div class='line' id='LC125'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kt">var</span> <span class="n">current</span> <span class="p">=</span> <span class="n">readOnlyList</span><span class="p">[</span><span class="n">i</span><span class="p">];</span></div><div class='line' id='LC126'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="k">if</span> <span class="p">(</span><span class="n">equalityComparer</span><span class="p">.</span><span class="n">Equals</span><span class="p">(</span><span class="n">current</span><span class="p">,</span> <span class="k">value</span><span class="p">))</span> <span class="p">{</span> <span class="k">return</span> <span class="n">i</span><span class="p">;</span> <span class="p">}</span></div><div class='line' id='LC127'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="p">}</span></div><div class='line' id='LC128'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="k">return</span><span class="p">-</span> <span class="m">1</span><span class="p">;</span></div><div class='line' id='LC129'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="p">}</span></div><div class='line' id='LC130'>&nbsp;&nbsp;&nbsp;<span class="p">}</span></div><div class='line' id='LC131'><br/></div><div class='line' id='LC132'><br/></div><div class='line' id='LC133'><br/></div><div class='line' id='LC134'><br/></div><div class='line' id='LC135'><br/></div><div class='line' id='LC136'><span class="na">   [TestFixture]</span></div><div class='line' id='LC137'>&nbsp;&nbsp;&nbsp;<span class="k">public</span> <span class="k">class</span> <span class="nc">Test_ReadOnlyCollectionList</span> <span class="p">{</span></div><div class='line' id='LC138'><br/></div><div class='line' id='LC139'><span class="na">      [Test]</span></div><div class='line' id='LC140'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="k">public</span> <span class="k">void</span> <span class="nf">Test_ReadOnlyCollection</span><span class="p">()</span> <span class="p">{</span></div><div class='line' id='LC141'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kt">var</span> <span class="n">collection</span> <span class="p">=</span> <span class="k">new</span> <span class="n">List</span><span class="p">&lt;</span><span class="kt">int</span><span class="p">&gt;</span> <span class="p">{</span> <span class="m">11</span><span class="p">,</span> <span class="m">21</span> <span class="p">};</span></div><div class='line' id='LC142'><br/></div><div class='line' id='LC143'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kt">var</span> <span class="n">wrappedCollection</span> <span class="p">=</span> <span class="n">collection</span><span class="p">.</span><span class="n">ToReadOnlyWrappedCollection</span><span class="p">();</span></div><div class='line' id='LC144'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="n">Assert</span><span class="p">.</span><span class="n">IsTrue</span><span class="p">(</span><span class="n">wrappedCollection</span><span class="p">.</span><span class="n">Count</span> <span class="p">==</span> <span class="m">2</span><span class="p">);</span></div><div class='line' id='LC145'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="n">Assert</span><span class="p">.</span><span class="n">IsTrue</span><span class="p">(</span><span class="n">wrappedCollection</span><span class="p">.</span><span class="n">ElementAt</span><span class="p">(</span><span class="m">0</span><span class="p">)</span> <span class="p">==</span> <span class="m">11</span><span class="p">);</span></div><div class='line' id='LC146'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="n">Assert</span><span class="p">.</span><span class="n">IsTrue</span><span class="p">(</span><span class="n">wrappedCollection</span><span class="p">.</span><span class="n">ElementAt</span><span class="p">(</span><span class="m">1</span><span class="p">)</span> <span class="p">==</span> <span class="m">21</span><span class="p">);</span></div><div class='line' id='LC147'><br/></div><div class='line' id='LC148'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kt">var</span> <span class="n">clonedCollection</span> <span class="p">=</span> <span class="n">collection</span><span class="p">.</span><span class="n">ToReadOnlyClonedCollection</span><span class="p">();</span></div><div class='line' id='LC149'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="n">Assert</span><span class="p">.</span><span class="n">IsTrue</span><span class="p">(</span><span class="n">clonedCollection</span><span class="p">.</span><span class="n">Count</span> <span class="p">==</span> <span class="m">2</span><span class="p">);</span></div><div class='line' id='LC150'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="n">Assert</span><span class="p">.</span><span class="n">IsTrue</span><span class="p">(</span><span class="n">clonedCollection</span><span class="p">.</span><span class="n">ElementAt</span><span class="p">(</span><span class="m">0</span><span class="p">)</span> <span class="p">==</span> <span class="m">11</span><span class="p">);</span></div><div class='line' id='LC151'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="n">Assert</span><span class="p">.</span><span class="n">IsTrue</span><span class="p">(</span><span class="n">clonedCollection</span><span class="p">.</span><span class="n">ElementAt</span><span class="p">(</span><span class="m">1</span><span class="p">)</span> <span class="p">==</span> <span class="m">21</span><span class="p">);</span></div><div class='line' id='LC152'><br/></div><div class='line' id='LC153'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="c1">// Test Cloned/Wrapped</span></div><div class='line' id='LC154'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="n">collection</span><span class="p">.</span><span class="n">Add</span><span class="p">(</span><span class="m">31</span><span class="p">);</span></div><div class='line' id='LC155'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="n">Assert</span><span class="p">.</span><span class="n">IsTrue</span><span class="p">(</span><span class="n">wrappedCollection</span><span class="p">.</span><span class="n">Count</span> <span class="p">==</span> <span class="m">3</span><span class="p">);</span></div><div class='line' id='LC156'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="n">Assert</span><span class="p">.</span><span class="n">IsTrue</span><span class="p">(</span><span class="n">wrappedCollection</span><span class="p">.</span><span class="n">ElementAt</span><span class="p">(</span><span class="m">2</span><span class="p">)</span> <span class="p">==</span> <span class="m">31</span><span class="p">);</span></div><div class='line' id='LC157'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="n">Assert</span><span class="p">.</span><span class="n">IsTrue</span><span class="p">(</span><span class="n">clonedCollection</span><span class="p">.</span><span class="n">Count</span> <span class="p">==</span> <span class="m">2</span><span class="p">);</span></div><div class='line' id='LC158'><br/></div><div class='line' id='LC159'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="c1">// Force cover the IEnumerable.GetEnumerator()</span></div><div class='line' id='LC160'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="n">IEnumerator</span> <span class="n">enumerator</span> <span class="p">=</span> <span class="p">((</span><span class="n">IEnumerable</span><span class="p">)</span><span class="n">wrappedCollection</span><span class="p">).</span><span class="n">GetEnumerator</span><span class="p">();</span></div><div class='line' id='LC161'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="n">enumerator</span><span class="p">.</span><span class="n">MoveNext</span><span class="p">();</span></div><div class='line' id='LC162'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="n">Assert</span><span class="p">.</span><span class="n">IsTrue</span><span class="p">((</span><span class="kt">int</span><span class="p">)(</span><span class="n">enumerator</span><span class="p">.</span><span class="n">Current</span><span class="p">)</span> <span class="p">==</span> <span class="m">11</span><span class="p">);</span></div><div class='line' id='LC163'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="p">}</span></div><div class='line' id='LC164'><br/></div><div class='line' id='LC165'><br/></div><div class='line' id='LC166'><span class="na">      [Test]</span></div><div class='line' id='LC167'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="k">public</span> <span class="k">void</span> <span class="nf">Test_ReadOnlyList</span><span class="p">()</span> <span class="p">{</span></div><div class='line' id='LC168'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kt">var</span> <span class="n">list</span> <span class="p">=</span> <span class="k">new</span> <span class="n">List</span><span class="p">&lt;</span><span class="kt">int</span><span class="p">&gt;</span> <span class="p">{</span> <span class="m">11</span><span class="p">,</span><span class="m">21</span> <span class="p">};</span></div><div class='line' id='LC169'><br/></div><div class='line' id='LC170'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kt">var</span> <span class="n">wrappedList</span> <span class="p">=</span> <span class="n">list</span><span class="p">.</span><span class="n">ToReadOnlyWrappedList</span><span class="p">();</span></div><div class='line' id='LC171'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="n">Assert</span><span class="p">.</span><span class="n">IsTrue</span><span class="p">(</span><span class="n">wrappedList</span><span class="p">.</span><span class="n">Count</span> <span class="p">==</span> <span class="m">2</span><span class="p">);</span></div><div class='line' id='LC172'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="n">Assert</span><span class="p">.</span><span class="n">IsTrue</span><span class="p">(</span><span class="n">wrappedList</span><span class="p">[</span><span class="m">0</span><span class="p">]</span> <span class="p">==</span> <span class="m">11</span><span class="p">);</span></div><div class='line' id='LC173'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="n">Assert</span><span class="p">.</span><span class="n">IsTrue</span><span class="p">(</span><span class="n">wrappedList</span><span class="p">[</span><span class="m">1</span><span class="p">]</span> <span class="p">==</span> <span class="m">21</span><span class="p">);</span></div><div class='line' id='LC174'><br/></div><div class='line' id='LC175'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kt">var</span> <span class="n">clonedList</span> <span class="p">=</span> <span class="n">list</span><span class="p">.</span><span class="n">ToReadOnlyClonedList</span><span class="p">();</span></div><div class='line' id='LC176'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="n">Assert</span><span class="p">.</span><span class="n">IsTrue</span><span class="p">(</span><span class="n">clonedList</span><span class="p">.</span><span class="n">Count</span> <span class="p">==</span> <span class="m">2</span><span class="p">);</span></div><div class='line' id='LC177'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="n">Assert</span><span class="p">.</span><span class="n">IsTrue</span><span class="p">(</span><span class="n">clonedList</span><span class="p">[</span><span class="m">0</span><span class="p">]</span> <span class="p">==</span> <span class="m">11</span><span class="p">);</span></div><div class='line' id='LC178'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="n">Assert</span><span class="p">.</span><span class="n">IsTrue</span><span class="p">(</span><span class="n">clonedList</span><span class="p">[</span><span class="m">1</span><span class="p">]</span> <span class="p">==</span> <span class="m">21</span><span class="p">);</span></div><div class='line' id='LC179'><br/></div><div class='line' id='LC180'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="c1">// Test Cloned/Wrapped</span></div><div class='line' id='LC181'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="n">list</span><span class="p">.</span><span class="n">Add</span><span class="p">(</span><span class="m">31</span><span class="p">);</span></div><div class='line' id='LC182'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="n">Assert</span><span class="p">.</span><span class="n">IsTrue</span><span class="p">(</span><span class="n">wrappedList</span><span class="p">.</span><span class="n">Count</span> <span class="p">==</span> <span class="m">3</span><span class="p">);</span></div><div class='line' id='LC183'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="n">Assert</span><span class="p">.</span><span class="n">IsTrue</span><span class="p">(</span><span class="n">wrappedList</span><span class="p">[</span><span class="m">2</span><span class="p">]</span> <span class="p">==</span> <span class="m">31</span><span class="p">);</span></div><div class='line' id='LC184'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="n">Assert</span><span class="p">.</span><span class="n">IsTrue</span><span class="p">(</span><span class="n">clonedList</span><span class="p">.</span><span class="n">Count</span> <span class="p">==</span> <span class="m">2</span><span class="p">);</span></div><div class='line' id='LC185'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="p">}</span></div><div class='line' id='LC186'><br/></div><div class='line' id='LC187'><span class="na">      [Test]</span></div><div class='line' id='LC188'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="k">public</span> <span class="k">void</span> <span class="nf">Test_IndexOf</span><span class="p">()</span> <span class="p">{</span></div><div class='line' id='LC189'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kt">var</span> <span class="n">ints</span> <span class="p">=</span> <span class="p">(</span><span class="k">new</span> <span class="n">List</span><span class="p">&lt;</span><span class="kt">int</span><span class="p">&gt;</span> <span class="p">{</span><span class="m">11</span><span class="p">,</span> <span class="m">21</span><span class="p">,</span> <span class="m">31</span><span class="p">}).</span><span class="n">ToReadOnlyWrappedList</span><span class="p">();</span></div><div class='line' id='LC190'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="n">Assert</span><span class="p">.</span><span class="n">IsTrue</span><span class="p">(</span><span class="n">ints</span><span class="p">.</span><span class="n">IndexOf</span><span class="p">(</span><span class="m">21</span><span class="p">)</span> <span class="p">==</span> <span class="m">1</span><span class="p">);</span></div><div class='line' id='LC191'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="n">Assert</span><span class="p">.</span><span class="n">IsTrue</span><span class="p">(</span><span class="n">ints</span><span class="p">.</span><span class="n">IndexOf</span><span class="p">(</span><span class="m">41</span><span class="p">)</span> <span class="p">==</span> <span class="p">-</span><span class="m">1</span><span class="p">);</span></div><div class='line' id='LC192'><br/></div><div class='line' id='LC193'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kt">var</span> <span class="n">strings</span> <span class="p">=</span> <span class="p">(</span><span class="k">new</span> <span class="n">List</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">&gt;</span> <span class="p">{</span><span class="s">&quot;11&quot;</span><span class="p">,</span> <span class="s">&quot;21&quot;</span><span class="p">,</span> <span class="s">&quot;31&quot;</span><span class="p">}).</span><span class="n">ToReadOnlyWrappedList</span><span class="p">();</span></div><div class='line' id='LC194'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="n">Assert</span><span class="p">.</span><span class="n">IsTrue</span><span class="p">(</span><span class="n">strings</span><span class="p">.</span><span class="n">IndexOf</span><span class="p">(</span><span class="s">&quot;21&quot;</span><span class="p">)</span> <span class="p">==</span> <span class="m">1</span><span class="p">);</span></div><div class='line' id='LC195'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="n">Assert</span><span class="p">.</span><span class="n">IsTrue</span><span class="p">(</span><span class="n">strings</span><span class="p">.</span><span class="n">IndexOf</span><span class="p">(</span><span class="s">&quot;41&quot;</span><span class="p">)</span> <span class="p">==</span> <span class="p">-</span><span class="m">1</span><span class="p">);</span></div><div class='line' id='LC196'><br/></div><div class='line' id='LC197'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kt">var</span> <span class="n">obj</span> <span class="p">=</span> <span class="k">new</span> <span class="kt">object</span><span class="p">();</span></div><div class='line' id='LC198'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kt">var</span> <span class="n">objects</span> <span class="p">=</span> <span class="p">(</span><span class="k">new</span> <span class="n">List</span><span class="p">&lt;</span><span class="kt">object</span><span class="p">&gt;</span> <span class="p">{</span><span class="k">new</span> <span class="kt">object</span><span class="p">(),</span> <span class="n">obj</span><span class="p">,</span> <span class="k">new</span> <span class="kt">object</span><span class="p">()}).</span><span class="n">ToReadOnlyWrappedList</span><span class="p">();</span></div><div class='line' id='LC199'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="n">Assert</span><span class="p">.</span><span class="n">IsTrue</span><span class="p">(</span><span class="n">objects</span><span class="p">.</span><span class="n">IndexOf</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span> <span class="p">==</span> <span class="m">1</span><span class="p">);</span></div><div class='line' id='LC200'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="n">Assert</span><span class="p">.</span><span class="n">IsTrue</span><span class="p">(</span><span class="n">objects</span><span class="p">.</span><span class="n">IndexOf</span><span class="p">(</span><span class="k">new</span> <span class="kt">object</span><span class="p">())</span> <span class="p">==</span> <span class="p">-</span><span class="m">1</span><span class="p">);</span></div><div class='line' id='LC201'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="p">}</span></div><div class='line' id='LC202'>&nbsp;&nbsp;&nbsp;<span class="p">}</span></div></pre></div>
          </div>

          <div class="gist-meta">
            <a href="https://gist.github.com/raw/3247559/1ac54e60a786ab1b082f51dc7fb16c8c559383a0/gistfile1.cs" style="float:right;">view raw</a>
            <a href="https://gist.github.com/3247559#file_gistfile1.cs" style="float:right;margin-right:10px;color:#666">gistfile1.cs</a>
            <a href="https://gist.github.com/3247559">This Gist</a> brought to you by <a href="http://github.com">GitHub</a>.
          </div>
        </div>
</div>
</noscript>
<p>And finally, I did a CQLinq rule to check that NDepend.API will never return anymore a <em>ICollection&lt;T&gt;</em>!</p>
<script src="http://gist.github.com/3249750.js"></script><noscript><link rel="stylesheet" href="https://gist.github.com/stylesheets/gist/embed.css"><div id="gist-3249750" class="gist">
    

        <div class="gist-file">
          <div class="gist-data gist-syntax">
              <div class="highlight"><pre><div class='line' id='LC1'><span class="c1">// &lt;Name&gt;Check enumerable types returned by NDepend.API&lt;/Name&gt;</span></div><div class='line' id='LC2'><span class="n">warnif</span> <span class="n">count</span> <span class="p">&gt;</span> <span class="m">0</span></div><div class='line' id='LC3'><span class="n">let</span> <span class="n">seqTypes</span> <span class="p">=</span> <span class="n">Types</span><span class="p">.</span><span class="n">Where</span><span class="p">(</span></div><div class='line' id='LC4'>&nbsp;&nbsp;&nbsp;<span class="n">t</span> <span class="p">=&gt;</span> <span class="n">t</span><span class="p">.</span><span class="n">Implement</span><span class="p">(</span><span class="s">&quot;System.Collections.Generic.IEnumerable&lt;T&gt;&quot;</span><span class="p">)</span> <span class="p">&amp;&amp;</span></div><div class='line' id='LC5'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="c1">// List of enumerable types that can be returned by a NDepend.API function.</span></div><div class='line' id='LC6'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="p">!</span><span class="n">t</span><span class="p">.</span><span class="n">FullName</span><span class="p">.</span><span class="n">EqualsAny</span><span class="p">(</span><span class="s">&quot;System.String&quot;</span><span class="p">,</span></div><div class='line' id='LC7'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="s">&quot;System.Linq.ILookup&lt;TKey,TElement&gt;&quot;</span><span class="p">,</span></div><div class='line' id='LC8'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="s">&quot;NDepend.Helpers.IReadOnlyList&lt;T&gt;&quot;</span><span class="p">,</span></div><div class='line' id='LC9'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="s">&quot;NDepend.Helpers.IReadOnlyCollection&lt;T&gt;&quot;</span><span class="p">,</span></div><div class='line' id='LC10'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="s">&quot;System.Collections.Generic.HashSet&lt;T&gt;&quot;</span><span class="p">,</span></div><div class='line' id='LC11'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="s">&quot;NDepend.CodeModel.ICodeMetric&lt;TCodeElement,TNumeric&gt;&quot;</span><span class="p">)).</span><span class="n">ToHashSet</span><span class="p">()</span></div><div class='line' id='LC12'><br/></div><div class='line' id='LC13'><span class="k">from</span> <span class="n">m</span> <span class="k">in</span> <span class="n">Assemblies</span><span class="p">.</span><span class="n">WithNameIn</span><span class="p">(</span> <span class="s">&quot;NDepend.API&quot;</span><span class="p">).</span><span class="n">ChildMethods</span><span class="p">()</span> <span class="k">orderby</span> <span class="n">m</span><span class="p">.</span><span class="n">NbLinesOfCode</span> <span class="k">descending</span></div><div class='line' id='LC14'><br/></div><div class='line' id='LC15'><span class="k">where</span> <span class="n">m</span><span class="p">.</span><span class="n">IsPubliclyVisible</span> <span class="p">&amp;&amp;</span></div><div class='line' id='LC16'>&nbsp;<span class="n">m</span><span class="p">.</span><span class="n">ReturnType</span> <span class="p">!=</span> <span class="k">null</span> <span class="p">&amp;&amp;</span></div><div class='line' id='LC17'>&nbsp;<span class="n">seqTypes</span><span class="p">.</span><span class="n">Contains</span><span class="p">(</span><span class="n">m</span><span class="p">.</span><span class="n">ReturnType</span><span class="p">)</span></div><div class='line' id='LC18'><span class="k">select</span> <span class="k">new</span> <span class="p">{</span> <span class="n">m</span><span class="p">,</span> <span class="n">m</span><span class="p">.</span><span class="n">ReturnType</span> <span class="p">}</span></div></pre></div>
          </div>

          <div class="gist-meta">
            <a href="https://gist.github.com/raw/3249750/83eefa5c696cb374799356f48e1811400d122431/gistfile1.cs" style="float:right;">view raw</a>
            <a href="https://gist.github.com/3249750#file_gistfile1.cs" style="float:right;margin-right:10px;color:#666">gistfile1.cs</a>
            <a href="https://gist.github.com/3249750">This Gist</a> brought to you by <a href="http://github.com">GitHub</a>.
          </div>
        </div>
</div>
</noscript>
							</div><!-- .entry-content -->
	
			<div class="entry-utility">
				<span class="cat-links"><span class="entry-utility-prep entry-utility-prep-cat-links">Posted in <a href="http://codebetter.com/patricksmacchia/category/net-framework/" title="View all posts in .NET Framework" rel="category">.NET Framework</a>, <a href="http://codebetter.com/patricksmacchia/category/api-usage/" title="View all posts in API usage" rel="category">API usage</a>, <a href="http://codebetter.com/patricksmacchia/category/breaking-changes/" title="View all posts in breaking changes" rel="category">breaking changes</a>, <a href="http://codebetter.com/patricksmacchia/category/code-rule/" title="View all posts in Code Rule" rel="category">Code Rule</a></span></span>
				<span class="meta-sep"> | </span>
												<span class="comments-link"><a href="http://codebetter.com/patricksmacchia/2012/08/06/the-consequence-of-a-net-framework-api-design-flaw/#comments" title="Comment on The consequence of a.NET Framework API design flaw"><span class="dsq-postid" rel="689 http://codebetter.com/patricksmacchia/?p=689">11 Comments</span></a></span>
							</div><!-- #entry-utility -->
		</div><!-- #post-689 -->

		
			
	<div id="nav-below" class="navigation">
		<div class="nav-next"><a href="?page=1" > Next Page &raquo;</a></div>
		
	</div><!-- #nav-below -->
		</div><!-- #main -->
		<div id="sidebar" class="grid_4">
					<div id="primary" class="widget-area">
			<ul class="xoxo">
				<div class="ad-container">
<script type='text/javascript'><!--// <![CDATA[
    OA_show(29416);
// ]]> --></script><noscript><a target='_blank' href='http://d1.openx.org/ck.php?n=2782afb'><img border='0' alt='' src='http://d1.openx.org/avw.php?zoneid=29416&amp;n=2782afb' /></a></noscript><script type='text/javascript'><!--// <![CDATA[
    OA_show(29417);
// ]]> --></script><noscript><a target='_blank' href='http://d1.openx.org/ck.php?n=e94cea6'><img border='0' alt='' src='http://d1.openx.org/avw.php?zoneid=29417&amp;n=e94cea6' /></a></noscript><script type='text/javascript'><!--// <![CDATA[
    OA_show(29418);
// ]]> --></script><noscript><a target='_blank' href='http://d1.openx.org/ck.php?n=9ba3022'><img border='0' alt='' src='http://d1.openx.org/avw.php?zoneid=29418&amp;n=9ba3022' /></a></noscript><script type='text/javascript'><!--// <![CDATA[
    OA_show(29419);
// ]]> --></script><noscript><a target='_blank' href='http://d1.openx.org/ck.php?n=f467b52'><img border='0' alt='' src='http://d1.openx.org/avw.php?zoneid=29419&amp;n=f467b52' /></a></noscript>
				</div>
			
				<li id="user_bio-2" class="widget-container widget_user_bio"><h3 class="widget-title"></h3>One of these days I will add something to my user profile! For now, I shall remain mysterious.
</li>		
						
			</ul>
			
		</div><!-- #primary .widget-area -->
		
		<div id="secondary" class="widget-area">
				
<script type='text/javascript'><!--// <![CDATA[
    OA_show(220407);
// ]]> --></script><noscript><a target='_blank' href='http://d1.openx.org/ck.php?n=68b8307'><img border='0' alt='' src='http://d1.openx.org/avw.php?zoneid=220407&amp;n=68b8307' /></a></noscript>				
				
				<ul class="xoxo">		
									</ul>	
				
<script type='text/javascript'><!--// <![CDATA[
    OA_show(29421);
// ]]> --></script><noscript><a target='_blank' href='http://d1.openx.org/ck.php?n=3f8e353'><img border='0' alt='' src='http://d1.openx.org/avw.php?zoneid=29421&amp;n=3f8e353' /></a></noscript>
				
		</div><!-- #secondary .widget-area -->		</div><!--sidebar-->
	</div><!-- #content -->	
</div><!-- end div tabs see header.php -->
	
	<div id="footer">
		<div class="container_12">
		<div id="footer-widget-area">
				<div class="grid_4">					
					<ul>
					<li><a href="http://codebetter.com" title="home">Home</a></li>
					<li class="page_item page-item-2"><a href="http://codebetter.com/about/">About</a></li>
<li class="page_item page-item-8"><a href="http://codebetter.com/codebetter-ci/">CodeBetter CI</a></li>
<li class="page_item page-item-6"><a href="http://codebetter.com/community/">Community</a></li>
<li class="page_item page-item-10"><a href="http://codebetter.com/editors/">Editors</a></li>
<li class="page_item page-item-41"><a href="http://codebetter.com/globalsearch/">Search Results</a></li>
					<li><a href="http://feeds.feedburner.com/CodeBetter" rel="alternate" type="application/rss+xml"><img src="http://www.feedburner.com/fb/images/pub/feed-icon16x16.png" alt="" style="vertical-align:middle;border:0"/></a><a href="http://feeds.feedburner.com/CodeBetter"><img src="http://feeds.feedburner.com/~fc/CodeBetter?bg=FFFFFF&amp;fg=2E9BD2&amp;anim=1" height="26" width="88" style="vertical-align:middle;border:0"/></a></li>
					</ul>
				</div><!-- #second .widget-area -->
				<div class="grid_4">
					
					<h3>Friends of CodeBetter.Com</h3>
<ul>

<li><a href="http://red-gate.com/">Red-Gate Tools For SQL and .NET</a></li>
<li><a href="http://telerik.com">Telerik .NET Tools</a></li>
<li><a href="http://jetbrains.com/resharper/">JetBrains - ReSharper</a></li>
<li><a href="http://scootersoftware.com">Beyond Compare</a></li>
<li><a href="http://www.ndepend.com/">NDepend</a></li>
<li><a href="http://www.sapphiresteel.com/">Ruby In Steel</a></li>
<li><a href="http://www.slickedit.com/">SlickEdit</a></li>
<li><a href="http://www.gurock.com/products/smartinspect/">SmartInspect .NET Logging</a></li>
<li>NGEDIT: <a href="http://www.viemu.com/">ViEmu</a> and <a href="http://www.codekana.com/">Codekana</a> </li>
<li><a href="http://www.devexpress.com/" target="_blank">DevExpress</a></li>
<li><a href="http://nhprof.com" target="_blank">NHibernate Profiler</a></li>
<li><a href="http://unfuddle.com" target="_blank">Unfuddle</a></li>
<li><a href="http://www.balsamiq.com/products/mockups" target="_blank">Balsamiq Mockups</a></li>
<li><a href="http://scrumy.com" target="_blank">Scrumy</a></li>
<li><a href="http://umbraco.com" target="_blank">Umbraco</a></li>
<li><a href="http://nservicebus.com" target="_blank">NServiceBus</a></li>
<li><a href="http://ravendb.net" target="_blank">RavenDb</a></li>
<li><a href="http://www.websequencediagrams.com/" target="_blank">Web Sequence Diagrams</a></li>
	</ul>				
				</div><!-- #third .widget-area -->
				<div class="grid_4">
					CodeBetter.Com &copy; '12<br />
						Stuff you need to Code Better!<br />
				Proudly powered by <span id="generator-link"><a href="http://wordpress.org/" title="Semantic Personal Publishing Platform" rel="generator">WordPress</a></span>.					
				</div><!-- #fourth .widget-area -->
			</div><!-- #footer-widget-area -->		
		
			</div><!-- end div.container_12 -->

	</div><!-- end div#footer -->
		
<script type="text/javascript">

  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-531207-1']);
  _gaq.push(['_trackPageview']);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();

</script>
<script type='text/javascript' src='http://cdn1.codebetter.com/wp-content/plugins/syntaxhighlighter/syntaxhighlighter3/scripts/shCore.js?ver=3.0.83b'></script>
<script type='text/javascript' src='http://cdn1.codebetter.com/wp-content/plugins/syntaxhighlighter/syntaxhighlighter3/scripts/shBrushCSharp.js?ver=3.0.83b'></script>
<script type='text/javascript' src='http://cdn1.codebetter.com/wp-content/plugins/syntaxhighlighter/syntaxhighlighter3/scripts/shBrushRuby.js?ver=3.0.83b'></script>
<script type='text/javascript' src='http://cdn1.codebetter.com/wp-content/plugins/syntaxhighlighter/syntaxhighlighter3/scripts/shBrushJScript.js?ver=3.0.83b'></script>
<script type='text/javascript' src='http://cdn1.codebetter.com/wp-content/plugins/syntaxhighlighter/syntaxhighlighter3/scripts/shBrushXml.js?ver=3.0.83b'></script>
<script type='text/javascript' src='http://cdn1.codebetter.com/wp-content/plugins/syntaxhighlighter/syntaxhighlighter3/scripts/shBrushPython.js?ver=3.0.83b'></script>
<script type='text/javascript' src='http://cdn1.codebetter.com/wp-content/plugins/syntaxhighlighter/third-party-brushes/shBrushFSharp.js?ver=3.0.83b'></script>
<script type='text/javascript'>
	(function(){
		var corecss = document.createElement('link');
		var themecss = document.createElement('link');
		var corecssurl = "http://cdn1.codebetter.com/wp-content/plugins/syntaxhighlighter/syntaxhighlighter3/styles/shCore.css?ver=3.0.83b";
		if ( corecss.setAttribute ) {
				corecss.setAttribute( "rel", "stylesheet" );
				corecss.setAttribute( "type", "text/css" );
				corecss.setAttribute( "href", corecssurl );
		} else {
				corecss.rel = "stylesheet";
				corecss.href = corecssurl;
		}
		document.getElementsByTagName("head")[0].insertBefore( corecss, document.getElementById("syntaxhighlighteranchor") );
		var themecssurl = "http://cdn1.codebetter.com/wp-content/plugins/syntaxhighlighter/syntaxhighlighter3/styles/shThemeDefault.css?ver=3.0.83b";
		if ( themecss.setAttribute ) {
				themecss.setAttribute( "rel", "stylesheet" );
				themecss.setAttribute( "type", "text/css" );
				themecss.setAttribute( "href", themecssurl );
		} else {
				themecss.rel = "stylesheet";
				themecss.href = themecssurl;
		}
		//document.getElementById("syntaxhighlighteranchor").appendChild(themecss);
		document.getElementsByTagName("head")[0].insertBefore( themecss, document.getElementById("syntaxhighlighteranchor") );
	})();
	SyntaxHighlighter.config.strings.expandSource = '+ expand source';
	SyntaxHighlighter.config.strings.help = '?';
	SyntaxHighlighter.config.strings.alert = 'SyntaxHighlighter\n\n';
	SyntaxHighlighter.config.strings.noBrush = 'Can\'t find brush for: ';
	SyntaxHighlighter.config.strings.brushNotHtmlScript = 'Brush wasn\'t configured for html-script option: ';
	SyntaxHighlighter.defaults['gutter'] = false;
    SyntaxHighlighter.defaults['tab-size'] = 2;
    SyntaxHighlighter.defaults['toolbar'] = false;
    SyntaxHighlighter.defaults['wrap-lines'] = true; 
	SyntaxHighlighter.defaults['pad-line-numbers'] = false;
	SyntaxHighlighter.all();
</script>

<script type='text/javascript'>//<![CDATA[
    if (typeof jQuery == 'undefined') {
        document.write(unescape("%3Cscript src='http://ajax.aspnetcdn.com/ajax/jQuery/jquery-1.4.2.min.js' type='text/javascript' %3E%3C/script%3E"));
    }//]]></script>
<script type='text/javascript' language='Javascript' src='http://s1.lqcdn.com/m.min.js?dt=2.3.110202.1'></script>
<script type='text/javascript' language='Javascript'> if(jQuery.LqmAds)jQuery.LqmAds();</script>
 
</body>
</html>
<!-- Dynamic page generated in 1.822 seconds. -->
<!-- Cached page generated by WP-Super-Cache on 2012-11-26 14:26:19 -->

<!-- super cache -->