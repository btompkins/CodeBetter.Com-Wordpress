<!DOCTYPE html>
<html dir="ltr" lang="en-US">
<head>
	<meta charset="UTF-8" />
    <title>Build your own CAB #11 &#8211; Event Aggregator | Jeremy D. Miller</title>
	<link rel="profile" href="http://gmpg.org/xfn/11" />
	
	<link href="http://feeds.feedburner.com/CodeBetter" title="CodeBetter.Com &raquo; Feed" type="application/rss+xml" rel="alternate">
	
		<link rel="pingback" href="http://codebetter.com/jeremymiller/xmlrpc.php" />
	                <link rel="stylesheet" href="http://cdn1.codebetter.com/wp-content/uploads/spacker-cache/ea73517eb74a545f51c376487c94dc9f.css" type="text/css" media="all" /><!-- Is Cache! -->
                <script type='text/javascript' src='http://cdn1.codebetter.com/wp-includes/js/l10n.js?ver=20101110'></script>
<link rel="EditURI" type="application/rsd+xml" title="RSD" href="http://codebetter.com/jeremymiller/xmlrpc.php?rsd" />
<link rel="wlwmanifest" type="application/wlwmanifest+xml" href="http://cdn1.codebetter.com/wp-includes/wlwmanifest.xml" /> 
<link rel='index' title='Jeremy D. Miller' href='http://codebetter.com/jeremymiller/' />
<link rel='start' title='Bypass VSTS and get yourself a &quot;Poor Man&#8217;s IntelliJ&quot;' href='http://codebetter.com/jeremymiller/2005/04/12/bypass-vsts-and-get-yourself-a-poor-mans-intellij/' />
<link rel='prev' title='Designing for Testability' href='http://codebetter.com/jeremymiller/2007/06/29/designing-for-testability/' />
<link rel='next' title='Build your own CAB #12 &#8211; Rein in runaway events with the &quot;Latch&quot;' href='http://codebetter.com/jeremymiller/2007/07/02/build-your-own-cab-12-rein-in-runaway-events-with-the-quot-latch-quot/' />
<meta name="generator" content="WordPress 3.1-beta1-16732" />
<link rel='canonical' href='http://codebetter.com/jeremymiller/2007/06/29/build-your-own-cab-11-event-aggregator/' />
<link rel='shortlink' href='http://codebetter.com/jeremymiller/?p=370' />
<link rel="stylesheet" href="http://cdn1.codebetter.com/wp-content/plugins/digg-digg/include/../css/diggdigg-style.css?ver=4.5.0.7" type="text/css" media="screen" /><link rel="stylesheet" href="http://disqus.com/stylesheets/theshadetreedeveloper/disqus.css?v=2.0" type="text/css" media="screen" />	<style type="text/css">.recentcomments a{display:inline !important;padding:0 !important;margin:0 !important;}</style>
<meta id="syntaxhighlighteranchor" name="syntaxhighlighter-version" content="3.1.1" />
                <script type="text/javascript" src="http://cdn1.codebetter.com/wp-content/uploads/spacker-cache/a8046d2f1fc1c08af413701218a11c1d.js">/*Is Cache!*/</script>
                	<style type="text/css">body { padding-top:0px !important; } html { margin-top: 0px !important; }</style>

</head>

<body>

			
		<div class="container_12 ui-tabs ui-widget ui-widget-content ui-corner-all" id="tabs">			
			<ul class="ui-tabs-nav ui-helper-reset ui-helper-clearfix ui-widget-header ui-corner-all">
				<li class="ui-state-default ui-corner-top ui-tabs-selected ui-state-active"><a href="#ui-tabs-1">CodeBetter.Com</a></li>
				<li class="ui-state-default ui-corner-top"><a href="http://devlicio.us">Devlicio.Us</a></li>				
				<div id="top-search">
				<form action="http://codebetter.com/globalsearch/" id="cse-search-box">
  <div>
   <fieldset id="search">
		<input type="hidden" name="cx" value="005178204031477491434:2bg5jtwgsfe" />
		<input type="hidden" name="cof" value="FORID:9" />
		<input type="hidden" name="ie" value="UTF-8" />
		<input type="text"  class="text-input" id="s" name="q" size="31" />
		<input type="image" src="http://cdn1.codebetter.com/wp-content/themes/codebetter/images/search-img.png" class="form-button" id="searchsubmit" value="GO" name="">				   	
	</fieldset>
  </div>
</form>
<script type="text/javascript" src="http://www.google.com/cse/brand?form=cse-search-box&lang=en&sitesearch=true"></script>
				</div>				
			</ul><div id="ui-tabs-1" class="ui-tabs-panel ui-widget-content ui-corner-bottom"></div><div id="ui-tabs-2" class="ui-tabs-panel ui-widget-content ui-corner-bottom ui-tabs-hide"></div>
		</div>
			
		<div id="main" class="container_12">
		
			<div id="logo" class="grid_3"><a href="/" title="CodeBetter.Com - Stuff you need to Code Better!"><image src="http://cdn1.codebetter.com/wp-content/themes/codebetter/images/codebetter_logo.png" height="48" width="223"></image></a></div>
			<div id="ad_leaderboard" class="grid_9">			</div>
			
			<div id="globalNav" class="grid_12">
				<ul>
					<li><a href="http://codebetter.com" title="home">Home</a></li>
					<li class="page_item page-item-2"><a href="http://codebetter.com/about/" title="About">About</a></li>
<li class="page_item page-item-8"><a href="http://codebetter.com/codebetter-ci/" title="CodeBetter CI">CodeBetter CI</a></li>
<li class="page_item page-item-6"><a href="http://codebetter.com/community/" title="Community">Community</a></li>
<li class="page_item page-item-10"><a href="http://codebetter.com/editors/" title="Editors">Editors</a></li>
					<li><a href="http://feeds.feedburner.com/CodeBetter" rel="alternate" type="application/rss+xml"><img src="http://www.feedburner.com/fb/images/pub/feed-icon16x16.png" alt="" style="vertical-align:middle;border:0"/></a><a href="http://feeds.feedburner.com/CodeBetter"><img src="http://feeds.feedburner.com/~fc/CodeBetter?bg=EFEFEF&amp;fg=2E9BD2&amp;anim=1" height="26" width="88" style="vertical-align:middle;border:0"/></a></li>
				</ul>
								
			</div><!-- end div#globalNav.container_12 -->				
	
		<div id="content" class="container_12">
			<div id="main" class="grid_8">


				<div id="post-370" class="post-370 post type-post status-publish format-standard hentry category-build-your-own-cab category-design-patterns category-storyteller">
					<h1 class="entry-title">Build your own CAB #11 &#8211; Event Aggregator</h1>

					<div class="entry-meta">
						<span class="meta-prep meta-prep-author">Posted by </span>
						<span class="author vcard"><a class="url fn n" href="http://codebetter.com/jeremymiller/author/jeremymiller/" title="View all posts by Jeremy Miller">Jeremy Miller</a></span>
						<span class="meta-sep"> on  </span>
						<a href="http://codebetter.com/jeremymiller/2007/06/29/build-your-own-cab-11-event-aggregator/" title="3:12 pm" rel="bookmark"><span class="entry-date">June 29, 2007</span></a>
											</div><!-- .entry-meta -->

					<div class="entry-content">
						<div id="greet_block"><noscript><div class="greet_block wpgb_cornered"><div class="greet_text"><div class="greet_image"><a href="http://codebetter.com/jeremymiller/feed/rss/"  rel="nofollow"><img src="http://cdn1.codebetter.com/wp-content/plugins/wp-greet-box/images/rss_icon.png" alt="WP Greet Box icon"/></a></div>Hello there! If you are new here, you might want to <a href="http://codebetter.com/jeremymiller/feed/rss/" rel="nofollow"><strong>subscribe to the RSS feed</strong></a> for updates on this topic.<div style="clear:both"></div><div class="greet_block_powered_by">Powered by <a href="http://omninoggin.com/projects/wordpress-plugins/wp-greet-box-wordpress-plugin/" title="WP Greet Box WordPress Plugin" style="text-decoration:none;">WP Greet Box</a> <a href="http://omninoggin.com/" title="WordPress Plugin" style="text-decoration:none;">WordPress Plugin</a></div><div style="clear:both"></div></div></div></noscript></div><p>I will finish &#8220;Build your own CAB&#8221; at least before Acropolis hits and makes it all obsolete.&nbsp; In the meantime, check out all the stuff that&#8217;s gone before:</p>
<ol>
<li><a href="http://codebetter.com/blogs/jeremy.miller/archive/2007/05/21/build-your-own-cab-part-1-the-preamble.aspx">Preamble</a>  </li>
<li><a href="http://codebetter.com/blogs/jeremy.miller/archive/2007/05/23/build-your-own-cab-part-2-the-humble-dialog-box.aspx">The Humble Dialog Box</a>  </li>
<li><a href="http://codebetter.com/blogs/jeremy.miller/archive/2007/05/25/build-you-own-cab-part-3-the-supervising-controller-pattern.aspx">Supervising Controller</a>  </li>
<li><a href="http://codebetter.com/blogs/jeremy.miller/archive/2007/05/30/build-your-own-cab-part-4-the-passive-view.aspx">Passive View</a>  </li>
<li><a href="http://codebetter.com/blogs/jeremy.miller/archive/2007/06/03/build-your-own-cab-part-5-the-presentation-model.aspx">Presentation Model</a>  </li>
<li><a href="http://codebetter.com/blogs/jeremy.miller/archive/2007/06/04/build-your-own-cab-part-6-view-to-presenter-communication.aspx">View to Presenter Communication</a>  </li>
<li><a href="http://codebetter.com/blogs/jeremy.miller/archive/2007/06/05/build-your-own-cab-answering-some-questions.aspx">Answering some questions</a>  </li>
<li><a href="http://codebetter.com/blogs/jeremy.miller/archive/2007/06/05/build-your-own-cab-part-7-what-s-the-model.aspx">What&#8217;s the Model?</a>  </li>
<li><a href="http://codebetter.com/blogs/jeremy.miller/archive/2007/06/10/build-your-own-cab-part-8-model-view-presenter-wrapup.aspx">Assigning Responsibilities in a Model View Presenter Architecture</a>  </li>
<li><a href="http://codebetter.com/blogs/jeremy.miller/archive/2007/06/13/build-your-own-cab-part-9-domain-centric-validation-with-the-notification-pattern.aspx">Domain Centric Validation with the Notification Pattern</a></li>
<li><a href="http://codebetter.com/blogs/jeremy.miller/archive/2007/06/26/build-your-own-cab-part-10-unit-testing-the-ui-with-nunitforms.aspx">Unit Testing the UI with NUnitForms</a></li>
<li>Event Aggregator &#8211; This post</li>
<li>Stopping Event Propagation with the &#8220;Latch&#8221; &#8211; Very closely related follow up to this post.&nbsp; Forthcoming</li>
<li>Embedded Controllers &#8211; Forthcoming</li>
<li>MicroControllers &#8211; Forthcoming</li>
<li>Other stuff&#8230;</li>
</ol>
<p>And no, there will definitely NOT be a &#8220;Build your own Acropolis&#8221; series here.</p>
<h4>Event Management is Hard</h4>
<p>A direct quote from my tester today:&nbsp; &#8220;user interfaces are complicated critters.&#8221;&nbsp; From time to time I bump into the idea that Graphical User Interface (GUI)&nbsp;programming is easy stuff suitable for keeping the amateurs busy while the adults are busy on the server side.&nbsp;&nbsp;My previous job involved very complex business logic behind a trivial GUI, but in systems like my current project the complexity of the GUI dwarfs the web services and database.&nbsp; There are several things that potentially make GUI programming hard, but the worst culprit by far to me is the event driven nature of heavy, interactive clients.&nbsp; A close second might be the synchronization of state between different parts of the user interface.&nbsp; Here&#8217;s an example to illustrate what I mean:</p>
<p>Several years ago I found myself absurdly underused at work* with a brand new copy of the Gang of Four book on my bookshelf.&nbsp; I naturally decided to teach myself&nbsp;design patterns by&nbsp;writing a fullblown grid and reporting system for DHTML&nbsp;written in JavaScript.&nbsp; The easy stuff was easy, but things suddenly got harder when I started to put these pieces together:</p>
<ol>
<li>A grid control.&nbsp; Given some data, an array of Column objects and ColorCoding objects, and a page size, make an HTML table on the fly.&nbsp; Allow sorting from the grid</li>
<li>A pager control</li>
<li>A filter control that allowed you to filter data in the grid based on the unique values of the data set.&nbsp; Think lot&#8217;s of dropdowns</li>
<li>A control that allowed you to customize the columns and color coding conditions</li>
<li>A control that displayed the report header information</li>
</ol>
<p>Fine and great, except I&nbsp; ran into two major problems.&nbsp; The first problem was that I needed to synchronize all of the various components of the logical &#8220;Report&#8221; anytime things changed (new data, filter changed, sorting, turning columns on and off, changing to a different report, etc.).&nbsp; What Martin Fowler calls <a href="http://www.martinfowler.com/eaaDev/FlowSynchronization.html">flow synchronization</a>&nbsp;turned out to be very clumsy.&nbsp; Besides the <a href="http://www.enterpriseintegrationpatterns.com/ramblings/03_hubandspoke.html">&#8220;n squared&#8221; communication problem</a>, not every page had the exact same set of components.&nbsp; Having each component try to reach out and tell each other anytime the report state changed turned out to be a nightmare.&nbsp; Plus, what if I wanted to add completely new types of components to new report screens?</p>
<p>My second problem was the cascading event problem that&#8217;s so painfully common in stateful GUI programming.&nbsp; Resetting the data in the grid causes the filter control to refresh it&#8217;s dropdown boxes, which could easily fire off the onchanged event of the dropdowns, which would fire off a command to reset the grid data, which could&#8230;&nbsp;&nbsp;&nbsp; &#8230;ripple all over the place.&nbsp; </p>
<p>I came to the conclusion that I needed to funnel all the events to a single class that would be responsible for propagating the events to all the other class&#8217;s, and also to control the event propagation somewhat to shut down the rippling event problem.&nbsp; New components could be added to the screen and take part in the reporting workflow just by being registered as listeners to my new &#8220;ReportManager&#8221; class.&nbsp;&nbsp; What I came up with in the end&nbsp;was an implementation of the <a href="http://www.martinfowler.com/eaaDev/EventAggregator.html">Event Aggregator</a> design pattern.</p>
<p>The Event Aggregator pattern is&nbsp;essentially a <a href="http://en.wikipedia.org/wiki/Publish/subscribe">Publish/Subscribe</a> infrastructure inside your&nbsp;WinForms application.&nbsp; The Event Aggregator serves the same basic purpose as&nbsp;a <a href="http://www.enterpriseintegrationpatterns.com/MessageBroker.html">messaging broker</a> in a hub and spoke messaging architecture.&nbsp;&nbsp;&nbsp;If you have any experience (that isn&#8217;t repressed memory) with publish/subscribe messaging&nbsp;architectures like webMethods or Tibco this should be old news.&nbsp; We can take much of the writings and patterns of loosely connected messaging and apply those lessons to the construction of composite&nbsp;user interfaces.&nbsp; To handle all these events flying around we can compose our system into three groups:</p>
<ol>
<li>Subscribers that need to be told about events</li>
<li>Publishers that raise the events in the first place</li>
<li>A &#8220;Hub&#8221; that collects all of the events from the publishers&nbsp;and routes and/or transforms the events to the proper subscribers</li>
</ol>
<p>By channeling all of the events into a single hub we make it much easier to add new components to our user interface.&nbsp; This is absolutely crucial for the kinds of composite applications we&#8217;re trying to build now with WinForms solutions.&nbsp; </p>
<h4>Example Event Aggregator in StoryTeller</h4>
<p>Here&#8217;s the setup.&nbsp; <a href="http://storyteller.tigris.org">StoryTeller</a> is, or will be shortly,&nbsp;a tool for editing and running acceptance tests with the <a href="http://fitnessedotnet.sourceforge.net">FitnesseDotNet</a> engine.&nbsp; The WinForms client is meant to replace the <a href="http://fitnesse.org">FitNesse</a> Wiki for running tests, and as you can easily imagine, there are a lot of screen updates when test changes or is executed.&nbsp; Potentially, each test execution could effect:</p>
<ol>
<li>The TreeView control in the left pane that presents the Test/Test Suite hierarchy.&nbsp; The TreeView nodes that represent tests change their icon to reflect the test&#8217;s status as unknown, successful, failed, or exception.&nbsp; Suspiciously similar to the NUnit GUI and every graphical test runner you&#8217;ve ever seen in your life.</li>
<li>If it&#8217;s open, the screen for editing a test.&nbsp; Some options are only enabled when there is a previous result.&nbsp; Visual cues need to change based on the result or state of the test.&nbsp; When the test is changed I gray out the title bar.&nbsp; When a test fails you get lots of red in the screen to indicate failure.</li>
<li>Test grid pages.&nbsp; I wanted the grid to update (turn the grid row red or green, update the counts, etc.)&nbsp;when the Tests change state.&nbsp; </li>
</ol>
<p>All three of these UI elements need to be updated on the same events, but it would be foolish to tie all of these pieces together with the nonvisual&nbsp;code that actually executes the tests.&nbsp; In Fowler speak, Flow Synchronization would lead to spaghetti code and undesirable coupling.&nbsp; Instead, I used a centralized Event Aggregator class to perform <a href="http://www.martinfowler.com/eaaDev/MediatedSynchronization.html">Observer Synchronization</a>.</p>
<p>Most of the literature on using or building Event Aggregator&#8217;s in WinForms applications revolves around using &#8220;Attribute magic&#8221; to define event subscribers and publishers.&nbsp; I understand a little now about why people were so upset or dubious&nbsp;with&nbsp;my &#8220;roll your own CAB&#8221; statements.&nbsp; The generic way CAB does Event Aggregator *is* complicated (but well within the reach of mere mortals if you were so inclined to do it).&nbsp; When I say that you don&#8217;t need the CAB it&#8217;s not because I think I can quickly roll my own CAB, it&#8217;s because I think I can write little specific point solutions and quite possibly be better off for it.</p>
<p>My advice is to avoid the generic one size fits all Event Aggregator implementation for something specific to your own application with interfaces&nbsp;that are&nbsp;expressed in the terms of your problem domain.&nbsp;&nbsp;Make your Event Aggregator&nbsp;publish and subscribe events that are specific and meaningful&nbsp;to your problem domain.&nbsp; By making the events specific, the semantics of the code should be far more intention revealing than code like&nbsp;<font face="Courier New">EventBroker.RaiseEvent(&#8220;event://some string/more string/event name&#8221;, new GenericEventArgs())</font> can ever be.&nbsp; I&#8217;m plenty happy to write a little bit of custom, specific&nbsp;code if the payoff is better understandability.&nbsp; </p>
<p>For StoryTeller, I took a very simple, direct path to creating an event aggregator for testing events.&nbsp; Let&#8217;s ignore the publisher and hub pieces of event aggregation for now.&nbsp; The subscribers in StoryTeller need to expose&nbsp;and implement&nbsp;an <a href="http://en.wikipedia.org/wiki/Observer_pattern">Observer</a> interface called ITestObserver with four methods:</p>
<div style="background: white none repeat scroll 0% 50%;font-size: 10pt;color: black;font-family: courier new">
<p style="margin: 0px">&nbsp;&nbsp;&nbsp; <span style="color: blue">public</span> <span style="color: blue">interface</span> <span style="color: teal">ITestObserver</span></p>
<p style="margin: 0px">&nbsp;&nbsp;&nbsp; {</p>
<p style="margin: 0px">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <span style="color: blue">void</span> StateIsUnknown(<span style="color: teal">Guid</span> testId);</p>
<p style="margin: 0px">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <span style="color: blue">void</span> StartedRunning(<span style="color: teal">Guid</span> testId);</p>
<p style="margin: 0px">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <span style="color: blue">void</span> Completed(<span style="color: teal">TestResult</span> result);</p>
<p style="margin: 0px">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <span style="color: blue">void</span> Queued(<span style="color: teal">Guid</span> testId);</p>
<p style="margin: 0px">&nbsp;&nbsp;&nbsp; }</p>
</div>
<p>What I was aiming for with this design was semantic clarity and a strong contract.&nbsp; From an implementation standpoint it becomes pretty easy to organize the code that responds to test events.&nbsp; The first class to get the ITestObserver treatment was the TreeNode subclass for StoryTeller Test&#8217;s:</p>
<p><span style="color: blue">public</span> <span style="color: blue">class</span> <span style="color: teal">TestNode</span> : <span style="color: teal">LeafNode</span>&lt;<span style="color: teal">Test</span>&gt;, <span style="color: teal">ITestObserver</span></p>
<p>TestNode is a descendent of TreeNode that represents a Test within the TreeView explorer view.&nbsp; TestNode changes it&#8217;s display when any of the ITestObserver methods are called.&nbsp; For example, when a test run starts the StartedRunning() method is called.&nbsp; The TestNode will change its icon to a question mark to denote that the outcome is unknown, and change the TreeNode.Text to &#8220;name of the test (Executing)&#8221; to give some visual indication of which test is currently being executed.&nbsp;&nbsp;Here are a couple of the&nbsp;observer methods are just this:</p>
<p>&nbsp;</p>
<p style="margin: 0px">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <span style="color: blue">public</span> <span style="color: blue">void</span> StateIsUnknown(<span style="color: teal">Guid</span> testId)</p>
<p style="margin: 0px">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; {</p>
<p style="margin: 0px">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; _lastResult = <span style="color: blue">null</span>;</p>
<p style="margin: 0px">&nbsp;</p>
<p style="margin: 0px">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; _context.Send(</p>
<p style="margin: 0px">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <span style="color: blue">delegate</span></p>
<p style="margin: 0px">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; {</p>
<p style="margin: 0px">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; Text = Subject.Name;</p>
<p style="margin: 0px">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; RefreshImages();</p>
<p style="margin: 0px">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; }, <span style="color: blue">null</span></p>
<p style="margin: 0px">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; );</p>
<p style="margin: 0px">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; }</p>
<p style="margin: 0px">&nbsp;</p>
<p style="margin: 0px">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <span style="color: blue">public</span> <span style="color: blue">void</span> StartedRunning(<span style="color: teal">Guid</span> testId)</p>
<p style="margin: 0px">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; {</p>
<p style="margin: 0px">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; _lastResult = <span style="color: blue">null</span>;</p>
<p style="margin: 0px">&nbsp;</p>
<p style="margin: 0px">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; _context.Send(</p>
<p style="margin: 0px">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <span style="color: blue">delegate</span></p>
<p style="margin: 0px">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; {</p>
<p style="margin: 0px">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; changeIcon(<span style="color: teal">StoryTellerConstants</span>.IGNORED);</p>
<p style="margin: 0px">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; Text = Subject.Name + <span style="color: maroon">&#8221; (Running)&#8221;</span>;</p>
<p style="margin: 0px">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; }, <span style="color: blue">null</span></p>
<p style="margin: 0px">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; );</p>
<p style="margin: 0px">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; }</p>
<p>The TestNode just changes its text and icon to reflect&nbsp;the status of the Test.&nbsp; Since we&#8217;ve made it clear (I hope) that we don&#8217;t want the test execution engine to &#8220;know&#8221; about the TreeView in the main screen, and the TestNode&#8217;s certainly don&#8217;t execute the Test&#8217;s themselves, something else has to tell the ITestObserver&#8217;s about Test events.&nbsp; The &#8220;hub&#8221; for publishing and subscribing to Test events in StoryTeller is an interface called ITestEventPublisher shown below:</p>
<p>&nbsp;</p>
<div style="background: white none repeat scroll 0% 50%;font-size: 10pt;color: black;font-family: courier new">
<p style="margin: 0px">&nbsp;&nbsp;&nbsp; [<span style="color: teal">PluginFamily</span>(<span style="color: maroon">"Default"</span>, Scope = <span style="color: teal">InstanceScope</span>.Singleton)]</p>
<p style="margin: 0px">&nbsp;&nbsp;&nbsp; <span style="color: blue">public</span> <span style="color: blue">interface</span> <span style="color: teal">ITestEventPublisher</span></p>
<p style="margin: 0px">&nbsp;&nbsp;&nbsp; {</p>
<p style="margin: 0px">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <span style="color: blue">void</span> RegisterForTestEvents(<span style="color: teal">ITestObserver</span> observer, <span style="color: teal">Test</span> test);</p>
<p style="margin: 0px">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <span style="color: blue">void</span> UnRegister(<span style="color: teal">ITestObserver</span> observer, <span style="color: teal">Test</span> test);</p>
<p style="margin: 0px">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <span style="color: blue">void</span> PublishResult(<span style="color: teal">Test</span> test, <span style="color: teal">TestResult</span> result);</p>
<p style="margin: 0px">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <span style="color: blue">void</span> MarkAsQueued(<span style="color: teal">Test</span> test);</p>
<p style="margin: 0px">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <span style="color: blue">void</span> MarkAsUnknown(<span style="color: teal">Test</span> test);</p>
<p style="margin: 0px">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <span style="color: blue">void</span> MarkAsExecuting(<span style="color: teal">Test</span> Test);</p>
<p style="margin: 0px">&nbsp;</p>
<p style="margin: 0px">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <span style="color: teal">TestResult</span> GetLastResult(<span style="color: teal">Guid</span> testId);</p>
<p style="margin: 0px">&nbsp;&nbsp;&nbsp; }</p>
</div>
<p>The [PluginFamily] attribute decorating the interface is just declarative wiring configuration for <a href="http://structuremap.sourceforge.net">StructureMap</a> (you don&#8217;t have to use attributes for configuration).&nbsp; Part of the StructureMap&nbsp;configuration is to only create a single instance of ITestEventPublisher for the entire AppDomain.&nbsp;&nbsp;Anytime another class retrieves ITestEventPublisher through <a href="http://www.martinfowler.com/articles/injection.html">service location</a> or ITestEventPublisher is injected into a constructor function the&nbsp;same single instance will be returned.&nbsp; In effect, we&#8217;re just letting StructureMap handle the Singleton mechanics for us.&nbsp; It is, however, of the utmost importance to depend on the abstracted ITestEventPublisher interface rather than the concrete implementation (<a href="http://codebetter.com/blogs/jeremy.miller/archive/2005/08/04/130302.aspx">Chill out on the Singleton Fetish</a>).</p>
<p>If you&#8217;ll note the UnRegister(ITestObserver, Test) method for a second.&nbsp; In this particular case I have reasons to explicitly unregister listeners.&nbsp; In normal usage I&#8217;m having each screen unregister itself when it&#8217;s closed to make sure that the garbage collection can reclaim the screen.&nbsp; Most people&nbsp;are taking advantage of WeakReference&#8217;s to solve the garbage collection problem (if the publisher keeps a reference to each observer, the observers can not be garbage collected).</p>
<p>You&#8217;ll also note that the RegisterForTestEvents(ITestObserver, Test) method explicitly requires you to specify the Test (the event subject) that the listener is interested in.&nbsp; In this case I&#8217;m making the concrete implementation of ITestEventPublisher responsible for remembering who&#8217;s listening to which tests.&nbsp; Otherwise, you could have the publisher broadcast messages to each subscriber and just assume that the subscribers will be responsible for ignoring irrelevant events.&nbsp; I&#8217;ve never liked that approach in real&nbsp;messaging infrastructure, but I don&#8217;t see it being that big of a difference inside a single process.&nbsp; In the StoryTeller case I thought that it made the implementation simpler to make the subscribers dumb.</p>
<p>Back to registering subscribers.&nbsp; Any class that listens for test execution events needs to register itself for each test&nbsp;with the an instance of ITestEventPublisher.&nbsp; The TestNode class registers itself in it&#8217;s constructor function by retrieving the configured instance of ITestEventPublisher from StructureMap and passing itself into the RegisterForTestEvents(ITestObserver, Test) method:</p>
<p>&nbsp;</p>
<div style="background: white none repeat scroll 0% 50%;font-size: 10pt;color: black;font-family: courier new">
<p style="margin: 0px">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <span style="color: blue">public</span> TestNode(<span style="color: teal">Test</span> subject) : <span style="color: blue">base</span>(subject.Name, subject)</p>
<p style="margin: 0px">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; {</p>
<p style="margin: 0px">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <span style="color: green">// Other setup that isn&#8217;t relevant to the Event Aggregation</span></p>
<p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &#8230;</p>
<p style="margin: 0px">&nbsp;</p>
<p style="margin: 0px">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <span style="color: green">// Grab the Event Aggregator out of StructureMap and register</span></p>
<p style="margin: 0px">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <span style="color: green">// for any events related to the Subject of the node</span></p>
<p style="margin: 0px">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <span style="color: teal">ITestEventPublisher</span> publisher = <span style="color: teal">ObjectFactory</span>.GetInstance&lt;<span style="color: teal">ITestEventPublisher</span>&gt;();</p>
<p style="margin: 0px">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; publisher.RegisterForTestEvents(<span style="color: blue">this</span>, subject);</p>
<p style="margin: 0px">&nbsp;</p>
<p style="margin: 0px">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <span style="color: green">// Simple initialization</span></p>
<p style="margin: 0px">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; StateIsUnknown(subject.TestId);</p>
<p style="margin: 0px">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; }</p>
</div>
<p>If you&#8217;ve been following <a href="http://codebetter.com/blogs/scott.bellware/archive/2007/06/26/164729.aspx">Scott Bellware&#8217;s posts on dependencies</a>, you&#8217;ll recognize ITestEventPublisher as a transitive dependency of the TestNode.&nbsp; Once TestNode registers itself&nbsp;with ITestEventPublisher there&#8217;s no more need to keep a reference around.</p>
<p>The internals of the concrete TestEventPublisher aren&#8217;t particularly that complicated.&nbsp; The registered subscribers are stored in a Dictionary like this**:</p>
<div style="background: white none repeat scroll 0% 50%;font-size: 10pt;color: black;font-family: courier new">
<p style="margin: 0px">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <span style="color: blue">private</span> <span style="color: teal">Dictionary</span>&lt;<span style="color: teal">Guid</span>, <span style="color: teal">List</span>&lt;<span style="color: teal">ITestObserver</span>&gt;&gt; _observers</p>
<p style="margin: 0px">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; = <span style="color: blue">new</span> <span style="color: teal">Dictionary</span>&lt;<span style="color: teal">Guid</span>, <span style="color: teal">List</span>&lt;<span style="color: teal">ITestObserver</span>&gt;&gt;();</p>
</div>
<p>&nbsp;</p>
<p>The methods for raising events to the subscribers look like these two below.&nbsp; Just find the ITestObserver&#8217;s that are interested in a particular Test and fire the appropriate method for each subscriber.</p>
<p>&nbsp;</p>
<div style="background: white none repeat scroll 0% 50%;font-size: 10pt;color: black;font-family: courier new">
<p style="margin: 0px">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <span style="color: blue">public</span> <span style="color: blue">void</span> MarkAsQueued(<span style="color: teal">Test</span> test)</p>
<p style="margin: 0px">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; {</p>
<p style="margin: 0px">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; test.Status = <span style="color: teal">TestStatus</span>.Queued;</p>
<p style="margin: 0px">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <span style="color: blue">foreach</span> (<span style="color: teal">ITestObserver</span> observer <span style="color: blue">in</span> GetObservers(test))</p>
<p style="margin: 0px">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; {</p>
<p style="margin: 0px">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; observer.Queued(test.TestId);</p>
<p style="margin: 0px">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; }</p>
<p style="margin: 0px">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; }</p>
<p style="margin: 0px">&nbsp;</p>
<p style="margin: 0px">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <span style="color: blue">public</span> <span style="color: blue">void</span> MarkAsUnknown(<span style="color: teal">Test</span> test)</p>
<p style="margin: 0px">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; {</p>
<p style="margin: 0px">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; test.Status = <span style="color: teal">TestStatus</span>.Unknown;</p>
<p style="margin: 0px">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <span style="color: blue">foreach</span> (<span style="color: teal">ITestObserver</span> observer <span style="color: blue">in</span> GetObservers(test))</p>
<p style="margin: 0px">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; {</p>
<p style="margin: 0px">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; observer.StateIsUnknown(test.TestId);</p>
<p style="margin: 0px">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; }</p>
<p style="margin: 0px">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; }</p>
</div>
<p>&nbsp;</p>
<p>Inside of the unit tests for TestEventPublisher I use RhinoMocks to test the interaction of the TestEventPublisher with the ITestObserver&#8217;s.&nbsp; The first set of unit tests just checks that TestEventPublisher is correctly associating ITestObserver&#8217;s with the proper Test subjects (I&#8217;ll spare you the details).&nbsp; After that I wrote tests like the following that verifies that the ITestObserver.Completed(TestResult) method is fired on the correct ITestObserver&#8217;s whenever ITestEventPublisher.PublishResult(Test, TestResult) is called.</p>
<div style="background: white none repeat scroll 0% 50%;font-size: 10pt;color: black;font-family: courier new">
<p style="margin: 0px">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <span style="color: blue">private</span> <span style="color: teal">TestEventPublisher</span> setupMockedPublisher()</p>
<p style="margin: 0px">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; {</p>
<p style="margin: 0px">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <span style="color: green">// Using a Self-Mock for TestEventPublisher</span></p>
<p style="margin: 0px">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <span style="color: green">// I&#8217;ve already unit tested the GetObservers(Test) method,</span></p>
<p style="margin: 0px">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <span style="color: green">// so I&#8217;d like to remove that little wrinkle from the other tests</span></p>
<p style="margin: 0px">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <span style="color: teal">TestEventPublisher</span> publisher = _mocks.CreateMock&lt;<span style="color: teal">TestEventPublisher</span>&gt;();</p>
<p style="margin: 0px">&nbsp;</p>
<p style="margin: 0px">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <span style="color: teal">Expect</span>.Call(publisher.GetObservers(test1))</p>
<p style="margin: 0px">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; .Return(_observerArray)</p>
<p style="margin: 0px">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; .Constraints(<span style="color: blue">new</span> <span style="color: teal">Equal</span>(test1));</p>
<p style="margin: 0px">&nbsp;</p>
<p style="margin: 0px">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <span style="color: blue">return</span> publisher;</p>
<p style="margin: 0px">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; }</p>
<p style="margin: 0px">&nbsp;</p>
<p style="margin: 0px">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; [<span style="color: teal">Test</span>]</p>
<p style="margin: 0px">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <span style="color: blue">public</span> <span style="color: blue">void</span> PublishResult()</p>
<p style="margin: 0px">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; {</p>
<p style="margin: 0px">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <span style="color: teal">TestEventPublisher</span> publisher = setupMockedPublisher();</p>
<p style="margin: 0px">&nbsp;</p>
<p style="margin: 0px">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <span style="color: teal">TestResult</span> result = <span style="color: blue">new</span> <span style="color: teal">TestResult</span>();</p>
<p style="margin: 0px">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <span style="color: blue">foreach</span> (<span style="color: teal">ITestObserver</span> observer <span style="color: blue">in</span> _observerArray)</p>
<p style="margin: 0px">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; {</p>
<p style="margin: 0px">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; observer.Completed(result);</p>
<p style="margin: 0px">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; }</p>
<p style="margin: 0px">&nbsp;</p>
<p style="margin: 0px">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; _mocks.ReplayAll();</p>
<p style="margin: 0px">&nbsp;</p>
<p style="margin: 0px">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; publisher.PublishResult(test1, result);</p>
<p style="margin: 0px">&nbsp;</p>
<p style="margin: 0px">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; _mocks.VerifyAll();</p>
<p style="margin: 0px">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; }</p>
</div>
<p>&nbsp;</p>
<p>Great, we&#8217;ve got an interface for subscribers and a unit tested hub (TestEventPublisher).&nbsp; Now all we need is to actually fire off the events from the publishers.&nbsp; Instead of opting for more indirection like the CAB, I just have the publishers call methods directly on the ITestEventPublisher interface.&nbsp; Again, I think it&#8217;s simpler and&nbsp;makes the code more intention revealing (the CTRL-B factor as well).&nbsp; If you&nbsp;want more decoupling you could have the hub listen to events on the publishers and then relay and/or transform the events to the subscribers.&nbsp; </p>
<p>One way or another, the publishers get the single instance of ITestEventPublisher from StructureMap.&nbsp; The presenter for the screen that let&#8217;s you edit a Test gets a reference from <a href="http://www.picocontainer.org/Constructor+Injection">constructor injection</a>.</p>
<p>&nbsp;</p>
<div style="background: white none repeat scroll 0% 50%;font-size: 10pt;color: black;font-family: courier new">
<p style="margin: 0px">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <span style="color: blue">public</span> TestEditorPresenter(<span style="color: teal">ITestView</span> view, <span style="color: teal">ITestFormatConverter</span> converter, <span style="color: teal">ITestEventPublisher</span> publisher,</p>
<p style="margin: 0px">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp; <span style="color: teal">ICommandExecutor</span> executor)</p>
<p style="margin: 0px">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; : <span style="color: blue">base</span>(view, converter)</p>
<p style="margin: 0px">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; {</p>
<p style="margin: 0px">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; _publisher = publisher;</p>
<p style="margin: 0px">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; _executor = executor;</p>
<p style="margin: 0px">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; }</p>
</div>
<p>The publisher I want to look at is called ExecutionEngine.&nbsp; Internally, it&#8217;s responsible for managing and coordinating&nbsp;the workflow of running tests.&nbsp; In this case ITestEventPublisher is a transparent dependency that ExecutionEngine interacts with throughout it&#8217;s lifetime.</p>
<p>&nbsp;</p>
<div style="background: white none repeat scroll 0% 50%;font-size: 10pt;color: black;font-family: courier new">
<p style="margin: 0px">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <span style="color: blue">public</span> ExecutionEngine(<span style="color: teal">ITestRunner</span> runner, <span style="color: teal">IComponentAnalyzer</span>[] analyzers, <span style="color: teal">ITestEventPublisher</span> publisher)</p>
<p style="margin: 0px">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; {</p>
<p style="margin: 0px">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; _runner = runner;</p>
<p style="margin: 0px">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; _analyzers = analyzers;</p>
<p style="margin: 0px">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; _publisher = publisher;</p>
<p style="margin: 0px">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; }</p>
</div>
<div style="background: white none repeat scroll 0% 50%;font-size: 10pt;color: black;font-family: courier new">&nbsp;</div>
<p>Deep inside of ExecutionEngine it has a private method that actually executes a batch of tests.&nbsp; </p>
<p><font face="Courier New" size="2"></font>&nbsp;</p>
<div style="background: white none repeat scroll 0% 50%;font-size: 10pt;color: black;font-family: courier new">
<p style="margin: 0px">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <span style="color: blue">private</span> <span style="color: teal">List</span>&lt;<span style="color: teal">TestResult</span>&gt; executeTests(<span style="color: teal">Test</span>[] tests)</p>
<p style="margin: 0px">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; {</p>
<p style="margin: 0px">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <span style="color: teal">List</span>&lt;<span style="color: teal">TestResult</span>&gt; list = <span style="color: blue">new</span> <span style="color: teal">List</span>&lt;<span style="color: teal">TestResult</span>&gt;();</p>
<p style="margin: 0px">&nbsp;</p>
<p style="margin: 0px">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <span style="color: blue">foreach</span> (<span style="color: teal">Test</span> test <span style="color: blue">in</span> tests)</p>
<p style="margin: 0px">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; {</p>
<p style="margin: 0px">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <span style="color: teal">Console</span>.WriteLine(<span style="color: maroon">&#8220;Running Test &#8220;</span> + test.GetFullPath());</p>
<p style="margin: 0px">&nbsp;</p>
<p style="margin: 0px">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; _publisher.MarkAsExecuting(test);</p>
<p style="margin: 0px">&nbsp;</p>
<p style="margin: 0px">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <span style="color: teal">TestResult</span> result = _runner.ExecuteTest(test);</p>
<p style="margin: 0px">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; list.Add(result);</p>
<p style="margin: 0px">&nbsp;</p>
<p style="margin: 0px">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; _publisher.PublishResult(test, result);</p>
<p style="margin: 0px">&nbsp;</p>
<p style="margin: 0px">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <span style="color: teal">Console</span>.WriteLine(<span style="color: maroon">&#8220;&nbsp; &#8220;</span> + result.Counts.ToString());</p>
<p style="margin: 0px">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; }</p>
<p style="margin: 0px">&nbsp;</p>
<p style="margin: 0px">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <span style="color: blue">return</span> list;</p>
<p style="margin: 0px">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; }</p>
</div>
<p>ExecutionEngine calls the ITestEventPublisher.MarkAsExecuting(Test) method just before executing a Test and publishes the result afterwards with the ITestEventPublisher.PublishResult(Test, TestResult) method to let the subscribers know that an individual test is finished.&nbsp; This is important functionality.&nbsp; The StoryTeller tests can often be slow to execute because they&#8217;re usually integration tests, and it&#8217;s very handy to both give some UI cues about the progress and also allow the user to begin reviewing the test&nbsp;results while the remaining tests execute.&nbsp; It&#8217;s a huge advantage over the FitNesse Wiki tool that I&#8217;m trying to replace with StoryTeller.&nbsp;</p>
<p>Part of the unit test for running a batch of tests is shown below.&nbsp; I&#8217;m using RhinoMocks &#8220;ordered&#8221; mode to validate that the interactions happen in the correct order.</p>
<p>&nbsp;</p>
<div style="background: white none repeat scroll 0% 50%;font-size: 10pt;color: black;font-family: courier new">
<p style="margin: 0px">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <span style="color: blue">using</span> (mocks.Ordered())</p>
<p style="margin: 0px">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; {</p>
<p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: teal">// Other stuff</span></p>
<p style="margin: 0px">&nbsp;</p>
<p style="margin: 0px">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; publisher.MarkAsExecuting(test1);</p>
<p style="margin: 0px">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <span style="color: teal">Expect</span>.Call(runner.ExecuteTest(test1)).Return(result1).Constraints(<span style="color: blue">new</span> <span style="color: teal">Equal</span>(test1));</p>
<p style="margin: 0px">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; publisher.PublishResult(test1, result1);</p>
<p style="margin: 0px">&nbsp;</p>
<p style="margin: 0px">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; publisher.MarkAsExecuting(test2);</p>
<p style="margin: 0px">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <span style="color: teal">Expect</span>.Call(runner.ExecuteTest(test2)).Return(result2).Constraints(<span style="color: blue">new</span> <span style="color: teal">Equal</span>(test2));</p>
<p style="margin: 0px">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; publisher.PublishResult(test2, result2);</p>
<p style="margin: 0px">&nbsp;</p>
<p style="margin: 0px">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; publisher.MarkAsExecuting(test3);</p>
<p style="margin: 0px">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <span style="color: teal">Expect</span>.Call(runner.ExecuteTest(test3)).Return(result3).Constraints(<span style="color: blue">new</span> <span style="color: teal">Equal</span>(test3));</p>
<p style="margin: 0px">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; publisher.PublishResult(test3, result3);</p>
<p style="margin: 0px">&nbsp;</p>
<p style="margin: 0px">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; publisher.MarkAsExecuting(test4);</p>
<p style="margin: 0px">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <span style="color: teal">Expect</span>.Call(runner.ExecuteTest(test4)).Return(result4).Constraints(<span style="color: blue">new</span> <span style="color: teal">Equal</span>(test4));</p>
<p style="margin: 0px">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; publisher.PublishResult(test4, result4);</p>
<p style="margin: 0px">&nbsp;</p>
<p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; // Other Stuff</p>
<p style="margin: 0px">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; }</p>
</div>
<p>&nbsp;</p>
<p>So far I&#8217;d say that the TestEventPublisher design&nbsp;has worked out rather well.&nbsp; The one issue I didn&#8217;t mention was thread synchronization as the TestEventPublisher could easily be running in a background thread instead of the UI thread.&nbsp; I&#8217;ll leave that solution up to you dear reader;)&nbsp; On a serious note, do be aware of the thread synchronization issue here.</p>
<p>The rest of the code for the Event Aggregation in StoryTeller can be found in the Subversion trunk here:&nbsp; <a href="http://storyteller.tigris.org/svn/storyteller/trunk/src" title="http://storyteller.tigris.org/svn/storyteller/trunk/src">http://storyteller.tigris.org/svn/storyteller/trunk/src</a>.</p>
<h4>More Resources</h4>
<p>Besides the ever useful <a href="http://www.martinfowler.com">www.martinfowler.com</a> site, check out these resources for different approaches to Event Aggregation:</p>
<ul>
<li><a href="http://blogs.msdn.com/edjez/archive/2005/04/20/CABEventBroker101.aspx">CAB -Event Broker: Pub-Sub for your components</a></li>
<li><a href="http://magmasystems.blogspot.com/2006/12/cab-eventbroker-and-wildcards.html">Marc Adler on building an Event Broker</a></li>
</ul>
<p>&nbsp;</p>
<h4>Next</h4>
<p>The next post is a closely related followup to this post on the &#8220;Latch&#8221; strategy for controlling event rippling.</p>
<p>&nbsp;</p>
<p>&nbsp;</p>
<p>* Immediately following a successful project that had me working about 4 out of 5 weekends for almost six months.&nbsp; I&#8217;d say that it was a justified at work vacation except that it was mostly due to managerial malfeasance.&nbsp; My &#8220;official&#8221; and measurable&nbsp;output for about three months was a couple sentences in a current state analysis document.&nbsp; Almost verbatim:&nbsp; &#8220;Every process runs under the admin account.&nbsp; There is no security.&#8221;</p>
<p>** C# 3.0 type inference anyone?&nbsp; Seriously.&nbsp; I love the newer, more powerful language features of C# 2.0, but in some ways it&#8217;s been a huge step backwards in terms of code aesthetics.&nbsp; I&#8217;m feeling like C# 2.0 was really just the beta for 3.0.</p>
											</div><!-- .entry-content -->

					<div id="entry-author-info">
						<div id="author-avatar">
							<img alt='' src='http://1.gravatar.com/avatar/db65c5c5cf9f1c51e842f733892eace1?s=60&amp;d=http%3A%2F%2F1.gravatar.com%2Favatar%2Fad516503a11cd5ca435acc9bb6523536%3Fs%3D60&amp;r=G' class='avatar avatar-60 photo' height='60' width='60' />						</div><!-- #author-avatar 	-->
						<div id="author-description">
							<h2>About Jeremy Miller</h2>
							Jeremy is the Chief Software Architect at Dovetail Software, the coolest ISV in Austin.  Jeremy began his IT career writing "Shadow IT" applications to automate his engineering documentation, then wandered into software development because it looked like more fun. Jeremy is the author of the open source StructureMap tool for Dependency Injection with .Net, StoryTeller for supercharged acceptance testing in .Net, and one of the principal developers behind FubuMVC.  Jeremy's thoughts on all things software can be found at The Shade Tree Developer at http://codebetter.com/jeremymiller.							<div id="author-link">
								<a href="http://codebetter.com/jeremymiller/author/jeremymiller/" title="View all posts by Jeremy Miller">View all posts by Jeremy Miller &rarr;</a>
							</div><!-- #author-link	-->
						</div><!-- #author-description	-->
					</div><!-- .entry-author-info -->

					<div class="entry-utility">
					This entry was posted in <a href="http://codebetter.com/jeremymiller/category/build-your-own-cab/" title="View all posts in Build your own CAB" rel="category tag">Build your own CAB</a>, <a href="http://codebetter.com/jeremymiller/category/design-patterns/" title="View all posts in Design Patterns" rel="category tag">Design Patterns</a>, <a href="http://codebetter.com/jeremymiller/category/storyteller/" title="View all posts in StoryTeller" rel="category tag">StoryTeller</a>. Bookmark the <a href="http://codebetter.com/jeremymiller/2007/06/29/build-your-own-cab-11-event-aggregator/" title="Permalink to Build your own CAB #11 &#8211; Event Aggregator" rel="bookmark">permalink</a>. Follow any comments here with the <a href="http://codebetter.com/jeremymiller/2007/06/29/build-your-own-cab-11-event-aggregator/feed/" title="Comments RSS to Build your own CAB #11 &#8211; Event Aggregator" rel="alternate" type="application/rss+xml">RSS feed for this post</a>.
					</div><!-- .entry-utility -->
				</div><!-- #post-370 -->

				<div id="nav-below" class="navigation">
					<div class="nav-previous"><a href="http://codebetter.com/jeremymiller/2007/06/29/designing-for-testability/" rel="prev"><span class="meta-nav">&larr;</span> Designing for Testability</a></div>
					<div class="nav-next"><a href="http://codebetter.com/jeremymiller/2007/07/02/build-your-own-cab-12-rein-in-runaway-events-with-the-quot-latch-quot/" rel="next">Build your own CAB #12 &#8211; Rein in runaway events with the &quot;Latch&quot; <span class="meta-nav">&rarr;</span></a></div>
				</div><!-- #nav-below -->

				
<div id="disqus_thread">
					<div id="dsq-content">
			<ul id="dsq-comments">
					<li id="dsq-comment-2262">
					<div id="dsq-comment-header-2262" class="dsq-comment-header">
						<cite id="dsq-cite-2262">
	http://blog.ddpruitt.net							<span id="dsq-author-user-2262">darren</span>
							</cite>
					</div>
					<div id="dsq-comment-body-2262" class="dsq-comment-body">
						<div id="dsq-comment-message-2262" class="dsq-comment-message"><p>You should collect the BYOC articles into a PDF and sell it on Lulu.com.  </p>
<p>Great stuff!</p>
</div>
					</div>
				</li>
					<li id="dsq-comment-2263">
					<div id="dsq-comment-header-2263" class="dsq-comment-header">
						<cite id="dsq-cite-2263">
	http://www,bellware.net							<span id="dsq-author-user-2263">ScottBellware</span>
							</cite>
					</div>
					<div id="dsq-comment-body-2263" class="dsq-comment-body">
						<div id="dsq-comment-message-2263" class="dsq-comment-message"><p>> You should collect the BYOC articles into a PDF and sell it on Lulu.com</p>
<p>I completely, utterly, and vociferously second that motion.  I would love to take these posts to my hammock and try to catch up on them.  Jeremy, please take this suggestion seriously, and please make it happen soon, My laptop sucks on the hammock, and these posts are far to detailed for reading on my mobile phone.</p>
</div>
					</div>
				</li>
					<li id="dsq-comment-2264">
					<div id="dsq-comment-header-2264" class="dsq-comment-header">
						<cite id="dsq-cite-2264">
	http://www.albahari.com							<span id="dsq-author-user-2264">Joe Albahari</span>
							</cite>
					</div>
					<div id="dsq-comment-body-2264" class="dsq-comment-body">
						<div id="dsq-comment-message-2264" class="dsq-comment-message"><p>Regarding your comment about type inference in C# 3.0 (I assume you meant implicit typing) I agree with you 100%. Writing  </p>
<p>Dictionary<guid , List<ITestObserver>></p>
<p>twice does nothing for readability. Such constructor calls are so much cleaner with var.</guid></p>
</div>
					</div>
				</li>
					<li id="dsq-comment-2265">
					<div id="dsq-comment-header-2265" class="dsq-comment-header">
						<cite id="dsq-cite-2265">
	http://www.ayende.com/Blog/							<span id="dsq-author-user-2265">Ayende Rahien</span>
							</cite>
					</div>
					<div id="dsq-comment-body-2265" class="dsq-comment-body">
						<div id="dsq-comment-message-2265" class="dsq-comment-message"><p>Jeremy,<br />
Why are you using:</p>
<p>Expect.Call(runner.ExecuteTest(test1))<br />
   .Return(result1).Constraints(new Equal(test1));</p>
<p>This is equivalent:</p>
<p>Expect.Call(runner.ExecuteTest(test1))<br />
  .Return(result1).Constraints(Is.Equal(test1));</p>
<p>And since it is the default behavior, you can get it down to:<br />
Expect.Call(runner.ExecuteTest(test1)).Return(result1);</p>
</div>
					</div>
				</li>
					<li id="dsq-comment-2266">
					<div id="dsq-comment-header-2266" class="dsq-comment-header">
						<cite id="dsq-cite-2266">
	http://udidahan.weblogs.us							<span id="dsq-author-user-2266">Udi Dahan</span>
							</cite>
					</div>
					<div id="dsq-comment-body-2266" class="dsq-comment-body">
						<div id="dsq-comment-message-2266" class="dsq-comment-message"><p>I don&#8217;t like the single event aggregator idea as much as specific commands containing specific arguments. Take a look here to see how we can create generic command handlers and how much better refactored the code becomes:</p>
<p><a href="http://udidahan.weblogs.us/2006/08/04/polymorphism-and-the-switch-statement/" rel="nofollow">http://udidahan.weblogs.us/2006/08/04/polymorphism-and-the-switch-statement/</a></p>
</div>
					</div>
				</li>
					<li id="dsq-comment-2267">
					<div id="dsq-comment-header-2267" class="dsq-comment-header">
						<cite id="dsq-cite-2267">
								<span id="dsq-author-user-2267">AndyT</span>
							</cite>
					</div>
					<div id="dsq-comment-body-2267" class="dsq-comment-body">
						<div id="dsq-comment-message-2267" class="dsq-comment-message"><p>Apologies for going slightly off-topic here: It looks to me like you are using StructureMap in your framework to do the same job as the CAB ObjectBuilder. Is this correct? Could you comment on this?</p>
</div>
					</div>
				</li>
					<li id="dsq-comment-2268">
					<div id="dsq-comment-header-2268" class="dsq-comment-header">
						<cite id="dsq-cite-2268">
	http://codebetter.com/blogs/jeremy.miller							<span id="dsq-author-user-2268">Jeremy D. Miller</span>
							</cite>
					</div>
					<div id="dsq-comment-body-2268" class="dsq-comment-body">
						<div id="dsq-comment-message-2268" class="dsq-comment-message"><p>@AndyT,</p>
<p>I&#8217;m the primary author of StructureMap, and I&#8217;ve worked on it off and on for 4+ years, so therefore, nothing I would say about StructureMap vis a vis ObjectBuilder should be taken very seriously.</p>
<p>But yes, the fact that CAB mandates the usage of ObjectBuilder is a strike against it in my eyes.  But again, can you take my biased opinion very seriously?</p>
</div>
					</div>
				</li>
					<li id="dsq-comment-2269">
					<div id="dsq-comment-header-2269" class="dsq-comment-header">
						<cite id="dsq-cite-2269">
								<span id="dsq-author-user-2269">Rob Cecil</span>
							</cite>
					</div>
					<div id="dsq-comment-body-2269" class="dsq-comment-body">
						<div id="dsq-comment-message-2269" class="dsq-comment-message"><p>Dude, everytime I read your blog, i think that RedGate Guy is you&#8230; You need to move that ad somewhere else &#8230; <img src='http://cdn1.codebetter.com/wp-includes/images/smilies/icon_smile.gif' alt=':)' class='wp-smiley' /> </p>
<p>I tried to hit  <a href="http://storyteller.tigris.org/svn/storyteller/trunk/src" rel="nofollow">http://storyteller.tigris.org/svn/storyteller/trunk/src</a><br />
 but I get challenged with u/p. How do I access the code??</p>
<p>Thanks </p>
<p>Rob Cecil</p>
</div>
					</div>
				</li>
					<li id="dsq-comment-2270">
					<div id="dsq-comment-header-2270" class="dsq-comment-header">
						<cite id="dsq-cite-2270">
								<span id="dsq-author-user-2270">Oswaldo</span>
							</cite>
					</div>
					<div id="dsq-comment-body-2270" class="dsq-comment-body">
						<div id="dsq-comment-message-2270" class="dsq-comment-message"><p>Thanks Jeremy, This series is great and this article helped me a lot in my current project.<br />
Great stuff.</p>
</div>
					</div>
				</li>
					<li id="dsq-comment-2271">
					<div id="dsq-comment-header-2271" class="dsq-comment-header">
						<cite id="dsq-cite-2271">
	http://jroller.com/mrettig/							<span id="dsq-author-user-2271">Mike Rettig</span>
							</cite>
					</div>
					<div id="dsq-comment-body-2271" class="dsq-comment-body">
						<div id="dsq-comment-message-2271" class="dsq-comment-message"><p>Retlang is a pub/sub library designed specifically for the problems addressed in this article. </p>
<p><a href="http://code.google.com/p/retlang/" rel="nofollow">http://code.google.com/p/retlang/</a></p>
<p>It can serve as an event aggregator as well as handling all threading concerns. </p>
<p>Mike<br />
Retlang Developer</p>
</div>
					</div>
				</li>
					<li id="dsq-comment-2272">
					<div id="dsq-comment-header-2272" class="dsq-comment-header">
						<cite id="dsq-cite-2272">
								<span id="dsq-author-user-2272">Boxout</span>
							</cite>
					</div>
					<div id="dsq-comment-body-2272" class="dsq-comment-body">
						<div id="dsq-comment-message-2272" class="dsq-comment-message"><p>Please help me download the source code. The SVN asked for username&#038;password. Unfotunately I don&#8217;t have an account.</p>
<p>Where I could created an account to download the source code? </p>
<p>Thanks in advance.</p>
</div>
					</div>
				</li>
				</ul>
		</div>
	</div>

<a href="http://disqus.com" class="dsq-brlink">blog comments powered by <span class="logo-disqus">Disqus</span></a>

<script type="text/javascript">
/* <![CDATA[ */
	var disqus_url = 'http://codebetter.com/jeremymiller/2007/06/29/build-your-own-cab-11-event-aggregator/ ';
	var disqus_identifier = '370 /blogs/jeremy.miller/archive/2007/06/29/build-your-own-cab-11-event-aggregator.aspx';
	var disqus_container_id = 'disqus_thread';
	var disqus_domain = 'disqus.com';
	var disqus_shortname = 'theshadetreedeveloper';
	var disqus_title = "Build your own CAB #11 &#8211; Event Aggregator";
		var disqus_config = function () {
	    var config = this; // Access to the config object

	    /* 
	       All currently supported events:
	        * preData  fires just before we request for initial data
	        * preInit - fires after we get initial data but before we load any dependencies
	        * onInit  - fires when all dependencies are resolved but before dtpl template is rendered
	        * afterRender - fires when template is rendered but before we show it
	        * onReady - everything is done
	     */

		config.callbacks.preData.push(function() {
			// clear out the container (its filled for SEO/legacy purposes)
			document.getElementById(disqus_container_id).innerHTML = '';
		});
				config.callbacks.onReady.push(function() {
			// sync comments in the background so we don't block the page
			DISQUS.request.get('?cf_action=sync_comments&post_id=370');
		});
					};
	var facebookXdReceiverPath = 'http://cdn1.codebetter.com/wp-content/plugins/disqus-comment-system/xd_receiver.htm';
/* ]]> */
</script>

<script type="text/javascript">
/* <![CDATA[ */
	var DsqLocal = {
		'trackbacks': [
		],
		'trackback_url': "http:\/\/codebetter.com\/jeremymiller\/2007\/06\/29\/build-your-own-cab-11-event-aggregator\/trackback\/"	};
/* ]]> */
</script>

<script type="text/javascript">
/* <![CDATA[ */
(function() {
	var dsq = document.createElement('script'); dsq.type = 'text/javascript';
	dsq.async = true;
	dsq.src = 'http://' + disqus_shortname + '.' + disqus_domain + '/embed.js?pname=wordpress&pver=2.61';
	(document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();
/* ]]> */
</script>

		</div><!-- #main -->
			<div id="sidebar" class="grid_4">

		<div id="primary" class="widget-area">
			<ul class="xoxo">
				<div class="ad-container">
					<a target="_blank" href="http://www.red-gate.com/products/dotnet-development/ants-performance-profiler/entrypage/version-6-new-features?utm_source=cb&utm_medium=button&utm_term=4328&utm_content=app6release&utm_campaign=antsperformanceprofiler"><img width="125" height="125" border="0" title="" alt="" src="http://s3.amazonaws.com/CodeBetter/Creative/ANTSPP5_125x125_M1.gif"></a>
					<embed width="125" height="125" flashvars="clickTARGET=_blank&amp;clickTAG=http%3A%2F%2Fd1.openx.org%2Fck.php%3Foaparams%3D2__bannerid%3D62753__zoneid%3D29419__cb%3Da0471ce5e8__r_id%3Dd42118811971f057012db20aa261c5c1__r_ts%3Dldef6x__oadest%3Dhttp%253A%252F%252Fwww.jetbrains.com%252Fresharper%252F%253Frs4cb125" allowscriptaccess="always" quality="high" name="Advertisement" id="Advertisement" style="" src="http://s3.amazonaws.com/CodeBetter/Creative/tc_125x125_simple2.swf" type="application/x-shockwave-flash">
				</div>
			
				<li id="user_bio-2" class="widget-container widget_user_bio"><h3 class="widget-title">The Shade Tree Developer</h3>Jeremy is the Chief Software Architect at Dovetail Software, the coolest ISV in Austin.  Jeremy began his IT career writing "Shadow IT" applications to automate his engineering documentation, then wandered into software development because it looked like more fun. Jeremy is the author of the open source StructureMap tool for Dependency Injection with .Net, StoryTeller for supercharged acceptance testing in .Net, and one of the principal developers behind FubuMVC.  Jeremy's thoughts on all things software can be found at The Shade Tree Developer at http://codebetter.com/jeremymiller.
</li><li id="text-3" class="widget-container widget_text"><h3 class="widget-title">Upcoming posts&#8230;</h3>			<div class="textwidget"><p>How I'm using StoryTeller to test FubuMVC<br />
Building a "Lookup" html convention w/ FubuMVC<br />
FubuMVC's Configuration Model "Special Sauce"<br />
Managing Script dependencies with FubuMVC<br />
Authorization and FubuMVC<br />
Continuations<br />
Composing Views with FubuMVC<br />
Extensible Model Binding with FubuMVC<br />
Introducing "Bottles"<br />
Modular Packaging with FubuMVC<br />
Self-Installing Apps w/ FubuMVC<br />
Routing and Behavioral Conventions with FubuMVC<br />
What Should I Learn?</p>
</div>
		</li><li id="linkcat-1046" class="widget-container widget_links"><h3 class="widget-title">Blogroll</h3>
	<ul class='xoxo blogroll'>
<li><a href="http://twitter.com/jeremydmiller">Follow me on Twitter</a></li>
<li><a href="https://github.com/DarthFubuMVC/fubumvc" target="_blank">FubuMVC on GitHub</a></li>
<li><a href="https://github.com/jeremydmiller">My GitHub Page</a></li>
<li><a href="https://github.com/storyteller/storyteller">StoryTeller on GitHub</a></li>
<li><a href="https://github.com/structuremap/structuremap">StructureMap on GitHub</a></li>

	</ul>
</li>
		
						
			</ul>
			
		</div><!-- #primary .widget-area -->
		
		<div id="secondary" class="widget-area">
				<script type="text/javascript" src="http://engine.theloungenet.com/z/15/adzerk1_2_5"></script>
				<div id="adzerk1"></div>
				
				<ul class="xoxo">		
					<li id="archives-2" class="widget-container widget_archive"><h3 class="widget-title">Archives</h3>		<ul>
			<li><a href='http://codebetter.com/jeremymiller/2011/01/' title='January 2011'>January 2011</a></li>
	<li><a href='http://codebetter.com/jeremymiller/2010/12/' title='December 2010'>December 2010</a></li>
	<li><a href='http://codebetter.com/jeremymiller/2010/09/' title='September 2010'>September 2010</a></li>
	<li><a href='http://codebetter.com/jeremymiller/2010/08/' title='August 2010'>August 2010</a></li>
	<li><a href='http://codebetter.com/jeremymiller/2010/07/' title='July 2010'>July 2010</a></li>
	<li><a href='http://codebetter.com/jeremymiller/2010/06/' title='June 2010'>June 2010</a></li>
	<li><a href='http://codebetter.com/jeremymiller/2010/05/' title='May 2010'>May 2010</a></li>
	<li><a href='http://codebetter.com/jeremymiller/2010/03/' title='March 2010'>March 2010</a></li>
	<li><a href='http://codebetter.com/jeremymiller/2010/02/' title='February 2010'>February 2010</a></li>
	<li><a href='http://codebetter.com/jeremymiller/2010/01/' title='January 2010'>January 2010</a></li>
	<li><a href='http://codebetter.com/jeremymiller/2009/12/' title='December 2009'>December 2009</a></li>
	<li><a href='http://codebetter.com/jeremymiller/2009/11/' title='November 2009'>November 2009</a></li>
	<li><a href='http://codebetter.com/jeremymiller/2009/10/' title='October 2009'>October 2009</a></li>
	<li><a href='http://codebetter.com/jeremymiller/2009/09/' title='September 2009'>September 2009</a></li>
	<li><a href='http://codebetter.com/jeremymiller/2009/08/' title='August 2009'>August 2009</a></li>
	<li><a href='http://codebetter.com/jeremymiller/2009/07/' title='July 2009'>July 2009</a></li>
	<li><a href='http://codebetter.com/jeremymiller/2009/06/' title='June 2009'>June 2009</a></li>
	<li><a href='http://codebetter.com/jeremymiller/2009/05/' title='May 2009'>May 2009</a></li>
	<li><a href='http://codebetter.com/jeremymiller/2009/04/' title='April 2009'>April 2009</a></li>
	<li><a href='http://codebetter.com/jeremymiller/2009/03/' title='March 2009'>March 2009</a></li>
	<li><a href='http://codebetter.com/jeremymiller/2009/02/' title='February 2009'>February 2009</a></li>
	<li><a href='http://codebetter.com/jeremymiller/2009/01/' title='January 2009'>January 2009</a></li>
	<li><a href='http://codebetter.com/jeremymiller/2008/12/' title='December 2008'>December 2008</a></li>
	<li><a href='http://codebetter.com/jeremymiller/2008/11/' title='November 2008'>November 2008</a></li>
	<li><a href='http://codebetter.com/jeremymiller/2008/10/' title='October 2008'>October 2008</a></li>
	<li><a href='http://codebetter.com/jeremymiller/2008/09/' title='September 2008'>September 2008</a></li>
	<li><a href='http://codebetter.com/jeremymiller/2008/08/' title='August 2008'>August 2008</a></li>
	<li><a href='http://codebetter.com/jeremymiller/2008/07/' title='July 2008'>July 2008</a></li>
	<li><a href='http://codebetter.com/jeremymiller/2008/06/' title='June 2008'>June 2008</a></li>
	<li><a href='http://codebetter.com/jeremymiller/2008/05/' title='May 2008'>May 2008</a></li>
	<li><a href='http://codebetter.com/jeremymiller/2008/04/' title='April 2008'>April 2008</a></li>
	<li><a href='http://codebetter.com/jeremymiller/2008/03/' title='March 2008'>March 2008</a></li>
	<li><a href='http://codebetter.com/jeremymiller/2008/02/' title='February 2008'>February 2008</a></li>
	<li><a href='http://codebetter.com/jeremymiller/2008/01/' title='January 2008'>January 2008</a></li>
	<li><a href='http://codebetter.com/jeremymiller/2007/12/' title='December 2007'>December 2007</a></li>
	<li><a href='http://codebetter.com/jeremymiller/2007/11/' title='November 2007'>November 2007</a></li>
	<li><a href='http://codebetter.com/jeremymiller/2007/10/' title='October 2007'>October 2007</a></li>
	<li><a href='http://codebetter.com/jeremymiller/2007/09/' title='September 2007'>September 2007</a></li>
	<li><a href='http://codebetter.com/jeremymiller/2007/08/' title='August 2007'>August 2007</a></li>
	<li><a href='http://codebetter.com/jeremymiller/2007/07/' title='July 2007'>July 2007</a></li>
	<li><a href='http://codebetter.com/jeremymiller/2007/06/' title='June 2007'>June 2007</a></li>
	<li><a href='http://codebetter.com/jeremymiller/2007/05/' title='May 2007'>May 2007</a></li>
	<li><a href='http://codebetter.com/jeremymiller/2007/04/' title='April 2007'>April 2007</a></li>
	<li><a href='http://codebetter.com/jeremymiller/2007/03/' title='March 2007'>March 2007</a></li>
	<li><a href='http://codebetter.com/jeremymiller/2007/02/' title='February 2007'>February 2007</a></li>
	<li><a href='http://codebetter.com/jeremymiller/2007/01/' title='January 2007'>January 2007</a></li>
	<li><a href='http://codebetter.com/jeremymiller/2006/12/' title='December 2006'>December 2006</a></li>
	<li><a href='http://codebetter.com/jeremymiller/2006/11/' title='November 2006'>November 2006</a></li>
	<li><a href='http://codebetter.com/jeremymiller/2006/10/' title='October 2006'>October 2006</a></li>
	<li><a href='http://codebetter.com/jeremymiller/2006/09/' title='September 2006'>September 2006</a></li>
	<li><a href='http://codebetter.com/jeremymiller/2006/08/' title='August 2006'>August 2006</a></li>
	<li><a href='http://codebetter.com/jeremymiller/2006/07/' title='July 2006'>July 2006</a></li>
	<li><a href='http://codebetter.com/jeremymiller/2006/06/' title='June 2006'>June 2006</a></li>
	<li><a href='http://codebetter.com/jeremymiller/2006/05/' title='May 2006'>May 2006</a></li>
	<li><a href='http://codebetter.com/jeremymiller/2006/04/' title='April 2006'>April 2006</a></li>
	<li><a href='http://codebetter.com/jeremymiller/2006/03/' title='March 2006'>March 2006</a></li>
	<li><a href='http://codebetter.com/jeremymiller/2006/02/' title='February 2006'>February 2006</a></li>
	<li><a href='http://codebetter.com/jeremymiller/2006/01/' title='January 2006'>January 2006</a></li>
	<li><a href='http://codebetter.com/jeremymiller/2005/12/' title='December 2005'>December 2005</a></li>
	<li><a href='http://codebetter.com/jeremymiller/2005/11/' title='November 2005'>November 2005</a></li>
	<li><a href='http://codebetter.com/jeremymiller/2005/10/' title='October 2005'>October 2005</a></li>
	<li><a href='http://codebetter.com/jeremymiller/2005/09/' title='September 2005'>September 2005</a></li>
	<li><a href='http://codebetter.com/jeremymiller/2005/08/' title='August 2005'>August 2005</a></li>
	<li><a href='http://codebetter.com/jeremymiller/2005/07/' title='July 2005'>July 2005</a></li>
	<li><a href='http://codebetter.com/jeremymiller/2005/06/' title='June 2005'>June 2005</a></li>
	<li><a href='http://codebetter.com/jeremymiller/2005/05/' title='May 2005'>May 2005</a></li>
	<li><a href='http://codebetter.com/jeremymiller/2005/04/' title='April 2005'>April 2005</a></li>
		</ul>
</li><li id="recent-comments-3" class="widget-container widget_recent_comments"><h3 class="widget-title">What others have said&#8230;</h3><ul id="recentcomments"><li class="recentcomments"><a href='http://topsy.com/codebetter.com/jeremymiller/2011/01/28/announcing-the-new-atx-code-lunch/?utm_source=pingback&amp;utm_campaign=L2' rel='external nofollow' class='url'>Tweets that mention Announcing the new ATX Code Lunch | Jeremy D. Miller -- Topsy.com</a> on <a href="http://codebetter.com/jeremymiller/2011/01/28/announcing-the-new-atx-code-lunch/#comment-6765">Announcing the new ATX Code Lunch</a></li><li class="recentcomments"><a href='http://weblogs.asp.net/thangchung' rel='external nofollow' class='url'>thangchung</a> on <a href="http://codebetter.com/jeremymiller/2009/01/16/quot-buildup-quot-existing-objects-with-structuremap/#comment-6764">&quot;BuildUp&quot; Existing Objects with StructureMap</a></li><li class="recentcomments">Steven Gentile on <a href="http://codebetter.com/jeremymiller/2011/01/23/if-you-are-using-structuremap-with-mvc3-please-read-this/#comment-6763">If you are using StructureMap with MVC3, please read this:</a></li><li class="recentcomments">jabits on <a href="http://codebetter.com/jeremymiller/2011/01/16/a-train-of-thought-wrapping-up-codemash-2011/#comment-6761">A Train of Thought &ndash; Wrapping up CodeMash 2011</a></li><li class="recentcomments">Michael Meadows on <a href="http://codebetter.com/jeremymiller/2011/01/16/a-train-of-thought-wrapping-up-codemash-2011/#comment-6754">A Train of Thought &ndash; Wrapping up CodeMash 2011</a></li></ul></li>				</ul>	
				
				<a target="_blank" href="http://www.red-gate.com/products/dotnet-development/ants-performance-profiler/entrypage/version-6-csharp?utm_source=cb&utm_medium=rectangle&utm_term=4327&utm_content=app6release&utm_campaign=antsperformanceprofiler"><img width="300" height="250" border="0" title="" alt="" src="http://s3.amazonaws.com/CodeBetter/Creative/APP6_Launch_C%23_Jun10_300x250_M1.gif?AWSAccessKeyId=0KMA35HT86EVXB99Z302&amp;Expires=1458095516&amp;Signature=BIBDilUaLnZe1uKfVKyyTBxr%2BvE%3D"></a>
				
		</div><!-- #secondary .widget-area -->			</div><!--sidebar-->
		</div><!-- #container -->
</div><!-- end div tabs see header.php -->
	
	<div id="footer">
		<div class="container_12">
		<div id="footer-widget-area">
				<div class="grid_4">					
					<ul>
					<li><a href="http://codebetter.com" title="home">Home</a></li>
					<li class="page_item page-item-2"><a href="http://codebetter.com/about/" title="About">About</a></li>
<li class="page_item page-item-8"><a href="http://codebetter.com/codebetter-ci/" title="CodeBetter CI">CodeBetter CI</a></li>
<li class="page_item page-item-6"><a href="http://codebetter.com/community/" title="Community">Community</a></li>
<li class="page_item page-item-10"><a href="http://codebetter.com/editors/" title="Editors">Editors</a></li>
<li class="page_item page-item-41"><a href="http://codebetter.com/globalsearch/" title="Search Results">Search Results</a></li>
					<li><a href="http://feeds.feedburner.com/CodeBetter" rel="alternate" type="application/rss+xml"><img src="http://www.feedburner.com/fb/images/pub/feed-icon16x16.png" alt="" style="vertical-align:middle;border:0"/></a><a href="http://feeds.feedburner.com/CodeBetter"><img src="http://feeds.feedburner.com/~fc/CodeBetter?bg=FFFFFF&amp;fg=2E9BD2&amp;anim=1" height="26" width="88" style="vertical-align:middle;border:0"/></a></li>
					</ul>
				</div><!-- #second .widget-area -->
				<div class="grid_4">
					
					<h3>Friends of CodeBetter.Com</h3>
<ul>

<li><a href="/blogs/products/pages/64386.aspx">Red-Gate Tools For SQL and .NET</a></li>
<li><a href="/blogs/products/pages/64615.aspx">Telerik</a></li>
<li><a href="/blogs/products/pages/142174.aspx">JetBrains - ReSharper</a></li>
<li><a href="/blogs/products/pages/Beyond-Compare.aspx">Beyond Compare</a></li>
<li><a href="/blogs/products/pages/.NET-Memory-Profiler.aspx">.NET Memory Profiler</a></li>
<li><a href="http://www.ndepend.com/">NDepend</a></li>
<li><a href="http://www.sapphiresteel.com/">Ruby In Steel</a></li>
<li><a href="http://www.slickedit.com/">SlickEdit</a></li>
<li><a href="http://www.gurock.com/products/smartinspect/">SmartInspect .NET Logging</a></li>
<li>NGEDIT: <a href="http://www.viemu.com/">ViEmu</a> and <a href="http://www.codekana.com/">Codekana</a> </li>
<li><a href="http://www.devexpress.com/" target="_blank">DevExpress</a></li>
<li><a href="http://nhprof.com" target="_blank">NHibernate Profiler</a></li>
<li><a href="http://unfuddle.com" target="_blank">Unfuddle</a></li>
<li><a href="http://www.balsamiq.com/products/mockups" target="_blank">Balsamiq Mockups</a></li>
<li><a href="http://scrumy.com" target="_blank">Scrumy</a> &lt;-- NEW Friend!</li>

	</ul>				
				</div><!-- #third .widget-area -->
				<div class="grid_4">
					CodeBetter.Com &copy; '11<br />
						Stuff you need to Code Better!<br />
				Proudly powered by <span id="generator-link"><a href="http://wordpress.org/" title="Semantic Personal Publishing Platform" rel="generator">WordPress</a></span>.					
				</div><!-- #fourth .widget-area -->
			</div><!-- #footer-widget-area -->		
		
			</div><!-- end div.container_12 -->

	</div><!-- end div#footer -->
		
<script type="text/javascript">

  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-531207-1']);
  _gaq.push(['_trackPageview']);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();

</script>
<script type='text/javascript' src='http://cdn1.codebetter.com/wp-content/plugins/syntaxhighlighter/syntaxhighlighter3/scripts/shCore.js?ver=3.0.83b'></script>
<script type='text/javascript' src='http://cdn1.codebetter.com/wp-content/plugins/syntaxhighlighter/syntaxhighlighter3/scripts/shBrushCSharp.js?ver=3.0.83b'></script>
<script type='text/javascript' src='http://cdn1.codebetter.com/wp-content/plugins/syntaxhighlighter/syntaxhighlighter3/scripts/shBrushRuby.js?ver=3.0.83b'></script>
<script type='text/javascript' src='http://cdn1.codebetter.com/wp-content/plugins/syntaxhighlighter/syntaxhighlighter3/scripts/shBrushJScript.js?ver=3.0.83b'></script>
<script type='text/javascript' src='http://cdn1.codebetter.com/wp-content/plugins/syntaxhighlighter/syntaxhighlighter3/scripts/shBrushXml.js?ver=3.0.83b'></script>
<script type='text/javascript' src='http://cdn1.codebetter.com/wp-content/plugins/syntaxhighlighter/third-party-brushes/shBrushFSharp.js?ver=3.0.83b'></script>
<script type='text/javascript'>
	(function(){
		var corecss = document.createElement('link');
		var themecss = document.createElement('link');
		var corecssurl = "http://cdn1.codebetter.com/wp-content/plugins/syntaxhighlighter/syntaxhighlighter3/styles/shCore.css?ver=3.0.83b";
		if ( corecss.setAttribute ) {
				corecss.setAttribute( "rel", "stylesheet" );
				corecss.setAttribute( "type", "text/css" );
				corecss.setAttribute( "href", corecssurl );
		} else {
				corecss.rel = "stylesheet";
				corecss.href = corecssurl;
		}
		document.getElementsByTagName("head")[0].insertBefore( corecss, document.getElementById("syntaxhighlighteranchor") );
		var themecssurl = "http://cdn1.codebetter.com/wp-content/plugins/syntaxhighlighter/syntaxhighlighter3/styles/shThemeDefault.css?ver=3.0.83b";
		if ( themecss.setAttribute ) {
				themecss.setAttribute( "rel", "stylesheet" );
				themecss.setAttribute( "type", "text/css" );
				themecss.setAttribute( "href", themecssurl );
		} else {
				themecss.rel = "stylesheet";
				themecss.href = themecssurl;
		}
		//document.getElementById("syntaxhighlighteranchor").appendChild(themecss);
		document.getElementsByTagName("head")[0].insertBefore( themecss, document.getElementById("syntaxhighlighteranchor") );
	})();
	SyntaxHighlighter.config.strings.expandSource = '+ expand source';
	SyntaxHighlighter.config.strings.help = '?';
	SyntaxHighlighter.config.strings.alert = 'SyntaxHighlighter\n\n';
	SyntaxHighlighter.config.strings.noBrush = 'Can\'t find brush for: ';
	SyntaxHighlighter.config.strings.brushNotHtmlScript = 'Brush wasn\'t configured for html-script option: ';
	SyntaxHighlighter.defaults['gutter'] = false;
    SyntaxHighlighter.defaults['tab-size'] = 2;
    SyntaxHighlighter.defaults['toolbar'] = false;
    SyntaxHighlighter.defaults['wrap-lines'] = false; 
	SyntaxHighlighter.defaults['pad-line-numbers'] = false;
	SyntaxHighlighter.all();
</script>
 
</body>
</html>
<!-- Dynamic page generated in 0.331 seconds. -->
<!-- Cached page generated by WP-Super-Cache on 2011-01-31 06:50:28 -->
<!-- super cache -->