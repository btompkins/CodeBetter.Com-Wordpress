<!DOCTYPE html>
<html dir="ltr" lang="en-US">
<head>
	<meta charset="UTF-8" />
    <title>How Dovetail uses NHibernate with StructureMap | Jeremy D. Miller</title>
	<link rel="profile" href="http://gmpg.org/xfn/11" />
	
	<link href="http://feeds.feedburner.com/CodeBetter" title="CodeBetter.Com &raquo; Feed" type="application/rss+xml" rel="alternate">
	
		<link rel="pingback" href="http://codebetter.com/jeremymiller/xmlrpc.php" />
	                <link rel="stylesheet" href="http://cdn1.codebetter.com/wp-content/uploads/spacker-cache/ea73517eb74a545f51c376487c94dc9f.css?v=3912785705" type="text/css" media="all" /><!-- Is Cache! -->
                <script type='text/javascript' src='https://ajax.googleapis.com/ajax/libs/jquery/1.6.0/jquery.min.js?ver=3.4.2'></script>
<script type='text/javascript' src='http://dtym7iokkjlif.cloudfront.net/dough/1.0/recipe.js'></script>
<link rel="EditURI" type="application/rsd+xml" title="RSD" href="http://codebetter.com/jeremymiller/xmlrpc.php?rsd" />
<link rel="wlwmanifest" type="application/wlwmanifest+xml" href="http://cdn1.codebetter.com/wp-includes/wlwmanifest.xml" /> 
<link rel='prev' title='FubuMVC Diagnostics Sneak Peek' href='http://codebetter.com/jeremymiller/2010/01/04/fubumvc-diagnostics-sneak-peek/' />
<link rel='next' title='Writing Internal DSL&#8217;s in MSDN' href='http://codebetter.com/jeremymiller/2010/01/07/writing-internal-dsl-s-in-msdn/' />
<meta name="generator" content="WordPress 3.4.2" />
<link rel='shortlink' href='http://codebetter.com/jeremymiller/?p=745' />

<!-- All in One SEO Pack 1.6.13.2 by Michael Torbert of Semper Fi Web Design[83,155] -->
<link rel="canonical" href="http://codebetter.com/jeremymiller/2010/01/06/how-dovetail-uses-structuremap-with-nhibernate/" />
<!-- /all in one seo pack -->
<link rel="stylesheet" href="http://cdn1.codebetter.com/wp-content/plugins/digg-digg/include/../css/diggdigg-style.css?ver=4.5.3.3" type="text/css" media="screen" />

<!-- Start Shareaholic OgTags -->

	<!-- Shareaholic Notice: There is neither a featured nor gallery image set -->

<!-- End Shareaholic OgTags -->

	<style type="text/css">.recentcomments a{display:inline !important;padding:0 !important;margin:0 !important;}</style>
<meta id="syntaxhighlighteranchor" name="syntaxhighlighter-version" content="3.1.3" />
                <script type="text/javascript" src="http://cdn1.codebetter.com/wp-content/uploads/spacker-cache/dc168cf39155d7b5d39f696ca94d5980.js?v=5302176208">/*Is Cache!*/</script>
                	
	<script type='text/javascript' src='http://d1.openx.org/spcjs.php?id=7744&amp;target=_blank'></script>
	<style type="text/css">body { padding-top:0px !important; } html { margin-top: 0px !important; }</style>
<!-- BuySellAds Ad Code -->
<script type="text/javascript">
(function(){
  var bsa = document.createElement('script');
     bsa.type = 'text/javascript';
     bsa.async = true;
     bsa.src = 'http://s3.buysellads.com/ac/bsa.js';
  (document.getElementsByTagName('head')[0]||document.getElementsByTagName('body')[0]).appendChild(bsa);
})();
</script>
<!-- End BuySellAds Ad Code -->
</head>

<body>

			
		<div class="container_12 ui-tabs ui-widget ui-widget-content ui-corner-all" id="tabs">			
			<ul class="ui-tabs-nav ui-helper-reset ui-helper-clearfix ui-widget-header ui-corner-all">
				<li class="ui-state-default ui-corner-top ui-tabs-selected ui-state-active"><a href="#ui-tabs-1">CodeBetter.Com</a></li>
				<li class="ui-state-default ui-corner-top"><a href="http://devlicio.us">Devlicio.Us</a></li>				
				<div id="top-search">
				<form action="http://codebetter.com/globalsearch/" id="cse-search-box">
  <div>
   <fieldset id="search">
		<input type="hidden" name="cx" value="005178204031477491434:2bg5jtwgsfe" />
		<input type="hidden" name="cof" value="FORID:9" />
		<input type="hidden" name="ie" value="UTF-8" />
		<input type="text"  class="text-input" id="s" name="q" size="31" />
		<input type="image" src="http://cdn1.codebetter.com/wp-content/themes/codebetter/images/search-img.png" class="form-button" id="searchsubmit" value="GO" name="">				   	
	</fieldset>
  </div>
</form>
<script type="text/javascript" src="http://www.google.com/cse/brand?form=cse-search-box&lang=en&sitesearch=true"></script>
				</div>				
			</ul><div id="ui-tabs-1" class="ui-tabs-panel ui-widget-content ui-corner-bottom"></div><div id="ui-tabs-2" class="ui-tabs-panel ui-widget-content ui-corner-bottom ui-tabs-hide"></div>
		</div>
			
		<div id="main" class="container_12">
		
			<div id="logo" class="grid_3"><a href="/" title="CodeBetter.Com - Stuff you need to Code Better!"><image src="http://cdn1.codebetter.com/wp-content/themes/codebetter/images/codebetter_logo.png" height="48" width="223"></image></a></div>
			<div id="ad_leaderboard" class="grid_9">
			<!-- BuySellAds Zone Code -->
<div id="bsap_1276080" class="bsarocks bsap_4fe632babdccc2b4b049e4f08cc3c549"></div>
<!-- End BuySellAds Zone Code --></div>
			
			<div id="globalNav" class="grid_12">
				<ul>
					<li><a href="http://codebetter.com" title="home">Home</a></li>
					<li class="page_item page-item-2"><a href="http://codebetter.com/about/">About</a></li>
<li class="page_item page-item-8"><a href="http://codebetter.com/codebetter-ci/">CodeBetter CI</a></li>
<li class="page_item page-item-6"><a href="http://codebetter.com/community/">Community</a></li>
<li class="page_item page-item-10"><a href="http://codebetter.com/editors/">Editors</a></li>
					<li><a href="http://feeds.feedburner.com/CodeBetter" rel="alternate" type="application/rss+xml"><img src="http://www.feedburner.com/fb/images/pub/feed-icon16x16.png" alt="" style="vertical-align:middle;border:0"/></a><a href="http://feeds.feedburner.com/CodeBetter"><img src="http://feeds.feedburner.com/~fc/CodeBetter?bg=EFEFEF&amp;fg=2E9BD2&amp;anim=1" height="26" width="88" style="vertical-align:middle;border:0"/></a></li>
				</ul>
								
			</div><!-- end div#globalNav.container_12 -->				
	
		<div id="content" class="container_12">
			<div id="main" class="grid_8">


				<div id="post-745" class="post-745 post type-post status-publish format-standard hentry category-database-and-persistence category-di category-fubumvc category-ioc category-structuremap">
					<h1 class="entry-title">How Dovetail uses NHibernate with StructureMap</h1>

					<div class="entry-meta">
						<span class="meta-prep meta-prep-author">Posted by </span>
						<span class="author vcard"><a class="url fn n" href="http://codebetter.com/jeremymiller/author/jeremymiller/" title="View all posts by Jeremy Miller">Jeremy Miller</a></span>
						<span class="meta-sep"> on  </span>
						<a href="http://codebetter.com/jeremymiller/2010/01/06/how-dovetail-uses-structuremap-with-nhibernate/" title="6:19 am" rel="bookmark"><span class="entry-date">January 6, 2010</span></a>
											</div><!-- .entry-meta -->

					<div class="entry-content">
						<div id="greet_block"><noscript><div class="greet_block wpgb_cornered"><div class="greet_text"><div class="greet_image"><a href="http://codebetter.com/jeremymiller/feed/rss/"  rel="nofollow"><img src="http://cdn1.codebetter.com/wp-content/plugins/wp-greet-box/images/rss_icon.png" alt="WP Greet Box icon"/></a></div>Hello there! If you are new here, you might want to <a href="http://codebetter.com/jeremymiller/feed/rss/" rel="nofollow"><strong>subscribe to the RSS feed</strong></a> for updates on this topic.<div style="clear:both"></div><div class="greet_block_powered_by">Powered by <a href="http://omninoggin.com/projects/wordpress-plugins/wp-greet-box-wordpress-plugin/" title="WP Greet Box WordPress Plugin" style="text-decoration:none;">WP Greet Box</a> <a href="http://omninoggin.com/" title="WordPress Plugin" style="text-decoration:none;">WordPress Plugin</a></div><div style="clear:both"></div></div></div></noscript></div><!-- Start Shareaholic LikeButtonSetTop Automatic --><!-- End Shareaholic LikeButtonSetTop Automatic --><p>A quick note here, this article shows features of StructureMap that are only available in the very latest <a href="http://sourceforge.net/projects/structuremap/">2.5.4 release available on sourceforge</a>.&nbsp; I&rsquo;ve uploaded the finished binaries, but haven&rsquo;t made a formal announcement because I&rsquo;m a couple weeks away from having the docs updated (and yes, StructureMap *is* actually <a href="http://structuremap.sourceforge.net/TableOfContents.htm">well documented</a>, thank you).&nbsp; My friend Weston Binford published his take on <a href="http://trason.net/journal/2009/10/7/bootstrapping-nhibernate-with-structuremap.html">StructureMap / NHibernate bootstrapping</a> and some on <a href="http://trason.net/journal/2009/10/14/nhibernate-transactional-boundaries.html">managing transactional boundaries with NHibernate</a> in a web application.&nbsp; He&rsquo;s been constantly nagging me to write *this* post because we do things very differently with some of the newer features in StructureMap that I haven&rsquo;t documented yet (and frankly, you should thank me for dogfooding this stuff and playing whack-a-mole with memory leak bugs before inflicting it upon the world).&nbsp; </p>
<p>This is *our* approach and not a canonical example of how to do everything.&nbsp; It&rsquo;s working for us at the moment is the best that I can really say.&nbsp; The performance is good enough for us, but I won&rsquo;t claim that it&rsquo;s been tuned yet.&nbsp; In writing this it has definitely occurred to me that, yes, this does seem pretty complicated.&nbsp; There are a lot of moving parts, but at least every individual moving part is simple by itself.&nbsp; I&rsquo;m used to seeing software designs as a series of fine grained objects fulfilling narrow roles that collaborate with each other.&nbsp; I&rsquo;m very aware that other developers think it&rsquo;s simpler to have fewer, but blockier moving parts.&nbsp; And no, I don&rsquo;t think the complexity is a flaw in NHibernate because I think all of the application lifecycle issues apply to all ORM tools.</p>
<p>Ok, here we go, we need to talk about:</p>
<ol>
<li>Tooling</li>
<li>Bootstrapping NHibernate</li>
<li>Configuring NHibernate in StructureMap</li>
<li>Session Management</li>
<li>Runtime Usage of NHibernate</li>
<li>Our Workflow</li>
</ol>
<p>&nbsp;</p>
<h4><b>Tooling</b></h4>
<p>For tooling, Dovetail generally runs on the trunk of StructureMap at all times (dogfooding, and a lot of my StructureMap dev work is driven by Dovetail needs).&nbsp; Beyond that, we use: </p>
<ol>
<li>NHibernate 2.1.0.1003</li>
<li>Linq for NHibernate &ndash; We frankly haven&rsquo;t had any issues with its limitations.&nbsp; Most of our querying is by primary key or by simple queries for whole entities, so advanced Linq usage just isn&rsquo;t something we need.&nbsp; We do have our own little bit of tooling around the old ICriteria stuff in the few places we do projections.</li>
<li>Fluent NHibernate 0.1.0443.&nbsp; We don&rsquo;t use the auto mapping, but we have gotten significant usage out of the conventions all the same.</li>
<li>The FubuMVC Reboot.&nbsp; This is significant for the section on session management.&nbsp; The approach we use will not apply to ASP.Net MVC or WebForms (dunno about MonoRail).</li>
</ol>
<p>&nbsp;</p>
<h4><b>Bootstrapping NHibernate</b></h4>
<p>The first thing you generally have to do with NHibernate is to figure out how you&rsquo;re going to create the NHibernate SessionFactory object and how you&rsquo;ll feed configuration data to the SessionFactory in your architecture.&nbsp; When I started using NHibernate 4-5 years ago I quickly settled on a role in the system I call &ldquo;ISessionSource&rdquo; that generally manages the creation of a SessionFactory object and uses that object to create ISession objects.&nbsp; The signature of ISessionSource is this:</p>
<div style="border-bottom: black thin solid;border-left: black thin solid;font-family: courier new;background: white;color: black;font-size: 10pt;border-top: black thin solid;border-right: black thin solid">
<p style="margin: 0px">&nbsp;&nbsp;&nbsp; <span style="color: blue">public</span> <span style="color: blue">interface</span> <span style="color: #2b91af">ISessionSource</span></p>
<p style="margin: 0px">&nbsp;&nbsp;&nbsp; {</p>
<p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: #2b91af">ISession</span> CreateSession();</p>
<p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: blue">void</span> BuildSchema();</p>
<p style="margin: 0px">&nbsp;&nbsp;&nbsp; }</p>
</div>
<p>&nbsp;</p>
<p>As you can see, it only has two methods.&nbsp; CreateSession() is obvious.&nbsp; BuildSchema() invokes the <a href="http://tunatoksoz.com/post/NHibernate-hbm2ddl.aspx">HBM2DDL tool</a> to completely rebuild the database schema off of the NHibernate mappings (more on this below).&nbsp; The real implementation of ISessionSource for us is of course, NHibernateSessionSource (shown heavily elided):</p>
<div style="border-bottom: black thin solid;border-left: black thin solid;font-family: courier new;background: white;color: black;font-size: 10pt;border-top: black thin solid;border-right: black thin solid">
<p style="margin: 0px">&nbsp;&nbsp;&nbsp; <span style="color: blue">public</span> <span style="color: blue">class</span> <span style="color: #2b91af">NHibernateSessionSource</span> : <span style="color: #2b91af">ISessionSource</span></p>
<p style="margin: 0px">&nbsp;&nbsp;&nbsp; {</p>
<p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: blue">private</span> <span style="color: blue">readonly</span> <span style="color: #2b91af">DatabaseSettings</span> _databaseSettings;</p>
<p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: blue">private</span> <span style="color: blue">readonly</span> <span style="color: blue">object</span> _factorySyncRoot = <span style="color: blue">new</span> <span style="color: blue">object</span>();</p>
<p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: blue">private</span> <span style="color: #2b91af">ISessionFactory</span> _sessionFactory;</p>
<p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: blue">private</span> <span style="color: #2b91af">Configuration</span> _configuration;</p>
<p style="margin: 0px">&nbsp;</p>
<p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: blue">public</span> NHibernateSessionSource(<span style="color: #2b91af">DatabaseSettings</span> databaseSettings)</p>
<p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {</p>
<p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: blue">if</span> (_sessionFactory != <span style="color: blue">null</span>) <span style="color: blue">return</span> ;</p>
<p style="margin: 0px">&nbsp;</p>
<p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: blue">lock</span> (_factorySyncRoot)</p>
<p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {</p>
<p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: blue">if</span> (_sessionFactory != <span style="color: blue">null</span>) <span style="color: blue">return</span>;</p>
<p style="margin: 0px">&nbsp;</p>
<p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; _databaseSettings = databaseSettings;</p>
<p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; _configuration = AssembleConfiguration(<span style="color: blue">null</span>);</p>
<p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; _sessionFactory = _configuration.BuildSessionFactory();</p>
<p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }</p>
<p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }</p>
<p style="margin: 0px">&nbsp;</p>
<p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: blue">public</span> <span style="color: #2b91af">Configuration</span> AssembleConfiguration(<span style="color: blue">string</span> mappingExportPath)</p>
<p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {</p>
<p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: blue">// other stuff off stage</span></p>
<p style="margin: 0px">&nbsp;</p>
<p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: green">// We use Fluent NHibernate&rsquo;s Fluently.Configure() to setup conventions, attach event listeners,</span></p>
<p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: green">// configure the properties from the DatabaseSettings object like the connection string, and </span></p>
<p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: green">// the list of IDomainMap objects passed in the constructor function that define the mappings</span></p>
<p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: blue">return</span> <span style="color: #2b91af">Fluently</span>.Configure()</p>
<p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; .Database(<span style="color: blue">new</span> <span style="color: #2b91af">DovetailPersistenceConfigurer</span>(nhibernateProperties))</p>
<p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; .ExposeConfiguration(config=&gt;</p>
<p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {</p>
<p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: blue">var</span> listener = <span style="color: blue">new</span> <span style="color: #2b91af">NHibernateSaveListener</span>();</p>
<p style="margin: 0px">&nbsp;</p>
<p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; config.EventListeners.PreInsertEventListeners = <span style="color: blue">new</span> <span style="color: #2b91af">IPreInsertEventListener</span>[]{listener};</p>
<p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; config.EventListeners.PreUpdateEventListeners = <span style="color: blue">new</span> <span style="color: #2b91af">IPreUpdateEventListener</span>[]{listener};</p>
<p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; })</p>
<p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; .Mappings(m =&gt;</p>
<p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {</p>
<p style="margin: 0px">&nbsp;</p>
<p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; m.FluentMappings.AddFromAssemblyOf&lt;<span style="color: #2b91af">DomainEntity</span>&gt;();</p>
<p style="margin: 0px"><span style="color: green"></span></p>
<p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; m.FluentMappings.ConventionDiscovery.Setup(convention =&gt;</p>
<p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {</p>
<p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: green">// Set up the Fluent NHibernate conventions</span></p>
<p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; convention.Add&lt;<span style="color: #2b91af">TimeZoneInfoTypeConvention</span>&gt;();</p>
<p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; convention.Add&lt;<span style="color: #2b91af">ManyToManyConvention</span>&gt;();</p>
<p style="margin: 0px">&nbsp;</p>
<p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; });</p>
<p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }).BuildConfiguration();</p>
<p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }</p>
<p style="margin: 0px">&nbsp;</p>
<p style="margin: 0px"><span style="color: blue">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; #region</span> ISessionSource Members</p>
<p style="margin: 0px">&nbsp;</p>
<p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: blue">public</span> <span style="color: #2b91af">ISession</span> CreateSession()</p>
<p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {</p>
<p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: blue">return</span> _sessionFactory.OpenSession();</p>
<p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }</p>
<p style="margin: 0px">&nbsp;</p>
<p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: blue">public</span> <span style="color: blue">void</span> BuildSchema()</p>
<p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {</p>
<p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: #2b91af">ISession</span> session = CreateSession();</p>
<p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: #2b91af">IDbConnection</span> connection = session.Connection;</p>
<p style="margin: 0px">&nbsp;</p>
<p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: #2b91af">Dialect</span> dialect = <span style="color: #2b91af">Dialect</span>.GetDialect(_databaseSettings.GetProperties());</p>
<p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: blue">string</span>[] drops = _configuration.GenerateDropSchemaScript(dialect);</p>
<p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; executeScripts(drops, connection);</p>
<p style="margin: 0px">&nbsp;</p>
<p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: blue">string</span>[] scripts = _configuration.GenerateSchemaCreationScript(dialect);</p>
<p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; executeScripts(scripts, connection);</p>
<p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }</p>
<p style="margin: 0px">&nbsp;</p>
<p style="margin: 0px"><span style="color: blue">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; #endregion</span></p>
<p style="margin: 0px">&nbsp;</p>
<p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: blue">private</span> <span style="color: blue">static</span> <span style="color: blue">void</span> executeScripts(<span style="color: blue">string</span>[] scripts, <span style="color: #2b91af">IDbConnection</span> connection)</p>
<p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {</p>
<p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: blue">foreach</span> (<span style="color: blue">string</span> script <span style="color: blue">in</span> scripts)</p>
<p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {</p>
<p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: #2b91af">IDbCommand</span> command = connection.CreateCommand();</p>
<p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; command.CommandText = script;</p>
<p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; command.ExecuteNonQuery();</p>
<p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }</p>
<p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }</p>
<p style="margin: 0px">&nbsp;&nbsp;&nbsp; }</p>
</div>
<p>&nbsp;</p>
<p>We simply embed Fluent NHibernate (FNH) ClassMap classes directly into the same assembly that holds the NHibernateSessionSource object.&nbsp; The call to m.FluentMappings.AddFromAssemblyOf&lt;<span style="color: #2b91af">DomainEntity</span>&gt;(); scans the executing assembly for any classes that inherit from ClassMap&lt;T&gt; from FNH and add them to the NHibernate Configuration object for use in constructing the SessionFactory object behind the scenes.&nbsp; Now, the DatabaseSettings class contains all of the metadata that our NHibernate SessionFactory needs.&nbsp; It&rsquo;s really just a simple data bag class:</p>
<div style="border-bottom: black thin solid;border-left: black thin solid;font-family: courier new;background: white;color: black;font-size: 10pt;border-top: black thin solid;border-right: black thin solid">
<p style="margin: 0px">&nbsp;&nbsp;&nbsp; <span style="color: blue">public</span> <span style="color: blue">class</span> <span style="color: #2b91af">DatabaseSettings</span></p>
<p style="margin: 0px">&nbsp;&nbsp;&nbsp; {</p>
<p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: blue">public</span> <span style="color: blue">string</span> Provider { <span style="color: blue">get</span>; <span style="color: blue">set</span>; }</p>
<p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: blue">public</span> <span style="color: blue">string</span> Driver { <span style="color: blue">get</span>; <span style="color: blue">set</span>; }</p>
<p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: blue">public</span> <span style="color: blue">string</span> Dialect { <span style="color: blue">get</span>; <span style="color: blue">set</span>; }</p>
<p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: blue">public</span> <span style="color: blue">bool</span> UseOuterJoin { <span style="color: blue">get</span>; <span style="color: blue">set</span>; }</p>
<p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; [<span style="color: #2b91af">ConnectionString</span>]</p>
<p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: blue">public</span> <span style="color: blue">string</span> ConnectionString { <span style="color: blue">get</span>; <span style="color: blue">set</span>; }</p>
<p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: blue">public</span> <span style="color: blue">bool</span> ShowSql { <span style="color: blue">get</span>; <span style="color: blue">set</span>; }</p>
<p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: blue">public</span> <span style="color: blue">string</span> ProxyFactory { <span style="color: blue">get</span>; <span style="color: blue">set</span>; }</p>
<p style="margin: 0px">&nbsp;</p>
<p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: green">// simple solution for now</span></p>
<p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: blue">public</span> <span style="color: #2b91af">IDictionary</span>&lt;<span style="color: blue">string</span>, <span style="color: blue">string</span>&gt; GetProperties()</p>
<p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {</p>
<p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: blue">if</span> (Provider.IsEmpty()) <span style="color: blue">throw</span> <span style="color: blue">new</span> <span style="color: #2b91af">ApplicationException</span>(<span style="color: #a31515">&#8220;DatabaseSettings unavailable. Make sure your application configuration file has appSetting entries for the necessary DatabaseSettings properties.&#8221;</span>);</p>
<p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: blue">var</span> properties = <span style="color: blue">new</span> <span style="color: #2b91af">Dictionary</span>&lt;<span style="color: blue">string</span>, <span style="color: blue">string</span>&gt;</p>
<p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {</p>
<p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<span style="color: #a31515">&#8220;connection.provider&#8221;</span>, Provider},</p>
<p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<span style="color: #a31515">&#8220;connection.driver_class&#8221;</span>, Driver},</p>
<p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<span style="color: #a31515">&#8220;dialect&#8221;</span>, Dialect},</p>
<p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<span style="color: #a31515">&#8220;use_outer_join&#8221;</span>, UseOuterJoin.ToString()},</p>
<p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<span style="color: #a31515">&#8220;connection.connection_string&#8221;</span>, ConnectionString},</p>
<p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<span style="color: #a31515">&#8220;show_sql&#8221;</span>, ShowSql.ToString()},</p>
<p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<span style="color: #a31515">&#8220;proxyfactory.factory_class&#8221;</span>, ProxyFactory}</p>
<p style="margin: 0px">&nbsp;</p>
<p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; };</p>
<p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: blue">return</span> properties;</p>
<p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }</p>
<p style="margin: 0px">&nbsp;&nbsp;&nbsp; }</p>
</div>
<p>In the interest of me finishing this post before midnight, I&rsquo;m going to skip out on how DatabaseSettings is resolved from the app settings config, but let&rsquo;s just say that StructureMap &ldquo;knows&rdquo; how to build DatabaseSettings and therefore can inject it into the constructor function of any object that needs DatabaseSettings.</p>
<p>&nbsp;</p>
<h4><b>Configuring NHibernate in StructureMap</b></h4>
<p>Regardless of which IoC tool you choose (apparently there are others beside StructureMap), you will consistently want to manage the NHibernate SessionFactory object as a singleton instance in your container.&nbsp; This is important because the ISessionFactory is very expensive in resources to bootstrap.&nbsp; You only want to do this once.&nbsp; The second thing you want to do is to teach the container how to resolve an object instance of the ISession object.&nbsp; The entire configuration of NHibernate objects in StructureMap is shown below as part of a StructureMap Registry in our codebase called &ldquo;CoreRegistry&rdquo;:</p>
<div style="border-bottom: black thin solid;border-left: black thin solid;font-family: courier new;background: white;color: black;font-size: 10pt;border-top: black thin solid;border-right: black thin solid">
<p style="margin: 0px">&nbsp;&nbsp;&nbsp; <span style="color: blue">public</span> <span style="color: blue">class</span> <span style="color: #2b91af">CoreRegistry</span> : <span style="color: #2b91af">Registry</span></p>
<p style="margin: 0px">&nbsp;&nbsp;&nbsp; {</p>
<p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: blue">public</span> <span style="color: blue">const</span> <span style="color: blue">string</span> IN_MEMORY_PROFILE = <span style="color: #a31515">&#8220;InMemory&#8221;</span>;</p>
<p style="margin: 0px">&nbsp;</p>
<p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: blue">public</span> CoreRegistry()</p>
<p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {</p>
<p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; setupNHibernate();</p>
<p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }</p>
<p style="margin: 0px">&nbsp;</p>
<p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: blue">private</span> <span style="color: blue">void</span> setupNHibernate()</p>
<p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {</p>
<p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ForSingletonOf&lt;<span style="color: #2b91af">ISessionSource</span>&gt;().Use&lt;<span style="color: #2b91af">NHibernateSessionSource</span>&gt;();</p>
<p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; For&lt;<span style="color: #2b91af">ISession</span>&gt;().Use(c =&gt;</p>
<p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {</p>
<p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: blue">var</span> transaction = (<span style="color: #2b91af">NHibernateTransactionBoundary</span>)c.GetInstance&lt;<span style="color: #2b91af">ITransactionBoundary</span>&gt;();</p>
<p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: blue">return</span> transaction.Session;</p>
<p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; });</p>
<p style="margin: 0px">&nbsp;</p>
<p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; For&lt;<span style="color: #2b91af">IUniqueIdentifierService</span>&gt;().Use&lt;<span style="color: #2b91af">NHibernateUniqueIdentifierService</span>&gt;();</p>
<p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; For&lt;<span style="color: #2b91af">ITransactionBoundary</span>&gt;().Use&lt;<span style="color: #2b91af">NHibernateTransactionBoundary</span>&gt;();</p>
<p style="margin: 0px">&nbsp;</p>
<p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; For&lt;<span style="color: #2b91af">IRepository</span>&gt;().Use&lt;<span style="color: #2b91af">Repository</span>&gt;();</p>
<p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }</p>
<p style="margin: 0px">&nbsp;</p>
<p style="margin: 0px">&nbsp;&nbsp;&nbsp; }&nbsp; </p>
</div>
<p>For StructureMap veterans, this is the new streamlined Registry DSL found in 2.5.4.&nbsp; The key points here are that ISessionSource is registered with the singleton lifecycle in StructureMap so that there is only one of these very expensive objects created for the lifetime of the application.&nbsp; Look at how the &ldquo;ISession&rdquo; object is resolved by StructureMap by invoking a Lambda function.&nbsp; Our ISession lifecycle is partially controlled by the ITransactionalBoundary/NHibernateTransactionalBoundary class that I&rsquo;ll describe in detail in the next section.&nbsp; Our Repository class, and any other classes that directly touch the NHibernate ISession, simply need to expose a constructor argument for &ldquo;ISession&rdquo; and StructureMap will happily invoke the Lambda function above to create and return an ISession:</p>
<div style="border-bottom: black thin solid;border-left: black thin solid;font-family: courier new;background: white;color: black;font-size: 10pt;border-top: black thin solid;border-right: black thin solid">
<p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: blue">public</span> Repository(<span style="color: #2b91af">ISession</span> session, <span style="color: #2b91af">ILogger</span> logger)</p>
<p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {</p>
<p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; _session = session;</p>
<p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; _logger = logger;</p>
<p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }</p>
</div>
<p>&nbsp;</p>
<h4><b>Session Management</b></h4>
<p>Okay, this is the part of our solution that I don&rsquo;t particularly care for &ndash; except that it works.&nbsp; We&rsquo;re building a web application that involves a lot of very short atomic transactions.&nbsp; We do not have any significant need for nested transactions or unit of work type implementations.&nbsp; That being said, we have three basic needs for NHibernate usage in a web request:</p>
<ol>
<li>We need to start a single ISession for each unique web request</li>
<li>All services invoked during the web request <b>must use the same ISession</b>.&nbsp; This is a crucial detail.&nbsp; You may be fetching a domain entity from a repository and passing it later into a domain service which attempts to persist it at a later time.&nbsp; The domain service will blow up if the entity object is not part of the same ISession within the domain service.</li>
<li>At the end of the request, all outstanding changes to the ISession need to be committed if there were no errors detected during the web request and the ISession should be disposed at the end of every request.</li>
</ol>
<p>As I hinted at earlier before, we use an interface called ITransactionBoundary to govern the lifecycle of an ISession.&nbsp; As you can see in the preceding section, StructureMap can only resolve an ISession by going through an ITransactionBoundary object.&nbsp; The implementation of this stinker is shown below:</p>
<div style="border-bottom: black thin solid;border-left: black thin solid;font-family: courier new;background: white;color: black;font-size: 10pt;border-top: black thin solid;border-right: black thin solid">
<p style="margin: 0px">&nbsp;&nbsp;&nbsp; <span style="color: blue">public</span> <span style="color: blue">class</span> <span style="color: #2b91af">NHibernateTransactionBoundary</span> : <span style="color: #2b91af">INHibernateTransactionBoundary</span></p>
<p style="margin: 0px">&nbsp;&nbsp;&nbsp; {</p>
<p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: blue">private</span> <span style="color: blue">readonly</span> <span style="color: #2b91af">ISessionSource</span> _sessionSource;</p>
<p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: blue">private</span> <span style="color: blue">bool</span> _isInitialized;</p>
<p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: blue">private</span> <span style="color: #2b91af">ISession</span> _session;</p>
<p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: blue">private</span> <span style="color: #2b91af">ITransaction</span> _transaction;</p>
<p style="margin: 0px">&nbsp;</p>
<p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: blue">public</span> NHibernateTransactionBoundary(<span style="color: #2b91af">ISessionSource</span> sessionSource)</p>
<p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {</p>
<p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; _sessionSource = sessionSource;</p>
<p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }</p>
<p style="margin: 0px">&nbsp;</p>
<p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: blue">public</span> <span style="color: #2b91af">ISession</span> Session</p>
<p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {</p>
<p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: blue">get</span></p>
<p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {</p>
<p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ensure_initialized();</p>
<p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: blue">return</span> _session;</p>
<p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }</p>
<p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }</p>
<p style="margin: 0px">&nbsp;</p>
<p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: blue">public</span> <span style="color: blue">bool</span> IsDisposed { <span style="color: blue">get</span>; <span style="color: blue">private</span> <span style="color: blue">set</span>; }</p>
<p style="margin: 0px">&nbsp;</p>
<p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: blue">public</span> <span style="color: blue">void</span> Start()</p>
<p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {</p>
<p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; _session = _sessionSource.CreateSession();</p>
<p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; _session.FlushMode = <span style="color: #2b91af">FlushMode</span>.Commit;</p>
<p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; _transaction = _session.BeginTransaction();</p>
<p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; _isInitialized = <span style="color: blue">true</span>;</p>
<p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }</p>
<p style="margin: 0px">&nbsp;</p>
<p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: blue">public</span> <span style="color: blue">void</span> Commit()</p>
<p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {</p>
<p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; should_not_be_disposed();</p>
<p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ensure_initialized();</p>
<p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; _transaction.Commit();</p>
<p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }</p>
<p style="margin: 0px">&nbsp;</p>
<p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: blue">public</span> <span style="color: blue">void</span> Rollback()</p>
<p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {</p>
<p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; should_not_be_disposed();</p>
<p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ensure_initialized();</p>
<p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; _transaction.Rollback();</p>
<p style="margin: 0px">&nbsp;</p>
<p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; _transaction = _session.BeginTransaction();</p>
<p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }</p>
<p style="margin: 0px">&nbsp;</p>
<p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: blue">public</span> <span style="color: blue">void</span> Dispose()</p>
<p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {</p>
<p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; IsDisposed = <span style="color: blue">true</span>;</p>
<p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: blue">if</span> (_transaction != <span style="color: blue">null</span>) _transaction.Dispose();</p>
<p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: blue">if</span> (_session != <span style="color: blue">null</span>) _session.Dispose();</p>
<p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }</p>
<p style="margin: 0px">&nbsp;</p>
<p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: blue">private</span> <span style="color: blue">void</span> should_not_be_disposed()</p>
<p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {</p>
<p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: blue">if</span> (! IsDisposed) <span style="color: blue">return</span>;</p>
<p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: blue">throw</span> <span style="color: blue">new</span> <span style="color: #2b91af">ObjectDisposedException</span>(<span style="color: #a31515">&#8220;NHibernateTransactionBoundary&#8221;</span>);</p>
<p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }</p>
<p style="margin: 0px">&nbsp;</p>
<p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: blue">private</span> <span style="color: blue">void</span> ensure_initialized()</p>
<p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {</p>
<p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: blue">if</span> (!_isInitialized)</p>
<p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {</p>
<p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: blue">throw</span> <span style="color: blue">new</span> <span style="color: #2b91af">InvalidOperationException</span>(</p>
<p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: #a31515">&#8220;An attempt was made to access the database session outside of a transaction. Please make sure all access is made within an initialized transaction boundary.&#8221;</span>);</p>
<p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }</p>
<p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }</p>
<p style="margin: 0px">&nbsp;&nbsp;&nbsp; }</p>
</div>
<p>&nbsp;</p>
<p>We typically don&rsquo;t have to use ITransactionBoundary directly.&nbsp; We use a class called TransactionProcessor as a helper to manage the transaction lifecycle.&nbsp; A little bit of this class is shown below:</p>
<div style="border-bottom: black thin solid;border-left: black thin solid;font-family: courier new;background: white;color: black;font-size: 10pt;border-top: black thin solid;border-right: black thin solid">
<p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: blue">private</span> <span style="color: blue">void</span> execute(<span style="color: #2b91af">Action</span>&lt;<span style="color: #2b91af">IContainer</span>&gt; action)</p>
<p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {</p>
<p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: #2b91af">IContainer</span> container = <span style="color: blue">null</span>;</p>
<p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: blue">lock</span> (_locker)</p>
<p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {</p>
<p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; container = _container;</p>
<p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }</p>
<p style="margin: 0px">&nbsp;</p>
<p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: green">// This is using the new &#8220;Nested&#8221; Container feature of StructureMap</span></p>
<p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: green">// to create an entirely new Container object that is &#8220;scoped&#8221; to</span></p>
<p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: green">// this action</span></p>
<p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: blue">using</span> (<span style="color: #2b91af">IContainer</span> nestedContainer = container.GetNestedContainer())</p>
<p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: blue">using</span> (<span style="color: blue">var</span> boundary = nestedContainer.GetInstance&lt;<span style="color: #2b91af">ITransactionBoundary</span>&gt;())</p>
<p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {</p>
<p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; boundary.Start();</p>
<p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; action(nestedContainer);</p>
<p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; boundary.Commit();</p>
<p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }</p>
<p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }</p>
</div>
<p>I&rsquo;m not sure how clear it is what is happening above, so let me explain all the steps that are happening here:</p>
<ol>
<li>TransactionProcessor takes in a reference to the root StructureMap IContainer of the application (IContainer is injected into itself by default).&nbsp; From the main IContainer, it creates a new &ldquo;Nested&rdquo; container that references all the same configuration as the parent container including the same singleton object of our NHibernateSessionSource, but scopes all &ldquo;Transient&rdquo; objects to the lifecycle of the new nested container.&nbsp; What this means is that any object created/resolved by the nested container that asks for an ISession object in either a constructor or setter will get the exact same object instance of ISession.&nbsp; This way all services invoked in the web request will be using the same identity map and logical unit of work even though they are created separately and independently.&nbsp; When the nested container is disposed, it will attempt to dispose all of the objects that it created.&nbsp; This is new behavior in StructureMap I built specifically for NHibernate usage in a web application.</li>
<li>TransactionProcessor pulls a new ITransactionBoundary object out of the nested container and calls Start() which will spin up a new ISession and start a new transaction.&nbsp; Remembering the rules of nested container behavior I outlined above, you can see that only one ITransactionBoundary is created for the nested container, so only one ISession is used for all other services.</li>
<li>TransactionProcessor uses the &ldquo;Action&lt;IContainer&gt;&rdquo; passed into it against the nested container to perform an action within a transaction</li>
<li>TransactionProcessor calls Commit() to finish the transaction and flush changes from the ISession to the database</li>
<li>The using {} block finishes and disposes the TransactionBoundary which internally disposes the ISession.&nbsp; Technically, you could get by with only the first using block up above.</li>
</ol>
<p>&nbsp;</p>
<p>In the past you&rsquo;ve typically dealt with NHibernate in web applications by scoping the ISession per HttpContext and using HttpModule&rsquo;s to flush and/or dispose the ISession after the request is finished.&nbsp; We&rsquo;re using a combination of the new StructureMap nested container functionality and FubuMVC&rsquo;s &ldquo;ActionBehavior&rdquo; model to manage ISession lifecycle in our application.&nbsp; All of our routing requests have to go through a top level behavior called TransactionalContainerBehavior that invokes the transaction mechanics around the rest of the web request handling:</p>
<div style="border-bottom: black thin solid;border-left: black thin solid;font-family: courier new;background: white;color: black;font-size: 10pt;border-top: black thin solid;border-right: black thin solid">
<p style="margin: 0px">&nbsp;&nbsp;&nbsp; <span style="color: blue">public</span> <span style="color: blue">class</span> <span style="color: #2b91af">TransactionalContainerBehavior</span> : <span style="color: #2b91af">IActionBehavior</span></p>
<p style="margin: 0px">&nbsp;&nbsp;&nbsp; {</p>
<p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: blue">private</span> <span style="color: blue">readonly</span> <span style="color: #2b91af">IContainer</span> _container;</p>
<p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: blue">private</span> <span style="color: blue">readonly</span> <span style="color: #2b91af">ServiceArguments</span> _arguments;</p>
<p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: blue">private</span> <span style="color: blue">readonly</span> <span style="color: #2b91af">Guid</span> _behaviorId;</p>
<p style="margin: 0px">&nbsp;</p>
<p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: blue">public</span> TransactionalContainerBehavior(<span style="color: #2b91af">IContainer</span> container, <span style="color: #2b91af">ServiceArguments</span> arguments, <span style="color: #2b91af">Guid</span> behaviorId)</p>
<p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {</p>
<p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; _container = container;</p>
<p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; _arguments = arguments;</p>
<p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; _behaviorId = behaviorId;</p>
<p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }</p>
<p style="margin: 0px">&nbsp;</p>
<p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: blue">public</span> <span style="color: blue">void</span> Invoke()</p>
<p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {</p>
<p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; _container.ExecuteInTransaction&lt;<span style="color: #2b91af">IContainer</span>&gt;(c =&gt;</p>
<p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {</p>
<p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; c.GetInstance&lt;<span style="color: #2b91af">IAuthenticationService</span>&gt;().SetupAuthenticationContext();</p>
<p style="margin: 0px">&nbsp;</p>
<p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; invokeRequestedBehavior(c);</p>
<p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; });</p>
<p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }</p>
<p style="margin: 0px">&nbsp;</p>
<p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: blue">private</span> <span style="color: blue">void</span> invokeRequestedBehavior(<span style="color: #2b91af">IContainer</span> c)</p>
<p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {</p>
<p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: blue">var</span> behavior = c.GetInstance&lt;<span style="color: #2b91af">IActionBehavior</span>&gt;(_arguments.ToExplicitArgs(), _behaviorId.ToString());</p>
<p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; behavior.Invoke();</p>
<p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }</p>
<p style="margin: 0px">&nbsp;&nbsp;&nbsp; }</p>
</div>
<p>&nbsp;</p>
<p>&ldquo;ExecuteInTransaction&lt;&gt;()&rdquo; is an extension method on IContainer that we use as a convenience to perform actions within a transactional boundary.&nbsp; The advantage of the FubuMVC + Nested Container approach that I like is how all the mechanics are here in one spot instead of having to register the HttpModule where you have less control over the ordering of events.</p>
<p>&nbsp;</p>
<h4><b>Runtime Usage of NHibernate</b></h4>
<p>Okay, assuming that you&rsquo;re still with me and I haven&rsquo;t bored the pants off of you, let&rsquo;s go onto our Repository.&nbsp; We&rsquo;re not very strict about DDD, so I&rsquo;m perfectly content to use a single generic Repository that uses this signature:</p>
<div style="border-bottom: black thin solid;border-left: black thin solid;font-family: courier new;background: white;color: black;font-size: 10pt;border-top: black thin solid;border-right: black thin solid">
<p style="margin: 0px">&nbsp;&nbsp;&nbsp; <span style="color: blue">public</span> <span style="color: blue">interface</span> <span style="color: #2b91af">IRepository</span></p>
<p style="margin: 0px">&nbsp;&nbsp;&nbsp; {</p>
<p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: #2b91af">DomainEntity</span> FindByPath(<span style="color: blue">string</span> path);</p>
<p style="margin: 0px">&nbsp;</p>
<p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; RESULT ExecuteScalarCommand&lt;RESULT&gt;(<span style="color: blue">string</span> sqlCommandText);</p>
<p style="margin: 0px">&nbsp;</p>
<p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: green">// Find an Entity by its primary key</span></p>
<p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: green">// We assume and enforce that every Entity</span></p>
<p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: green">// is identified by an &#8220;Id&#8221; property of </span></p>
<p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: green">// type long</span></p>
<p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; T Find&lt;T&gt;(<span style="color: #2b91af">Guid</span> id) <span style="color: blue">where</span> T : <span style="color: #2b91af">Entity</span>;</p>
<p style="margin: 0px">&nbsp;</p>
<p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: green">// Query for a specific type of Entity</span></p>
<p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: green">// with Linq expressions.&nbsp; More on this later</span></p>
<p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: #2b91af">IQueryable</span>&lt;T&gt; Query&lt;T&gt;();</p>
<p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: #2b91af">IQueryable</span>&lt;T&gt; Query&lt;T&gt;(<span style="color: #2b91af">Expression</span>&lt;<span style="color: #2b91af">Func</span>&lt;T, <span style="color: blue">bool</span>&gt;&gt; where);</p>
<p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: #2b91af">IQueryable</span>&lt;T&gt; Query&lt;T&gt;(<span style="color: #2b91af">IQueryExpression</span>&lt;T&gt; queryExpression) <span style="color: blue">where</span> T : <span style="color: #2b91af">DomainEntity</span>;</p>
<p style="margin: 0px">&nbsp;</p>
<p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; T FindBy&lt;T, U&gt;(<span style="color: #2b91af">Expression</span>&lt;<span style="color: #2b91af">Func</span>&lt;T, U&gt;&gt; expression, U search) <span style="color: blue">where</span> T : <span style="color: blue">class</span>;</p>
<p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; T FindBy&lt;T&gt;(<span style="color: #2b91af">Expression</span>&lt;<span style="color: #2b91af">Func</span>&lt;T, <span style="color: blue">bool</span>&gt;&gt; where);</p>
<p style="margin: 0px">&nbsp;</p>
<p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: green">// Basic operations on an Entity</span></p>
<p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: blue">void</span> Delete(<span style="color: blue">object</span> target);</p>
<p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: blue">void</span> Save(<span style="color: blue">object</span> target);</p>
<p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: blue">void</span> Insert(<span style="color: blue">object</span> target);</p>
<p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: blue">void</span> RejectChanges(<span style="color: blue">object</span> target);</p>
<p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; T[] GetAll&lt;T&gt;();</p>
<p style="margin: 0px">&nbsp;&nbsp;&nbsp; }</p>
</div>
<p>&nbsp;</p>
<p>It&rsquo;s way, way&nbsp; beyond the scope of this already long post to discuss the pros and cons of having &ldquo;tight&rdquo; repositories that expose specific queries and hide the save/insert/update methods.&nbsp; For us, this has worked very well.&nbsp; Even if you&rsquo;re using a more strict DDD approach to control who and where domain entities can be updated and reuse queries, I think you could back the specific repositories (CustomerRepository, SaleRepository, etc.) with our generic IRepository.&nbsp; The single biggest reason is because it gives you one simple switch in your IoC tool of choice to switch to:</p>
<div style="border-bottom: black thin solid;border-left: black thin solid;font-family: courier new;background: white;color: black;font-size: 10pt;border-top: black thin solid;border-right: black thin solid">
<p style="margin: 0px">&nbsp;&nbsp;&nbsp; <span style="color: blue">public</span> <span style="color: blue">class</span> <span style="color: #2b91af">InMemoryRepository</span> : <span style="color: #2b91af">IRepository</span></p>
</div>
<p>&nbsp;</p>
<p>that stores objects in memory and uses Linq to Objects for it&rsquo;s querying to be a high performance in memory standin during automated tests.&nbsp; This has been hugely advantageous for us.</p>
<p>Most of the methods in our concrete Repository class just delegate straight to the inner ISession object.</p>
<p>We do not use the longhand way of invoking Linq (the whole Yoda speak version of Sql).&nbsp; Since I think that stuff is completely unreadable, I&rsquo;m perfectly content to just pass little expressions in for ordering and querying.</p>
<p>&nbsp;</p>
<p>I won&rsquo;t get into it unless someone wants it, but we have a simplistic Fluent Interface I named &ldquo;SmartGrid&rdquo; that we use to create NHibernate projects with the older ICriteria mechanism in NHibernate.&nbsp; Here&rsquo;s an example:</p>
<div style="border-bottom: black thin solid;border-left: black thin solid;font-family: courier new;background: white;color: black;font-size: 10pt;border-top: black thin solid;border-right: black thin solid">
<p style="margin: 0px">&nbsp;&nbsp;&nbsp; <span style="color: blue">public</span> <span style="color: blue">class</span> <span style="color: #2b91af">MyCasesGrid</span> : <span style="color: #2b91af">SmartGrid</span>&lt;<span style="color: #2b91af">Case</span>&gt;, <span style="color: #2b91af">IMyCasesQuery</span></p>
<p style="margin: 0px">&nbsp;&nbsp;&nbsp; {</p>
<p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: blue">public</span> MyCasesGrid(<span style="color: #2b91af">ISession</span> session, <span style="color: #2b91af">User</span> user, <span style="color: #2b91af">IUrlRegistry</span> registry, <span style="color: #2b91af">IDisplayFormatter</span> displayFormatter)</p>
<p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; : <span style="color: blue">base</span>(session, registry, displayFormatter)</p>
<p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {</p>
<p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: green">// Sorting</span></p>
<p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; SortAscending(x =&gt; x.Created);</p>
<p style="margin: 0px">&nbsp;</p>
<p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: green">// What to show and fetch from the database</span></p>
<p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ShowViewLink(x =&gt; x.Identifier);</p>
<p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Show(x =&gt; x.Contact.FullName).HeaderFrom(<span style="color: #2b91af">CoreMessageKeys</span>.CONTACT_KEY);</p>
<p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Show(x =&gt; x.Site.Name).OuterJoin().HeaderFrom(<span style="color: #2b91af">CoreMessageKeys</span>.SITE_KEY);</p>
<p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Show(x =&gt; x.Title);</p>
<p style="margin: 0px">&nbsp;</p>
<p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: green">// What data to fetch</span></p>
<p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Where(x =&gt; x.Owner).IsIs(user)</p>
<p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; .And(x =&gt; x.Condition).IsNot(<span style="color: #2b91af">Condition</span>.Closed)</p>
<p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; .And(x =&gt; x.Queue).IsNull();</p>
<p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }</p>
<p style="margin: 0px">&nbsp;&nbsp;&nbsp; }</p>
</div>
<p>This little FI is doing more than setting up the ICriteria projection.&nbsp; It&rsquo;s also configuring how this little &ldquo;gridlet&rdquo; is displaying data and even automagically creating a whole new set of routes in the application to handle paging and sorting requests from the UI.</p>
<p>&nbsp;</p>
<h4><b>Our Workflow</b></h4>
<p>Lastly, I wanted to talk about our workflow and how we go about adding or changing elements in our persistence.&nbsp; The first think I want to say is that persistence related concerns are a very, very small fraction of our total effort.&nbsp; I&rsquo;d even say that database, persistence, or NHibernate related work is no more than 2-3% of our development effort, if that.&nbsp; Contrast that to about 8-10 years ago when better than half of my time was spent on writing DDL, stored procedures, and ADO manipulation code to pull or push data to and from the database.&nbsp; </p>
<p>So what do we do?&nbsp; I typically make the changes I need to our domain model as things come up.&nbsp; I usually like to wrap up the business logic and even the UI code that interacts with the new entity changes first, then turn to making the new changes persistent.&nbsp; To add the persistence, we write an integration test that expresses what fields or properties are supposed to be persisted using a modified version of the mapping testing tools in Fluent NHibernate like this (actually, I don&rsquo;t know if this is still in FNH.&nbsp; Chad &amp; I wrote it originally for what ended up becoming FNH, but it might have gotten tossed out.&nbsp; You have to customize it quite a bit per app anyway.&nbsp; I&rsquo;ll blog on this too if someone wants it):</p>
<div style="border-bottom: black thin solid;border-left: black thin solid;font-family: courier new;background: white;color: black;font-size: 10pt;border-top: black thin solid;border-right: black thin solid">
<p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; [<span style="color: #2b91af">Test</span>]</p>
<p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: blue">public</span> <span style="color: blue">void</span> Save_and_load_a_Site()</p>
<p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {</p>
<p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: #2b91af">IList</span>&lt;<span style="color: #2b91af">Address</span>&gt; addressList = <span style="color: blue">new</span>[]</p>
<p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {</p>
<p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: blue">new</span> <span style="color: #2b91af">Address</span> { Address1 = <span style="color: #a31515">&#8220;123 Main Street&#8221;</span>, City = <span style="color: #a31515">&#8220;Austin&#8221;</span>, PostalCode = <span style="color: #a31515">&#8220;78703&#8243;</span>},</p>
<p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: blue">new</span> <span style="color: #2b91af">Address</span> { Address1 = <span style="color: #a31515">&#8220;456 Main Street&#8221;</span>, City = <span style="color: #a31515">&#8220;Austin&#8221;</span>, PostalCode = <span style="color: #a31515">&#8220;78704&#8243;</span>},</p>
<p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: blue">new</span> <span style="color: #2b91af">Address</span> { Address1 = <span style="color: #a31515">&#8220;789 Main Street&#8221;</span>, City = <span style="color: #a31515">&#8220;Austin&#8221;</span>, PostalCode = <span style="color: #a31515">&#8220;78705&#8243;</span>}</p>
<p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; };</p>
<p style="margin: 0px">&nbsp;</p>
<p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: blue">new</span> <span style="color: #2b91af">VerifyTheMappingsOf</span>&lt;<span style="color: #2b91af">Site</span>&gt;(spec =&gt; spec</p>
<p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; .CheckProperty(s =&gt; s.Identifier, <span style="color: #a31515">&#8220;something&#8221;</span>)</p>
<p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; .CheckProperty(s =&gt; s.Name, <span style="color: #a31515">&#8220;a&#8221;</span>)</p>
<p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; .CheckProperty(s =&gt; s.SiteType, <span style="color: #a31515">&#8220;the site type&#8221;</span>)</p>
<p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; .CheckProperty(s =&gt; s.Phone, <span style="color: #a31515">&#8220;555-555-5555&#8243;</span>)</p>
<p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; .CheckProperty(s =&gt; s.AlternateName, <span style="color: #a31515">&#8220;altname&#8221;</span>)</p>
<p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; .CheckProperty(s =&gt; s.Website, <span style="color: #a31515">&#8220;www.foo.com&#8221;</span>)</p>
<p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; .CheckProperty(s =&gt; s.Status, <span style="color: #a31515">&#8220;Active&#8221;</span>)</p>
<p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; .CheckReference(s =&gt; s.Calendar, <span style="color: #2b91af">ObjectMother</span>.ValidEmptyWorkCalendar(<span style="color: #2b91af">Guid</span>.NewGuid().ToString()))</p>
<p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; .CheckReference(s=&gt; s.PrimaryAddress, addressList[0])</p>
<p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; .CheckReadOnlyList(s =&gt; s.GetAddresses(), addressList, (s, addr) =&gt; s.AddAddress(addr), addr =&gt; addr.Address1));</p>
<p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }</p>
</div>
<p>The test above creates a new Site object with the suggested property values, saves the new Site object in one ISession and gets the newly assigned Id, then fetches a second copy of the new Site object from an entirely new ISession and checks that each property was successfully persisted.&nbsp; All this test really does is exercise the NHibernate mappings end to end just to prove that we can successfully persist and load these properties.&nbsp; After that, we largely assume that NHibernate itself works.&nbsp; I should say that these tests have helped plenty to weed out minor problems in NHibernate configuration as we add new configuration.</p>
<p>Once I&rsquo;ve got the new persistence test in place and it happily fails because we haven&rsquo;t configured anything yet, I add some configuration.&nbsp; In this case I might add a new ClassMap&lt;Site&gt; class to the core assembly with Fluent NHibernate configuration for the Site class:</p>
<div style="border-bottom: black thin solid;border-left: black thin solid;font-family: courier new;background: white;color: black;font-size: 10pt;border-top: black thin solid;border-right: black thin solid">
<p style="margin: 0px">&nbsp;&nbsp;&nbsp; <span style="color: green">// DomainMap&lt;T&gt; is a Dovetail specific</span></p>
<p style="margin: 0px">&nbsp;&nbsp;&nbsp; <span style="color: green">// subclass of ClassMap&lt;T&gt; that adds</span></p>
<p style="margin: 0px">&nbsp;&nbsp;&nbsp; <span style="color: green">// some conventional configuration</span></p>
<p style="margin: 0px">&nbsp;&nbsp;&nbsp; <span style="color: blue">public</span> <span style="color: blue">class</span> <span style="color: #2b91af">SiteMap</span> : <span style="color: #2b91af">DomainMap</span>&lt;<span style="color: #2b91af">Site</span>&gt;</p>
<p style="margin: 0px">&nbsp;&nbsp;&nbsp; {</p>
<p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: blue">public</span> SiteMap()</p>
<p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {</p>
<p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: green">// Map the simple properties</span></p>
<p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Map(s =&gt; s.Identifier);</p>
<p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Map(s =&gt; s.Name);</p>
<p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Map(s =&gt; s.AlternateName);</p>
<p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Map(s =&gt; s.Website);</p>
<p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Map(s =&gt; s.Phone);</p>
<p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Map(s =&gt; s.Fax);</p>
<p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Map(s =&gt; s.SiteType);</p>
<p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Map(s =&gt; s.Status);</p>
<p style="margin: 0px">&nbsp;</p>
<p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: green">// The Site object has an Address property called PrimaryAddress</span></p>
<p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: green">// The code below sets up the mapping for the reference between</span></p>
<p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: green">// Site and the Address class</span></p>
<p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; HasMany(s =&gt; s.GetAddresses())</p>
<p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; .Access.AsCamelCaseField(<span style="color: #2b91af">Prefix</span>.Underscore)</p>
<p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; .Cascade.All();</p>
<p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; References(s =&gt; s.PrimaryAddress).Cascade.All();</p>
<p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; References(s =&gt; s.SupportSite).Cascade.All();</p>
<p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; References(s =&gt; s.Calendar).Cascade.All();</p>
<p style="margin: 0px">&nbsp;</p>
<p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; HasManyToMany(x =&gt; x.GetContracts())</p>
<p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; .LazyLoad()</p>
<p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; .Access.AsCamelCaseField(<span style="color: #2b91af">Prefix</span>.Underscore).Inverse()</p>
<p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; .Cascade.All();</p>
<p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }</p>
<p style="margin: 0px">&nbsp;</p>
<p style="margin: 0px">&nbsp;&nbsp;&nbsp; }</p>
</div>
<p>Now I&rsquo;ve got a mapping configured, but no database changes yet.&nbsp; Easy money, I just run rake target we have called &ldquo;generate_all&rdquo; that compiles the code and rebuilds the database from scratch using NHibernate&rsquo;s hbm2ddl tool to generate the DDL from the mappings (plus adds some baseline data so the application can actually run).&nbsp; We use a lot of conventions to further enrich the NHibernate mappings to add metadata used to generate the DDL.&nbsp; The DDL comes out following our naming conventions for tables, primary keys, foreign keys, and builds columns based on the validation attributes decorating our classes for some Ruby on Rails style DRY-ness.</p>
<p>The entire cycle goes pretty fast.&nbsp; Of course, we&rsquo;ll have to do something more sophisticated like adopt a migrations tool when we go live and have to maintain backwards compatibility with the database schema, but for now, this approach is happily speeding us along.&nbsp; All that time that we spent on painstaking data access coding in the early part of this decade gets put into better testing and leaves time for a vastly better user experience.</p>
<p>&nbsp;</p>
<p>&nbsp;</p>
<p>&nbsp;</p>
<p>As Forrest Gump said, that&rsquo;s all I&rsquo;ve got to say about that.&nbsp; I&rsquo;ll try to jump on questions because it&rsquo;s an absurd amount of information and code to dump on you.&nbsp; But maybe now Weston will stop trying to guilt me into writing this post;-)</p>
<div class="shr-publisher-745"></div><!-- Start Shareaholic LikeButtonSetBottom Automatic --><!-- End Shareaholic LikeButtonSetBottom Automatic -->											</div><!-- .entry-content -->

					<div id="entry-author-info">
						<div id="author-avatar">
							<img alt='' src='http://1.gravatar.com/avatar/db65c5c5cf9f1c51e842f733892eace1?s=60&amp;d=http%3A%2F%2F1.gravatar.com%2Favatar%2Fad516503a11cd5ca435acc9bb6523536%3Fs%3D60&amp;r=G' class='avatar avatar-60 photo' height='60' width='60' />						</div><!-- #author-avatar 	-->
						<div id="author-description">
							<h2>About Jeremy Miller</h2>
							Jeremy is the Chief Software Architect at Dovetail Software, the coolest ISV in Austin.  Jeremy began his IT career writing "Shadow IT" applications to automate his engineering documentation, then wandered into software development because it looked like more fun. Jeremy is the author of the open source StructureMap tool for Dependency Injection with .Net, StoryTeller for supercharged acceptance testing in .Net, and one of the principal developers behind FubuMVC.  Jeremy's thoughts on all things software can be found at The Shade Tree Developer at http://codebetter.com/jeremymiller.							<div id="author-link">
								<a href="http://codebetter.com/jeremymiller/author/jeremymiller/" title="View all posts by Jeremy Miller">View all posts by Jeremy Miller &rarr;</a>
							</div><!-- #author-link	-->
						</div><!-- #author-description	-->
					</div><!-- .entry-author-info -->

					<div class="entry-utility">
					This entry was posted in <a href="http://codebetter.com/jeremymiller/category/database-and-persistence/" title="View all posts in Database and Persistence" rel="category tag">Database and Persistence</a>, <a href="http://codebetter.com/jeremymiller/category/di/" title="View all posts in DI" rel="category tag">DI</a>, <a href="http://codebetter.com/jeremymiller/category/fubumvc/" title="View all posts in FubuMVC" rel="category tag">FubuMVC</a>, <a href="http://codebetter.com/jeremymiller/category/ioc/" title="View all posts in IOC" rel="category tag">IOC</a>, <a href="http://codebetter.com/jeremymiller/category/structuremap/" title="View all posts in StructureMap" rel="category tag">StructureMap</a>. Bookmark the <a href="http://codebetter.com/jeremymiller/2010/01/06/how-dovetail-uses-structuremap-with-nhibernate/" title="Permalink to How Dovetail uses NHibernate with StructureMap" rel="bookmark">permalink</a>. Follow any comments here with the <a href="http://codebetter.com/jeremymiller/2010/01/06/how-dovetail-uses-structuremap-with-nhibernate/feed/" title="Comments RSS to How Dovetail uses NHibernate with StructureMap" rel="alternate" type="application/rss+xml">RSS feed for this post</a>.
					</div><!-- .entry-utility -->
				</div><!-- #post-745 -->

				<div id="nav-below" class="navigation">
					<div class="nav-previous"><a href="http://codebetter.com/jeremymiller/2010/01/04/fubumvc-diagnostics-sneak-peek/" rel="prev"><span class="meta-nav">&larr;</span> FubuMVC Diagnostics Sneak Peek</a></div>
					<div class="nav-next"><a href="http://codebetter.com/jeremymiller/2010/01/07/writing-internal-dsl-s-in-msdn/" rel="next">Writing Internal DSL&#8217;s in MSDN <span class="meta-nav">&rarr;</span></a></div>
				</div><!-- #nav-below -->

				
<div id="disqus_thread">
                    <div id="dsq-content">
            <ul id="dsq-comments">
                    <li id="dsq-comment-6042">
                    <div id="dsq-comment-header-6042" class="dsq-comment-header">
                        <cite id="dsq-cite-6042">
    http://flux88.com                            <span id="dsq-author-user-6042">Ben Scheirman</span>
                            </cite>
                    </div>
                    <div id="dsq-comment-body-6042" class="dsq-comment-body">
                        <div id="dsq-comment-message-6042" class="dsq-comment-message"><p>Thanks for writing this.  I always enjoy seeing how other folks utilize NHibernate.</p>
</div>
                    </div>
                </li>
                    <li id="dsq-comment-6043">
                    <div id="dsq-comment-header-6043" class="dsq-comment-header">
                        <cite id="dsq-cite-6043">
    http://codebetter.com/members/mob/default.aspx                            <span id="dsq-author-user-6043">Mike O&#8217;Brien</span>
                            </cite>
                    </div>
                    <div id="dsq-comment-body-6043" class="dsq-comment-body">
                        <div id="dsq-comment-message-6043" class="dsq-comment-message"><p>Thanks for your hard work Jeremy. ConnectImplementationsToTypesClosing rocks!</p>
<p>m</p>
</div>
                    </div>
                </li>
                    <li id="dsq-comment-6044">
                    <div id="dsq-comment-header-6044" class="dsq-comment-header">
                        <cite id="dsq-cite-6044">
    http://joshuaflanagan.lostechies.com                            <span id="dsq-author-user-6044">Joshua Flanagan</span>
                            </cite>
                    </div>
                    <div id="dsq-comment-body-6044" class="dsq-comment-body">
                        <div id="dsq-comment-message-6044" class="dsq-comment-message"><p>At the end of the Bootstrapping Nhibernate section above, Jeremy mention that StructureMap knows how to build the DatabaseSettings class from app.config. If you are curious how that works, I wrote it up at:<br />
<a href="http://www.lostechies.com/blogs/joshuaflanagan/archive/2009/07/12/how-we-handle-application-configuration.aspx" rel="nofollow">http://www.lostechies.com/blogs/joshuaflanagan/archive/2009/07/12/how-we-handle-application-configuration.aspx</a></p>
</div>
                    </div>
                </li>
                    <li id="dsq-comment-6045">
                    <div id="dsq-comment-header-6045" class="dsq-comment-header">
                        <cite id="dsq-cite-6045">
    http://blog.coreycoogan.com                            <span id="dsq-author-user-6045">corey coogan</span>
                            </cite>
                    </div>
                    <div id="dsq-comment-body-6045" class="dsq-comment-body">
                        <div id="dsq-comment-message-6045" class="dsq-comment-message"><p>Great article Jeremy.  I really enjoy the detail you put into these.</p>
<p>I, personally, would very much like to see more of the SmartGrid.  I&#8217;m not a bug UI guy and anything that makes that easier is always great to learn.</p>
</div>
                    </div>
                </li>
                    <li id="dsq-comment-6046">
                    <div id="dsq-comment-header-6046" class="dsq-comment-header">
                        <cite id="dsq-cite-6046">
                                <span id="dsq-author-user-6046">Dirk</span>
                            </cite>
                    </div>
                    <div id="dsq-comment-body-6046" class="dsq-comment-body">
                        <div id="dsq-comment-message-6046" class="dsq-comment-message"><p>So when the web request first comes in a singleton instance of<br />
SessionFactory is created for that web request, is this then cached for<br />
subsequent requests?</p>
<p>So the question is do you cache the SessionFactory?</p>
</div>
                    </div>
                </li>
                    <li id="dsq-comment-6047">
                    <div id="dsq-comment-header-6047" class="dsq-comment-header">
                        <cite id="dsq-cite-6047">
    http://chadmyers.lostechies.com                            <span id="dsq-author-user-6047">Chad Myers</span>
                            </cite>
                    </div>
                    <div id="dsq-comment-body-6047" class="dsq-comment-body">
                        <div id="dsq-comment-message-6047" class="dsq-comment-message"><p>@Dirk:</p>
<p>No, it&#8217;s a singleton for the entire app domain.  It&#8217;s created the first time someone requests it (in our case, in Application_Start) and survives for the rest of the application.</p>
</div>
                    </div>
                </li>
                    <li id="dsq-comment-6048">
                    <div id="dsq-comment-header-6048" class="dsq-comment-header">
                        <cite id="dsq-cite-6048">
                                <span id="dsq-author-user-6048">Dirk</span>
                            </cite>
                    </div>
                    <div id="dsq-comment-body-6048" class="dsq-comment-body">
                        <div id="dsq-comment-message-6048" class="dsq-comment-message"><p>Thanks for the reply Chad.</p>
<p>So would you mind telling me where or how it is stored?</p>
<p>Thanks</p>
</div>
                    </div>
                </li>
                    <li id="dsq-comment-6049">
                    <div id="dsq-comment-header-6049" class="dsq-comment-header">
                        <cite id="dsq-cite-6049">
    http://chadmyers.lostechies.com                            <span id="dsq-author-user-6049">Chad Myers</span>
                            </cite>
                    </div>
                    <div id="dsq-comment-body-6049" class="dsq-comment-body">
                        <div id="dsq-comment-message-6049" class="dsq-comment-message"><p>@Dirk:</p>
<p>It&#8217;s a singleton instance. StructureMap&#8217;s container has a reference to it.</p>
<p>It seems like you may not understand what a &#8220;Singleton&#8221; is. You should read up on this pattern a little as it will help you understand what&#8217;s going on here.</p>
</div>
                    </div>
                </li>
                    <li id="dsq-comment-6050">
                    <div id="dsq-comment-header-6050" class="dsq-comment-header">
                        <cite id="dsq-cite-6050">
                                <span id="dsq-author-user-6050">Dirk</span>
                            </cite>
                    </div>
                    <div id="dsq-comment-body-6050" class="dsq-comment-body">
                        <div id="dsq-comment-message-6050" class="dsq-comment-message"><p>@Chad</p>
<p>No I get what a singleton is and why you would need it here, I was just wondering how you actually store it. e.g. Application cache.</p>
<p>The thing is I think I have been doing this wrong and creating a sessionfactory per request, which gets the job done but in light of this thread is not the best way to be doing things. So I just wanted to know where I should be storing it, with the Application cache seeming a good choice.</p>
<p>Thanks again for the reply.</p>
</div>
                    </div>
                </li>
                    <li id="dsq-comment-6051">
                    <div id="dsq-comment-header-6051" class="dsq-comment-header">
                        <cite id="dsq-cite-6051">
    http://chadmyers.lostechies.com                            <span id="dsq-author-user-6051">Chad Myers</span>
                            </cite>
                    </div>
                    <div id="dsq-comment-body-6051" class="dsq-comment-body">
                        <div id="dsq-comment-message-6051" class="dsq-comment-message"><p>@Dirk:</p>
<p>Why not just mark it as Singleton and let StructureMap deal with the lifecycle issues?</p>
<p>Or are you not using StructureMap?</p>
</div>
                    </div>
                </li>
                    <li id="dsq-comment-6052">
                    <div id="dsq-comment-header-6052" class="dsq-comment-header">
                        <cite id="dsq-cite-6052">
                                <span id="dsq-author-user-6052">Dirk</span>
                            </cite>
                    </div>
                    <div id="dsq-comment-body-6052" class="dsq-comment-body">
                        <div id="dsq-comment-message-6052" class="dsq-comment-message"><p>@Chad</p>
<p>Yes thats right I am not using Structuremap yet, its on my list though I promise <img src='http://cdn1.codebetter.com/wp-includes/images/smilies/icon_biggrin.gif' alt=':D' class='wp-smiley' /> </p>
<p>Presumably you would still need to cache StructureMap? Sorry about the caching questions!!</p>
</div>
                    </div>
                </li>
                    <li id="dsq-comment-6053">
                    <div id="dsq-comment-header-6053" class="dsq-comment-header">
                        <cite id="dsq-cite-6053">
    http://codebetter.com/members/jmiller/default.aspx                            <span id="dsq-author-user-6053">Jeremy D. Miller</span>
                            </cite>
                    </div>
                    <div id="dsq-comment-body-6053" class="dsq-comment-body">
                        <div id="dsq-comment-message-6053" class="dsq-comment-message"><p>@Dirk,</p>
<p>The &#8220;main&#8221; StructureMap container held by the ObjectFactory class is a singleton.  The StructureMap container itself manages the lifecycle of everything else.</p>
</div>
                    </div>
                </li>
                    <li id="dsq-comment-6054">
                    <div id="dsq-comment-header-6054" class="dsq-comment-header">
                        <cite id="dsq-cite-6054">
    http://blog.coreycoogan.com                            <span id="dsq-author-user-6054">Corey Coogan</span>
                            </cite>
                    </div>
                    <div id="dsq-comment-body-6054" class="dsq-comment-body">
                        <div id="dsq-comment-message-6054" class="dsq-comment-message"><p>Hey Jeremy,<br />
   I&#8217;m trying to sort some of this stuff for an NH pilot and think your ITransactionBoundary and ITransactionProcessor fit the bill.</p>
<p>Any chance you could post all the code for the TransactionProcessor?</p>
</div>
                    </div>
                </li>
                    <li id="dsq-comment-6055">
                    <div id="dsq-comment-header-6055" class="dsq-comment-header">
                        <cite id="dsq-cite-6055">
    http://codebetter.com/members/jmiller/default.aspx                            <span id="dsq-author-user-6055">Jeremy D. Miller</span>
                            </cite>
                    </div>
                    <div id="dsq-comment-body-6055" class="dsq-comment-body">
                        <div id="dsq-comment-message-6055" class="dsq-comment-message"><p>@Corey,</p>
<p>    public interface ITransactionProcessor<br />
    {<br />
        void Execute<t>(Action</t><t> action);<br />
        RETURN Execute</t><t , RETURN>(Func</t><t , RETURN> func);<br />
        void Execute</t><t>(Action</t><t , IContainer> action);<br />
        void Execute</t><t>(string instanceName, Action</t><t> action);<br />
    }</p>
<p>    public class TransactionProcessor : ITransactionProcessor<br />
    {<br />
        private readonly object _locker = new object();<br />
        private IContainer _container;</p>
<p>        public TransactionProcessor(IContainer container)<br />
        {<br />
            _container = container;<br />
        }</p>
<p>        public IContainer Container<br />
        {<br />
            get { return _container; }<br />
            set<br />
            {<br />
                lock (_locker)<br />
                {<br />
                    _container = value;<br />
                }<br />
            }<br />
        }</p>
<p>        #region ITransactionProcessor Members</p>
<p>        public void Execute</t><t>(Action</t><t> action)<br />
        {<br />
            execute(c =><br />
            {<br />
                var service = c.GetInstance</t><t>();<br />
                action(service);<br />
            });<br />
        }</p>
<p>        public RETURN Execute</t><t , RETURN>(Func</t><t , RETURN> func)<br />
        {<br />
            RETURN result = default(RETURN);<br />
            execute(c =><br />
            {<br />
                var service = c.GetInstance</t><t>();<br />
                result = func(service);<br />
            });<br />
            return result;<br />
        }</p>
<p>        public void Execute</t><t>(Action</t><t , IContainer> action)<br />
        {<br />
            execute(c =><br />
            {<br />
                var service = c.GetInstance</t><t>();<br />
                action(service, c);<br />
            });<br />
        }</p>
<p>        public void Execute</t><t>(string instanceName, Action</t><t> action)<br />
        {<br />
            execute(c =><br />
            {<br />
                var service = c.GetInstance</t><t>(instanceName);<br />
                action(service);<br />
            });<br />
        }</p>
<p>        #endregion</p>
<p>        private void execute(Action<icontainer> action)<br />
        {<br />
            IContainer container = null;<br />
            lock (_locker)<br />
            {<br />
                container = _container;<br />
            }</p>
<p>            using (IContainer nestedContainer = container.GetNestedContainer())<br />
            using (var boundary = nestedContainer.GetInstance<itransactionboundary>())<br />
            {<br />
                boundary.Start();<br />
                action(nestedContainer);<br />
                boundary.Commit();<br />
            }<br />
        }<br />
    }</itransactionboundary></icontainer></t></p>
</div>
                    </div>
                </li>
                    <li id="dsq-comment-6056">
                    <div id="dsq-comment-header-6056" class="dsq-comment-header">
                        <cite id="dsq-cite-6056">
    http://blog.coreycoogan.com                            <span id="dsq-author-user-6056">Corey Coogan</span>
                            </cite>
                    </div>
                    <div id="dsq-comment-body-6056" class="dsq-comment-body">
                        <div id="dsq-comment-message-6056" class="dsq-comment-message"><p>What a tremendous help Jeremy.  Thanks alot.</p>
<p>corey</p>
</div>
                    </div>
                </li>
                    <li id="dsq-comment-6057">
                    <div id="dsq-comment-header-6057" class="dsq-comment-header">
                        <cite id="dsq-cite-6057">
                                <span id="dsq-author-user-6057">Chris</span>
                            </cite>
                    </div>
                    <div id="dsq-comment-body-6057" class="dsq-comment-body">
                        <div id="dsq-comment-message-6057" class="dsq-comment-message"><p>I&#8217;m currently setting up a new FuBuMvc project using a similar approach.  </p>
<p>Any chance you could post the ExecuteInTransaction extension method?</p>
</div>
                    </div>
                </li>
                    <li id="dsq-comment-6058">
                    <div id="dsq-comment-header-6058" class="dsq-comment-header">
                        <cite id="dsq-cite-6058">
                                <span id="dsq-author-user-6058">Chris</span>
                            </cite>
                    </div>
                    <div id="dsq-comment-body-6058" class="dsq-comment-body">
                        <div id="dsq-comment-message-6058" class="dsq-comment-message"><p>Never mind, figured it out from another post!</p>
</div>
                    </div>
                </li>
                    <li id="dsq-comment-6059">
                    <div id="dsq-comment-header-6059" class="dsq-comment-header">
                        <cite id="dsq-cite-6059">
                                <span id="dsq-author-user-6059">J</span>
                            </cite>
                    </div>
                    <div id="dsq-comment-body-6059" class="dsq-comment-body">
                        <div id="dsq-comment-message-6059" class="dsq-comment-message"><p>Hi great post! Will consider it next time i write a webbapp!<br />
Wouldnt return transaction.Session in CoreRegistry / setupNHibernate() caus an exception because of the ensure_initialized in NHibernateTransactionBoundary? </p>
</div>
                    </div>
                </li>
                    <li id="dsq-comment-6060">
                    <div id="dsq-comment-header-6060" class="dsq-comment-header">
                        <cite id="dsq-cite-6060">
    http://codebetter.com/members/jmiller/default.aspx                            <span id="dsq-author-user-6060">Jeremy D. Miller</span>
                            </cite>
                    </div>
                    <div id="dsq-comment-body-6060" class="dsq-comment-body">
                        <div id="dsq-comment-message-6060" class="dsq-comment-message"><p>@J,</p>
<p>If you hadn&#8217;t already initialized the transaction before requesting the ISession, yes it would throw an exception.  That&#8217;s a purposeful defensive coding check we did because we retrofitted this stuff in late in the game and it forced us to make the session mgmt correct.</p>
<p>That&#8217;s the part I wouldn&#8217;t particularly recommend.  You might call this &#8220;what we did&#8221; and definitely not &#8220;what I think you should do.&#8221;</p>
</div>
                    </div>
                </li>
                    <li id="dsq-comment-6061">
                    <div id="dsq-comment-header-6061" class="dsq-comment-header">
                        <cite id="dsq-cite-6061">
    http://sm-art.biz                            <span id="dsq-author-user-6061">ulu</span>
                            </cite>
                    </div>
                    <div id="dsq-comment-body-6061" class="dsq-comment-body">
                        <div id="dsq-comment-message-6061" class="dsq-comment-message"><p>Has anybody ever had problems with multiple AppDomains per Web site? I don&#8217;t know about IIS7, but this thing happened to me while I was using IIS6. Suddenly I had several instances of my singleton, and it was acting weird!</p>
<p>Shouldn&#8217;t be a problem with SessionFactory, but you should be aware of this.</p>
</div>
                    </div>
                </li>
                    <li id="dsq-comment-6062">
                    <div id="dsq-comment-header-6062" class="dsq-comment-header">
                        <cite id="dsq-cite-6062">
    http://elegantcode.com                            <span id="dsq-author-user-6062">Ryan Kelley</span>
                            </cite>
                    </div>
                    <div id="dsq-comment-body-6062" class="dsq-comment-body">
                        <div id="dsq-comment-message-6062" class="dsq-comment-message"><p>Jeremy, How are you guys wrapping all the transaction stuff to do your Persistence Testing? I keep getting errors about the transaction not being started.</p>
</div>
                    </div>
                </li>
                    <li id="dsq-comment-6063">
                    <div id="dsq-comment-header-6063" class="dsq-comment-header">
                        <cite id="dsq-cite-6063">
    http://fknet.wordpress.com                            <span id="dsq-author-user-6063">Frantisek</span>
                            </cite>
                    </div>
                    <div id="dsq-comment-body-6063" class="dsq-comment-body">
                        <div id="dsq-comment-message-6063" class="dsq-comment-message"><p>Jeremy, coool blog entry. I like the idea with workflow: NHibernate integration tests, fluent NHibernate, &#8220;generate_all&#8221;. </p>
<p>If you would have a time, could you write a blog about it, please ;o)?</p>
</div>
                    </div>
                </li>
                    <li id="dsq-comment-6064">
                    <div id="dsq-comment-header-6064" class="dsq-comment-header">
                        <cite id="dsq-cite-6064">
    http://www.mikehenry.name/                            <span id="dsq-author-user-6064">Mike Henry</span>
                            </cite>
                    </div>
                    <div id="dsq-comment-body-6064" class="dsq-comment-body">
                        <div id="dsq-comment-message-6064" class="dsq-comment-message"><p>Thanks for the article. When and how does TransactionProcessor.Execute() get called (and thus make use of the nested container and transaction boundary)?</p>
</div>
                    </div>
                </li>
                    <li id="dsq-comment-6065">
                    <div id="dsq-comment-header-6065" class="dsq-comment-header">
                        <cite id="dsq-cite-6065">
    http://codebetter.com/members/jmiller/default.aspx                            <span id="dsq-author-user-6065">Jeremy D. Miller</span>
                            </cite>
                    </div>
                    <div id="dsq-comment-body-6065" class="dsq-comment-body">
                        <div id="dsq-comment-message-6065" class="dsq-comment-message"><p>@Mike,</p>
<p>TransactionProcessor.Execute() happens inside a FubuMVC behavior and wraps the rest of the pipeline.  There isn&#8217;t an exact analogue in MSMVC.</p>
</div>
                    </div>
                </li>
                    <li id="dsq-comment-6066">
                    <div id="dsq-comment-header-6066" class="dsq-comment-header">
                        <cite id="dsq-cite-6066">
    http://codebetter.com/members/sdrk/default.aspx                            <span id="dsq-author-user-6066">sdrk</span>
                            </cite>
                    </div>
                    <div id="dsq-comment-body-6066" class="dsq-comment-body">
                        <div id="dsq-comment-message-6066" class="dsq-comment-message"><p>Jeremy, </p>
<p>you mention that we can create several object graphs with service location calls to the nested container and any subsequent method calls to any of these services will be scoped (use the same ISession etc. )</p>
<p>However consider the following code from one of your other posts:-</p>
<p>var transaction = ObjectFactory.GetInstance<itransactionprocessor>();<br />
transaction.Execute<datadriver>(x => x.ClearData());</p>
<p>In this case, DataDriver and its object dependencies will be constructed using a new nested container and all the code inside ClearData will be scoped. </p>
<p>How can i use the TransactionProcessor to create instances of multiple services like DataDriver and say DataConsumer and invoke some methods on them within the same transaction boundary. </p>
<p>I know i can do that using &#8211; using blocks of nested container/ transaction boundary directly and create instances of all the services i need and invoking methods on them. (but this will result in lot of redundant code</p>
<p>But how to achieve the same using transactionprocessor ?</p>
<p>Thanks.</p>
<p>Nested Container Rocks !!</p>
<p></datadriver></itransactionprocessor></p>
</div>
                    </div>
                </li>
                    <li id="dsq-comment-6067">
                    <div id="dsq-comment-header-6067" class="dsq-comment-header">
                        <cite id="dsq-cite-6067">
    http://codebetter.com/members/sdrk/default.aspx                            <span id="dsq-author-user-6067">sdrk</span>
                            </cite>
                    </div>
                    <div id="dsq-comment-body-6067" class="dsq-comment-body">
                        <div id="dsq-comment-message-6067" class="dsq-comment-message"><p>Jeremy, </p>
<p>you mention that we can create several object graphs with service location calls to the nested container and any subsequent method calls to any of these services will be scoped (use the same ISession etc. )</p>
<p>However consider the following code from one of your other posts:-</p>
<p>var transaction = ObjectFactory.GetInstance<itransactionprocessor>();<br />
transaction.Execute<datadriver>(x => x.ClearData());</p>
<p>In this case, DataDriver and its object dependencies will be constructed using a new nested container and all the code inside ClearData will be scoped. </p>
<p>How can i use the TransactionProcessor to create instances of multiple services like DataDriver and say DataConsumer and invoke some methods on them within the same transaction boundary. </p>
<p>I know i can do that using &#8211; using blocks of nested container/ transaction boundary directly and create instances of all the services i need and invoking methods on them. (but this will result in lot of redundant code</p>
<p>But how to achieve the same using transactionprocessor ?</p>
<p>Thanks.</p>
<p>Nested Container Rocks !!</p>
<p></datadriver></itransactionprocessor></p>
</div>
                    </div>
                </li>
                </ul>
        </div>
    </div>

<script type="text/javascript">
/* <![CDATA[ */
    var disqus_url = 'http://codebetter.com/jeremymiller/2010/01/06/how-dovetail-uses-structuremap-with-nhibernate/';
    var disqus_identifier = '745 /blogs/jeremy.miller/archive/2010/01/06/how-dovetail-uses-structuremap-with-nhibernate.aspx';
    var disqus_container_id = 'disqus_thread';
    var disqus_domain = 'disqus.com';
    var disqus_shortname = 'theshadetreedeveloper';
    var disqus_title = "How Dovetail uses NHibernate with StructureMap";
        var disqus_config = function () {
        var config = this; // Access to the config object

        /* 
           All currently supported events:
            * preData  fires just before we request for initial data
            * preInit - fires after we get initial data but before we load any dependencies
            * onInit  - fires when all dependencies are resolved but before dtpl template is rendered
            * afterRender - fires when template is rendered but before we show it
            * onReady - everything is done
         */

        config.callbacks.preData.push(function() {
            // clear out the container (its filled for SEO/legacy purposes)
            document.getElementById(disqus_container_id).innerHTML = '';
        });
                config.callbacks.onReady.push(function() {
            // sync comments in the background so we don't block the page
            DISQUS.request.get('?cf_action=sync_comments&post_id=745');
        });
                    };
    var facebookXdReceiverPath = 'http://cdn1.codebetter.com/wp-content/plugins/disqus-comment-system/xd_receiver.htm';
/* ]]> */
</script>

<script type="text/javascript">
/* <![CDATA[ */
    var DsqLocal = {
        'trackbacks': [
        ],
        'trackback_url': "http:\/\/codebetter.com\/jeremymiller\/2010\/01\/06\/how-dovetail-uses-structuremap-with-nhibernate\/trackback\/"    };
/* ]]> */
</script>

<script type="text/javascript">
/* <![CDATA[ */
(function() {
    var dsq = document.createElement('script'); dsq.type = 'text/javascript';
    dsq.async = true;
    dsq.src = 'http://' + disqus_shortname + '.' + disqus_domain + '/embed.js?pname=wordpress&pver=2.67';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();
/* ]]> */
</script>

		</div><!-- #main -->
			<div id="sidebar" class="grid_4">

		<div id="primary" class="widget-area">
			<ul class="xoxo">
				<div class="ad-container">
<script type='text/javascript'><!--// <![CDATA[
    OA_show(29416);
// ]]> --></script><noscript><a target='_blank' href='http://d1.openx.org/ck.php?n=2782afb'><img border='0' alt='' src='http://d1.openx.org/avw.php?zoneid=29416&amp;n=2782afb' /></a></noscript><script type='text/javascript'><!--// <![CDATA[
    OA_show(29417);
// ]]> --></script><noscript><a target='_blank' href='http://d1.openx.org/ck.php?n=e94cea6'><img border='0' alt='' src='http://d1.openx.org/avw.php?zoneid=29417&amp;n=e94cea6' /></a></noscript><script type='text/javascript'><!--// <![CDATA[
    OA_show(29418);
// ]]> --></script><noscript><a target='_blank' href='http://d1.openx.org/ck.php?n=9ba3022'><img border='0' alt='' src='http://d1.openx.org/avw.php?zoneid=29418&amp;n=9ba3022' /></a></noscript><script type='text/javascript'><!--// <![CDATA[
    OA_show(29419);
// ]]> --></script><noscript><a target='_blank' href='http://d1.openx.org/ck.php?n=f467b52'><img border='0' alt='' src='http://d1.openx.org/avw.php?zoneid=29419&amp;n=f467b52' /></a></noscript>
				</div>
			
				<li id="user_bio-2" class="widget-container widget_user_bio"><h3 class="widget-title">The Shade Tree Developer</h3>Jeremy is the Chief Software Architect at Dovetail Software, the coolest ISV in Austin.  Jeremy began his IT career writing "Shadow IT" applications to automate his engineering documentation, then wandered into software development because it looked like more fun. Jeremy is the author of the open source StructureMap tool for Dependency Injection with .Net, StoryTeller for supercharged acceptance testing in .Net, and one of the principal developers behind FubuMVC.  Jeremy's thoughts on all things software can be found at The Shade Tree Developer at http://codebetter.com/jeremymiller.
</li><li id="text-3" class="widget-container widget_text"><h3 class="widget-title">Upcoming posts&#8230;</h3>			<div class="textwidget"><p>How I'm using StoryTeller to test FubuMVC<br />
Building a "Lookup" html convention w/ FubuMVC<br />
FubuMVC's Configuration Model "Special Sauce"<br />
Managing Script dependencies with FubuMVC<br />
Authorization and FubuMVC<br />
Continuations<br />
Composing Views with FubuMVC<br />
Extensible Model Binding with FubuMVC<br />
Introducing "Bottles"<br />
Modular Packaging with FubuMVC<br />
Self-Installing Apps w/ FubuMVC<br />
Routing and Behavioral Conventions with FubuMVC<br />
What Should I Learn?</p>
</div>
		</li><li id="linkcat-1046" class="widget-container widget_links"><h3 class="widget-title">Blogroll</h3>
	<ul class='xoxo blogroll'>
<li><a href="http://twitter.com/jeremydmiller">Follow me on Twitter</a></li>
<li><a href="https://github.com/DarthFubuMVC/fubumvc" target="_blank">FubuMVC on GitHub</a></li>
<li><a href="https://github.com/jeremydmiller">My GitHub Page</a></li>
<li><a href="https://github.com/storyteller/storyteller">StoryTeller on GitHub</a></li>
<li><a href="https://github.com/structuremap/structuremap">StructureMap on GitHub</a></li>

	</ul>
</li>
		
						
			</ul>
			
		</div><!-- #primary .widget-area -->
		
		<div id="secondary" class="widget-area">
				
<script type='text/javascript'><!--// <![CDATA[
    OA_show(220407);
// ]]> --></script><noscript><a target='_blank' href='http://d1.openx.org/ck.php?n=68b8307'><img border='0' alt='' src='http://d1.openx.org/avw.php?zoneid=220407&amp;n=68b8307' /></a></noscript>				
				
				<ul class="xoxo">		
					<li id="archives-2" class="widget-container widget_archive"><h3 class="widget-title">Archives</h3>		<ul>
			<li><a href='http://codebetter.com/jeremymiller/2012/01/' title='January 2012'>January 2012</a></li>
	<li><a href='http://codebetter.com/jeremymiller/2011/09/' title='September 2011'>September 2011</a></li>
	<li><a href='http://codebetter.com/jeremymiller/2011/07/' title='July 2011'>July 2011</a></li>
	<li><a href='http://codebetter.com/jeremymiller/2011/06/' title='June 2011'>June 2011</a></li>
	<li><a href='http://codebetter.com/jeremymiller/2011/05/' title='May 2011'>May 2011</a></li>
	<li><a href='http://codebetter.com/jeremymiller/2011/04/' title='April 2011'>April 2011</a></li>
	<li><a href='http://codebetter.com/jeremymiller/2011/03/' title='March 2011'>March 2011</a></li>
	<li><a href='http://codebetter.com/jeremymiller/2011/01/' title='January 2011'>January 2011</a></li>
	<li><a href='http://codebetter.com/jeremymiller/2010/12/' title='December 2010'>December 2010</a></li>
	<li><a href='http://codebetter.com/jeremymiller/2010/09/' title='September 2010'>September 2010</a></li>
	<li><a href='http://codebetter.com/jeremymiller/2010/08/' title='August 2010'>August 2010</a></li>
	<li><a href='http://codebetter.com/jeremymiller/2010/07/' title='July 2010'>July 2010</a></li>
	<li><a href='http://codebetter.com/jeremymiller/2010/06/' title='June 2010'>June 2010</a></li>
	<li><a href='http://codebetter.com/jeremymiller/2010/05/' title='May 2010'>May 2010</a></li>
	<li><a href='http://codebetter.com/jeremymiller/2010/03/' title='March 2010'>March 2010</a></li>
	<li><a href='http://codebetter.com/jeremymiller/2010/02/' title='February 2010'>February 2010</a></li>
	<li><a href='http://codebetter.com/jeremymiller/2010/01/' title='January 2010'>January 2010</a></li>
	<li><a href='http://codebetter.com/jeremymiller/2009/12/' title='December 2009'>December 2009</a></li>
	<li><a href='http://codebetter.com/jeremymiller/2009/11/' title='November 2009'>November 2009</a></li>
	<li><a href='http://codebetter.com/jeremymiller/2009/10/' title='October 2009'>October 2009</a></li>
	<li><a href='http://codebetter.com/jeremymiller/2009/09/' title='September 2009'>September 2009</a></li>
	<li><a href='http://codebetter.com/jeremymiller/2009/08/' title='August 2009'>August 2009</a></li>
	<li><a href='http://codebetter.com/jeremymiller/2009/07/' title='July 2009'>July 2009</a></li>
	<li><a href='http://codebetter.com/jeremymiller/2009/06/' title='June 2009'>June 2009</a></li>
	<li><a href='http://codebetter.com/jeremymiller/2009/05/' title='May 2009'>May 2009</a></li>
	<li><a href='http://codebetter.com/jeremymiller/2009/04/' title='April 2009'>April 2009</a></li>
	<li><a href='http://codebetter.com/jeremymiller/2009/03/' title='March 2009'>March 2009</a></li>
	<li><a href='http://codebetter.com/jeremymiller/2009/02/' title='February 2009'>February 2009</a></li>
	<li><a href='http://codebetter.com/jeremymiller/2009/01/' title='January 2009'>January 2009</a></li>
	<li><a href='http://codebetter.com/jeremymiller/2008/12/' title='December 2008'>December 2008</a></li>
	<li><a href='http://codebetter.com/jeremymiller/2008/11/' title='November 2008'>November 2008</a></li>
	<li><a href='http://codebetter.com/jeremymiller/2008/10/' title='October 2008'>October 2008</a></li>
	<li><a href='http://codebetter.com/jeremymiller/2008/09/' title='September 2008'>September 2008</a></li>
	<li><a href='http://codebetter.com/jeremymiller/2008/08/' title='August 2008'>August 2008</a></li>
	<li><a href='http://codebetter.com/jeremymiller/2008/07/' title='July 2008'>July 2008</a></li>
	<li><a href='http://codebetter.com/jeremymiller/2008/06/' title='June 2008'>June 2008</a></li>
	<li><a href='http://codebetter.com/jeremymiller/2008/05/' title='May 2008'>May 2008</a></li>
	<li><a href='http://codebetter.com/jeremymiller/2008/04/' title='April 2008'>April 2008</a></li>
	<li><a href='http://codebetter.com/jeremymiller/2008/03/' title='March 2008'>March 2008</a></li>
	<li><a href='http://codebetter.com/jeremymiller/2008/02/' title='February 2008'>February 2008</a></li>
	<li><a href='http://codebetter.com/jeremymiller/2008/01/' title='January 2008'>January 2008</a></li>
	<li><a href='http://codebetter.com/jeremymiller/2007/12/' title='December 2007'>December 2007</a></li>
	<li><a href='http://codebetter.com/jeremymiller/2007/11/' title='November 2007'>November 2007</a></li>
	<li><a href='http://codebetter.com/jeremymiller/2007/10/' title='October 2007'>October 2007</a></li>
	<li><a href='http://codebetter.com/jeremymiller/2007/09/' title='September 2007'>September 2007</a></li>
	<li><a href='http://codebetter.com/jeremymiller/2007/08/' title='August 2007'>August 2007</a></li>
	<li><a href='http://codebetter.com/jeremymiller/2007/07/' title='July 2007'>July 2007</a></li>
	<li><a href='http://codebetter.com/jeremymiller/2007/06/' title='June 2007'>June 2007</a></li>
	<li><a href='http://codebetter.com/jeremymiller/2007/05/' title='May 2007'>May 2007</a></li>
	<li><a href='http://codebetter.com/jeremymiller/2007/04/' title='April 2007'>April 2007</a></li>
	<li><a href='http://codebetter.com/jeremymiller/2007/03/' title='March 2007'>March 2007</a></li>
	<li><a href='http://codebetter.com/jeremymiller/2007/02/' title='February 2007'>February 2007</a></li>
	<li><a href='http://codebetter.com/jeremymiller/2007/01/' title='January 2007'>January 2007</a></li>
	<li><a href='http://codebetter.com/jeremymiller/2006/12/' title='December 2006'>December 2006</a></li>
	<li><a href='http://codebetter.com/jeremymiller/2006/11/' title='November 2006'>November 2006</a></li>
	<li><a href='http://codebetter.com/jeremymiller/2006/10/' title='October 2006'>October 2006</a></li>
	<li><a href='http://codebetter.com/jeremymiller/2006/09/' title='September 2006'>September 2006</a></li>
	<li><a href='http://codebetter.com/jeremymiller/2006/08/' title='August 2006'>August 2006</a></li>
	<li><a href='http://codebetter.com/jeremymiller/2006/07/' title='July 2006'>July 2006</a></li>
	<li><a href='http://codebetter.com/jeremymiller/2006/06/' title='June 2006'>June 2006</a></li>
	<li><a href='http://codebetter.com/jeremymiller/2006/05/' title='May 2006'>May 2006</a></li>
	<li><a href='http://codebetter.com/jeremymiller/2006/04/' title='April 2006'>April 2006</a></li>
	<li><a href='http://codebetter.com/jeremymiller/2006/03/' title='March 2006'>March 2006</a></li>
	<li><a href='http://codebetter.com/jeremymiller/2006/02/' title='February 2006'>February 2006</a></li>
	<li><a href='http://codebetter.com/jeremymiller/2006/01/' title='January 2006'>January 2006</a></li>
	<li><a href='http://codebetter.com/jeremymiller/2005/12/' title='December 2005'>December 2005</a></li>
	<li><a href='http://codebetter.com/jeremymiller/2005/11/' title='November 2005'>November 2005</a></li>
	<li><a href='http://codebetter.com/jeremymiller/2005/10/' title='October 2005'>October 2005</a></li>
	<li><a href='http://codebetter.com/jeremymiller/2005/09/' title='September 2005'>September 2005</a></li>
	<li><a href='http://codebetter.com/jeremymiller/2005/08/' title='August 2005'>August 2005</a></li>
	<li><a href='http://codebetter.com/jeremymiller/2005/07/' title='July 2005'>July 2005</a></li>
	<li><a href='http://codebetter.com/jeremymiller/2005/06/' title='June 2005'>June 2005</a></li>
	<li><a href='http://codebetter.com/jeremymiller/2005/05/' title='May 2005'>May 2005</a></li>
	<li><a href='http://codebetter.com/jeremymiller/2005/04/' title='April 2005'>April 2005</a></li>
		</ul>
</li><li id="recent-comments-3" class="widget-container widget_recent_comments"><h3 class="widget-title">What others have said&#8230;</h3><ul id="recentcomments"><li class="recentcomments"><a href='http://zacherygaines.webstarts.com/' rel='external nofollow' class='url'>KadeemFulton</a> on <a href="http://codebetter.com/jeremymiller/2007/07/26/the-build-your-own-cab-series-table-of-contents/#comment-7523">The Build Your Own CAB Series Table of Contents</a></li><li class="recentcomments"><a href='http://jonsonbettly.wordpress.com/' rel='external nofollow' class='url'>ScottWorkman</a> on <a href="http://codebetter.com/jeremymiller/2007/07/26/the-build-your-own-cab-series-table-of-contents/#comment-7517">The Build Your Own CAB Series Table of Contents</a></li><li class="recentcomments">haihao on <a href="http://codebetter.com/jeremymiller/2008/10/18/profile-s-in-structuremap/#comment-7513">Profiles in StructureMap</a></li><li class="recentcomments">neon on <a href="http://codebetter.com/jeremymiller/2008/09/10/using-the-structuremap-container-independently-of-objectfactory/#comment-7512">Using the StructureMap Container independently of ObjectFactory</a></li><li class="recentcomments">weaponfan on <a href="http://codebetter.com/jeremymiller/2008/09/25/using-structuremap-2-5-to-inject-your-entity-objects-into-services/#comment-7511">Using StructureMap 2.5 to inject your Entity objects into Services</a></li></ul></li>				</ul>	
				
<script type='text/javascript'><!--// <![CDATA[
    OA_show(29421);
// ]]> --></script><noscript><a target='_blank' href='http://d1.openx.org/ck.php?n=3f8e353'><img border='0' alt='' src='http://d1.openx.org/avw.php?zoneid=29421&amp;n=3f8e353' /></a></noscript>
				
		</div><!-- #secondary .widget-area -->			</div><!--sidebar-->
		</div><!-- #container -->
</div><!-- end div tabs see header.php -->
	
	<div id="footer">
		<div class="container_12">
		<div id="footer-widget-area">
				<div class="grid_4">					
					<ul>
					<li><a href="http://codebetter.com" title="home">Home</a></li>
					<li class="page_item page-item-2"><a href="http://codebetter.com/about/">About</a></li>
<li class="page_item page-item-8"><a href="http://codebetter.com/codebetter-ci/">CodeBetter CI</a></li>
<li class="page_item page-item-6"><a href="http://codebetter.com/community/">Community</a></li>
<li class="page_item page-item-10"><a href="http://codebetter.com/editors/">Editors</a></li>
<li class="page_item page-item-41"><a href="http://codebetter.com/globalsearch/">Search Results</a></li>
					<li><a href="http://feeds.feedburner.com/CodeBetter" rel="alternate" type="application/rss+xml"><img src="http://www.feedburner.com/fb/images/pub/feed-icon16x16.png" alt="" style="vertical-align:middle;border:0"/></a><a href="http://feeds.feedburner.com/CodeBetter"><img src="http://feeds.feedburner.com/~fc/CodeBetter?bg=FFFFFF&amp;fg=2E9BD2&amp;anim=1" height="26" width="88" style="vertical-align:middle;border:0"/></a></li>
					</ul>
				</div><!-- #second .widget-area -->
				<div class="grid_4">
					
					<h3>Friends of CodeBetter.Com</h3>
<ul>

<li><a href="http://red-gate.com/">Red-Gate Tools For SQL and .NET</a></li>
<li><a href="http://telerik.com">Telerik .NET Tools</a></li>
<li><a href="http://jetbrains.com/resharper/">JetBrains - ReSharper</a></li>
<li><a href="http://scootersoftware.com">Beyond Compare</a></li>
<li><a href="http://www.ndepend.com/">NDepend</a></li>
<li><a href="http://www.sapphiresteel.com/">Ruby In Steel</a></li>
<li><a href="http://www.slickedit.com/">SlickEdit</a></li>
<li><a href="http://www.gurock.com/products/smartinspect/">SmartInspect .NET Logging</a></li>
<li>NGEDIT: <a href="http://www.viemu.com/">ViEmu</a> and <a href="http://www.codekana.com/">Codekana</a> </li>
<li><a href="http://www.devexpress.com/" target="_blank">DevExpress</a></li>
<li><a href="http://nhprof.com" target="_blank">NHibernate Profiler</a></li>
<li><a href="http://unfuddle.com" target="_blank">Unfuddle</a></li>
<li><a href="http://www.balsamiq.com/products/mockups" target="_blank">Balsamiq Mockups</a></li>
<li><a href="http://scrumy.com" target="_blank">Scrumy</a></li>
<li><a href="http://umbraco.com" target="_blank">Umbraco</a></li>
<li><a href="http://nservicebus.com" target="_blank">NServiceBus</a></li>
<li><a href="http://ravendb.net" target="_blank">RavenDb</a></li>
<li><a href="http://www.websequencediagrams.com/" target="_blank">Web Sequence Diagrams</a></li>
	</ul>				
				</div><!-- #third .widget-area -->
				<div class="grid_4">
					CodeBetter.Com &copy; '12<br />
						Stuff you need to Code Better!<br />
				Proudly powered by <span id="generator-link"><a href="http://wordpress.org/" title="Semantic Personal Publishing Platform" rel="generator">WordPress</a></span>.					
				</div><!-- #fourth .widget-area -->
			</div><!-- #footer-widget-area -->		
		
			</div><!-- end div.container_12 -->

	</div><!-- end div#footer -->
		
<script type="text/javascript">

  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-531207-1']);
  _gaq.push(['_trackPageview']);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();

</script>
<script type='text/javascript' src='http://cdn1.codebetter.com/wp-content/plugins/syntaxhighlighter/syntaxhighlighter3/scripts/shCore.js?ver=3.0.83b'></script>
<script type='text/javascript' src='http://cdn1.codebetter.com/wp-content/plugins/syntaxhighlighter/syntaxhighlighter3/scripts/shBrushCSharp.js?ver=3.0.83b'></script>
<script type='text/javascript' src='http://cdn1.codebetter.com/wp-content/plugins/syntaxhighlighter/syntaxhighlighter3/scripts/shBrushRuby.js?ver=3.0.83b'></script>
<script type='text/javascript' src='http://cdn1.codebetter.com/wp-content/plugins/syntaxhighlighter/syntaxhighlighter3/scripts/shBrushJScript.js?ver=3.0.83b'></script>
<script type='text/javascript' src='http://cdn1.codebetter.com/wp-content/plugins/syntaxhighlighter/syntaxhighlighter3/scripts/shBrushXml.js?ver=3.0.83b'></script>
<script type='text/javascript' src='http://cdn1.codebetter.com/wp-content/plugins/syntaxhighlighter/syntaxhighlighter3/scripts/shBrushPython.js?ver=3.0.83b'></script>
<script type='text/javascript' src='http://cdn1.codebetter.com/wp-content/plugins/syntaxhighlighter/third-party-brushes/shBrushFSharp.js?ver=3.0.83b'></script>
<script type='text/javascript'>
	(function(){
		var corecss = document.createElement('link');
		var themecss = document.createElement('link');
		var corecssurl = "http://cdn1.codebetter.com/wp-content/plugins/syntaxhighlighter/syntaxhighlighter3/styles/shCore.css?ver=3.0.83b";
		if ( corecss.setAttribute ) {
				corecss.setAttribute( "rel", "stylesheet" );
				corecss.setAttribute( "type", "text/css" );
				corecss.setAttribute( "href", corecssurl );
		} else {
				corecss.rel = "stylesheet";
				corecss.href = corecssurl;
		}
		document.getElementsByTagName("head")[0].insertBefore( corecss, document.getElementById("syntaxhighlighteranchor") );
		var themecssurl = "http://cdn1.codebetter.com/wp-content/plugins/syntaxhighlighter/syntaxhighlighter3/styles/shThemeDefault.css?ver=3.0.83b";
		if ( themecss.setAttribute ) {
				themecss.setAttribute( "rel", "stylesheet" );
				themecss.setAttribute( "type", "text/css" );
				themecss.setAttribute( "href", themecssurl );
		} else {
				themecss.rel = "stylesheet";
				themecss.href = themecssurl;
		}
		//document.getElementById("syntaxhighlighteranchor").appendChild(themecss);
		document.getElementsByTagName("head")[0].insertBefore( themecss, document.getElementById("syntaxhighlighteranchor") );
	})();
	SyntaxHighlighter.config.strings.expandSource = '+ expand source';
	SyntaxHighlighter.config.strings.help = '?';
	SyntaxHighlighter.config.strings.alert = 'SyntaxHighlighter\n\n';
	SyntaxHighlighter.config.strings.noBrush = 'Can\'t find brush for: ';
	SyntaxHighlighter.config.strings.brushNotHtmlScript = 'Brush wasn\'t configured for html-script option: ';
	SyntaxHighlighter.defaults['gutter'] = false;
    SyntaxHighlighter.defaults['tab-size'] = 2;
    SyntaxHighlighter.defaults['toolbar'] = false;
    SyntaxHighlighter.defaults['wrap-lines'] = true; 
	SyntaxHighlighter.defaults['pad-line-numbers'] = false;
	SyntaxHighlighter.all();
</script>

<script type='text/javascript'>//<![CDATA[
    if (typeof jQuery == 'undefined') {
        document.write(unescape("%3Cscript src='http://ajax.aspnetcdn.com/ajax/jQuery/jquery-1.4.2.min.js' type='text/javascript' %3E%3C/script%3E"));
    }//]]></script>
<script type='text/javascript' language='Javascript' src='http://s1.lqcdn.com/m.min.js?dt=2.3.110202.1'></script>
<script type='text/javascript' language='Javascript'> if(jQuery.LqmAds)jQuery.LqmAds();</script>
 
</body>
</html>
<!-- Dynamic page generated in 0.775 seconds. -->
<!-- Cached page generated by WP-Super-Cache on 2012-11-09 12:41:01 -->
<!-- super cache -->