<!DOCTYPE html>
<html dir="ltr" lang="en-US">
<head>
	<meta charset="UTF-8" />
    <title>Architecting LINQ To SQL Applications, part 5 | Ian Cooper</title>
	<link rel="profile" href="http://gmpg.org/xfn/11" />
	
	<link href="http://feeds.feedburner.com/CodeBetter" title="CodeBetter.Com &raquo; Feed" type="application/rss+xml" rel="alternate">
	
		<link rel="pingback" href="http://codebetter.com/iancooper/xmlrpc.php" />
	                <link rel="stylesheet" href="http://cdn1.codebetter.com/wp-content/uploads/spacker-cache/ea73517eb74a545f51c376487c94dc9f.css?v=3912785705" type="text/css" media="all" /><!-- Is Cache! -->
                <script type='text/javascript' src='https://ajax.googleapis.com/ajax/libs/jquery/1.6.0/jquery.min.js?ver=3.4.2'></script>
<script type='text/javascript' src='http://dtym7iokkjlif.cloudfront.net/dough/1.0/recipe.js'></script>
<link rel="EditURI" type="application/rsd+xml" title="RSD" href="http://codebetter.com/iancooper/xmlrpc.php?rsd" />
<link rel="wlwmanifest" type="application/wlwmanifest+xml" href="http://cdn1.codebetter.com/wp-includes/wlwmanifest.xml" /> 
<link rel='prev' title='Classicist vs. Mockist Test-Driven Development' href='http://codebetter.com/iancooper/2008/02/04/classicist-vs-mockist-test-driven-development/' />
<link rel='next' title='Some recommended books' href='http://codebetter.com/iancooper/2008/03/04/some-recommended-books/' />
<meta name="generator" content="WordPress 3.4.2" />
<link rel='shortlink' href='http://codebetter.com/iancooper/?p=23' />

<!-- All in One SEO Pack 1.6.13.2 by Michael Torbert of Semper Fi Web Design[83,148] -->
<link rel="canonical" href="http://codebetter.com/iancooper/2008/02/17/architecting-linq-to-sql-applications-part-5/" />
<!-- /all in one seo pack -->
<link rel="stylesheet" href="http://cdn1.codebetter.com/wp-content/plugins/digg-digg/include/../css/diggdigg-style.css?ver=4.5.3.3" type="text/css" media="screen" />

<!-- Start Shareaholic OgTags -->

	<!-- Shareaholic Notice: There is neither a featured nor gallery image set -->

<!-- End Shareaholic OgTags -->

<meta id="syntaxhighlighteranchor" name="syntaxhighlighter-version" content="3.1.3" />
                <script type="text/javascript" src="http://cdn1.codebetter.com/wp-content/uploads/spacker-cache/dc168cf39155d7b5d39f696ca94d5980.js?v=5302176208">/*Is Cache!*/</script>
                	
	<script type='text/javascript' src='http://d1.openx.org/spcjs.php?id=7744&amp;target=_blank'></script>
	<style type="text/css">body { padding-top:0px !important; } html { margin-top: 0px !important; }</style>
<!-- BuySellAds Ad Code -->
<script type="text/javascript">
(function(){
  var bsa = document.createElement('script');
     bsa.type = 'text/javascript';
     bsa.async = true;
     bsa.src = 'http://s3.buysellads.com/ac/bsa.js';
  (document.getElementsByTagName('head')[0]||document.getElementsByTagName('body')[0]).appendChild(bsa);
})();
</script>
<!-- End BuySellAds Ad Code -->
</head>

<body>

			
		<div class="container_12 ui-tabs ui-widget ui-widget-content ui-corner-all" id="tabs">			
			<ul class="ui-tabs-nav ui-helper-reset ui-helper-clearfix ui-widget-header ui-corner-all">
				<li class="ui-state-default ui-corner-top ui-tabs-selected ui-state-active"><a href="#ui-tabs-1">CodeBetter.Com</a></li>
				<li class="ui-state-default ui-corner-top"><a href="http://devlicio.us">Devlicio.Us</a></li>				
				<div id="top-search">
				<form action="http://codebetter.com/globalsearch/" id="cse-search-box">
  <div>
   <fieldset id="search">
		<input type="hidden" name="cx" value="005178204031477491434:2bg5jtwgsfe" />
		<input type="hidden" name="cof" value="FORID:9" />
		<input type="hidden" name="ie" value="UTF-8" />
		<input type="text"  class="text-input" id="s" name="q" size="31" />
		<input type="image" src="http://cdn1.codebetter.com/wp-content/themes/codebetter/images/search-img.png" class="form-button" id="searchsubmit" value="GO" name="">				   	
	</fieldset>
  </div>
</form>
<script type="text/javascript" src="http://www.google.com/cse/brand?form=cse-search-box&lang=en&sitesearch=true"></script>
				</div>				
			</ul><div id="ui-tabs-1" class="ui-tabs-panel ui-widget-content ui-corner-bottom"></div><div id="ui-tabs-2" class="ui-tabs-panel ui-widget-content ui-corner-bottom ui-tabs-hide"></div>
		</div>
			
		<div id="main" class="container_12">
		
			<div id="logo" class="grid_3"><a href="/" title="CodeBetter.Com - Stuff you need to Code Better!"><image src="http://cdn1.codebetter.com/wp-content/themes/codebetter/images/codebetter_logo.png" height="48" width="223"></image></a></div>
			<div id="ad_leaderboard" class="grid_9">
			<!-- BuySellAds Zone Code -->
<div id="bsap_1276080" class="bsarocks bsap_4fe632babdccc2b4b049e4f08cc3c549"></div>
<!-- End BuySellAds Zone Code --></div>
			
			<div id="globalNav" class="grid_12">
				<ul>
					<li><a href="http://codebetter.com" title="home">Home</a></li>
					<li class="page_item page-item-2"><a href="http://codebetter.com/about/">About</a></li>
<li class="page_item page-item-8"><a href="http://codebetter.com/codebetter-ci/">CodeBetter CI</a></li>
<li class="page_item page-item-6"><a href="http://codebetter.com/community/">Community</a></li>
<li class="page_item page-item-10"><a href="http://codebetter.com/editors/">Editors</a></li>
					<li><a href="http://feeds.feedburner.com/CodeBetter" rel="alternate" type="application/rss+xml"><img src="http://www.feedburner.com/fb/images/pub/feed-icon16x16.png" alt="" style="vertical-align:middle;border:0"/></a><a href="http://feeds.feedburner.com/CodeBetter"><img src="http://feeds.feedburner.com/~fc/CodeBetter?bg=EFEFEF&amp;fg=2E9BD2&amp;anim=1" height="26" width="88" style="vertical-align:middle;border:0"/></a></li>
				</ul>
								
			</div><!-- end div#globalNav.container_12 -->				
	
		<div id="content" class="container_12">
			<div id="main" class="grid_8">


				<div id="post-23" class="post-23 post type-post status-publish format-standard hentry category-featured category-linq category-mocks category-stubs category-tdd">
					<h1 class="entry-title">Architecting LINQ To SQL Applications, part 5</h1>

					<div class="entry-meta">
						<span class="meta-prep meta-prep-author">Posted by </span>
						<span class="author vcard"><a class="url fn n" href="http://codebetter.com/iancooper/author/iancooper/" title="View all posts by Ian Cooper">Ian Cooper</a></span>
						<span class="meta-sep"> on  </span>
						<a href="http://codebetter.com/iancooper/2008/02/17/architecting-linq-to-sql-applications-part-5/" title="5:35 pm" rel="bookmark"><span class="entry-date">February 17, 2008</span></a>
											</div><!-- .entry-meta -->

					<div class="entry-content">
						<div id="greet_block"><noscript><div class="greet_block wpgb_cornered"><div class="greet_text"><div class="greet_image"><a href="http://codebetter.com/iancooper/feed/rss/"  rel="nofollow"><img src="http://cdn1.codebetter.com/wp-content/plugins/wp-greet-box/images/rss_icon.png" alt="WP Greet Box icon"/></a></div>Hello there! If you are new here, you might want to <a href="http://codebetter.com/iancooper/feed/rss/" rel="nofollow"><strong>subscribe to the RSS feed</strong></a> for updates on this topic.<div style="clear:both"></div><div class="greet_block_powered_by">Powered by <a href="http://omninoggin.com/projects/wordpress-plugins/wp-greet-box-wordpress-plugin/" title="WP Greet Box WordPress Plugin" style="text-decoration:none;">WP Greet Box</a> <a href="http://omninoggin.com/" title="WordPress Plugin" style="text-decoration:none;">WordPress Plugin</a></div><div style="clear:both"></div></div></div></noscript></div><!-- Start Shareaholic LikeButtonSetTop Automatic --><!-- End Shareaholic LikeButtonSetTop Automatic --><p><P>Let&#8217;s return to the series on how to architect applications that use LINQ To SQL. First of all, for those you who missed it, a summary of where we have been:</P><br />
<P><A class="" href="http://codebetter.com/blogs/ian_cooper/archive/2007/11/29/architecting-linq-to-sql-applications-part-1.aspx">Part 1, Introduction</A><BR><A class="" href="http://codebetter.com/blogs/ian_cooper/archive/2007/11/30/architecting-linq-to-sql-applications-part-2.aspx">Part 2, Layered Architectures</A><BR><A class="" href="http://codebetter.com/blogs/ian_cooper/archive/2007/12/02/architecting-linq-to-sql-applications-part-3.aspx">Part 3, DAOs and Repositories</A><BR><A class="" href="http://codebetter.com/blogs/ian_cooper/archive/2007/12/04/architecting-linq-to-sql-applications-part-4.aspx">Part 4, Dynamic Queries</A><BR></P><br />
<P><STRONG>Introduction</STRONG></P><br />
<P>I had a couple of requests to provide some sample code. So I delayed this installment to start building something that will work to that purpose as the backbone for these articles. In the example we are modelling a system that allows us to store usernames and passwords for systems we own, just because that is a side project I am working on. It will go up on Google code toward the end of the series. I also had a number of requests to talk more about mapping and TDD, so this installment returns to that territory in more detail.</P><br />
<P>First, imagine that we have built some domain objects through Test-Driven Development. In our model an ITSystem has a collection of Keys (username and password) to systems and belongs to a Category.</P><br />
<P><STRONG>&nbsp;&nbsp; public class ITSystem<BR>&nbsp;&nbsp;&nbsp; {<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; public Category Category {get;set;}<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; public string Comments {get;set;}<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; public string Name {get;set; }<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; public List&lt;Key&gt; Keys {get;set;}<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &#8230;<BR>&nbsp;&nbsp;&nbsp; }<BR></STRONG><BR>We&#8217;ve built our domain model before we create a database schema to store it against. We know we do need to store it, but we want to be malleable until we do. </P><br />
<P><STRONG>Aggregates and Repositories</STRONG>&nbsp;</P><br />
<P>Within our domain we have repositories, which represent a collection of our objects and negotiates with infrastrtucture services to get that list of objects. We don&#8217;t define a repository&nbsp; for all of our entities, but for the root entities within an aggregate:</P><br />
<P>&#8220;An AGGREGATE is a cluster of associated objects that we treat as a unit for the purpose of data changes. Each AGGREGATE has a root and a boundary. The boundary defines what is inside the AGGREGATE. The root is a single, specific ENTITY contained in the AGGREGATE. The root is the only member of the AGGREGATE that outside objects are allowed to hold references to, although objects within the boundary may hold references to each other. ENTITIES other than the root have local identity, but that identity needs to be distinguishable only within the AGGREGATE, because no outside object can ever see it out of the context of the root ENTITY&#8221; [Evans]</P><br />
<P>In our example the root is ITSystem and the boundary includes the Keys for that system. We don&#8217;t include Category within the boundary. Although an ITSystem has a category it does not manage the lifecycle of a Category. Deleting an ITSystem does not delete the Category it belongs to.&nbsp; As a corollary we might delete a Category, without deleting the IT System, if, for example, we were re-categorizing our systems.</P><br />
<P>Within our Category and ITSystem aggregates we can hold references to each other&#8217;s root objects, but nothing below them. This does not make a huge difference here, because there are only two aggregates we care about: ITSystem and Category, but the point remains.</P><br />
<P>When working with an ORM I tend to view the point of crossing an aggregate boundaries as a good candidate for lazy loading. As well as using the collection based lazy loading common in ORMs you might also want to think about using a ghost [Fowler]. Of course beware the select N+1 problem if you know that you are likely to load a collection.</P><br />
<P><STRONG>Working in memory</STRONG>&nbsp;</P><br />
<P>So we need a repository that allows us to retrieve/persist the ITSystem root and its child Keys. We can write a unit test for that:</P><br />
<P><STRONG>&nbsp;&nbsp;&nbsp; [TestClass]<BR>&nbsp;&nbsp;&nbsp; public class ITSytemRepositoryFixture<BR>&nbsp;&nbsp;&nbsp; {<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; [TestMethod]<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; public void Should_Be_Able_To_Find_All_Systems()<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; //setup<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; MockRepository mocks = new MockRepository();<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ISession session = mocks.Stub&lt;ISession&gt;();<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; session.Systems = CreateSystemList();</STRONG></P><br />
<P><STRONG>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; SystemRepository systemRepository = new SystemRepository(session);</STRONG></P><br />
<P><STRONG>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; //exercise<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; List&lt;ITSystem&gt; systems = systemRepository.FindAll();</STRONG></P><br />
<P><STRONG>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; //verify<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; AssertSystemListMatches(session, systems);&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<BR>&nbsp;&nbsp;&nbsp; }<BR></STRONG></P><br />
<P>We are not showing the creation method CreateSystemList or the verification method: AssertSystemListMatches here, for simplicity. </P><br />
<P>The session will end up abstracting DataContext. It is our unit of work and has both the methods we need to submit changes, and contains the collections that we are accessing. </P><br />
<P>Remember how in part 3 we stated that when we crossed a layer boundary we wanted to depend upon an abstraction and not a concrete type. A proof here is that depending on an abstract type allows us to replace the real data context for unit tests. In the unit test we replace the dependency from the DataContext based repository with a in-memory stub implementation which acts as a Test Double for Db operations.</P><br />
<P>Note that I am not accessing the Db here, I am just building up the functionality of the repository. Within the implementation we use LINQ to return the result set. Note that this is so simple a case, as an example, that the use of LINQ may seem overcomplex, but we don&#8217;t want to distract with complexity here. </P><br />
<P>My implementation looks like this:</P><br />
<P><STRONG>&nbsp;&nbsp;&nbsp; public class SystemRepository<BR>&nbsp;&nbsp;&nbsp; {<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; private ISession session;</STRONG></P><br />
<P><STRONG>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; /// &lt;summary&gt;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; /// Initializes a new instance of the SystemRepository class.<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; /// &lt;/summary&gt;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; /// &lt;param name=&#8221;session&#8221;&gt;&lt;/param&gt;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; public SystemRepository(ISession session)<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; this.session = session;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }</STRONG></P><br />
<P><STRONG>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; /// &lt;summary&gt;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; /// Find all the systems<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; /// &lt;/summary&gt;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; /// &lt;returns&gt;&lt;/returns&gt;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; public List&lt;ITSystem&gt; FindAll()<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return <BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; (from s in session.Systems<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; select s)<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; .ToList&lt;ITSystem&gt;();<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<BR>&nbsp;&nbsp;&nbsp; }<BR></STRONG></P><br />
<P><STRONG>Mapping</STRONG>&nbsp;</P><br />
<P>We can go a long way working with this in-memory representation, building up the queries our repository manages for us against the&nbsp; domain layer without ever touching peristence to a Db. Because we are not touching the Db as yet we are very malleable. We don&#8217;t have to worry about versioning Db schemas. Where there is a lack of resistance to change, we tend to make more effort to keep our code clean.</P><br />
<P>Of course at some point we want to write the code that will persist our domain model. Again we can drive with tests. </P><br />
<P>Because these tests will be slow, we are touching the Db, we put them in a seperate assembly and tag them as Slow or Acceptance tests. Developers may want to skip running these tests when confirming their refactoring up until they check-in, so they don&#8217;t break the rhythm.</P><br />
<P>We could have an equivalent test to that above:</P><br />
<P><STRONG>&nbsp;&nbsp;&nbsp; [TestClass]<BR>&nbsp;&nbsp;&nbsp; public class ITSytemRepositoryFixture: ITSystemTests<BR>&nbsp;&nbsp;&nbsp; {<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; [TestMethod]<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; public void Should_Be_Able_To_Find_All_Systems()<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; //setup<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ISession session = new KeySafeSession(new DataContext(ConfigurationManager.ConnectionStrings["KeySafe"].ConnectionString));<BR>&nbsp;&nbsp; <BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; SystemRepository systemRepository = new SystemRepository(session);</STRONG></P><br />
<P><STRONG>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; //exercise<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; List&lt;ITSystem&gt; systems = systemRepository.FindAll();</STRONG></P><br />
<P><STRONG>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; //verify<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; AssertSystemListMatches(session, systems);&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<BR>&nbsp;&nbsp;&nbsp; }<BR></STRONG></P><br />
<P>But note how this time we are using a concrete session implementation initialized from our DataContext.</P><br />
<P>In order to get our domain classes working with DataContext we have to tell DataContext how to map them. We can add mappings in a seperate mapping file, or as attributes. </P><br />
<P>Which you prefer is somewhat to personal preference. One tradeoff is between polluting your domain class with mapping information and managing XML files. I have always leaned toward the mapping file, because I like to leave my domain clean of persistence knowldege, others are happy with attributes for what is an orthogonal concern. Here we will show use of attributes. </P><br />
<P>One thing to point out here though is that as we are building from our domain first, we have no schema to map to at this point. That&#8217;s fine we are going to tag our domain classes for persistence, and then generate the Db from them. </P><br />
<P>First we need to identify the table that our domain class maps to. We simply add the Table attribute to our class to do that. [Table] allows us to map to a different name. </P><br />
<P>Although there are limitations to mapping (lack of implicit support for many-to-many, single table for inheritance hierachies) working from a clean domain gives us one of the simplest options for using LINQ To SQL as we are defining how to persist our domain, not trying to figure out what domain classes map from an existing schema. Working with a legacy schema with LINQ To SQL will always shape our domain to that schema.</P><br />
<P>We do not have an inheritance hierachy, so we don&#8217;t need to use the [InheritanceMapping] attribute. </P><br />
<P>We need to add this to all of the classes we wish to persist.</P><br />
<P><STRONG>&nbsp;&nbsp;&nbsp; [Table]<BR>&nbsp;&nbsp;&nbsp; public class ITSystem<BR></STRONG></P><br />
<P>Next we tag those fields that we wish to persist as columns. Again we can rename if we don&#8217;t like the domain name.</P><br />
<P><STRONG>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; [Column]<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; public string Comments {get;set;}<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; [Column]<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; public string Name {get;set; }<BR></STRONG></P><br />
<P>Our entities must have an identity, that seperates them from other instances of the class. We need to tag this identity so that we can use it to identify instances of our identity. The Db will use a primary key for this so we tag a column as our primary key.</P><br />
<P>We can modify the name property of ITSystem as follows:</P><br />
<P><STRONG>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; [Column(IsPrimaryKey= true)]<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; public string Name {get;set; }<BR></STRONG></P><br />
<P>Not all of our fields will be primitives. Where they are instances of another class the Db will need to represent this as a foriegn key pointing to a row in a table to which we persist the other class. We can show this mapping by using the attribute [Association]. We need to tell it how to hook up to our child i.e what property of the child holds the parent identifier. Our Key class looks like this at the minute:</P><br />
<P><STRONG>&nbsp;&nbsp;&nbsp; [Table]<BR>&nbsp;&nbsp;&nbsp; public class Key<BR>&nbsp;&nbsp;&nbsp; {<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; [Column(IsPrimaryKey=true)]<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; public string UserName {get;set;}<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; [Column]<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; public string Password {get;set; }</STRONG></P><br />
<P><STRONG>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; public Key() {}</STRONG></P><br />
<P><STRONG>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; public Key(string userName, string password)<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; UserName = userName;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Password = password;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<BR>&nbsp;&nbsp;&nbsp; }<BR></STRONG></P><br />
<P>So we add a SystemName to Key so that we have the child knows its parent, and in instance of the ITSystem System so we can navigatge the relationship bidiectionally. Now we add an Association attribute to ITSystem to indicate how to map the child collection.</P><br />
<P><STRONG>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; [Association(OtherKey="SystemName")]<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; public List&lt;Key&gt; Keys {get;set;}<BR></STRONG></P><br />
<P>And then we can add an Association in Key for the ITSystem so that we can traverse the relationship in both directions.</P><br />
<P>Note we need to switch to using&nbsp; EntitySet for the backing storage for the many of side of our associations. We also need to use EntityRef to support the one side of our associations. This supports lazy loading, but pushes a persistence specific class info into our domain. I&#8217;m tolerant to this because it can be hidden in the public interface. We only intend to support lazy loading across an aggregate boundary, so from our ITSystem we will lazy load the category, but eager load the Keys. We will use DataLoadOptions to eager load where required. Read the documentation to see the restrictions here. So we end up with this:</P><br />
<P><STRONG>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; private EntitySet&lt;Key&gt; keys;</STRONG></P><br />
<P><STRONG>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; [Association(OtherKey="SystemName")]<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; public IList&lt;Key&gt; Keys<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; get{return keys;}<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; set{keys.Assign(value);} <BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<BR></STRONG></P><br />
<P>Where we have an EntityRef&lt;&gt; or EntitySet&lt;&gt; we need to initialize the collection in the constructor, for example:</P><br />
<P><STRONG>&nbsp;&nbsp;&nbsp;category = default(EntityRef&lt;Category&gt;);<BR></STRONG></P><br />
<P>If you are too uncomfortable with using EntityRef and EntitySet see also Mathew Charles&#8217;s notes on how to work around this restriction:&nbsp; (<A href="http://blogs.msdn.com/digital_ruminations/archive/2007/08/28/linq-to-sql-poco-support.aspx">http://blogs.msdn.com/digital_ruminations/archive/2007/08/28/linq-to-sql-poco-support.aspx</A>) on supporting Persistence Ignorance with LINQ To SQL.</P><br />
<P><STRONG>Building the Db</STRONG>&nbsp;</P><br />
<P>Once we have all of our classes mapped out, we can generate a Db to support them. I add a utility console project to do this.</P><br />
<P>We build a KeySafeContext that looks like this, to help us get generation done. We&#8217;ll come back to talk about linking it up to our ISession implementation KeySafeSession.</P><br />
<P><STRONG>&nbsp;&nbsp;&nbsp; public class KeySafeContext : DataContext<BR>&nbsp;&nbsp;&nbsp; {<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; private const string DbName = &#8220;KeySafe&#8221;;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; public Table&lt;ITSystem&gt; Systems { get; set; }<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; public Table&lt;Key&gt; Keys { get; set; }<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; public Table&lt;Category&gt; Categories { get; set; }</STRONG></P><br />
<P><STRONG>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; /// &lt;summary&gt;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; /// Initializes a new instance of the KeySafeContext class.<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; /// &lt;/summary&gt;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; public KeySafeContext() : base(ConfigurationManager.ConnectionStrings[DbName].ConnectionString)&nbsp; <BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Systems = GetTable&lt;ITSystem&gt;();<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Keys = GetTable&lt;Key&gt;();<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Categories = GetTable&lt;Category&gt;();<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<BR>&nbsp;&nbsp;&nbsp; }<BR></STRONG></P><br />
<P>we can then use this with a simple script to build our Db:</P><br />
<P><STRONG>&nbsp;&nbsp;&nbsp; class Program<BR>&nbsp;&nbsp;&nbsp; {<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; static void Main(string[] args)<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Console.WriteLine(&#8220;Generate new version of Db&#8221;);</STRONG></P><br />
<P><STRONG>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; try<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; KeySafeContext db = new KeySafeContext();<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if (db.DatabaseExists())<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Console.WriteLine(&#8220;Deleting old version&#8221;);<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; db.DeleteDatabase();<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }</STRONG></P><br />
<P><STRONG>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; db.CreateDatabase();</STRONG></P><br />
<P><STRONG>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Console.WriteLine(&#8220;Database created successfully.&#8221;);<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; catch(Exception ex)<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Console.WriteLine(&#8220;Error creating Db&#8230;&#8221;);<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Console.WriteLine(ex.Message);<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; throw;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<BR>&nbsp;&nbsp;&nbsp; }<BR></STRONG></P><br />
<P>This will pop out any errors for you in your mapping as you build, so its a great way to check that your domain is configured correctly. I certainly got one or two errors when I set this up for the first time.</P><br />
<P>Now you can use the generated Db to check how your mappings are coming out. You have a fair amount of flexibility to specify details of how you want your final mapping to look in your attributes. Review the docs. You can use the script above to modify and build until you are happy that your domain model is being mapped out in your preferred form.</P><br />
<P>For example the default storage for our strings is nvarchar(4000), which is way larger than we want, so we specify the size and constraints of the columns directly:</P><br />
<P><STRONG>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; [Column(DbType="NVarChar(50) NOT NULL", CanBeNull=false, IsPrimaryKey= true)]<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; public string Name {get;set; }<BR></STRONG>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <BR>I can keep adjusting the metadata in the attributes, and re-generating the Db using the utility until I get something I like.</P><br />
<P>This may also be the point where I decide to use an Id field as a key, instead of relying on natural keys, or add a version/timestamp field to support optimistic currency. </P><br />
<P>As it is possible that someone might choose to change the names of the systems and categories, I opt to add an Id column and use that as the primary key instead of the name. That change flows through to child objects, which now need to store an Id to represent the foriegn key portion of the association.</P><br />
<P><STRONG>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; [Column(AutoSync = AutoSync.OnInsert, IsDbGenerated = true, IsPrimaryKey = true)]<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; public int Id { get; set; }</STRONG></P><br />
<P>At the same time I need to adjust the mappings to reflect this. First the association with the Key class:</P><br />
<P><STRONG>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; [Association(OtherKey="SystemId")]<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; public IList&lt;Key&gt; Keys {&#8230; }<BR></STRONG></P><br />
<P>and the Key class itself</P><br />
<P><BR><STRONG>&nbsp;&nbsp;&nbsp; [Table]<BR>&nbsp;&nbsp;&nbsp; public class Key<BR>&nbsp;&nbsp;&nbsp; {<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; [Column(AutoSync = AutoSync.OnInsert, IsDbGenerated = true, IsPrimaryKey = true)]<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; public int Id { get; set; }<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; [Column(DbType="NVarChar(50) NOT NULL", CanBeNull=false)]<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; public string Password { get; set; }<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; [Column]<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; public int SystemId { get; set; }<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; private EntityRef&lt;ITSystem&gt; system;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; [Column(DbType="NVarChar(50) NOT NULL", CanBeNull=false)]<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; public string UserName { get; set; }<BR>&nbsp;&nbsp;&nbsp; &#8230;<BR>&nbsp;&nbsp;&nbsp; <BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; [Association(OtherKey="Id", ThisKey="SystemId")]<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; public ITSystem System <BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; { <BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; get{return system.Entity;} <BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; set{system.Entity = value;} <BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }</STRONG></P><br />
<P><STRONG>&nbsp;&nbsp;&nbsp; }</STRONG><BR></P><br />
<P>I also decide that as this is intended to be a multi-user system I&#8217;m going to support a versions to make optimistic concurrency work better i.e. not through comparing every field.</P><br />
<P><STRONG>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; [Column(AutoSync=AutoSync.Always, IsDbGenerated=true,&nbsp;&nbsp;&nbsp; IsVersion=true)]<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; public byte[] Version {get;set;}</STRONG><BR></P><br />
<P>Finally, where I want the field within the Db to be nullable, I switch to using a nullable type on my domain.</P><br />
<P><STRONG>Summarizing the Mapping</STRONG></P><br />
<P>Because things may have got a little confusing through all that let&#8217;s review the mappings:</P><br />
<P><STRONG>&nbsp;&nbsp;&nbsp; [Table]<BR>&nbsp;&nbsp;&nbsp; public class ITSystem<BR>&nbsp;&nbsp;&nbsp; {<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; [Column]<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; public int CategoryId { get; set; }<BR>&nbsp;&nbsp;private EntityRef&lt;Category&gt; category = default(EntityRef&lt;Category&gt;);<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; [Column]<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; public string Comments {get;set;}<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; [Column(DbType="NVarChar(50) NOT NULL", CanBeNull=false)]<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; public string Name {get;set; }<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; [Column(AutoSync = AutoSync.OnInsert, IsDbGenerated = true, IsPrimaryKey = true)]<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; public int Id { get; set; }<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; private EntitySet&lt;Key&gt; keys = new EntitySet&lt;Key&gt;();<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; [Column(AutoSync=AutoSync.Always, IsDbGenerated=true, IsVersion=true)]<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; public byte[] Version {get;set;}<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &#8230;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; [Association(OtherKey="SystemId")]<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; public IList&lt;Key&gt; Keys<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; get{return keys;}<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; set<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; foreach (Key key in value)<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; key.System = this;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; keys.Assign(value);<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; } <BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }</STRONG></P><br />
<P><BR><STRONG>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; [Association(OtherKey="Id", Storage="category", ThisKey="CategoryId")]<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; public Category Category<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; get<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return category.Entity;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; set<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; this.CategoryId = value.Id;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; this.category.Entity = value;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <BR>&nbsp;&nbsp;&nbsp; [Table]<BR>&nbsp;&nbsp;&nbsp; public class Key<BR>&nbsp;&nbsp;&nbsp; {<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; [Column(AutoSync = AutoSync.OnInsert, IsDbGenerated = true, IsPrimaryKey = true)]<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; public int Id { get; set; }<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; [Column(DbType="NVarChar(50) NOT NULL", CanBeNull=false)]<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; public string Password { get; set; }<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; [Column]<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; public int SystemId { get; set; }<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; private EntityRef&lt;ITSystem&gt; system = default(EntityRef&lt;ITSystem&gt;);<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; [Column(DbType="NVarChar(50) NOT NULL", CanBeNull=false)]<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; public string UserName { get; set; }<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; [Column(AutoSync=AutoSync.Always, IsDbGenerated=true, IsVersion=true)]<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; public byte[] Version {get;set;}<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &#8230;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; [Association(OtherKey="Id", ThisKey="SystemId")]<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; public ITSystem System <BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; { <BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; get{return system.Entity;} <BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; set{system.Entity = value;} <BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<BR>&nbsp;&nbsp;&nbsp; }</STRONG></P><br />
<P><STRONG>&nbsp;&nbsp;&nbsp; [Table]<BR>&nbsp;&nbsp;&nbsp; public class Category<BR>&nbsp;&nbsp;&nbsp; {<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; private EntitySet&lt;Category&gt; children = new EntitySet&lt;Category&gt;();<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; [Column(AutoSync = AutoSync.OnInsert, IsDbGenerated = true, IsPrimaryKey = true)]<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; public int Id { get; set; }<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; [Column(DbType="NVarChar(50) NOT NULL", CanBeNull=false)]<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; public string Name {get;set; }<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; [Column(DbType="Int", CanBeNull=true)]<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; public int? ParentId { get; set; }<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; private EntityRef&lt;Category&gt; parent;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; private EntitySet&lt;ITSystem&gt; systems = new EntitySet&lt;ITSystem&gt;();<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; [Column(AutoSync=AutoSync.Always, IsDbGenerated=true, IsVersion=true)]<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; public byte[] Version {get;set;}<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &#8230;<BR>&nbsp;&nbsp;&nbsp; <BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; [Association(ThisKey="ParentId", OtherKey="Id")]<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; public IList&lt;Category&gt; Children<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; get{return children;}<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; set<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; foreach (Category child in value)<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; child.Parent = this;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; children.Assign(value);<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; } <BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }</STRONG></P><br />
<P><STRONG>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; [Association(ThisKey="ParentId")]<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; public Category Parent <BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; { <BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; get{return parent.Entity;} <BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; set<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if (value == null)<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ParentId = null;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; else<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ParentId = value.Id;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; parent.Entity = value;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; } <BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<BR>&nbsp;&nbsp;&nbsp; }<BR></STRONG></P><br />
<P><STRONG>The good, the bad, and the ugly</STRONG>&nbsp;</P><br />
<P>Mapping can be a little tricky, so put aside sufficent time in your project to make it happen. A couple of tips are that when you get null reference exception when submitting changes, consider commenting out parts of the mapping, until you can isolate the mapping that causes the error. In particular, watch your foreign keys, its easy to get confused and end up with a broken mapping. Secondly, once you have built the Db you can always create a new solution and within that use the designer to generate the suggested mappings and re-apply anything that is missing to your domain. </P><br />
<P>Some folks are going to look at the work involved in mapping from domain to Db, panic, and just adopt a schema first approach. Don&#8217;t forget however that by going domain first, we focus on the ubiquitous language we share with the user, and by using TDD we have tests to preserve our domain behavior while we refactor to support our mapping.</P><br />
<P>As you can see, as the attributes build up, they can cause an accretion of &#8216;noise&#8217; in our domain model whose pupose is orthogonal to the domain itself. If that bothers you, use an XML based mapping file instead.</P><br />
<P>We could probably, and should, revise these mappings a little more, but they will do for now.</P><br />
<P><STRONG>LINQ and designing for testability</STRONG></P><br />
<P>Once we have our Db generated we need to review our Session. It currently exposes its member collections as an IList&lt;T&gt;. While this is good enough for LINQ To Objects, LINQ To SQL needs an IQueryable. Our KeySafeContext works with a Table&lt;T&gt; for each class we are persisting.</P><br />
<P>For this purpose I have a helper library of classes, called Strain, that I have written that exposes a common interface, IQuerySource, which derives from both IQueryable&lt;T&gt; and IEnumerable&lt;T&gt; and adds Add and Remove methods. Both Table&lt;T&gt; and List&lt;T&gt; sourced collections can implement this: </P><br />
<P><STRONG>&nbsp;&nbsp;&nbsp; public interface IQuerySource&lt;T&gt; : IQueryable&lt;T&gt;, IEnumerable&lt;T&gt;<BR>&nbsp;&nbsp;&nbsp; {<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; void Add(T item);<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; void Attach(T item);<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; void Remove(T item);<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; void RemoveAll(IEnumerable&lt;T&gt; items);<BR>&nbsp;&nbsp;&nbsp; }</STRONG><BR></P><br />
<P>We expose the IQueryable&lt;T&gt; from a List&lt;T&gt;&nbsp; by virtue of the conversion availabe from the Queryable.AsQueryable() method.</P><br />
<P><STRONG>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; public ListQuery(List&lt;T&gt; source)<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; impl = source;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; queryableImpl = impl.AsQueryable();<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<BR></STRONG></P><br />
<P>and then just implement the IQueryable&lt;T&gt; in terms of this.</P><br />
<P>A Table&lt;T&gt; is already an IQueryable&lt;T&gt; so we don&#8217;t need to do this conversion. We can simply implement the Add, Attach, etc. methods we are after from the Table e.g.</P><br />
<P><STRONG>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; public void Add(T item)<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; dataTable.InsertOnSubmit(item);<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<BR></STRONG></P><br />
<P>I don&#8217;t show the code for this helper library here, but I&#8217;ll post it at a later date. However it should be possible to implement this yourself from this.</P><br />
<P>This allows us to modify our ISession to expose an IQuerySource&lt;T&gt; instead of a List&lt;T&gt; so that we can source it from either.</P><br />
<P>We also ensure that our context has the DataLoadOptions we need to populate our eager-loaded collections.</P><br />
<P><BR><STRONG>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; public KeySafeContext() : base(ConfigurationManager.ConnectionStrings[DbName].ConnectionString)&nbsp; <BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Systems = GetTable&lt;ITSystem&gt;();<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Keys = GetTable&lt;Key&gt;();<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Categories = GetTable&lt;Category&gt;();</STRONG></P><br />
<P><STRONG>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; DataLoadOptions dataLoadOptions = new DataLoadOptions();<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; dataLoadOptions.LoadWith&lt;ITSystem&gt;(s=&gt;s.Keys);<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }</STRONG><BR></P><br />
<P>Our acceptance tests will also need to populate the data we intend to select into the Db by adding data to the repository and then calling SubmitChanges. To avoid issues with shared fixture state between tests, we wrap the modifications in a transaction that we never commit.</P><br />
<P>Our final test looks like this:</P><br />
<P><BR><STRONG>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; [TestMethod]<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; public void Should_Be_Able_To_Find_All_Systems()<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; //setup<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; KeySafeContext context = new KeySafeContext();<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ISession session = new KeySafeSession(context);<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; SystemRepository systemRepository = new SystemRepository(session);<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ITSystem system = CreateITSystem();</STRONG></P><br />
<P><STRONG>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; //exercise<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; using (new TransactionScope())<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; systemRepository.Systems.Add(system);</STRONG></P><br />
<P><STRONG>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; session.SubmitChanges();</STRONG></P><br />
<P><STRONG>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; List&lt;ITSystem&gt; systems = systemRepository.FindAll();</STRONG></P><br />
<P><STRONG>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; //verify<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; AssertSystemListMatches(session, systems);<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<BR></STRONG></P><br />
<P>With that, the tests pass. That is enough for this installment, but next time, I&#8217;ll give some examples around dynamic querying options. After that we&#8217;ll move on to look at the place for ORMs in distributed systems.<BR></P></p>
<div class="shr-publisher-23"></div><!-- Start Shareaholic LikeButtonSetBottom Automatic --><!-- End Shareaholic LikeButtonSetBottom Automatic -->											</div><!-- .entry-content -->

					<div id="entry-author-info">
						<div id="author-avatar">
							<img alt='' src='http://1.gravatar.com/avatar/b033a6c1af4ee8d7a734f3684225ea8a?s=60&amp;d=http%3A%2F%2F1.gravatar.com%2Favatar%2Fad516503a11cd5ca435acc9bb6523536%3Fs%3D60&amp;r=R' class='avatar avatar-60 photo' height='60' width='60' />						</div><!-- #author-avatar 	-->
						<div id="author-description">
							<h2>About Ian Cooper</h2>
							Ian Cooper has over 18 years of experience delivering Microsoft platform solutions in government, healthcare, and finance. During that time he has worked for the DTi, Reuters, Sungard, Misys and Beazley delivering everything from bespoke enterpise solutions to 'shrink-wrapped' products to thousands of customers. Ian is a passionate exponent of the benefits of OO and Agile. He is test-infected and contagious. When he is not writing C# code he is also the and founder of the London .NET user group. http://www.dnug.org.uk							<div id="author-link">
								<a href="http://codebetter.com/iancooper/author/iancooper/" title="View all posts by Ian Cooper">View all posts by Ian Cooper &rarr;</a>
							</div><!-- #author-link	-->
						</div><!-- #author-description	-->
					</div><!-- .entry-author-info -->

					<div class="entry-utility">
					This entry was posted in <a href="http://codebetter.com/iancooper/category/featured/" title="View all posts in Featured" rel="category tag">Featured</a>, <a href="http://codebetter.com/iancooper/category/linq/" title="View all posts in LINQ" rel="category tag">LINQ</a>, <a href="http://codebetter.com/iancooper/category/mocks/" title="View all posts in Mocks" rel="category tag">Mocks</a>, <a href="http://codebetter.com/iancooper/category/stubs/" title="View all posts in Stubs" rel="category tag">Stubs</a>, <a href="http://codebetter.com/iancooper/category/tdd/" title="View all posts in TDD" rel="category tag">TDD</a>. Bookmark the <a href="http://codebetter.com/iancooper/2008/02/17/architecting-linq-to-sql-applications-part-5/" title="Permalink to Architecting LINQ To SQL Applications, part 5" rel="bookmark">permalink</a>. Follow any comments here with the <a href="http://codebetter.com/iancooper/2008/02/17/architecting-linq-to-sql-applications-part-5/feed/" title="Comments RSS to Architecting LINQ To SQL Applications, part 5" rel="alternate" type="application/rss+xml">RSS feed for this post</a>.
					</div><!-- .entry-utility -->
				</div><!-- #post-23 -->

				<div id="nav-below" class="navigation">
					<div class="nav-previous"><a href="http://codebetter.com/iancooper/2008/02/04/classicist-vs-mockist-test-driven-development/" rel="prev"><span class="meta-nav">&larr;</span> Classicist vs. Mockist Test-Driven Development</a></div>
					<div class="nav-next"><a href="http://codebetter.com/iancooper/2008/03/04/some-recommended-books/" rel="next">Some recommended books <span class="meta-nav">&rarr;</span></a></div>
				</div><!-- #nav-below -->

				
<div id="disqus_thread">
                    <div id="dsq-content">
            <ul id="dsq-comments">
                    <li id="dsq-comment-252">
                    <div id="dsq-comment-header-252" class="dsq-comment-header">
                        <cite id="dsq-cite-252">
                                <span id="dsq-author-user-252">Greg</span>
                            </cite>
                    </div>
                    <div id="dsq-comment-body-252" class="dsq-comment-body">
                        <div id="dsq-comment-message-252" class="dsq-comment-message"><p>Do you think its a good idea to have all of this persistence information polluting the domain? What happens when we need to persist our model to two different data sources?</p>
</div>
                    </div>
                </li>
                    <li id="dsq-comment-253">
                    <div id="dsq-comment-header-253" class="dsq-comment-header">
                        <cite id="dsq-cite-253">
                                <span id="dsq-author-user-253">Ian Cooper</span>
                            </cite>
                    </div>
                    <div id="dsq-comment-body-253" class="dsq-comment-body">
                        <div id="dsq-comment-message-253" class="dsq-comment-message"><p>@Greg As I point out above the XML option will take the pain of polluting domain classes away for you. My gut says that I would prefer to use XML mappings over attributes, but I can appreciate the arguments of people who resist the growth of XML configuration. To be frank my major reason for using attributes here was to help those people who had thought about marking up their own classes, but had only seen the designer generated code make the steps into tagging their own model more easily.</p>
<p>That said I have begun to drift to using attributes with NHibernate of late so there must be something in it</p>
</div>
                    </div>
                </li>
                    <li id="dsq-comment-254">
                    <div id="dsq-comment-header-254" class="dsq-comment-header">
                        <cite id="dsq-cite-254">
                                <span id="dsq-author-user-254">Justin Voshell</span>
                            </cite>
                    </div>
                    <div id="dsq-comment-body-254" class="dsq-comment-body">
                        <div id="dsq-comment-message-254" class="dsq-comment-message"><p>Doesn&#8217;t the fact that System.Data.Linq.Table<tentity> is a sealed class prevent it from ever being able to implement IQuerySource</tentity><tentity>?</tentity></p>
</div>
                    </div>
                </li>
                    <li id="dsq-comment-255">
                    <div id="dsq-comment-header-255" class="dsq-comment-header">
                        <cite id="dsq-cite-255">
                                <span id="dsq-author-user-255">Ian Cooper</span>
                            </cite>
                    </div>
                    <div id="dsq-comment-body-255" class="dsq-comment-body">
                        <div id="dsq-comment-message-255" class="dsq-comment-message"><p>@Justin</p>
<p>You don&#8217;t need to modify Table<t> just use an adapter that does implement IQuerySource</t><t>. I usually implement in terms of Table</t><t> like so:</p>
<p>   public class TableQuery</t><t> : IQuerySource</t><t> where T : class<br />
    {<br />
        public Table</t><t> dataTable;<br />
        public IQueryable</t><t> queryableTable;<br />
        &#8230;<br />
       public TableQuery(Table</t><t> dataTable)<br />
        {<br />
            this.dataTable = dataTable;<br />
            queryableTable = dataTable as IQueryable</t><t>;<br />
        }<br />
   }</t></p>
</div>
                    </div>
                </li>
                    <li id="dsq-comment-256">
                    <div id="dsq-comment-header-256" class="dsq-comment-header">
                        <cite id="dsq-cite-256">
                                <span id="dsq-author-user-256">elberon5</span>
                            </cite>
                    </div>
                    <div id="dsq-comment-body-256" class="dsq-comment-body">
                        <div id="dsq-comment-message-256" class="dsq-comment-message"><p>What exactly is an ISession? Did I miss an article in this series? Is this part of LINQ to SQL?</p>
</div>
                    </div>
                </li>
                    <li id="dsq-comment-257">
                    <div id="dsq-comment-header-257" class="dsq-comment-header">
                        <cite id="dsq-cite-257">
    http://shumelkd.com/                            <span id="dsq-author-user-257">Qhkkfouj</span>
                            </cite>
                    </div>
                    <div id="dsq-comment-body-257" class="dsq-comment-body">
                        <div id="dsq-comment-message-257" class="dsq-comment-message"><p>u6m7zc </p>
</div>
                    </div>
                </li>
                    <li id="dsq-comment-258">
                    <div id="dsq-comment-header-258" class="dsq-comment-header">
                        <cite id="dsq-cite-258">
    http://&#039;h1BUG/h1&#039;                            <span id="dsq-author-user-258">&#8216;&quot;&gt;&lt;h1&gt;BUG&lt;/h1&gt;&lt;&quot;&#8217;</span>
                            </cite>
                    </div>
                    <div id="dsq-comment-body-258" class="dsq-comment-body">
                        <div id="dsq-comment-message-258" class="dsq-comment-message"><p>&#8216;&#8221;><br />
<h1>BUG</h1>
<p><"'</p>
</div>
                    </div>
                </li>
                    <li id="dsq-comment-259">
                    <div id="dsq-comment-header-259" class="dsq-comment-header">
                        <cite id="dsq-cite-259">
    http://&#039;h1BUG/h1&#039;                            <span id="dsq-author-user-259">&#8216;&quot;&gt;&lt;h1&gt;BUG&lt;/h1&gt;&lt;&quot;&#8217;</span>
                            </cite>
                    </div>
                    <div id="dsq-comment-body-259" class="dsq-comment-body">
                        <div id="dsq-comment-message-259" class="dsq-comment-message"><p>&#8216;&#8221;><br />
<h1>BUG</h1>
<p><"'</p>
</div>
                    </div>
                </li>
                </ul>
        </div>
    </div>

<script type="text/javascript">
/* <![CDATA[ */
    var disqus_url = 'http://codebetter.com/iancooper/2008/02/17/architecting-linq-to-sql-applications-part-5/';
    var disqus_identifier = '23 /blogs/ian_cooper/archive/2008/02/17/architecting-linq-to-sql-applications-part-5.aspx';
    var disqus_container_id = 'disqus_thread';
    var disqus_domain = 'disqus.com';
    var disqus_shortname = 'codebetteriancooper';
    var disqus_title = "Architecting LINQ To SQL Applications, part 5";
        var disqus_config = function () {
        var config = this; // Access to the config object

        /* 
           All currently supported events:
            * preData  fires just before we request for initial data
            * preInit - fires after we get initial data but before we load any dependencies
            * onInit  - fires when all dependencies are resolved but before dtpl template is rendered
            * afterRender - fires when template is rendered but before we show it
            * onReady - everything is done
         */

        config.callbacks.preData.push(function() {
            // clear out the container (its filled for SEO/legacy purposes)
            document.getElementById(disqus_container_id).innerHTML = '';
        });
                config.callbacks.onReady.push(function() {
            // sync comments in the background so we don't block the page
            DISQUS.request.get('?cf_action=sync_comments&post_id=23');
        });
                    };
    var facebookXdReceiverPath = 'http://cdn1.codebetter.com/wp-content/plugins/disqus-comment-system/xd_receiver.htm';
/* ]]> */
</script>

<script type="text/javascript">
/* <![CDATA[ */
    var DsqLocal = {
        'trackbacks': [
        ],
        'trackback_url': "http:\/\/codebetter.com\/iancooper\/2008\/02\/17\/architecting-linq-to-sql-applications-part-5\/trackback\/"    };
/* ]]> */
</script>

<script type="text/javascript">
/* <![CDATA[ */
(function() {
    var dsq = document.createElement('script'); dsq.type = 'text/javascript';
    dsq.async = true;
    dsq.src = 'http://' + disqus_shortname + '.' + disqus_domain + '/embed.js?pname=wordpress&pver=2.67';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();
/* ]]> */
</script>

		</div><!-- #main -->
			<div id="sidebar" class="grid_4">

		<div id="primary" class="widget-area">
			<ul class="xoxo">
				<div class="ad-container">
<script type='text/javascript'><!--// <![CDATA[
    OA_show(29416);
// ]]> --></script><noscript><a target='_blank' href='http://d1.openx.org/ck.php?n=2782afb'><img border='0' alt='' src='http://d1.openx.org/avw.php?zoneid=29416&amp;n=2782afb' /></a></noscript><script type='text/javascript'><!--// <![CDATA[
    OA_show(29417);
// ]]> --></script><noscript><a target='_blank' href='http://d1.openx.org/ck.php?n=e94cea6'><img border='0' alt='' src='http://d1.openx.org/avw.php?zoneid=29417&amp;n=e94cea6' /></a></noscript><script type='text/javascript'><!--// <![CDATA[
    OA_show(29418);
// ]]> --></script><noscript><a target='_blank' href='http://d1.openx.org/ck.php?n=9ba3022'><img border='0' alt='' src='http://d1.openx.org/avw.php?zoneid=29418&amp;n=9ba3022' /></a></noscript><script type='text/javascript'><!--// <![CDATA[
    OA_show(29419);
// ]]> --></script><noscript><a target='_blank' href='http://d1.openx.org/ck.php?n=f467b52'><img border='0' alt='' src='http://d1.openx.org/avw.php?zoneid=29419&amp;n=f467b52' /></a></noscript>
				</div>
			
				<li id="user_bio-2" class="widget-container widget_user_bio"><h3 class="widget-title"></h3>One of these days I will add something to my user profile! For now, I shall remain mysterious.
</li>		
						
			</ul>
			
		</div><!-- #primary .widget-area -->
		
		<div id="secondary" class="widget-area">
				
<script type='text/javascript'><!--// <![CDATA[
    OA_show(220407);
// ]]> --></script><noscript><a target='_blank' href='http://d1.openx.org/ck.php?n=68b8307'><img border='0' alt='' src='http://d1.openx.org/avw.php?zoneid=220407&amp;n=68b8307' /></a></noscript>				
				
				<ul class="xoxo">		
									</ul>	
				
<script type='text/javascript'><!--// <![CDATA[
    OA_show(29421);
// ]]> --></script><noscript><a target='_blank' href='http://d1.openx.org/ck.php?n=3f8e353'><img border='0' alt='' src='http://d1.openx.org/avw.php?zoneid=29421&amp;n=3f8e353' /></a></noscript>
				
		</div><!-- #secondary .widget-area -->			</div><!--sidebar-->
		</div><!-- #container -->
</div><!-- end div tabs see header.php -->
	
	<div id="footer">
		<div class="container_12">
		<div id="footer-widget-area">
				<div class="grid_4">					
					<ul>
					<li><a href="http://codebetter.com" title="home">Home</a></li>
					<li class="page_item page-item-2"><a href="http://codebetter.com/about/">About</a></li>
<li class="page_item page-item-8"><a href="http://codebetter.com/codebetter-ci/">CodeBetter CI</a></li>
<li class="page_item page-item-6"><a href="http://codebetter.com/community/">Community</a></li>
<li class="page_item page-item-10"><a href="http://codebetter.com/editors/">Editors</a></li>
<li class="page_item page-item-41"><a href="http://codebetter.com/globalsearch/">Search Results</a></li>
					<li><a href="http://feeds.feedburner.com/CodeBetter" rel="alternate" type="application/rss+xml"><img src="http://www.feedburner.com/fb/images/pub/feed-icon16x16.png" alt="" style="vertical-align:middle;border:0"/></a><a href="http://feeds.feedburner.com/CodeBetter"><img src="http://feeds.feedburner.com/~fc/CodeBetter?bg=FFFFFF&amp;fg=2E9BD2&amp;anim=1" height="26" width="88" style="vertical-align:middle;border:0"/></a></li>
					</ul>
				</div><!-- #second .widget-area -->
				<div class="grid_4">
					
					<h3>Friends of CodeBetter.Com</h3>
<ul>

<li><a href="http://red-gate.com/">Red-Gate Tools For SQL and .NET</a></li>
<li><a href="http://telerik.com">Telerik .NET Tools</a></li>
<li><a href="http://jetbrains.com/resharper/">JetBrains - ReSharper</a></li>
<li><a href="http://scootersoftware.com">Beyond Compare</a></li>
<li><a href="http://www.ndepend.com/">NDepend</a></li>
<li><a href="http://www.sapphiresteel.com/">Ruby In Steel</a></li>
<li><a href="http://www.slickedit.com/">SlickEdit</a></li>
<li><a href="http://www.gurock.com/products/smartinspect/">SmartInspect .NET Logging</a></li>
<li>NGEDIT: <a href="http://www.viemu.com/">ViEmu</a> and <a href="http://www.codekana.com/">Codekana</a> </li>
<li><a href="http://www.devexpress.com/" target="_blank">DevExpress</a></li>
<li><a href="http://nhprof.com" target="_blank">NHibernate Profiler</a></li>
<li><a href="http://unfuddle.com" target="_blank">Unfuddle</a></li>
<li><a href="http://www.balsamiq.com/products/mockups" target="_blank">Balsamiq Mockups</a></li>
<li><a href="http://scrumy.com" target="_blank">Scrumy</a></li>
<li><a href="http://umbraco.com" target="_blank">Umbraco</a></li>
<li><a href="http://nservicebus.com" target="_blank">NServiceBus</a></li>
<li><a href="http://ravendb.net" target="_blank">RavenDb</a></li>
<li><a href="http://www.websequencediagrams.com/" target="_blank">Web Sequence Diagrams</a></li>
	</ul>				
				</div><!-- #third .widget-area -->
				<div class="grid_4">
					CodeBetter.Com &copy; '12<br />
						Stuff you need to Code Better!<br />
				Proudly powered by <span id="generator-link"><a href="http://wordpress.org/" title="Semantic Personal Publishing Platform" rel="generator">WordPress</a></span>.					
				</div><!-- #fourth .widget-area -->
			</div><!-- #footer-widget-area -->		
		
			</div><!-- end div.container_12 -->

	</div><!-- end div#footer -->
		
<script type="text/javascript">

  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-531207-1']);
  _gaq.push(['_trackPageview']);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();

</script>
<script type='text/javascript' src='http://cdn1.codebetter.com/wp-content/plugins/syntaxhighlighter/syntaxhighlighter3/scripts/shCore.js?ver=3.0.83b'></script>
<script type='text/javascript' src='http://cdn1.codebetter.com/wp-content/plugins/syntaxhighlighter/syntaxhighlighter3/scripts/shBrushCSharp.js?ver=3.0.83b'></script>
<script type='text/javascript' src='http://cdn1.codebetter.com/wp-content/plugins/syntaxhighlighter/syntaxhighlighter3/scripts/shBrushRuby.js?ver=3.0.83b'></script>
<script type='text/javascript' src='http://cdn1.codebetter.com/wp-content/plugins/syntaxhighlighter/syntaxhighlighter3/scripts/shBrushJScript.js?ver=3.0.83b'></script>
<script type='text/javascript' src='http://cdn1.codebetter.com/wp-content/plugins/syntaxhighlighter/syntaxhighlighter3/scripts/shBrushXml.js?ver=3.0.83b'></script>
<script type='text/javascript' src='http://cdn1.codebetter.com/wp-content/plugins/syntaxhighlighter/syntaxhighlighter3/scripts/shBrushPython.js?ver=3.0.83b'></script>
<script type='text/javascript' src='http://cdn1.codebetter.com/wp-content/plugins/syntaxhighlighter/third-party-brushes/shBrushFSharp.js?ver=3.0.83b'></script>
<script type='text/javascript'>
	(function(){
		var corecss = document.createElement('link');
		var themecss = document.createElement('link');
		var corecssurl = "http://cdn1.codebetter.com/wp-content/plugins/syntaxhighlighter/syntaxhighlighter3/styles/shCore.css?ver=3.0.83b";
		if ( corecss.setAttribute ) {
				corecss.setAttribute( "rel", "stylesheet" );
				corecss.setAttribute( "type", "text/css" );
				corecss.setAttribute( "href", corecssurl );
		} else {
				corecss.rel = "stylesheet";
				corecss.href = corecssurl;
		}
		document.getElementsByTagName("head")[0].insertBefore( corecss, document.getElementById("syntaxhighlighteranchor") );
		var themecssurl = "http://cdn1.codebetter.com/wp-content/plugins/syntaxhighlighter/syntaxhighlighter3/styles/shThemeDefault.css?ver=3.0.83b";
		if ( themecss.setAttribute ) {
				themecss.setAttribute( "rel", "stylesheet" );
				themecss.setAttribute( "type", "text/css" );
				themecss.setAttribute( "href", themecssurl );
		} else {
				themecss.rel = "stylesheet";
				themecss.href = themecssurl;
		}
		//document.getElementById("syntaxhighlighteranchor").appendChild(themecss);
		document.getElementsByTagName("head")[0].insertBefore( themecss, document.getElementById("syntaxhighlighteranchor") );
	})();
	SyntaxHighlighter.config.strings.expandSource = '+ expand source';
	SyntaxHighlighter.config.strings.help = '?';
	SyntaxHighlighter.config.strings.alert = 'SyntaxHighlighter\n\n';
	SyntaxHighlighter.config.strings.noBrush = 'Can\'t find brush for: ';
	SyntaxHighlighter.config.strings.brushNotHtmlScript = 'Brush wasn\'t configured for html-script option: ';
	SyntaxHighlighter.defaults['gutter'] = false;
    SyntaxHighlighter.defaults['tab-size'] = 2;
    SyntaxHighlighter.defaults['toolbar'] = false;
    SyntaxHighlighter.defaults['wrap-lines'] = true; 
	SyntaxHighlighter.defaults['pad-line-numbers'] = false;
	SyntaxHighlighter.all();
</script>

<script type='text/javascript'>//<![CDATA[
    if (typeof jQuery == 'undefined') {
        document.write(unescape("%3Cscript src='http://ajax.aspnetcdn.com/ajax/jQuery/jquery-1.4.2.min.js' type='text/javascript' %3E%3C/script%3E"));
    }//]]></script>
<script type='text/javascript' language='Javascript' src='http://s1.lqcdn.com/m.min.js?dt=2.3.110202.1'></script>
<script type='text/javascript' language='Javascript'> if(jQuery.LqmAds)jQuery.LqmAds();</script>
 
</body>
</html>
<!-- Dynamic page generated in 0.606 seconds. -->
<!-- Cached page generated by WP-Super-Cache on 2012-11-09 21:35:26 -->
<!-- super cache -->