<!DOCTYPE html>
<html dir="ltr" lang="en-US">
<head>
	<meta charset="UTF-8" />
    <title>Ian Cooper</title>
	<link rel="profile" href="http://gmpg.org/xfn/11" />
	
	<link href="http://feeds.feedburner.com/CodeBetter" title="CodeBetter.Com &raquo; Feed" type="application/rss+xml" rel="alternate">
	
		<link rel="pingback" href="http://codebetter.com/iancooper/xmlrpc.php" />
	                <link rel="stylesheet" href="http://cdn1.codebetter.com/wp-content/uploads/spacker-cache/ea73517eb74a545f51c376487c94dc9f.css?v=3912785705" type="text/css" media="all" /><!-- Is Cache! -->
                <script type='text/javascript' src='https://ajax.googleapis.com/ajax/libs/jquery/1.6.0/jquery.min.js?ver=3.4.2'></script>
<script type='text/javascript' src='http://dtym7iokkjlif.cloudfront.net/dough/1.0/recipe.js'></script>
<link rel="EditURI" type="application/rsd+xml" title="RSD" href="http://codebetter.com/iancooper/xmlrpc.php?rsd" />
<link rel="wlwmanifest" type="application/wlwmanifest+xml" href="http://cdn1.codebetter.com/wp-includes/wlwmanifest.xml" /> 
<meta name="generator" content="WordPress 3.4.2" />

<!-- All in One SEO Pack 1.6.13.2 by Michael Torbert of Semper Fi Web Design[83,156] -->
<link rel="canonical" href="http://codebetter.com/iancooper/" />
<!-- /all in one seo pack -->
<link rel="stylesheet" href="http://cdn1.codebetter.com/wp-content/plugins/digg-digg/include/../css/diggdigg-style.css?ver=4.5.3.3" type="text/css" media="screen" />

<!-- Start Shareaholic OgTags -->

	<!-- Shareaholic Notice: There is no featured image set -->

<!-- End Shareaholic OgTags -->

<meta id="syntaxhighlighteranchor" name="syntaxhighlighter-version" content="3.1.3" />
                <script type="text/javascript" src="http://cdn1.codebetter.com/wp-content/uploads/spacker-cache/f6dc4c0f53ef65f49ac220c0b131dda2.js?v=3952471517">/*Is Cache!*/</script>
                	
	<script type='text/javascript' src='http://d1.openx.org/spcjs.php?id=7744&amp;target=_blank'></script>
	<style type="text/css">body { padding-top:0px !important; } html { margin-top: 0px !important; }</style>
<!-- BuySellAds Ad Code -->
<script type="text/javascript">
(function(){
  var bsa = document.createElement('script');
     bsa.type = 'text/javascript';
     bsa.async = true;
     bsa.src = 'http://s3.buysellads.com/ac/bsa.js';
  (document.getElementsByTagName('head')[0]||document.getElementsByTagName('body')[0]).appendChild(bsa);
})();
</script>
<!-- End BuySellAds Ad Code -->
</head>

<body>

			
		<div class="container_12 ui-tabs ui-widget ui-widget-content ui-corner-all" id="tabs">			
			<ul class="ui-tabs-nav ui-helper-reset ui-helper-clearfix ui-widget-header ui-corner-all">
				<li class="ui-state-default ui-corner-top ui-tabs-selected ui-state-active"><a href="#ui-tabs-1">CodeBetter.Com</a></li>
				<li class="ui-state-default ui-corner-top"><a href="http://devlicio.us">Devlicio.Us</a></li>				
				<div id="top-search">
				<form action="http://codebetter.com/globalsearch/" id="cse-search-box">
  <div>
   <fieldset id="search">
		<input type="hidden" name="cx" value="005178204031477491434:2bg5jtwgsfe" />
		<input type="hidden" name="cof" value="FORID:9" />
		<input type="hidden" name="ie" value="UTF-8" />
		<input type="text"  class="text-input" id="s" name="q" size="31" />
		<input type="image" src="http://cdn1.codebetter.com/wp-content/themes/codebetter/images/search-img.png" class="form-button" id="searchsubmit" value="GO" name="">				   	
	</fieldset>
  </div>
</form>
<script type="text/javascript" src="http://www.google.com/cse/brand?form=cse-search-box&lang=en&sitesearch=true"></script>
				</div>				
			</ul><div id="ui-tabs-1" class="ui-tabs-panel ui-widget-content ui-corner-bottom"></div><div id="ui-tabs-2" class="ui-tabs-panel ui-widget-content ui-corner-bottom ui-tabs-hide"></div>
		</div>
			
		<div id="main" class="container_12">
		
			<div id="logo" class="grid_3"><a href="/" title="CodeBetter.Com - Stuff you need to Code Better!"><image src="http://cdn1.codebetter.com/wp-content/themes/codebetter/images/codebetter_logo.png" height="48" width="223"></image></a></div>
			<div id="ad_leaderboard" class="grid_9">
			<!-- BuySellAds Zone Code -->
<div id="bsap_1276080" class="bsarocks bsap_4fe632babdccc2b4b049e4f08cc3c549"></div>
<!-- End BuySellAds Zone Code --></div>
			
			<div id="globalNav" class="grid_12">
				<ul>
					<li><a href="http://codebetter.com" title="home">Home</a></li>
					<li class="page_item page-item-2"><a href="http://codebetter.com/about/">About</a></li>
<li class="page_item page-item-8"><a href="http://codebetter.com/codebetter-ci/">CodeBetter CI</a></li>
<li class="page_item page-item-6"><a href="http://codebetter.com/community/">Community</a></li>
<li class="page_item page-item-10"><a href="http://codebetter.com/editors/">Editors</a></li>
					<li><a href="http://feeds.feedburner.com/CodeBetter" rel="alternate" type="application/rss+xml"><img src="http://www.feedburner.com/fb/images/pub/feed-icon16x16.png" alt="" style="vertical-align:middle;border:0"/></a><a href="http://feeds.feedburner.com/CodeBetter"><img src="http://feeds.feedburner.com/~fc/CodeBetter?bg=EFEFEF&amp;fg=2E9BD2&amp;anim=1" height="26" width="88" style="vertical-align:middle;border:0"/></a></li>
				</ul>
								
			</div><!-- end div#globalNav.container_12 -->				
		<div id="content">
		<div id="main" class="grid_8">
		<div id="greet_block"><noscript><div class="greet_block wpgb_cornered"><div class="greet_text"><div class="greet_image"><a href="http://codebetter.com/iancooper/feed/rss/"  rel="nofollow"><img src="http://cdn1.codebetter.com/wp-content/plugins/wp-greet-box/images/rss_icon.png" alt="WP Greet Box icon"/></a></div>Hello there! If you are new here, you might want to <a href="http://codebetter.com/iancooper/feed/rss/" rel="nofollow"><strong>subscribe to the RSS feed</strong></a> for updates on this topic.<div style="clear:both"></div><div class="greet_block_powered_by">Powered by <a href="http://omninoggin.com/projects/wordpress-plugins/wp-greet-box-wordpress-plugin/" title="WP Greet Box WordPress Plugin" style="text-decoration:none;">WP Greet Box</a> <a href="http://omninoggin.com/" title="WordPress Plugin" style="text-decoration:none;">WordPress Plugin</a></div><div style="clear:both"></div></div></div></noscript></div>		
	<div id="nav-above" class="navigation">
		<div class="nav-next"><a href="?page=1" > Next Page &raquo;</a></div>
		
	</div><!-- #nav-above -->


				
			<div id="post-222" class="post-222 post type-post status-publish format-standard hentry category-atdd category-bdd category-solid category-stdd category-tdd category-xunit">
			<h2 class="entry-title"><a href="http://codebetter.com/iancooper/2011/10/06/avoid-testing-implementation-details-test-behaviours/" title="Permalink to Avoid Testing Implementation Details, Test Behaviours" rel="bookmark">Avoid Testing Implementation Details, Test Behaviours</a></h2>

			<div class="entry-meta">
				<span class="meta-prep meta-prep-author">Posted on </span><a href="http://codebetter.com/iancooper/2011/10/06/avoid-testing-implementation-details-test-behaviours/" title="4:06 am" rel="bookmark"><span class="entry-date">October 6, 2011</span></a> <span class="meta-sep"> by </span> <span class="author vcard"><a class="url fn n" href="http://codebetter.com/iancooper" title="View all posts by Ian Cooper">Ian Cooper</a></span>			</div><!-- .entry-meta -->

				<div class="entry-content">
				<!-- Start Shareaholic LikeButtonSetTop Automatic --><!-- End Shareaholic LikeButtonSetTop Automatic --><p>Every so often I return to <a href="http://en.wikipedia.org/wiki/Kent_Beck">Kent Beck&#8217;s</a> <a href="http://www.amazon.co.uk/Test-Driven-Development-Addison-Wesley-Signature/dp/0321146530">Test-Driven Development</a>. I honestly believe it to be one of the finest software development books ever written. What I love about the book is its simplicity. There is a sparseness to it that decieves, as though it were a lightweight exploration of the field. But continued reading as you progress with TDD reveals that it is fairly complete in its insights. Where later works have added pages and ideas, they have often lessened the technique, burdening it with complexity, born of misunderstandings of its power. I urge any of you who have practiced TDD for a while to re-read it regularly</p>
<p>For me one of the key ideas of TDD that is often overlooked is expressed in the cycle or Red, Green, Refactor. First we write a failing test, then we implement as quickly and dirtily as we can, and then we make it elegant. In this blog post I want to talk about some of the insights of the second and third steps that get missed. (Although you should remember the first step: tests don&#8217;t have tests so you need to prove them).</p>
<p>A lot of folks stall when they come to implement, because they try to implement well, thinking about good OO, SOLID patterns etc. Stop! The goal is to get green as soon as possible. Don&#8217;t try to build a decent solution at this point, just script out the quickest solution to the problem you can get too. Cut and Paste if you can, copy algorithms from CodeProject or StackOverflow if you can.</p>
<p>From <strong>Test-Driven Development</strong></p>
<blockquote><p>Stop. Hold on. I can hear the aesthetically inclined among you sneering and spitting. Copy-and-paste reuse? The death of abstraction? The killer of clean design?</p>
<p>If you&#8217;re upset, take a cleansing breath. In through the nose &#8230; hold it 1, 2, 3 &#8230; out through the mouth. There. Remember, our cycle has different phases (they go by quickly, often in seconds, but they are phases.):</p>
<p>1 Write a test.</p>
<p>2. Make it compile.</p>
<p>3. Run it to see that it fails.</p>
<p>4. Make it run.</p>
<p>5. Remove duplication.&#8221;</p></blockquote>
<p>It&#8217;s that final step (which is our refactoring step) in which we create Clean Code. Not before, but after.</p>
<blockquote><p>&#8220;Solving “clean code” at the same time that you solve “that works” can be too much to do at once. As soon as it is, go back to solving “that works,” and then “clean code” at leisure.&#8221;</p></blockquote>
<p>Now there is an important implication here that is often overlooked. We don&#8217;t have to write tests for the classes that we refactor out through that last step. They will be internal to our implementation, and are already covered by the first test. We do not need to add new tests for the next level &#8211; unless we feel we do not know how to navigate to the next step.</p>
<p>From <strong>Test-Driven Development</strong> again:</p>
<blockquote><p>&#8220;Because we are using Pairs as keys, we have to implement equals() and hashCode(). I&#8217;m not going to write tests for these, because we are writing this code in the context of a refactoring. If we get to the payoff of the refactoring and all of the tests run, then we expect the code to have been exercised. If I were programming with someone who didn&#8217;t see exactly where we were going with this, or if the logic became the least bit complex, I would begin writing separate tests.&#8221;</p></blockquote>
<p>Code developed in the context of refactoring does not require new tests! It is already covered, and safe refactoring techniques mean we should not be introducing specualtive change, just cleaning up the rough implementation we used to to green. At this point further tests help you steer (but they come at a cost)</p>
<p>The outcome of this understanding is that a test-case per class approach fails to capture the ethos for TDD. Adding a new class is not the trigger for writing tests. The trigger is implementing a requirement. So we should test outside-in, (though I would recommend using ports and adapters and making the &#8216;outside&#8217; the port), writing tests to cover then use cases (scenarios, examples, GWTs etc.), but only writing tests to cover the implementation details of that as and when we need to better understand the refactoring of the simple implementation we start with.</p>
<p>A positive outcome from this will be that much of our implementation will be internal or private, and never exposed outside our assembly. That will lower the coupling of our solution and make it easier for us to effect change.</p>
<p>From <strong>Test-Driven Development</strong> again:</p>
<blockquote><p>&#8220;In TDD we use refactoring in an interesting way. Usually, a refactoring cannot change the semantics of the program under any circumstances. In TDD, the circumstances we care about are the tests that are already passing.&#8221;</p></blockquote>
<p>When we refactor we don&#8217;t want to break tests. If our tests know too much about our implementation, that will be difficult, because changes to our implementation will necessarily result in us re-writing tests &#8211; at which point we are not refactoring. We would say that we have over-specified through our tests. Instead of assisting change, our tests have now begun to hamper it. As someone who has made this mistake, I can vouch for the fact that it is possible to write too many unit tests against details. If we follow TDD as originally envisaged though, the tests will naturally fall mainly on our public interface, not the implementation details, and we will find it far easier to meet the goal of changing the impementation details (safe change) and not the public interface (unsafe change)</p>
<p>Of course, this observation, that this idea has been overlooked by many TDD practitioners, formed the kernel of <a href="http://dannorth.net/introducing-bdd/">Dan North&#8217;s original BDD missive</a> and is why BDD focused on scenarios and outside-in for TDD</p>
<div class="shr-publisher-222"></div><!-- Start Shareaholic LikeButtonSetBottom Automatic --><!-- End Shareaholic LikeButtonSetBottom Automatic -->							</div><!-- .entry-content -->
	
			<div class="entry-utility">
				<span class="cat-links"><span class="entry-utility-prep entry-utility-prep-cat-links">Posted in <a href="http://codebetter.com/iancooper/category/atdd/" title="View all posts in ATDD" rel="category">ATDD</a>, <a href="http://codebetter.com/iancooper/category/bdd/" title="View all posts in BDD" rel="category">BDD</a>, <a href="http://codebetter.com/iancooper/category/solid/" title="View all posts in SOLID" rel="category">SOLID</a>, <a href="http://codebetter.com/iancooper/category/stdd/" title="View all posts in STDD" rel="category">STDD</a>, <a href="http://codebetter.com/iancooper/category/tdd/" title="View all posts in TDD" rel="category">TDD</a>, <a href="http://codebetter.com/iancooper/category/xunit/" title="View all posts in xUnit" rel="category">xUnit</a></span></span>
				<span class="meta-sep"> | </span>
												<span class="comments-link"><a href="http://codebetter.com/iancooper/2011/10/06/avoid-testing-implementation-details-test-behaviours/#comments" title="Comment on Avoid Testing Implementation Details, Test Behaviours"><span class="dsq-postid" rel="222 http://codebetter.com/iancooper/?p=222">15 Comments</span></a></span>
							</div><!-- #entry-utility -->
		</div><!-- #post-222 -->

		
						
			<div id="post-194" class="post-194 post type-post status-publish format-standard hentry category-uncategorized">
			<h2 class="entry-title"><a href="http://codebetter.com/iancooper/2011/07/15/why-crud-might-be-what-they-want-but-may-not-be-what-they-need/" title="Permalink to Why CRUD might be what they want, but may not be what they need" rel="bookmark">Why CRUD might be what they want, but may not be what they need</a></h2>

			<div class="entry-meta">
				<span class="meta-prep meta-prep-author">Posted on </span><a href="http://codebetter.com/iancooper/2011/07/15/why-crud-might-be-what-they-want-but-may-not-be-what-they-need/" title="1:35 pm" rel="bookmark"><span class="entry-date">July 15, 2011</span></a> <span class="meta-sep"> by </span> <span class="author vcard"><a class="url fn n" href="http://codebetter.com/iancooper" title="View all posts by Ian Cooper">Ian Cooper</a></span>			</div><!-- .entry-meta -->

				<div class="entry-content">
				<!-- Start Shareaholic LikeButtonSetTop Automatic --><!-- End Shareaholic LikeButtonSetTop Automatic --><h2>A brief history of CRUD </h2>
<p>The Rolling Stones once sung:</p>
<blockquote><p>&#8220;You can&#8217;t always get what you want, But if you try sometimes, well you just might find, You get what you need&#8221;</p></blockquote>
<p>I think the same is true of CRUD. Our users seem to ask for it and we blindly agree to their wishes and build it; however, its regularly not what they need.</p>
<h3>The File Store</h3>
<p>When computers first arrived the early commercial use was to try and remove the need for paper files. Some of us may be old enough to remember that offices has filing departments with staff, where when we began a piece of work we went to get the records that the company had on that customer, or policy, or project. There were problems with this approach: file stores took up a lot of space, and the mangement of paper based records, particulary archival material is expensive; often, someone else had the file out, buried on their desk, and it was not always clear who &#8211; an early form of pessimistic concurrency control &#8211; which often stopped you responding to requests; files were only as useful as the discipline of maintaing them, and keeping them in order &#8211; searching was difficult within a file if it was not ordered and there was no idea of seaching the file store itself.</p>
<p>So it was natural when we began to think about ways in which computers could help in the workplace to think about electronic filing systems. We would record the data around the customer, policy, or project on an electronic form instead of a paper one and the computer could store it for us. We saved paper, we saved staff, we saved time, and we added new functionality such as the ability to search.</p>
<p>The UIs that we designed were optimized to enter data. After all there was a lot of data to enter just to catch up on. The essential questions for UX design became tab order or number of clicks &#8211; just how fast could we enter data. We wanted bulk data entry grids, and forms that mirrored our paper based forms, because that was what we needed to get out of the physical filing store and into our electronic store</p>
<p>Throughout the paper told us what to do and the process was built around the form. The form was passed from person to person. Stickers attached to the form, or boxes on the file defined the workflow. The paper-trail was the business process. Indeed, early analysis techniques simply followed the paper trail. Initial systems just followed the existing paper based process. Someone took the paper, the insurance application form, and type it in to the terminal. Then a batch run moved the record to the next step, so the next person in line could perform the same step that they had at the computer.</p>
<p>But no one really thought of this workflow as something the computer could handle. We just did handoffs the same way we did with paper. Indeed we sometimes used paper as the &#8216;token&#8217; that we passed around for the workflow and told you that you needed to enter the system and do some work. Or, later we became more sophisticated, and used email to do the same thing.</p>
<p>And for this perspective &#8211; the electronic filing store &#8211; Create, Read, Update, and Delete (CRUD) was the paradigm we needed. It described the lifecycle of a paper file perfectly and with our goal to automate that physical file store it was a capable model &#8211; or so it seemed.</p>
<h2>Brave New World</h2>
<p>Users tend to create electronic documents today. There is less paper. Inputs come from phone, email, the consumer directly accessing a web-based interface. Removing the phsyical file store is no longer behind the business case to provide IT systems. We no longer want to remove the old filing room and its associated clerks. Of course we might want to move away from our new shadow IT world of documents on shared drives and Excel spreadsheets.</p>
<p> The business goals around automation have changed too. To obtain the savings that justify the cost of IT savings, we want to enable smaller numbers of people to carry out the tasks formally done by many through not just electronic filing but through business process automation.</p>
<p> But once we shift the goals away from data entry to process automation, the shape of our architecture changes too. Less of the value comes from data entry today. It comes from providing a key business differentiator that allows us to outperform the competition in service, control of costs, management of supply chain, enabling new business models through disintermediation etc.</p>
<p>CRUD &#8211; a model for removing the old file store is less useful as a paradigm when we come to think about analysing and architecting a response to this kind of business process.</p>
<p>Think about how we force users to interact under a CRUD paradigm. They have procedures written in a manual, a checklist for the process. They have to edit this page,then edit that page etc. The system consists of CRUD screens where the users do the data entry. People run their workflow using email. Business process is the preserve of a priesthood who maintain their position by understanding &#8216;how things are done here&#8217;. </p>
<p>The problem here is that the behavior is not captured in the system, it is captured in the manual at best, more likely in the oral transmission of process from one worker to another. The business understands that it has workflow and behavior &#8211; they defined process with copies of memos, forms etc. We have not removed those steps by automating them, we have just  given them electronic forms. Pejoratively we are little better than the shadow IT offering written in Access; why engage an IT expert at all for that, all you do is add cost. </p>
<p>Much of the issue here is sheer laziness on our part. When I see tweets and blog posts saying: most business apps are CRUD, I hear, &#8220;we don&#8217;t want to work with the business to show them what IT could do for them&#8221;. Part of the reason is because it requires little skill to model CRUD; modelling business process is harder &#8211; but that is where the value lies. Think of early software development approaches that began with modeling the data, and then identified processes to act on that data. Is it any wonder we built CRUD based systems if we started by thinking about data. Data Flow diagrams, Process diagrams. These were the cornerstones of how we thought about the design phase of the software lifecycle and we have failed to escape from it. However, for our users recording data itself is rarely the end goal any more, completion of a business process is the goal.</p>
<p>Now sure, in some cases we might still have CRUD, for some kinds of reference data, and I&#8217;m sure a lot of people will respond to this with straw men of CRUD only applications. But be careful. In a lot of cases the customer thinks about records management, and they don&#8217;t know you could help them with processing, business rules, workflow (or are frightened of what that might mean for their jobs). Anywhere where there is a process in someone&#8217;s head, a word document, or excel spreadsheet that says, when this happens, you need to go into this page and fill in these values on the form, you have behavior, or intent that could and should be captured.</p>
<p>Let&#8217;s take a simple example: changing the state of a purchase order. What we tend to be saying is: the workflow for this process has reached a certain point and so it can move into this state. We can immediately see that we must have a number of things for this to occur: the purchase order must have some data that we need to validate it; we can also see that a number of things may be predicated on this occurring: we need to send the order to fulfilment, we need to begin the billing process etc. So this act, completing a purchase order, has both a workflow or business process and rules. A CRUD based approach to design tends to encourage us to leave these outside the system, with the user, in some set of manual checks or switching between parts of the application. What we want to look at is: is this process something we could automate, could the workflow and rules live in the system?</p>
<p>Of course a traditional objection to putting workflow and rules &#8216;in the system&#8217; is that they can change. This causes some folks to suggest that they ought to be left out.</p>
<p>Unfortunately in the typical business this means that a given named person Alice, Mary or Bob is the person that understands how to drive the process, and is mission critical to the success of the enterprise. If they get hit by a bus its all over, and they can pretty much ask for a raise whenever they like, because we can&#8217;t afford to lose them. Process diagrams often end up with a stick figure which imply that &#8216;Alice does her magic&#8217;. Often that person is uncommunicative and secretive about the process &#8211; to ensure that they remain essential to the business. When they are absent, things fall apart.</p>
<p>No business really wants that.
<p />
<p>And the reality is that we have plenty of options we can use to make workflow and rules more configurable &#8211; though we need to look at the tradeoffs between the cost to change the app against using a rules engine or workflow engine carefully by understanding the amount of likely change.</p>
<h2>Enter Tasks: What to you want to do today.</h2>
<p>We need to drop the focus on CRUD and move to a focus on tasks: what is it that the user wants to accomplish, and how can we help them accomplish that?</p>
<p>Let&#8217;s think about the case of a family doctor. In an appointment they tend to take the patient&#8217;s history, diagnose the illness, and prescribe a course of treatment. Now, in the UK the paper based way to achieve this used to be the <a href="http://www.patient.co.uk/doctor/Clinical-Negligence-and-the-Electronic-Patient-Record.htm">Lloyd George envelope.</a> Simply replicating the functionality of the Lloyd George envelope using a CRUD approach would give us screens for entering consultation notes, prescriptions&#8230; But there is a lot more we could do to help. If we treat diagnosis as a task, then we ought to consider searching previous medical history to see if anything shows up related to the patient&#8217;s complaint that may be of concern. There may be guidelines for these symptoms that we should be following to check that we are not missing illnesses like meningitis. When we prescribe we can list common drugs for the illness, and look for incompatibility with drugs that the patient is currently being prescribed in a drugs database. That may lead to us offering further advice, for example if the patient is using the contraceptive pill and we prescribe them antibiotics.</p>
<p>Or perhaps consider an on line retailer where the customer can go in and change their account details. If the customer changes their address, we might want to prompt the customer for in-flight orders and ask where they want them to be delivered &#8211; the old address or the new address.</p>
<p>Ask yourself the question: am I thinking about the intent of what the user wishes to accomplish?</p>
<p>The grid is particularly dangerous ground in this regard. It is rare that you can capture intent through a grid. if you are using a grid you are probably not focused on a task but on CRUD</p>
<p>Greg Young has a great <a href="http://cqrsinfo.com/documents/task-based-ui/">discussion on the Task-based UI</a>. It is one of the building blocks in a journey towards understanding the why of <a href="http://cqrsinfo.com/">CQRS</a></p>
<div class="shr-publisher-194"></div><!-- Start Shareaholic LikeButtonSetBottom Automatic --><!-- End Shareaholic LikeButtonSetBottom Automatic -->							</div><!-- .entry-content -->
	
			<div class="entry-utility">
				<span class="cat-links"><span class="entry-utility-prep entry-utility-prep-cat-links">Posted in <a href="http://codebetter.com/iancooper/category/uncategorized/" title="View all posts in Uncategorized" rel="category">Uncategorized</a></span></span>
				<span class="meta-sep"> | </span>
												<span class="comments-link"><a href="http://codebetter.com/iancooper/2011/07/15/why-crud-might-be-what-they-want-but-may-not-be-what-they-need/#comments" title="Comment on Why CRUD might be what they want, but may not be what they need"><span class="dsq-postid" rel="194 http://codebetter.com/iancooper/?p=194">23 Comments</span></a></span>
							</div><!-- #entry-utility -->
		</div><!-- #post-194 -->

		
						
			<div id="post-175" class="post-175 post type-post status-publish format-standard hentry category-cqrs category-ddd category-events category-object-orientation category-solid category-uncategorized">
			<h2 class="entry-title"><a href="http://codebetter.com/iancooper/2011/04/27/why-use-the-command-processor-pattern-in-the-service-layer/" title="Permalink to Why use the command processor pattern in the service layer" rel="bookmark">Why use the command processor pattern in the service layer</a></h2>

			<div class="entry-meta">
				<span class="meta-prep meta-prep-author">Posted on </span><a href="http://codebetter.com/iancooper/2011/04/27/why-use-the-command-processor-pattern-in-the-service-layer/" title="5:00 pm" rel="bookmark"><span class="entry-date">April 27, 2011</span></a> <span class="meta-sep"> by </span> <span class="author vcard"><a class="url fn n" href="http://codebetter.com/iancooper" title="View all posts by Ian Cooper">Ian Cooper</a></span>			</div><!-- .entry-meta -->

				<div class="entry-content">
				<!-- Start Shareaholic LikeButtonSetTop Automatic --><!-- End Shareaholic LikeButtonSetTop Automatic --><h4>Using a Command Processor</h4>
<p>When we think about a <a href="http://domaindrivendesign.org/node/118">layered </a>or <a href="http://alistair.cockburn.us/Hexagonal+architecture">hexagonal </a>architecture it is common to identify the need for a service layer. The service layer both provides a facade over our domain layer to applications &#8211; acting as an API definition &#8211; and contains the co-ordination and control logic for orchestrating how we respond to requests.</p>
<p>One option to implement this is the notion of a service as a class:</p>
<pre><code>
public class MyFatDomainService
{
    public void CreateMyThing(CreateMyThingCommand createMyThingCommand)
    {
        /*Stuff*/
    }

    public void UpdateMyThingForFoo(FooCommand fooHappened)
    {
       /*Other Stuff*/
    }

     public void UpdateMyThingForBar(BarCommand barHappened)
     {
        /*Other Stuff*/
     }

     /*Loads more of these*/
}
</code></pre>
<p>Another option is to use the <a href="wiki.hsr.ch/APF/files/CommandProcessor.pdf">command processor pattern</a>. There are some keys to understanding the choice to use a command processor to implement your service layer.</p>
<p>The <a href="http://www.objectmentor.com/resources/articles/isp.pdf">Interface Segregation Principle</a> states that clients should not be forced to depend on methods on an interface that they do not use. This is because we do not want to update the client because the interface changes to service other clients in a way that the client itself does not care about. <em>Operation script</em> style domain service classes force consumers (for example MVC controllers) to become dependent on methods on the domain service class that they do not consume.</p>
<p>Now this can be obviated by having the domain service implement a number of interfaces, and hand to its clients interfaces that only cover the concerns they have. With application service layers this naturally tends towards one method per interface.</p>
<pre><code>
public interface ICreateMyThingDomainService
{
    void CreateMyThing(CreateMyThingCommand createMyThingCommand);
}

public interface IUpdateMyThingForFooDomainService
{
    void UpdateMyThingForFoo(FooCommand fooHappened);
}

public interface IUpdateMyThingForBarDomainService
{
   void UpdateMyThingForBar(BarCommand barHappened);
}

public class MyFatDomainService : ICreateMyThingDomainService, IUpdateMyThingForFooDomainService, IUpdateMyThingForBarDomainService
{
   public void CreateMyThing(CreateMyThingCommand createMyThingCommand)
  {
      /*Stuff*/
   }

   public void UpdateMyThingForFoo(FooCommand fooHappened)
  {
      /*Other Stuff*/
  }

   public void UpdateMyThingForBar(BarCommand barHappened)
   {
      /*Other Stuff*/
    }

/*Loads more of these*/

}
</code></pre>
<p>Now the <a href="http://www.objectmentor.com/resources/articles/srp.pdf">Single Responsibility Principle</a> suggests that a class should have one and only one reason to change. All these separate interfaces begin to suggest that a separate class might be better for each interface, to avoid updating a class for concerns that it does not have.</p>
<pre><code>
public interface ICreateMyThingDomainService
{
    void CreateMyThing(CreateMyThingCommand createMyThingCommand);
}

public class CreateMyThingDomainService : ICreateMyThingDomainService
{
    public void CreateMyThing(CreateMyThingCommand createMyThingCommand)
    {
       /*Stuff */
    }
}

public interface IUpdateMyThingForFooDomainService
{
    void UpdateMyThingForFoo(FooCommand fooHappened);
}

public class UpdateMyThingForFooDomainService : IUpdateMyThingForBarDomainService
{
    public void UpdateMyThingForBar(BarCommand barHappened)
   {
      /*Other Stuff*/
   }
}

public interface IUpdateMyThingForFooDomainService
{
   void UpdateMyThingForBar(FooCommand barHappened);
}

public class UpdateMyThingForFooDomainService : IUpdateMyThingForFooDomainService
{
   public void UpdateMyThingForFoo(FooCommand barHappened)
  {
    /*Other Stuff*/
  }
}
</code></pre>
<p>Having split these individual classes out we might choose to avoid calling them directly, but instead decide to send a message to them. There are a number of reasons for this.</p>
<p>The first is that we decouple the caller from the service. This is useful where we might want to change what the service does – for example handle requests asynchronously, without modifying the caller.</p>
<p>The second is that we might want to handle orthogonal concerns orthogonally such as transactions or logging. Although we could use a technology like PostSharp to weave in aspects, a simpler approach is pipes and filters – create a pipeline with a series of steps, the end of which is our service. We then send a message, the framework instantiates a pipeline with those orthogonal concerns, the message is passed through the filter steps before arriving at the target handler.</p>
<p>In order to make this work the pipeline steps need to implement a common interface as this allows us to add <a href="http://en.wikipedia.org/wiki/Decorator_pattern">Decorators</a> that implement the same interface, forming a <a href="http://en.wikipedia.org/wiki/Chain-of-responsibility_pattern">Chain of Responsibility</a>.</p>
<p>&nbsp;</p>
<pre><code>
public interface IHandleMessages
{
    void Handle(T command);
}

public class CreateMyThingHandler : IHandleMessages
{
    public void Handles(CreateMyThingCommand createMyThingCommand)
   {
      /*Stuff */
  }
}

public class UpdateMyThingForFooHandler : IHandleMessages
{
    [Logging]
    public void Handles(BarCommand barHappened)
    {
      /*Other Stuff*/
    }
}

public class Logger : IHandleMessages
{
    public void Handles(BarCommand barHappened)
   {
       /*Other Stuff*/
   }
}
</code></pre>
<p>The code is not shown here, but you may want to use attributes to document a handler and show the decorators in the chain of responsibility. You could use these to decide what decorators to put in the chain. However, It&#8217;s worth noting that real implementations that assemble a chain of responsibility often use an Inversion of Control container to resolve the handler and you will often find it easier to implement if you have an IDecorate interface. Some of the pipeline building code involves usually involves dealing with <a href="http://msdn.microsoft.com/en-us/library/system.type.makegenerictype.aspx">Type.MakeGenericType</a> and you might want to be aware of that if you want to use this approach. I might do a separate post on building a chain of responsibility at a future date.</p>
<p>Note that this also serves to reduce the number of interfaces that we must implement as the generic interface can stand in for most of them.</p>
<p>Third is the number of dependencies our service has. We might have an action that we need to execute as part of the response to a number of actions by the user. We don’t want to repeat that code in every service. But, we also don’t want to have services calling too many other services, (that in turn may call other services), because we will get an explosion of dependencies for our service, and the service that it depends on. This makes it hard to get our service under test, or makes the tests unintelligible and results in <a href="http://altnetseattle.pbworks.com/w/page/12367942/Why%20We%20Stopped%20Using%20the%20Auto-Mocking%20Container%20and%20What%27s%20Next">anti-patterns like auto-mocking</a>. The need for auto-mocking may be seen as a design smell: you have too many dependencies; resolution might be to use a command processor.</p>
<p>We gain some dependency advantages from the split into separate handlers, because each handler will have fewer dependencies than a service. But in addition we can separate concerns in our handlers, such that we focus on updating a small part of our domain model or object graph in each handler (in DDD terms we focus on an <a href="http://domaindrivendesign.org/node/88">aggregate</a>).</p>
<p>So to further limit the number of dependencies we prefer to publish a message (an event) from the service that handles the initial request, handing off any work that is related to handling the command, but applies to a different aggregate (and should potentially be in a different transaction and consistency boundary). This allows the framework to pass the message to those services, removing our dependency on them.</p>
<pre><code>
public class CreateMyThingHandler : IHandleMessages
{
    IProcessCommands _commandProcessor;
    IMyThingRepository _myThingRepository;

    public CreateMyThingHandler(IProcessCommands commandProcessor, 
         IMyThingRepository myThingRepository)
   {
      _commandProcessor = commandProcessor;
      _myThingRepository = myThingRepository;
   }

   public void Handles(CreateMyThingCommand createMyThingCommand)
  {
      /*Use Factory or Factory Method to create a my thing  */
      /*save my thing to a repository*/

      _commandProcessor.Publish(
          new MyThingCreated
              {/* properties that other consumers may care about*/}
          );
   }
}
</code></pre>
<p>In addition a command processor, because it is responsible for loading the services, is also the point at which an Inversion of Control (IOC) container is injected into our request handling pipeline, which removes any issues with lack of support for IOC containers in legacy platforms like WebForms.</p>
<p>Finally switching to a command processor eases our path to handling some requests asynchronously.</p>
<h4>Disadvantages of using a command processor</h4>
<p>One common criticism of using a command processor is that it adds a level of indirection. To read the code you have to identify how commands map to handlers. Naming conventions can help ease the burden, especially if used with tools like R#.</p>
<div class="shr-publisher-175"></div><!-- Start Shareaholic LikeButtonSetBottom Automatic --><!-- End Shareaholic LikeButtonSetBottom Automatic -->							</div><!-- .entry-content -->
	
			<div class="entry-utility">
				<span class="cat-links"><span class="entry-utility-prep entry-utility-prep-cat-links">Posted in <a href="http://codebetter.com/iancooper/category/cqrs/" title="View all posts in CQRS" rel="category">CQRS</a>, <a href="http://codebetter.com/iancooper/category/ddd/" title="View all posts in DDD" rel="category">DDD</a>, <a href="http://codebetter.com/iancooper/category/events/" title="View all posts in Events" rel="category">Events</a>, <a href="http://codebetter.com/iancooper/category/object-orientation/" title="View all posts in Object-Orientation" rel="category">Object-Orientation</a>, <a href="http://codebetter.com/iancooper/category/solid/" title="View all posts in SOLID" rel="category">SOLID</a>, <a href="http://codebetter.com/iancooper/category/uncategorized/" title="View all posts in Uncategorized" rel="category">Uncategorized</a></span></span>
				<span class="meta-sep"> | </span>
												<span class="comments-link"><a href="http://codebetter.com/iancooper/2011/04/27/why-use-the-command-processor-pattern-in-the-service-layer/#comments" title="Comment on Why use the command processor pattern in the service layer"><span class="dsq-postid" rel="175 http://codebetter.com/iancooper/?p=175">14 Comments</span></a></span>
							</div><!-- #entry-utility -->
		</div><!-- #post-175 -->

		
						
			<div id="post-165" class="post-165 post type-post status-publish format-standard hentry category-net category-ddd category-nhibernate category-orm">
			<h2 class="entry-title"><a href="http://codebetter.com/iancooper/2011/04/12/repository-saveupdate-is-a-smell/" title="Permalink to Why Repository SaveUpdate is a smell" rel="bookmark">Why Repository SaveUpdate is a smell</a></h2>

			<div class="entry-meta">
				<span class="meta-prep meta-prep-author">Posted on </span><a href="http://codebetter.com/iancooper/2011/04/12/repository-saveupdate-is-a-smell/" title="5:30 am" rel="bookmark"><span class="entry-date">April 12, 2011</span></a> <span class="meta-sep"> by </span> <span class="author vcard"><a class="url fn n" href="http://codebetter.com/iancooper" title="View all posts by Ian Cooper">Ian Cooper</a></span>			</div><!-- .entry-meta -->

				<div class="entry-content">
				<!-- Start Shareaholic LikeButtonSetTop Automatic --><!-- End Shareaholic LikeButtonSetTop Automatic --><p>One of the idioms I see a fair amount of is the <strong>SaveUpdate </strong>method on a <a href="http://martinfowler.com/eaaCatalog/repository.html">Repository</a>. The intent is usually to persist an item to storage, using a <strong>SaveUpdate </strong>method to lazily avoid the question of whether it is a new object, or just one you are updating.</p>
<p>I have a couple of issues with this approach. The first is that a Repository is intended to have collection semantics and encapsulate the method used to obtain the data. Adding <strong>SaveUpdate</strong> makes it explicit that your repository is backed with some kind of persistent storage &#8211; why else would you need to save it. But a Repository does not encapsulate access to a Db, a repository is simply a collection of entities (in DDD aggregate roots) which is agnostic about where the entities are stored. A Repository might be entirely in memory, it might abstract a <a href="http://en.wikipedia.org/wiki/Representational_State_Transfer">REST API</a> on a separate service, then options are legion.</p>
<p>In most cases I would prefer that we have a similar interface to a collection: an <strong>Add</strong> method because I want to add new items into the collection, but not an update, because I should only need to change an object referenced from the collection for that.</p>
<p>Working with <a href="http://nhforge.org/Default.aspx">NHibernate </a>(NH) this also works with NH&#8217;s paradigm rather than against it. This is my second issue: you should rarely need to ever call SaveUpdate in NH, and only rarely call Save.</p>
<p>NH distinguishes between two types of objects: <em>transient </em>and <em>persistent</em>. A <em>persistent</em> object is one that is in the Db, a <em>transient </em>one is in memory. When you <strong>Save </strong>against an NH session a <em>transient </em>object becomes a <em>persistent </em>one. When an object is loaded from the Db it is a <em>persistent </em>object. The key to this is the <a href="http://martinfowler.com/eaaCatalog/identityMap.html">Identity Map</a> pattern &#8211; NH has a list of all the objects loaded from the Db, so that it knows to serve them back up to you, if you ask for the object representing a row again during the session. The idea is that you want to use the version with any changes you have already made, not a fresh copy from the Db.</p>
<p>When NH flushes a session, or commits a transaction, it does a dirty check for all the <em>persistent </em>objects in your Identity Map, and saves any changes. That&#8217;s it, no need to call <strong>SaveUpdate</strong>, just flush the session or commit a transaction and your <em>persistent </em>objects will be saved. So <strong>Update </strong>is meaningless to call explicitly, NH will do it for you. (Understanding this is important, because auto-flush will commit dirty writes when your session terminates, even if you threw an exception; this may not be what you desired, in which case you should not autoflush but rely on explicit transactions).</p>
<p>This fits nicely with our Repository as collection metaphor: we don&#8217;t need to do anything with objects that already part of the collection post-updating them.</p>
<p>In addition NH supports <em>persistence by cascade</em> &#8211; you know those options you set on many-to-one, many&#8211;to-many relationships etc. Provided your cascade options require NH to follow a relationship, a <em>persistent </em>object will also save children in its object graph. Now this does not make any difference for already <em>persistent </em>objects, but <em>transient </em>ones that can be reached by following a cascade will be saved too.</p>
<p>This means that you do not need to call <strong>Save </strong>for an object that is added to the graph of an already <em>persistent </em>the dirty check will pick it up &#8211; so adding a new object in this case does not require a call to <strong>Save</strong>.</p>
<p>This makes sense for our Repository pattern, we don&#8217;t tend to call <strong>Add </strong>for the children in the object graph of entities we add to a collection, and there. It is also worth noting that this lends itself to the DDD idea of an Aggregate Root being what a Repository loads, we need to load root objects, not all their children. (Sadly NH does not really support the notion of a <a href="http://martinfowler.com/eaaCatalog/coarseGrainedLock.html">coarse-grained lock</a>, which aggregates try to implement, <a href="http://ayende.com/Blog/archive/2009/05/30/nhibernate-ndash-coarse-grained-locks.aspx">but that&#8217;s a seperate issue</a>).</p>
<p>This means that we only ever need to <strong>Save </strong>i.e. <strong>Add </strong>to our Repository, on new <em>transient</em> objects that have no association with existing objects (in DDD terms likely to be Aggregate Roots). There are usually a lot less of these than other kinds of entities. So once you challenge the idea of doing <strong>SaveUpdate</strong>, you naturally begin to move toward thinking about a Repository loading an object graph, and not an entity. By doing this you are both encapsulating your access to whatever backs the repository, and in the case of an O<a href="http://en.wikipedia.org/wiki/Object-relational_mapping">bject-Relational Mapper </a>(ORM) working with the ORM. A good ORM is intended to support the OO paradigm, if you don&#8217;t exploit its power to work seamlessly, but rely on old school explicitly CRUD operations on a <a href="http://martinfowler.com/eaaCatalog/dataMapper.html">Data Mapper</a> then you miss some of the strengths of a well written ORM.</p>
<p>If you want to have explicit knowledge of the Db, and find it more comfortable to know that you are saving to the Db, use the Data Mapper pattern, not a Repository. Otherwise, consider that explicitly calling <strong>SaveUpdate </strong>(or synonyms of that) may well be a smell that you are pusing too much information about how persistence is done into your model.</p>
<div class="shr-publisher-165"></div><!-- Start Shareaholic LikeButtonSetBottom Automatic --><!-- End Shareaholic LikeButtonSetBottom Automatic -->							</div><!-- .entry-content -->
	
			<div class="entry-utility">
				<span class="cat-links"><span class="entry-utility-prep entry-utility-prep-cat-links">Posted in <a href="http://codebetter.com/iancooper/category/net/" title="View all posts in .Net" rel="category">.Net</a>, <a href="http://codebetter.com/iancooper/category/ddd/" title="View all posts in DDD" rel="category">DDD</a>, <a href="http://codebetter.com/iancooper/category/nhibernate/" title="View all posts in NHibernate" rel="category">NHibernate</a>, <a href="http://codebetter.com/iancooper/category/orm/" title="View all posts in ORM" rel="category">ORM</a></span></span>
				<span class="meta-sep"> | </span>
												<span class="comments-link"><a href="http://codebetter.com/iancooper/2011/04/12/repository-saveupdate-is-a-smell/#comments" title="Comment on Why Repository SaveUpdate is a smell"><span class="dsq-postid" rel="165 http://codebetter.com/iancooper/?p=165">5 Comments</span></a></span>
							</div><!-- #entry-utility -->
		</div><!-- #post-165 -->

		
						
			<div id="post-86" class="post-86 post type-post status-publish format-standard hentry category-net category-agile category-bdd category-behavior-specification category-mocks category-object-orientation category-stubs category-tdd">
			<h2 class="entry-title"><a href="http://codebetter.com/iancooper/2011/04/05/tell-dont-ask-mocks/" title="Permalink to Mocks and Tell Don&#8217;t Ask" rel="bookmark">Mocks and Tell Don&#8217;t Ask</a></h2>

			<div class="entry-meta">
				<span class="meta-prep meta-prep-author">Posted on </span><a href="http://codebetter.com/iancooper/2011/04/05/tell-dont-ask-mocks/" title="12:19 pm" rel="bookmark"><span class="entry-date">April 5, 2011</span></a> <span class="meta-sep"> by </span> <span class="author vcard"><a class="url fn n" href="http://codebetter.com/iancooper" title="View all posts by Ian Cooper">Ian Cooper</a></span>			</div><!-- .entry-meta -->

				<div class="entry-content">
				<!-- Start Shareaholic LikeButtonSetTop Automatic --><!-- End Shareaholic LikeButtonSetTop Automatic --><p>One of our alumni Karl blogged a request recently for folks to <a href="http://openmymind.net/2011/3/23/Stop-Using-Mocks">stop using mocks</a>. Once upon a time I also made clear that I had a <a href="http://codebetter.com/iancooper/2008/02/04/classicist-vs-mockist-test-driven-development/">significant distrust of mocks</a>. I&#8217;ve mellowed on that position over time, so I thought that I should explain why I have changed my opinion.</p>
<p>Perhaps it would be useful to give a summary of the discussion around this. Whilst I don&#8217;t think that you need to choose between being a classicist or mockist, I think that Martin Fowler&#8217;s article on <a href="http://martinfowler.com/articles/mocksArentStubs.html">Mocks Aren&#8217;t Stubs</a> is still a good starting point for understanding the debate, because it talks about the different types of <a href="http://xunitpatterns.com/Test%20Double.html">Test Double</a>, as well as outlining approaches to their usage. However, for my part, Martin does not highlight Meszaros&#8217;s key distinction between replacing <a href="http://xunitpatterns.com/indirect%20input.html">indirect inputs</a> and monitoring <a href="http://xunitpatterns.com/indirect%20output.html">indirect outputs</a>. Both mention the danger of <a href="http://xunitpatterns.com/Fragile%20Test.html#Overspecified%20Software">Over-specified Software</a> from Mocks, and Meszaros cautions to <a href="http://xunitpatterns.com/Principles%20of%20Test%20Automation.html#Use%20the%20Front%20Door%20First">Use the Front Door</a>. On the other side the proponents of mocks have always pointed to their admonition to<a href="http://citeseerx.ist.psu.edu/viewdoc/download?doi=10.1.1.100.2927&amp;rep=rep1&amp;type=pdf"> Mock Roles Not Objects </a>{PDF}. <a href="http://www.growing-object-oriented-software.com/">Growing Object Oriented Software, Guided by Tests</a> (GooS) is probably the best expression of their technique today.</p>
<p>The key to understanding mocks to me was that the motivation behind Mocks, revealed in GooS is to support the <a href="http://pragprog.com/articles/tell-dont-ask">Tell Don&#8217;t Ask</a> principle. Tim Mackinnon notes that:</p>
<blockquote><p>In particular, I had noticed a tendency to add “getter” methods to our  objects to facilitate testing. This felt wrong, since it could be seen  as violating object-oriented principles, so I was interested in the  thoughts of the other members. The conversation was quite lively—mainly  centering on the tension between pragmatism in testing and pure  object-oriented design.</p></blockquote>
<p>For me understanding this goal for mock objects was something of a revelation in how I understood them to be used. Previously I had heard arguments that centered around the concept of a unit test needing isolation being the driver for use of mocking frameworks, but now I can see them as tools helping us avoid asking the object about its internal state.</p>
<p>Within any test we tend to follow the same pattern: set up the pre-conditions for the test, exercise the test and then check post-conditions. It&#8217;s the latter step that causes the pain for developers working towards a Tell Don&#8217;t Ask principle &#8211; how do I confirm the post-conditions without asking objects for their state.</p>
<p>This is a concern because objects should encapsulate state and expose behavior (whereas data structures have state but no behavior). This helps avoid <a href="http://en.wikipedia.org/wiki/Code_smell">feature envy</a>, where an objects collaborator holds the behavior of that object, in a set of calls to discover its state instead of asking the object to carry out the behavior on the state itself. This leads to coupling and makes our software more rigid (difficult to change) and brittle (likely to break when we do change it).</p>
<p>But this leads to the question: how do we confirm the post-conditions if we have no getters?</p>
<p>Mocks come into play where we decide to confirm is the behavior of the class-under-test through its interaction with its collaborators, instead of through getters checking the state. This is the meaning of behavior-based testing over state-based testing, although you might want to think of it as message-based testing, because what you really care about is the messages that you send to your collaborators.</p>
<p>Now when we talk about confirming behavior, recognize that in a Tell Don&#8217;t Ask style the objects we are interested in confirming our interaction with are the indirect outputs of the class under test, not the indirect inputs (classes that we get state from). In an ideal world of course, we won&#8217;t have many indirect inputs (we want Tell Don&#8217;t Ask remember), but most people will tend to be realistic about how far they can take a Tell Don&#8217;t Ask approach. Those indirect inputs may continue to be fakes, stubs, or even instances of collaborators created with TestDataBuilders or ObjectMothers. Of course the presence of a lot of them in our test setup is a smell that we have not followed a Test Don&#8217;t Ask approach.</p>
<p>It is also likely that many of our concerns about over-specified software with mocks often come from the coupling caused by these indirect inputs over indirect outputs. They are likely to reveal most about the implementation of the their collaborator. By contrast where we tell an object to do something for us, we likely let it hide the implementation details from us. Of course we need to beware of feature envy from calling a lot of setters instead of simply calling a method on the collaborator. This chattiness is again a feature envy design smell.</p>
<p>I have come to see an over-specified test when using mocks is not a problem of using mocks themselves, but mocks surfacing the problem that the class-under-test is not telling collaborators to perform actions at a granular enough level, or is asking too many questions of collaborators.</p>
<p>Finally one question that often arises here is: if we are just handing off to other classes, how do we know that the state was eventually correct i.e. the algorithm calculated the right value, or we stored the correct information. One catch-all option is to use a visitor, and pass it in so that the class-under-test can populate it with the state that you need to observe. Other options include observers that listen for changes. Of course at some point you need to consume the data from the visitor or the event sent to the observer &#8211; but the trick here is to use a data structure where it is acceptable to expose state (but not to have behavior).</p>
<p><a href="http://cqrsinfo.com/">CQRS</a> also has huge payoffs for a Tell Don&#8217;t Ask approach. Because your write side rarely needs to &#8216;get&#8217; the state, you can defer the question of where we consume the data &#8211; the read side does it, in the simplest fashion of just creating data structures directly. Event Sourcing also has benefits here, because you can confirm the changes to the state made to the object by examining the events raised by the class under test instead of asking the object for its state.</p>
<div class="shr-publisher-86"></div><!-- Start Shareaholic LikeButtonSetBottom Automatic --><!-- End Shareaholic LikeButtonSetBottom Automatic -->							</div><!-- .entry-content -->
	
			<div class="entry-utility">
				<span class="cat-links"><span class="entry-utility-prep entry-utility-prep-cat-links">Posted in <a href="http://codebetter.com/iancooper/category/net/" title="View all posts in .Net" rel="category">.Net</a>, <a href="http://codebetter.com/iancooper/category/agile/" title="View all posts in Agile" rel="category">Agile</a>, <a href="http://codebetter.com/iancooper/category/bdd/" title="View all posts in BDD" rel="category">BDD</a>, <a href="http://codebetter.com/iancooper/category/behavior-specification/" title="View all posts in Behavior Specification" rel="category">Behavior Specification</a>, <a href="http://codebetter.com/iancooper/category/mocks/" title="View all posts in Mocks" rel="category">Mocks</a>, <a href="http://codebetter.com/iancooper/category/object-orientation/" title="View all posts in Object-Orientation" rel="category">Object-Orientation</a>, <a href="http://codebetter.com/iancooper/category/stubs/" title="View all posts in Stubs" rel="category">Stubs</a>, <a href="http://codebetter.com/iancooper/category/tdd/" title="View all posts in TDD" rel="category">TDD</a></span></span>
				<span class="meta-sep"> | </span>
												<span class="comments-link"><a href="http://codebetter.com/iancooper/2011/04/05/tell-dont-ask-mocks/#comments" title="Comment on Mocks and Tell Don&#8217;t Ask"><span class="dsq-postid" rel="86 /blogs/ian_cooper/archive/2010/11/16/tell-don-t-ask-mocks-and-event-sourcing-oh-my.aspx">5 Comments</span></a></span>
							</div><!-- #entry-utility -->
		</div><!-- #post-86 -->

		
			
	<div id="nav-below" class="navigation">
		<div class="nav-next"><a href="?page=1" > Next Page &raquo;</a></div>
		
	</div><!-- #nav-below -->
		</div><!-- #main -->
		<div id="sidebar" class="grid_4">
					<div id="primary" class="widget-area">
			<ul class="xoxo">
				<div class="ad-container">
<script type='text/javascript'><!--// <![CDATA[
    OA_show(29416);
// ]]> --></script><noscript><a target='_blank' href='http://d1.openx.org/ck.php?n=2782afb'><img border='0' alt='' src='http://d1.openx.org/avw.php?zoneid=29416&amp;n=2782afb' /></a></noscript><script type='text/javascript'><!--// <![CDATA[
    OA_show(29417);
// ]]> --></script><noscript><a target='_blank' href='http://d1.openx.org/ck.php?n=e94cea6'><img border='0' alt='' src='http://d1.openx.org/avw.php?zoneid=29417&amp;n=e94cea6' /></a></noscript><script type='text/javascript'><!--// <![CDATA[
    OA_show(29418);
// ]]> --></script><noscript><a target='_blank' href='http://d1.openx.org/ck.php?n=9ba3022'><img border='0' alt='' src='http://d1.openx.org/avw.php?zoneid=29418&amp;n=9ba3022' /></a></noscript><script type='text/javascript'><!--// <![CDATA[
    OA_show(29419);
// ]]> --></script><noscript><a target='_blank' href='http://d1.openx.org/ck.php?n=f467b52'><img border='0' alt='' src='http://d1.openx.org/avw.php?zoneid=29419&amp;n=f467b52' /></a></noscript>
				</div>
			
				<li id="user_bio-2" class="widget-container widget_user_bio"><h3 class="widget-title"></h3>One of these days I will add something to my user profile! For now, I shall remain mysterious.
</li>		
						
			</ul>
			
		</div><!-- #primary .widget-area -->
		
		<div id="secondary" class="widget-area">
				
<script type='text/javascript'><!--// <![CDATA[
    OA_show(220407);
// ]]> --></script><noscript><a target='_blank' href='http://d1.openx.org/ck.php?n=68b8307'><img border='0' alt='' src='http://d1.openx.org/avw.php?zoneid=220407&amp;n=68b8307' /></a></noscript>				
				
				<ul class="xoxo">		
									</ul>	
				
<script type='text/javascript'><!--// <![CDATA[
    OA_show(29421);
// ]]> --></script><noscript><a target='_blank' href='http://d1.openx.org/ck.php?n=3f8e353'><img border='0' alt='' src='http://d1.openx.org/avw.php?zoneid=29421&amp;n=3f8e353' /></a></noscript>
				
		</div><!-- #secondary .widget-area -->		</div><!--sidebar-->
	</div><!-- #content -->	
</div><!-- end div tabs see header.php -->
	
	<div id="footer">
		<div class="container_12">
		<div id="footer-widget-area">
				<div class="grid_4">					
					<ul>
					<li><a href="http://codebetter.com" title="home">Home</a></li>
					<li class="page_item page-item-2"><a href="http://codebetter.com/about/">About</a></li>
<li class="page_item page-item-8"><a href="http://codebetter.com/codebetter-ci/">CodeBetter CI</a></li>
<li class="page_item page-item-6"><a href="http://codebetter.com/community/">Community</a></li>
<li class="page_item page-item-10"><a href="http://codebetter.com/editors/">Editors</a></li>
<li class="page_item page-item-41"><a href="http://codebetter.com/globalsearch/">Search Results</a></li>
					<li><a href="http://feeds.feedburner.com/CodeBetter" rel="alternate" type="application/rss+xml"><img src="http://www.feedburner.com/fb/images/pub/feed-icon16x16.png" alt="" style="vertical-align:middle;border:0"/></a><a href="http://feeds.feedburner.com/CodeBetter"><img src="http://feeds.feedburner.com/~fc/CodeBetter?bg=FFFFFF&amp;fg=2E9BD2&amp;anim=1" height="26" width="88" style="vertical-align:middle;border:0"/></a></li>
					</ul>
				</div><!-- #second .widget-area -->
				<div class="grid_4">
					
					<h3>Friends of CodeBetter.Com</h3>
<ul>

<li><a href="http://red-gate.com/">Red-Gate Tools For SQL and .NET</a></li>
<li><a href="http://telerik.com">Telerik .NET Tools</a></li>
<li><a href="http://jetbrains.com/resharper/">JetBrains - ReSharper</a></li>
<li><a href="http://scootersoftware.com">Beyond Compare</a></li>
<li><a href="http://www.ndepend.com/">NDepend</a></li>
<li><a href="http://www.sapphiresteel.com/">Ruby In Steel</a></li>
<li><a href="http://www.slickedit.com/">SlickEdit</a></li>
<li><a href="http://www.gurock.com/products/smartinspect/">SmartInspect .NET Logging</a></li>
<li>NGEDIT: <a href="http://www.viemu.com/">ViEmu</a> and <a href="http://www.codekana.com/">Codekana</a> </li>
<li><a href="http://www.devexpress.com/" target="_blank">DevExpress</a></li>
<li><a href="http://nhprof.com" target="_blank">NHibernate Profiler</a></li>
<li><a href="http://unfuddle.com" target="_blank">Unfuddle</a></li>
<li><a href="http://www.balsamiq.com/products/mockups" target="_blank">Balsamiq Mockups</a></li>
<li><a href="http://scrumy.com" target="_blank">Scrumy</a></li>
<li><a href="http://umbraco.com" target="_blank">Umbraco</a></li>
<li><a href="http://nservicebus.com" target="_blank">NServiceBus</a></li>
<li><a href="http://ravendb.net" target="_blank">RavenDb</a></li>
<li><a href="http://www.websequencediagrams.com/" target="_blank">Web Sequence Diagrams</a></li>
	</ul>				
				</div><!-- #third .widget-area -->
				<div class="grid_4">
					CodeBetter.Com &copy; '12<br />
						Stuff you need to Code Better!<br />
				Proudly powered by <span id="generator-link"><a href="http://wordpress.org/" title="Semantic Personal Publishing Platform" rel="generator">WordPress</a></span>.					
				</div><!-- #fourth .widget-area -->
			</div><!-- #footer-widget-area -->		
		
			</div><!-- end div.container_12 -->

	</div><!-- end div#footer -->
		
<script type="text/javascript">

  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-531207-1']);
  _gaq.push(['_trackPageview']);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();

</script>
<script type='text/javascript' src='http://cdn1.codebetter.com/wp-content/plugins/syntaxhighlighter/syntaxhighlighter3/scripts/shCore.js?ver=3.0.83b'></script>
<script type='text/javascript' src='http://cdn1.codebetter.com/wp-content/plugins/syntaxhighlighter/syntaxhighlighter3/scripts/shBrushCSharp.js?ver=3.0.83b'></script>
<script type='text/javascript' src='http://cdn1.codebetter.com/wp-content/plugins/syntaxhighlighter/syntaxhighlighter3/scripts/shBrushRuby.js?ver=3.0.83b'></script>
<script type='text/javascript' src='http://cdn1.codebetter.com/wp-content/plugins/syntaxhighlighter/syntaxhighlighter3/scripts/shBrushJScript.js?ver=3.0.83b'></script>
<script type='text/javascript' src='http://cdn1.codebetter.com/wp-content/plugins/syntaxhighlighter/syntaxhighlighter3/scripts/shBrushXml.js?ver=3.0.83b'></script>
<script type='text/javascript' src='http://cdn1.codebetter.com/wp-content/plugins/syntaxhighlighter/syntaxhighlighter3/scripts/shBrushPython.js?ver=3.0.83b'></script>
<script type='text/javascript' src='http://cdn1.codebetter.com/wp-content/plugins/syntaxhighlighter/third-party-brushes/shBrushFSharp.js?ver=3.0.83b'></script>
<script type='text/javascript'>
	(function(){
		var corecss = document.createElement('link');
		var themecss = document.createElement('link');
		var corecssurl = "http://cdn1.codebetter.com/wp-content/plugins/syntaxhighlighter/syntaxhighlighter3/styles/shCore.css?ver=3.0.83b";
		if ( corecss.setAttribute ) {
				corecss.setAttribute( "rel", "stylesheet" );
				corecss.setAttribute( "type", "text/css" );
				corecss.setAttribute( "href", corecssurl );
		} else {
				corecss.rel = "stylesheet";
				corecss.href = corecssurl;
		}
		document.getElementsByTagName("head")[0].insertBefore( corecss, document.getElementById("syntaxhighlighteranchor") );
		var themecssurl = "http://cdn1.codebetter.com/wp-content/plugins/syntaxhighlighter/syntaxhighlighter3/styles/shThemeDefault.css?ver=3.0.83b";
		if ( themecss.setAttribute ) {
				themecss.setAttribute( "rel", "stylesheet" );
				themecss.setAttribute( "type", "text/css" );
				themecss.setAttribute( "href", themecssurl );
		} else {
				themecss.rel = "stylesheet";
				themecss.href = themecssurl;
		}
		//document.getElementById("syntaxhighlighteranchor").appendChild(themecss);
		document.getElementsByTagName("head")[0].insertBefore( themecss, document.getElementById("syntaxhighlighteranchor") );
	})();
	SyntaxHighlighter.config.strings.expandSource = '+ expand source';
	SyntaxHighlighter.config.strings.help = '?';
	SyntaxHighlighter.config.strings.alert = 'SyntaxHighlighter\n\n';
	SyntaxHighlighter.config.strings.noBrush = 'Can\'t find brush for: ';
	SyntaxHighlighter.config.strings.brushNotHtmlScript = 'Brush wasn\'t configured for html-script option: ';
	SyntaxHighlighter.defaults['gutter'] = false;
    SyntaxHighlighter.defaults['tab-size'] = 2;
    SyntaxHighlighter.defaults['toolbar'] = false;
    SyntaxHighlighter.defaults['wrap-lines'] = true; 
	SyntaxHighlighter.defaults['pad-line-numbers'] = false;
	SyntaxHighlighter.all();
</script>

<script type='text/javascript'>//<![CDATA[
    if (typeof jQuery == 'undefined') {
        document.write(unescape("%3Cscript src='http://ajax.aspnetcdn.com/ajax/jQuery/jquery-1.4.2.min.js' type='text/javascript' %3E%3C/script%3E"));
    }//]]></script>
<script type='text/javascript' language='Javascript' src='http://s1.lqcdn.com/m.min.js?dt=2.3.110202.1'></script>
<script type='text/javascript' language='Javascript'> if(jQuery.LqmAds)jQuery.LqmAds();</script>
 
</body>
</html>
<!-- Dynamic page generated in 0.783 seconds. -->
<!-- Cached page generated by WP-Super-Cache on 2012-11-09 18:42:21 -->
<!-- super cache -->