<!DOCTYPE html>
<html dir="ltr" lang="en-US">
<head>
	<meta charset="UTF-8" />
    <title>Create a SQL Server View of your AD Users | Brendan Tompkins</title>
	<link rel="profile" href="http://gmpg.org/xfn/11" />
	
	<link href="http://feeds.feedburner.com/CodeBetter" title="CodeBetter.Com &raquo; Feed" type="application/rss+xml" rel="alternate">
	
		<link rel="pingback" href="http://codebetter.com/brendantompkins/xmlrpc.php" />
	                <link rel="stylesheet" href="http://codebetter.com/brendantompkins/wp-content/uploads/spacker-cache/ea73517eb74a545f51c376487c94dc9f.css" type="text/css" media="all" /><!-- Is Cache! -->
                <script type='text/javascript' src='http://codebetter.com/brendantompkins/wp-includes/js/l10n.js?ver=20101110'></script>
<link rel="EditURI" type="application/rsd+xml" title="RSD" href="http://codebetter.com/brendantompkins/xmlrpc.php?rsd" />
<link rel="wlwmanifest" type="application/wlwmanifest+xml" href="http://codebetter.com/brendantompkins/wp-includes/wlwmanifest.xml" /> 
<link rel='index' title='Brendan Tompkins' href='http://codebetter.com/brendantompkins/' />
<link rel='start' title='Tap. Tap.  Is this thing on?' href='http://codebetter.com/brendantompkins/2003/10/08/tap-tap-is-this-thing-on/' />
<link rel='prev' title='From Active Directory to SQL Relational Data' href='http://codebetter.com/brendantompkins/2003/12/19/from-active-directory-to-sql-relational-data/' />
<link rel='next' title='Use GDI+ to Save Crystal-Clear GIF Images with .NET' href='http://codebetter.com/brendantompkins/2004/01/26/use-gdi-to-save-crystal-clear-gif-images-with-net/' />
<meta name="generator" content="WordPress 3.1-beta1-16732" />
<link rel='canonical' href='http://codebetter.com/brendantompkins/2003/12/19/create-a-sql-server-view-of-your-ad-users/' />
<link rel='shortlink' href='http://codebetter.com/brendantompkins/?p=35' />
<link rel="stylesheet" href="http://codebetter.com/brendantompkins/wp-content/plugins/digg-digg/include/../css/diggdigg-style.css?ver=4.5.0.7" type="text/css" media="screen" /><link rel="stylesheet" href="http://disqus.com/stylesheets/brendantompkins/disqus.css?v=2.0" type="text/css" media="screen" /><meta id="syntaxhighlighteranchor" name="syntaxhighlighter-version" content="3.1.1" />
                <script type="text/javascript" src="http://codebetter.com/brendantompkins/wp-content/uploads/spacker-cache/a8046d2f1fc1c08af413701218a11c1d.js">/*Is Cache!*/</script>
                	<style type="text/css">body { padding-top:0px !important; } html { margin-top: 0px !important; }</style>

</head>

<body>

			
		<div class="container_12 ui-tabs ui-widget ui-widget-content ui-corner-all" id="tabs">			
			<ul class="ui-tabs-nav ui-helper-reset ui-helper-clearfix ui-widget-header ui-corner-all">
				<li class="ui-state-default ui-corner-top ui-tabs-selected ui-state-active"><a href="#ui-tabs-1">CodeBetter.Com</a></li>
				<li class="ui-state-default ui-corner-top"><a href="http://devlicio.us">Devlicio.Us</a></li>				
				<div id="top-search">
				<form action="http://codebetter.com/globalsearch/" id="cse-search-box">
  <div>
   <fieldset id="search">
		<input type="hidden" name="cx" value="005178204031477491434:2bg5jtwgsfe" />
		<input type="hidden" name="cof" value="FORID:9" />
		<input type="hidden" name="ie" value="UTF-8" />
		<input type="text"  class="text-input" id="s" name="q" size="31" />
		<input type="image" src="/wp-content/themes/codebetter/images/search-img.png" class="form-button" id="searchsubmit" value="GO" name="">				   	
	</fieldset>
  </div>
</form>
<script type="text/javascript" src="http://www.google.com/cse/brand?form=cse-search-box&lang=en&sitesearch=true"></script>
				</div>				
			</ul><div id="ui-tabs-1" class="ui-tabs-panel ui-widget-content ui-corner-bottom"></div><div id="ui-tabs-2" class="ui-tabs-panel ui-widget-content ui-corner-bottom ui-tabs-hide"></div>
		</div>
			
		<div id="main" class="container_12">
		
			<div id="logo" class="grid_3"><a href="/" title="CodeBetter.Com - Stuff you need to Code Better!"><image src="/wp-content/themes/codebetter/images/codebetter_logo.png" height="48" width="223"></image></a></div>
			<div id="ad_leaderboard" class="grid_9">			</div>
			
			<div id="globalNav" class="grid_12">
				<ul>
					<li><a href="http://codebetter.com" title="home">Home</a></li>
					<li class="page_item page-item-2"><a href="http://codebetter.com/about/" title="About">About</a></li>
<li class="page_item page-item-8"><a href="http://codebetter.com/codebetter-ci/" title="CodeBetter CI">CodeBetter CI</a></li>
<li class="page_item page-item-6"><a href="http://codebetter.com/community/" title="Community">Community</a></li>
<li class="page_item page-item-10"><a href="http://codebetter.com/editors/" title="Editors">Editors</a></li>
					<li><a href="http://feeds.feedburner.com/CodeBetter" rel="alternate" type="application/rss+xml"><img src="http://www.feedburner.com/fb/images/pub/feed-icon16x16.png" alt="" style="vertical-align:middle;border:0"/></a><a href="http://feeds.feedburner.com/CodeBetter"><img src="http://feeds.feedburner.com/~fc/CodeBetter?bg=EFEFEF&amp;fg=2E9BD2&amp;anim=1" height="26" width="88" style="vertical-align:middle;border:0"/></a></li>
				</ul>
								
			</div><!-- end div#globalNav.container_12 -->				
	
		<div id="content" class="container_12">
			<div id="main" class="grid_8">


				<div id="post-35" class="post-35 post type-post status-publish format-standard hentry category-sql">
					<h1 class="entry-title">Create a SQL Server View of your AD Users</h1>

					<div class="entry-meta">
						<span class="meta-prep meta-prep-author">Posted by </span>
						<span class="author vcard"><a class="url fn n" href="http://codebetter.com/brendantompkins/author/btompkins/" title="View all posts by Brendan Tompkins">Brendan Tompkins</a></span>
						<span class="meta-sep"> on  </span>
						<a href="http://codebetter.com/brendantompkins/2003/12/19/create-a-sql-server-view-of-your-ad-users/" title="6:43 pm" rel="bookmark"><span class="entry-date">December 19, 2003</span></a>
											</div><!-- .entry-meta -->

					<div class="entry-content">
						<div id="greet_block"><noscript><div class="greet_block wpgb_cornered"><div class="greet_text"><div class="greet_image"><a href="http://codebetter.com/brendantompkins/feed/rss/"  rel="nofollow"><img src="http://codebetter.com/brendantompkins/wp-content/plugins/wp-greet-box/images/rss_icon.png" alt="WP Greet Box icon"/></a></div>Hello there! If you are new here, you might want to <a href="http://codebetter.com/brendantompkins/feed/rss/" rel="nofollow"><strong>subscribe to the RSS feed</strong></a> for updates on this topic.<div style="clear:both"></div><div class="greet_block_powered_by">Powered by <a href="http://omninoggin.com/projects/wordpress-plugins/wp-greet-box-wordpress-plugin/" title="WP Greet Box WordPress Plugin" style="text-decoration:none;">WP Greet Box</a> <a href="http://omninoggin.com/" title="WordPress Plugin" style="text-decoration:none;">WordPress Plugin</a></div><div style="clear:both"></div></div></div></noscript></div><p><P><A href="http://dotnetjunkies.com/weblog/bsblog/posts/4701.aspx">I posted about this earlier today</A>, and the solution was so simple and straight-forward that I&#8217;m posting the solution in a separate post.&nbsp; So, to create a view in SQL Server of your AD users, simply do this:</P><br />
<P><STRONG>Step 1: Create a linked server to your Active Directory</STRONG> </P><br />
<P><FONT face="Courier New" size="2">sp_addlinkedserver &#8216;ADSI&#8217;, &#8216;Active Directory Service Interfaces&#8217;, &#8216;ADSDSOObject&#8217;, &#8216;adsdatasource&#8217;</FONT></P><br />
<P><STRONG>Step 2: Create a view in SQL server using OPENQUERY to select from Active Directory</STRONG></P><br />
<P><FONT face="Courier New" size="2">CREATE&nbsp; VIEW dbo.vw_AD_USER_INFO<BR>AS </FONT></P><br />
<P><FONT face="Courier New" size="2">SELECT * FROM OpenQuery(ADSI, &#8216;SELECT title, displayName, sAMAccountName, givenName, telephoneNumber, facsimileTelephoneNumber, sn FROM &#8221;LDAP://DC=whaever,DC=domain,DC=org&#8221; where objectClass = &#8221;User&#8221;&#8217;)</FONT></P><br />
<P><FONT face="Courier New" size="2">GO</FONT></P><br />
<P>Now, this might not exactly&nbsp;work for you if your AD Schema is different than ours, etc, but for me it worked like a charm, and the general concept should apply to your LDAP server.</P><br />
<P>-Brendan</P></p>
											</div><!-- .entry-content -->

					<div id="entry-author-info">
						<div id="author-avatar">
							<img alt='' src='http://0.gravatar.com/avatar/c1de0fbc0dbc3fd24b285009c123d9b0?s=60&amp;d=http%3A%2F%2F0.gravatar.com%2Favatar%2Fad516503a11cd5ca435acc9bb6523536%3Fs%3D60&amp;r=G' class='avatar avatar-60 photo' height='60' width='60' />						</div><!-- #author-avatar 	-->
						<div id="author-description">
							<h2>About Brendan Tompkins</h2>
							By day, I'm a .NET developer working in the transportation and logistics industry... By night I'm a fabulous disco dancer.							<div id="author-link">
								<a href="http://codebetter.com/brendantompkins/author/btompkins/" title="View all posts by Brendan Tompkins">View all posts by Brendan Tompkins &rarr;</a>
							</div><!-- #author-link	-->
						</div><!-- #author-description	-->
					</div><!-- .entry-author-info -->

					<div class="entry-utility">
					This entry was posted in <a href="http://codebetter.com/brendantompkins/category/sql/" title="View all posts in SQL" rel="category tag">SQL</a>. Bookmark the <a href="http://codebetter.com/brendantompkins/2003/12/19/create-a-sql-server-view-of-your-ad-users/" title="Permalink to Create a SQL Server View of your AD Users" rel="bookmark">permalink</a>. Follow any comments here with the <a href="http://codebetter.com/brendantompkins/2003/12/19/create-a-sql-server-view-of-your-ad-users/feed/" title="Comments RSS to Create a SQL Server View of your AD Users" rel="alternate" type="application/rss+xml">RSS feed for this post</a>.
					</div><!-- .entry-utility -->
				</div><!-- #post-35 -->

				<div id="nav-below" class="navigation">
					<div class="nav-previous"><a href="http://codebetter.com/brendantompkins/2003/12/19/from-active-directory-to-sql-relational-data/" rel="prev"><span class="meta-nav">&larr;</span> From Active Directory to SQL Relational Data</a></div>
					<div class="nav-next"><a href="http://codebetter.com/brendantompkins/2004/01/26/use-gdi-to-save-crystal-clear-gif-images-with-net/" rel="next">Use GDI+ to Save Crystal-Clear GIF Images with .NET <span class="meta-nav">&rarr;</span></a></div>
				</div><!-- #nav-below -->

				
<div id="disqus_thread">
					<div id="dsq-content">
			<ul id="dsq-comments">
					<li id="dsq-comment-143">
					<div id="dsq-comment-header-143" class="dsq-comment-header">
						<cite id="dsq-cite-143">
								<span id="dsq-author-user-143">catcat</span>
							</cite>
					</div>
					<div id="dsq-comment-body-143" class="dsq-comment-body">
						<div id="dsq-comment-message-143" class="dsq-comment-message"><p>In Step 1:<br />
<br />I got the follow error:</p>
<p>??? OLE DB ???? &#8216;ADSDSOObject&#8217; ????????<br />
<br />OLE DB ????[OLE/DB Provider 'ADSDSOObject' ICommandPrepare::Prepare returned 0x80040e14]?<br /></p>
</div>
					</div>
				</li>
					<li id="dsq-comment-144">
					<div id="dsq-comment-header-144" class="dsq-comment-header">
						<cite id="dsq-cite-144">
								<span id="dsq-author-user-144">Brendan Tompkins</span>
							</cite>
					</div>
					<div id="dsq-comment-body-144" class="dsq-comment-body">
						<div id="dsq-comment-message-144" class="dsq-comment-message"><p>See<br />
<br /><a target="_new" href="http://support.microsoft.com/default.aspx?scid=kb;en-us;Q299410">http://support.microsoft.com/default.aspx?scid=kb;en-us;Q299410</a> for more<br />
<br />detailed information on how to perform a SQL distributed query by using<br />
<br />ADSI.<br /></p>
</div>
					</div>
				</li>
					<li id="dsq-comment-145">
					<div id="dsq-comment-header-145" class="dsq-comment-header">
						<cite id="dsq-cite-145">
								<span id="dsq-author-user-145">Anders J&#228;gard</span>
							</cite>
					</div>
					<div id="dsq-comment-body-145" class="dsq-comment-body">
						<div id="dsq-comment-message-145" class="dsq-comment-message"><p>How do you get this to work if you want to have different aspaths. Lets say you have an application where you can walk around in the &quot;AD hierarki&quot; and you choose to output a report&#8230;</p>
</div>
					</div>
				</li>
					<li id="dsq-comment-146">
					<div id="dsq-comment-header-146" class="dsq-comment-header">
						<cite id="dsq-cite-146">
								<span id="dsq-author-user-146">Brendan Tompkins</span>
							</cite>
					</div>
					<div id="dsq-comment-body-146" class="dsq-comment-body">
						<div id="dsq-comment-message-146" class="dsq-comment-message"><p>Anders,</p>
<p>This can get tricky.  Usually you will be able to add the OU= tag with the specific OU that you are interested in, i.e. </p>
<p>&#8221;LDAP://DC=whaever,DC=domain,DC=org,OU=webusers&#8221;</p>
<p>But, I&#8217;ve had difficulties getting this to work properly. Honestly, navigating LDAP is pretty difficult stuff, and requires a lot of trial and error. Good luck!</p>
</div>
					</div>
				</li>
					<li id="dsq-comment-147">
					<div id="dsq-comment-header-147" class="dsq-comment-header">
						<cite id="dsq-cite-147">
								<span id="dsq-author-user-147">Brendan Tompkins</span>
							</cite>
					</div>
					<div id="dsq-comment-body-147" class="dsq-comment-body">
						<div id="dsq-comment-message-147" class="dsq-comment-message"><p>Anders,</p>
<p>You could also of course, provide a stored proc that takes the LDAP connection string as a paramater, and return the query result.  Not as good for doing joins with other tables, but still will get you the data you need.<br /></p>
</div>
					</div>
				</li>
					<li id="dsq-comment-148">
					<div id="dsq-comment-header-148" class="dsq-comment-header">
						<cite id="dsq-cite-148">
								<span id="dsq-author-user-148">Anders J&#228;gard</span>
							</cite>
					</div>
					<div id="dsq-comment-body-148" class="dsq-comment-body">
						<div id="dsq-comment-message-148" class="dsq-comment-message"><p>Thank you Brendan!<br />
<br />I was kind of thinking that way but havent used stored procedures. I will have to try to write one and test. Thanks again for your quick answer.</p>
</div>
					</div>
				</li>
					<li id="dsq-comment-149">
					<div id="dsq-comment-header-149" class="dsq-comment-header">
						<cite id="dsq-cite-149">
								<span id="dsq-author-user-149">Anders</span>
							</cite>
					</div>
					<div id="dsq-comment-body-149" class="dsq-comment-body">
						<div id="dsq-comment-message-149" class="dsq-comment-message"><p>Brendan! You dont have any Example-SP that concats the (Input Parameter) LDAP string into the openquery statement &#8211; im having some trouble here&#8230; /Anders</p>
</div>
					</div>
				</li>
					<li id="dsq-comment-150">
					<div id="dsq-comment-header-150" class="dsq-comment-header">
						<cite id="dsq-cite-150">
								<span id="dsq-author-user-150">Anders J&#228;gard</span>
							</cite>
					</div>
					<div id="dsq-comment-body-150" class="dsq-comment-body">
						<div id="dsq-comment-message-150" class="dsq-comment-message"><p>Ive now done one working Stored Procedure but without any DB Table join&#8230;I cant join it &#8211; how do I do? Heres the procedure:</p>
<p>CREATE PROCEDURE [dbo].[FTADQuery] AS<br />
<br />SET QUOTED_IDENTIFIER OFF<br />
<br />GO<br />
<br />SET ANSI_NULLS ON<br />
<br />GO<br />
<br />ALTER  PROCEDURE FTADQuery @Ldap nvarchar(500),<br />
<br />         @ObjectCategory nvarchar(10),<br />
<br />         @ObjectClass nvarchar(10),<br />
<br />         @Attribute nvarchar(500),<br />
<br />         @Scoope nvarchar(10)<br />
<br />AS</p>
<p>DECLARE @strSQL1 nvarchar(2000)  </p>
<p>SELECT @strSQL1 = &#8216;SELECT * FROM OpenQuery(ADSI,  &#8216; + CHAR(39) + &#8216;&lt;&#8217; + @Ldap + &#8216;&gt;;(&amp;(objectCategory=&#8217; + @ObjectCategory +&#8217;)(objectClass=&#8217; + @ObjectClass + &#8216;));&#8217; + @Attribute + &#8216;;&#8217; + @Scoope + CHAR(39) + &#8216;)&#8217;</p>
<p>EXEC (@strSQL1)</p>
<p>GO<br />
<br />SET QUOTED_IDENTIFIER OFF<br />
<br />GO<br />
<br />SET ANSI_NULLS ON<br />
<br />GO</p>
</div>
					</div>
				</li>
					<li id="dsq-comment-151">
					<div id="dsq-comment-header-151" class="dsq-comment-header">
						<cite id="dsq-cite-151">
								<span id="dsq-author-user-151">Brendan Tompkins</span>
							</cite>
					</div>
					<div id="dsq-comment-body-151" class="dsq-comment-body">
						<div id="dsq-comment-message-151" class="dsq-comment-message"><p>Anders, since you&#8217;re using Dynamic SQL, you can do this two ways, as far as I&#8217;m aware.  </p>
<p>1) Select into a #TEMP table, and do your join that way.  </p>
<p>2) Add your join to your original Dynamic SQL like this. Assuming your SQL table is called USERS, and the AD Login is USERS.AD_LOGIN</p>
<p>SELECT @strSQL1 = &#8216;SELECT ADResults.*, USERS.* FROM OpenQuery(ADSI, &#8216; + CHAR(39) + &#8216;&lt;&#8217; + @Ldap + &#8216;&gt;;(&amp;(objectCategory=&#8217; + @ObjectCategory +&#8217;)(objectClass=&#8217; + @ObjectClass + &#8216;));&#8217; + @Attribute + &#8216;;&#8217; + @Scoope + CHAR(39) + &#8216;) ADResults LEFT OUTER JOIN                    USERS ON ADResults.sAMAccountName COLLATE SQL_Latin1_General_CP1_CI_AS = USERS.AD_LOGIN&#8217;</p>
</div>
					</div>
				</li>
					<li id="dsq-comment-152">
					<div id="dsq-comment-header-152" class="dsq-comment-header">
						<cite id="dsq-cite-152">
								<span id="dsq-author-user-152">Anders</span>
							</cite>
					</div>
					<div id="dsq-comment-body-152" class="dsq-comment-body">
						<div id="dsq-comment-message-152" class="dsq-comment-message"><p>Brendan &#8211; thanks alot for your help!</p>
</div>
					</div>
				</li>
					<li id="dsq-comment-153">
					<div id="dsq-comment-header-153" class="dsq-comment-header">
						<cite id="dsq-cite-153">
								<span id="dsq-author-user-153">Neil Evans</span>
							</cite>
					</div>
					<div id="dsq-comment-body-153" class="dsq-comment-body">
						<div id="dsq-comment-message-153" class="dsq-comment-message"><p>Getting the following error when attempting to run a query against AD</p>
<p>An error occurred while preparing a query for execution against OLE DB provider &#8216;ADSDSOObject&#8217;.<br />
<br />OLE DB error trace [OLE/DB Provider 'ADSDSOObject' ICommandPrepare::Prepare returned 0x80040e14].</p>
<p>Believe it is to do with (&#8216;) apostrophe&#8217;s  However every resource I look at including yours uses them in construcint strings as you would in SQL Server, any thoughts would be much appreciated.</p>
</div>
					</div>
				</li>
					<li id="dsq-comment-154">
					<div id="dsq-comment-header-154" class="dsq-comment-header">
						<cite id="dsq-cite-154">
								<span id="dsq-author-user-154">Cameron Beatley</span>
							</cite>
					</div>
					<div id="dsq-comment-body-154" class="dsq-comment-body">
						<div id="dsq-comment-message-154" class="dsq-comment-message"><p>Same problem here. I&#8217;ve tried evry which way and I still get </p>
<p>Server: Msg 7321, Level 16, State 2, Line 1<br />
<br />An error occurred while preparing a query for execution against OLE DB provider &#8216;ADSDSOObject&#8217;.<br />
<br />OLE DB error trace [OLE/DB Provider 'ADSDSOObject' ICommandPrepare::Prepare returned 0x80040e14].<br /></p>
</div>
					</div>
				</li>
					<li id="dsq-comment-155">
					<div id="dsq-comment-header-155" class="dsq-comment-header">
						<cite id="dsq-cite-155">
								<span id="dsq-author-user-155">Anders</span>
							</cite>
					</div>
					<div id="dsq-comment-body-155" class="dsq-comment-body">
						<div id="dsq-comment-message-155" class="dsq-comment-message"><p>I also get this error. Any idea what to do??</p>
</div>
					</div>
				</li>
					<li id="dsq-comment-156">
					<div id="dsq-comment-header-156" class="dsq-comment-header">
						<cite id="dsq-cite-156">
								<span id="dsq-author-user-156">Brendan Tompkins</span>
							</cite>
					</div>
					<div id="dsq-comment-body-156" class="dsq-comment-body">
						<div id="dsq-comment-message-156" class="dsq-comment-message"><p>Anders, Cameron, this is a bit out of my range of understanding of the ADSDSOObject.   I did find this post here, which may help:</p>
<p><a target="_new" href="http://www.dbforums.com/archive/index.php/t-958399.html">http://www.dbforums.com/archive/index.php/t-958399.html</a></p>
<p>Also If you&#8217;re using exec, print out the sql query by replacing the EXEC (@strSQL1) with PRINT @strSQL1</p>
<p>Then copy what is printed out and run it directly in SQL Query Analyzer.  If you have syntax errors in Query Analyzer, you can ususally work them out easier and then make your changes to your stored proc later. This seems to work well for me when I&#8217;m having trouble with dynamic SQL.. Sorry if this is old hat for you&#8230;</p>
</div>
					</div>
				</li>
					<li id="dsq-comment-157">
					<div id="dsq-comment-header-157" class="dsq-comment-header">
						<cite id="dsq-cite-157">
								<span id="dsq-author-user-157">Jahyen</span>
							</cite>
					</div>
					<div id="dsq-comment-body-157" class="dsq-comment-body">
						<div id="dsq-comment-message-157" class="dsq-comment-message"><p>If you&#8217;re sure that the syntax is correct, it may be a delegation problem if the active directory is Windows 2000+ only.</p>
<p>Try the same command from the console of the SQL server or using remote desktop to log onto the SQL server.</p>
</div>
					</div>
				</li>
					<li id="dsq-comment-158">
					<div id="dsq-comment-header-158" class="dsq-comment-header">
						<cite id="dsq-cite-158">
								<span id="dsq-author-user-158">Steve Minns</span>
							</cite>
					</div>
					<div id="dsq-comment-body-158" class="dsq-comment-body">
						<div id="dsq-comment-message-158" class="dsq-comment-message"><p>Hi Guys, can I join the party?<br />
<br />I have a SQL Server 2000 sitting on a W2000 Domain but the SQL box it not an AD Server.  When I run the code above I get an error while preparing a query for execution against OLE DB &#8216;ADSDSObject&#8217;.<br />
<br />Can someone tell me what I need to put into whaever, domain and org?</p>
</div>
					</div>
				</li>
					<li id="dsq-comment-159">
					<div id="dsq-comment-header-159" class="dsq-comment-header">
						<cite id="dsq-cite-159">
								<span id="dsq-author-user-159">fouber</span>
							</cite>
					</div>
					<div id="dsq-comment-body-159" class="dsq-comment-body">
						<div id="dsq-comment-message-159" class="dsq-comment-message"><p>Anders,<br />
<br />I messed around with trying to pass variables to the LDAP query within SQL, as I believe you were trying to do. I found if was possible if you nested the apostrophes just right.  For example, if you have a variable called @adspath which contains a proper LDAP path you can pass it to the inner SQL query thus:</p>
<p>set @adsiquery=&#8217;(SELECT adspath from openquery<br />
<br />(ADSI, &#8221;select ADsPath from &#8221;&#8221;&#8217;+@adspath+&#8221;&#8221;&#8217; WHERE objectclass=&#8221;&#8221;person&#8221;&#8221;&#8221;))&#8217;<br />
<br />exec (@adsiquery) </p>
<p>Took a bit of apostrophe counting to get right, but it did work for me.  Hope this is relevant.</p>
</div>
					</div>
				</li>
					<li id="dsq-comment-160">
					<div id="dsq-comment-header-160" class="dsq-comment-header">
						<cite id="dsq-cite-160">
								<span id="dsq-author-user-160">Martin Douglas</span>
							</cite>
					</div>
					<div id="dsq-comment-body-160" class="dsq-comment-body">
						<div id="dsq-comment-message-160" class="dsq-comment-message"><p>If your ADSI linked server is correctly set up and you still get the following error,</p>
<p>An error occurred while preparing a query for execution against OLE DB provider &#8216;ADSDSOObject&#8217;.<br />
<br />OLE DB error trace [OLE/DB Provider 'ADSDSOObject' ICommandPrepare::Prepare returned 0x80040e14]. </p>
<p>then I suggest you check the account under which your SQL server instance is running.  Likely it is something like the local administrator account.  In that case, running under local system will fix the issue.  You may also choose to run your instance under a domain account if you need access to network resources as well.</p>
<p>Best of luck.</p>
<p>-MD-</p>
</div>
					</div>
				</li>
					<li id="dsq-comment-161">
					<div id="dsq-comment-header-161" class="dsq-comment-header">
						<cite id="dsq-cite-161">
								<span id="dsq-author-user-161">Deathagen</span>
							</cite>
					</div>
					<div id="dsq-comment-body-161" class="dsq-comment-body">
						<div id="dsq-comment-message-161" class="dsq-comment-message"><p>If you change your SQL Startup Service accout to the local account and run the procedure from the server, it will work. I am trying to find a solution for the client side and will let you know.</p>
</div>
					</div>
				</li>
					<li id="dsq-comment-162">
					<div id="dsq-comment-header-162" class="dsq-comment-header">
						<cite id="dsq-cite-162">
								<span id="dsq-author-user-162">Deathagen</span>
							</cite>
					</div>
					<div id="dsq-comment-body-162" class="dsq-comment-body">
						<div id="dsq-comment-message-162" class="dsq-comment-message"><p>Found it&#8230; From the server side change the SQL Startup to your Domain Account and on the linked server security tab, change the security to &#8216;Being made without using security context&#8217;&#8230; This should work</p>
</div>
					</div>
				</li>
					<li id="dsq-comment-163">
					<div id="dsq-comment-header-163" class="dsq-comment-header">
						<cite id="dsq-cite-163">
								<span id="dsq-author-user-163">Drew</span>
							</cite>
					</div>
					<div id="dsq-comment-body-163" class="dsq-comment-body">
						<div id="dsq-comment-message-163" class="dsq-comment-message"><p>Does anyone know where to find a list of AD fields/attributes that are available through an ADSI query?  I have found only partial references in examples, but no complete list.  Also, I was getting the 0x80040e14 error, and rebooting the server fixed it.</p>
</div>
					</div>
				</li>
					<li id="dsq-comment-164">
					<div id="dsq-comment-header-164" class="dsq-comment-header">
						<cite id="dsq-cite-164">
								<span id="dsq-author-user-164">Piotr Szwajkowski</span>
							</cite>
					</div>
					<div id="dsq-comment-body-164" class="dsq-comment-body">
						<div id="dsq-comment-message-164" class="dsq-comment-message"><p>Prepare returned 0x80040e14&#8230;<br />
<br />This error is a syntax error.<br />
<br />Just check your query sytax and should be fine.</p>
</div>
					</div>
				</li>
					<li id="dsq-comment-165">
					<div id="dsq-comment-header-165" class="dsq-comment-header">
						<cite id="dsq-cite-165">
								<span id="dsq-author-user-165">Jan Mlekusch</span>
							</cite>
					</div>
					<div id="dsq-comment-body-165" class="dsq-comment-body">
						<div id="dsq-comment-message-165" class="dsq-comment-message"><p>Through the tool ADSIedit.msc delivered by the Exchange Server</p>
</div>
					</div>
				</li>
					<li id="dsq-comment-166">
					<div id="dsq-comment-header-166" class="dsq-comment-header">
						<cite id="dsq-cite-166">
								<span id="dsq-author-user-166">Christiaan</span>
							</cite>
					</div>
					<div id="dsq-comment-body-166" class="dsq-comment-body">
						<div id="dsq-comment-message-166" class="dsq-comment-message"><p>This works fine:<br />
<br />select * from openquery(adsi, &#8216;select * from &#8221;LDAP://WS01&#8221;&#8217;)</p>
<p>This gives the 0x80040e14 error:<br />
<br />select * from openquery(adsi, &#8216;select * from &#8221;LDAP://WS01/OU=Teleservice,DC=e-resultive,DC=nl&#8221;&#8217;)</p>
</div>
					</div>
				</li>
					<li id="dsq-comment-167">
					<div id="dsq-comment-header-167" class="dsq-comment-header">
						<cite id="dsq-cite-167">
								<span id="dsq-author-user-167">Hermann Croucamp</span>
							</cite>
					</div>
					<div id="dsq-comment-body-167" class="dsq-comment-body">
						<div id="dsq-comment-message-167" class="dsq-comment-message"><p>Using SQL to query ADSI is useful until you hit the 1000 record barrier set in place by the ADSDSOObject. From ASP you use the PageSize and AbsolutePage properties to get past this. </p>
<p>Have you been able to pass the 1000 mark from within SQL?</p>
</div>
					</div>
				</li>
					<li id="dsq-comment-168">
					<div id="dsq-comment-header-168" class="dsq-comment-header">
						<cite id="dsq-cite-168">
								<span id="dsq-author-user-168">Brendan Tompkins</span>
							</cite>
					</div>
					<div id="dsq-comment-body-168" class="dsq-comment-body">
						<div id="dsq-comment-message-168" class="dsq-comment-message"><p>Hermann,</p>
<p>No, I haven&#8217;t found a good way of getting around this.  One way, admittedly a hack, is to find some way to divide up the result set so that each select returns less than 1000 records.  Then you can union your results before returning them from SQL Server</p>
<p>Hope this helps&#8230; Brendan</p>
</div>
					</div>
				</li>
					<li id="dsq-comment-169">
					<div id="dsq-comment-header-169" class="dsq-comment-header">
						<cite id="dsq-cite-169">
								<span id="dsq-author-user-169">Hermann Croucamp</span>
							</cite>
					</div>
					<div id="dsq-comment-body-169" class="dsq-comment-body">
						<div id="dsq-comment-message-169" class="dsq-comment-message"><p>Brendan</p>
<p>What you&#8217;ve said made me think of method do achieve more than 1000. I started of by returning records by passing A* through Z* to the ADSI link and adding it to a temp table. I soon realized that in a big corporation there may even be more than a 1000 users with CNs starting with for example A. The same might be the case for AB*, etc.</p>
<p>Well I&#8217;ve ended up with quite a long script to retrieve all objects which will be best if stached in a table once a day or every few hours and then create a view from there.</p>
<p>The script should be fine for medium to big companies (1000-10000+). The only drawback with the script is that when 1000 records or more are found for say A*, it causes a tedious querying process. In this case, it takes the last records added to the temp table and locate the second character and then step trhough the rest of A from for example AB-AZ.</p>
<p>All the characters specified in @vchChars is in the order in which AD will sort them to make the search process sequencial. You will however not be able to retrieve records starting with (, ), * or a single quote for the provider does not allow the syntax. Even when you say cn=/(* which is the escape sequence provided by Microsoft.</p>
<p>The script returned 30251 records in 09:57 minutes. The test DC was only a P4 1.4GHz<br />
<br />Test users was A0001 up to A0998 plus A01250 to A02350 and [B-Z]0001 up to [B-Z]0998. It only returns enabled users.</p>
<p>Well enough blabbing, here is the script:</p>
<p>declare<br />
<br />	@vchChars varchar(100)<br />
<br />,	@vchTest varchar(10)<br />
<br />,	@intLength tinyint<br />
<br />,	@intStep tinyint<br />
<br />,	@intSubStep tinyint<br />
<br />,	@intCompPos tinyint<br />
<br />,	@intRowCount smallint<br />
<br />,	@intCycleCount smallint<br />
<br />,	@intMaxCompare smallint<br />
<br />,	@bitStepNext bit<br />
<br />,	@bitSubStepNext bit<br />
<br />,	@nvchSQL nvarchar(4000)<br />
<br />,	@nvarOU	nvarchar(200)<br />
<br />,	@nvchDC nvarchar(100)<br />
<br />,	@nvchCN varchar(256)</p>
<p>set @nvchDC		= &#8216;DC=your_domain,DC=com&#8217;<br />
<br />set @nvarOU		= &#8216;OU=SQL Test&#8217; &#8211;set equal to &#8221; if not needed<br />
<br />set @vchChars 		= &#8216;-_`0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ&#8217;<br />
<br />set @intMaxCompare	= 3</p>
<p>set nocount on</p>
<p>if exists (select * from tempdb.dbo.sysobjects where id = object_id(&#8216;tempdb.dbo.#LDAP&#8217;))<br />
<br />		drop table #LDAP</p>
<p>create table [dbo].[#ldap] (<br />
<br />	[row_id] [int] IDENTITY (1, 1) NOT NULL ,<br />
<br />	[cn] [nvarchar] (256) collate sql_latin1_general_cp1_ci_as null ,<br />
<br />	[adspath] [nvarchar] (256) collate sql_latin1_general_cp1_ci_as null<br />
<br />) on [primary]</p>
<p>if len(@vchChars) &gt; 0<br />
<br />begin<br />
<br />	set @intStep = 1<br />
<br />	while @intStep &lt;= len(@vchChars)<br />
<br />	begin<br />
<br />		set @bitStepNext 	= 0<br />
<br />		set @intCycleCount 	= 0<br />
<br />		set @intSubStep 	= 2 &#8211;start comparison on second character<br />
<br />		set @intCompPos 	= 1<br />
<br />		set @intRowCount 	= 0<br />
<br />		set @bitSubStepNext 	= 0</p>
<p>		while @bitStepNext = 0<br />
<br />		begin<br />
<br />			if @intCycleCount = 0<br />
<br />				set @vchTest = substring(@vchChars, @intStep, 1)<br />
<br />			else<br />
<br />			begin<br />
<br />				select top 1 @nvchCN = cn from #ldap order by row_id desc<br />
<br />				if @bitSubStepNext = 0<br />
<br />					set @intCompPos = charindex(substring(@nvchCN, @intSubStep, 1), @vchChars, 1)</p>
<p>				set @vchTest = substring(@vchTest, 1, (@intSubStep &#8211; 1)) + substring(@vchChars, @intCompPos, 1)</p>
<p>				set @bitSubStepNext = 0<br />
<br />			end</p>
<p>			set @nvchSQL = &#8216;insert into #ldap &#8216; +<br />
<br />					&#8216;select cn, adspath &#8216; +<br />
<br />					&#8216;from openquery(ADSI,&#8221;&lt;LDAP://&#8217; + @nvarOU + &#8216;,&#8217; + @nvchDC + &#8216;&gt;;(&amp;(objectCategory=Person)(!(UserAccountControl:1.2.840.113556.1.4.803:=2))(cn=&#8217; + @vchTest + &#8216;*));cn, adspath;subtree&#8221;) q &#8216;+<br />
<br />					&#8216;where not exists (select adspath from #ldap ld where ld.adspath = q.adspath)&#8217; +<br />
<br />					&#8216;order by cn&#8217;</p>
<p>			exec sp_executesql @nvchSQL</p>
<p>			set @intRowCount = @@rowcount<br />
<br />			print @vchTest + &#8216; : &#8216; + convert(varchar, @intRowCount) + &#8216; : &#8216; + convert(varchar, @intCompPos) &#8211;keep print after the @@rowcount statement or it will reset @@rowcount</p>
<p>			if (@intRowCount &lt; 1000 and @intCycleCount = 0) or ((@intCompPos = len(@vchChars) and @intCycleCount &gt; 0 and (@intSubStep = @intMaxCompare or (@intSubStep = 2 and @intRowCount = 0))))<br />
<br />				set @bitStepNext = 1<br />
<br />			else<br />
<br />			begin<br />
<br />				set @intCycleCount = @intCycleCount + 1<br />
<br />				if @intRowCount &lt; 1000<br />
<br />				begin<br />
<br />					if (@intCompPos = len(@vchChars))<br />
<br />					begin<br />
<br />						set @intSubStep = @intSubStep &#8211; 1<br />
<br />						if @intSubStep &lt; 2<br />
<br />							set @intSubStep = 2<br />
<br />					end<br />
<br />					else<br />
<br />					begin<br />
<br />						set @bitSubStepNext = 1<br />
<br />						set @intCompPos = @intCompPos + 1<br />
<br />					end<br />
<br />				end<br />
<br />				else<br />
<br />				begin<br />
<br />					set @intCompPos = 1<br />
<br />					set @intSubStep = @intSubStep + 1<br />
<br />					if (@intCompPos = len(@vchChars) and @intSubStep &gt; 3)<br />
<br />					begin<br />
<br />						set @intSubStep = @intSubStep &#8211; 1<br />
<br />						if @intSubStep &lt; 2<br />
<br />							set @intSubStep = 2<br />
<br />					end<br />
<br />				end<br />
<br />			end<br />
<br />		end<br />
<br />		set @intStep = @intStep + 1<br />
<br />	end</p>
<p>set nocount off</p>
<p>	select * from #ldap order by cn<br />
<br />end<br />
<br />else<br />
<br />	print &#8216;No characters specified&#8217;<br /></p>
</div>
					</div>
				</li>
					<li id="dsq-comment-170">
					<div id="dsq-comment-header-170" class="dsq-comment-header">
						<cite id="dsq-cite-170">
								<span id="dsq-author-user-170">Hermann Croucamp</span>
							</cite>
					</div>
					<div id="dsq-comment-body-170" class="dsq-comment-body">
						<div id="dsq-comment-message-170" class="dsq-comment-message"><p>I missed a comment for @intMaxCompare:</p>
<p>set @intMaxCompare	= 3 &#8211;this will set the maximum chars to compare for the last char in @vchChars<br />
<br />&#8211;if not set, the script will go into a never ending loop (only if last char has more than a 1000 which is not likely for Z)<br /></p>
</div>
					</div>
				</li>
					<li id="dsq-comment-171">
					<div id="dsq-comment-header-171" class="dsq-comment-header">
						<cite id="dsq-cite-171">
								<span id="dsq-author-user-171">Brendan Tompkins</span>
							</cite>
					</div>
					<div id="dsq-comment-body-171" class="dsq-comment-body">
						<div id="dsq-comment-message-171" class="dsq-comment-message"><p>Hermann. Great work. Much better than my solution.  We have about 1300 objects in our AD store, so this works for me:</p>
<p>SELECT  TOP 100 PERCENT Rowset_1.*, sn + &#8216;, &#8216; + givenName AS FULL_NAME<br />
<br />FROM   OPENQUERY(ADSI,<br />
<br />                      &#8216;SELECT title, sAMAccountName, givenName, telephoneNumber, facsimileTelephoneNumber, sn, mail, userAccountControl FROM &#8221;LDAP://DC=our,DC=domain,DC=org&#8221; WHERE objectCategory = &#8221;Person&#8221; AND  objectClass=&#8221;user&#8221; and userAccountControl&gt;1000&#8242;)<br />
<br />Rowset_1<br />
<br />WHERE     sn IS NOT NULL<br />
<br />UNION<br />
<br />SELECT     TOP 100 PERCENT Rowset_1.*, sn + &#8216;, &#8216; + givenName AS FULL_NAME<br />
<br />FROM         OPENQUERY(ADSI,<br />
<br />                      &#8216;SELECT title, sAMAccountName, givenName, telephoneNumber, facsimileTelephoneNumber, sn, mail, userAccountControl FROM &#8221;LDAP://DC=our,DC=domain,DC=org&#8221; WHERE objectCategory = &#8221;Person&#8221; AND  objectClass=&#8221;user&#8221; and userAccountControl&lt;1000&#8242;)<br />
<br />                       Rowset_1</p>
</div>
					</div>
				</li>
					<li id="dsq-comment-172">
					<div id="dsq-comment-header-172" class="dsq-comment-header">
						<cite id="dsq-cite-172">
								<span id="dsq-author-user-172">Hermann Croucamp</span>
							</cite>
					</div>
					<div id="dsq-comment-body-172" class="dsq-comment-body">
						<div id="dsq-comment-message-172" class="dsq-comment-message"><p>It was a nice challenge to find a solution for.<br />
<br />However, it would make more sense to write and schedule a small application to retrieve all the info into a SQL table for the use with views. Much faster! I&#8217;m not sure of the ADO.NET syntax, but with classic ADO it would require the use of objCommand.Properties(@Page Size@) = 1000</p>
<p>For more info, have a look at:<br />
<br /><a target="_new" href="http://www.microsoft.com/technet/scriptcenter/resources/qanda/aug04/hey0824.mspx">http://www.microsoft.com/technet/scriptcenter/resources/qanda/aug04/hey0824.mspx</a></p>
<p>Chiao,<br />
<br />Hermann</p>
</div>
					</div>
				</li>
					<li id="dsq-comment-173">
					<div id="dsq-comment-header-173" class="dsq-comment-header">
						<cite id="dsq-cite-173">
								<span id="dsq-author-user-173">Sampath</span>
							</cite>
					</div>
					<div id="dsq-comment-body-173" class="dsq-comment-body">
						<div id="dsq-comment-message-173" class="dsq-comment-message"><p>I also have the same problem</p>
</div>
					</div>
				</li>
					<li id="dsq-comment-174">
					<div id="dsq-comment-header-174" class="dsq-comment-header">
						<cite id="dsq-cite-174">
								<span id="dsq-author-user-174">SjoerdvW</span>
							</cite>
					</div>
					<div id="dsq-comment-body-174" class="dsq-comment-body">
						<div id="dsq-comment-message-174" class="dsq-comment-message"><p>I use youre query to read the AD, but I would also know or a account is dissabled. For this I&#8217;m using userAccountControl. Most results come with a userAccountControl of NULL&#8230; How can I resolve this???</p>
</div>
					</div>
				</li>
					<li id="dsq-comment-175">
					<div id="dsq-comment-header-175" class="dsq-comment-header">
						<cite id="dsq-cite-175">
								<span id="dsq-author-user-175">Mike</span>
							</cite>
					</div>
					<div id="dsq-comment-body-175" class="dsq-comment-body">
						<div id="dsq-comment-message-175" class="dsq-comment-message"><p>that&#8217;s a nice query Hermann&#8230;but, you can also resolve the issue by changing your MaxPageSize within AD, which is what is limiting you to 1000 rows being returned&#8230;That&#8217;s the route I&#8217;m hoping we can go here. <img src='http://codebetter.com/brendantompkins/wp-includes/images/smilies/icon_smile.gif' alt=':)' class='wp-smiley' /> </p>
</div>
					</div>
				</li>
					<li id="dsq-comment-176">
					<div id="dsq-comment-header-176" class="dsq-comment-header">
						<cite id="dsq-cite-176">
	http://marcusoh.blogspot.com							<span id="dsq-author-user-176">marcus oh</span>
							</cite>
					</div>
					<div id="dsq-comment-body-176" class="dsq-comment-body">
						<div id="dsq-comment-message-176" class="dsq-comment-message"><p>MaxPageSize is set to 1000 for good reason.  It stops queries from relentlessly hammering a domain controller for the returned information.  Instead of raising this value, it&#8217;s always better to find ways to return the data.</p>
</div>
					</div>
				</li>
					<li id="dsq-comment-177">
					<div id="dsq-comment-header-177" class="dsq-comment-header">
						<cite id="dsq-cite-177">
								<span id="dsq-author-user-177">Jeremy</span>
							</cite>
					</div>
					<div id="dsq-comment-body-177" class="dsq-comment-body">
						<div id="dsq-comment-message-177" class="dsq-comment-message"><p>I need some help with the problem where the LDAP query works fine when logged in to the SQL server, but not when run from any other server.  I cannot use the solution suggested above of making SQL start under my domain account, as this violates policies and best practices.  I feel like this is a somewhat useless restriction posed by Microsoft (both products are theirs).  What is the benefit to the security of a given box to NOT allow an outbound LDAP query?  Help me out?  </p>
<p>thanks</p>
</div>
					</div>
				</li>
					<li id="dsq-comment-178">
					<div id="dsq-comment-header-178" class="dsq-comment-header">
						<cite id="dsq-cite-178">
								<span id="dsq-author-user-178">Texrat</span>
							</cite>
					</div>
					<div id="dsq-comment-body-178" class="dsq-comment-body">
						<div id="dsq-comment-message-178" class="dsq-comment-message"><p>Hermann&#8217;s example was certainly a good start for me, but I needed to add other columns to my table (title, mail, etc).  So I included the new definitions, but then the procedure generates an error saying that the number of fields doesn&#8217;t match what&#8217;s expected.  ???  I don&#8217;t see why or where the number of fields is limited.  Why does this procedure care?  I&#8217;m probably missing something very simple I&#8217;m sure&#8230;</p>
</div>
					</div>
				</li>
					<li id="dsq-comment-179">
					<div id="dsq-comment-header-179" class="dsq-comment-header">
						<cite id="dsq-cite-179">
								<span id="dsq-author-user-179">eeBee</span>
							</cite>
					</div>
					<div id="dsq-comment-body-179" class="dsq-comment-body">
						<div id="dsq-comment-message-179" class="dsq-comment-message"><p>Hi, I had the same problem, &#8217;till I found out I was using &#8216;SELECT name FROM &#8221;ldap://&#8230; (ldap in lowercase). When I changed to uppercase (LDAP://) it worked !!! I did the test a few times, and the error came back.</p>
<p>Hope this will help&#8230;</p>
</div>
					</div>
				</li>
					<li id="dsq-comment-180">
					<div id="dsq-comment-header-180" class="dsq-comment-header">
						<cite id="dsq-cite-180">
								<span id="dsq-author-user-180">PedroPN</span>
							</cite>
					</div>
					<div id="dsq-comment-body-180" class="dsq-comment-body">
						<div id="dsq-comment-message-180" class="dsq-comment-message"><p>Dear friens,<br />
I&#8217;m having a problem with ADSI and SQL&#8230; Could you tell me, where is the error? The problem surge when I try to use parameter…</p>
<p>&#8221;<br />
CREATE PROCEDURE TEST<br />
AS<br />
DECLARE @charVariable nvarchar(11);<br />
DECLARE @SQLString NVARCHAR(500);<br />
DECLARE @ParmDefinition NVARCHAR(500);</p>
<p>/* Build the SQL string one time. */<br />
SET @SQLString = N&#8217;SELECT * FROM OPENQUERY(ADSI,&#8221;SELECT * FROM &#8221;&#8221;LDAP://DC=GrupoCGD,DC=com&#8221;&#8221; WHERE objectClass = &#8221;&#8221;user&#8221;&#8221; AND sAMAccountName=@UserID&#8221;)&#8217;</p>
<p>/* Specify the parameter format one time. */<br />
SET @ParmDefinition = N&#8217;@UserID varchar(11)&#8217;;</p>
<p>/* Execute the string with the first parameter value. */<br />
SET @charVariable = &#8216;rhs0002&#8242;;<br />
EXECUTE sp_executesql @SQLString, @ParmDefinition,<br />
                      @userID = @charVariable;<br />
&#8221;</p>
<p>ERROR is:<br />
Msg 7321, Level 16, State 2, Line 1<br />
An error occurred while preparing the query &#8220;SELECT * FROM &#8216;LDAP://DC=GrupoCGD,DC=com&#8217; WHERE objectClass = &#8216;user&#8217; AND sAMAccountName=@UserID&#8221; for execution against OLE DB provider &#8220;ADSDSOObject&#8221; for linked server &#8220;ADSI&#8221;. </p>
<p>FOR EXAMPLE THIS VIEW WORKS…<br />
USE [dbGestaoDesktop]<br />
GO<br />
/****** Object:  View [dbo].[AD_VW_DIR_Users]    Script Date: 11/22/2006 11:53:13 ******/<br />
SET ANSI_NULLS ON<br />
GO<br />
SET QUOTED_IDENTIFIER ON<br />
GO</p>
<p>CREATE VIEW [dbo].[AD_VW_DIR_Users]<br />
AS<br />
SELECT     TOP (100) PERCENT cn, createTimeStamp,department, extensionAttribute1<br />
FROM         OPENQUERY(ADSI, &#8216;<br />
SELECT createTimeStamp,cn, department, extensionAttribute1<br />
FROM &#8221;LDAP://OU=DSO,OU=Utilizadores,OU=Servicos-Centrais,OU=cgd,DC=GrupoCGD,DC=com&#8221;</p>
<p>WHERE objectclass=&#8221;user&#8221;</p>
<p>&#8216;)<br />
                      AS MyTable<br />
WHERE     (NOT (cn IS NULL))<br />
ORDER BY createTimeStamp</p>
<p>THANKS</p>
</div>
					</div>
				</li>
					<li id="dsq-comment-181">
					<div id="dsq-comment-header-181" class="dsq-comment-header">
						<cite id="dsq-cite-181">
								<span id="dsq-author-user-181">James</span>
							</cite>
					</div>
					<div id="dsq-comment-body-181" class="dsq-comment-body">
						<div id="dsq-comment-message-181" class="dsq-comment-message"><p>Can this be modified to add NDS also as a linked server?</p>
</div>
					</div>
				</li>
					<li id="dsq-comment-182">
					<div id="dsq-comment-header-182" class="dsq-comment-header">
						<cite id="dsq-cite-182">
								<span id="dsq-author-user-182">Charlie Asbornsen</span>
							</cite>
					</div>
					<div id="dsq-comment-body-182" class="dsq-comment-body">
						<div id="dsq-comment-message-182" class="dsq-comment-message"><p>This is very useful but we are banging our heads against the keyboards here trying to puzzle out the way to get a view that lists the users in their respective roles.  We have a list of users, we have a list of roles, but never the twain shall meet, so to speak.  Right now we are doing some rather cumbersome business layer coding to do row level security, but it would be so much better to do it on the data layer so we don&#8217;t have to clog up the network with all that stuff that the user&#8217;s aren&#8217;t allowed to see anyway.  It would also make synchronizing our DB security to AD security much easier.</p>
</div>
					</div>
				</li>
					<li id="dsq-comment-183">
					<div id="dsq-comment-header-183" class="dsq-comment-header">
						<cite id="dsq-cite-183">
								<span id="dsq-author-user-183">Buzz</span>
							</cite>
					</div>
					<div id="dsq-comment-body-183" class="dsq-comment-body">
						<div id="dsq-comment-message-183" class="dsq-comment-message"><p>To fix the error &#8220;An error occurred while preparing the query&#8221;</p>
<p>In the linked server security settings use &#8220;Be made using this security context&#8221;, entered Remote login: domain\user; With password: password.<br />
If you dont specify the domain before the user name, this will not work.</p>
</div>
					</div>
				</li>
					<li id="dsq-comment-184">
					<div id="dsq-comment-header-184" class="dsq-comment-header">
						<cite id="dsq-cite-184">
								<span id="dsq-author-user-184">Derek Czarny</span>
							</cite>
					</div>
					<div id="dsq-comment-body-184" class="dsq-comment-body">
						<div id="dsq-comment-message-184" class="dsq-comment-message"><p>You are a awesome.  I have struggled with how to execute my stored procedure from within a stored procedure for 2 days, and didn&#8217;t event think to make it a view.</p>
</div>
					</div>
				</li>
					<li id="dsq-comment-185">
					<div id="dsq-comment-header-185" class="dsq-comment-header">
						<cite id="dsq-cite-185">
								<span id="dsq-author-user-185">Dave Naples</span>
							</cite>
					</div>
					<div id="dsq-comment-body-185" class="dsq-comment-body">
						<div id="dsq-comment-message-185" class="dsq-comment-message"><p>The easiest way to get around the paging issue is to use the OLE stored procedures (sp_OA*):</p>
<p>/* BEGIN SAMPLE CODE */<br />
DECLARE @OLEReturn INT				&#8211; OLE return value (used for error checking)<br />
DECLARE @SQL VARCHAR (8000)			&#8211; Holds the text of the LDAP query (this could be an input parameter<br />
									&#8211; if this code is made into a standalone stored procedure)<br />
DECLARE @ADOcommprop INT			&#8211; ADO Command object properties pointer<br />
DECLARE @ADOcommpropVal INT			&#8211; ADO Command object properties value pointer</p>
<p>&#8211; Create the ADO connection object<br />
EXEC @OLEreturn = sp_OACreate &#8216;ADODB.Connection&#8217;, @ADOconn OUT</p>
<p>&#8211; Set the provider property to ADsDSOObject to point to Active Directory<br />
EXEC @OLEreturn = sp_OASETProperty @ADOconn , &#8216;Provider&#8217;, &#8216;ADsDSOObject&#8217;</p>
<p>&#8211; Open the ADO connection<br />
EXEC @OLEreturn = sp_OAMethod @ADOconn , &#8216;Open&#8217;</p>
<p>&#8211; Create the ADO command object<br />
EXEC @OLEreturn = sp_OACreate &#8216;ADODB.Command&#8217;, @ADOcomm OUT</p>
<p>&#8211; Set the ADO command object to use the connection object created first<br />
EXEC @OLEreturn = sp_OASETProperty @ADOcomm, &#8216;ActiveConnection&#8217;, &#8216;Provider=&#8221;ADsDSOObject&#8221;&#8217;</p>
<p>&#8211; Get a pointer to the properties set of the ADO Command Object<br />
EXEC @OLEreturn = sp_OAGetProperty @ADOcomm, &#8216;Properties&#8217;, @ADOcommprop out</p>
<p>&#8211; Set the PageSize property<br />
EXEC @OLEreturn = sp_OAMethod @ADOcommprop, &#8216;Item&#8217;, @ADOcommpropVal out, &#8216;Page Size&#8217;</p>
<p>&#8211; Set the PageSize value<br />
EXEC @OLEreturn = sp_OASETProperty @ADOcommpropVal, &#8216;Value&#8217;, &#8217;1000&#8242;</p>
<p>&#8211; Destroy PageSize token<br />
EXEC @OLEReturn = sp_OADestroy @ADOcommpropVal</p>
<p>&#8211; Set the SearchScope property to ADS_SCOPE_SUBTREE to search the entire subtree<br />
EXEC @OLEreturn = sp_OAMethod @ADOcommprop, &#8216;Item&#8217;, @ADOcommpropVal out, &#8216;SearchScope&#8217;</p>
<p>&#8211; Set the SearchScope value<br />
EXEC @OLEreturn = sp_OASETProperty @ADOcommpropVal, &#8216;Value&#8217;, &#8217;2&#8242; &#8212; ADS_SCOPE_SUBTREE</p>
<p>&#8211; Destroy SearchScope token<br />
EXEC @OLEReturn = sp_OADestroy @ADOcommpropVal</p>
<p>&#8211; Set the Asynchronous property to True<br />
EXEC @OLEreturn = sp_OAMethod @ADOcommprop, &#8216;Item&#8217;, @ADOcommpropVal out, &#8216;Asynchronous&#8217;</p>
<p>&#8211; Set the Asynchronous value<br />
EXEC @OLEreturn = sp_OASETProperty @ADOcommpropVal, &#8216;Value&#8217;,True</p>
<p>&#8211; Destroy Asynchronous token<br />
EXEC @OLEReturn = sp_OADestroy @ADOcommpropVal</p>
<p>&#8211; Destroy command properties token<br />
EXEC @OLEReturn = sp_OADestroy @ADOcommprop</p>
<p>&#8211; Create the ADO Recordset to hold the results of the LDAP query<br />
EXEC @OLEreturn = sp_OACreate &#8216;ADODB.Recordset&#8217;, @ADOrs out</p>
<p>&#8211; Set the SQL text of the command object<br />
EXEC @OLEreturn = sp_OASETProperty @ADOcomm, &#8216;CommandText&#8217;, @SQL </p>
<p>&#8211; Run the LDAP query and output the results to the ADO Recordset<br />
EXEC @OLEreturn = sp_OAMethod @ADOcomm, &#8216;Execute&#8217;, @ADOrs OUT<br />
/* END SAMPLE CODE */</p>
<p>I have used this very successfully in a company with over 20,000 logins, 17,000+ of which have the same 3 character prefix.</p>
</div>
					</div>
				</li>
					<li id="dsq-comment-186">
					<div id="dsq-comment-header-186" class="dsq-comment-header">
						<cite id="dsq-cite-186">
								<span id="dsq-author-user-186">Dave Naples</span>
							</cite>
					</div>
					<div id="dsq-comment-body-186" class="dsq-comment-body">
						<div id="dsq-comment-message-186" class="dsq-comment-message"><p>ACTIVE DIRECTORY RETRIEVAL FROM SQL: PART 1</p>
<p>Okay, so given the sample code above, here&#8217;s a stored procedure you can use as a wrapper to simplify your ADO calls from within SQL:</p>
<p>/* BEGIN STORED PROCEDURE */</p>
<p>CREATE PROCEDURE SetupOLE</p>
<p>@SQL VARCHAR (8000),<br />
@ADOconn INT OUTPUT,				&#8211; Returned handle to the ADO Connection object<br />
@ADOcomm INT OUTPUT,				&#8211; Returned handle to the ADO Command object<br />
@ADOrs INT OUTPUT					&#8211; Returned handle to the ADO Recordset object</p>
<p>AS<br />
DECLARE @OLEReturn INT<br />
DECLARE @ADOcommprop INT			&#8211; ADO Command object properties pointer<br />
DECLARE @ADOcommpropVal INT			&#8211; ADO Command object properties value pointer<br />
DECLARE @Section VARCHAR (255)<br />
DECLARE @ErrorObj INT</p>
<p>SET @Section = &#8216;Create the ADO connection object&#8217;<br />
EXEC @OLEreturn = sp_OACreate &#8216;ADODB.Connection&#8217;, @ADOconn OUT</p>
<p>IF @OLEreturn <> 0<br />
	BEGIN<br />
	SET @ErrorObj = @ADOconn<br />
	GOTO ErrorHandler<br />
	END</p>
<p>SET @Section = &#8216;Set the provider property to ADsDSOObject to point to Active Directory&#8217;<br />
EXEC @OLEreturn = sp_OASETProperty @ADOconn , &#8216;Provider&#8217;, &#8216;ADsDSOObject&#8217;</p>
<p>IF @OLEreturn <> 0<br />
	BEGIN<br />
	SET @ErrorObj = @ADOconn<br />
	GOTO ErrorHandler<br />
	END</p>
<p>SET @Section = &#8216;Open the ADO connection&#8217;<br />
EXEC @OLEreturn = sp_OAMethod @ADOconn , &#8216;Open&#8217;</p>
<p>IF @OLEreturn <> 0<br />
	BEGIN<br />
	SET @ErrorObj = @ADOconn<br />
	GOTO ErrorHandler<br />
	END</p>
<p>SET @Section = &#8216;Create the ADO command object&#8217;<br />
EXEC @OLEreturn = sp_OACreate &#8216;ADODB.Command&#8217;, @ADOcomm OUT</p>
<p>IF @OLEreturn <> 0<br />
	BEGIN<br />
	SET @ErrorObj = @ADOcomm<br />
	GOTO ErrorHandler<br />
	END</p>
<p>SET @Section = &#8216;Set the ADO command object to use the connection object created first&#8217;<br />
EXEC @OLEreturn = sp_OASETProperty @ADOcomm, &#8216;ActiveConnection&#8217;, &#8216;Provider=&#8221;ADsDSOObject&#8221;&#8217;</p>
<p>IF @OLEreturn <> 0<br />
	BEGIN<br />
	SET @ErrorObj = @ADOcomm<br />
	GOTO ErrorHandler<br />
	END</p>
<p>SET @Section = &#8216;Get a pointer to the properties set of the ADO Command Object&#8217;<br />
EXEC @OLEreturn = sp_OAGetProperty @ADOcomm, &#8216;Properties&#8217;, @ADOcommprop out</p>
<p>IF @OLEreturn <> 0<br />
	BEGIN<br />
	SET @ErrorObj = @ADOcomm<br />
	GOTO ErrorHandler<br />
	END</p>
<p>SET @Section = &#8216;Set the PageSize property&#8217;<br />
EXEC @OLEreturn = sp_OAMethod @ADOcommprop, &#8216;Item&#8217;, @ADOcommpropVal out, &#8216;Page Size&#8217;</p>
<p>IF @OLEreturn <> 0<br />
	BEGIN<br />
	SET @ErrorObj = @ADOcommprop<br />
	GOTO ErrorHandler<br />
	END</p>
<p>SET @Section = &#8216;Set the PageSize value&#8217;<br />
EXEC @OLEreturn = sp_OASETProperty @ADOcommpropVal, &#8216;Value&#8217;, &#8217;1000&#8242;</p>
<p>IF @OLEreturn <> 0<br />
	BEGIN<br />
	SET @ErrorObj = @ADOcommpropVal<br />
	GOTO ErrorHandler<br />
	END</p>
<p>SET @Section = &#8216;Destroy PageSize token&#8217;<br />
EXEC @OLEReturn = sp_OADestroy @ADOcommpropVal</p>
<p>IF @OLEreturn <> 0<br />
	BEGIN<br />
	SET @ErrorObj = @ADOcommpropVal<br />
	GOTO ErrorHandler<br />
	END</p>
<p>SET @Section = &#8216;Set the SearchScope property to ADS_SCOPE_SUBTREE to search the entire subtree&#8217;<br />
EXEC @OLEreturn = sp_OAMethod @ADOcommprop, &#8216;Item&#8217;, @ADOcommpropVal out, &#8216;SearchScope&#8217;<br />
IF @OLEreturn <> 0<br />
	BEGIN<br />
	SET @ErrorObj = @ADOcommprop<br />
	GOTO ErrorHandler<br />
	END</p>
<p>SET @Section = &#8216;Set the SearchScope value&#8217;<br />
EXEC @OLEreturn = sp_OASETProperty @ADOcommpropVal, &#8216;Value&#8217;, &#8217;2&#8242; &#8212; ADS_SCOPE_SUBTREE</p>
<p>IF @OLEreturn <> 0<br />
	BEGIN<br />
	SET @ErrorObj = @ADOcommpropVal<br />
	GOTO ErrorHandler<br />
	END</p>
<p>SET @Section = &#8216;Destroy SearchScope token&#8217;<br />
EXEC @OLEReturn = sp_OADestroy @ADOcommpropVal</p>
<p>IF @OLEreturn <> 0<br />
	BEGIN<br />
	SET @ErrorObj = @ADOcommpropVal<br />
	GOTO ErrorHandler<br />
	END</p>
<p>SET @Section = &#8216;Set the Asynchronous property to True&#8217;<br />
EXEC @OLEreturn = sp_OAMethod @ADOcommprop, &#8216;Item&#8217;, @ADOcommpropVal out, &#8216;Asynchronous&#8217;</p>
<p>IF @OLEreturn <> 0<br />
	BEGIN<br />
	SET @ErrorObj = @ADOcommprop<br />
	GOTO ErrorHandler<br />
	END</p>
<p>SET @Section = &#8216;Set the Asynchronous value&#8217;<br />
EXEC @OLEreturn = sp_OASETProperty @ADOcommpropVal, &#8216;Value&#8217;,True</p>
<p>IF @OLEreturn <> 0<br />
	BEGIN<br />
	SET @ErrorObj = @ADOcommpropVal<br />
	GOTO ErrorHandler<br />
	END</p>
<p>SET @Section = &#8216;Destroy Asynchronous token&#8217;<br />
EXEC @OLEReturn = sp_OADestroy @ADOcommpropVal</p>
<p>IF @OLEreturn <> 0<br />
	BEGIN<br />
	SET @ErrorObj = @ADOcommpropVal<br />
	GOTO ErrorHandler<br />
	END</p>
<p>SET @Section = &#8216;Destroy command properties token&#8217;<br />
EXEC @OLEReturn = sp_OADestroy @ADOcommprop</p>
<p>IF @OLEreturn <> 0<br />
	BEGIN<br />
	SET @ErrorObj = @ADOcommprop<br />
	GOTO ErrorHandler<br />
	END</p>
<p>SET @Section = &#8216;Create the ADO Recordset to hold the results of the LDAP query&#8217;<br />
EXEC @OLEreturn = sp_OACreate &#8216;ADODB.Recordset&#8217;, @ADOrs out</p>
<p>IF @OLEreturn <> 0<br />
	BEGIN<br />
	SET @ErrorObj = @ADOrs<br />
	GOTO ErrorHandler<br />
	END</p>
<p>SET @Section = &#8216;Set the SQL text of the command object&#8217;<br />
EXEC @OLEreturn = sp_OASETProperty @ADOcomm, &#8216;CommandText&#8217;, @SQL </p>
<p>IF @OLEreturn <> 0<br />
	BEGIN<br />
	SET @ErrorObj = @ADOcomm<br />
	GOTO ErrorHandler<br />
	END</p>
<p>SET @Section = &#8216;Run the LDAP query and output the results to the ADO Recordset&#8217;<br />
EXEC @OLEreturn = sp_OAMethod @ADOcomm, &#8216;Execute&#8217;, @ADOrs OUT</p>
<p>IF @OLEreturn <> 0<br />
	BEGIN<br />
	SET @ErrorObj = @ADOcomm<br />
	GOTO ErrorHandler<br />
	END</p>
<p>GOTO Finish</p>
<p>ErrorHandler:<br />
EXEC GetOLEError @OLEReturn, @ErrorObj, @Section</p>
<p>Finish:<br />
RETURN @OLEreturn</p>
<p>/* END STORED PROCEDURE */</p>
<p>In the next installment I&#8217;ll show how to use this stored procedure to retrieve Active Directory users and groups and store them in staging tables &#8230;</p>
</div>
					</div>
				</li>
					<li id="dsq-comment-187">
					<div id="dsq-comment-header-187" class="dsq-comment-header">
						<cite id="dsq-cite-187">
								<span id="dsq-author-user-187">Dave Naples</span>
							</cite>
					</div>
					<div id="dsq-comment-body-187" class="dsq-comment-body">
						<div id="dsq-comment-message-187" class="dsq-comment-message"><p>ACTIVE DIRECTORY RETRIEVAL FROM SQL: PART 2</p>
<p>Okay, so now you have the wrapper procedure to access your AD information. Next we&#8217;ll use this wrapper to easily bring this data down to staging tables:</p>
<p>/* BEGIN STAGING TABLE DEFINITIONS */</p>
<p>CREATE TABLE [dbo].[<active Directory login table>](<br />
	[ID] [int] IDENTITY (1,1) NOT NULL,<br />
	[Login] [varchar](512) NULL,<br />
	[DistName] [varchar](512) NULL,<br />
	[FirstName] [varchar](512) NULL,<br />
	[Initials] [varchar](512) NULL,<br />
	[LastName] [varchar](512) NULL,<br />
	[EMail] [varchar](255) NULL,<br />
	[CreatedDate] [datetime] NULL,<br />
	[ChangedDate] [datetime] NULL,<br />
	[AcctCtrl] [bigint] NULL,<br />
	[Title] [varchar](512) NULL,<br />
	[Dept] [varchar](512) NULL,<br />
	[Phone] [varchar](512) NULL,<br />
	[FullName] [varchar](512) NULL,<br />
	[Mgr] [varchar](512) NULL,<br />
	[LastLogon] [varchar](50) NULL,<br />
	[LastLogoff] [varchar](50) NULL,<br />
	[CN] [varchar](512) NULL,<br />
	[Info] [varchar](512) NULL,<br />
	[sid] [varbinary](85) NULL,<br />
	[PriGroupID] [int] NULL,<br />
	[objectClass] [varchar](255) NULL,<br />
	[objectCategory] [varchar](255) NULL,<br />
	CONSTRAINT [PK_</active><active Directory login table>]<br />
		PRIMARY KEY CLUSTERED ([ID] ASC)<br />
		WITH (IGNORE_DUP_KEY = OFF) ON [PRIMARY]<br />
	) ON [PRIMARY]<br />
GO<br />
CREATE TABLE [dbo].[</active><active Directory group table>] (<br />
	[ID] [int] IDENTITY (1,1) NOT NULL,<br />
	[Login] [varchar](512) NULL,<br />
	[EMail] [varchar](255) NULL,<br />
	[AcctName] [varchar](512) NULL,<br />
	[DistName] [varchar](512) NULL,<br />
	[CreatedDate] [datetime] NULL,<br />
	[ChangedDate] [datetime] NULL,<br />
	[Mgr] [varchar](512) NULL,<br />
	[sid] [varbinary](85) NULL,<br />
	CONSTRAINT [PK_</active><active Directory group table>]<br />
		PRIMARY KEY CLUSTERED ([ID] ASC)<br />
		WITH (IGNORE_DUP_KEY = OFF) ON [PRIMARY]<br />
	) ON [PRIMARY]</p>
<p>GO<br />
CREATE TABLE [dbo].[<ad group/user correlation table>](<br />
	[UserLogin] [varbinary](85) NOT NULL,<br />
	[GroupLogin] [varbinary](85) NULL<br />
) ON [PRIMARY]<br />
GO<br />
/* END STAGING TABLE DEFINITIONS */</p>
<p>Now that the tables have been created, we need to create the stored procedure to bring the login and group information into these tables &#8230;</ad></active></p>
</div>
					</div>
				</li>
					<li id="dsq-comment-188">
					<div id="dsq-comment-header-188" class="dsq-comment-header">
						<cite id="dsq-cite-188">
								<span id="dsq-author-user-188">Dave Naples</span>
							</cite>
					</div>
					<div id="dsq-comment-body-188" class="dsq-comment-body">
						<div id="dsq-comment-message-188" class="dsq-comment-message"><p>ACTIVE DIRECTORY RETRIEVAL FROM SQL: PART 2</p>
<p>So we need to get the Active Directory information into the tables we have just created, and we want to be able to retrieve beyond the 1000 record limit without having to loop through different character patterns. We do this by using the sp_OA* stored procedures to use ADO. This gives us the ability to set the paging from within SQL Server (which means &#8212; say it with me &#8212; NO EXTERNAL COMPONENTS!).</p>
<p>/* BEGIN SAMPLE CODE */</p>
<p>DECLARE @ADOconn INT				&#8211; ADO Connection object<br />
DECLARE @ADOcomm INT				&#8211; ADO Command object<br />
&#8211;DECLARE @ADOcommprop INT			&#8211; ADO Command object properties pointer<br />
&#8211;DECLARE @ADOcommpropVal INT			&#8211; ADO Command object properties value pointer<br />
DECLARE @ADOrs INT					&#8211; ADO RecordSet object<br />
DECLARE @OLEReturn INT				&#8211; OLE return value<br />
&#8211;DECLARE @src varchar(255)			&#8211; OLE Error Source<br />
&#8211;DECLARE @desc varchar(255)			&#8211; OLE Error Description<br />
DECLARE @SQL VARCHAR (8000)			&#8211; LDAP query string<br />
&#8211;DECLARE @Batch_ID INT<br />
&#8211;DECLARE @Login VARBINARY (85)<br />
&#8211;DECLARE @CN VARCHAR (512)<br />
&#8211;DECLARE @CT INT<br />
DECLARE @ADRoot VARCHAR (255)</p>
<p>&#8211; Set the Active Directory root domain<br />
SET @ADRoot = &#8216;LDAP://DC=<domain1>,DC=<com ,net,etc.>&#8216;</p>
<p>&#8211; Retrieve Active Directory users<br />
SET @SQL = &#8216;SELECT<br />
	Manager,<br />
	Name,<br />
	TelephoneNumber,<br />
	Department,<br />
	Title,<br />
	userAccountControl,<br />
	whenChanged,<br />
	whenCreated,<br />
	SN,<br />
	initials,<br />
	givenName,<br />
	distinguishedName,<br />
	samAccountName,<br />
	objectSid,<br />
	mail<br />
	FROM &#8221;&#8217; + @ADRoot + &#8221;&#8217;<br />
	WHERE objectCategory = &#8221;User&#8221;&#8217;</p>
<p>EXEC @OLEReturn = SetupOLE @SQL, @ADOConn OUT, @ADOcomm OUT, @ADOrs OUT</p>
<p>IF @OLEReturn <> 0<br />
	RETURN</p>
<p>TRUNCATE TABLE <active Directory login table></p>
<p>INSERT INTO </active><active Directory login table> (EMail, sid, Login, DistName, FirstName, Initials, LastName, CreatedDate, ChangedDate, AcctCtrl, Title, Dept, Phone, FullName, Mgr)<br />
EXEC @OLEReturn = sp_OAgetproperty @ADOrs, &#8216;getrows&#8217;</p>
<p>IF @OLEReturn <> 0<br />
	BEGIN<br />
	PRINT @OLEReturn<br />
	RETURN<br />
	END</p>
<p>EXEC @OLEReturn = DestroyOLE @ADOconn, @ADOcomm, @ADOrs</p>
<p>IF @OLEReturn <> 0<br />
	RETURN<br />
&#8211; End Active Directory users</p>
<p>&#8211; Retrieve Active Directory groups<br />
SET @SQL = &#8216;SELECT<br />
	objectSid,<br />
	managedBy,<br />
	whenChanged,<br />
	whenCreated,<br />
	distinguishedName,<br />
	name,<br />
	samAccountName,<br />
	mail<br />
	FROM &#8221;&#8217; + @ADRoot + &#8221;&#8217;<br />
	WHERE objectCategory = &#8221;Group&#8221;&#8217;</p>
<p>EXEC @OLEReturn = SetupOLE @SQL, @ADOConn OUT, @ADOcomm OUT, @ADOrs OUT</p>
<p>IF @OLEReturn <> 0<br />
	RETURN</p>
<p>TRUNCATE TABLE </active><active Directory group table></p>
<p>INSERT INTO </active><active Directory group table> (EMail, Login, AcctName, DistName, CreatedDate, ChangedDate, Mgr, sid)<br />
EXEC @OLEReturn = sp_OAgetproperty @ADOrs, &#8216;getrows&#8217;</p>
<p>IF @OLEReturn <> 0<br />
	RETURN</p>
<p>EXEC @OLEReturn = DestroyOLE @ADOconn, @ADOcomm, @ADOrs</p>
<p>IF @OLEReturn <> 0<br />
	RETURN<br />
&#8211; End Active Directory groups</p>
<p>/* END SAMPLE CODE */</p>
<p>Now this is all well and good, but what if you want the Active Directory group membership information? Stay tuned &#8230;</active></com></domain1></p>
</div>
					</div>
				</li>
					<li id="dsq-comment-189">
					<div id="dsq-comment-header-189" class="dsq-comment-header">
						<cite id="dsq-cite-189">
								<span id="dsq-author-user-189">Dave Naples</span>
							</cite>
					</div>
					<div id="dsq-comment-body-189" class="dsq-comment-body">
						<div id="dsq-comment-message-189" class="dsq-comment-message"><p>ACTIVE DIRECTORY RETRIEVAL FROM SQL: PART 3</p>
<p>Now, the more astute among you may have noticed that there were actually TWO &#8220;part 2&#8243; sections. You may be wondering as to the metaphysical implications of this.</p>
<p>Don&#8217;t sweat it. It means nothing. It was just a typo, fer cryin&#8217; out loud. That being said &#8230;</p>
<p>Our next task, now that we have successfully retrieved both user a group information, is to tie to two together. We do this by using the &#8220;memberof&#8221; property in LDAP.</p>
<p>&#8220;Well, if there&#8217;s a <memberof> property, why didn&#8217;t we just query it when we were retrieving the user information?&#8221; you mght ask, if you were here, but you&#8217;re not, so I&#8217;ll go ahead and assume that you DID ask and answer the question anyway.</p>
<p>The reasonm this doesn&#8217;t work is that group membership in Active Directory is a many-to-many relationship (a user can be a member of 1 to n groups, and each group can have 0 to n users). So if you query the </memberof><memberof> property directly you will get a null result. This happens because AD returns the contents of this property as an array, and since SQL Server doesn&#8217;t know what to do with arrays it simply throws up its hands and says &#8220;Ah, there ain&#8217;t nuthin&#8217; there.&#8221;</p>
<p>So what we have to do, as painful and annoying as it sounds, is to open up a cursor containing a list of all the AD groups we retrieved earlier, and retrieve AD users that are a member of each group.</p>
<p>We WILL be using a linked server here. There are a couple of reasons for this:</p>
<p>1) Most of the groups retrieved are in all likelihood very specialized and will have fewer than 1000 members. Using a linked server will increase performance.</p>
<p>2) The number of OLE handles is limited (mainly by memory usage). We could try to use the OLE calls for each group, and explicitly destroy each handle after each call. This should prevent the number of handles from exceeding system capacity, right?</p>
<p>That&#8217;s what I thought, too. As it turns out, though, even if handles are explictly destroyed they remain in the cache UNTIL THE BATCH COMPLETES. If there are more than a couple hundred AD groups, the procedure will error out (can&#8217;t remember the exact error, but trust me &#8230; it won&#8217;t work).</p>
<p>That being said, here&#8217;s some sample code:</p>
<p>/* BEGIN SAMPLE CODE */<br />
DECLARE @ADOconn INT				&#8211; ADO Connection object<br />
DECLARE @ADOcomm INT				&#8211; ADO Command object<br />
DECLARE @ADOrs INT					&#8211; ADO RecordSet object<br />
DECLARE @OLEReturn INT				&#8211; OLE return value<br />
DECLARE @SQL VARCHAR (8000)			&#8211; LDAP query string<br />
DECLARE @Login VARBINARY (85)<br />
DECLARE @CN VARCHAR (512)<br />
DECLARE @CT INT<br />
DECLARE @ADRoot VARCHAR (255)</p>
<p>&#8211; Truncate the table used to hold user/group correlation information<br />
TRUNCATE TABLE <user /group correlation table></p>
<p>&#8211; Create a temporary table to hold AD user SID values<br />
CREATE TABLE #CT (CT VARBINARY (85))</p>
<p>&#8211; Declare and open a cursor to step through the list of Active Directory groups<br />
DECLARE curGroups CURSOR FOR<br />
	SELECT<br />
	sid, DistName<br />
	FROM <active Directory group table><br />
	ORDER BY Login<br />
OPEN curGroups<br />
FETCH NEXT FROM curGroups INTO @Login, @CN<br />
WHILE @@FETCH_STATUS = 0<br />
	BEGIN<br />
	&#8211; Empty the temp table<br />
	TRUNCATE TABLE #CT</p>
<p>	&#8211; Build a SQL statement to insert the SID values directly from the linked server into the temp table<br />
	SET @SQL = &#8216;INSERT #CT<br />
	SELECT *<br />
	FROM OPENQUERY (<br />
		ADSI,<br />
		&#8221;SELECT objectSid<br />
		FROM &#8221;&#8221;&#8217; + @ADRoot + &#8221;&#8221;&#8217;<br />
		WHERE objectCategory = &#8221;&#8221;User&#8221;&#8221;<br />
		AND memberof=&#8221;&#8221;&#8217; + REPLACE (@CN, &#8221;&#8221;, &#8221;&#8221;&#8221;&#8221;&#8221;) + &#8221;&#8221;&#8221;&#8217;)&#8217;</p>
<p>	EXEC (@SQL)</p>
<p>	&#8211; Select the number of records inserted. If this value is less than 1000 then there is no need<br />
	&#8211; to execute the OLE calls, and we simply copy the values into the correlation table.<br />
	SELECT @CT = COUNT(*) FROM #CT</p>
<p>	IF @CT < 1000<br />
		BEGIN<br />
		IF @CT <> 0<br />
			BEGIN<br />
			INSERT <user /group correlation table> (UserLogin, GroupLogin)<br />
			SELECT CT, @Login<br />
			FROM #CT<br />
			WHERE CT IS NOT NULL<br />
			END<br />
		END<br />
	ELSE<br />
		BEGIN<br />
		&#8211; Execute the OLE calls<br />
		SET @SQL = &#8216;SELECT objectSid FROM &#8221;&#8217; + @ADRoot + &#8221;&#8217; WHERE objectCategory = &#8221;User&#8221; AND memberof=&#8221;&#8217; + @CN + &#8221;&#8221;</p>
<p>		EXEC @OLEReturn = SetupOLE @SQL, @ADOConn OUT, @ADOcomm OUT, @ADOrs OUT</p>
<p>		IF @OLEReturn <> 0<br />
			RETURN</p>
<p>		INSERT INTO </user><user /group correlation table> (UserLogin)<br />
		EXEC @OLEReturn = sp_OAgetproperty @ADOrs, &#8216;getrows&#8217;</p>
<p>		&#8211; If the @OLEReturn value is not zero, this indicates an error condition. However, one of these<br />
		&#8211; conditions (800A0BCD, aka -2146825267) indicates that the procedure executed successfully but<br />
		&#8211; that no rows were found that matched the criteria. Therefore, for our purposes, this is NOT an<br />
		&#8211; error but a valid return condition.<br />
		IF (@OLEReturn <> 0) AND (@OLEReturn <> -2146825267)<br />
			RETURN</p>
<p>		&#8211; If rows were found we update the rows in the correlation table with the name of the AD group.<br />
		IF @OLEReturn <> -2146825267<br />
			UPDATE </user><user /group correlation table><br />
			SET GroupLogin = @Login<br />
			WHERE GroupLogin IS NULL</p>
<p>		&#8211; If no rows were returned, we reset the @OLEReturn value to indicate that there was no error<br />
		&#8211; condition encountered.<br />
		IF @OLEReturn = -2146825267<br />
			SET @OLEReturn = 0</p>
<p>		IF @OLEReturn <> 0<br />
			GOTO CursorError</p>
<p>		EXEC @OLEreturn = sp_OADestroy @ADOconn</p>
<p>		IF @OLEReturn <> 0<br />
			GOTO CursorError<br />
		END</p>
<p>	FETCH NEXT FROM curGroups INTO @Login, @CN<br />
	END<br />
CursorError:<br />
CLOSE curGroups<br />
DEALLOCATE curGroups</p>
<p>DROP TABLE #CT<br />
/* END SAMPLE CODE */</user></active></user></memberof></p>
</div>
					</div>
				</li>
					<li id="dsq-comment-190">
					<div id="dsq-comment-header-190" class="dsq-comment-header">
						<cite id="dsq-cite-190">
								<span id="dsq-author-user-190">Steve Moreno</span>
							</cite>
					</div>
					<div id="dsq-comment-body-190" class="dsq-comment-body">
						<div id="dsq-comment-message-190" class="dsq-comment-message"><p>Dave,</p>
<p>Your scripts are great examples.  However, your last script &#8220;part 3&#8243; errors out before it populates the correlation table.  Thoughts?</p>
</div>
					</div>
				</li>
					<li id="dsq-comment-191">
					<div id="dsq-comment-header-191" class="dsq-comment-header">
						<cite id="dsq-cite-191">
								<span id="dsq-author-user-191">Steve Moreno</span>
							</cite>
					</div>
					<div id="dsq-comment-body-191" class="dsq-comment-body">
						<div id="dsq-comment-message-191" class="dsq-comment-message"><p>Dave,</p>
<p>Got &#8220;part 3&#8243; working by adding:</p>
<p>SET @ADRoot = &#8216;LDAP://DC=xyz,DC=abc,DC=com&#8217;</p>
<p>to just after the declaration section but now I&#8217;m stuck again with binary data in those columns rather than varchars.  Was this the intent of your scripts?</p>
</div>
					</div>
				</li>
					<li id="dsq-comment-192">
					<div id="dsq-comment-header-192" class="dsq-comment-header">
						<cite id="dsq-cite-192">
								<span id="dsq-author-user-192">Ed</span>
							</cite>
					</div>
					<div id="dsq-comment-body-192" class="dsq-comment-body">
						<div id="dsq-comment-message-192" class="dsq-comment-message"><p>A query such as this would tie the users name to the group name.</p>
<p>SELECT u.Login AS UserName, ug.Login AS GroupName<br />
FROM ADGroupUserCorrelationTable<br />
 INNER JOIN ADGroupTable ug<br />
  ON GroupLogin = ug.sid<br />
 INNER JOIN ADLoginTable u<br />
  ON UserLogin = u.sid</p>
</div>
					</div>
				</li>
					<li id="dsq-comment-193">
					<div id="dsq-comment-header-193" class="dsq-comment-header">
						<cite id="dsq-cite-193">
								<span id="dsq-author-user-193">Need Help!!</span>
							</cite>
					</div>
					<div id="dsq-comment-body-193" class="dsq-comment-body">
						<div id="dsq-comment-message-193" class="dsq-comment-message"><p>Hi,<br />
 Is it possible to Disable an account in AD by creating a Linked Server in SQL 2005??<br />
 I was able to create a view to get all the information that I need and I can see the &#8216;accountExpires&#8217; information, but cannot change it. Any ideas on that??<br />
Thanks,</p>
</div>
					</div>
				</li>
					<li id="dsq-comment-194">
					<div id="dsq-comment-header-194" class="dsq-comment-header">
						<cite id="dsq-cite-194">
								<span id="dsq-author-user-194">Nick2345</span>
							</cite>
					</div>
					<div id="dsq-comment-body-194" class="dsq-comment-body">
						<div id="dsq-comment-message-194" class="dsq-comment-message"><p>I&#8217;m having a problem with error 7321:</p>
<p>An error occurred while preparing the query &#8220;SELECT samAccountName, </p>
<p>      givenName, sn, legacyExchangeDN</p>
<p>   FROM &#8216;LDAP://askcts.com/OU=Users,OU=BHMRiverchase,OU=CTS Corporate,DC=askcts,DC=com&#8217;<br />
   WHERE objectClass=&#8217;Person&#8217; AND objectClass = &#8216;User&#8221;<br />
   WHERE objectClass=&#8217;Person&#8217;</p>
<p>   AND objectClass = &#8216;User&#8217;&#8221; for execution against OLE DB provider &#8220;ADSDSOObject&#8221; for linked server &#8220;ADSI&#8221;. </p>
<p>I don&#8217;t know what&#8217;s going on.  I disabled security context on the linked server, as others instructed.  I&#8217;m confident that it&#8217;s not a syntax error because the guy next to me can run this query just fine.  The only thing I haven&#8217;t checked is the whole local vs. domain account issue since I&#8217;m not sure where to look that up.  Anyone know how to fix the issue?</p>
</div>
					</div>
				</li>
					<li id="dsq-comment-195">
					<div id="dsq-comment-header-195" class="dsq-comment-header">
						<cite id="dsq-cite-195">
								<span id="dsq-author-user-195">kevin</span>
							</cite>
					</div>
					<div id="dsq-comment-body-195" class="dsq-comment-body">
						<div id="dsq-comment-message-195" class="dsq-comment-message"><p>Thanks for the artical, First time go on my part.</p>
<p>Quick note on my network, Needed to change security on ADSI Linked server to login as Network Admin</p>
</div>
					</div>
				</li>
					<li id="dsq-comment-196">
					<div id="dsq-comment-header-196" class="dsq-comment-header">
						<cite id="dsq-cite-196">
								<span id="dsq-author-user-196">mmoore225</span>
							</cite>
					</div>
					<div id="dsq-comment-body-196" class="dsq-comment-body">
						<div id="dsq-comment-message-196" class="dsq-comment-message"><p>Nick2345, it looks like you should be using objectCategory=&#8217;Person&#8217; instead of objectClass=&#8217;Person&#8217; .</p>
<p>objectClass=&#8217;User&#8217; is correct.  You also have your WHERE twice.</p>
</div>
					</div>
				</li>
					<li id="dsq-comment-197">
					<div id="dsq-comment-header-197" class="dsq-comment-header">
						<cite id="dsq-cite-197">
								<span id="dsq-author-user-197">DH</span>
							</cite>
					</div>
					<div id="dsq-comment-body-197" class="dsq-comment-body">
						<div id="dsq-comment-message-197" class="dsq-comment-message"><p>Ha, I wish I&#8217;d seen this way earlier, I&#8217;ve been importing a csvde dump from a text file for ages.. Thanks!</p>
</div>
					</div>
				</li>
					<li id="dsq-comment-198">
					<div id="dsq-comment-header-198" class="dsq-comment-header">
						<cite id="dsq-cite-198">
								<span id="dsq-author-user-198">Rashid</span>
							</cite>
					</div>
					<div id="dsq-comment-body-198" class="dsq-comment-body">
						<div id="dsq-comment-message-198" class="dsq-comment-message"><p>Hello Brendon<br />
Thanks for the info regarding AD.</p>
<p>I&#8217;m using the following query<br />
SELECT * FROM OpenQuery<br />
(ADSI,<br />
&#8216;SELECT objectSid,<br />
                 title,<br />
		displayName,<br />
		sAMAccountName,<br />
		givenName,<br />
		telephoneNumber,<br />
		facsimileTelephoneNumber,<br />
		mail,<br />
		userAccountControl,<br />
        company,<br />
		department,<br />
		name,<br />
		sn<br />
FROM &#8221;LDAP://DC=nr,DC=ad,DC=xyzco,DC=com&#8221;<br />
WHERE     objectCategory=&#8221;Person&#8221;<br />
      and objectClass = &#8221;User&#8221;<br />
ORDER BY name&#8217;)</p>
<p>This works fine, but only for 1000 objects, I know a lot of people have been talking about this but is&#8217;nt there a simple property or parameter I can use for this in the above code</p>
</div>
					</div>
				</li>
					<li id="dsq-comment-199">
					<div id="dsq-comment-header-199" class="dsq-comment-header">
						<cite id="dsq-cite-199">
	http://eidermauricio.blogspot.com							<span id="dsq-author-user-199">eider mauricio aristizabal erazo</span>
							</cite>
					</div>
					<div id="dsq-comment-body-199" class="dsq-comment-body">
						<div id="dsq-comment-message-199" class="dsq-comment-message"><p>Make it easy,<br />
See muy Blog at:<br />
<a href="http://eidermauricio.blogspot.com/2007/10/consultas-contra-el-directorio-activo_31.html" rel="nofollow">http://eidermauricio.blogspot.com/2007/10/consultas-contra-el-directorio-activo_31.html</a><br />
I made an article that guide you step by step<br />
eider d colombia con gusto</p>
</div>
					</div>
				</li>
					<li id="dsq-comment-200">
					<div id="dsq-comment-header-200" class="dsq-comment-header">
						<cite id="dsq-cite-200">
								<span id="dsq-author-user-200">Richard Beal</span>
							</cite>
					</div>
					<div id="dsq-comment-body-200" class="dsq-comment-body">
						<div id="dsq-comment-message-200" class="dsq-comment-message"><p>We have around 30,000 people, so I&#8217;ve extended Brendan&#8217;s solution to 3 levels, and less coding. Its probably a bit slower, but captures everyone in our organisation. </p>
<p>-The insertion/update/deleting to an ADcopy table I do in another set of code not included here.<br />
-There are more fields I try to capture from AD than Brendan&#8217;s solution.</p>
<p>Any comments welcome&#8230;</p>
<p>declare<br />
@AlphaChars varchar(60)<br />
, @search varchar(10)<br />
, @searchLevel1 varchar(1)<br />
, @searchLevel2 varchar(1)<br />
, @searchLevel3 varchar(1)<br />
, @countLevel1 int<br />
, @countLevel2 int<br />
, @countLevel3 int</p>
<p>, @intRowCount int<br />
, @SQL nvarchar(4000)</p>
<p>, @nvarOU nvarchar(200)<br />
, @nvchDC nvarchar(100)<br />
, @nvchCN varchar(256)</p>
<p>set @nvchDC = &#8216;DC=your_domain,DC=com&#8217;<br />
set @nvarOU = &#8216;OU=SQL Test&#8217; &#8211;set equal to &#8221; if not needed</p>
<p>&#8211; any chars, but the first char must be a space<br />
set @AlphaChars = &#8216; ABCDEFGHIJKLMNOPQRSTUVWXYZ.-_`0123456789&#8242;</p>
<p>set nocount on</p>
<p>if exists (select * from tempdb.dbo.sysobjects where id = object_id(&#8216;tempdb.dbo.#LDAP&#8217;))<br />
drop table #LDAP</p>
<p>create table [dbo].[#ldap] (<br />
	[row_id] [int] IDENTITY (1, 1) NOT NULL ,<br />
	sAMAccountName [nvarchar] (256) collate sql_latin1_general_cp1_ci_as null,<br />
	[cn] [nvarchar] (256) collate sql_latin1_general_cp1_ci_as null ,<br />
	[sn] [nvarchar] (256) collate sql_latin1_general_cp1_ci_as null ,<br />
	displayName [nvarchar] (256) collate sql_latin1_general_cp1_ci_as null,<br />
	givenName [nvarchar] (256) collate sql_latin1_general_cp1_ci_as null,<br />
	telephoneNumber [nvarchar] (256) collate sql_latin1_general_cp1_ci_as null,<br />
	[adspath] [nvarchar] (256) collate sql_latin1_general_cp1_ci_as null,<br />
	[homedirectory] [nvarchar] (256) collate sql_latin1_general_cp1_ci_as null,<br />
	[mail] [nvarchar] (256) collate sql_latin1_general_cp1_ci_as null,<br />
	[memberof] [nvarchar] (256) collate sql_latin1_general_cp1_ci_as null,<br />
	[primarygroupid] [int],<br />
	createTimeStamp datetime<br />
	)  ON [PRIMARY] </p>
<p>&#8211; start on non space char<br />
set @countLevel1 =2<br />
&#8211; first level loop<br />
while @countLevel1 < = len(@AlphaChars)<br />
begin<br />
	-- get first level char<br />
	set @searchLevel1=substring(@AlphaChars, @countLevel1, 1)<br />
	-- reset start on space<br />
	set @countLevel2 =1</p>
<p>	-- second level loop<br />
	while @countLevel2 <= len(@AlphaChars)<br />
	begin</p>
<p>		-- reset start on space<br />
		set @countLevel3 =1</p>
<p>		-- third level loop<br />
		while @countLevel3 <= len(@AlphaChars)<br />
		begin<br />
			-- setup the string to search for. By using the trim function we can form each level depending on no records<br />
			-- eg A 99, B 1000 > BA 9, BB 20 etc</p>
<p>			&#8211; trim the spaces forming just A, B, C ; AA, AB for search etc<br />
			set @searchLevel1=substring(@AlphaChars, @countLevel1, 1)<br />
			set @searchLevel2=rtrim(substring(@AlphaChars, @countLevel2, 1))<br />
			set @searchLevel3=rtrim(substring(@AlphaChars, @countLevel3, 1))<br />
			set @search=@searchLevel1 + @searchLevel2 + @searchLevel3</p>
<p>			set @SQL =&#8217;insert into #ldap (cn,sn,displayName, sAMAccountName, givenName, telephoneNumber, adspath,  homedirectory, mail, primarygroupid, createTimeStamp) &#8216; +<br />
					&#8216;select cn,sn,displayName, sAMAccountName, givenName, telephoneNumber, adspath,  homedirectory, mail, primarygroupid, createTimeStamp &#8216; +<br />
					&#8216;from openquery(ADSI,&#8221;<ldap: //root>;(&#038;(objectCategory=Person)(!(UserAccountControl:1.2.840.113556.1.4.803:=2))(sAMAccountName=&#8217; +<br />
					@search + &#8216;*));cn,sn,displayName, sAMAccountName, givenName, telephoneNumber, adspath, homedirectory, mail, adspath, primarygroupid, createTimeStamp;subtree&#8221;) q &#8216;+<br />
					&#8216;where not exists (select adspath from #ldap ld where ld.adspath collate sql_latin1_general_cp1_ci_as= q.adspath) &#8216; +<br />
					&#8216;order by sAMAccountName&#8217;<br />
			exec sp_executesql @SQL</p>
<p>			set @intRowCount = @@rowcount<br />
			&#8211; prints what string is being searched for : no of inserts<br />
			print @search + &#8216; : &#8216; + convert(varchar, @intRowCount)</p>
<p>			&#8211; if searched on @searchLevel1 and under 1000 then everything is fine so skip search2 to next search1 eg A > B<br />
			if @intRowCount < 1000 and @searchLevel2='' set @countLevel2=@countLevel2 +100	</p>
<p>			-- if searched on @searchLevel2 and under 1000 then everything is fine so skip to next search2 eg AA > AB<br />
			if @intRowCount < 1000 and @searchLevel3=&#8221; set @countLevel3=@countLevel3 +100</p>
<p>			&#8211; else over 1000 so increment third level<br />
			set @countLevel3=@countLevel3 + 1</p>
<p>		end<br />
		&#8211; increment next second level char<br />
		set @countLevel2=@countLevel2 +1<br />
	end<br />
	&#8211; increment next first level char<br />
	set @countLevel1=@countLevel1 +1<br />
end</p>
<p>set nocount off</ldap:></p>
</div>
					</div>
				</li>
					<li id="dsq-comment-201">
					<div id="dsq-comment-header-201" class="dsq-comment-header">
						<cite id="dsq-cite-201">
								<span id="dsq-author-user-201">Joseph Brown</span>
							</cite>
					</div>
					<div id="dsq-comment-body-201" class="dsq-comment-body">
						<div id="dsq-comment-message-201" class="dsq-comment-message"><p>Dave&#8230;thanks for the code.  Everything works fine until I try to add the accountExpires field?  I know that this is 64bit value, and I have done enough research to translate it into a usuable format.  I can pull the field whenever I use the linked server and not the above code, but of course i am then limited to 1000 records.</p>
<p>Does anyone know of a way to retrieve the accountExpires field via Dave&#8217;s code?</p>
<p>Any help would be appreciated.</p>
</div>
					</div>
				</li>
					<li id="dsq-comment-202">
					<div id="dsq-comment-header-202" class="dsq-comment-header">
						<cite id="dsq-cite-202">
								<span id="dsq-author-user-202">MJTech</span>
							</cite>
					</div>
					<div id="dsq-comment-body-202" class="dsq-comment-body">
						<div id="dsq-comment-message-202" class="dsq-comment-message"><p>Wow!<br />
I have been looking for this info for about a month now.<br />
I&#8217;m a novice so I need to digest more but pretty much along the lines of what I have been trying to do.  Thanks much for all this info folks</p>
</div>
					</div>
				</li>
					<li id="dsq-comment-203">
					<div id="dsq-comment-header-203" class="dsq-comment-header">
						<cite id="dsq-cite-203">
								<span id="dsq-author-user-203">Mike</span>
							</cite>
					</div>
					<div id="dsq-comment-body-203" class="dsq-comment-body">
						<div id="dsq-comment-message-203" class="dsq-comment-message"><p>Great lessons! But could someone PLEASE show me how to add Active Directory Users to a table with Insert, Update and Delete? I&#8217;m looking for a Stored Procedure that does this once a day.</p>
<p>Thanks,</p>
</div>
					</div>
				</li>
					<li id="dsq-comment-204">
					<div id="dsq-comment-header-204" class="dsq-comment-header">
						<cite id="dsq-cite-204">
								<span id="dsq-author-user-204">Gary</span>
							</cite>
					</div>
					<div id="dsq-comment-body-204" class="dsq-comment-body">
						<div id="dsq-comment-message-204" class="dsq-comment-message"><p>For those of you have issues with the 1000 row limit you can change the default maxPageSize on the domain controller using NTDSUtil.  You still may have an issue if for performance issues you can&#8217;t set it above say 10000, I&#8217;m not sure how high you want to go.  I used 10000 and now I can query all my users without any workaround.  I&#8217;m surprised I haven&#8217;t seen this mentioned specifically when people have questions about the 1000 row limit.</p>
<p>Cheers</p>
<p>For more information about how to modify the server limit for maxPageSize by using NTDSUtil, click the following article number to view the article in the Microsoft Knowledge Base:<br />
315071 (<a href="http://support.microsoft.com/kb/315071/" rel="nofollow">http://support.microsoft.com/kb/315071/</a>) How to view and set LDAP policy in Active Directory by using Ntdsutil.exe</p>
</div>
					</div>
				</li>
					<li id="dsq-comment-205">
					<div id="dsq-comment-header-205" class="dsq-comment-header">
						<cite id="dsq-cite-205">
								<span id="dsq-author-user-205">Joshua Perry</span>
							</cite>
					</div>
					<div id="dsq-comment-body-205" class="dsq-comment-body">
						<div id="dsq-comment-message-205" class="dsq-comment-message"><p>I pull 50,000 users every day.  I use a vbscript to get around the 1000 record limit and write to the SQL server.  This also gives me a static table instead of a view.  The adspath gets stored in the table so I can pull different OUs.  It would look like this:</p>
<p>LDAP://dcserver/OU=users,DC=domain,DC=forest,DC=tld</p>
<p>USE [DATABASE]<br />
GO<br />
/****** Object:  Table [dbo].[ActiveDirectory] ******/<br />
SET ANSI_NULLS ON<br />
GO<br />
SET QUOTED_IDENTIFIER ON<br />
GO<br />
SET ANSI_PADDING ON<br />
GO<br />
CREATE TABLE [dbo].[ActiveDirectory](<br />
	[manager] [varchar](1024) NULL,<br />
	[company] [varchar](1024) NULL,<br />
	[department] [varchar](1024) NULL,<br />
	[title] [varchar](1024) NULL,<br />
	[facsimileTelephoneNumber] [varchar](1024) NULL,<br />
	[info] [varchar](1024) NULL,<br />
	[ipPhone] [varchar](1024) NULL,<br />
	[mobile] [varchar](1024) NULL,<br />
	[pager] [varchar](1024) NULL,<br />
	[homePhone] [varchar](1024) NULL,<br />
	[HomeDrive] [varchar](1024) NULL,<br />
	[HomeDirectory] [varchar](1024) NULL,<br />
	[ScriptPath] [varchar](1024) NULL,<br />
	[ProfilePath] [varchar](1024) NULL,<br />
	[userWorkstations] [varchar](1024) NULL,<br />
	[samAccountName] [varchar](50) NULL,<br />
	[userPrincipalName] [varchar](50) NULL,<br />
	 [varchar](1024) NULL,<br />
	[postalCode] [varchar](1024) NULL,<br />
	[st] [varchar](1024) NULL,<br />
	[l] [varchar](1024) NULL,<br />
	[streetAddress] [varchar](1024) NULL,<br />
	[mail] [varchar](1024) NULL,<br />
	[telephoneNumber] [varchar](1024) NULL,<br />
	[physicalDeliveryOfficeName] [varchar](1024) NULL,<br />
	[displayName] [varchar](1024) NULL,<br />
	[sn] [varchar](1024) NULL,<br />
	[initials] [varchar](1024) NULL,<br />
	[givenName] [varchar](1024) NULL<br />
) ON [PRIMARY]</p>
<p>GO<br />
SET ANSI_PADDING OFF</p>
<p>USE [DATABASE]<br />
GO<br />
/****** Object:  Table [dbo].[OU] ******/<br />
SET ANSI_NULLS ON<br />
GO<br />
SET QUOTED_IDENTIFIER ON<br />
GO<br />
CREATE TABLE [dbo].[AccountsOUs](<br />
	[ADsPath] [ntext] NULL,<br />
	[rec_id] [int] IDENTITY(1,1) NOT NULL<br />
) ON [PRIMARY] TEXTIMAGE_ON [PRIMARY]</p>
<p>==================================================================</p>
<p>Option Explicit</p>
<p>Dim adoCommand, _<br />
adoConnection, _<br />
strBase, _<br />
strFilter, _<br />
strAttributes</p>
<p>Dim objRootDSE, _<br />
strDNSDomain, _<br />
strQuery, _<br />
adoRecordset</p>
<p>Dim givenName, _<br />
initials, _<br />
sn, _<br />
displayName, _<br />
physicalDeliveryOfficeName, _<br />
telephoneNumber, _<br />
mail, _<br />
streetAddress, _<br />
l, _<br />
st, _<br />
postalCode, _<br />
c, _<br />
userPrincipalName, _<br />
samAccountName, _<br />
userWorkstations, _<br />
ProfilePath, _<br />
ScriptPath, _<br />
HomeDirectory, _<br />
HomeDrive, _<br />
homePhone, _<br />
pager, _<br />
mobile, _<br />
ipPhone, _<br />
info, _<br />
facsimileTelephoneNumber, _<br />
title, _<br />
department, _<br />
company, _<br />
manager</p>
<p>Dim sqlCommand, _<br />
sqlConnection </p>
<p>Dim  adPath, _<br />
adSql, _<br />
adConnection</p>
<p>&#8216; Setup ADO objects.</p>
<p>Set adoCommand = CreateObject(&#8220;ADODB.Command&#8221;)<br />
Set adoConnection = CreateObject(&#8220;ADODB.Connection&#8221;)</p>
<p>set sqlConnection = CreateObject(&#8220;ADODB.Connection&#8221;)<br />
Set sqlCommand = CreateObject(&#8220;ADODB.Command&#8221;)</p>
<p>Set adPath = CreateObject(&#8220;ADODB.Recordset&#8221;)<br />
Set adConnection = CreateObject(&#8220;ADODB.Connection&#8221;)<br />
set adSql= CreateObject(&#8220;ADODB.Command&#8221;)</p>
<p>adSql.CommandText = &#8220;TRUNCATE TABLE ActiveDirectory; SELECT adspath FROM OU WHERE rec_id = 1&#8243;<br />
adConnection.Open &#8220;Driver={SQL Server};server=SERVER,PORT;&#8221; &#038; _<br />
&#8220;database=DATABASE;uid=USER;pwd=PASSWORD;&#8221;<br />
adSql.ActiveConnection = adConnection<br />
Set adPath = adSql.Execute</p>
<p>Do Until adpath.EOF<br />
    adoConnection.Provider = &#8220;ADsDSOObject&#8221;<br />
    adoConnection.Open &#8220;Active Directory Provider&#8221;<br />
    adoCommand.ActiveConnection = adoConnection</p>
<p>    &#8216; Search entire Active Directory domain.</p>
<p>    strDNSDomain = adPath(&#8220;ADsPath&#8221;)<br />
    strBase = &#8220;< "&#038; strDNSDomain &#038;">&#8221;</p>
<p>    &#8216; Filter on user objects.<br />
    strFilter = &#8220;(&#038;(objectClass=user))&#8221;</p>
<p>    &#8216; Comma delimited list of attribute values to retrieve.<br />
    strAttributes = &#8220;givenName,&#8221; &#038; _<br />
    &#8220;initials,&#8221; &#038; _<br />
    &#8220;sn,&#8221; &#038; _<br />
    &#8220;displayName,&#8221; &#038; _<br />
    &#8220;physicalDeliveryOfficeName,&#8221; &#038; _<br />
    &#8220;telephoneNumber,&#8221; &#038; _<br />
    &#8220;mail,&#8221; &#038; _<br />
    &#8220;streetAddress,&#8221; &#038; _<br />
    &#8220;l,&#8221; &#038; _<br />
    &#8220;st,&#8221; &#038; _<br />
    &#8220;postalCode,&#8221; &#038; _<br />
    &#8220;c,&#8221; &#038; _<br />
    &#8220;userPrincipalName,&#8221; &#038; _<br />
    &#8220;samAccountName,&#8221; &#038; _<br />
    &#8220;userWorkstations,&#8221; &#038; _<br />
    &#8220;ProfilePath,&#8221; &#038; _<br />
    &#8220;ScriptPath,&#8221; &#038; _<br />
    &#8220;HomeDirectory,&#8221; &#038; _<br />
    &#8220;HomeDrive,&#8221; &#038; _<br />
    &#8220;homePhone,&#8221; &#038; _<br />
    &#8220;pager,&#8221; &#038; _<br />
    &#8220;mobile,&#8221; &#038; _<br />
    &#8220;ipPhone,&#8221; &#038; _<br />
    &#8220;info,&#8221; &#038; _<br />
    &#8220;facsimileTelephoneNumber,&#8221; &#038; _<br />
    &#8220;title,&#8221; &#038; _<br />
    &#8220;department,&#8221; &#038; _<br />
    &#8220;company,&#8221; &#038; _<br />
    &#8220;manager&#8221;</p>
<p>    &#8216; Construct the LDAP syntax query.<br />
    strQuery = strBase &#038; &#8220;;&#8221; &#038; strFilter &#038; &#8220;;&#8221; &#038; strAttributes</p>
<p>    adoCommand.CommandText = strQuery<br />
    adoCommand.Properties(&#8220;Page Size&#8221;) = 1000<br />
    adoCommand.Properties(&#8220;Timeout&#8221;) = 30<br />
    adoCommand.Properties(&#8220;Cache Results&#8221;) = False</p>
<p>    &#8216; Run the query.<br />
    Set adoRecordset = adoCommand.Execute</p>
<p>    &#8216; Enumerate the resulting recordset.<br />
    Do Until adoRecordset.EOF</p>
<p>        &#8216; Retrieve values and display.<br />
        givenName= adoRecordset.Fields(&#8220;givenName&#8221;).Value<br />
        initials= adoRecordset.Fields(&#8220;initials&#8221;).Value<br />
        sn=adoRecordset.Fields(&#8220;sn&#8221;).Value<br />
        displayName= adoRecordset.Fields(&#8220;displayname&#8221;).Value<br />
        physicalDeliveryOfficeName = adoRecordset.Fields(&#8220;physicalDeliveryofficename&#8221;).Value<br />
        telephoneNumber= adoRecordset.Fields(&#8220;telephonenumber&#8221;).Value<br />
        mail=adoRecordset.Fields(&#8220;mail&#8221;).Value<br />
        streetAddress=adoRecordset.Fields(&#8220;streetaddress&#8221;).Value<br />
        l=adoRecordset.Fields(&#8220;l&#8221;).Value<br />
        st=adoRecordset.Fields(&#8220;st&#8221;).Value<br />
        postalCode=adoRecordset.Fields(&#8220;postalcode&#8221;).Value<br />
        c=adoRecordset.Fields(&#8220;c&#8221;).Value<br />
        userPrincipalName=adoRecordset.Fields(&#8220;userprincipalname&#8221;).Value<br />
        samAccountName=adoRecordset.Fields(&#8220;samAccountName&#8221;).Value<br />
        userWorkstations=adoRecordset.Fields(&#8220;userworkstations&#8221;).Value<br />
        ProfilePath=adoRecordset.Fields(&#8220;profilepath&#8221;).Value<br />
        ScriptPath=adoRecordset.Fields(&#8220;Scriptpath&#8221;).Value<br />
        HomeDirectory=adoRecordset.Fields(&#8220;Homedirectory&#8221;).Value<br />
        HomeDrive=adoRecordset.Fields(&#8220;homedrive&#8221;).Value<br />
        homePhone=adoRecordset.Fields(&#8220;homephone&#8221;).Value<br />
        pager=adoRecordset.Fields(&#8220;pager&#8221;).Value<br />
        mobile=adoRecordset.Fields(&#8220;mobile&#8221;).Value<br />
        ipPhone=adoRecordset.Fields(&#8220;ipphone&#8221;).Value<br />
        info=adoRecordset.Fields(&#8220;Info&#8221;).Value<br />
        facsimileTelephoneNumber=adoRecordset.Fields(&#8220;facsimileTelephonenumber&#8221;).Value<br />
        title=adoRecordset.Fields(&#8220;title&#8221;).Value<br />
        department=adoRecordset.Fields(&#8220;department&#8221;).Value<br />
        company=adoRecordset.Fields(&#8220;company&#8221;).Value<br />
        manager=adoRecordset.Fields(&#8220;manager&#8221;).Value</p>
<p>        &#8216;   Wscript.echo &#8220;NT Name: &#8221; &#038; strName &#038; &#8220;, Common Name: &#8221; &#038; strCN<br />
        SQLConnection.Open &#8220;Driver={SQL Server};server=SERVER,PORT;&#8221; &#038; _<br />
        &#8220;database=DATABASE;uid=USER;pwd=PASSWORD;&#8221;<br />
        Set sqlCommand.ActiveConnection = sqlConnection</p>
<p>        SQLCommand.CommandText = &#8220;SET QUOTED_IDENTIFIER OFF &#8221; &#038; _<br />
        &#8220;INSERT INTO &#8221; &#038; _<br />
        &#8220;ActiveDirectory &#8221; &#038; _<br />
        &#8220;(samAccountName,&#8221; &#038; _<br />
        &#8220;givenName,&#8221; &#038; _<br />
        &#8220;initials,&#8221; &#038; _<br />
        &#8220;sn,&#8221; &#038; _<br />
        &#8220;displayName,&#8221; &#038; _<br />
        &#8220;physicalDeliveryOfficeName,&#8221; &#038; _<br />
        &#8220;telephoneNumber,&#8221; &#038; _<br />
        &#8220;mail,&#8221; &#038; _<br />
        &#8220;streetAddress,&#8221; &#038; _<br />
        &#8220;l,&#8221; &#038; _<br />
        &#8220;st,&#8221; &#038; _<br />
        &#8220;postalCode,&#8221; &#038; _<br />
        &#8220;c,&#8221; &#038; _<br />
        &#8220;userPrincipalName,&#8221; &#038; _<br />
        &#8220;userWorkstations,&#8221; &#038; _<br />
        &#8220;ProfilePath,&#8221; &#038; _<br />
        &#8220;ScriptPath,&#8221; &#038; _<br />
        &#8220;HomeDirectory,&#8221; &#038; _<br />
        &#8220;HomeDrive,&#8221; &#038; _<br />
        &#8220;homePhone,&#8221; &#038; _<br />
        &#8220;pager,&#8221; &#038; _<br />
        &#8220;mobile,&#8221; &#038; _<br />
        &#8220;ipPhone,&#8221; &#038; _<br />
        &#8220;info,&#8221; &#038; _<br />
        &#8220;facsimileTelephoneNumber,&#8221; &#038; _<br />
        &#8220;title,&#8221; &#038; _<br />
        &#8220;department,&#8221; &#038; _<br />
        &#8220;company,&#8221; &#038; _<br />
        &#8220;manager) &#8221; &#038; _<br />
        &#8220;VALUES(&#8221; &#038; _<br />
        chr(34) &#038; sAMAccountName &#038; chr(34) &#038; &#8220;,&#8221; &#038; _<br />
        chr(34) &#038; givenName &#038; chr(34) &#038; &#8220;,&#8221; &#038; _<br />
        chr(34) &#038; initials &#038; chr(34) &#038; &#8220;,&#8221; &#038; _<br />
        chr(34) &#038; sn &#038; chr(34) &#038; &#8220;,&#8221; &#038; _<br />
        chr(34) &#038; displayName &#038; chr(34) &#038; &#8220;,&#8221; &#038; _<br />
        chr(34) &#038; physicalDeliveryOfficeName &#038; chr(34) &#038; &#8220;,&#8221; &#038; _<br />
        chr(34) &#038; telephoneNumber &#038; chr(34) &#038; &#8220;,&#8221; &#038; _<br />
        chr(34) &#038; mail &#038; chr(34) &#038; &#8220;,&#8221; &#038; _<br />
        chr(34) &#038; streetAddress &#038; chr(34) &#038; &#8220;,&#8221; &#038; _<br />
        chr(34) &#038; l &#038; chr(34) &#038; &#8220;,&#8221; &#038; _<br />
        chr(34) &#038; st &#038; chr(34) &#038; &#8220;,&#8221; &#038; _<br />
        chr(34) &#038; postalCode &#038; chr(34) &#038; &#8220;,&#8221; &#038; _<br />
        chr(34) &#038; c &#038; chr(34) &#038; &#8220;,&#8221; &#038; _<br />
        chr(34) &#038; userPrincipalName &#038; chr(34) &#038; &#8220;,&#8221; &#038; _<br />
        chr(34) &#038; userWorkstations &#038; chr(34) &#038; &#8220;,&#8221; &#038; _<br />
        chr(34) &#038; ProfilePath &#038; chr(34) &#038; &#8220;,&#8221; &#038; _<br />
        chr(34) &#038; ScriptPath &#038; chr(34) &#038; &#8220;,&#8221; &#038; _<br />
        chr(34) &#038; HomeDirectory &#038; chr(34) &#038; &#8220;,&#8221; &#038; _<br />
        chr(34) &#038; HomeDrive &#038; chr(34) &#038; &#8220;,&#8221; &#038; _<br />
        chr(34) &#038; homePhone &#038; chr(34) &#038; &#8220;,&#8221; &#038; _<br />
        chr(34) &#038; pager &#038; chr(34) &#038; &#8220;,&#8221; &#038; _<br />
        chr(34) &#038; mobile &#038; chr(34) &#038; &#8220;,&#8221; &#038; _<br />
        chr(34) &#038; ipPhone &#038; chr(34) &#038; &#8220;,&#8221; &#038; _<br />
        chr(34) &#038; info &#038; chr(34) &#038;&#8221;,&#8221; &#038; _<br />
        chr(34) &#038; facsimileTelephoneNumber &#038; chr(34) &#038; &#8220;,&#8221; &#038; _<br />
        chr(34) &#038; title &#038; chr(34) &#038; &#8220;,&#8221; &#038; _<br />
        chr(34) &#038; department &#038; chr(34) &#038; &#8220;,&#8221; &#038; _<br />
        chr(34) &#038; company &#038; chr(34) &#038; &#8220;,&#8221; &#038; _<br />
        chr(34) &#038; manager &#038; chr(34) &#038; &#8220;)&#8221; </p>
<p>        sqlCommand.CommandType = 1<br />
        sqlCommand.Execute<br />
        sqlConnection.Close </p>
<p>        &#8216; Move to the next record in the recordset.<br />
        adoRecordset.MoveNext</p>
<p>    Loop</p>
<p>    adoRecordset.Close<br />
    adoConnection.Close</p>
<p>   &#8216; Move to the next record in the recordset.<br />
    adPath.MoveNext</p>
<p>loop </p>
<p>&#8216; Clean up.</p>
<p>adPath.Close<br />
adConnection.Close</p>
</div>
					</div>
				</li>
					<li id="dsq-comment-206">
					<div id="dsq-comment-header-206" class="dsq-comment-header">
						<cite id="dsq-cite-206">
								<span id="dsq-author-user-206">mat</span>
							</cite>
					</div>
					<div id="dsq-comment-body-206" class="dsq-comment-body">
						<div id="dsq-comment-message-206" class="dsq-comment-message"><p>Hi all,</p>
<p>we have two trusted domains (query from SQL.dom1.com to AD.dom2.com) and we are using &#8220;Be made using this security context&#8221; setting with domain account from dom2.com. But we still get the same error. Any idea? </p>
<p>The OLE DB provider &#8220;ADsDSOObject&#8221; for linked server &#8220;ADSI_CORP&#8221; reported an error. The provider indicates that the user did not have the permission to perform the operation.</p>
</div>
					</div>
				</li>
					<li id="dsq-comment-207">
					<div id="dsq-comment-header-207" class="dsq-comment-header">
						<cite id="dsq-cite-207">
								<span id="dsq-author-user-207">0xG</span>
							</cite>
					</div>
					<div id="dsq-comment-body-207" class="dsq-comment-body">
						<div id="dsq-comment-message-207" class="dsq-comment-message"><p>objectClass = &#8221;User&#8221;&#8217;<br />
This is ambigious becauser I get both users and computers in my view.<br />
objectCategory=&#8221;user&#8221; seens to be more reliable.</p>
<p>Strangely, I can add objectCategory to my SELECT list, but not objectClass &#8211; any ideas why?</p>
</div>
					</div>
				</li>
					<li id="dsq-comment-208">
					<div id="dsq-comment-header-208" class="dsq-comment-header">
						<cite id="dsq-cite-208">
								<span id="dsq-author-user-208">John</span>
							</cite>
					</div>
					<div id="dsq-comment-body-208" class="dsq-comment-body">
						<div id="dsq-comment-message-208" class="dsq-comment-message"><p>This may help someone&#8230;<br />
This query pulls all AD accounts expiring in 7 days, along with their managers email address (so you can CC them)</p>
<p>SELECT     Rowset_1.GIVENNAME, Rowset_1.SAMACCOUNTNAME, Rowset_1.MAIL, Rowset_1.NAME, Rowset_1.MANAGER, DERIVEDTBL.MGRMAIL AS MGRMAIL, ROUND((CAST(Rowset_1.AccountExpires AS BigInt)<br />
                      / 10000000 &#8211; 11644560000 &#8211; CAST(DATEDIFF(SECOND, &#8217;19700101&#8242;, DATEADD(dd, DATEDIFF(dd, 0, GETDATE()), 0)) AS VARCHAR(64))) / 60 / 60 / 24, 0)<br />
                      AS EXPIRYDAYS<br />
FROM         OPENQUERY(ADSI,<br />
                      &#8216; SELECT GivenName, samAccountName, mail, name,manager, AccountExpires FROM &#8221;DC=[your_domain],DC=[com]&#8221; where objectClass = &#8221;User&#8221; and UserAccountControl <> 514 and accountExpires <> 0 and accountExpires <> 9223372036854775807 &#8216;)<br />
                       Rowset_1 LEFT OUTER JOIN<br />
                          (SELECT     adspath, mail AS MgrMail<br />
                            FROM          OPENQUERY(ADSI, &#8216;SELECT ADSpath, mail FROM &#8221;LDAP://DC=[your_domain],DC=[com]&#8221;&#8217;) Rowset_1) DERIVEDTBL ON<br />
                      &#8216;LDAP://&#8217; + Rowset_1.manager = DERIVEDTBL.adspath<br />
WHERE     (ROUND((CAST(Rowset_1.AccountExpires AS BigInt) / 10000000 &#8211; 11644560000 &#8211; CAST(DATEDIFF(SECOND, &#8217;19700101&#8242;, DATEADD(dd, DATEDIFF(dd, 0,<br />
                      GETDATE()), 0)) AS VARCHAR(64))) / 60 / 60 / 24, 0) = 7)<br />
ORDER BY Rowset_1.AccountExpires</p>
</div>
					</div>
				</li>
					<li id="dsq-comment-209">
					<div id="dsq-comment-header-209" class="dsq-comment-header">
						<cite id="dsq-cite-209">
								<span id="dsq-author-user-209">John</span>
							</cite>
					</div>
					<div id="dsq-comment-body-209" class="dsq-comment-body">
						<div id="dsq-comment-message-209" class="dsq-comment-message"><p>This may help someone&#8230;<br />
This query pulls all AD accounts expiring in 7 days, along with their managers email address (so you can CC them)</p>
<p>SELECT     Rowset_1.GIVENNAME, Rowset_1.SAMACCOUNTNAME, Rowset_1.MAIL, Rowset_1.NAME, Rowset_1.MANAGER, DERIVEDTBL.MGRMAIL AS MGRMAIL, ROUND((CAST(Rowset_1.AccountExpires AS BigInt)<br />
                      / 10000000 &#8211; 11644560000 &#8211; CAST(DATEDIFF(SECOND, &#8217;19700101&#8242;, DATEADD(dd, DATEDIFF(dd, 0, GETDATE()), 0)) AS VARCHAR(64))) / 60 / 60 / 24, 0)<br />
                      AS EXPIRYDAYS<br />
FROM         OPENQUERY(ADSI,<br />
                      &#8216; SELECT GivenName, samAccountName, mail, name,manager, AccountExpires FROM &#8221;DC=[your_domain],DC=[com]&#8221; where objectClass = &#8221;User&#8221; and UserAccountControl <> 514 and accountExpires <> 0 and accountExpires <> 9223372036854775807 &#8216;)<br />
                       Rowset_1 LEFT OUTER JOIN<br />
                          (SELECT     adspath, mail AS MgrMail<br />
                            FROM          OPENQUERY(ADSI, &#8216;SELECT ADSpath, mail FROM &#8221;LDAP://DC=[your_domain],DC=[com]&#8221;&#8217;) Rowset_1) DERIVEDTBL ON<br />
                      &#8216;LDAP://&#8217; + Rowset_1.manager = DERIVEDTBL.adspath<br />
WHERE     (ROUND((CAST(Rowset_1.AccountExpires AS BigInt) / 10000000 &#8211; 11644560000 &#8211; CAST(DATEDIFF(SECOND, &#8217;19700101&#8242;, DATEADD(dd, DATEDIFF(dd, 0,<br />
                      GETDATE()), 0)) AS VARCHAR(64))) / 60 / 60 / 24, 0) = 7)<br />
ORDER BY Rowset_1.AccountExpires</p>
</div>
					</div>
				</li>
					<li id="dsq-comment-210">
					<div id="dsq-comment-header-210" class="dsq-comment-header">
						<cite id="dsq-cite-210">
								<span id="dsq-author-user-210">dinorex</span>
							</cite>
					</div>
					<div id="dsq-comment-body-210" class="dsq-comment-body">
						<div id="dsq-comment-message-210" class="dsq-comment-message"><p>CatCat, that&#8217;s your permission problem&#8230;</p>
<p>In fact, this solution is CORRECT <img src='http://codebetter.com/brendantompkins/wp-includes/images/smilies/icon_smile.gif' alt=':)' class='wp-smiley' /> </p>
</div>
					</div>
				</li>
					<li id="dsq-comment-211">
					<div id="dsq-comment-header-211" class="dsq-comment-header">
						<cite id="dsq-cite-211">
	http://www.r2d2.de							<span id="dsq-author-user-211">Roland A.</span>
							</cite>
					</div>
					<div id="dsq-comment-body-211" class="dsq-comment-body">
						<div id="dsq-comment-message-211" class="dsq-comment-message"><p>Hi Folks Pretty coll that you all posted this solutions, for the owner of the Page: Your article was good for the beginning&#8230; BUT you could just expand your article with the Added Informations if you have the Time&#8230; its a mess to scroll up and down&#8230; </p>
<p>however, its very good to have at least a few people who are also working on SQL Server and try to retrieve the ad data that way.</p>
<p>cheers</p>
</div>
					</div>
				</li>
					<li id="dsq-comment-212">
					<div id="dsq-comment-header-212" class="dsq-comment-header">
						<cite id="dsq-cite-212">
	http://raoulteeuwen.blogspot.com							<span id="dsq-author-user-212">Raoul Teeuwen</span>
							</cite>
					</div>
					<div id="dsq-comment-body-212" class="dsq-comment-body">
						<div id="dsq-comment-message-212" class="dsq-comment-message"><p>Hi.</p>
<p>Thanks for all the info. I&#8217;ve tried Dave&#8217;s code. I&#8217;m running a SQL 2000-machine. And i want to know what users are in what groups within the AD.</p>
<p>Runing Dave&#8217;s code, I ran into a problem that GetOleError isn&#8217;t available. After taking that out of the equasion, i run into a problem within SetupOLE, at the line &#8220;EXEC @OLEreturn = sp_OAMethod @ADOcomm, &#8216;Execute&#8217;, @ADOrs OUT&#8221;. At the moment of the error </p>
<p>ADOcomm has a value of: 33488638<br />
ADOrs has a value of: 50265854</p>
<p>When i run the command manually with these values:</p>
<p>EXEC @OLEreturn = sp_OAMethod 33488638, &#8216;Execute&#8217;, 50265854 OUT</p>
<p>i get: &#8220;Cannot use the OUTPUT option when passing a constant to a stored procedure.&#8221;.</p>
<p>When i remove the OUT option running:</p>
<p>EXEC @OLEreturn = sp_OAMethod 33488638, &#8216;Execute&#8217;, 50265854 </p>
<p>I get &#8220;sp_OACreate has not yet been called successfully for this command batch.&#8221;.</p>
<p>When i edit SetupOLE so the OUT-parameter is removed, i immediately run into the 1st error (while, with the OUT-parameter active, it takes some seconds before the error shows)</p>
<p>Any ideas?</p>
</div>
					</div>
				</li>
				</ul>
		</div>
	</div>

<a href="http://disqus.com" class="dsq-brlink">blog comments powered by <span class="logo-disqus">Disqus</span></a>

<script type="text/javascript">
/* <![CDATA[ */
	var disqus_url = 'http://codebetter.com/brendantompkins/2003/12/19/create-a-sql-server-view-of-your-ad-users/ ';
	var disqus_identifier = '35 /blogs/brendan.tompkins/archive/2003/12/19/4746.aspx';
	var disqus_container_id = 'disqus_thread';
	var disqus_domain = 'disqus.com';
	var disqus_shortname = 'brendantompkins';
	var disqus_title = "Create a SQL Server View of your AD Users";
		var disqus_config = function () {
	    var config = this; // Access to the config object

	    /* 
	       All currently supported events:
	        * preData — fires just before we request for initial data
	        * preInit - fires after we get initial data but before we load any dependencies
	        * onInit  - fires when all dependencies are resolved but before dtpl template is rendered
	        * afterRender - fires when template is rendered but before we show it
	        * onReady - everything is done
	     */

		config.callbacks.preData.push(function() {
			// clear out the container (its filled for SEO/legacy purposes)
			document.getElementById(disqus_container_id).innerHTML = '';
		});
				config.callbacks.onReady.push(function() {
			// sync comments in the background so we don't block the page
			DISQUS.request.get('?cf_action=sync_comments&post_id=35');
		});
					};
	var facebookXdReceiverPath = 'http://codebetter.com/brendantompkins/wp-content/plugins/disqus-comment-system/xd_receiver.htm';
/* ]]> */
</script>

<script type="text/javascript">
/* <![CDATA[ */
	var DsqLocal = {
		'trackbacks': [
		],
		'trackback_url': "http:\/\/codebetter.com\/brendantompkins\/2003\/12\/19\/create-a-sql-server-view-of-your-ad-users\/trackback\/"	};
/* ]]> */
</script>

<script type="text/javascript">
/* <![CDATA[ */
(function() {
	var dsq = document.createElement('script'); dsq.type = 'text/javascript';
	dsq.async = true;
	dsq.src = 'http://' + disqus_shortname + '.' + disqus_domain + '/embed.js?pname=wordpress&pver=2.61';
	(document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();
/* ]]> */
</script>

		</div><!-- #main -->
			<div id="sidebar" class="grid_4">

		<div id="primary" class="widget-area">
			<ul class="xoxo">
				<div class="ad-container">
					<a target="_blank" href="http://www.red-gate.com/products/dotnet-development/ants-performance-profiler/entrypage/version-6-new-features?utm_source=cb&utm_medium=button&utm_term=4328&utm_content=app6release&utm_campaign=antsperformanceprofiler"><img width="125" height="125" border="0" title="" alt="" src="http://s3.amazonaws.com/CodeBetter/Creative/ANTSPP5_125x125_M1.gif"></a>
					<embed width="125" height="125" flashvars="clickTARGET=_blank&amp;clickTAG=http%3A%2F%2Fd1.openx.org%2Fck.php%3Foaparams%3D2__bannerid%3D62753__zoneid%3D29419__cb%3Da0471ce5e8__r_id%3Dd42118811971f057012db20aa261c5c1__r_ts%3Dldef6x__oadest%3Dhttp%253A%252F%252Fwww.jetbrains.com%252Fresharper%252F%253Frs4cb125" allowscriptaccess="always" quality="high" name="Advertisement" id="Advertisement" style="" src="http://s3.amazonaws.com/CodeBetter/Creative/tc_125x125_simple2.swf" type="application/x-shockwave-flash">
				</div>
			
				<li id="user_bio-2" class="widget-container widget_user_bio"><h3 class="widget-title">About Me</h3><div class="ub-grav" style="margin:5px 5px 0px 5px;float: left;"><img alt='' src='http://0.gravatar.com/avatar/c1de0fbc0dbc3fd24b285009c123d9b0?s=96&amp;d=http%3A%2F%2F0.gravatar.com%2Favatar%2Fad516503a11cd5ca435acc9bb6523536%3Fs%3D96&amp;r=G' class='avatar avatar-96 photo' height='96' width='96' /></div>By day, I'm a .NET developer working in the transportation and logistics industry... By night I'm a fabulous disco dancer.
</li>		
						
			</ul>
			
		</div><!-- #primary .widget-area -->
		
		<div id="secondary" class="widget-area">
				<script type="text/javascript" src="http://engine.theloungenet.com/z/15/adzerk1_2_5"></script>
				<div id="adzerk1"></div>
				
				<ul class="xoxo">		
									</ul>	
				
				<a target="_blank" href="http://www.red-gate.com/products/dotnet-development/ants-performance-profiler/entrypage/version-6-csharp?utm_source=cb&utm_medium=rectangle&utm_term=4327&utm_content=app6release&utm_campaign=antsperformanceprofiler"><img width="300" height="250" border="0" title="" alt="" src="http://s3.amazonaws.com/CodeBetter/Creative/APP6_Launch_C%23_Jun10_300x250_M1.gif?AWSAccessKeyId=0KMA35HT86EVXB99Z302&amp;Expires=1458095516&amp;Signature=BIBDilUaLnZe1uKfVKyyTBxr%2BvE%3D"></a>
				
		</div><!-- #secondary .widget-area -->			</div><!--sidebar-->
		</div><!-- #container -->
</div><!-- end div tabs see header.php -->
	
	<div id="footer">
		<div class="container_12">
		<div id="footer-widget-area">
				<div class="grid_4">					
					<ul>
					<li><a href="http://codebetter.com" title="home">Home</a></li>
					<li class="page_item page-item-2"><a href="http://codebetter.com/about/" title="About">About</a></li>
<li class="page_item page-item-8"><a href="http://codebetter.com/codebetter-ci/" title="CodeBetter CI">CodeBetter CI</a></li>
<li class="page_item page-item-6"><a href="http://codebetter.com/community/" title="Community">Community</a></li>
<li class="page_item page-item-10"><a href="http://codebetter.com/editors/" title="Editors">Editors</a></li>
<li class="page_item page-item-41"><a href="http://codebetter.com/globalsearch/" title="Search Results">Search Results</a></li>
					<li><a href="http://feeds.feedburner.com/CodeBetter" rel="alternate" type="application/rss+xml"><img src="http://www.feedburner.com/fb/images/pub/feed-icon16x16.png" alt="" style="vertical-align:middle;border:0"/></a><a href="http://feeds.feedburner.com/CodeBetter"><img src="http://feeds.feedburner.com/~fc/CodeBetter?bg=FFFFFF&amp;fg=2E9BD2&amp;anim=1" height="26" width="88" style="vertical-align:middle;border:0"/></a></li>
					</ul>
				</div><!-- #second .widget-area -->
				<div class="grid_4">
					
					<h3>Friends of CodeBetter.Com</h3>
<ul>

<li><a href="/blogs/products/pages/64386.aspx">Red-Gate Tools For SQL and .NET</a></li>
<li><a href="/blogs/products/pages/64615.aspx">Telerik</a></li>
<li><a href="/blogs/products/pages/142174.aspx">JetBrains - ReSharper</a></li>
<li><a href="/blogs/products/pages/Beyond-Compare.aspx">Beyond Compare</a></li>
<li><a href="/blogs/products/pages/.NET-Memory-Profiler.aspx">.NET Memory Profiler</a></li>
<li><a href="http://www.ndepend.com/">NDepend</a></li>
<li><a href="http://www.sapphiresteel.com/">Ruby In Steel</a></li>
<li><a href="http://www.slickedit.com/">SlickEdit</a></li>
<li><a href="http://www.gurock.com/products/smartinspect/">SmartInspect .NET Logging</a></li>
<li>NGEDIT: <a href="http://www.viemu.com/">ViEmu</a> and <a href="http://www.codekana.com/">Codekana</a> </li>
<li><a href="http://www.devexpress.com/" target="_blank">DevExpress</a></li>
<li><a href="http://nhprof.com" target="_blank">NHibernate Profiler</a></li>
<li><a href="http://unfuddle.com" target="_blank">Unfuddle</a></li>
<li><a href="http://www.balsamiq.com/products/mockups" target="_blank">Balsamiq Mockups</a></li>
<li><a href="http://scrumy.com" target="_blank">Scrumy</a> &lt;-- NEW Friend!</li>

	</ul>				
				</div><!-- #third .widget-area -->
				<div class="grid_4">
					CodeBetter.Com &copy; '11<br />
						Stuff you need to Code Better!<br />
				Proudly powered by <span id="generator-link"><a href="http://wordpress.org/" title="Semantic Personal Publishing Platform" rel="generator">WordPress</a></span>.					
				</div><!-- #fourth .widget-area -->
			</div><!-- #footer-widget-area -->		
		
			</div><!-- end div.container_12 -->

	</div><!-- end div#footer -->
		
<script type="text/javascript">

  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-531207-1']);
  _gaq.push(['_trackPageview']);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();

</script>
<script type='text/javascript' src='/wp-content/plugins/syntaxhighlighter/syntaxhighlighter3/scripts/shCore.js?ver=3.0.83b'></script>
<script type='text/javascript' src='/wp-content/plugins/syntaxhighlighter/syntaxhighlighter3/scripts/shBrushCSharp.js?ver=3.0.83b'></script>
<script type='text/javascript' src='/wp-content/plugins/syntaxhighlighter/syntaxhighlighter3/scripts/shBrushRuby.js?ver=3.0.83b'></script>
<script type='text/javascript' src='/wp-content/plugins/syntaxhighlighter/syntaxhighlighter3/scripts/shBrushJScript.js?ver=3.0.83b'></script>
<script type='text/javascript' src='/wp-content/plugins/syntaxhighlighter/syntaxhighlighter3/scripts/shBrushXml.js?ver=3.0.83b'></script>
<script type='text/javascript' src='/wp-content/plugins/syntaxhighlighter//third-party-brushes/shBrushFSharp.js?ver=3.0.83b'></script>
<script type='text/javascript'>
	(function(){
		var corecss = document.createElement('link');
		var themecss = document.createElement('link');
		var corecssurl = "/wp-content/plugins/syntaxhighlighter/syntaxhighlighter3/styles/shCore.css?ver=3.0.83b";
		if ( corecss.setAttribute ) {
				corecss.setAttribute( "rel", "stylesheet" );
				corecss.setAttribute( "type", "text/css" );
				corecss.setAttribute( "href", corecssurl );
		} else {
				corecss.rel = "stylesheet";
				corecss.href = corecssurl;
		}
		document.getElementsByTagName("head")[0].insertBefore( corecss, document.getElementById("syntaxhighlighteranchor") );
		var themecssurl = "/wp-content/plugins/syntaxhighlighter/syntaxhighlighter3/styles/shThemeDefault.css?ver=3.0.83b";
		if ( themecss.setAttribute ) {
				themecss.setAttribute( "rel", "stylesheet" );
				themecss.setAttribute( "type", "text/css" );
				themecss.setAttribute( "href", themecssurl );
		} else {
				themecss.rel = "stylesheet";
				themecss.href = themecssurl;
		}
		//document.getElementById("syntaxhighlighteranchor").appendChild(themecss);
		document.getElementsByTagName("head")[0].insertBefore( themecss, document.getElementById("syntaxhighlighteranchor") );
	})();
	SyntaxHighlighter.config.strings.expandSource = '+ expand source';
	SyntaxHighlighter.config.strings.help = '?';
	SyntaxHighlighter.config.strings.alert = 'SyntaxHighlighter\n\n';
	SyntaxHighlighter.config.strings.noBrush = 'Can\'t find brush for: ';
	SyntaxHighlighter.config.strings.brushNotHtmlScript = 'Brush wasn\'t configured for html-script option: ';
	SyntaxHighlighter.defaults['gutter'] = false;
    SyntaxHighlighter.defaults['tab-size'] = 2;
    SyntaxHighlighter.defaults['toolbar'] = false;
    SyntaxHighlighter.defaults['wrap-lines'] = false; 
	SyntaxHighlighter.defaults['pad-line-numbers'] = false;
	SyntaxHighlighter.all();
</script>
 
</body>
</html>
<!-- Dynamic page generated in 0.694 seconds. -->
<!-- Cached page generated by WP-Super-Cache on 2011-01-25 14:59:14 -->
<!-- super cache -->