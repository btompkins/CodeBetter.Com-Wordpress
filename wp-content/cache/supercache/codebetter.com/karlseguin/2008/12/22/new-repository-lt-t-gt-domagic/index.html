<!DOCTYPE html>
<html dir="ltr" lang="en-US">
<head>
	<meta charset="UTF-8" />
    <title>new Repository&lt;T&gt;().DoMagic() | Karl Seguin</title>
	<link rel="profile" href="http://gmpg.org/xfn/11" />
	
	<link href="http://feeds.feedburner.com/CodeBetter" title="CodeBetter.Com &raquo; Feed" type="application/rss+xml" rel="alternate">
	
		<link rel="pingback" href="http://codebetter.com/karlseguin/xmlrpc.php" />
	                <link rel="stylesheet" href="http://cdn1.codebetter.com/wp-content/uploads/spacker-cache/ea73517eb74a545f51c376487c94dc9f.css?v=3912785705" type="text/css" media="all" /><!-- Is Cache! -->
                <script type='text/javascript' src='https://ajax.googleapis.com/ajax/libs/jquery/1.6.0/jquery.min.js?ver=3.4.2'></script>
<script type='text/javascript' src='http://dtym7iokkjlif.cloudfront.net/dough/1.0/recipe.js'></script>
<link rel="EditURI" type="application/rsd+xml" title="RSD" href="http://codebetter.com/karlseguin/xmlrpc.php?rsd" />
<link rel="wlwmanifest" type="application/wlwmanifest+xml" href="http://cdn1.codebetter.com/wp-includes/wlwmanifest.xml" /> 
<link rel='prev' title='Oxite &#8211; Oh Dear Lord Why?!' href='http://codebetter.com/karlseguin/2008/12/16/oxite-oh-dear-lord-why/' />
<link rel='next' title='Compressing JS files as part of your build process' href='http://codebetter.com/karlseguin/2008/12/29/compressing-js-files-as-part-of-your-build-process/' />
<meta name="generator" content="WordPress 3.4.2" />
<link rel='shortlink' href='http://codebetter.com/karlseguin/?p=154' />

<!-- All in One SEO Pack 1.6.13.2 by Michael Torbert of Semper Fi Web Design[83,139] -->
<link rel="canonical" href="http://codebetter.com/karlseguin/2008/12/22/new-repository-lt-t-gt-domagic/" />
<!-- /all in one seo pack -->
<link rel="stylesheet" href="http://cdn1.codebetter.com/wp-content/plugins/digg-digg/include/../css/diggdigg-style.css?ver=4.5.3.3" type="text/css" media="screen" />

<!-- Start Shareaholic OgTags -->

	<!-- Shareaholic Notice: There is neither a featured nor gallery image set -->

<!-- End Shareaholic OgTags -->

<meta id="syntaxhighlighteranchor" name="syntaxhighlighter-version" content="3.1.3" />
                <script type="text/javascript" src="http://cdn1.codebetter.com/wp-content/uploads/spacker-cache/dc168cf39155d7b5d39f696ca94d5980.js?v=5302176208">/*Is Cache!*/</script>
                	
	<script type='text/javascript' src='http://d1.openx.org/spcjs.php?id=7744&amp;target=_blank'></script>
	<style type="text/css">body { padding-top:0px !important; } html { margin-top: 0px !important; }</style>
<!-- BuySellAds Ad Code -->
<script type="text/javascript">
(function(){
  var bsa = document.createElement('script');
     bsa.type = 'text/javascript';
     bsa.async = true;
     bsa.src = 'http://s3.buysellads.com/ac/bsa.js';
  (document.getElementsByTagName('head')[0]||document.getElementsByTagName('body')[0]).appendChild(bsa);
})();
</script>
<!-- End BuySellAds Ad Code -->
</head>

<body>

			
		<div class="container_12 ui-tabs ui-widget ui-widget-content ui-corner-all" id="tabs">			
			<ul class="ui-tabs-nav ui-helper-reset ui-helper-clearfix ui-widget-header ui-corner-all">
				<li class="ui-state-default ui-corner-top ui-tabs-selected ui-state-active"><a href="#ui-tabs-1">CodeBetter.Com</a></li>
				<li class="ui-state-default ui-corner-top"><a href="http://devlicio.us">Devlicio.Us</a></li>				
				<div id="top-search">
				<form action="http://codebetter.com/globalsearch/" id="cse-search-box">
  <div>
   <fieldset id="search">
		<input type="hidden" name="cx" value="005178204031477491434:2bg5jtwgsfe" />
		<input type="hidden" name="cof" value="FORID:9" />
		<input type="hidden" name="ie" value="UTF-8" />
		<input type="text"  class="text-input" id="s" name="q" size="31" />
		<input type="image" src="http://cdn1.codebetter.com/wp-content/themes/codebetter/images/search-img.png" class="form-button" id="searchsubmit" value="GO" name="">				   	
	</fieldset>
  </div>
</form>
<script type="text/javascript" src="http://www.google.com/cse/brand?form=cse-search-box&lang=en&sitesearch=true"></script>
				</div>				
			</ul><div id="ui-tabs-1" class="ui-tabs-panel ui-widget-content ui-corner-bottom"></div><div id="ui-tabs-2" class="ui-tabs-panel ui-widget-content ui-corner-bottom ui-tabs-hide"></div>
		</div>
			
		<div id="main" class="container_12">
		
			<div id="logo" class="grid_3"><a href="/" title="CodeBetter.Com - Stuff you need to Code Better!"><image src="http://cdn1.codebetter.com/wp-content/themes/codebetter/images/codebetter_logo.png" height="48" width="223"></image></a></div>
			<div id="ad_leaderboard" class="grid_9">
			<!-- BuySellAds Zone Code -->
<div id="bsap_1276080" class="bsarocks bsap_4fe632babdccc2b4b049e4f08cc3c549"></div>
<!-- End BuySellAds Zone Code --></div>
			
			<div id="globalNav" class="grid_12">
				<ul>
					<li><a href="http://codebetter.com" title="home">Home</a></li>
					<li class="page_item page-item-2"><a href="http://codebetter.com/about/">About</a></li>
<li class="page_item page-item-8"><a href="http://codebetter.com/codebetter-ci/">CodeBetter CI</a></li>
<li class="page_item page-item-6"><a href="http://codebetter.com/community/">Community</a></li>
<li class="page_item page-item-10"><a href="http://codebetter.com/editors/">Editors</a></li>
					<li><a href="http://feeds.feedburner.com/CodeBetter" rel="alternate" type="application/rss+xml"><img src="http://www.feedburner.com/fb/images/pub/feed-icon16x16.png" alt="" style="vertical-align:middle;border:0"/></a><a href="http://feeds.feedburner.com/CodeBetter"><img src="http://feeds.feedburner.com/~fc/CodeBetter?bg=EFEFEF&amp;fg=2E9BD2&amp;anim=1" height="26" width="88" style="vertical-align:middle;border:0"/></a></li>
				</ul>
								
			</div><!-- end div#globalNav.container_12 -->				
	
		<div id="content" class="container_12">
			<div id="main" class="grid_8">


				<div id="post-154" class="post-154 post type-post status-publish format-standard hentry category-uncategorized">
					<h1 class="entry-title">new Repository&lt;T&gt;().DoMagic()</h1>

					<div class="entry-meta">
						<span class="meta-prep meta-prep-author">Posted by </span>
						<span class="author vcard"><a class="url fn n" href="http://codebetter.com/karlseguin/author/karlseguin/" title="View all posts by karlseguin">karlseguin</a></span>
						<span class="meta-sep"> on  </span>
						<a href="http://codebetter.com/karlseguin/2008/12/22/new-repository-lt-t-gt-domagic/" title="6:27 pm" rel="bookmark"><span class="entry-date">December 22, 2008</span></a>
											</div><!-- .entry-meta -->

					<div class="entry-content">
						<div id="greet_block"><noscript><div class="greet_block wpgb_cornered"><div class="greet_text"><div class="greet_image"><a href="http://codebetter.com/karlseguin/feed/rss/"  rel="nofollow"><img src="http://cdn1.codebetter.com/wp-content/plugins/wp-greet-box/images/rss_icon.png" alt="WP Greet Box icon"/></a></div>Hello there! If you are new here, you might want to <a href="http://codebetter.com/karlseguin/feed/rss/" rel="nofollow"><strong>subscribe to the RSS feed</strong></a> for updates on this topic.<div style="clear:both"></div><div class="greet_block_powered_by">Powered by <a href="http://omninoggin.com/projects/wordpress-plugins/wp-greet-box-wordpress-plugin/" title="WP Greet Box WordPress Plugin" style="text-decoration:none;">WP Greet Box</a> <a href="http://omninoggin.com/" title="WordPress Plugin" style="text-decoration:none;">WordPress Plugin</a></div><div style="clear:both"></div></div></div></noscript></div><!-- Start Shareaholic LikeButtonSetTop Automatic --><!-- End Shareaholic LikeButtonSetTop Automatic --><p>#karl_custom_1 code{color:#833;background:#fcfcfc;}<br />
#karl_custom_1 h4{margin:30px 0px 0px 0px;font-color:#fff;font-weight:bold;border-bottom:1px dashed #ccc;font-variant: small-caps}</p>
<p><DIV><br />
<P>The purpose behind the repository pattern is to provide a layer of abstraction between your domain and data layer. For smaller projects, this typically isn&#8217;t needed. However, larger projects can really benefit from a broker that specifically handles the back and forth between the two layers. With repositories your domain objects aren&#8217;t burdened with infrastructure details and can therefore better focus on domain-specific behavior.</P><br />
<H4>Without A Repository</H4><br />
<P>To build this up to our grand finale (a generic repository), let&#8217;s look at how you might do things in a small project without a repository. The simplest example might look something like: </P><PRE>public class User<br />
{<br />
   private int _id;<br />
   &#8230;</p>
<p>   public void Delete()<br />
   {<br />
        Factory.Get&lt;IDataStore&gt;().DeleteUser(_id);<br />
   }<br />
}<br />
</PRE><br />
<P>Of course, our <CODE>User</CODE> class will likely need a <CODE>Save</CODE> and various <CODE>Find</CODE> methods. Also, <CODE>Delete</CODE> won&#8217;t always be so straightforward â€“ for data integrity/historic reasons you might not actually delete the entity, but rather flag it as inactive and update it:</P><PRE>public void Delete()<br />
{<br />
    _isActive = false;<br />
    Factory.Get&lt;IDataStore&gt;().Update(this);<br />
}</PRE><br />
<H4>With non-generic Repositories</H4><br />
<P>The above approach will quickly result in a burdened User class &#8211; especially when you look at all the different ways you&#8217;ll want to fetch entities. The next step is to create repositories per-entity. So you end up with something like:</P><PRE>public class UserRepository : IUserRepository<br />
{<br />
   public void Delete(User user)<br />
   {<br />
      user.IsActive = false;<br />
      Factory.Get&lt;IDataStore&gt;().Update(user);<br />
   }<br />
   public User FindByCredentials(string username, password)<br />
   {<br />
      //todo some null checks, maybe encrypt the password<br />
      var user = Factory.Get&lt;IDataStore&gt;().FindUser(username, password)<br />
      return user ?? User.Null;<br />
   }<br />
}</PRE><br />
<P>This is a pretty common approach (you don&#8217;t have to look too far back to some of my own code samples to see it) and it works pretty well. The main problem with this code is that you end up with a lot of repetitive code and an equal number of repetitive tests. If only there was a way to significantly reduce the repitition&#8230;</P><br />
<H4>Generic Repository</H4><br />
<P>Not too long ago <A href="http://codebetter.com/blogs/karlseguin/archive/2008/11/21/back-to-basics-generics.aspx">I blogged about Generics</A> saying that they were ideal for situations where code was similar but types differed. I provided a few examples, including a quick overview of a generic repository. Lets expand on that a bit. The beauty of a generic repository is that it gives you a powerful, flexible and easy to test class that can satisfy the vast majority of your needs â€“ especially when you combine it with other generic classes (we use a generic controller for our CRUD which interacts with our generic repository which hits a generic DAL which is pretty much a wrapper to NHibernate (which itself is a generic implementation)).</P><br />
<P>First thing first, we start with some basic stuff:</P><PRE>public class Repository&lt;T&gt; where T : IEntity<br />
{<br />
    private T _entity;<br />
    public Repository(T entity)<br />
    {<br />
        if (entity == null)<br />
        {<br />
            throw new ArgumentNullException(&#8220;entity&#8221;);<br />
        }<br />
       _entity = entity;<br />
    }<br />
}</PRE><br />
<P>The only note-worthy thing is the generic constraint stating that <CODE>T</CODE> must be of type <CODE>IEntity</CODE>. This is a custom type, which I simply define as:</P><PRE>public interface IEntity<br />
{<br />
    int Id{ get; }<br />
}</PRE><br />
<P>This not only lets us get an entity&#8217;s Id (which is pretty important for some simple operations), but also makes sure someone doesn&#8217;t create a repository for a type we don&#8217;t control, such as:</P><PRE>new Repository&lt;int&gt;(3); //doh!</PRE><br />
<P>Next we can start implementing simple versions of our most common methods:</P><PRE>public virtual void Delete()<br />
{<br />
    DataFactory.For&lt;T&gt;().Delete(_entity);<br />
}<br />
public virtual void Save()<br />
{<br />
    DataFactory.For&lt;T&gt;().Save(_entity);<br />
}</PRE><br />
<P>The real power though comes from being able to re-use more complex patterns. In our current system we have versioned entities (entities that can&#8217;t be modified or deleted in order to preserver historical data integrity). Such entities are marked with the <CODE>IVersioned</CODE> interface:</P><PRE>public interface IVersioned&lt;T&gt; where T : IEntity<br />
{<br />
    void MarkAsNew();<br />
    void MarkAsOld();<br />
    DateTime Created{get;set;}<br />
    T Root{get;set;}<br />
}</PRE><br />
<P>Essentially, a versioned entity can be marked as active/inactive, always has a created property and always references its root element (this makes reporting across a single entity transparent from the versioning aspect). By implementing <CODE>IVersioned&lt;T&gt;</CODE> within an entity, such as: </P><PRE>public class User : IEntity, IVersioned&lt;User&gt;<br />
{<br />
   private int _id;<br />
   private bool _isActive;</p>
<p>   public int Id{get { return _id; }}<br />
   public bool IsActive{get { return _isActive; }}<br />
   public User Root{get;set;}<br />
   public DateTime Created{get;set;}</p>
<p>   public void MarkAsOld()<br />
   {<br />
      _isActive = false;<br />
   }<br />
   public void MarkAsNew()<br />
   {<br />
       _created = DateTime.Now;<br />
      _isActive = true;<br />
      _id = 0;<br />
   }<br />
}</PRE><br />
<P>We can now start wirting some really meaningful and reusable code:</P><PRE>public virtual void Delete()<br />
{<br />
    if (!(_entity is IVersioned&lt;T&gt;))<br />
    {<br />
        DataFactory.For&lt;T&gt;().Delete(entity);<br />
        return;<br />
    }<br />
    var entity = (IVersioned&lt;T&gt;)_entity;<br />
    entity.MarkAsInactive();<br />
    DataFactory.For&lt;T&gt;().Save(entity);<br />
}<br />
public virtual void Save()<br />
{<br />
    AssertValidity(); //validates _entity<br />
    var store = DataFactory.For&lt;T&gt;();<br />
    if (_entity.Id == 0 || !(_entity is IVersioned&lt;T&gt;))<br />
    {<br />
        store.Save(_entity);<br />
        return;<br />
    }<br />
    var original = store.Get(_entity.Id);<br />
    var entity = (IVersioned&lt;T&gt;)_entity;<br />
    entity.MarkAsNew();<br />
    entity.Root = original.Root ?? original;<br />
    original.MarkAsOld();<br />
    store.Save(entity, original)<br />
}<br />
</PRE><br />
<P>This is just a narrow slice of what you can accomplish â€“ with just a few interfaces you can accomplish a lot of work â€“ we currently have <CODE>IImmutable</CODE> (can&#8217;t be updated/deleted), <CODE>IDefautable</CODE> (an entity with IsDefault == true cannot be deleted and cannot be removed as the default), and <CODE>IUnique</CODE> which lists some unique constraint that the generic repository can enforce (a unique username for example).</P><br />
<H4>What Is DataFactory&lt;T&gt;()&#8230;</H4><br />
<P>Except for references to a data-layer, I left out all details about the underlying DAL that our repository has to interact with. Depending on what you&#8217;re currently using, you might not see how the two will play nicely together (for example, I&#8217;m under the impression that my above code won&#8217;t work all that well with a LINQ-to-SQL implementation). This is just one of the many reasons why you really should look at your DAL from the domain point of view (instead of the data perspective). If you aren&#8217;t familiar with a quality O/R mapper, what are you waiting for?</P><br />
<H4>What about Fetching?</H4><br />
<P>I also conveniently left-out how to retrieve records. We can consider this a topic for future posts. However, the same concept applies. There are actually a number of tools at your disposal, including LINQ-to-Nhibernate, NHIbernate detached queries and generic object query. We currently use the latter, though we&#8217;re looking into going more of an expression route. Here&#8217;s a little sample:</P><PRE>//I dislike the magic string &#8216;IsActive&#8217;<br />
var query = new ModelQuery&lt;User&gt;()<br />
                 .Where(w =&gt; w.AddCriteria(&#8220;IsActive&#8221;, Operation.Equals,  true).Paged(1, 10);<br />
var result = new Repository&lt;User&gt;().Find(query);<br />
int pages = result.TotalPages;<br />
var users = result.Entities;</PRE><br />
<H4>Special Cases</H4><br />
<P>Your generic repository won&#8217;t be able to handle all cases. In such situations, you simply sub-class it and provide the custom logic â€“ overriding existing methods or implementing your own.</P><br />
<H4>Conclusion</H4><br />
<P>I see more and more applications making use of numerous XXXRepository classes, and wonder whether they get tired, like I did, of copy-n-pasting the same base code and tests. Over the last year, I&#8217;ve learnt that if you copy existing tests as a starting point, there&#8217;s a good chance you can introduce a generic implementation â€“ which almost always results in cleaner and more testable code. Hopefully you also see how generics and interfaces can play off of each other â€“ almost in a symbolic manner. By simply marking your entity with <CODE>IDefautable</CODE> (and implementing the sole <CODE>IsDefault</CODE> property) all of the necessary infrastructure and tests are already in place to support your systems concept of a default entity</P>. </DIV></p>
<div class="shr-publisher-154"></div><!-- Start Shareaholic LikeButtonSetBottom Automatic --><!-- End Shareaholic LikeButtonSetBottom Automatic -->											</div><!-- .entry-content -->


					<div class="entry-utility">
					This entry was posted in <a href="http://codebetter.com/karlseguin/category/uncategorized/" title="View all posts in Uncategorized" rel="category tag">Uncategorized</a>. Bookmark the <a href="http://codebetter.com/karlseguin/2008/12/22/new-repository-lt-t-gt-domagic/" title="Permalink to new Repository&lt;T&gt;().DoMagic()" rel="bookmark">permalink</a>. Follow any comments here with the <a href="http://codebetter.com/karlseguin/2008/12/22/new-repository-lt-t-gt-domagic/feed/" title="Comments RSS to new Repository&lt;T&gt;().DoMagic()" rel="alternate" type="application/rss+xml">RSS feed for this post</a>.
					</div><!-- .entry-utility -->
				</div><!-- #post-154 -->

				<div id="nav-below" class="navigation">
					<div class="nav-previous"><a href="http://codebetter.com/karlseguin/2008/12/16/oxite-oh-dear-lord-why/" rel="prev"><span class="meta-nav">&larr;</span> Oxite &#8211; Oh Dear Lord Why?!</a></div>
					<div class="nav-next"><a href="http://codebetter.com/karlseguin/2008/12/29/compressing-js-files-as-part-of-your-build-process/" rel="next">Compressing JS files as part of your build process <span class="meta-nav">&rarr;</span></a></div>
				</div><!-- #nav-below -->

							<div id="comments">


			<h3 id="comments-title">31 Responses to <em>new Repository&lt;T&gt;().DoMagic()</em> </h3>


			<ol class="commentlist">
						<li class="comment even thread-even depth-1" id="li-comment-1544">
		<div id="comment-1544">
		<div class="comment-author vcard">
			<img alt='' src='http://0.gravatar.com/avatar/ad516503a11cd5ca435acc9bb6523536?s=40' class='avatar avatar-40 photo avatar-default' height='40' width='40' />			<cite class="fn">Chris J</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="http://codebetter.com/karlseguin/2008/12/22/new-repository-lt-t-gt-domagic/#comment-1544">March 12, 2009 at 9:48 pm</a></div>

		<div class="comment-body"><p>Karl, first of all, great article. Thank you.  </p>
<p>I&#8217;m really curious how a mapping of an entity in NHibernate would work when the entity inherits from IVersioned<t> and also what the database schema would entail.  Before finding this article, I envisioned a versioning construct very similar, however, I&#8217;m really struggling to determine how NHibernate plays nicely with this interface from which many entities would inherit.  How does DataFactory</t><t> handle this? Any help would be GREATLY appreciated!</t></p>
</div>

		<div class="reply">
					</div>
	</div>

	</li>
		<li class="comment odd alt thread-odd thread-alt depth-1" id="li-comment-1543">
		<div id="comment-1543">
		<div class="comment-author vcard">
			<img alt='' src='http://0.gravatar.com/avatar/ad516503a11cd5ca435acc9bb6523536?s=40' class='avatar avatar-40 photo avatar-default' height='40' width='40' />			<cite class="fn"><a href='http://terracognita.ca' rel='external nofollow' class='url'>Remi Despres-Smyth</a></cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="http://codebetter.com/karlseguin/2008/12/22/new-repository-lt-t-gt-domagic/#comment-1543">January 5, 2009 at 12:41 pm</a></div>

		<div class="comment-body"><p>Karl: Thanks for your thoughts &#8211; I really enjoyed the article.</p>
<p>Regards,<br />
Remi.</p>
</div>

		<div class="reply">
					</div>
	</div>

	</li>
		<li class="comment even thread-even depth-1" id="li-comment-1542">
		<div id="comment-1542">
		<div class="comment-author vcard">
			<img alt='' src='http://0.gravatar.com/avatar/ad516503a11cd5ca435acc9bb6523536?s=40' class='avatar avatar-40 photo avatar-default' height='40' width='40' />			<cite class="fn">karl</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="http://codebetter.com/karlseguin/2008/12/22/new-repository-lt-t-gt-domagic/#comment-1542">January 4, 2009 at 3:36 am</a></div>

		<div class="comment-body"><p>Remi:<br />
I think your approach is better for larger systems &#8211; I happened to be working on something with only a few domain objects so that&#8217;s the mindset I was in.</p>
<p>Keeping references to repositories within domain entities can cause all sorts of nasty bugs to creep up &#8211; largely causes by caching and such. I can&#8217;t remember the details, but I remember spending a few days tracking down an obscure bug which ended up being caused by entities holding on to references to stale repositories. I think it&#8217;s simply to simply use a DI framework and ask for the repository whenever its needed. This works well in .NET since the scope of a unit of work is generally tied to an individual request (it&#8217;s why the Session-per-request model for Nhibernate works so well too). Not sure how I&#8217;d go about doing it for non-web apps though.</p>
<p>Karl</p>
</div>

		<div class="reply">
					</div>
	</div>

	</li>
		<li class="comment odd alt thread-odd thread-alt depth-1" id="li-comment-1541">
		<div id="comment-1541">
		<div class="comment-author vcard">
			<img alt='' src='http://0.gravatar.com/avatar/ad516503a11cd5ca435acc9bb6523536?s=40' class='avatar avatar-40 photo avatar-default' height='40' width='40' />			<cite class="fn">karl</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="http://codebetter.com/karlseguin/2008/12/22/new-repository-lt-t-gt-domagic/#comment-1541">January 4, 2009 at 3:36 am</a></div>

		<div class="comment-body"><p>Remi:<br />
I think your approach is better for larger systems &#8211; I happened to be working on something with only a few domain objects so that&#8217;s the mindset I was in.</p>
<p>Keeping references to repositories within domain entities can cause all sorts of nasty bugs to creep up &#8211; largely causes by caching and such. I can&#8217;t remember the details, but I remember spending a few days tracking down an obscure bug which ended up being caused by entities holding on to references to stale repositories. I think it&#8217;s simply to simply use a DI framework and ask for the repository whenever its needed. This works well in .NET since the scope of a unit of work is generally tied to an individual request (it&#8217;s why the Session-per-request model for Nhibernate works so well too). Not sure how I&#8217;d go about doing it for non-web apps though.</p>
<p>Karl</p>
</div>

		<div class="reply">
					</div>
	</div>

	</li>
		<li class="comment even thread-even depth-1" id="li-comment-1540">
		<div id="comment-1540">
		<div class="comment-author vcard">
			<img alt='' src='http://0.gravatar.com/avatar/ad516503a11cd5ca435acc9bb6523536?s=40' class='avatar avatar-40 photo avatar-default' height='40' width='40' />			<cite class="fn"><a href='http://terracognita.ca/' rel='external nofollow' class='url'>Remi Despres-Smyth</a></cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="http://codebetter.com/karlseguin/2008/12/22/new-repository-lt-t-gt-domagic/#comment-1540">January 3, 2009 at 5:07 pm</a></div>

		<div class="comment-body"><p>Karl, I notice that your repository contains an instance of the domain class it represents.  In my case, when I&#8217;ve used repositories &#8211; even generic ones &#8211; I&#8217;ve typically set them up using a repository instance per domain aggregate class (passing the instance in by param), and not a repository per domain aggregate instance (which I believe is the implication here).</p>
<p>I would be interested in hearing your thoughts on the advantages in your approach.</p>
<p>Also, how does the repository get called for a loaded aggregate instance?  Who keeps a reference to the repository?</p>
<p>Regards,<br />
Remi.</p>
</div>

		<div class="reply">
					</div>
	</div>

	</li>
		<li class="comment odd alt thread-odd thread-alt depth-1" id="li-comment-1539">
		<div id="comment-1539">
		<div class="comment-author vcard">
			<img alt='' src='http://0.gravatar.com/avatar/ad516503a11cd5ca435acc9bb6523536?s=40' class='avatar avatar-40 photo avatar-default' height='40' width='40' />			<cite class="fn"><a href='http://terracognita.ca/' rel='external nofollow' class='url'>Remi Despres-Smyth</a></cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="http://codebetter.com/karlseguin/2008/12/22/new-repository-lt-t-gt-domagic/#comment-1539">January 3, 2009 at 5:07 pm</a></div>

		<div class="comment-body"><p>Karl, I notice that your repository contains an instance of the domain class it represents.  In my case, when I&#8217;ve used repositories &#8211; even generic ones &#8211; I&#8217;ve typically set them up using a repository instance per domain aggregate class, and not a repository per domain aggregate instance (which I believe is the implication here).</p>
<p>I would be interested in hearing your thoughts on the advantages in your approach.</p>
<p>Also, how does the repository get called for a loaded aggregate instance?  Who keeps a reference to the repository?</p>
<p>Regards,<br />
Remi.</p>
</div>

		<div class="reply">
					</div>
	</div>

	</li>
		<li class="comment even thread-even depth-1" id="li-comment-1538">
		<div id="comment-1538">
		<div class="comment-author vcard">
			<img alt='' src='http://0.gravatar.com/avatar/ad516503a11cd5ca435acc9bb6523536?s=40' class='avatar avatar-40 photo avatar-default' height='40' width='40' />			<cite class="fn"><a href='http://www.angryhacker.com/blog/' rel='external nofollow' class='url'>Robert G</a></cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="http://codebetter.com/karlseguin/2008/12/22/new-repository-lt-t-gt-domagic/#comment-1538">December 28, 2008 at 7:37 am</a></div>

		<div class="comment-body"><p>Karl, </p>
<p>I&#8217;d also like to see an implementation of DataFactory.  I can&#8217;t help but think that you&#8217;ll run into massive subtle issues once there is a real implementation.</p>
</div>

		<div class="reply">
					</div>
	</div>

	</li>
		<li class="comment odd alt thread-odd thread-alt depth-1" id="li-comment-1537">
		<div id="comment-1537">
		<div class="comment-author vcard">
			<img alt='' src='http://0.gravatar.com/avatar/ad516503a11cd5ca435acc9bb6523536?s=40' class='avatar avatar-40 photo avatar-default' height='40' width='40' />			<cite class="fn">karl</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="http://codebetter.com/karlseguin/2008/12/22/new-repository-lt-t-gt-domagic/#comment-1537">December 27, 2008 at 2:52 am</a></div>

		<div class="comment-body"><p>Fregas:<br />
Its our own class. Its a pretty straightforward query object&#8230;we then use a &#8220;Converter&#8221; to map it to our DAL. So for our Nhibernate DAL, we&#8217;ll have an NhibernateConverter It really isn&#8217;t hard to piece together. ModelQuery just contains a list of Creteria, a Pager class (which also does sorting) and you just add to it as you need (our supports joins and only selecting individual properties instead of full objects). Might write up on it some day.</p>
</div>

		<div class="reply">
					</div>
	</div>

	</li>
		<li class="comment even thread-even depth-1" id="li-comment-1536">
		<div id="comment-1536">
		<div class="comment-author vcard">
			<img alt='' src='http://0.gravatar.com/avatar/ad516503a11cd5ca435acc9bb6523536?s=40' class='avatar avatar-40 photo avatar-default' height='40' width='40' />			<cite class="fn"><a href='http://www.dotnettricks.com' rel='external nofollow' class='url'>Fregas</a></cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="http://codebetter.com/karlseguin/2008/12/22/new-repository-lt-t-gt-domagic/#comment-1536">December 26, 2008 at 3:13 pm</a></div>

		<div class="comment-body"><p>Whats that class you&#8217;re using &#8220;ModelQuery&#8221; ?  Is that part of NH or something you guys came up with?</p>
</div>

		<div class="reply">
					</div>
	</div>

	</li>
		<li class="comment odd alt thread-odd thread-alt depth-1" id="li-comment-1535">
		<div id="comment-1535">
		<div class="comment-author vcard">
			<img alt='' src='http://0.gravatar.com/avatar/ad516503a11cd5ca435acc9bb6523536?s=40' class='avatar avatar-40 photo avatar-default' height='40' width='40' />			<cite class="fn"><a href='http://blog.danielfernandes.net' rel='external nofollow' class='url'>Daniel Fernandes</a></cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="http://codebetter.com/karlseguin/2008/12/22/new-repository-lt-t-gt-domagic/#comment-1535">December 23, 2008 at 4:09 pm</a></div>

		<div class="comment-body"><p>@Daniel  : I would be cautious in using Linq as a query engine publicly exposed by your Repository.<br />
The compile time of Linq might be generic but it can crash on you hard at runtime so I would still use things such as Specification objects to encapsulate filtering logic.</p>
<p>@Troy : I did too take the IRepository<tentity , TPrimaryKey> route too, it seems it&#8217;s an easy way to get compile time safety but the way I see it sometimse Generics are plain annoying because they tend to leak very badly.<br />
I would say it&#8217;d be best to do something like :<br />
IRepository</tentity><tentity> {<br />
IPrimaryKey Key {get;set;}<br />
}<br />
Not the most common way of approaching this I know.<br />
</tentity></p>
</div>

		<div class="reply">
					</div>
	</div>

	</li>
		<li class="comment even thread-even depth-1" id="li-comment-1534">
		<div id="comment-1534">
		<div class="comment-author vcard">
			<img alt='' src='http://0.gravatar.com/avatar/ad516503a11cd5ca435acc9bb6523536?s=40' class='avatar avatar-40 photo avatar-default' height='40' width='40' />			<cite class="fn"><a href='http://colinjack.lostechies.com' rel='external nofollow' class='url'>Colin Jack</a></cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="http://codebetter.com/karlseguin/2008/12/22/new-repository-lt-t-gt-domagic/#comment-1534">December 23, 2008 at 4:05 pm</a></div>

		<div class="comment-body"><p>@Troy Goode<br />
If you mean me then I *didn&#8217;t* say that it wasn&#8217;t different&#8230;.I just said the reuse argument was baloney.</p>
<p>As for registering, thats just a single convention. You could write another one, look for all inerfaces inheriting from IRepository<t> (such as ICustomerRepository) and then register any classes implementing them (CustomerRepository). Not tried that exact convention, but can&#8217;t see a problem.</p>
<p>Also assuming people &#8220;must not be use DI/IoC&#8221; isn&#8217;t sensible, just because someone disagrees does not mean they are ignorant of the ideas.</t></p>
</div>

		<div class="reply">
					</div>
	</div>

	</li>
		<li class="comment odd alt thread-odd thread-alt depth-1" id="li-comment-1533">
		<div id="comment-1533">
		<div class="comment-author vcard">
			<img alt='' src='http://0.gravatar.com/avatar/ad516503a11cd5ca435acc9bb6523536?s=40' class='avatar avatar-40 photo avatar-default' height='40' width='40' />			<cite class="fn">karl</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="http://codebetter.com/karlseguin/2008/12/22/new-repository-lt-t-gt-domagic/#comment-1533">December 23, 2008 at 4:00 pm</a></div>

		<div class="comment-body"><p>@redgreenrefactor:<br />
I&#8217;ve wondered the same thing more than once. It&#8217;ll probably get there. Initially I had assumed that _how_ an entity versioned itself, or determined that it had to version itself would be different from type to type. As it turns out, so far, the code is almost identical, and thus a base type might be more suitable. Only have 2 fully versioned entities so far, maybe once I repeat the same code a 3rd time I&#8217;ll budge&#8230;continuous improvements.</p>
</div>

		<div class="reply">
					</div>
	</div>

	</li>
		<li class="comment even thread-even depth-1" id="li-comment-1532">
		<div id="comment-1532">
		<div class="comment-author vcard">
			<img alt='' src='http://0.gravatar.com/avatar/ad516503a11cd5ca435acc9bb6523536?s=40' class='avatar avatar-40 photo avatar-default' height='40' width='40' />			<cite class="fn">redgreenrefactor</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="http://codebetter.com/karlseguin/2008/12/22/new-repository-lt-t-gt-domagic/#comment-1532">December 23, 2008 at 2:59 pm</a></div>

		<div class="comment-body"><p>Hi Karl,</p>
<p>Nice writing. Why is IVersioned not a generic abstract class.</p>
</div>

		<div class="reply">
					</div>
	</div>

	</li>
		<li class="comment odd alt thread-odd thread-alt depth-1" id="li-comment-1531">
		<div id="comment-1531">
		<div class="comment-author vcard">
			<img alt='' src='http://0.gravatar.com/avatar/ad516503a11cd5ca435acc9bb6523536?s=40' class='avatar avatar-40 photo avatar-default' height='40' width='40' />			<cite class="fn"><a href='http://www.squaredroot.com' rel='external nofollow' class='url'>Troy Goode</a></cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="http://codebetter.com/karlseguin/2008/12/22/new-repository-lt-t-gt-domagic/#comment-1531">December 23, 2008 at 1:51 pm</a></div>

		<div class="comment-body"><p>A few comments:</p>
<p>1) We do exactly the same thing (even with almost the same naming, except our IRepository methods follow CRUD naming, e.g. Save = Update, Find = Retrieve).</p>
<p>2) Instead of IEntity, we use IEntity<t>, which allows for non-int keys (primarily for the tables that use Guid).</p>
<p>3) The people talking about this not being any different than using abstract base classes and such must not be use DI/IoC. Using DI/IoC (Autofac for me) and the generic repository, I can register ALL of my generic repositories with one line:</p>
<p>container.RegisterGeneric(typeof(NHibernateRepository< ,>)).As(typeof(IRepository< ,>));</p>
<p>Then, my service classes can just request an instance of IRepository<foo ,int> (second arg is id type) and it will automatically create the appropriate instance &#8211; no extra code needed.</foo></t></p>
</div>

		<div class="reply">
					</div>
	</div>

	</li>
		<li class="comment even thread-even depth-1" id="li-comment-1530">
		<div id="comment-1530">
		<div class="comment-author vcard">
			<img alt='' src='http://0.gravatar.com/avatar/ad516503a11cd5ca435acc9bb6523536?s=40' class='avatar avatar-40 photo avatar-default' height='40' width='40' />			<cite class="fn">JP</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="http://codebetter.com/karlseguin/2008/12/22/new-repository-lt-t-gt-domagic/#comment-1530">December 23, 2008 at 1:37 pm</a></div>

		<div class="comment-body"><p>Good Read!  I like the idea of IVersioned<t>.  </p>
<p>It always seem to bother me that we still &#8220;write&#8221; strategies like this.  I&#8217;ve written many, and have to say there is a point where they must be believed in for your fellow developers to use it wisely.  I&#8217;ve been reluctantly softening my walls to ef hoping that it pays off with the next drop.  At least v1 is released and they can&#8217;t pull an &#8220;object spaces&#8221;; although we did witness linq2sql getting absorbed. </t></p>
</div>

		<div class="reply">
					</div>
	</div>

	</li>
		<li class="comment odd alt thread-odd thread-alt depth-1" id="li-comment-1529">
		<div id="comment-1529">
		<div class="comment-author vcard">
			<img alt='' src='http://0.gravatar.com/avatar/ad516503a11cd5ca435acc9bb6523536?s=40' class='avatar avatar-40 photo avatar-default' height='40' width='40' />			<cite class="fn">Daniel</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="http://codebetter.com/karlseguin/2008/12/22/new-repository-lt-t-gt-domagic/#comment-1529">December 23, 2008 at 1:26 pm</a></div>

		<div class="comment-body"><p>I&#8217;d be interested in seeing more of DataFactory<t>.</p>
<p>I keep trying this and running into issues around queries and data types.  I think what we all want is a generic repository that handles POCOs and supports identical LINQ queries across different data stores.  This gets tricky fast, though, because there are so many different flavors of LINQ, and so many nuances in the data stores.  For example, I&#8217;ve seen lots of IRepository examples expose LINQ-to-SQL classes as domain objects.  This looks great until you try to implement an EF, XML, or SQL Data Services repository- the types either don&#8217;t work in the data store, or the queries are different between the two, or nuances like lazy loading implementations dictate different strategies. </t></p>
</div>

		<div class="reply">
					</div>
	</div>

	</li>
		<li class="comment even thread-even depth-1" id="li-comment-1528">
		<div id="comment-1528">
		<div class="comment-author vcard">
			<img alt='' src='http://0.gravatar.com/avatar/ad516503a11cd5ca435acc9bb6523536?s=40' class='avatar avatar-40 photo avatar-default' height='40' width='40' />			<cite class="fn"><a href='http://blog.danielfernandes.net' rel='external nofollow' class='url'>Daniel Fernandes</a></cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="http://codebetter.com/karlseguin/2008/12/22/new-repository-lt-t-gt-domagic/#comment-1528">December 23, 2008 at 8:15 am</a></div>

		<div class="comment-body"><p>@Chris : I don&#8217;t think the IVersioned<t> type check is really a worry, I instead think creating a subtype of the repository that puts another constraint on T as a smell though, who knows what combinations of constraints you will need ?<br />
I&#8217;d rather use a mechanism where you can have a registry of what types are interested for specific persistence events (pre save, post save, pre load, etc&#8230;).</t></p>
</div>

		<div class="reply">
					</div>
	</div>

	</li>
		<li class="comment odd alt thread-odd thread-alt depth-1" id="li-comment-1527">
		<div id="comment-1527">
		<div class="comment-author vcard">
			<img alt='' src='http://0.gravatar.com/avatar/ad516503a11cd5ca435acc9bb6523536?s=40' class='avatar avatar-40 photo avatar-default' height='40' width='40' />			<cite class="fn"><a href='http://blog.danielfernandes.net' rel='external nofollow' class='url'>Daniel Fernandes</a></cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="http://codebetter.com/karlseguin/2008/12/22/new-repository-lt-t-gt-domagic/#comment-1527">December 23, 2008 at 8:15 am</a></div>

		<div class="comment-body"><p>@Chris : I don&#8217;t think the IVersioned<t> type check is really a worry, I instead think creating a subtype of the repository that puts another constraint on T as a smell though, who knows what combinations of constraints you will need ?<br />
I&#8217;d rather use a mechanism where you can have a registry of what types are interested for specific persistence events (pre save, post save, pre load, etc&#8230;).</t></p>
</div>

		<div class="reply">
					</div>
	</div>

	</li>
		<li class="comment even thread-even depth-1" id="li-comment-1526">
		<div id="comment-1526">
		<div class="comment-author vcard">
			<img alt='' src='http://0.gravatar.com/avatar/ad516503a11cd5ca435acc9bb6523536?s=40' class='avatar avatar-40 photo avatar-default' height='40' width='40' />			<cite class="fn">Lars</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="http://codebetter.com/karlseguin/2008/12/22/new-repository-lt-t-gt-domagic/#comment-1526">December 23, 2008 at 7:55 am</a></div>

		<div class="comment-body"><p>Very nice, Karl. Very nice.<br />
Generic repositories are a big help in a system with lots of data access across types.</p>
<p>I did the whole Repository<t> thing with LINQ2Sql, and it worked like a charm.<br />
Actualle, it was a Repository</t><t ,DB, Mapper<T,DB>>, but that is only because we needed to do our own mapping from the L2Sql data types.</p>
<p>I also tried out doing a Repository</t><t>, just using the L2Sql data types throughout the app, but it always feels a bit hackish.<br />
I was able to create a custom querying class  that way though, I might write about it some day <img src='http://cdn1.codebetter.com/wp-includes/images/smilies/icon_wink.gif' alt=';)' class='wp-smiley' /> </t></p>
</div>

		<div class="reply">
					</div>
	</div>

	</li>
		<li class="comment odd alt thread-odd thread-alt depth-1" id="li-comment-1525">
		<div id="comment-1525">
		<div class="comment-author vcard">
			<img alt='' src='http://0.gravatar.com/avatar/ad516503a11cd5ca435acc9bb6523536?s=40' class='avatar avatar-40 photo avatar-default' height='40' width='40' />			<cite class="fn">karl</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="http://codebetter.com/karlseguin/2008/12/22/new-repository-lt-t-gt-domagic/#comment-1525">December 23, 2008 at 12:21 am</a></div>

		<div class="comment-body"><p>@Chris:<br />
It does smell a bit &#8211; though its still super-easy to test, which I tend to use as a general indication of whether something really has to be refactored or not. You could subclass the repository and have a VersionedRepository<t> and so on. I&#8217;d consider it, and I&#8217;d certainly consider it more as things got more complicated. Thanks for the suggestion.</t></p>
</div>

		<div class="reply">
					</div>
	</div>

	</li>
		<li class="comment even thread-even depth-1" id="li-comment-1524">
		<div id="comment-1524">
		<div class="comment-author vcard">
			<img alt='' src='http://0.gravatar.com/avatar/ad516503a11cd5ca435acc9bb6523536?s=40' class='avatar avatar-40 photo avatar-default' height='40' width='40' />			<cite class="fn">Chris</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="http://codebetter.com/karlseguin/2008/12/22/new-repository-lt-t-gt-domagic/#comment-1524">December 22, 2008 at 11:30 pm</a></div>

		<div class="comment-body"><p>Hi &#8211; that was interesting reading</p>
<p>One question though &#8211; isn&#8217;t checking whether a parameter is of a particular type (e.g. IVersioned) and doing one thing if it is and one thing if it isnt a code smell?</p>
<p>I&#8217;m not having a pop at you &#8211; but I have been reading Refactoring and Bob Martins book recent,y and Im sure that i mentioned as a no-no. (is it a violation of Liskov principle?)</p>
<p>would love to hear our opinion &#8211; even if i is to tell me I am wrong &#8211; which is deffinitely possible as I am still getting my head round all of this</p>
</div>

		<div class="reply">
					</div>
	</div>

	</li>
		<li class="comment odd alt thread-odd thread-alt depth-1" id="li-comment-1523">
		<div id="comment-1523">
		<div class="comment-author vcard">
			<img alt='' src='http://0.gravatar.com/avatar/ad516503a11cd5ca435acc9bb6523536?s=40' class='avatar avatar-40 photo avatar-default' height='40' width='40' />			<cite class="fn"><a href='http://colinjack.lostechies.com' rel='external nofollow' class='url'>Colin Jack</a></cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="http://codebetter.com/karlseguin/2008/12/22/new-repository-lt-t-gt-domagic/#comment-1523">December 22, 2008 at 10:37 pm</a></div>

		<div class="comment-body"><p>@karl<br />
Agreed, I&#8217;ve just read a few blog posts and heard a few arguments where people said that writing custom repositories led to too much redundnancy and so they moved to generic redundancies. Poppycock is my response to that <img src='http://cdn1.codebetter.com/wp-includes/images/smilies/icon_smile.gif' alt=':)' class='wp-smiley' /> </p>
<p>On the clean and tight, I&#8217;m not so sure. Custom repositories can be incredibly clean and tight, they&#8217;re focussed on behavior specific to that aggregate. </p>
<p>Also whilst custom query code can sometimes be wrapped in specifications eventually you&#8217;ll want to use a bit of SQL or do something clever (maybe swap to loading some aggregate or part of it from another source) which is when the real power of the custom repository kicks in.</p>
<p>Anyhow great blogpost, as always.</p>
</div>

		<div class="reply">
					</div>
	</div>

	</li>
		<li class="comment even thread-even depth-1" id="li-comment-1522">
		<div id="comment-1522">
		<div class="comment-author vcard">
			<img alt='' src='http://0.gravatar.com/avatar/ad516503a11cd5ca435acc9bb6523536?s=40' class='avatar avatar-40 photo avatar-default' height='40' width='40' />			<cite class="fn">karl</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="http://codebetter.com/karlseguin/2008/12/22/new-repository-lt-t-gt-domagic/#comment-1522">December 22, 2008 at 10:26 pm</a></div>

		<div class="comment-body"><p>@Colin:<br />
You&#8217;re right &#8211; the re-use isn&#8217;t because its a generic repository, it&#8217;s merely because its a base class (which can be extended or not if needed) &#8211; the generic aspect merely helps keep it clean and tight. Aside from that, the differences between the approach seems pretty small enough that we can probably agree that we&#8217;d understand each others code pretty easily &#8211; its in the same genus.</p>
<p>@Robin:<br />
The entity is there for non-fetch operations. How you deal with fetches is up to you, I&#8217;ve seen a separate read-specific repository, static members, parameterless constructor (have to be careful that someone doesn&#8217;t call Save() though) and so on.</p>
</div>

		<div class="reply">
					</div>
	</div>

	</li>
		<li class="comment odd alt thread-odd thread-alt depth-1" id="li-comment-1521">
		<div id="comment-1521">
		<div class="comment-author vcard">
			<img alt='' src='http://0.gravatar.com/avatar/ad516503a11cd5ca435acc9bb6523536?s=40' class='avatar avatar-40 photo avatar-default' height='40' width='40' />			<cite class="fn"><a href='http://colinjack.lostechies.com' rel='external nofollow' class='url'>Colin Jack</a></cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="http://codebetter.com/karlseguin/2008/12/22/new-repository-lt-t-gt-domagic/#comment-1521">December 22, 2008 at 10:09 pm</a></div>

		<div class="comment-body"><p>@Bil Simser<br />
Yeah I use a similiar approach, find it gives me all the advantages with no particular disadvantages (that I&#8217;m aware of).</p>
</div>

		<div class="reply">
					</div>
	</div>

	</li>
		<li class="comment even thread-even depth-1" id="li-comment-1520">
		<div id="comment-1520">
		<div class="comment-author vcard">
			<img alt='' src='http://0.gravatar.com/avatar/ad516503a11cd5ca435acc9bb6523536?s=40' class='avatar avatar-40 photo avatar-default' height='40' width='40' />			<cite class="fn"><a href='http://robinclowers.blogspot.com' rel='external nofollow' class='url'>Robin Clowers</a></cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="http://codebetter.com/karlseguin/2008/12/22/new-repository-lt-t-gt-domagic/#comment-1520">December 22, 2008 at 10:07 pm</a></div>

		<div class="comment-body"><p>Why do you pass an instance of your IEntity into your generic repository?  What if you just need to do a fetch operation, do you pass in a null instance?</p>
</div>

		<div class="reply">
					</div>
	</div>

	</li>
		<li class="comment odd alt thread-odd thread-alt depth-1" id="li-comment-1519">
		<div id="comment-1519">
		<div class="comment-author vcard">
			<img alt='' src='http://0.gravatar.com/avatar/ad516503a11cd5ca435acc9bb6523536?s=40' class='avatar avatar-40 photo avatar-default' height='40' width='40' />			<cite class="fn"><a href='http://colinjack.lostechies.com' rel='external nofollow' class='url'>Colin Jack</a></cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="http://codebetter.com/karlseguin/2008/12/22/new-repository-lt-t-gt-domagic/#comment-1519">December 22, 2008 at 10:06 pm</a></div>

		<div class="comment-body"><p>&#8220;I see more and more applications making use of numerous XXXRepository classes, and wonder whether they get tired, like I did, of copy-n-pasting the same base code and tests.&#8221;</p>
<p>This whole generic repository and reuse thing leaves me a little puzzled, because leaveraging interfaces/generics to get lots of reuse is what people have been doing since 2.0 came out and has certainly been what I&#8217;ve been doing since I started using repositories (same for most people I know of).</p>
<p>I do disagree with your conclusion that this reuse is caused by you using generic repositories, you can get massive quantities of reuse through careful use of inheritance/composition and still have concrete repositories.</p>
<p>In our case we quickly extracted all common code and added base classes, allowing inheritance and/or composition (whichever you prefer) for reuse. So you could use RepositoryHelper<t> through composition or you could inherit from ReadWriteRepository</t><t>. This took me very little time and meant for simple CRUD you got all the code for free (<a href="http://tech.groups.yahoo.com/group/domaindrivendesign/message/9053" rel="nofollow">http://tech.groups.yahoo.com/group/domaindrivendesign/message/9053</a>).</p>
<p>The custom repositories then just contain any custom queries, SQL (for performance) or mapping (maybe from DTO&#8217;s or web services).</p>
<p>Same applied for testing, you had a DeleteTestHelper</t><t>, a SaveTestHelper</t><t> and so on. To make this easy my repositories implemented interfaces like IDelete</t><t> and DeleteTestHelper</t><t> used those interfaces. Actually we also had base classes like AggregateRootPersistenceTestBase</t><t>, you had to overload a few methods like CreateRepository/CreateAggregateRoot but other than that it could take care of the vast majority of the work.</p>
<p>Overall I think this is much preferable to the generic Repository</t><t> approach, other than (perhaps) for relatively simple scenarios (though even then I don&#8217;t particularly rate the generic approach).</t></p>
</div>

		<div class="reply">
					</div>
	</div>

	</li>
		<li class="comment even thread-even depth-1" id="li-comment-1518">
		<div id="comment-1518">
		<div class="comment-author vcard">
			<img alt='' src='http://0.gravatar.com/avatar/ad516503a11cd5ca435acc9bb6523536?s=40' class='avatar avatar-40 photo avatar-default' height='40' width='40' />			<cite class="fn"><a href='http://www.highoncoding.com' rel='external nofollow' class='url'>Mohammad Azam</a></cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="http://codebetter.com/karlseguin/2008/12/22/new-repository-lt-t-gt-domagic/#comment-1518">December 22, 2008 at 9:31 pm</a></div>

		<div class="comment-body"><p>Hi Karl, </p>
<p>Very nice post! I also played around with a single generic repository. One of the main problems I faced was when using special cases. Also, I was caching the results of the method call and only wanted to cache for some cases. This can be accomplished by overriding the method in the concrete repository class. </p>
</div>

		<div class="reply">
					</div>
	</div>

	</li>
		<li class="comment odd alt thread-odd thread-alt depth-1" id="li-comment-1517">
		<div id="comment-1517">
		<div class="comment-author vcard">
			<img alt='' src='http://0.gravatar.com/avatar/ad516503a11cd5ca435acc9bb6523536?s=40' class='avatar avatar-40 photo avatar-default' height='40' width='40' />			<cite class="fn">Paco</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="http://codebetter.com/karlseguin/2008/12/22/new-repository-lt-t-gt-domagic/#comment-1517">December 22, 2008 at 8:17 pm</a></div>

		<div class="comment-body"><p>I used to use a generic repository, but I removed it and made it an abstract base class, because I always seam to have special cases. I don&#8217;t like to expose persistence implementation specific stuff like IQueryable to other parts of the system then the repository classes itself. What about YAGNI? It&#8217;s useless to have a public findall method in a repository querying against a millions of record db.</p>
</div>

		<div class="reply">
					</div>
	</div>

	</li>
		<li class="comment even thread-even depth-1" id="li-comment-1516">
		<div id="comment-1516">
		<div class="comment-author vcard">
			<img alt='' src='http://0.gravatar.com/avatar/ad516503a11cd5ca435acc9bb6523536?s=40' class='avatar avatar-40 photo avatar-default' height='40' width='40' />			<cite class="fn"><a href='http://blog.sb2.fr' rel='external nofollow' class='url'>Yoann. B</a></cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="http://codebetter.com/karlseguin/2008/12/22/new-repository-lt-t-gt-domagic/#comment-1516">December 22, 2008 at 7:51 pm</a></div>

		<div class="comment-body"><p>Great article,</p>
<p>Thanks.</p>
</div>

		<div class="reply">
					</div>
	</div>

	</li>
		<li class="comment odd alt thread-odd thread-alt depth-1" id="li-comment-1515">
		<div id="comment-1515">
		<div class="comment-author vcard">
			<img alt='' src='http://0.gravatar.com/avatar/ad516503a11cd5ca435acc9bb6523536?s=40' class='avatar avatar-40 photo avatar-default' height='40' width='40' />			<cite class="fn"><a href='http://weblogs.asp.net/bsimser' rel='external nofollow' class='url'>Bil Simser</a></cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="http://codebetter.com/karlseguin/2008/12/22/new-repository-lt-t-gt-domagic/#comment-1515">December 22, 2008 at 7:04 pm</a></div>

		<div class="comment-body"><p>I find I do the same, I have an IRepository that is implemented by a generic BaseRepository which handles all of the normal basics (Get, Find, FindAll, Query, Update, Delete, etc.). The specialized repositories (say for a Customer) would have methods specific to features I needed to optimize the Customer UI pipeline (GetAllCustomersMatchingSomeSpecification). The last method could be generic&#8217;ized using an ISpecification and ISpecification.Matches but that might be pushing it). In the end I have specialized repository classes with very few methods and an abstract generic one that handles the majority of the world. Must watch viddler to see the debate though as I would rather have just one if it would work for all cases.</p>
</div>

		<div class="reply">
					</div>
	</div>

	</li>
		<li class="comment even thread-even depth-1" id="li-comment-1514">
		<div id="comment-1514">
		<div class="comment-author vcard">
			<img alt='' src='http://0.gravatar.com/avatar/ad516503a11cd5ca435acc9bb6523536?s=40' class='avatar avatar-40 photo avatar-default' height='40' width='40' />			<cite class="fn"><a href='http://codebetter.com/blogs/jeremy.miller' rel='external nofollow' class='url'>Jeremy D. Miller</a></cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="http://codebetter.com/karlseguin/2008/12/22/new-repository-lt-t-gt-domagic/#comment-1514">December 22, 2008 at 6:34 pm</a></div>

		<div class="comment-body"><p>Karl,</p>
<p>We use Linq for NHibernate and enforce a rigid rule of always using the same identity strategy for each entity, so we get away with only having IRepository with generic methods for Find<t>() and Query</t><t>() to avoid all the rinse and repeat repository coding.  Add the overhead of wanting in memory repositories for testing, and I much prefer the single repository class over having individual repository classes.</p>
<p>Ayende &#038; I had a debate on this subject at KaizenConf at the Opinionated MVC talk that&#8217;s on Viddler.</t></p>
</div>

		<div class="reply">
					</div>
	</div>

	</li>
			</ol>



								
</div><!-- #comments -->

		</div><!-- #main -->
			<div id="sidebar" class="grid_4">

		<div id="primary" class="widget-area">
			<ul class="xoxo">
				<div class="ad-container">
<script type='text/javascript'><!--// <![CDATA[
    OA_show(29416);
// ]]> --></script><noscript><a target='_blank' href='http://d1.openx.org/ck.php?n=2782afb'><img border='0' alt='' src='http://d1.openx.org/avw.php?zoneid=29416&amp;n=2782afb' /></a></noscript><script type='text/javascript'><!--// <![CDATA[
    OA_show(29417);
// ]]> --></script><noscript><a target='_blank' href='http://d1.openx.org/ck.php?n=e94cea6'><img border='0' alt='' src='http://d1.openx.org/avw.php?zoneid=29417&amp;n=e94cea6' /></a></noscript><script type='text/javascript'><!--// <![CDATA[
    OA_show(29418);
// ]]> --></script><noscript><a target='_blank' href='http://d1.openx.org/ck.php?n=9ba3022'><img border='0' alt='' src='http://d1.openx.org/avw.php?zoneid=29418&amp;n=9ba3022' /></a></noscript><script type='text/javascript'><!--// <![CDATA[
    OA_show(29419);
// ]]> --></script><noscript><a target='_blank' href='http://d1.openx.org/ck.php?n=f467b52'><img border='0' alt='' src='http://d1.openx.org/avw.php?zoneid=29419&amp;n=f467b52' /></a></noscript>
				</div>
			
				<li id="user_bio-2" class="widget-container widget_user_bio"><h3 class="widget-title"></h3>One of these days I will add something to my user profile! For now, I shall remain mysterious.
</li>		
						
			</ul>
			
		</div><!-- #primary .widget-area -->
		
		<div id="secondary" class="widget-area">
				
<script type='text/javascript'><!--// <![CDATA[
    OA_show(220407);
// ]]> --></script><noscript><a target='_blank' href='http://d1.openx.org/ck.php?n=68b8307'><img border='0' alt='' src='http://d1.openx.org/avw.php?zoneid=220407&amp;n=68b8307' /></a></noscript>				
				
				<ul class="xoxo">		
									</ul>	
				
<script type='text/javascript'><!--// <![CDATA[
    OA_show(29421);
// ]]> --></script><noscript><a target='_blank' href='http://d1.openx.org/ck.php?n=3f8e353'><img border='0' alt='' src='http://d1.openx.org/avw.php?zoneid=29421&amp;n=3f8e353' /></a></noscript>
				
		</div><!-- #secondary .widget-area -->			</div><!--sidebar-->
		</div><!-- #container -->
</div><!-- end div tabs see header.php -->
	
	<div id="footer">
		<div class="container_12">
		<div id="footer-widget-area">
				<div class="grid_4">					
					<ul>
					<li><a href="http://codebetter.com" title="home">Home</a></li>
					<li class="page_item page-item-2"><a href="http://codebetter.com/about/">About</a></li>
<li class="page_item page-item-8"><a href="http://codebetter.com/codebetter-ci/">CodeBetter CI</a></li>
<li class="page_item page-item-6"><a href="http://codebetter.com/community/">Community</a></li>
<li class="page_item page-item-10"><a href="http://codebetter.com/editors/">Editors</a></li>
<li class="page_item page-item-41"><a href="http://codebetter.com/globalsearch/">Search Results</a></li>
					<li><a href="http://feeds.feedburner.com/CodeBetter" rel="alternate" type="application/rss+xml"><img src="http://www.feedburner.com/fb/images/pub/feed-icon16x16.png" alt="" style="vertical-align:middle;border:0"/></a><a href="http://feeds.feedburner.com/CodeBetter"><img src="http://feeds.feedburner.com/~fc/CodeBetter?bg=FFFFFF&amp;fg=2E9BD2&amp;anim=1" height="26" width="88" style="vertical-align:middle;border:0"/></a></li>
					</ul>
				</div><!-- #second .widget-area -->
				<div class="grid_4">
					
					<h3>Friends of CodeBetter.Com</h3>
<ul>

<li><a href="http://red-gate.com/">Red-Gate Tools For SQL and .NET</a></li>
<li><a href="http://telerik.com">Telerik .NET Tools</a></li>
<li><a href="http://jetbrains.com/resharper/">JetBrains - ReSharper</a></li>
<li><a href="http://scootersoftware.com">Beyond Compare</a></li>
<li><a href="http://www.ndepend.com/">NDepend</a></li>
<li><a href="http://www.sapphiresteel.com/">Ruby In Steel</a></li>
<li><a href="http://www.slickedit.com/">SlickEdit</a></li>
<li><a href="http://www.gurock.com/products/smartinspect/">SmartInspect .NET Logging</a></li>
<li>NGEDIT: <a href="http://www.viemu.com/">ViEmu</a> and <a href="http://www.codekana.com/">Codekana</a> </li>
<li><a href="http://www.devexpress.com/" target="_blank">DevExpress</a></li>
<li><a href="http://nhprof.com" target="_blank">NHibernate Profiler</a></li>
<li><a href="http://unfuddle.com" target="_blank">Unfuddle</a></li>
<li><a href="http://www.balsamiq.com/products/mockups" target="_blank">Balsamiq Mockups</a></li>
<li><a href="http://scrumy.com" target="_blank">Scrumy</a></li>
<li><a href="http://umbraco.com" target="_blank">Umbraco</a></li>
<li><a href="http://nservicebus.com" target="_blank">NServiceBus</a></li>
<li><a href="http://ravendb.net" target="_blank">RavenDb</a></li>
<li><a href="http://www.websequencediagrams.com/" target="_blank">Web Sequence Diagrams</a></li>
	</ul>				
				</div><!-- #third .widget-area -->
				<div class="grid_4">
					CodeBetter.Com &copy; '12<br />
						Stuff you need to Code Better!<br />
				Proudly powered by <span id="generator-link"><a href="http://wordpress.org/" title="Semantic Personal Publishing Platform" rel="generator">WordPress</a></span>.					
				</div><!-- #fourth .widget-area -->
			</div><!-- #footer-widget-area -->		
		
			</div><!-- end div.container_12 -->

	</div><!-- end div#footer -->
		
<script type="text/javascript">

  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-531207-1']);
  _gaq.push(['_trackPageview']);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();

</script>
<script type='text/javascript' src='http://cdn1.codebetter.com/wp-content/plugins/syntaxhighlighter/syntaxhighlighter3/scripts/shCore.js?ver=3.0.83b'></script>
<script type='text/javascript' src='http://cdn1.codebetter.com/wp-content/plugins/syntaxhighlighter/syntaxhighlighter3/scripts/shBrushCSharp.js?ver=3.0.83b'></script>
<script type='text/javascript' src='http://cdn1.codebetter.com/wp-content/plugins/syntaxhighlighter/syntaxhighlighter3/scripts/shBrushRuby.js?ver=3.0.83b'></script>
<script type='text/javascript' src='http://cdn1.codebetter.com/wp-content/plugins/syntaxhighlighter/syntaxhighlighter3/scripts/shBrushJScript.js?ver=3.0.83b'></script>
<script type='text/javascript' src='http://cdn1.codebetter.com/wp-content/plugins/syntaxhighlighter/syntaxhighlighter3/scripts/shBrushXml.js?ver=3.0.83b'></script>
<script type='text/javascript' src='http://cdn1.codebetter.com/wp-content/plugins/syntaxhighlighter/syntaxhighlighter3/scripts/shBrushPython.js?ver=3.0.83b'></script>
<script type='text/javascript' src='http://cdn1.codebetter.com/wp-content/plugins/syntaxhighlighter/third-party-brushes/shBrushFSharp.js?ver=3.0.83b'></script>
<script type='text/javascript'>
	(function(){
		var corecss = document.createElement('link');
		var themecss = document.createElement('link');
		var corecssurl = "http://cdn1.codebetter.com/wp-content/plugins/syntaxhighlighter/syntaxhighlighter3/styles/shCore.css?ver=3.0.83b";
		if ( corecss.setAttribute ) {
				corecss.setAttribute( "rel", "stylesheet" );
				corecss.setAttribute( "type", "text/css" );
				corecss.setAttribute( "href", corecssurl );
		} else {
				corecss.rel = "stylesheet";
				corecss.href = corecssurl;
		}
		document.getElementsByTagName("head")[0].insertBefore( corecss, document.getElementById("syntaxhighlighteranchor") );
		var themecssurl = "http://cdn1.codebetter.com/wp-content/plugins/syntaxhighlighter/syntaxhighlighter3/styles/shThemeDefault.css?ver=3.0.83b";
		if ( themecss.setAttribute ) {
				themecss.setAttribute( "rel", "stylesheet" );
				themecss.setAttribute( "type", "text/css" );
				themecss.setAttribute( "href", themecssurl );
		} else {
				themecss.rel = "stylesheet";
				themecss.href = themecssurl;
		}
		//document.getElementById("syntaxhighlighteranchor").appendChild(themecss);
		document.getElementsByTagName("head")[0].insertBefore( themecss, document.getElementById("syntaxhighlighteranchor") );
	})();
	SyntaxHighlighter.config.strings.expandSource = '+ expand source';
	SyntaxHighlighter.config.strings.help = '?';
	SyntaxHighlighter.config.strings.alert = 'SyntaxHighlighter\n\n';
	SyntaxHighlighter.config.strings.noBrush = 'Can\'t find brush for: ';
	SyntaxHighlighter.config.strings.brushNotHtmlScript = 'Brush wasn\'t configured for html-script option: ';
	SyntaxHighlighter.defaults['gutter'] = false;
    SyntaxHighlighter.defaults['tab-size'] = 2;
    SyntaxHighlighter.defaults['toolbar'] = false;
    SyntaxHighlighter.defaults['wrap-lines'] = true; 
	SyntaxHighlighter.defaults['pad-line-numbers'] = false;
	SyntaxHighlighter.all();
</script>

<script type='text/javascript'>//<![CDATA[
    if (typeof jQuery == 'undefined') {
        document.write(unescape("%3Cscript src='http://ajax.aspnetcdn.com/ajax/jQuery/jquery-1.4.2.min.js' type='text/javascript' %3E%3C/script%3E"));
    }//]]></script>
<script type='text/javascript' language='Javascript' src='http://s1.lqcdn.com/m.min.js?dt=2.3.110202.1'></script>
<script type='text/javascript' language='Javascript'> if(jQuery.LqmAds)jQuery.LqmAds();</script>
 
</body>
</html>
<!-- Dynamic page generated in 0.506 seconds. -->
<!-- Cached page generated by WP-Super-Cache on 2012-11-09 23:48:16 -->
<!-- super cache -->