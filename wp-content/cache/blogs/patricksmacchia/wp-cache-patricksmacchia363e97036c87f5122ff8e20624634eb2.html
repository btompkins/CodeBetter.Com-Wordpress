<?xml version="1.0" encoding="UTF-8"?>
<rss version="2.0"
	xmlns:content="http://purl.org/rss/1.0/modules/content/"
	xmlns:wfw="http://wellformedweb.org/CommentAPI/"
	xmlns:dc="http://purl.org/dc/elements/1.1/"
	xmlns:atom="http://www.w3.org/2005/Atom"
	xmlns:sy="http://purl.org/rss/1.0/modules/syndication/"
	xmlns:slash="http://purl.org/rss/1.0/modules/slash/"
	>

<channel>
	<title>Patrick Smacchia</title>
	<atom:link href="http://codebetter.com/patricksmacchia/feed/" rel="self" type="application/rss+xml" />
	<link>http://codebetter.com/patricksmacchia</link>
	<description>CodeBetter.Com - Stuff you need to Code Better!</description>
	<lastBuildDate>Wed, 31 Oct 2012 15:14:28 +0000</lastBuildDate>
	<language>en-US</language>
	<sy:updatePeriod>hourly</sy:updatePeriod>
	<sy:updateFrequency>1</sy:updateFrequency>
	<generator>http://wordpress.org/?v=3.4.2</generator>
		<item>
		<title>Two Screencasts on How to Demystify Spaghetti Code</title>
		<link>http://codebetter.com/patricksmacchia/2012/10/31/two-screencasts-on-how-to-demystify-spaghetti-code/</link>
		<comments>http://codebetter.com/patricksmacchia/2012/10/31/two-screencasts-on-how-to-demystify-spaghetti-code/#comments</comments>
		<pubDate>Wed, 31 Oct 2012 15:14:28 +0000</pubDate>
		<dc:creator>Patrick Smacchia</dc:creator>
				<category><![CDATA[.NET assemblies]]></category>
		<category><![CDATA[.NET Framework]]></category>
		<category><![CDATA[.NET Fx]]></category>
		<category><![CDATA[Acyclic componentization]]></category>
		<category><![CDATA[Code Dependency]]></category>
		<category><![CDATA[Component]]></category>
		<category><![CDATA[CQLinq]]></category>
		<category><![CDATA[Cycle]]></category>
		<category><![CDATA[DAG]]></category>
		<category><![CDATA[Dependencies]]></category>
		<category><![CDATA[Dependency Cycle]]></category>
		<category><![CDATA[Dependency Graph]]></category>
		<category><![CDATA[Dependency Matrix]]></category>
		<category><![CDATA[graph of callers]]></category>
		<category><![CDATA[Graph of Dependencies]]></category>
		<category><![CDATA[Indirect Dependency]]></category>
		<category><![CDATA[Pattern]]></category>
		<category><![CDATA[Patterns]]></category>

		<guid isPermaLink="false">http://codebetter.com/patricksmacchia/?p=752</guid>
		<description><![CDATA[In my consultant career, no matter the kind of company I visited, from the tiny startup to the largest fortune 500 corporation, they all have in common to be entangled in spaghetti. Spaghetti means poorly structured code. Spaghetti means high maintenance and&#160;&#8230; <a href="http://codebetter.com/patricksmacchia/2012/10/31/two-screencasts-on-how-to-demystify-spaghetti-code/">Continue&#160;reading&#160;<span class="meta-nav">&#8594;</span></a>]]></description>
			<content:encoded><![CDATA[<p>In my consultant career, no matter the kind of company I visited, from the tiny startup to the largest fortune 500 corporation, they all have in common to be entangled in spaghetti. Spaghetti means poorly structured code. Spaghetti means high maintenance and evolution cost. Spaghetti means frustration, friction and lack of motivation for everyone in the team. And often, spaghetti means project failure.</p>
<p>Mastering code structure means demystifying and getting rid of spaghetti code! With <a href="http://blog.filipekberg.se/" target="_blank">Filip Ekberg</a>, we propose you to cover in-depth code dependencies management through two 30 minutes screencasts. The tool <a href="http://www.NDepend.com" target="_blank">NDepend</a> is used to shed light on the structure of real-world code bases.</p>
<p>The first screencast shows how to make the best of dependency graph and dependency matrix tooling to explore the structure of a .NET application. This includes detecting at a glance good patterns or smelly patterns, buried in the code. In this screencast, we also explain how to master interaction between code query LINQ generation and dependency graph and matrix. Doing so constitutes a very powerful way to generate all custom graph you really need to visualize, like custom call graphs and inheritance graphs.</p>
<p>The second screencast starts with focusing on dependency code rules. This is especially useful to write rules related to Object-Oriented tenets, like <em>base class shouldn&#8217;t use derivatives</em>, or to list <em>instance method that could be made static</em>. We then continue with rules concerned with layered architecture, like <em>UI layer shouldn&#8217;t use the DAL layer</em> or <em>components dependency cycles </em>detection. We finally explore entangled layering in the real-world, and explain how to get rid of spaghetti and achieve well structured code bases.</p>
<p>These screencats contain many original and useful <em>haha</em> hints that will improve the way you and your team manage your .NET code base dependencies.</p>
<p>Enjoy <img src='http://cdn1.codebetter.com/wp-includes/images/smilies/icon_smile.gif' alt=':)' class='wp-smiley' /> </p>
<p><strong>Part I</strong></p>
<p><iframe src="http://player.vimeo.com/video/52020901" width="640" height="360" frameborder="0" webkitAllowFullScreen mozallowfullscreen allowFullScreen></iframe></p>
<p><strong>Part II</strong></p>
<p><iframe src="http://player.vimeo.com/video/52423676" width="640" height="360" frameborder="0" webkitAllowFullScreen mozallowfullscreen allowFullScreen></iframe></p>
]]></content:encoded>
			<wfw:commentRss>http://codebetter.com/patricksmacchia/2012/10/31/two-screencasts-on-how-to-demystify-spaghetti-code/feed/</wfw:commentRss>
		<slash:comments>1</slash:comments>
		</item>
		<item>
		<title>Validating Architecture through LINQ Query</title>
		<link>http://codebetter.com/patricksmacchia/2012/10/26/validating-architecture-through-one-linq-query/</link>
		<comments>http://codebetter.com/patricksmacchia/2012/10/26/validating-architecture-through-one-linq-query/#comments</comments>
		<pubDate>Fri, 26 Oct 2012 09:53:18 +0000</pubDate>
		<dc:creator>Patrick Smacchia</dc:creator>
				<category><![CDATA[C#]]></category>
		<category><![CDATA[Code Dependency]]></category>
		<category><![CDATA[Code Query]]></category>
		<category><![CDATA[Code Rule]]></category>
		<category><![CDATA[code structure]]></category>
		<category><![CDATA[Code visualization]]></category>
		<category><![CDATA[CQLinq]]></category>
		<category><![CDATA[Dependency Matrix]]></category>
		<category><![CDATA[Layer]]></category>
		<category><![CDATA[LINQ]]></category>
		<category><![CDATA[namespace]]></category>
		<category><![CDATA[namespaces]]></category>
		<category><![CDATA[NDepend]]></category>
		<category><![CDATA[Pattern]]></category>
		<category><![CDATA[Patterns]]></category>
		<category><![CDATA[Performance]]></category>

		<guid isPermaLink="false">http://codebetter.com/patricksmacchia/?p=731</guid>
		<description><![CDATA[These days we are restructuring the NDepend code base to make it more suited to welcome future features implementation. Here is below the new architecture of the NDepend.UI assembly, made of around 50.000 lines of code, shown through a Dependency Structure&#160;&#8230; <a href="http://codebetter.com/patricksmacchia/2012/10/26/validating-architecture-through-one-linq-query/">Continue&#160;reading&#160;<span class="meta-nav">&#8594;</span></a>]]></description>
			<content:encoded><![CDATA[<p>These days we are restructuring the NDepend code base to make it more suited to welcome future features implementation. Here is below the new architecture of the NDepend.UI assembly, made of around 50.000 lines of code, shown through a <a href="http://www.ndepend.com/Doc_Matrix.aspx" target="_blank">Dependency Structure Matrix</a>:</p>
<p><a href="http://codebetter.com/patricksmacchia/files/2012/10/Matrix1.png"><img class="alignnone size-full wp-image-743" src="http://codebetter.com/patricksmacchia/files/2012/10/Matrix1.png" alt="" width="595" height="429" /></a></p>
<p>As always, the dependency matrix naturally exhibits architectural patterns. Keep in mind that a <span style="color: #0000ff">blue cell</span> means: the namespace in column is using the namespace in row. The number on a <span style="color: #0000ff">blue cell</span> represents the number of members used (see the option in the matrix menu: <em>Weight on Cells</em> set to <em>Direct: # members</em>). This cell number is then a measure of the coupling between the two namespaces.</p>
<p>Here are architecture patterns emerging from this dependency matrix:</p>
<ul>
<li>There is one <strong>Top</strong> namespace, that is using all namespaces (<span style="color: #0000ff">blue column #0</span>)</li>
<li>There is one <strong>Base</strong> namespace, that is used by all namespaces (<span style="color: #0000ff">blue row #17</span>)</li>
<li>The <strong>Panels</strong> namespaces don&#8217;t use each others (<span style="color: #ff0000">empty big red square</span>, rows/columns [1-12])</li>
<li>The <strong>Shared</strong> namespaces don&#8217;t use each others (<span style="color: #ff0000">empty small red square</span>, rows/columns [13-16])</li>
<li>The <span style="color: #0000ff">blue cells</span> in the rectangle rows [13,16] x columns [1,12], represents the usage of shared features by the panels. For example, on row #15 we can see that the <strong>DependencyContextMenu</strong> feature is used by the <strong>Top</strong>, <strong>Graph</strong> and <strong>Matrix</strong> impl.</li>
</ul>
<p>I found this NDepend.UI architecture pretty neat. Whether we will add a new panel or a new shared feature in the future, it will be inserted naturally in this structure. And this architecture is simple enough to get validated at a glance. But at a glance is not enough. What about defining custom rules that take care of validating this architecture and inform us <em>automatically</em> of any violation?</p>
<p>Each of this architecture pattern could be actually validated through a <a href="http://www.ndepend.com/Features.aspx#CQL" target="_blank">Code Query LINQ</a> rule. Let&#8217;s go through 5 steps to write the rule <strong>Panels shouldn&#8217;t use each others</strong> through a LINQ query.</p>
<h2><strong>5 steps to write the rule: Panels shouldn&#8217;t use each others</strong></h2>
<p><span style="text-decoration: underline"><strong>Step 1:</strong></span> First, let&#8217;s match all panels namespaces. Here we are using the extension method <a href="http://www.ndepend.com/API/webframe.html?NDepend.API~NDepend.CodeModel.ExtensionMethodsNaming~WithNameWildcardMatch.html" target="_blank">WithNameWildcardMatch()</a> to match the panels namespaces by name. We can see that some panels (<em>Matrix, QueryEdit, Search</em>&#8230;) are made of several sub-namespaces. The rule must be smart enough to both:</p>
<ul>
<li>let sub-namespaces of a panel use each others,</li>
<li>forbid sub-namespaces of different panels use each others:</li>
</ul>
<p><a href="http://codebetter.com/patricksmacchia/files/2012/10/Query1.png"><img class="alignnone size-full wp-image-734" src="http://codebetter.com/patricksmacchia/files/2012/10/Query1.png" alt="" width="563" height="715" /></a></p>
<p><strong><span style="text-decoration: underline">Step 2:</span> </strong>Now let&#8217;s use the method <a href="http://www.ndepend.com/API/webframe.html?NDepend.API~NDepend.CodeModel.IUser~IsUsing.html" target="_blank">IUser.IsUsing()</a> to list the couples of [namespace user, namespace used]. Notice that to improve the query performance:</p>
<ul>
<li>we are restraining the set of namespaces <em>user</em> only to the panels namespaces that are indeed <em>using</em> another panel namespace (with the extension method <a href="http://www.ndepend.com/API/webframe.html?NDepend.API~NDepend.CodeModel.ExtensionMethodsSequenceUsage~UsingAny.html" target="_blank">UsingAny()</a> )</li>
<li>we are restraining the set of namespaces <em>used</em> only to the panels namespaces that are indeed <em>used by</em> another panel namespace (with the extension method <a href="http://www.ndepend.com/API/webframe.html?NDepend.API~NDepend.CodeModel.ExtensionMethodsSequenceUsage~UsedByAny.html" target="_blank">UsedByAny()</a> )</li>
</ul>
<div><span style="font-size: medium"><span style="line-height: 24px">And indeed the query runs fast: 5 milli-seconds on a more than 130.000 lines of code code base! There are 45 couples of [namespace user, namespace used] listed:</span></span></div>
<p><a href="http://codebetter.com/patricksmacchia/files/2012/10/Query2.png"><img class="alignnone size-full wp-image-740" src="http://codebetter.com/patricksmacchia/files/2012/10/Query2.png" alt="" width="559" height="854" /></a></p>
<p><strong><span style="text-decoration: underline">Step 3:</span> </strong>Now, we need to validate for each couple of [namespace user, namespace used], that both user/used namespaces belong to the same panel. For that we have to work on the namespace name string. Let&#8217;s first get rid of the prefix <em>&#8220;NDepend.UI.Panels.&#8221;</em> and obtain for each namespace what we call its<em> sub-name</em>:</p>
<p><a href="http://codebetter.com/patricksmacchia/files/2012/10/Query3.png"><img class="alignnone size-full wp-image-740" src="http://codebetter.com/patricksmacchia/files/2012/10/Query3.png" alt="" width="556" height="814" /></a></p>
<p><span style="text-decoration: underline"><strong>Step 4:</strong></span> Let&#8217;s get the panel name from the namespace sub-name. For that we are using the ternary operator: if the namespace sub-name doens&#8217;t contain any dot, it is already the panel name. Else, the panel name is the sub-string until the first dot met in the sub-name:</p>
<p><a href="http://codebetter.com/patricksmacchia/files/2012/10/Query4.png"><img class="alignnone size-full wp-image-740" src="http://codebetter.com/patricksmacchia/files/2012/10/Query4.png" alt="" width="558" height="827" /></a></p>
<p><span style="text-decoration: underline"><strong>Step 5:</strong></span> <em>Et voila!</em> We now just have to make sure that for each couple of [namespace user, namespace used] they have the same panel name! This is as simple as adding the where clause: <em>where nUserPanel != nUsedPanel</em>.</p>
<p>We then add the prefix <em>warnif count &gt; 0</em> to transform our code query into a code rule. Plus, we set the name of the rule to <em>Panels shouldn&#8217;t use each others</em>. And the rule is ready to be saved, and to be run continuously in Visual Studio and/or on the build machine.</p>
<p><a href="http://codebetter.com/patricksmacchia/files/2012/10/Query5.png"><img class="alignnone size-full wp-image-739" src="http://codebetter.com/patricksmacchia/files/2012/10/Query5.png" alt="" width="560" height="563" /></a></p>
<p>Note that this rule gets compiled and executed in only 7 milli-seconds (see <em>7 ms</em> on the screenshot). This means that a typical machine can run in one second more than 140 of such complex rules against a large code base!</p>
<p>And also, <strong>when new panels will be developed, this rule won&#8217;t have to be updated</strong>. It&#8217;ll just work!</p>
<p>Could it be easier or faster to validate the architecture of a big lump of code?</p>
<p>Btw, just a quick side remark: The fact that panels <em>implementations</em> are not <em>using</em> each other doesn&#8217;t mean that panel shouldn&#8217;t <em>interact</em> with each other. They actually do interact <em>a lot</em> with each others. But they do interact through using a <a href="http://en.wikipedia.org/wiki/Mediator_pattern" target="_blank">mediator implementation</a> that lives in the <strong>Base</strong> namespace. This mediator then calls the <strong>Top</strong> implementation (through inversion of control) that takes care of dispatching any interaction to the right panel.</p>
]]></content:encoded>
			<wfw:commentRss>http://codebetter.com/patricksmacchia/2012/10/26/validating-architecture-through-one-linq-query/feed/</wfw:commentRss>
		<slash:comments>2</slash:comments>
		</item>
		<item>
		<title>Screencast: Inspecting Code Quality and Code Complexity</title>
		<link>http://codebetter.com/patricksmacchia/2012/10/15/screencast-inspecting-code-quality-and-code-complexity/</link>
		<comments>http://codebetter.com/patricksmacchia/2012/10/15/screencast-inspecting-code-quality-and-code-complexity/#comments</comments>
		<pubDate>Mon, 15 Oct 2012 11:56:36 +0000</pubDate>
		<dc:creator>Patrick Smacchia</dc:creator>
				<category><![CDATA[CC]]></category>
		<category><![CDATA[Code Diff]]></category>
		<category><![CDATA[Code metrics]]></category>
		<category><![CDATA[Code Rule]]></category>
		<category><![CDATA[Cyclomatic complexity]]></category>

		<guid isPermaLink="false">http://codebetter.com/patricksmacchia/?p=721</guid>
		<description><![CDATA[Recently I had a chance to record a screencast on Inspecting Code Quality and Code Complexity with Filip Ekberg. In this half-hour video we inspect the NUnit v2.5.8 code base quality and complexity with NDepend v4.0: We first use the popular&#160;&#8230; <a href="http://codebetter.com/patricksmacchia/2012/10/15/screencast-inspecting-code-quality-and-code-complexity/">Continue&#160;reading&#160;<span class="meta-nav">&#8594;</span></a>]]></description>
			<content:encoded><![CDATA[<p>Recently I had a chance to record a screencast on Inspecting Code Quality and Code Complexity with <a href="http://blog.filipekberg.se/" target="_blank">Filip Ekberg</a>. In this half-hour video we inspect the NUnit v2.5.8 code base quality and complexity with NDepend v4.0:</p>
<ul>
<li>We first use the popular Cyclomatic Complexity code metric&#8230;</li>
<li>&#8230;we then refine our findings by focusing on code quality regression since NUnit v2.5.3.</li>
<li>&#8230;some more code metrics are then involved, including the code coverage ratio by tests, the C.R.A.P metric and the code coupling ratio.</li>
</ul>
<div><span style="font-size: medium"><span style="line-height: 24px">We plan to do more screencast on other programming related topics. Your feedbacks and suggestions are welcomed.</span></span></div>
<div></div>
<div><span style="font-size: medium"><span style="line-height: 24px">Enjoy!</span></span></div>
<p><iframe src="http://player.vimeo.com/video/51204579?title=1&amp;byline=1&amp;portrait=1" width="640" height="360" frameborder="0" webkitAllowFullScreen mozallowfullscreen allowFullScreen></iframe></p>
]]></content:encoded>
			<wfw:commentRss>http://codebetter.com/patricksmacchia/2012/10/15/screencast-inspecting-code-quality-and-code-complexity/feed/</wfw:commentRss>
		<slash:comments>1</slash:comments>
		</item>
		<item>
		<title>Beware mixing List.Sort() and Thread.Abort()</title>
		<link>http://codebetter.com/patricksmacchia/2012/10/02/beware-mixing-list-sort-and-thread-abort/</link>
		<comments>http://codebetter.com/patricksmacchia/2012/10/02/beware-mixing-list-sort-and-thread-abort/#comments</comments>
		<pubDate>Tue, 02 Oct 2012 14:24:28 +0000</pubDate>
		<dc:creator>Patrick Smacchia</dc:creator>
				<category><![CDATA[.NET Framework]]></category>
		<category><![CDATA[.NET Fx]]></category>
		<category><![CDATA[C#]]></category>
		<category><![CDATA[Code Query]]></category>
		<category><![CDATA[Code Rule]]></category>
		<category><![CDATA[CQLinq]]></category>

		<guid isPermaLink="false">http://codebetter.com/patricksmacchia/?p=702</guid>
		<description><![CDATA[After more than a decade of full-time development with .NET, I still discover surprising unfixed bugs in the heart of the framework. Today, while I was smoke-testing new stuff in the NDepend UI, I stumbled on an InvalidOperationException thrown by a&#160;&#8230; <a href="http://codebetter.com/patricksmacchia/2012/10/02/beware-mixing-list-sort-and-thread-abort/">Continue&#160;reading&#160;<span class="meta-nav">&#8594;</span></a>]]></description>
			<content:encoded><![CDATA[<p>After more than a decade of full-time development with .NET, I still discover surprising unfixed bugs in the heart of the framework. Today, while I was smoke-testing new stuff in the NDepend UI, I stumbled on an <a href="http://msdn.microsoft.com/en-us/library/system.invalidoperationexception.aspx" target="_blank">InvalidOperationException</a> thrown by a call to <a href="http://msdn.microsoft.com/en-us/library/b0zbh7b6.aspx" target="_blank">List&lt;T&gt;.Sort()</a> ?!</p>
<p>After 15 minutes of searching the cause of the bug, I found this unfixed bug on Microsoft Connect: <a href="http://connect.microsoft.com/VisualStudio/feedback/details/605536/list-sort-throws-invalidoperationexception-instead-of-re-throw-threadabortexception-while-thread-is-being-aborted" target="_blank">List.Sort() throws InvalidOperationException (instead of re-throw ThreadAbortException) while thread is being aborted</a></p>
<p>In other words, if your application is using <a href="http://msdn.microsoft.com/en-us/library/system.threading.thread.abort.aspx" target="_blank">Thread.Abort()</a> somehow, and that the abortable code is calling <em>List&lt;T&gt;.Sort()</em>, you are exposed to the risk of getting an <em>InvalidOperationException</em> instead of a <em>ThreadAbortException</em>.</p>
<p>I already hear that it is a good practice to avoid calling <em>Thread.Abort()</em>, but the fact is that if one wants a responsive UI, one needs some sort of abortable/timed-out background work, and at a point <em>Thread.Abort()</em> will have to be called for that. As long as calling <em>Thread.Abort() </em>is done in a safe way (see this <a href="http://www.bluebytesoftware.com/blog/2009/03/13/ManagedCodeAndAsynchronousExceptionHardening.aspx" target="_blank">Joe Duffy detailled post</a>) we didn&#8217;t meet any problems so far. On millions of production runs logged, we cannot see any problem except &#8230; that <em>List&lt;T&gt;.Sort()</em> throws an <em>InvalidOperationException</em> with the frequency of around one on every 50K production runs. And today, this bug just popped to me in a <em>reproductible</em> way thanks to some refactoring I was doing.</p>
<p>To workaround this problem once for all, I enclosed all calls to any override of <em>List&lt;T&gt;.Sort()</em> in some extension methods in a dedicated class. These <em>BugFreeSort() methods </em>catch the <em>InvalidOperationException. </em>This is fine because anyway the thread is in a <a href="http://msdn.microsoft.com/en-us/library/system.threading.threadstate.aspx" target="_blank">ThreadState.AbortRequested</a> and the CLR will throw the <em>ThreadAbortException </em>at the end of the catch block. Also, attached to this class through an attribute, I declare a <a href="http://www.ndepend.com/ConstraintsExtractedFromCode.aspx" target="_blank">CQLinq code rule in the source code</a> to make sure that all calls to <em>List&lt;T&gt;.Sort()</em> are made through one of these <em>BugFreeSort()</em> methods. Here is the code:</p>
<script src="http://gist.github.com/3819116.js"></script><noscript><link rel="stylesheet" href="https://gist.github.com/stylesheets/gist/embed.css"><div id="gist-3819116" class="gist">
    

        <div class="gist-file">
          <div class="gist-data gist-syntax">
              <div class="highlight"><pre><div class='line' id='LC1'><span class="k">using</span> <span class="nn">System</span><span class="p">;</span></div><div class='line' id='LC2'><span class="k">using</span> <span class="nn">System.Collections.Generic</span><span class="p">;</span></div><div class='line' id='LC3'><span class="k">using</span> <span class="nn">System.Diagnostics</span><span class="p">;</span></div><div class='line' id='LC4'><span class="k">using</span> <span class="nn">System.Threading</span><span class="p">;</span></div><div class='line' id='LC5'><span class="k">using</span> <span class="nn">NDepend.Attributes</span><span class="p">;</span></div><div class='line' id='LC6'><span class="k">using</span> <span class="nn">ThreadState</span> <span class="p">=</span> <span class="n">System</span><span class="p">.</span><span class="n">Threading</span><span class="p">.</span><span class="n">ThreadState</span><span class="p">;</span></div><div class='line' id='LC7'><br/></div><div class='line' id='LC8'><span class="k">namespace</span> <span class="nn">NDepend.Helpers.Collections</span> <span class="p">{</span></div><div class='line' id='LC9'>&nbsp;&nbsp;&nbsp;<span class="c1">//</span></div><div class='line' id='LC10'>&nbsp;&nbsp;&nbsp;<span class="c1">// These extension methods are paliative to a bug of the .NET Fx described here:</span></div><div class='line' id='LC11'>&nbsp;&nbsp;&nbsp;<span class="c1">// http://connect.microsoft.com/VisualStudio/feedback/details/605536/list-sort-throws-invalidoperationexception-instead-of-re-throw-threadabortexception-while-thread-is-being-aborted</span></div><div class='line' id='LC12'>&nbsp;&nbsp;&nbsp;<span class="c1">// List.Sort() throws InvalidOperationException (instead of re-throw ThreadAbortException) while thread is being aborted</span></div><div class='line' id='LC13'>&nbsp;&nbsp;&nbsp;<span class="c1">//</span></div><div class='line' id='LC14'><span class="cp">#if DEBUG</span></div><div class='line' id='LC15'><span class="na">   [CodeRule(@&quot;// &lt;Name&gt;Use List&lt;T&gt;.BugFreeSort() instead of List&lt;T&gt;.Sort()&lt;/Name&gt;</span></div><div class='line' id='LC16'><span class="na">warnif count &gt; 0</span></div><div class='line' id='LC17'><span class="na">let listSortMethods = ThirdParty.Methods</span></div><div class='line' id='LC18'><span class="na">  .WithFullNameWildcardMatch(@&quot;&quot;System.Collections.Generic.List&lt;T&gt;.Sort*&quot;&quot;)</span></div><div class='line' id='LC19'><span class="na">from m in Application.Methods.UsingAny(listSortMethods)  </span></div><div class='line' id='LC20'><span class="na">where m.ParentType.FullName != &quot;&quot;NDepend.Helpers.Collections.ListSortExtensionMethods&quot;&quot;</span></div><div class='line' id='LC21'><span class="na">select new { m, sortMethodCalled = m.MethodsCalled.Intersect(listSortMethods) }&quot;,</span></div><div class='line' id='LC22'><span class="na">      Active = true,</span></div><div class='line' id='LC23'><span class="na">      DisplayStatInReport = true,</span></div><div class='line' id='LC24'><span class="na">      DisplayListInReport = true,</span></div><div class='line' id='LC25'><span class="na">      DisplaySelectionViewInReport = true,</span></div><div class='line' id='LC26'><span class="na">      IsCriticalRule = false)]</span></div><div class='line' id='LC27'><span class="cp">#endif</span></div><div class='line' id='LC28'>&nbsp;&nbsp;&nbsp;<span class="k">public</span> <span class="k">static</span> <span class="k">class</span> <span class="nc">ListSortExtensionMethods</span> <span class="p">{</span></div><div class='line' id='LC29'><br/></div><div class='line' id='LC30'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="k">public</span> <span class="k">static</span> <span class="k">void</span> <span class="n">BugFreeSort</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;(</span><span class="k">this</span> <span class="n">List</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span></div><div class='line' id='LC31'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="n">Debug</span><span class="p">.</span><span class="n">Assert</span><span class="p">(</span><span class="n">list</span> <span class="p">!=</span> <span class="k">null</span><span class="p">);</span></div><div class='line' id='LC32'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="k">try</span> <span class="p">{</span></div><div class='line' id='LC33'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="n">list</span><span class="p">.</span><span class="n">Sort</span><span class="p">();</span></div><div class='line' id='LC34'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="p">}</span> <span class="k">catch</span><span class="p">(</span><span class="n">InvalidOperationException</span><span class="p">)</span> <span class="p">{</span></div><div class='line' id='LC35'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="n">Debug</span><span class="p">.</span><span class="n">Assert</span><span class="p">((</span><span class="n">Thread</span><span class="p">.</span><span class="n">CurrentThread</span><span class="p">.</span><span class="n">ThreadState</span> <span class="p">&amp;</span> <span class="n">ThreadState</span><span class="p">.</span><span class="n">AbortRequested</span><span class="p">)</span> <span class="p">!=</span> <span class="m">0</span><span class="p">);</span></div><div class='line' id='LC36'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="c1">// The exception ThreadAbortException is propagated when closing this catch blok</span></div><div class='line' id='LC37'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="p">}</span></div><div class='line' id='LC38'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="p">}</span></div><div class='line' id='LC39'><br/></div><div class='line' id='LC40'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="k">public</span> <span class="k">static</span> <span class="k">void</span> <span class="n">BugFreeSort</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;(</span><span class="k">this</span> <span class="n">List</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;</span> <span class="n">list</span><span class="p">,</span> <span class="n">Comparison</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;</span> <span class="n">comparison</span><span class="p">)</span> <span class="p">{</span></div><div class='line' id='LC41'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="n">Debug</span><span class="p">.</span><span class="n">Assert</span><span class="p">(</span><span class="n">list</span> <span class="p">!=</span> <span class="k">null</span><span class="p">);</span></div><div class='line' id='LC42'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="n">Debug</span><span class="p">.</span><span class="n">Assert</span><span class="p">(</span><span class="n">comparison</span> <span class="p">!=</span> <span class="k">null</span><span class="p">);</span></div><div class='line' id='LC43'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="k">try</span> <span class="p">{</span></div><div class='line' id='LC44'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="n">list</span><span class="p">.</span><span class="n">Sort</span><span class="p">(</span><span class="n">comparison</span><span class="p">);</span></div><div class='line' id='LC45'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="n">InvalidOperationException</span><span class="p">)</span> <span class="p">{</span></div><div class='line' id='LC46'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="n">Debug</span><span class="p">.</span><span class="n">Assert</span><span class="p">((</span><span class="n">Thread</span><span class="p">.</span><span class="n">CurrentThread</span><span class="p">.</span><span class="n">ThreadState</span> <span class="p">&amp;</span> <span class="n">ThreadState</span><span class="p">.</span><span class="n">AbortRequested</span><span class="p">)</span> <span class="p">!=</span> <span class="m">0</span><span class="p">);</span></div><div class='line' id='LC47'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="c1">// The exception ThreadAbortException is propagated when closing this catch blok</span></div><div class='line' id='LC48'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="p">}</span></div><div class='line' id='LC49'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="p">}</span></div><div class='line' id='LC50'><br/></div><div class='line' id='LC51'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="k">public</span> <span class="k">static</span> <span class="k">void</span> <span class="n">BugFreeSort</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;(</span><span class="k">this</span> <span class="n">List</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;</span> <span class="n">list</span><span class="p">,</span> <span class="n">IComparer</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;</span> <span class="n">comparer</span><span class="p">)</span> <span class="p">{</span></div><div class='line' id='LC52'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="n">Debug</span><span class="p">.</span><span class="n">Assert</span><span class="p">(</span><span class="n">list</span> <span class="p">!=</span> <span class="k">null</span><span class="p">);</span></div><div class='line' id='LC53'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="n">Debug</span><span class="p">.</span><span class="n">Assert</span><span class="p">(</span><span class="n">comparer</span> <span class="p">!=</span> <span class="k">null</span><span class="p">);</span></div><div class='line' id='LC54'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="k">try</span> <span class="p">{</span></div><div class='line' id='LC55'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="n">list</span><span class="p">.</span><span class="n">Sort</span><span class="p">(</span><span class="n">comparer</span><span class="p">);</span></div><div class='line' id='LC56'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="n">InvalidOperationException</span><span class="p">)</span> <span class="p">{</span></div><div class='line' id='LC57'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="n">Debug</span><span class="p">.</span><span class="n">Assert</span><span class="p">((</span><span class="n">Thread</span><span class="p">.</span><span class="n">CurrentThread</span><span class="p">.</span><span class="n">ThreadState</span> <span class="p">&amp;</span> <span class="n">ThreadState</span><span class="p">.</span><span class="n">AbortRequested</span><span class="p">)</span> <span class="p">!=</span> <span class="m">0</span><span class="p">);</span></div><div class='line' id='LC58'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="c1">// The exception ThreadAbortException is propagated when closing this catch blok</span></div><div class='line' id='LC59'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="p">}</span></div><div class='line' id='LC60'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="p">}</span></div><div class='line' id='LC61'><br/></div><div class='line' id='LC62'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="k">public</span> <span class="k">static</span> <span class="k">void</span> <span class="n">BugFreeSort</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;(</span><span class="k">this</span> <span class="n">List</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;</span> <span class="n">list</span><span class="p">,</span> <span class="kt">int</span> <span class="n">index</span><span class="p">,</span> <span class="kt">int</span> <span class="n">count</span><span class="p">,</span> <span class="n">IComparer</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;</span> <span class="n">comparer</span><span class="p">)</span> <span class="p">{</span></div><div class='line' id='LC63'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="n">Debug</span><span class="p">.</span><span class="n">Assert</span><span class="p">(</span><span class="n">list</span> <span class="p">!=</span> <span class="k">null</span><span class="p">);</span></div><div class='line' id='LC64'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="n">Debug</span><span class="p">.</span><span class="n">Assert</span><span class="p">(</span><span class="n">index</span> <span class="p">&gt;=</span> <span class="m">0</span><span class="p">);</span></div><div class='line' id='LC65'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="n">Debug</span><span class="p">.</span><span class="n">Assert</span><span class="p">(</span><span class="n">count</span> <span class="p">&gt;=</span><span class="m">0</span><span class="p">);</span></div><div class='line' id='LC66'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="n">Debug</span><span class="p">.</span><span class="n">Assert</span><span class="p">(</span><span class="n">list</span><span class="p">.</span><span class="n">Count</span> <span class="p">==</span> <span class="m">0</span> <span class="p">||</span> <span class="n">index</span><span class="p">+</span><span class="n">count</span> <span class="p">&lt;</span> <span class="n">list</span><span class="p">.</span><span class="n">Count</span><span class="p">);</span></div><div class='line' id='LC67'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="n">Debug</span><span class="p">.</span><span class="n">Assert</span><span class="p">(</span><span class="n">comparer</span> <span class="p">!=</span> <span class="k">null</span><span class="p">);</span></div><div class='line' id='LC68'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="k">try</span> <span class="p">{</span></div><div class='line' id='LC69'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="n">list</span><span class="p">.</span><span class="n">Sort</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="n">comparer</span><span class="p">);</span></div><div class='line' id='LC70'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="n">InvalidOperationException</span><span class="p">)</span> <span class="p">{</span></div><div class='line' id='LC71'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="n">Debug</span><span class="p">.</span><span class="n">Assert</span><span class="p">((</span><span class="n">Thread</span><span class="p">.</span><span class="n">CurrentThread</span><span class="p">.</span><span class="n">ThreadState</span> <span class="p">&amp;</span> <span class="n">ThreadState</span><span class="p">.</span><span class="n">AbortRequested</span><span class="p">)</span> <span class="p">!=</span> <span class="m">0</span><span class="p">);</span></div><div class='line' id='LC72'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="c1">// The exception ThreadAbortException is propagated when closing this catch blok</span></div><div class='line' id='LC73'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="p">}</span></div><div class='line' id='LC74'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="p">}</span></div><div class='line' id='LC75'>&nbsp;&nbsp;&nbsp;<span class="p">}</span></div><div class='line' id='LC76'><span class="p">}</span></div><div class='line' id='LC77'><br/></div></pre></div>
          </div>

          <div class="gist-meta">
            <a href="https://gist.github.com/raw/3819116/19fc0ebb683253b9c2e3d78876a8348e3b97d69e/gistfile1.cs" style="float:right;">view raw</a>
            <a href="https://gist.github.com/3819116#file_gistfile1.cs" style="float:right;margin-right:10px;color:#666">gistfile1.cs</a>
            <a href="https://gist.github.com/3819116">This Gist</a> brought to you by <a href="http://github.com">GitHub</a>.
          </div>
        </div>
</div>
</noscript>
<p>Here is the code rule declared in the code. Hopefully any .NET developer acquainted with the LINQ syntax, should be able to read this piece to code:</p>
<script src="http://gist.github.com/3819157.js"></script><noscript><link rel="stylesheet" href="https://gist.github.com/stylesheets/gist/embed.css"><div id="gist-3819157" class="gist">
    

        <div class="gist-file">
          <div class="gist-data gist-syntax">
              <div class="highlight"><pre><div class='line' id='LC1'><span class="c1">// &lt;Name&gt;Use List&lt;T&gt;.BugFreeSort() instead of List&lt;T&gt;.Sort()&lt;/Name&gt;</span></div><div class='line' id='LC2'><span class="n">warnif</span> <span class="n">count</span> <span class="p">&gt;</span> <span class="m">0</span></div><div class='line' id='LC3'><span class="n">let</span> <span class="n">listSortMethods</span> <span class="p">=</span> <span class="n">ThirdParty</span><span class="p">.</span><span class="n">Methods</span></div><div class='line' id='LC4'>&nbsp;&nbsp;<span class="p">.</span><span class="n">WithFullNameWildcardMatch</span><span class="p">(</span><span class="s">@&quot;System.Collections.Generic.List&lt;T&gt;.Sort*&quot;</span><span class="p">)</span></div><div class='line' id='LC5'><br/></div><div class='line' id='LC6'><span class="k">from</span> <span class="n">m</span> <span class="k">in</span> <span class="n">Application</span><span class="p">.</span><span class="n">Methods</span><span class="p">.</span><span class="n">UsingAny</span><span class="p">(</span><span class="n">listSortMethods</span><span class="p">)</span>  </div><div class='line' id='LC7'><span class="k">where</span> <span class="n">m</span><span class="p">.</span><span class="n">ParentType</span><span class="p">.</span><span class="n">FullName</span> <span class="p">!=</span> <span class="s">&quot;NDepend.Helpers.Collections.ListSortExtensionMethods&quot;</span></div><div class='line' id='LC8'><span class="k">select</span> <span class="k">new</span> <span class="p">{</span> <span class="n">m</span><span class="p">,</span> <span class="n">sortMethodCalled</span> <span class="p">=</span> <span class="n">m</span><span class="p">.</span><span class="n">MethodsCalled</span><span class="p">.</span><span class="n">Intersect</span><span class="p">(</span><span class="n">listSortMethods</span><span class="p">)</span> <span class="p">}</span></div></pre></div>
          </div>

          <div class="gist-meta">
            <a href="https://gist.github.com/raw/3819157/22e3d5c2198bce7b68ce067977fe44da20a88c7b/gistfile1.cs" style="float:right;">view raw</a>
            <a href="https://gist.github.com/3819157#file_gistfile1.cs" style="float:right;margin-right:10px;color:#666">gistfile1.cs</a>
            <a href="https://gist.github.com/3819157">This Gist</a> brought to you by <a href="http://github.com">GitHub</a>.
          </div>
        </div>
</div>
</noscript>
<p>And here is a screenshot of the NDepend methods violating the code rule <em>before</em> refactoring:</p>
<p><a href="http://codebetter.com/patricksmacchia/files/2012/10/Match.png"><img class="alignnone size-full wp-image-705" src="http://codebetter.com/patricksmacchia/files/2012/10/Match.png" alt="" width="580" height="783" /></a></p>
<p>We have almost 200 code rules declared in source code like this newly added one. They protect us from stumbling <em>again and again</em> in tricky identified scenarios. In other words with these rules we abide by the tenet: <strong>Fool me once, don&#8217;t fool me twice</strong>.</p>
<p>In a team context, doing so is especially useful since such rule is warning a developer when he&#8217;s doing something wrong. Such warning is actually a <strong>just-in-time</strong> <strong>automatic piece of education</strong> for <em>newcomers</em> developers, about how things must be done. Communication in the team is enhanced, the overall friction is decreased, and I found this pretty cool <img src='http://cdn1.codebetter.com/wp-includes/images/smilies/icon_smile.gif' alt=':)' class='wp-smiley' /> </p>
]]></content:encoded>
			<wfw:commentRss>http://codebetter.com/patricksmacchia/2012/10/02/beware-mixing-list-sort-and-thread-abort/feed/</wfw:commentRss>
		<slash:comments>6</slash:comments>
		</item>
		<item>
		<title>The consequence of a.NET Framework API design flaw</title>
		<link>http://codebetter.com/patricksmacchia/2012/08/06/the-consequence-of-a-net-framework-api-design-flaw/</link>
		<comments>http://codebetter.com/patricksmacchia/2012/08/06/the-consequence-of-a-net-framework-api-design-flaw/#comments</comments>
		<pubDate>Mon, 06 Aug 2012 12:41:30 +0000</pubDate>
		<dc:creator>Patrick Smacchia</dc:creator>
				<category><![CDATA[.NET Framework]]></category>
		<category><![CDATA[API usage]]></category>
		<category><![CDATA[breaking changes]]></category>
		<category><![CDATA[Code Rule]]></category>

		<guid isPermaLink="false">http://codebetter.com/patricksmacchia/?p=689</guid>
		<description><![CDATA[Last week, a user reported a bug on NDepend (hopefully it happens in a very rare situation!). After mulling over a bit on the bug stack trace, it appears that the bug is the consequence of a call to ICollection&#60;T&#62;.Add() while the&#160;&#8230; <a href="http://codebetter.com/patricksmacchia/2012/08/06/the-consequence-of-a-net-framework-api-design-flaw/">Continue&#160;reading&#160;<span class="meta-nav">&#8594;</span></a>]]></description>
			<content:encoded><![CDATA[<p>Last week, a user reported a bug on NDepend (hopefully it happens in a very rare situation!). After mulling over a bit on the bug stack trace, it appears that the bug is the consequence of a call to <a href="http://msdn.microsoft.com/en-us/library/63ywd54z.aspx" target="_blank">ICollection&lt;T&gt;.Add()</a> while the underlying collection is an array!</p>
<p>Here I felt bad, because really the bug is a consequence of a .NET Framework API design flaw. Or better said, to take our responsibility, the bug is the consequence of us, not providing a work around seriously enough on this  .NET Framework API design flaw. <strong>Why the hell some read-only collection implements the Add() method?</strong> It is even getting worse if considering the documentation of <em><a href="http://msdn.microsoft.com/en-US/library/system.array.system.collections.ilist.add(v=vs.80)" target="_blank">Array.Add()</a></em> (as a <em>IList&lt;T&gt;</em> explicit implementation method) and <a href="http://msdn.microsoft.com/en-en/library/cc672239.aspx" target="_blank">ReadOnlyCollection.ICollection&lt;T&gt;.Add()</a>.</p>
<p style="text-align: center"><em> <strong>This implementation always throws <a href="http://msdn.microsoft.com/en-us/library/system.notsupportedexception">NotSupportedException</a></strong>. </em>OUCH!</p>
<p>It appears that finally, a decade after .NET 1.0 has been release, 3 interfaces <a href="http://msdn.microsoft.com/en-us/library/ee537802.aspx" target="_blank">IReadOnlyCollection&lt;T&gt;</a>, <a href="http://msdn.microsoft.com/en-us/library/hh192385(v=vs.110).aspx" target="_blank">IReadOnlyList&lt;T&gt;</a>, <a href="http://msdn.microsoft.com/en-us/library/hh136548(v=vs.110).aspx" target="_blank">IReadOnlyDictionary&lt;T&gt;</a> will be presented by the .NET v4.5. As commonly said, <em>it is never too late to do things right</em>, but in the case of an API with ascendant compatibility used by millions of developers world-wide, this proverb doesn&#8217;t fit that well.</p>
<p>The fact is that the brand new <a href="http://www.ndepend.com/API/webframe.html" target="_blank">NDepend.API</a> actually uses the interface <em>ICollection&lt;T&gt;</em> to return read-only lists. I wouldn&#8217;t like us or some users stumble on this API design flaw again! Hence a decision was taken to change the API policy, even though this will introduce breaking-change (the API is still young enough for that). First, I wrote the following CQLinq query to evaluate the problem:</p>
<script src="http://gist.github.com/3247870.js"></script><noscript><link rel="stylesheet" href="https://gist.github.com/stylesheets/gist/embed.css"><div id="gist-3247870" class="gist">
    
        <div class="gist-file">
          <div class="gist-data gist-syntax">
              <div class="highlight"><pre><div class='line' id='LC1'><span class="n">let</span> <span class="n">seqTypes</span> <span class="p">=</span> <span class="n">Types</span><span class="p">.</span><span class="n">Where</span><span class="p">(</span></div><div class='line' id='LC2'>&nbsp;&nbsp;<span class="n">t</span> <span class="p">=&gt;</span> <span class="n">t</span><span class="p">.</span><span class="n">Implement</span><span class="p">(</span><span class="s">&quot;System.Collections.Generic.IEnumerable&lt;T&gt;&quot;</span><span class="p">)</span> <span class="p">&amp;&amp;</span></div><div class='line' id='LC3'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="n">t</span><span class="p">.</span><span class="n">Name</span> <span class="p">!=</span> <span class="s">&quot;String&quot;</span> <span class="c1">// We don&#39;t string as collection!</span></div><div class='line' id='LC4'><span class="p">).</span><span class="n">ToHashSet</span><span class="p">()</span></div><div class='line' id='LC5'><br/></div><div class='line' id='LC6'><span class="k">from</span> <span class="n">m</span> <span class="k">in</span> <span class="n">Assemblies</span><span class="p">.</span><span class="n">WithNameIn</span><span class="p">(</span> <span class="s">&quot;NDepend.API&quot;</span><span class="p">).</span><span class="n">ChildMethods</span><span class="p">()</span></div><div class='line' id='LC7'><span class="k">where</span> <span class="n">m</span><span class="p">.</span><span class="n">IsPubliclyVisible</span> <span class="p">&amp;&amp;</span></div><div class='line' id='LC8'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="n">m</span><span class="p">.</span><span class="n">ReturnType</span> <span class="p">!=</span> <span class="k">null</span> <span class="p">&amp;&amp;</span></div><div class='line' id='LC9'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="n">seqTypes</span><span class="p">.</span><span class="n">Contains</span><span class="p">(</span><span class="n">m</span><span class="p">.</span><span class="n">ReturnType</span><span class="p">)</span></div><div class='line' id='LC10'><span class="k">select</span> <span class="k">new</span> <span class="p">{</span> <span class="n">m</span><span class="p">,</span> <span class="n">m</span><span class="p">.</span><span class="n">ReturnType</span> <span class="p">}</span></div></pre></div>
          </div>

          <div class="gist-meta">
            <a href="https://gist.github.com/raw/3247870/8bdf5bc0d8bd07100fd4272777cb586eace7417b/gistfile1.cs" style="float:right;">view raw</a>
            <a href="https://gist.github.com/3247870#file_gistfile1.cs" style="float:right;margin-right:10px;color:#666">gistfile1.cs</a>
            <a href="https://gist.github.com/3247870">This Gist</a> brought to you by <a href="http://github.com">GitHub</a>.
          </div>
        </div>
</div>
</noscript>
<p>Here is the result, 40 methods (or property getters) returns something that implement <em>IEnumerable&lt;T&gt;</em> and many of them returns a <em>ICollection&lt;T&gt;</em>.</p>
<p><a href="http://codebetter.com/patricksmacchia/files/2012/08/Query1.png"><img src="http://codebetter.com/patricksmacchia/files/2012/08/Query1.png" alt="" width="557" height="991" /></a></p>
<p>So what the API should return instead of <em>ICollection&lt;T&gt;?</em> Knowing that NDepend is still compatible with VS2008 and hence is compiled with .NET 3.5, it cannot use the brand new .NET v4.5 <em>IReadOnlyList&lt;T&gt; </em>(but it will certainly use these in several years, when we will compile against .NET v4.5 and above).</p>
<ul>
<li>Returning arrays instead of <em>ICollection&lt;T&gt;</em> could be an idea. The problem is that array is an implementation, and it is not read-only since the user can update each slot of the array.</li>
<li>I never really liked the class <em>ReadOnlyCollection&lt;T&gt;</em> that wraps a <em>IList&lt;T&gt;</em>. First it is a class and not an interface. Second it has the property getter <em>Items</em> that can returns the wrapped <em>IList&lt;T&gt;</em>, so it is not that read-only and not a good wrapper at all! Third it implements <em>IList&lt;T&gt;</em>, and all mutable members are not supported, so it can lead to the same kind of confusion we are now faced with.</li>
<li>Returning some <em>IEnumerable&lt;T&gt;</em> would be a better choice than the two above. It is not ideal through. While <em>IEnumerable&lt;T&gt;</em> conveys well the read-only idea, it has no <em>Count</em> nor an item access by index property. Hence it is not really suited to return a well-sized list. LINQ provides the adequate extension methods <em>Count()</em> and <em>ElementAt()</em>, but  <em>IEnumerable&lt;T&gt; </em>has a strong taste of <strong>sequence</strong>, while we&#8217;d really like to provide users with proper <strong>lists</strong>!</li>
</ul>
<div>
<p>So we choose to provide our own interfaces <em>IReadOnlyCollection&lt;T&gt;</em> and <em>IReadOnlyList&lt;T&gt;</em>! Same as the ones released soon in .NET v4.5, but defined in another namespace <em>NDepend.Helpers</em>, this will discard most naming collisions for clients. Thanks to this choice, the API is as clean as possible for now, and the transition will be simplified once NDepend will be compiled for .NET v4.5 and above, sooner or later.</p>
<p>As more and more often, I found inspiration in a <em>stackoverflow.com</em> response <a href="http://stackoverflow.com/a/343506/27194" target="_blank">here</a>. Find below the whole interfaces declarations and implementations. This is not an ideal solution, since <em>List&lt;T&gt;</em> and <em>Array</em> of course doesn&#8217;t implement our interfaces, but I found it to be a good design compromise.</p>
<p>Notice the four factory extension methods, that make a clear distinction at creation time, between <strong>Wrapped</strong> and <strong>Cloned </strong>read-only collection. Notice as well that the <em>Cloned</em> factories, take any sequence as argument, while the <em>Wrapped</em> factories, need collections and lists as argument:</p>
<ul>
<li><em>ToReadOnlyWrappedCollection(this ICollection&lt;T&gt;), </em></li>
<li><em>ToReadOnlyClonedCollection(this IEnumerable&lt;T&gt;),</em></li>
<li><em>ToReadOnlyWrappedList(this IList&lt;T&gt;), </em></li>
<li><em>ToReadOnlyClonedList(this IEnumerable&lt;T&gt;),</em></li>
</ul>
</div>
<p>Also, we&#8217;ve added the <em>IndexOf()</em> extension method over our two interfaces, because we needed it, and because the .NET Framework doesn&#8217;t provide <em>IndexOf(this IEnumerable&lt;T&gt;) </em>because a sequence is not necessarily ordered (like <em>hashset</em> or <em>dictionary</em>).</p>
<script src="http://gist.github.com/3247559.js"></script><noscript><link rel="stylesheet" href="https://gist.github.com/stylesheets/gist/embed.css"><div id="gist-3247559" class="gist">
    

        <div class="gist-file">
          <div class="gist-data gist-syntax">
              <div class="highlight"><pre><div class='line' id='LC1'>&nbsp;&nbsp;<span class="c1">///&lt;summary&gt;</span></div><div class='line' id='LC2'>&nbsp;&nbsp;&nbsp;<span class="c1">///Defines the property getter Count that defines a read-only collections.</span></div><div class='line' id='LC3'>&nbsp;&nbsp;&nbsp;<span class="c1">///&lt;/summary&gt;</span></div><div class='line' id='LC4'>&nbsp;&nbsp;&nbsp;<span class="c1">///&lt;remarks&gt;A &lt;see cref=&quot;IReadOnlyCollection{T}&quot;/&gt; object can be obtain through the extension methods &lt;see cref=&quot;ExtensionMethodsEnumerable.ToReadOnlyWrappedCollection{T}&quot;/&gt; or  &lt;see cref=&quot;ExtensionMethodsEnumerable.ToReadOnlyClonedCollection{T}&quot;/&gt;.&lt;/remarks&gt;</span></div><div class='line' id='LC5'>&nbsp;&nbsp;&nbsp;<span class="c1">///&lt;typeparam name=&quot;T&quot;&gt;The type parameter of the items in the collection.&lt;/typeparam&gt;</span></div><div class='line' id='LC6'>&nbsp;&nbsp;&nbsp;<span class="k">public</span> <span class="k">interface</span> <span class="n">IReadOnlyCollection</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;</span> <span class="p">:</span> <span class="n">IEnumerable</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;</span> <span class="p">{</span></div><div class='line' id='LC7'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="c1">///&lt;summary&gt;</span></div><div class='line' id='LC8'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="c1">///Gets the number of elements contained in the collection.</span></div><div class='line' id='LC9'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="c1">///&lt;/summary&gt;</span></div><div class='line' id='LC10'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kt">int</span> <span class="n">Count</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="p">}</span></div><div class='line' id='LC11'>&nbsp;&nbsp;&nbsp;<span class="p">}</span></div><div class='line' id='LC12'><br/></div><div class='line' id='LC13'><br/></div><div class='line' id='LC14'>&nbsp;&nbsp;&nbsp;<span class="c1">///&lt;summary&gt;</span></div><div class='line' id='LC15'>&nbsp;&nbsp;&nbsp;<span class="c1">///Represents a read-only collection of elements that can be accessed by index.</span></div><div class='line' id='LC16'>&nbsp;&nbsp;&nbsp;<span class="c1">///&lt;/summary&gt;</span></div><div class='line' id='LC17'>&nbsp;&nbsp;&nbsp;<span class="c1">///&lt;remarks&gt;A &lt;see cref=&quot;IReadOnlyList{T}&quot;/&gt; object can be obtain through the extension methods &lt;see cref=&quot;ExtensionMethodsEnumerable.ToReadOnlyWrappedList{T}&quot;/&gt; or  &lt;see cref=&quot;ExtensionMethodsEnumerable.ToReadOnlyClonedList{T}&quot;/&gt;.&lt;/remarks&gt;</span></div><div class='line' id='LC18'>&nbsp;&nbsp;&nbsp;<span class="c1">///&lt;typeparam name=&quot;T&quot;&gt;The type parameter of the items in the collection.&lt;/typeparam&gt;</span></div><div class='line' id='LC19'>&nbsp;&nbsp;&nbsp;<span class="k">public</span> <span class="k">interface</span> <span class="n">IReadOnlyList</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;</span> <span class="p">:</span> <span class="n">IReadOnlyCollection</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;</span> <span class="p">{</span></div><div class='line' id='LC20'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="c1">///&lt;summary&gt;</span></div><div class='line' id='LC21'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="c1">///Gets the element at the specified index in the read-only list.</span></div><div class='line' id='LC22'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="c1">///&lt;/summary&gt;</span></div><div class='line' id='LC23'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="c1">///&lt;param name=&quot;index&quot;&gt;The zero-based index of the element to get.&lt;/param&gt;</span></div><div class='line' id='LC24'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="n">T</span> <span class="k">this</span><span class="p">[</span><span class="kt">int</span> <span class="n">index</span><span class="p">]</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="p">}</span></div><div class='line' id='LC25'>&nbsp;&nbsp;&nbsp;<span class="p">}</span></div><div class='line' id='LC26'><br/></div><div class='line' id='LC27'><br/></div><div class='line' id='LC28'><br/></div><div class='line' id='LC29'>&nbsp;&nbsp;&nbsp;<span class="k">public</span> <span class="k">static</span> <span class="k">class</span> <span class="nc">ExtensionMethodsEnumerable</span> <span class="p">{</span></div><div class='line' id='LC30'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="c1">/// &lt;summary&gt;</span></div><div class='line' id='LC31'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="c1">/// Creates a &lt;see cref=&quot;IReadOnlyCollection{T}&quot;/&gt; wrapper collection around &lt;paramref name=&quot;collection&quot;/&gt;. </span></div><div class='line' id='LC32'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="c1">/// &lt;/summary&gt;</span></div><div class='line' id='LC33'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="c1">/// &lt;typeparam name=&quot;T&quot;&gt;The type parameter of the items in the collection.&lt;/typeparam&gt;</span></div><div class='line' id='LC34'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="c1">/// &lt;param name=&quot;collection&quot;&gt;A collection object.&lt;/param&gt;</span></div><div class='line' id='LC35'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="k">public</span> <span class="k">static</span> <span class="n">IReadOnlyCollection</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;</span> <span class="n">ToReadOnlyWrappedCollection</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;(</span><span class="k">this</span> <span class="n">ICollection</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;</span> <span class="n">collection</span><span class="p">)</span> <span class="p">{</span></div><div class='line' id='LC36'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="n">Contract</span><span class="p">.</span><span class="n">Requires</span><span class="p">(</span><span class="n">collection</span> <span class="p">!=</span> <span class="k">null</span><span class="p">,</span> <span class="s">&quot;collection must not be null&quot;</span><span class="p">);</span></div><div class='line' id='LC37'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="n">Contract</span><span class="p">.</span><span class="n">Ensures</span><span class="p">(</span><span class="n">Contract</span><span class="p">.</span><span class="n">Result</span><span class="p">&lt;</span><span class="n">IReadOnlyCollection</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;&gt;()</span> <span class="p">!=</span> <span class="k">null</span><span class="p">,</span> <span class="s">&quot;returned read-only collection is not null&quot;</span><span class="p">);</span></div><div class='line' id='LC38'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="n">Contract</span><span class="p">.</span><span class="n">Ensures</span><span class="p">(</span><span class="n">Contract</span><span class="p">.</span><span class="n">Result</span><span class="p">&lt;</span><span class="n">IReadOnlyCollection</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;&gt;().</span><span class="n">Count</span> <span class="p">==</span> <span class="n">collection</span><span class="p">.</span><span class="n">Count</span><span class="p">,</span> <span class="s">&quot;returned read-only collection has the same number of elements as collection&quot;</span><span class="p">);</span></div><div class='line' id='LC39'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="k">return</span> <span class="k">new</span> <span class="n">CollectionReadOnlyWrapper</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;(</span><span class="n">collection</span><span class="p">);</span></div><div class='line' id='LC40'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="p">}</span></div><div class='line' id='LC41'><br/></div><div class='line' id='LC42'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="c1">/// &lt;summary&gt;</span></div><div class='line' id='LC43'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="c1">/// Creates a &lt;see cref=&quot;IReadOnlyCollection{T}&quot;/&gt; cloned collection around &lt;paramref name=&quot;collection&quot;/&gt;. </span></div><div class='line' id='LC44'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="c1">/// &lt;/summary&gt;</span></div><div class='line' id='LC45'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="c1">/// &lt;typeparam name=&quot;T&quot;&gt;The type parameter of the items in the collection.&lt;/typeparam&gt;</span></div><div class='line' id='LC46'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="c1">/// &lt;param name=&quot;collection&quot;&gt;A collection object.&lt;/param&gt;</span></div><div class='line' id='LC47'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="k">public</span> <span class="k">static</span> <span class="n">IReadOnlyCollection</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;</span> <span class="n">ToReadOnlyClonedCollection</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;(</span><span class="k">this</span> <span class="n">IEnumerable</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;</span> <span class="n">collection</span><span class="p">)</span> <span class="p">{</span></div><div class='line' id='LC48'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="n">Contract</span><span class="p">.</span><span class="n">Requires</span><span class="p">(</span><span class="n">collection</span> <span class="p">!=</span> <span class="k">null</span><span class="p">,</span> <span class="s">&quot;collection must not be null&quot;</span><span class="p">);</span></div><div class='line' id='LC49'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="n">Contract</span><span class="p">.</span><span class="n">Ensures</span><span class="p">(</span><span class="n">Contract</span><span class="p">.</span><span class="n">Result</span><span class="p">&lt;</span><span class="n">IReadOnlyCollection</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;&gt;()</span> <span class="p">!=</span> <span class="k">null</span><span class="p">,</span> <span class="s">&quot;returned read-only collection is not null&quot;</span><span class="p">);</span></div><div class='line' id='LC50'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="n">Contract</span><span class="p">.</span><span class="n">Ensures</span><span class="p">(</span><span class="n">Contract</span><span class="p">.</span><span class="n">Result</span><span class="p">&lt;</span><span class="n">IReadOnlyCollection</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;&gt;().</span><span class="n">Count</span> <span class="p">==</span> <span class="n">collection</span><span class="p">.</span><span class="n">Count</span><span class="p">(),</span> <span class="s">&quot;returned read-only collection has the same number of elements as collection&quot;</span><span class="p">);</span></div><div class='line' id='LC51'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="k">return</span> <span class="k">new</span> <span class="n">CollectionReadOnlyWrapper</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;(</span><span class="n">collection</span><span class="p">.</span><span class="n">ToArray</span><span class="p">());</span></div><div class='line' id='LC52'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="p">}</span></div><div class='line' id='LC53'><br/></div><div class='line' id='LC54'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="c1">/// &lt;summary&gt;</span></div><div class='line' id='LC55'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="c1">/// Creates a &lt;see cref=&quot;IReadOnlyCollection{T}&quot;/&gt; wrapper collection around &lt;paramref name=&quot;list&quot;/&gt;. </span></div><div class='line' id='LC56'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="c1">/// &lt;/summary&gt;</span></div><div class='line' id='LC57'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="c1">/// &lt;typeparam name=&quot;T&quot;&gt;The type parameter of the items in the list.&lt;/typeparam&gt;</span></div><div class='line' id='LC58'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="c1">/// &lt;param name=&quot;list&quot;&gt;A list object.&lt;/param&gt;</span></div><div class='line' id='LC59'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="k">public</span> <span class="k">static</span> <span class="n">IReadOnlyList</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;</span> <span class="n">ToReadOnlyWrappedList</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;(</span><span class="k">this</span> <span class="n">IList</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span></div><div class='line' id='LC60'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="n">Contract</span><span class="p">.</span><span class="n">Requires</span><span class="p">(</span><span class="n">list</span> <span class="p">!=</span> <span class="k">null</span><span class="p">,</span> <span class="s">&quot;collection must not be null&quot;</span><span class="p">);</span></div><div class='line' id='LC61'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="n">Contract</span><span class="p">.</span><span class="n">Ensures</span><span class="p">(</span><span class="n">Contract</span><span class="p">.</span><span class="n">Result</span><span class="p">&lt;</span><span class="n">IReadOnlyList</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;&gt;()</span> <span class="p">!=</span> <span class="k">null</span><span class="p">,</span> <span class="s">&quot;returned read-only list is not null&quot;</span><span class="p">);</span></div><div class='line' id='LC62'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="n">Contract</span><span class="p">.</span><span class="n">Ensures</span><span class="p">(</span><span class="n">Contract</span><span class="p">.</span><span class="n">Result</span><span class="p">&lt;</span><span class="n">IReadOnlyList</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;&gt;().</span><span class="n">Count</span> <span class="p">==</span> <span class="n">list</span><span class="p">.</span><span class="n">Count</span><span class="p">,</span> <span class="s">&quot;returned read-only list has the same number of elements as list&quot;</span><span class="p">);</span></div><div class='line' id='LC63'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="k">return</span> <span class="k">new</span> <span class="n">ListReadOnlyWrapper</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;(</span><span class="n">list</span><span class="p">);</span></div><div class='line' id='LC64'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="p">}</span></div><div class='line' id='LC65'><br/></div><div class='line' id='LC66'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="c1">/// &lt;summary&gt;</span></div><div class='line' id='LC67'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="c1">/// Creates a &lt;see cref=&quot;IReadOnlyCollection{T}&quot;/&gt; cloned collection around &lt;paramref name=&quot;list&quot;/&gt;. </span></div><div class='line' id='LC68'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="c1">/// &lt;/summary&gt;</span></div><div class='line' id='LC69'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="c1">/// &lt;typeparam name=&quot;T&quot;&gt;The type parameter of the items in the list.&lt;/typeparam&gt;</span></div><div class='line' id='LC70'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="c1">/// &lt;param name=&quot;list&quot;&gt;A list object.&lt;/param&gt;</span></div><div class='line' id='LC71'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="k">public</span> <span class="k">static</span> <span class="n">IReadOnlyList</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;</span> <span class="n">ToReadOnlyClonedList</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;(</span><span class="k">this</span> <span class="n">IEnumerable</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span></div><div class='line' id='LC72'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="n">Contract</span><span class="p">.</span><span class="n">Requires</span><span class="p">(</span><span class="n">list</span> <span class="p">!=</span> <span class="k">null</span><span class="p">,</span> <span class="s">&quot;collection must not be null&quot;</span><span class="p">);</span></div><div class='line' id='LC73'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="n">Contract</span><span class="p">.</span><span class="n">Ensures</span><span class="p">(</span><span class="n">Contract</span><span class="p">.</span><span class="n">Result</span><span class="p">&lt;</span><span class="n">IReadOnlyList</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;&gt;()</span> <span class="p">!=</span> <span class="k">null</span><span class="p">,</span> <span class="s">&quot;returned read-only list is not null&quot;</span><span class="p">);</span></div><div class='line' id='LC74'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="n">Contract</span><span class="p">.</span><span class="n">Ensures</span><span class="p">(</span><span class="n">Contract</span><span class="p">.</span><span class="n">Result</span><span class="p">&lt;</span><span class="n">IReadOnlyList</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;&gt;().</span><span class="n">Count</span> <span class="p">==</span> <span class="n">list</span><span class="p">.</span><span class="n">Count</span><span class="p">(),</span> <span class="s">&quot;returned read-only list has the same number of elements as list&quot;</span><span class="p">);</span></div><div class='line' id='LC75'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="k">return</span> <span class="k">new</span> <span class="n">ListReadOnlyWrapper</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;(</span><span class="n">list</span><span class="p">.</span><span class="n">ToArray</span><span class="p">());</span></div><div class='line' id='LC76'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="p">}</span></div><div class='line' id='LC77'><br/></div><div class='line' id='LC78'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="k">private</span> <span class="k">class</span> <span class="nc">CollectionReadOnlyWrapper</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;</span> <span class="p">:</span> <span class="n">IReadOnlyCollection</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;</span> <span class="p">{</span></div><div class='line' id='LC79'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="k">internal</span> <span class="nf">CollectionReadOnlyWrapper</span><span class="p">(</span><span class="n">ICollection</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;</span> <span class="n">collection</span><span class="p">)</span> <span class="p">{</span></div><div class='line' id='LC80'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="n">Debug</span><span class="p">.</span><span class="n">Assert</span><span class="p">(</span><span class="n">collection</span> <span class="p">!=</span> <span class="k">null</span><span class="p">);</span></div><div class='line' id='LC81'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="n">m_Collection</span> <span class="p">=</span> <span class="n">collection</span><span class="p">;</span></div><div class='line' id='LC82'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="p">}</span></div><div class='line' id='LC83'><br/></div><div class='line' id='LC84'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="k">readonly</span> <span class="n">ICollection</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;</span> <span class="n">m_Collection</span><span class="p">;</span></div><div class='line' id='LC85'><br/></div><div class='line' id='LC86'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="k">public</span> <span class="kt">int</span> <span class="n">Count</span> <span class="p">{</span></div><div class='line' id='LC87'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="k">get</span> <span class="p">{</span> <span class="k">return</span> <span class="n">m_Collection</span><span class="p">.</span><span class="n">Count</span><span class="p">;</span> <span class="p">}</span></div><div class='line' id='LC88'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="p">}</span></div><div class='line' id='LC89'><br/></div><div class='line' id='LC90'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="k">public</span> <span class="n">IEnumerator</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;</span> <span class="n">GetEnumerator</span><span class="p">()</span> <span class="p">{</span></div><div class='line' id='LC91'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="k">return</span> <span class="n">m_Collection</span><span class="p">.</span><span class="n">GetEnumerator</span><span class="p">();</span></div><div class='line' id='LC92'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="p">}</span></div><div class='line' id='LC93'><br/></div><div class='line' id='LC94'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="n">IEnumerator</span> <span class="n">IEnumerable</span><span class="p">.</span><span class="n">GetEnumerator</span><span class="p">()</span> <span class="p">{</span></div><div class='line' id='LC95'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="k">return</span> <span class="p">((</span><span class="n">IEnumerable</span><span class="p">)</span><span class="n">m_Collection</span><span class="p">).</span><span class="n">GetEnumerator</span><span class="p">();</span></div><div class='line' id='LC96'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="p">}</span></div><div class='line' id='LC97'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="p">}</span></div><div class='line' id='LC98'><br/></div><div class='line' id='LC99'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="k">private</span> <span class="k">class</span> <span class="nc">ListReadOnlyWrapper</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;</span> <span class="p">:</span> <span class="n">CollectionReadOnlyWrapper</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;,</span> <span class="n">IReadOnlyList</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;</span> <span class="p">{</span></div><div class='line' id='LC100'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="k">internal</span> <span class="nf">ListReadOnlyWrapper</span><span class="p">(</span><span class="n">IList</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;</span> <span class="n">list</span><span class="p">)</span> <span class="p">:</span> <span class="k">base</span><span class="p">(</span><span class="n">list</span><span class="p">)</span> <span class="p">{</span></div><div class='line' id='LC101'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="n">Debug</span><span class="p">.</span><span class="n">Assert</span><span class="p">(</span><span class="n">list</span> <span class="p">!=</span> <span class="k">null</span><span class="p">);</span></div><div class='line' id='LC102'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="n">m_List</span> <span class="p">=</span> <span class="n">list</span><span class="p">;</span></div><div class='line' id='LC103'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="p">}</span></div><div class='line' id='LC104'><br/></div><div class='line' id='LC105'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="k">private</span> <span class="k">readonly</span> <span class="n">IList</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;</span> <span class="n">m_List</span><span class="p">;</span></div><div class='line' id='LC106'><br/></div><div class='line' id='LC107'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="k">public</span> <span class="n">T</span> <span class="k">this</span><span class="p">[</span><span class="kt">int</span> <span class="n">index</span><span class="p">]</span> <span class="p">{</span></div><div class='line' id='LC108'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="k">get</span> <span class="p">{</span> <span class="k">return</span> <span class="n">m_List</span><span class="p">[</span><span class="n">index</span><span class="p">];</span> <span class="p">}</span></div><div class='line' id='LC109'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="p">}</span></div><div class='line' id='LC110'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="p">}</span></div><div class='line' id='LC111'><br/></div><div class='line' id='LC112'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="c1">///&lt;summary&gt;</span></div><div class='line' id='LC113'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="c1">///Determines the index of a specific item in &lt;paramref name=&quot;readOnlyList&quot;/&gt;.</span></div><div class='line' id='LC114'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="c1">///&lt;/summary&gt;</span></div><div class='line' id='LC115'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="c1">///&lt;typeparam name=&quot;T&quot;&gt;The type parameter of the items in the read-only list.&lt;/typeparam&gt;</span></div><div class='line' id='LC116'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="c1">///&lt;param name=&quot;readOnlyList&quot;&gt;&lt;/param&gt;</span></div><div class='line' id='LC117'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="c1">///&lt;param name=&quot;value&quot;&gt;The object to locate in &lt;paramref name=&quot;readOnlyList&quot;/&gt;.&lt;/param&gt;</span></div><div class='line' id='LC118'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="c1">///&lt;returns&gt;The index of value if found in the list; otherwise, -1.&lt;/returns&gt;</span></div><div class='line' id='LC119'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="c1">///&lt;remarks&gt;This method uses the EqualityComparer$lt;T&amp;gt;.Default.Equals() method on &lt;paramref name=&quot;value&quot;/&gt; to determine whether item exists&lt;/remarks&gt;</span></div><div class='line' id='LC120'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="k">public</span> <span class="k">static</span> <span class="kt">int</span> <span class="n">IndexOf</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;(</span><span class="k">this</span> <span class="n">IReadOnlyList</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;</span> <span class="n">readOnlyList</span><span class="p">,</span> <span class="n">T</span> <span class="k">value</span><span class="p">)</span> <span class="p">{</span></div><div class='line' id='LC121'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="n">Contract</span><span class="p">.</span><span class="n">Requires</span><span class="p">(</span><span class="n">readOnlyList</span> <span class="p">!=</span> <span class="k">null</span><span class="p">,</span> <span class="s">&quot;readOnlyList must not be null&quot;</span><span class="p">);</span></div><div class='line' id='LC122'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kt">var</span> <span class="n">count</span> <span class="p">=</span> <span class="n">readOnlyList</span><span class="p">.</span><span class="n">Count</span><span class="p">;</span></div><div class='line' id='LC123'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kt">var</span> <span class="n">equalityComparer</span> <span class="p">=</span> <span class="n">EqualityComparer</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;.</span><span class="n">Default</span><span class="p">;</span></div><div class='line' id='LC124'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="k">for</span><span class="p">(</span><span class="kt">var</span> <span class="n">i</span> <span class="p">=</span><span class="m">0</span><span class="p">;</span> <span class="n">i</span><span class="p">&lt;</span> <span class="n">count</span><span class="p">;</span> <span class="n">i</span><span class="p">++)</span> <span class="p">{</span></div><div class='line' id='LC125'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kt">var</span> <span class="n">current</span> <span class="p">=</span> <span class="n">readOnlyList</span><span class="p">[</span><span class="n">i</span><span class="p">];</span></div><div class='line' id='LC126'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="k">if</span> <span class="p">(</span><span class="n">equalityComparer</span><span class="p">.</span><span class="n">Equals</span><span class="p">(</span><span class="n">current</span><span class="p">,</span> <span class="k">value</span><span class="p">))</span> <span class="p">{</span> <span class="k">return</span> <span class="n">i</span><span class="p">;</span> <span class="p">}</span></div><div class='line' id='LC127'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="p">}</span></div><div class='line' id='LC128'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="k">return</span><span class="p">-</span> <span class="m">1</span><span class="p">;</span></div><div class='line' id='LC129'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="p">}</span></div><div class='line' id='LC130'>&nbsp;&nbsp;&nbsp;<span class="p">}</span></div><div class='line' id='LC131'><br/></div><div class='line' id='LC132'><br/></div><div class='line' id='LC133'><br/></div><div class='line' id='LC134'><br/></div><div class='line' id='LC135'><br/></div><div class='line' id='LC136'><span class="na">   [TestFixture]</span></div><div class='line' id='LC137'>&nbsp;&nbsp;&nbsp;<span class="k">public</span> <span class="k">class</span> <span class="nc">Test_ReadOnlyCollectionList</span> <span class="p">{</span></div><div class='line' id='LC138'><br/></div><div class='line' id='LC139'><span class="na">      [Test]</span></div><div class='line' id='LC140'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="k">public</span> <span class="k">void</span> <span class="nf">Test_ReadOnlyCollection</span><span class="p">()</span> <span class="p">{</span></div><div class='line' id='LC141'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kt">var</span> <span class="n">collection</span> <span class="p">=</span> <span class="k">new</span> <span class="n">List</span><span class="p">&lt;</span><span class="kt">int</span><span class="p">&gt;</span> <span class="p">{</span> <span class="m">11</span><span class="p">,</span> <span class="m">21</span> <span class="p">};</span></div><div class='line' id='LC142'><br/></div><div class='line' id='LC143'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kt">var</span> <span class="n">wrappedCollection</span> <span class="p">=</span> <span class="n">collection</span><span class="p">.</span><span class="n">ToReadOnlyWrappedCollection</span><span class="p">();</span></div><div class='line' id='LC144'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="n">Assert</span><span class="p">.</span><span class="n">IsTrue</span><span class="p">(</span><span class="n">wrappedCollection</span><span class="p">.</span><span class="n">Count</span> <span class="p">==</span> <span class="m">2</span><span class="p">);</span></div><div class='line' id='LC145'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="n">Assert</span><span class="p">.</span><span class="n">IsTrue</span><span class="p">(</span><span class="n">wrappedCollection</span><span class="p">.</span><span class="n">ElementAt</span><span class="p">(</span><span class="m">0</span><span class="p">)</span> <span class="p">==</span> <span class="m">11</span><span class="p">);</span></div><div class='line' id='LC146'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="n">Assert</span><span class="p">.</span><span class="n">IsTrue</span><span class="p">(</span><span class="n">wrappedCollection</span><span class="p">.</span><span class="n">ElementAt</span><span class="p">(</span><span class="m">1</span><span class="p">)</span> <span class="p">==</span> <span class="m">21</span><span class="p">);</span></div><div class='line' id='LC147'><br/></div><div class='line' id='LC148'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kt">var</span> <span class="n">clonedCollection</span> <span class="p">=</span> <span class="n">collection</span><span class="p">.</span><span class="n">ToReadOnlyClonedCollection</span><span class="p">();</span></div><div class='line' id='LC149'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="n">Assert</span><span class="p">.</span><span class="n">IsTrue</span><span class="p">(</span><span class="n">clonedCollection</span><span class="p">.</span><span class="n">Count</span> <span class="p">==</span> <span class="m">2</span><span class="p">);</span></div><div class='line' id='LC150'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="n">Assert</span><span class="p">.</span><span class="n">IsTrue</span><span class="p">(</span><span class="n">clonedCollection</span><span class="p">.</span><span class="n">ElementAt</span><span class="p">(</span><span class="m">0</span><span class="p">)</span> <span class="p">==</span> <span class="m">11</span><span class="p">);</span></div><div class='line' id='LC151'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="n">Assert</span><span class="p">.</span><span class="n">IsTrue</span><span class="p">(</span><span class="n">clonedCollection</span><span class="p">.</span><span class="n">ElementAt</span><span class="p">(</span><span class="m">1</span><span class="p">)</span> <span class="p">==</span> <span class="m">21</span><span class="p">);</span></div><div class='line' id='LC152'><br/></div><div class='line' id='LC153'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="c1">// Test Cloned/Wrapped</span></div><div class='line' id='LC154'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="n">collection</span><span class="p">.</span><span class="n">Add</span><span class="p">(</span><span class="m">31</span><span class="p">);</span></div><div class='line' id='LC155'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="n">Assert</span><span class="p">.</span><span class="n">IsTrue</span><span class="p">(</span><span class="n">wrappedCollection</span><span class="p">.</span><span class="n">Count</span> <span class="p">==</span> <span class="m">3</span><span class="p">);</span></div><div class='line' id='LC156'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="n">Assert</span><span class="p">.</span><span class="n">IsTrue</span><span class="p">(</span><span class="n">wrappedCollection</span><span class="p">.</span><span class="n">ElementAt</span><span class="p">(</span><span class="m">2</span><span class="p">)</span> <span class="p">==</span> <span class="m">31</span><span class="p">);</span></div><div class='line' id='LC157'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="n">Assert</span><span class="p">.</span><span class="n">IsTrue</span><span class="p">(</span><span class="n">clonedCollection</span><span class="p">.</span><span class="n">Count</span> <span class="p">==</span> <span class="m">2</span><span class="p">);</span></div><div class='line' id='LC158'><br/></div><div class='line' id='LC159'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="c1">// Force cover the IEnumerable.GetEnumerator()</span></div><div class='line' id='LC160'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="n">IEnumerator</span> <span class="n">enumerator</span> <span class="p">=</span> <span class="p">((</span><span class="n">IEnumerable</span><span class="p">)</span><span class="n">wrappedCollection</span><span class="p">).</span><span class="n">GetEnumerator</span><span class="p">();</span></div><div class='line' id='LC161'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="n">enumerator</span><span class="p">.</span><span class="n">MoveNext</span><span class="p">();</span></div><div class='line' id='LC162'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="n">Assert</span><span class="p">.</span><span class="n">IsTrue</span><span class="p">((</span><span class="kt">int</span><span class="p">)(</span><span class="n">enumerator</span><span class="p">.</span><span class="n">Current</span><span class="p">)</span> <span class="p">==</span> <span class="m">11</span><span class="p">);</span></div><div class='line' id='LC163'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="p">}</span></div><div class='line' id='LC164'><br/></div><div class='line' id='LC165'><br/></div><div class='line' id='LC166'><span class="na">      [Test]</span></div><div class='line' id='LC167'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="k">public</span> <span class="k">void</span> <span class="nf">Test_ReadOnlyList</span><span class="p">()</span> <span class="p">{</span></div><div class='line' id='LC168'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kt">var</span> <span class="n">list</span> <span class="p">=</span> <span class="k">new</span> <span class="n">List</span><span class="p">&lt;</span><span class="kt">int</span><span class="p">&gt;</span> <span class="p">{</span> <span class="m">11</span><span class="p">,</span><span class="m">21</span> <span class="p">};</span></div><div class='line' id='LC169'><br/></div><div class='line' id='LC170'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kt">var</span> <span class="n">wrappedList</span> <span class="p">=</span> <span class="n">list</span><span class="p">.</span><span class="n">ToReadOnlyWrappedList</span><span class="p">();</span></div><div class='line' id='LC171'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="n">Assert</span><span class="p">.</span><span class="n">IsTrue</span><span class="p">(</span><span class="n">wrappedList</span><span class="p">.</span><span class="n">Count</span> <span class="p">==</span> <span class="m">2</span><span class="p">);</span></div><div class='line' id='LC172'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="n">Assert</span><span class="p">.</span><span class="n">IsTrue</span><span class="p">(</span><span class="n">wrappedList</span><span class="p">[</span><span class="m">0</span><span class="p">]</span> <span class="p">==</span> <span class="m">11</span><span class="p">);</span></div><div class='line' id='LC173'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="n">Assert</span><span class="p">.</span><span class="n">IsTrue</span><span class="p">(</span><span class="n">wrappedList</span><span class="p">[</span><span class="m">1</span><span class="p">]</span> <span class="p">==</span> <span class="m">21</span><span class="p">);</span></div><div class='line' id='LC174'><br/></div><div class='line' id='LC175'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kt">var</span> <span class="n">clonedList</span> <span class="p">=</span> <span class="n">list</span><span class="p">.</span><span class="n">ToReadOnlyClonedList</span><span class="p">();</span></div><div class='line' id='LC176'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="n">Assert</span><span class="p">.</span><span class="n">IsTrue</span><span class="p">(</span><span class="n">clonedList</span><span class="p">.</span><span class="n">Count</span> <span class="p">==</span> <span class="m">2</span><span class="p">);</span></div><div class='line' id='LC177'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="n">Assert</span><span class="p">.</span><span class="n">IsTrue</span><span class="p">(</span><span class="n">clonedList</span><span class="p">[</span><span class="m">0</span><span class="p">]</span> <span class="p">==</span> <span class="m">11</span><span class="p">);</span></div><div class='line' id='LC178'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="n">Assert</span><span class="p">.</span><span class="n">IsTrue</span><span class="p">(</span><span class="n">clonedList</span><span class="p">[</span><span class="m">1</span><span class="p">]</span> <span class="p">==</span> <span class="m">21</span><span class="p">);</span></div><div class='line' id='LC179'><br/></div><div class='line' id='LC180'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="c1">// Test Cloned/Wrapped</span></div><div class='line' id='LC181'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="n">list</span><span class="p">.</span><span class="n">Add</span><span class="p">(</span><span class="m">31</span><span class="p">);</span></div><div class='line' id='LC182'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="n">Assert</span><span class="p">.</span><span class="n">IsTrue</span><span class="p">(</span><span class="n">wrappedList</span><span class="p">.</span><span class="n">Count</span> <span class="p">==</span> <span class="m">3</span><span class="p">);</span></div><div class='line' id='LC183'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="n">Assert</span><span class="p">.</span><span class="n">IsTrue</span><span class="p">(</span><span class="n">wrappedList</span><span class="p">[</span><span class="m">2</span><span class="p">]</span> <span class="p">==</span> <span class="m">31</span><span class="p">);</span></div><div class='line' id='LC184'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="n">Assert</span><span class="p">.</span><span class="n">IsTrue</span><span class="p">(</span><span class="n">clonedList</span><span class="p">.</span><span class="n">Count</span> <span class="p">==</span> <span class="m">2</span><span class="p">);</span></div><div class='line' id='LC185'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="p">}</span></div><div class='line' id='LC186'><br/></div><div class='line' id='LC187'><span class="na">      [Test]</span></div><div class='line' id='LC188'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="k">public</span> <span class="k">void</span> <span class="nf">Test_IndexOf</span><span class="p">()</span> <span class="p">{</span></div><div class='line' id='LC189'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kt">var</span> <span class="n">ints</span> <span class="p">=</span> <span class="p">(</span><span class="k">new</span> <span class="n">List</span><span class="p">&lt;</span><span class="kt">int</span><span class="p">&gt;</span> <span class="p">{</span><span class="m">11</span><span class="p">,</span> <span class="m">21</span><span class="p">,</span> <span class="m">31</span><span class="p">}).</span><span class="n">ToReadOnlyWrappedList</span><span class="p">();</span></div><div class='line' id='LC190'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="n">Assert</span><span class="p">.</span><span class="n">IsTrue</span><span class="p">(</span><span class="n">ints</span><span class="p">.</span><span class="n">IndexOf</span><span class="p">(</span><span class="m">21</span><span class="p">)</span> <span class="p">==</span> <span class="m">1</span><span class="p">);</span></div><div class='line' id='LC191'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="n">Assert</span><span class="p">.</span><span class="n">IsTrue</span><span class="p">(</span><span class="n">ints</span><span class="p">.</span><span class="n">IndexOf</span><span class="p">(</span><span class="m">41</span><span class="p">)</span> <span class="p">==</span> <span class="p">-</span><span class="m">1</span><span class="p">);</span></div><div class='line' id='LC192'><br/></div><div class='line' id='LC193'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kt">var</span> <span class="n">strings</span> <span class="p">=</span> <span class="p">(</span><span class="k">new</span> <span class="n">List</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">&gt;</span> <span class="p">{</span><span class="s">&quot;11&quot;</span><span class="p">,</span> <span class="s">&quot;21&quot;</span><span class="p">,</span> <span class="s">&quot;31&quot;</span><span class="p">}).</span><span class="n">ToReadOnlyWrappedList</span><span class="p">();</span></div><div class='line' id='LC194'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="n">Assert</span><span class="p">.</span><span class="n">IsTrue</span><span class="p">(</span><span class="n">strings</span><span class="p">.</span><span class="n">IndexOf</span><span class="p">(</span><span class="s">&quot;21&quot;</span><span class="p">)</span> <span class="p">==</span> <span class="m">1</span><span class="p">);</span></div><div class='line' id='LC195'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="n">Assert</span><span class="p">.</span><span class="n">IsTrue</span><span class="p">(</span><span class="n">strings</span><span class="p">.</span><span class="n">IndexOf</span><span class="p">(</span><span class="s">&quot;41&quot;</span><span class="p">)</span> <span class="p">==</span> <span class="p">-</span><span class="m">1</span><span class="p">);</span></div><div class='line' id='LC196'><br/></div><div class='line' id='LC197'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kt">var</span> <span class="n">obj</span> <span class="p">=</span> <span class="k">new</span> <span class="kt">object</span><span class="p">();</span></div><div class='line' id='LC198'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kt">var</span> <span class="n">objects</span> <span class="p">=</span> <span class="p">(</span><span class="k">new</span> <span class="n">List</span><span class="p">&lt;</span><span class="kt">object</span><span class="p">&gt;</span> <span class="p">{</span><span class="k">new</span> <span class="kt">object</span><span class="p">(),</span> <span class="n">obj</span><span class="p">,</span> <span class="k">new</span> <span class="kt">object</span><span class="p">()}).</span><span class="n">ToReadOnlyWrappedList</span><span class="p">();</span></div><div class='line' id='LC199'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="n">Assert</span><span class="p">.</span><span class="n">IsTrue</span><span class="p">(</span><span class="n">objects</span><span class="p">.</span><span class="n">IndexOf</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span> <span class="p">==</span> <span class="m">1</span><span class="p">);</span></div><div class='line' id='LC200'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="n">Assert</span><span class="p">.</span><span class="n">IsTrue</span><span class="p">(</span><span class="n">objects</span><span class="p">.</span><span class="n">IndexOf</span><span class="p">(</span><span class="k">new</span> <span class="kt">object</span><span class="p">())</span> <span class="p">==</span> <span class="p">-</span><span class="m">1</span><span class="p">);</span></div><div class='line' id='LC201'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="p">}</span></div><div class='line' id='LC202'>&nbsp;&nbsp;&nbsp;<span class="p">}</span></div></pre></div>
          </div>

          <div class="gist-meta">
            <a href="https://gist.github.com/raw/3247559/1ac54e60a786ab1b082f51dc7fb16c8c559383a0/gistfile1.cs" style="float:right;">view raw</a>
            <a href="https://gist.github.com/3247559#file_gistfile1.cs" style="float:right;margin-right:10px;color:#666">gistfile1.cs</a>
            <a href="https://gist.github.com/3247559">This Gist</a> brought to you by <a href="http://github.com">GitHub</a>.
          </div>
        </div>
</div>
</noscript>
<p>And finally, I did a CQLinq rule to check that NDepend.API will never return anymore a <em>ICollection&lt;T&gt;</em>!</p>
<script src="http://gist.github.com/3249750.js"></script><noscript><link rel="stylesheet" href="https://gist.github.com/stylesheets/gist/embed.css"><div id="gist-3249750" class="gist">
    
        <div class="gist-file">
          <div class="gist-data gist-syntax">
              <div class="highlight"><pre><div class='line' id='LC1'><span class="c1">// &lt;Name&gt;Check enumerable types returned by NDepend.API&lt;/Name&gt;</span></div><div class='line' id='LC2'><span class="n">warnif</span> <span class="n">count</span> <span class="p">&gt;</span> <span class="m">0</span></div><div class='line' id='LC3'><span class="n">let</span> <span class="n">seqTypes</span> <span class="p">=</span> <span class="n">Types</span><span class="p">.</span><span class="n">Where</span><span class="p">(</span></div><div class='line' id='LC4'>&nbsp;&nbsp;&nbsp;<span class="n">t</span> <span class="p">=&gt;</span> <span class="n">t</span><span class="p">.</span><span class="n">Implement</span><span class="p">(</span><span class="s">&quot;System.Collections.Generic.IEnumerable&lt;T&gt;&quot;</span><span class="p">)</span> <span class="p">&amp;&amp;</span></div><div class='line' id='LC5'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="c1">// List of enumerable types that can be returned by a NDepend.API function.</span></div><div class='line' id='LC6'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="p">!</span><span class="n">t</span><span class="p">.</span><span class="n">FullName</span><span class="p">.</span><span class="n">EqualsAny</span><span class="p">(</span><span class="s">&quot;System.String&quot;</span><span class="p">,</span></div><div class='line' id='LC7'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="s">&quot;System.Linq.ILookup&lt;TKey,TElement&gt;&quot;</span><span class="p">,</span></div><div class='line' id='LC8'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="s">&quot;NDepend.Helpers.IReadOnlyList&lt;T&gt;&quot;</span><span class="p">,</span></div><div class='line' id='LC9'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="s">&quot;NDepend.Helpers.IReadOnlyCollection&lt;T&gt;&quot;</span><span class="p">,</span></div><div class='line' id='LC10'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="s">&quot;System.Collections.Generic.HashSet&lt;T&gt;&quot;</span><span class="p">,</span></div><div class='line' id='LC11'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="s">&quot;NDepend.CodeModel.ICodeMetric&lt;TCodeElement,TNumeric&gt;&quot;</span><span class="p">)).</span><span class="n">ToHashSet</span><span class="p">()</span></div><div class='line' id='LC12'><br/></div><div class='line' id='LC13'><span class="k">from</span> <span class="n">m</span> <span class="k">in</span> <span class="n">Assemblies</span><span class="p">.</span><span class="n">WithNameIn</span><span class="p">(</span> <span class="s">&quot;NDepend.API&quot;</span><span class="p">).</span><span class="n">ChildMethods</span><span class="p">()</span> <span class="k">orderby</span> <span class="n">m</span><span class="p">.</span><span class="n">NbLinesOfCode</span> <span class="k">descending</span></div><div class='line' id='LC14'><br/></div><div class='line' id='LC15'><span class="k">where</span> <span class="n">m</span><span class="p">.</span><span class="n">IsPubliclyVisible</span> <span class="p">&amp;&amp;</span></div><div class='line' id='LC16'>&nbsp;<span class="n">m</span><span class="p">.</span><span class="n">ReturnType</span> <span class="p">!=</span> <span class="k">null</span> <span class="p">&amp;&amp;</span></div><div class='line' id='LC17'>&nbsp;<span class="n">seqTypes</span><span class="p">.</span><span class="n">Contains</span><span class="p">(</span><span class="n">m</span><span class="p">.</span><span class="n">ReturnType</span><span class="p">)</span></div><div class='line' id='LC18'><span class="k">select</span> <span class="k">new</span> <span class="p">{</span> <span class="n">m</span><span class="p">,</span> <span class="n">m</span><span class="p">.</span><span class="n">ReturnType</span> <span class="p">}</span></div></pre></div>
          </div>

          <div class="gist-meta">
            <a href="https://gist.github.com/raw/3249750/83eefa5c696cb374799356f48e1811400d122431/gistfile1.cs" style="float:right;">view raw</a>
            <a href="https://gist.github.com/3249750#file_gistfile1.cs" style="float:right;margin-right:10px;color:#666">gistfile1.cs</a>
            <a href="https://gist.github.com/3249750">This Gist</a> brought to you by <a href="http://github.com">GitHub</a>.
          </div>
        </div>
</div>
</noscript>
]]></content:encoded>
			<wfw:commentRss>http://codebetter.com/patricksmacchia/2012/08/06/the-consequence-of-a-net-framework-api-design-flaw/feed/</wfw:commentRss>
		<slash:comments>11</slash:comments>
		</item>
		<item>
		<title>Include IL Offset into production exception StackTrace</title>
		<link>http://codebetter.com/patricksmacchia/2012/06/27/include-il-offset-into-production-exception-stacktrace/</link>
		<comments>http://codebetter.com/patricksmacchia/2012/06/27/include-il-offset-into-production-exception-stacktrace/#comments</comments>
		<pubDate>Wed, 27 Jun 2012 13:33:01 +0000</pubDate>
		<dc:creator>Patrick Smacchia</dc:creator>
				<category><![CDATA[Uncategorized]]></category>

		<guid isPermaLink="false">http://codebetter.com/patricksmacchia/?p=654</guid>
		<description><![CDATA[We are currently doing an intensive pesky minor bugs session. Bugs are logged into our gmail account as a production bug tracking server. For each logged crash, we get a stack trace and plenty of information about the machine environment. One&#160;&#8230; <a href="http://codebetter.com/patricksmacchia/2012/06/27/include-il-offset-into-production-exception-stacktrace/">Continue&#160;reading&#160;<span class="meta-nav">&#8594;</span></a>]]></description>
			<content:encoded><![CDATA[<p>We are currently doing an intensive <em>pesky minor bugs session</em>. Bugs are logged into our <a href="http://codebetter.com/patricksmacchia/2011/10/13/using-a-gmail-account-as-a-production-bug-tracking-server/" target="_blank">gmail account as a production bug tracking server</a>. For each logged crash, we get a stack trace and plenty of information about the machine environment.</p>
<p>One recurrent problem with exception stack trace in .NET, is that, one needs to release PDB files with assemblies installed in production code. Without PDB files, you still gets the stack trace of methods called, but you loose the exact source file line from where the exception popups. The problem is that usually the PDBs files weight between one and two times the weight of the target assemblies. Hence, releasing PDBs is usually not an option because this consumes so much more memory (both install hard-drive memory, and process memory at run-time).</p>
<p>The exact source file line from where the exception popups is not just a convenient info, it is an <em>essential </em>info. The typical wrong situation is when a method throws a <em>NullReferenceException</em>, but contains several references that can potentially be null: in such case you are stuck because you are missing the information from where exactly the exception popups. Knowing the exact source file line from where the exception popups, it would become easy to identify the faulty null reference.</p>
<p>To fix this situation, Mike Stall, the MSFT debugging guru, wrote a blog post about <a href="http://blogs.msdn.com/b/jmstall/archive/2005/08/25/pdb2xml.aspx" target="_blank">Converting a managed PDB into a XML file</a>. This blog post shows a trick about how to use some tooling to both, not release the PDB files, and be able to retrieve the exact source code line from a production exception stacktrace. The problem is that often real-world application assemblies are obfuscated. The correspondence between released obfuscated assemblies and their initial PDBs is then completely broken.</p>
<p>Yesterday, I just realized that somehow, it should be possible to retrieve the IL offset in the obfuscated method body, that provokes the production exception. After googling a bit, <a href="http://www.velocityreviews.com/forums/t95143-reading-stack-trace.html" target="_blank">it seems that sometime stacktrace contains the IL offset, at the end of each frame, after a plus &#8216;+&#8217; character</a>. However I haven&#8217;t been able to determine what should be done to get this extra information.</p>
<p>Hopefully, as always, more googling lead to exactly what I was looking for: in the step 3 of this blog post <a href="http://www.timstall.com/2008/07/getting-file-and-line-numbers-without.html" target="_blank">Getting file and line numbers without deploying the PDB files</a> Tim Stall (<em>another Stall debug guru?</em>) shows how to retrieve all stack trace and IL offset programatically. Using this info, I&#8217;ve been able to rebuild completely the stack trace, including IL Offset formatted the same way as Reflector does (hexadecimal with 4 digits prefixed with <em>L_</em>).</p>
<script src="http://gist.github.com/3003973.js"></script><noscript><link rel="stylesheet" href="https://gist.github.com/stylesheets/gist/embed.css"><div id="gist-3003973" class="gist">
    
        <div class="gist-file">
          <div class="gist-data gist-syntax">
              <div class="highlight"><pre><div class='line' id='LC1'>************** Exception Text **************</div><div class='line' id='LC2'>Exception on UI Thread</div><div class='line' id='LC3'>Exception in NDepend v4.0.2.6481</div><div class='line' id='LC4'>.NET Fx Version: 2.0.50727.4963</div><div class='line' id='LC5'>OS Windows Version: 6.1.7600.0</div><div class='line' id='LC6'>Processor Architecture: x86</div><div class='line' id='LC7'>#Handles in Process: 332</div><div class='line' id='LC8'>Execution Environment: UI</div><div class='line' id='LC9'>Error Hash: 4.0.2.6481 PRO 7B8BDF42 System.NullReferenceException</div><div class='line' id='LC10'>LicenseId: XXXYYYZZZ</div><div class='line' id='LC11'><br/></div><div class='line' id='LC12'>Exception.Type {System.NullReferenceException}</div><div class='line' id='LC13'>Exception.Message {La référence d&#39;objet n&#39;est pas définie à une instance d&#39;un objet.}</div><div class='line' id='LC14'>Exception.StackTrace {</div><div class='line' id='LC15'>&nbsp;&nbsp;afp.b()   L_013e </div><div class='line' id='LC16'>&nbsp;&nbsp;afp..ctor()   L_0017 </div><div class='line' id='LC17'>&nbsp;&nbsp;w0.a(aa3 A_0)   L_0000 </div><div class='line' id='LC18'>&nbsp;&nbsp;aoq.a(Object A_0, EventArgs A_1)   L_0000 </div><div class='line' id='LC19'>&nbsp;&nbsp;axo.a(Object A_0, ItemClickEventArgs A_1)   L_0009 </div><div class='line' id='LC20'>...</div></pre></div>
          </div>

          <div class="gist-meta">
            <a href="https://gist.github.com/raw/3003973/307c68b095cd7728f0b58494d36e2dfbe1305ff9/gistfile1.txt" style="float:right;">view raw</a>
            <a href="https://gist.github.com/3003973#file_gistfile1.txt" style="float:right;margin-right:10px;color:#666">gistfile1.txt</a>
            <a href="https://gist.github.com/3003973">This Gist</a> brought to you by <a href="http://github.com">GitHub</a>.
          </div>
        </div>
</div>
</noscript>
<p>Now we get clean stack trace with IL offset. It is pretty straightforward  to infer a source code line from a IL instructions. You just have to know that if the N<em>th</em> IL instructions  throw the exception, you&#8217;ll get the offset of the N-1<em>th</em> IL instruction logged.</p>
<p>Notice that we use <a href="http://www.preemptive.com/products/dotfuscator/overview/" target="_blank">Preemptive Dotfuscator</a> for obfuscation, and this tool come with <a href="http://www.preemptive.com/support/resources/lucidator" target="_blank">Lucidator</a> to transform a stacktrace made of obfuscated methods, into a stack trace with original methods name.</p>
<p>Find below our source code + associated tests. This code implements another requirement: we remove all localization info from the stacktrace. This way we are able to build a hash code from a stacktrace. Such hash code is pretty useful to group similar crash logs, independently from the underlying Windows machines localization settings.</p>
<script src="http://gist.github.com/3003999.js"></script><noscript><link rel="stylesheet" href="https://gist.github.com/stylesheets/gist/embed.css"><div id="gist-3003999" class="gist">
    

        <div class="gist-file">
          <div class="gist-data gist-syntax">
              <div class="highlight"><pre><div class='line' id='LC1'><span class="k">using</span> <span class="nn">System</span><span class="p">;</span></div><div class='line' id='LC2'><span class="k">using</span> <span class="nn">System.Diagnostics</span><span class="p">;</span></div><div class='line' id='LC3'><span class="k">using</span> <span class="nn">System.Reflection</span><span class="p">;</span></div><div class='line' id='LC4'><span class="k">using</span> <span class="nn">System.Text</span><span class="p">;</span></div><div class='line' id='LC5'><span class="k">using</span> <span class="nn">NDepend.Attributes</span><span class="p">;</span></div><div class='line' id='LC6'><span class="k">using</span> <span class="nn">NDepend.Helpers</span><span class="p">;</span></div><div class='line' id='LC7'><br/></div><div class='line' id='LC8'><span class="k">namespace</span> <span class="nn">NDepend.Product.ErrorHandling</span> <span class="p">{</span></div><div class='line' id='LC9'><br/></div><div class='line' id='LC10'><span class="cp">#if DEBUG</span></div><div class='line' id='LC11'><span class="na">   [FullCovered]</span></div><div class='line' id='LC12'><span class="cp">#endif</span></div><div class='line' id='LC13'>&nbsp;&nbsp;&nbsp;<span class="k">internal</span> <span class="k">static</span> <span class="k">class</span> <span class="nc">StackTraceHelper</span> <span class="p">{</span></div><div class='line' id='LC14'><br/></div><div class='line' id='LC15'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</div><div class='line' id='LC16'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="k">internal</span> <span class="k">static</span> <span class="kt">string</span> <span class="nf">FormatStackTrace</span><span class="p">(</span><span class="n">Exception</span> <span class="n">ex</span><span class="p">)</span> <span class="p">{</span></div><div class='line' id='LC17'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="n">Debug</span><span class="p">.</span><span class="n">Assert</span><span class="p">(</span><span class="n">ex</span> <span class="p">!=</span> <span class="k">null</span><span class="p">);</span></div><div class='line' id='LC18'><span class="cp">#if DEBUG</span></div><div class='line' id='LC19'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="k">return</span> <span class="nf">FormatUnlocalizedStackTraceFromString</span><span class="p">(</span><span class="n">ex</span><span class="p">.</span><span class="n">StackTrace</span><span class="p">);</span></div><div class='line' id='LC20'><span class="cp">#else </span></div><div class='line' id='LC21'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="k">return</span> <span class="nf">FormatUnlocalizedStackTraceWithILOffset</span><span class="p">(</span><span class="n">ex</span><span class="p">);</span></div><div class='line' id='LC22'><span class="cp">#endif</span></div><div class='line' id='LC23'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="p">}</span></div><div class='line' id='LC24'><br/></div><div class='line' id='LC25'><br/></div><div class='line' id='LC26'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</div><div class='line' id='LC27'><br/></div><div class='line' id='LC28'><br/></div><div class='line' id='LC29'><span class="cp">#region FormatUnlocalizedStackTraceWithILOffset()</span></div><div class='line' id='LC30'><br/></div><div class='line' id='LC31'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="c1">// 27June2012: Idea to get the ILOffset from stackTrace: http://www.timstall.com/2008/07/getting-file-and-line-numbers-without.html</span></div><div class='line' id='LC32'><span class="cp">#if DEBUG</span></div><div class='line' id='LC33'><span class="na">      [IsNotDeadCode]</span> <span class="c1">// Coz used by tests and release version!!!</span></div><div class='line' id='LC34'><span class="cp">#endif</span></div><div class='line' id='LC35'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="k">internal</span> <span class="k">static</span> <span class="kt">string</span> <span class="nf">FormatUnlocalizedStackTraceWithILOffset</span><span class="p">(</span><span class="n">Exception</span> <span class="n">ex</span><span class="p">)</span> <span class="p">{</span></div><div class='line' id='LC36'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="n">Debug</span><span class="p">.</span><span class="n">Assert</span><span class="p">(</span><span class="n">ex</span> <span class="p">!=</span> <span class="k">null</span><span class="p">);</span></div><div class='line' id='LC37'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="k">try</span> <span class="p">{</span></div><div class='line' id='LC38'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="c1">//Get offset:</span></div><div class='line' id='LC39'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kt">var</span> <span class="n">stackTrace</span> <span class="p">=</span> <span class="k">new</span> <span class="n">StackTrace</span><span class="p">(</span><span class="n">ex</span><span class="p">,</span> <span class="k">true</span><span class="p">);</span></div><div class='line' id='LC40'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="n">StackFrame</span><span class="p">[]</span> <span class="n">stackFrames</span> <span class="p">=</span> <span class="n">stackTrace</span><span class="p">.</span><span class="n">GetFrames</span><span class="p">();</span></div><div class='line' id='LC41'><br/></div><div class='line' id='LC42'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kt">var</span> <span class="n">sb</span> <span class="p">=</span> <span class="k">new</span> <span class="n">StringBuilder</span><span class="p">();</span></div><div class='line' id='LC43'><br/></div><div class='line' id='LC44'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kt">var</span> <span class="n">stackFramesLength</span> <span class="p">=</span> <span class="k">new</span> <span class="kt">int</span><span class="p">[</span><span class="n">stackFrames</span><span class="p">.</span><span class="n">Length</span><span class="p">];</span></div><div class='line' id='LC45'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="k">for</span> <span class="p">(</span><span class="kt">var</span> <span class="n">i</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span> <span class="n">i</span> <span class="p">&lt;</span> <span class="n">stackFramesLength</span><span class="p">.</span><span class="n">Length</span><span class="p">;</span> <span class="n">i</span><span class="p">++)</span> <span class="p">{</span></div><div class='line' id='LC46'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kt">var</span> <span class="n">stacfkFrame</span> <span class="p">=</span> <span class="n">stackFrames</span><span class="p">[</span><span class="n">i</span><span class="p">];</span></div><div class='line' id='LC47'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kt">var</span> <span class="n">method</span> <span class="p">=</span> <span class="n">stacfkFrame</span><span class="p">.</span><span class="n">GetMethod</span><span class="p">();</span></div><div class='line' id='LC48'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kt">var</span> <span class="n">parameters</span> <span class="p">=</span> <span class="n">GetMethodParameters</span><span class="p">(</span><span class="n">method</span><span class="p">);</span></div><div class='line' id='LC49'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kt">var</span> <span class="n">ilOffset</span> <span class="p">=</span> <span class="n">GetILOffset</span><span class="p">(</span><span class="n">stacfkFrame</span><span class="p">.</span><span class="n">GetILOffset</span><span class="p">());</span></div><div class='line' id='LC50'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="n">sb</span><span class="p">.</span><span class="n">Append</span><span class="p">(</span><span class="kt">string</span><span class="p">.</span><span class="n">Format</span><span class="p">(</span><span class="s">&quot;  {0}.{1}({2})   {3} \r\n&quot;</span><span class="p">,</span></div><div class='line' id='LC51'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="n">method</span><span class="p">.</span><span class="n">ReflectedType</span><span class="p">.</span><span class="n">FullName</span><span class="p">,</span> </div><div class='line' id='LC52'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="n">method</span><span class="p">.</span><span class="n">Name</span><span class="p">,</span> </div><div class='line' id='LC53'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="n">parameters</span><span class="p">,</span></div><div class='line' id='LC54'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="n">ilOffset</span><span class="p">));</span></div><div class='line' id='LC55'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="p">}</span></div><div class='line' id='LC56'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="k">return</span> <span class="n">sb</span><span class="p">.</span><span class="n">ToString</span><span class="p">();</span></div><div class='line' id='LC57'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="p">}</span> <span class="k">catch</span>  <span class="p">{</span></div><div class='line' id='LC58'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="k">return</span> <span class="nf">FormatUnlocalizedStackTraceFromString</span><span class="p">(</span><span class="n">ex</span><span class="p">.</span><span class="n">StackTrace</span><span class="p">);</span></div><div class='line' id='LC59'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="p">}</span></div><div class='line' id='LC60'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="p">}</span></div><div class='line' id='LC61'><br/></div><div class='line' id='LC62'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="k">private</span> <span class="k">static</span> <span class="kt">string</span> <span class="nf">GetILOffset</span><span class="p">(</span><span class="kt">int</span> <span class="n">ilOffset</span><span class="p">)</span> <span class="p">{</span></div><div class='line' id='LC63'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="n">Debug</span><span class="p">.</span><span class="n">Assert</span><span class="p">(</span><span class="n">ilOffset</span> <span class="p">&gt;=</span> <span class="m">0</span><span class="p">);</span></div><div class='line' id='LC64'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="c1">// Format to hexadecimal to have a Reflector like IL instruction OffSet</span></div><div class='line' id='LC65'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kt">var</span> <span class="n">ilOffsetHexString</span> <span class="p">=</span> <span class="n">ilOffset</span><span class="p">.</span><span class="n">ToString</span><span class="p">(</span><span class="s">&quot;X&quot;</span><span class="p">).</span><span class="n">ToLower</span><span class="p">();</span></div><div class='line' id='LC66'><br/></div><div class='line' id='LC67'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="c1">// Get a Reflector-like ILOffset like &quot;L_018e&quot;</span></div><div class='line' id='LC68'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kt">var</span> <span class="n">sb</span> <span class="p">=</span> <span class="k">new</span> <span class="n">StringBuilder</span><span class="p">(</span><span class="s">&quot;L_&quot;</span><span class="p">);</span></div><div class='line' id='LC69'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="k">if</span><span class="p">(</span><span class="n">ilOffsetHexString</span><span class="p">.</span><span class="n">Length</span> <span class="p">&lt;</span> <span class="m">4</span><span class="p">)</span> <span class="p">{</span></div><div class='line' id='LC70'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="n">sb</span><span class="p">.</span><span class="n">Append</span><span class="p">(</span><span class="k">new</span> <span class="kt">string</span><span class="p">(</span><span class="sc">&#39;0&#39;</span><span class="p">,</span> <span class="m">4</span> <span class="p">-</span> <span class="n">ilOffsetHexString</span><span class="p">.</span><span class="n">Length</span><span class="p">));</span></div><div class='line' id='LC71'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="p">}</span></div><div class='line' id='LC72'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="n">sb</span><span class="p">.</span><span class="n">Append</span><span class="p">(</span><span class="n">ilOffsetHexString</span><span class="p">);</span></div><div class='line' id='LC73'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="k">return</span> <span class="n">sb</span><span class="p">.</span><span class="n">ToString</span><span class="p">();</span></div><div class='line' id='LC74'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="p">}</span></div><div class='line' id='LC75'><br/></div><div class='line' id='LC76'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="k">private</span> <span class="k">static</span> <span class="kt">string</span> <span class="nf">GetMethodParameters</span><span class="p">(</span><span class="n">MethodBase</span> <span class="n">method</span><span class="p">)</span> <span class="p">{</span></div><div class='line' id='LC77'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="n">Debug</span><span class="p">.</span><span class="n">Assert</span><span class="p">(</span><span class="n">method</span> <span class="p">!=</span> <span class="k">null</span><span class="p">);</span></div><div class='line' id='LC78'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kt">var</span> <span class="n">parameters</span> <span class="p">=</span> <span class="n">method</span><span class="p">.</span><span class="n">GetParameters</span><span class="p">();</span></div><div class='line' id='LC79'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kt">var</span> <span class="n">length</span> <span class="p">=</span> <span class="n">parameters</span><span class="p">.</span><span class="n">Length</span><span class="p">;</span></div><div class='line' id='LC80'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kt">var</span> <span class="n">sb</span> <span class="p">=</span> <span class="k">new</span> <span class="n">StringBuilder</span><span class="p">();</span></div><div class='line' id='LC81'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="k">for</span><span class="p">(</span><span class="kt">var</span> <span class="n">i</span><span class="p">=</span><span class="m">0</span><span class="p">;</span> <span class="n">i</span><span class="p">&lt;</span> <span class="n">length</span><span class="p">;</span> <span class="n">i</span><span class="p">++)</span> <span class="p">{</span></div><div class='line' id='LC82'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kt">var</span> <span class="n">parameter</span> <span class="p">=</span> <span class="n">parameters</span><span class="p">[</span><span class="n">i</span><span class="p">];</span></div><div class='line' id='LC83'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="n">sb</span><span class="p">.</span><span class="n">Append</span><span class="p">(</span><span class="n">parameter</span><span class="p">.</span><span class="n">ParameterType</span><span class="p">.</span><span class="n">Name</span><span class="p">);</span></div><div class='line' id='LC84'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="n">sb</span><span class="p">.</span><span class="n">Append</span><span class="p">(</span><span class="s">&quot; &quot;</span><span class="p">);</span></div><div class='line' id='LC85'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="n">sb</span><span class="p">.</span><span class="n">Append</span><span class="p">(</span><span class="n">parameter</span><span class="p">.</span><span class="n">Name</span><span class="p">);</span></div><div class='line' id='LC86'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="k">if</span><span class="p">(</span><span class="n">i</span> <span class="p">&lt;</span> <span class="n">length</span> <span class="p">-</span><span class="m">1</span><span class="p">)</span> <span class="p">{</span></div><div class='line' id='LC87'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="n">sb</span><span class="p">.</span><span class="n">Append</span><span class="p">(</span><span class="s">&quot;, &quot;</span><span class="p">);</span></div><div class='line' id='LC88'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="p">}</span></div><div class='line' id='LC89'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="p">}</span></div><div class='line' id='LC90'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="k">return</span> <span class="n">sb</span><span class="p">.</span><span class="n">ToString</span><span class="p">();</span></div><div class='line' id='LC91'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="p">}</span></div><div class='line' id='LC92'><span class="cp">#endregion FormatUnlocalizedStackTraceWithILOffset()</span></div><div class='line' id='LC93'><br/></div><div class='line' id='LC94'><br/></div><div class='line' id='LC95'><br/></div><div class='line' id='LC96'><span class="cp">#region FormatUnlocalizedStackTraceFromString()</span></div><div class='line' id='LC97'><br/></div><div class='line' id='LC98'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="k">internal</span> <span class="k">const</span> <span class="kt">string</span> <span class="n">EMPTY_STACK_TRACE</span> <span class="p">=</span> <span class="s">&quot;Empty StackTrace&quot;</span><span class="p">;</span></div><div class='line' id='LC99'><br/></div><div class='line' id='LC100'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="c1">//</span></div><div class='line' id='LC101'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="c1">// OldVersion, still used in Debug mode to get the Line number</span></div><div class='line' id='LC102'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="c1">//             and used in case FormatUnlocalizedStackTraceWithILOffset() has a problem!</span></div><div class='line' id='LC103'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="c1">//</span></div><div class='line' id='LC104'><span class="cp">#if DEBUG</span></div><div class='line' id='LC105'><span class="na">      [IsNotDeadCode]</span> <span class="c1">// Coz used by tests and release version!!!</span></div><div class='line' id='LC106'><span class="cp">#endif</span></div><div class='line' id='LC107'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="c1">// StackTrace lines are prefixed with &quot;  at &quot;  or &quot;  à &quot; or &quot;  в &quot; or &quot;  場所 &quot; that we need to remove</span></div><div class='line' id='LC108'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="k">internal</span> <span class="k">static</span> <span class="kt">string</span> <span class="nf">FormatUnlocalizedStackTraceFromString</span><span class="p">(</span><span class="kt">string</span> <span class="n">stackTraceIn</span><span class="p">)</span> <span class="p">{</span></div><div class='line' id='LC109'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="k">if</span><span class="p">(</span><span class="n">stackTraceIn</span><span class="p">.</span><span class="n">IsNullOrEmpty</span><span class="p">())</span> <span class="p">{</span></div><div class='line' id='LC110'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="k">return</span> <span class="n">EMPTY_STACK_TRACE</span><span class="p">;</span></div><div class='line' id='LC111'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="p">}</span></div><div class='line' id='LC112'><br/></div><div class='line' id='LC113'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kt">var</span> <span class="n">lines</span> <span class="p">=</span> <span class="n">stackTraceIn</span><span class="p">.</span><span class="n">Split</span><span class="p">(</span><span class="k">new</span> <span class="kt">char</span><span class="p">[]</span> <span class="p">{</span><span class="sc">&#39;\r&#39;</span><span class="p">});</span></div><div class='line' id='LC114'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="n">Debug</span><span class="p">.</span><span class="n">Assert</span><span class="p">(</span><span class="n">lines</span> <span class="p">!=</span> <span class="k">null</span><span class="p">);</span></div><div class='line' id='LC115'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="n">Debug</span><span class="p">.</span><span class="n">Assert</span><span class="p">(</span><span class="n">lines</span><span class="p">.</span><span class="n">Length</span> <span class="p">&gt;=</span> <span class="m">1</span><span class="p">);</span></div><div class='line' id='LC116'><br/></div><div class='line' id='LC117'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kt">var</span> <span class="n">sb</span> <span class="p">=</span> <span class="k">new</span> <span class="n">StringBuilder</span><span class="p">();</span></div><div class='line' id='LC118'><br/></div><div class='line' id='LC119'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="k">for</span> <span class="p">(</span><span class="kt">var</span> <span class="n">i</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span> <span class="n">i</span> <span class="p">&lt;</span> <span class="n">lines</span><span class="p">.</span><span class="n">Length</span><span class="p">;</span> <span class="n">i</span><span class="p">++</span> <span class="p">)</span> <span class="p">{</span></div><div class='line' id='LC120'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kt">var</span> <span class="n">unlocalizedLine</span> <span class="p">=</span> <span class="n">UnlocalizeLine</span><span class="p">(</span><span class="n">lines</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span></div><div class='line' id='LC121'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="p">&gt;</span> <span class="m">0</span><span class="p">)</span> <span class="p">{</span> <span class="n">sb</span><span class="p">.</span><span class="n">Append</span><span class="p">(</span><span class="s">&quot;\r\n&quot;</span><span class="p">);</span> <span class="p">}</span></div><div class='line' id='LC122'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="n">sb</span><span class="p">.</span><span class="n">Append</span><span class="p">(</span><span class="n">unlocalizedLine</span><span class="p">);</span></div><div class='line' id='LC123'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="p">}</span></div><div class='line' id='LC124'><br/></div><div class='line' id='LC125'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="k">return</span> <span class="n">sb</span><span class="p">.</span><span class="n">ToString</span><span class="p">();</span></div><div class='line' id='LC126'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="p">}</span></div><div class='line' id='LC127'><br/></div><div class='line' id='LC128'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="k">private</span> <span class="k">static</span> <span class="kt">object</span> <span class="nf">UnlocalizeLine</span><span class="p">(</span><span class="kt">string</span> <span class="n">lineIn</span><span class="p">)</span> <span class="p">{</span></div><div class='line' id='LC129'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="n">Debug</span><span class="p">.</span><span class="n">Assert</span><span class="p">(!</span><span class="n">lineIn</span><span class="p">.</span><span class="n">IsNullOrEmpty</span><span class="p">());</span></div><div class='line' id='LC130'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="n">lineIn</span> <span class="p">=</span> <span class="n">lineIn</span><span class="p">.</span><span class="n">Replace</span><span class="p">(</span><span class="s">&quot;\n&quot;</span><span class="p">,</span> <span class="s">&quot;&quot;</span><span class="p">);</span> <span class="c1">// Eventually discard \n at the beginning</span></div><div class='line' id='LC131'><br/></div><div class='line' id='LC132'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kt">int</span> <span class="n">indexFirstNonWhiteSpace</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span></div><div class='line' id='LC133'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="k">for</span> <span class="p">(</span><span class="n">indexFirstNonWhiteSpace</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span> <span class="n">indexFirstNonWhiteSpace</span> <span class="p">&lt;</span> <span class="n">lineIn</span><span class="p">.</span><span class="n">Length</span><span class="p">;</span> <span class="n">indexFirstNonWhiteSpace</span><span class="p">++)</span> <span class="p">{</span></div><div class='line' id='LC134'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="k">if</span> <span class="p">(</span><span class="n">lineIn</span><span class="p">[</span><span class="n">indexFirstNonWhiteSpace</span><span class="p">]</span> <span class="p">!=</span> <span class="sc">&#39; &#39;</span><span class="p">)</span> <span class="p">{</span> <span class="k">break</span><span class="p">;</span> <span class="p">}</span></div><div class='line' id='LC135'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="p">}</span></div><div class='line' id='LC136'><br/></div><div class='line' id='LC137'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="c1">// lineIn is like</span></div><div class='line' id='LC138'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="c1">// &#39;\n&#39; &#39;white&#39; &#39;white&#39; &#39;at&#39; &#39;white&#39; &quot;xxxx</span></div><div class='line' id='LC139'><br/></div><div class='line' id='LC140'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="c1">// The idea is to get rid of the localizable &#39;at&#39; and to transform it in</span></div><div class='line' id='LC141'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="c1">// &#39;white&#39; &quot;xxxx</span></div><div class='line' id='LC142'><br/></div><div class='line' id='LC143'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kt">var</span> <span class="n">indexOfSecondSpace</span> <span class="p">=</span> <span class="n">lineIn</span><span class="p">.</span><span class="n">IndexOf</span><span class="p">(</span><span class="sc">&#39; &#39;</span><span class="p">,</span> <span class="n">indexFirstNonWhiteSpace</span><span class="p">);</span></div><div class='line' id='LC144'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="k">if</span> <span class="p">(</span><span class="n">indexOfSecondSpace</span> <span class="p">==</span> <span class="p">-</span><span class="m">1</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="n">lineIn</span><span class="p">;</span>  <span class="p">}</span></div><div class='line' id='LC145'><br/></div><div class='line' id='LC146'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kt">var</span> <span class="n">lineOut</span> <span class="p">=</span> <span class="n">lineIn</span><span class="p">.</span><span class="n">Substring</span><span class="p">(</span><span class="n">indexOfSecondSpace</span><span class="p">,</span> <span class="n">lineIn</span><span class="p">.</span><span class="n">Length</span> <span class="p">-</span> <span class="n">indexOfSecondSpace</span><span class="p">);</span></div><div class='line' id='LC147'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="k">return</span> <span class="n">lineOut</span><span class="p">;</span></div><div class='line' id='LC148'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="p">}</span></div><div class='line' id='LC149'><span class="cp">#endregion FormatUnlocalizedStackTraceFromString()</span></div><div class='line' id='LC150'><br/></div><div class='line' id='LC151'>&nbsp;&nbsp;&nbsp;<span class="p">}</span></div><div class='line' id='LC152'><span class="p">}</span></div><div class='line' id='LC153'><br/></div></pre></div>
          </div>

          <div class="gist-meta">
            <a href="https://gist.github.com/raw/3003999/e447a8f8947bad4d7137992042974c9ae7306272/gistfile1.cs" style="float:right;">view raw</a>
            <a href="https://gist.github.com/3003999#file_gistfile1.cs" style="float:right;margin-right:10px;color:#666">gistfile1.cs</a>
            <a href="https://gist.github.com/3003999">This Gist</a> brought to you by <a href="http://github.com">GitHub</a>.
          </div>
        </div>
</div>
</noscript>
<p>&#8230;and the test code that covers 100% <em>StackTraceHelper</em>:</p>
<script src="http://gist.github.com/3004007.js"></script><noscript><link rel="stylesheet" href="https://gist.github.com/stylesheets/gist/embed.css"><div id="gist-3004007" class="gist">
    
        <div class="gist-file">
          <div class="gist-data gist-syntax">
              <div class="highlight"><pre><div class='line' id='LC1'><br/></div><div class='line' id='LC2'><span class="k">using</span> <span class="nn">System</span><span class="p">;</span></div><div class='line' id='LC3'><span class="k">using</span> <span class="nn">NUnit.Framework</span><span class="p">;</span></div><div class='line' id='LC4'><br/></div><div class='line' id='LC5'><span class="k">namespace</span> <span class="nn">NDepend.Product.ErrorHandling</span> <span class="p">{</span></div><div class='line' id='LC6'><br/></div><div class='line' id='LC7'><span class="na">   [TestFixture]</span></div><div class='line' id='LC8'>&nbsp;&nbsp;&nbsp;<span class="k">public</span> <span class="k">class</span> <span class="nc">Test_StackTraceHelper</span> <span class="p">{</span></div><div class='line' id='LC9'><br/></div><div class='line' id='LC10'><br/></div><div class='line' id='LC11'><br/></div><div class='line' id='LC12'><span class="na">      [Test]</span></div><div class='line' id='LC13'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="k">public</span> <span class="k">void</span> <span class="nf">Test_FormatUnlocalizedStackTraceWithILOffset_EMPTY_STACK_TRACE</span><span class="p">()</span> <span class="p">{</span></div><div class='line' id='LC14'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kt">var</span> <span class="n">ex</span> <span class="p">=</span> <span class="k">new</span> <span class="n">Exception</span><span class="p">();</span></div><div class='line' id='LC15'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kt">var</span> <span class="n">str</span> <span class="p">=</span> <span class="n">StackTraceHelper</span><span class="p">.</span><span class="n">FormatUnlocalizedStackTraceWithILOffset</span><span class="p">(</span><span class="n">ex</span><span class="p">);</span></div><div class='line' id='LC16'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="n">Assert</span><span class="p">.</span><span class="n">IsTrue</span><span class="p">(</span><span class="n">str</span> <span class="p">==</span> <span class="n">StackTraceHelper</span><span class="p">.</span><span class="n">EMPTY_STACK_TRACE</span><span class="p">);</span></div><div class='line' id='LC17'><br/></div><div class='line' id='LC18'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="n">str</span> <span class="p">=</span> <span class="n">StackTraceHelper</span><span class="p">.</span><span class="n">FormatStackTrace</span><span class="p">(</span><span class="n">ex</span><span class="p">);</span></div><div class='line' id='LC19'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="n">Assert</span><span class="p">.</span><span class="n">IsTrue</span><span class="p">(</span><span class="n">str</span> <span class="p">==</span> <span class="n">StackTraceHelper</span><span class="p">.</span><span class="n">EMPTY_STACK_TRACE</span><span class="p">);</span></div><div class='line' id='LC20'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="p">}</span></div><div class='line' id='LC21'><br/></div><div class='line' id='LC22'><br/></div><div class='line' id='LC23'><br/></div><div class='line' id='LC24'><span class="na">      [Test]</span></div><div class='line' id='LC25'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="k">public</span> <span class="k">void</span> <span class="nf">Test_FormatUnlocalizedStackTraceWithILOffset_RealEx</span><span class="p">()</span> <span class="p">{</span></div><div class='line' id='LC26'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="n">NullReferenceException</span> <span class="n">nullReferenceException</span> <span class="p">=</span> <span class="k">null</span><span class="p">;</span></div><div class='line' id='LC27'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="k">try</span> <span class="p">{</span></div><div class='line' id='LC28'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kt">string</span> <span class="n">s</span> <span class="p">=</span> <span class="k">null</span><span class="p">;</span></div><div class='line' id='LC29'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kt">var</span> <span class="n">i</span> <span class="p">=</span> <span class="n">s</span><span class="p">.</span><span class="n">Length</span><span class="p">;</span></div><div class='line' id='LC30'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="p">}</span></div><div class='line' id='LC31'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="k">catch</span> <span class="p">(</span><span class="n">NullReferenceException</span> <span class="n">ex</span><span class="p">)</span> <span class="p">{</span></div><div class='line' id='LC32'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="n">nullReferenceException</span> <span class="p">=</span> <span class="n">ex</span><span class="p">;</span></div><div class='line' id='LC33'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="p">}</span></div><div class='line' id='LC34'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="n">Assert</span><span class="p">.</span><span class="n">IsNotNull</span><span class="p">(</span><span class="n">nullReferenceException</span><span class="p">);</span></div><div class='line' id='LC35'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kt">var</span> <span class="n">str</span> <span class="p">=</span> <span class="n">StackTraceHelper</span><span class="p">.</span><span class="n">FormatUnlocalizedStackTraceWithILOffset</span><span class="p">(</span><span class="n">nullReferenceException</span><span class="p">);</span></div><div class='line' id='LC36'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="c1">// Don&#39;t put the IL offset coz it can change once instrument with coverage tool!</span></div><div class='line' id='LC37'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="n">Assert</span><span class="p">.</span><span class="n">IsTrue</span><span class="p">(</span><span class="n">str</span><span class="p">.</span><span class="n">StartsWith</span><span class="p">(</span><span class="s">@&quot;  NDepend.Product.ErrorHandling.Test_StackTraceHelper.Test_FormatUnlocalizedStackTraceWithILOffset_RealEx()   L_00&quot;</span><span class="p">));</span></div><div class='line' id='LC38'><br/></div><div class='line' id='LC39'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kt">var</span> <span class="n">str1</span> <span class="p">=</span> <span class="n">StackTraceHelper</span><span class="p">.</span><span class="n">FormatStackTrace</span><span class="p">(</span><span class="n">nullReferenceException</span><span class="p">);</span></div><div class='line' id='LC40'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="n">Assert</span><span class="p">.</span><span class="n">IsTrue</span><span class="p">(</span><span class="n">str1</span> <span class="p">!=</span> <span class="n">str</span><span class="p">);</span></div><div class='line' id='LC41'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="n">Assert</span><span class="p">.</span><span class="n">IsTrue</span><span class="p">(</span><span class="n">str1</span><span class="p">.</span><span class="n">StartsWith</span><span class="p">(</span><span class="s">&quot; NDepend.Product.ErrorHandling.Test_StackTraceHelper.Test_FormatUnlocalizedStackTraceWithILOffset_RealEx()&quot;</span><span class="p">));</span></div><div class='line' id='LC42'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="p">}</span></div><div class='line' id='LC43'><br/></div><div class='line' id='LC44'><br/></div><div class='line' id='LC45'><span class="na">      [Test]</span></div><div class='line' id='LC46'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="k">public</span> <span class="k">void</span> <span class="nf">Test_FormatUnlocalizedStackTraceWithILOffset_RealExInAnonymouseMethod</span><span class="p">()</span> <span class="p">{</span></div><div class='line' id='LC47'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="n">NullReferenceException</span> <span class="n">nullReferenceException</span> <span class="p">=</span> <span class="k">null</span><span class="p">;</span></div><div class='line' id='LC48'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="k">try</span> <span class="p">{</span></div><div class='line' id='LC49'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="c1">// Note that we test here with delegate with two parameters!</span></div><div class='line' id='LC50'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kt">var</span> <span class="n">action</span> <span class="p">=</span> <span class="k">new</span> <span class="n">Action</span><span class="p">&lt;</span><span class="kt">int</span><span class="p">,</span><span class="kt">string</span><span class="p">&gt;(</span><span class="k">delegate</span><span class="p">(</span><span class="kt">int</span> <span class="n">i1</span><span class="p">,</span> <span class="kt">string</span> <span class="n">s2</span><span class="p">)</span> <span class="p">{</span></div><div class='line' id='LC51'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kt">string</span> <span class="n">s</span> <span class="p">=</span> <span class="k">null</span><span class="p">;</span></div><div class='line' id='LC52'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kt">var</span> <span class="n">i</span> <span class="p">=</span> <span class="n">s</span><span class="p">.</span><span class="n">Length</span><span class="p">;</span></div><div class='line' id='LC53'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="p">});</span></div><div class='line' id='LC54'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="n">action</span><span class="p">.</span><span class="n">Invoke</span><span class="p">(</span><span class="m">1</span><span class="p">,</span><span class="s">&quot;&quot;</span><span class="p">);</span></div><div class='line' id='LC55'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="p">}</span></div><div class='line' id='LC56'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="k">catch</span> <span class="p">(</span><span class="n">NullReferenceException</span> <span class="n">ex</span><span class="p">)</span> <span class="p">{</span></div><div class='line' id='LC57'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="n">nullReferenceException</span> <span class="p">=</span> <span class="n">ex</span><span class="p">;</span></div><div class='line' id='LC58'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="p">}</span></div><div class='line' id='LC59'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="n">Assert</span><span class="p">.</span><span class="n">IsNotNull</span><span class="p">(</span><span class="n">nullReferenceException</span><span class="p">);</span></div><div class='line' id='LC60'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kt">var</span> <span class="n">str</span> <span class="p">=</span> <span class="n">StackTraceHelper</span><span class="p">.</span><span class="n">FormatUnlocalizedStackTraceWithILOffset</span><span class="p">(</span><span class="n">nullReferenceException</span><span class="p">);</span></div><div class='line' id='LC61'><br/></div><div class='line' id='LC62'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="c1">// Don&#39;t put the IL offset coz it can change once instrument with coverage tool!</span></div><div class='line' id='LC63'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="n">Assert</span><span class="p">.</span><span class="n">IsTrue</span><span class="p">(</span><span class="n">str</span><span class="p">.</span><span class="n">StartsWith</span><span class="p">(</span><span class="s">@&quot;  NDepend.Product.ErrorHandling.Test_StackTraceHelper.&lt;Test_FormatUnlocalizedStackTraceWithILOffset_RealExInAnonymouseMethod&gt;b__0(Int32 i1, String s2)   L_00&quot;</span><span class="p">));</span></div><div class='line' id='LC64'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="n">Assert</span><span class="p">.</span><span class="n">IsTrue</span><span class="p">(</span><span class="n">str</span><span class="p">.</span><span class="n">Contains</span><span class="p">(</span><span class="s">@&quot;  NDepend.Product.ErrorHandling.Test_StackTraceHelper.Test_FormatUnlocalizedStackTraceWithILOffset_RealExInAnonymouseMethod()   L_00&quot;</span><span class="p">));</span> </div><div class='line' id='LC65'>&nbsp;&nbsp;<span class="p">;</span></div><div class='line' id='LC66'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="p">}</span></div><div class='line' id='LC67'><br/></div><div class='line' id='LC68'><br/></div><div class='line' id='LC69'><span class="na">      [Test]</span></div><div class='line' id='LC70'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="k">public</span> <span class="k">void</span> <span class="nf">Test1_FormatUnlocalizedStackTrace</span><span class="p">()</span> <span class="p">{</span></div><div class='line' id='LC71'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="k">const</span> <span class="kt">string</span> <span class="n">strIn</span> <span class="p">=</span> <span class="s">@&quot;  在 afs.h()</span></div><div class='line' id='LC72'><span class="s">  在 afs.c()}&quot;</span><span class="p">;</span></div><div class='line' id='LC73'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="k">const</span> <span class="kt">string</span> <span class="n">strOut</span> <span class="p">=</span> <span class="s">@&quot; afs.h()</span></div><div class='line' id='LC74'><span class="s"> afs.c()}&quot;</span><span class="p">;</span></div><div class='line' id='LC75'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="n">Assert</span><span class="p">.</span><span class="n">IsTrue</span><span class="p">(</span><span class="n">StackTraceHelper</span><span class="p">.</span><span class="n">FormatUnlocalizedStackTraceFromString</span><span class="p">(</span><span class="n">strIn</span><span class="p">)</span> <span class="p">==</span> <span class="n">strOut</span><span class="p">);</span></div><div class='line' id='LC76'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="p">}</span></div><div class='line' id='LC77'><br/></div><div class='line' id='LC78'><span class="na">      [Test]</span></div><div class='line' id='LC79'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="k">public</span> <span class="k">void</span> <span class="nf">Test2_FormatUnlocalizedStackTrace</span><span class="p">()</span> <span class="p">{</span></div><div class='line' id='LC80'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="n">Assert</span><span class="p">.</span><span class="n">IsTrue</span><span class="p">(</span><span class="n">StackTraceHelper</span><span class="p">.</span><span class="n">FormatUnlocalizedStackTraceFromString</span><span class="p">(</span></div><div class='line' id='LC81'><span class="s">@&quot;  в qz.a(Window A_0, Window A_1)}&quot;</span><span class="p">)</span> <span class="p">==</span></div><div class='line' id='LC82'><span class="n">StackTraceHelper</span><span class="p">.</span><span class="n">FormatUnlocalizedStackTraceFromString</span><span class="p">(</span></div><div class='line' id='LC83'><span class="s">@&quot;  in qz.a(Window A_0, Window A_1)}&quot;</span><span class="p">));</span></div><div class='line' id='LC84'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="p">}</span></div><div class='line' id='LC85'><br/></div><div class='line' id='LC86'><span class="na">      [Test]</span></div><div class='line' id='LC87'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="k">public</span> <span class="k">void</span> <span class="nf">Test3_FormatUnlocalizedStackTrace</span><span class="p">()</span> <span class="p">{</span></div><div class='line' id='LC88'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="n">Assert</span><span class="p">.</span><span class="n">IsTrue</span><span class="p">(</span><span class="n">StackTraceHelper</span><span class="p">.</span><span class="n">FormatUnlocalizedStackTraceFromString</span><span class="p">(</span></div><div class='line' id='LC89'><span class="s">@&quot;  в qz.a(Window A_0, Window A_1)}&quot;</span><span class="p">)</span> <span class="p">==</span></div><div class='line' id='LC90'><span class="s">@&quot; qz.a(Window A_0, Window A_1)}&quot;</span><span class="p">);</span></div><div class='line' id='LC91'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="p">}</span></div><div class='line' id='LC92'><br/></div><div class='line' id='LC93'><br/></div><div class='line' id='LC94'><span class="na">      [Test]</span></div><div class='line' id='LC95'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="k">public</span> <span class="k">void</span> <span class="nf">Test4_FormatUnlocalizedStackTrace</span><span class="p">()</span> <span class="p">{</span></div><div class='line' id='LC96'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="k">try</span> <span class="p">{</span></div><div class='line' id='LC97'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="k">throw</span> <span class="k">new</span> <span class="nf">Exception</span><span class="p">(</span><span class="s">&quot;hello&quot;</span><span class="p">);</span></div><div class='line' id='LC98'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="p">}</span> <span class="k">catch</span><span class="p">(</span><span class="n">Exception</span> <span class="n">e</span><span class="p">)</span> <span class="p">{</span></div><div class='line' id='LC99'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kt">var</span> <span class="n">unlocalizedStackTrace</span> <span class="p">=</span> <span class="n">StackTraceHelper</span><span class="p">.</span><span class="n">FormatUnlocalizedStackTraceFromString</span><span class="p">(</span><span class="n">e</span><span class="p">.</span><span class="n">StackTrace</span><span class="p">);</span></div><div class='line' id='LC100'><br/></div><div class='line' id='LC101'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="n">Assert</span><span class="p">.</span><span class="n">IsTrue</span><span class="p">(</span><span class="n">unlocalizedStackTrace</span><span class="p">.</span><span class="n">IndexOf</span><span class="p">(</span></div><div class='line' id='LC102'><span class="s">&quot; NDepend.Product.ErrorHandling.Test_StackTraceHelper.Test4_FormatUnlocalizedStackTrace()&quot;</span><span class="p">)</span> <span class="p">==</span> <span class="m">0</span><span class="p">);</span>            </div><div class='line' id='LC103'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="p">}</span></div><div class='line' id='LC104'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="p">}</span></div><div class='line' id='LC105'><br/></div><div class='line' id='LC106'><br/></div><div class='line' id='LC107'><span class="na">      [Test]</span></div><div class='line' id='LC108'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="k">public</span> <span class="k">void</span> <span class="nf">Test5_Faultolerant</span><span class="p">()</span> <span class="p">{</span></div><div class='line' id='LC109'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="n">Assert</span><span class="p">.</span><span class="n">IsTrue</span><span class="p">(</span><span class="n">StackTraceHelper</span><span class="p">.</span><span class="n">FormatUnlocalizedStackTraceFromString</span><span class="p">(</span></div><div class='line' id='LC110'><span class="s">@&quot;xxx</span></div><div class='line' id='LC111'><span class="s">xxx&quot;</span><span class="p">)</span> <span class="p">==</span></div><div class='line' id='LC112'><span class="s">@&quot;xxx</span></div><div class='line' id='LC113'><span class="s">xxx&quot;</span><span class="p">);</span></div><div class='line' id='LC114'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="p">}</span></div><div class='line' id='LC115'><br/></div><div class='line' id='LC116'><span class="na">      [Test]</span></div><div class='line' id='LC117'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="k">public</span> <span class="k">void</span> <span class="nf">Test6_Faultolerant</span><span class="p">()</span> <span class="p">{</span></div><div class='line' id='LC118'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="n">Assert</span><span class="p">.</span><span class="n">IsTrue</span><span class="p">(</span><span class="n">StackTraceHelper</span><span class="p">.</span><span class="n">FormatUnlocalizedStackTraceFromString</span><span class="p">(</span></div><div class='line' id='LC119'><span class="s">@&quot;xxx&quot;</span><span class="p">)</span> <span class="p">==</span></div><div class='line' id='LC120'><span class="s">@&quot;xxx&quot;</span><span class="p">);</span></div><div class='line' id='LC121'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="p">}</span></div><div class='line' id='LC122'><br/></div><div class='line' id='LC123'><span class="na">      [Test]</span></div><div class='line' id='LC124'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="k">public</span> <span class="k">void</span> <span class="nf">Test7_Faultolerant</span><span class="p">()</span> <span class="p">{</span></div><div class='line' id='LC125'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="n">Assert</span><span class="p">.</span><span class="n">IsTrue</span><span class="p">(</span><span class="n">StackTraceHelper</span><span class="p">.</span><span class="n">FormatUnlocalizedStackTraceFromString</span><span class="p">(</span></div><div class='line' id='LC126'><span class="s">@&quot;  xxx&quot;</span><span class="p">)</span> <span class="p">==</span></div><div class='line' id='LC127'><span class="s">@&quot;  xxx&quot;</span><span class="p">);</span></div><div class='line' id='LC128'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="p">}</span></div><div class='line' id='LC129'><br/></div><div class='line' id='LC130'><span class="na">      [Test]</span></div><div class='line' id='LC131'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="k">public</span> <span class="k">void</span> <span class="nf">Test8_Faultolerant</span><span class="p">()</span> <span class="p">{</span></div><div class='line' id='LC132'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="n">Assert</span><span class="p">.</span><span class="n">IsTrue</span><span class="p">(</span><span class="n">StackTraceHelper</span><span class="p">.</span><span class="n">FormatUnlocalizedStackTraceFromString</span><span class="p">(</span></div><div class='line' id='LC133'><span class="s">@&quot; xxx</span></div><div class='line' id='LC134'><span class="s"> xxx&quot;</span><span class="p">)</span> <span class="p">==</span></div><div class='line' id='LC135'><span class="s">@&quot; xxx</span></div><div class='line' id='LC136'><span class="s"> xxx&quot;</span><span class="p">);</span></div><div class='line' id='LC137'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="p">}</span></div><div class='line' id='LC138'>&nbsp;&nbsp;&nbsp;<span class="p">}</span></div><div class='line' id='LC139'><span class="p">}</span></div><div class='line' id='LC140'><br/></div></pre></div>
          </div>

          <div class="gist-meta">
            <a href="https://gist.github.com/raw/3004007/d699c492860f4b0c12e9ac5c9426675f57571c75/gistfile1.cs" style="float:right;">view raw</a>
            <a href="https://gist.github.com/3004007#file_gistfile1.cs" style="float:right;margin-right:10px;color:#666">gistfile1.cs</a>
            <a href="https://gist.github.com/3004007">This Gist</a> brought to you by <a href="http://github.com">GitHub</a>.
          </div>
        </div>
</div>
</noscript>
]]></content:encoded>
			<wfw:commentRss>http://codebetter.com/patricksmacchia/2012/06/27/include-il-offset-into-production-exception-stacktrace/feed/</wfw:commentRss>
		<slash:comments>3</slash:comments>
		</item>
		<item>
		<title>An Original Algorithm to Find .NET Code Duplicate</title>
		<link>http://codebetter.com/patricksmacchia/2012/06/12/an-original-algorithm-to-find-net-code-duplicate/</link>
		<comments>http://codebetter.com/patricksmacchia/2012/06/12/an-original-algorithm-to-find-net-code-duplicate/#comments</comments>
		<pubDate>Tue, 12 Jun 2012 08:34:17 +0000</pubDate>
		<dc:creator>Patrick Smacchia</dc:creator>
				<category><![CDATA[Uncategorized]]></category>

		<guid isPermaLink="false">http://codebetter.com/patricksmacchia/?p=594</guid>
		<description><![CDATA[The upcoming Visual Studio 2012 version comes with tooling to find code duplicate. However, today, I&#8217;d like to talk about another code duplicate tool for .NET code. This tool comes as a NDepend Power-Tool. Power-Tools are a set of open-source&#160;&#8230; <a href="http://codebetter.com/patricksmacchia/2012/06/12/an-original-algorithm-to-find-net-code-duplicate/">Continue&#160;reading&#160;<span class="meta-nav">&#8594;</span></a>]]></description>
			<content:encoded><![CDATA[<p>The upcoming Visual Studio 2012 version comes with tooling to find code duplicate.</p>
<p>However, today, I&#8217;d like to talk about another code duplicate tool for .NET code. This tool comes as a NDepend Power-Tool. Power-Tools are a set of open-source tools based on <a href="http://www.ndepend.com/API/webframe.html" target="_blank">NDepend.API</a>. The source code of Power-Tools can be found in <em>$NDependInstallPath$\ NDepend.PowerTools.SourceCode\ NDepend.PowerTools.sln.</em></p>
<p>The algorithm underlying this code duplicate Power-Tool is simple, yet powerful in practice. It consists in <strong>defining sets of methods that are using the same members, i.e calling the same methods, reading the same fields, writing the same fields</strong>. We call these sets, <em>suspect-sets</em>. Suspect-sets are sorted by the number of same members used.</p>
<p>Let&#8217;s run this Power-Tool on the NUnit v2.6.0 code base. The screenshot below shows the 3 steps of the algorithm executed, and the first suspect-set. This first suspect-set is, <em>as often from my testing experience</em>, the entry points of the application. Very often an application has several entry points that does <em>almost</em> the same initialization things. Sometime it is pure duplicate, sometime it is slightly changed. Most of the time this initialization code can be factorized in one or several parametrized method.</p>
<p>Notice the option <strong>o</strong> for <strong>Open callers methods decls</strong>. The declarations are opened in Visual Studio actually.</p>
<p><a href="http://codebetter.com/patricksmacchia/files/2012/06/NUnitDuplicate1.png"><img class="alignnone size-full wp-image-595" src="http://codebetter.com/patricksmacchia/files/2012/06/NUnitDuplicate1.png" alt="" width="597" height="537" /></a></p>
<p>The second suspect-set is the following one&#8230;</p>
<p><a href="http://codebetter.com/patricksmacchia/files/2012/06/NUnitDuplicate2.png"><img class="alignnone size-full wp-image-596" src="http://codebetter.com/patricksmacchia/files/2012/06/NUnitDuplicate2.png" alt="" width="597" height="378" /></a></p>
<p>&#8230;<strong>bingo</strong>, we have an exact code duplicate!</p>
<p><a href="http://codebetter.com/patricksmacchia/files/2012/06/NUnitDuplicate31.png"><img class="alignnone size-full wp-image-598" src="http://codebetter.com/patricksmacchia/files/2012/06/NUnitDuplicate31.png" alt="" width="591" height="909" /></a></p>
<p>The third suspect-set is the following one&#8230;</p>
<p><a href="http://codebetter.com/patricksmacchia/files/2012/06/NUnitDuplicate4.png"><img class="alignnone size-full wp-image-599" src="http://codebetter.com/patricksmacchia/files/2012/06/NUnitDuplicate4.png" alt="" width="598" height="393" /></a></p>
<p>&#8230;by looking at the code below, this suspect-set can eventually be considered as a false positive. Personally, I still consider such code as code duplicated. These two methods implement a unique layout algorithm, that could be parametrized. So here I&#8217;d vote for a factorization.</p>
<p><a href="http://codebetter.com/patricksmacchia/files/2012/06/NUnitDuplicate5.png"><img class="alignnone size-full wp-image-600" src="http://codebetter.com/patricksmacchia/files/2012/06/NUnitDuplicate5.png" alt="" width="600" height="635" /></a></p>
<p>I could continue on and on, but I invite you to <a href="http://www.ndepend.com/NDependDownload.aspx" target="_blank">download the 14-days full featured evaluation of NDepend</a> to see what this algorithm will report on your own code.</p>
<p>Hopefully duplicate results found by this algorithm are pretty relevant. Its main advantage over others algorithms is that it is not disturbed by dirty <em>copy-paste</em> where the pasted code is then sightly modified. Another advantage is that this algorithm can be run on IL code only, source code is not required. Notice that what this current blog post doesn&#8217;t show, is that a suspect-set can have more than 2 suspect methods.</p>
<p>On the <em>cons</em> side, sometime a suspect-set can be <em>humanly</em> considered as a <em>false positive.</em> At least it is almost always possible to refactor found duplicates to factorize them into one or several parametrized methods (as explained for the 2 layout methods). The fact is that <strong>two or several methods don&#8217;t use the same set of members by coincidence</strong>.</p>
<p>Also this algorithm is very fast to run, from 10 to 100 times faster than the VS2012 one. Concretely it takes few seconds to be executed on a real-world large code base. This speed is the consequence of the fact that NDepend.API is optimized to browse dependencies very quickly.</p>
<p>Concerning the algorithm itself, it is open-source so if you are interested in browsing and tweaking it you can. This open-source + NDepend.API form makes it particularly suited to be integrated into a CI process.</p>
<p>The algorithm consists in 3 steps:</p>
<ol>
<li>Investigate each method (including third-party ones) to see if their callers could be considered as suspect (methods called very often like the ones from types in <em>System.Collection.Generics</em> or <em>System.Xml</em> are discarded to limit false positive).</li>
<li>Merge suspect sets obtained from step 1).</li>
<li>Sort suspect-sets from a weigh computed on number of members called.</li>
</ol>
<p>Hopefully this algorithm can be optimized further, and your feedback is welcomed. Enjoy!</p>
]]></content:encoded>
			<wfw:commentRss>http://codebetter.com/patricksmacchia/2012/06/12/an-original-algorithm-to-find-net-code-duplicate/feed/</wfw:commentRss>
		<slash:comments>10</slash:comments>
		</item>
		<item>
		<title>LINQ Performance: Some Case Studies</title>
		<link>http://codebetter.com/patricksmacchia/2012/06/05/linq-performance-some-case-studies-2/</link>
		<comments>http://codebetter.com/patricksmacchia/2012/06/05/linq-performance-some-case-studies-2/#comments</comments>
		<pubDate>Tue, 05 Jun 2012 10:48:14 +0000</pubDate>
		<dc:creator>Patrick Smacchia</dc:creator>
				<category><![CDATA[CQLinq]]></category>
		<category><![CDATA[LINQ]]></category>
		<category><![CDATA[Performance]]></category>

		<guid isPermaLink="false">http://codebetter.com/patricksmacchia/?p=572</guid>
		<description><![CDATA[One essential requirement while developing Code Query and Rule through LINQ (CQLinq) has been performance, both performance of query compilation and performance of query execution. The reason is simple: we want hundreds of CQLinq rules to be verified right inside Visual Studio in a&#160;&#8230; <a href="http://codebetter.com/patricksmacchia/2012/06/05/linq-performance-some-case-studies-2/">Continue&#160;reading&#160;<span class="meta-nav">&#8594;</span></a>]]></description>
			<content:encoded><![CDATA[<p>One essential requirement while developing <a href="http://www.ndepend.com/Features.aspx#CQL" target="_blank">Code Query and Rule through LINQ (CQLinq)</a> has been <strong>performance</strong>, both performance of query compilation and performance of query execution. The reason is simple: we want hundreds of CQLinq rules to be verified right inside Visual Studio in a few seconds, to let the developer be quickly informed of problems. Hence, we&#8217;ve targeted and achieved <strong>100 queries compiled/executed per second</strong> against a real-world large code base.</p>
<p>To achieve this goal, a large research effort has been made. In the product itself, a query is compiled and then executed <em>live</em> at edition time. In the screenshot below, we can see the <em>query execution duration measurer</em> at the top right (here 4 millisecond).</p>
<p><a href="http://codebetter.com/patricksmacchia/files/2012/06/CQLinqPerf.png"><img src="http://codebetter.com/patricksmacchia/files/2012/06/CQLinqPerf.png" alt="" width="571" height="755" /></a></p>
<p>This <em>instant measurer</em> has been proven very useful to optimize CQLinq and the 200 default rules. Hopefully we&#8217;ve learnt a lot about LINQ performances. <strong>Several re-usable patterns</strong> are listed in the documentation <a href="http://www.ndepend.com/Doc_CQLinq_Perf.aspx" target="_blank">CQLinq Performance</a> and I&#8217;d like here to digress a bit deeper on these findings.</p>
<h1>HashSet&lt;T&gt;, Dictionary&lt;K,V&gt;, Lookup&lt;K,V&gt; my dear friends</h1>
<p>Often in my past posts, I claimed that hash tables (HashSet&lt;T&gt;, Dictionary&lt;K,V&gt;, Lookup&lt;K,V) are one of the best tool to optimize performances. Of course they played a major role to optimize many code queries. Last year I wrote about <a href="http://codebetter.com/patricksmacchia/2011/06/16/linq-intersect-2-7x-faster-with-hashset/" target="_blank">LINQ Intersect() 2.7x faster with HashSet</a> and in the v4 RTM, the concrete conclusion of this study is the class <a href="http://www.ndepend.com/API/webframe.html?NDepend.API~NDepend.Helpers.ExtensionMethodsSet_members.html" target="_blank">NDepend.Helpers.ExtensionMethodsSet</a> of the <a href="http://www.ndepend.com/API/webframe.html" target="_blank">NDepend.API</a>. For example without the single call to <a href="http://www.ndepend.com/API/webframe.html?NDepend.API~NDepend.Helpers.ExtensionMethodsSet~ToHashSet.html" target="_blank">ToHashSet()</a> the query below would be <strong>200 times slower</strong>! This is because the call to one overload of <a href="http://www.ndepend.com/API/webframe.html?NDepend.API~NDepend.Helpers.ExtensionMethodsSet~Intersect.html" target="_blank">Intersect()</a> is very fast, because it takes account of the fact that one of the collections to intersect is a HashSet&lt;T&gt; with O(1) search:</p>
<script src="http://gist.github.com/2868860.js"></script><noscript><link rel="stylesheet" href="https://gist.github.com/stylesheets/gist/embed.css"><div id="gist-2868860" class="gist">
    

        <div class="gist-file">
          <div class="gist-data gist-syntax">
              <div class="highlight"><pre><div class='line' id='LC1'><span class="c1">// &lt;Name&gt;Callers of refactored methods&lt;/Name&gt;</span></div><div class='line' id='LC2'><span class="n">let</span> <span class="n">refactoredMethods</span> <span class="p">=</span> <span class="n">Application</span><span class="p">.</span><span class="n">Methods</span><span class="p">.</span><span class="n">Where</span><span class="p">(</span><span class="n">m</span> <span class="p">=&gt;</span> <span class="n">m</span><span class="p">.</span><span class="n">CodeWasChanged</span><span class="p">()).</span><span class="n">ToHashSet</span><span class="p">()</span> </div><div class='line' id='LC3'><span class="k">from</span> <span class="n">caller</span> <span class="k">in</span> <span class="n">Application</span><span class="p">.</span><span class="n">Methods</span><span class="p">.</span><span class="n">UsingAny</span><span class="p">(</span><span class="n">refactoredMethods</span><span class="p">)</span></div><div class='line' id='LC4'><span class="n">let</span> <span class="n">refactoredMethodsCalled</span> <span class="p">=</span> <span class="n">caller</span><span class="p">.</span><span class="n">MethodsCalled</span><span class="p">.</span><span class="n">Intersect</span><span class="p">(</span><span class="n">refactoredMethods</span><span class="p">)</span></div><div class='line' id='LC5'><span class="k">where</span> <span class="n">refactoredMethodsCalled</span><span class="p">.</span><span class="n">Count</span><span class="p">()</span> <span class="p">&gt;</span> <span class="m">0</span></div><div class='line' id='LC6'><span class="k">select</span> <span class="k">new</span> <span class="p">{</span> <span class="n">caller</span><span class="p">,</span> <span class="n">refactoredMethodsCalled</span> <span class="p">}</span></div></pre></div>
          </div>

          <div class="gist-meta">
            <a href="https://gist.github.com/raw/2868860/46d995ac7c0e353c8657c8eca7cf7899b2384e6e/gistfile1.cs" style="float:right;">view raw</a>
            <a href="https://gist.github.com/2868860#file_gistfile1.cs" style="float:right;margin-right:10px;color:#666">gistfile1.cs</a>
            <a href="https://gist.github.com/2868860">This Gist</a> brought to you by <a href="http://github.com">GitHub</a>.
          </div>
        </div>
</div>
</noscript>
<p>It is disappointing that these simple, common yet efficient optimizations are not proposed by default by the .NET Fx.</p>
<p>Below is the rule <a href="http://www.ndepend.com/DefaultRules/webframe.html?Q_Do_not_hide_base_class_methods.html" target="_blank">Do not hide base class methods</a> source code. It took us significant effort to make it fast enough for our requirement. Here again the key to high performance has been a hash table, more specifically a <a href="http://msdn.microsoft.com/fr-fr/library/bb460184.aspx" target="_blank">lookup table</a>. Methods are indexed by their names (including their signature) in the lookup table to let us retrieve quickly the set of methods potentially hidden by a method:</p>
<script src="http://gist.github.com/2869036.js"></script><noscript><link rel="stylesheet" href="https://gist.github.com/stylesheets/gist/embed.css"><div id="gist-2869036" class="gist">
    

        <div class="gist-file">
          <div class="gist-data gist-syntax">
              <div class="highlight"><pre><div class='line' id='LC1'><span class="c1">// &lt;Name&gt;Do not hide base class methods&lt;/Name&gt;</span></div><div class='line' id='LC2'><span class="c1">// Prefer override virtual methods</span></div><div class='line' id='LC3'><span class="c1">// More on hiding vs. virtual usefulness here:</span></div><div class='line' id='LC4'><span class="c1">//  http://www.artima.com/intv/nonvirtual.html</span></div><div class='line' id='LC5'><span class="c1">//  http://blogs.msdn.com/b/ericlippert/archive/2008/05/21/method-hiding-apologia.aspx</span></div><div class='line' id='LC6'><br/></div><div class='line' id='LC7'><span class="n">warnif</span> <span class="n">count</span> <span class="p">&gt;</span> <span class="m">0</span></div><div class='line' id='LC8'><br/></div><div class='line' id='LC9'><span class="c1">// Define lookup table indexing methods by their name including parameters signature.</span></div><div class='line' id='LC10'><span class="n">let</span> <span class="n">lookup</span> <span class="p">=</span> <span class="n">Methods</span><span class="p">.</span><span class="n">Where</span><span class="p">(</span><span class="n">m</span> <span class="p">=&gt;</span> <span class="p">!</span><span class="n">m</span><span class="p">.</span><span class="n">IsConstructor</span> <span class="p">&amp;&amp;</span> <span class="p">!</span><span class="n">m</span><span class="p">.</span><span class="n">IsStatic</span> <span class="p">&amp;&amp;</span> <span class="p">!</span><span class="n">m</span><span class="p">.</span><span class="n">IsGeneratedByCompiler</span><span class="p">)</span></div><div class='line' id='LC11'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="p">.</span><span class="n">ToLookup</span><span class="p">(</span><span class="n">m1</span> <span class="p">=&gt;</span> <span class="n">m1</span><span class="p">.</span><span class="n">Name</span><span class="p">)</span></div><div class='line' id='LC12'><br/></div><div class='line' id='LC13'><span class="k">from</span> <span class="n">t</span> <span class="k">in</span> <span class="n">Application</span><span class="p">.</span><span class="n">Types</span></div><div class='line' id='LC14'><span class="k">where</span> <span class="p">!</span><span class="n">t</span><span class="p">.</span><span class="n">IsStatic</span> <span class="p">&amp;&amp;</span> <span class="n">t</span><span class="p">.</span><span class="n">IsClass</span> <span class="p">&amp;&amp;</span></div><div class='line' id='LC15'>&nbsp;&nbsp;&nbsp;<span class="c1">// Discard classes deriving directly from System.Object</span></div><div class='line' id='LC16'>&nbsp;&nbsp;&nbsp;<span class="n">t</span><span class="p">.</span><span class="n">DepthOfInheritance</span> <span class="p">&gt;</span> <span class="m">1</span> </div><div class='line' id='LC17'><span class="k">where</span> <span class="n">t</span><span class="p">.</span><span class="n">BaseClasses</span><span class="p">.</span><span class="n">Any</span><span class="p">()</span></div><div class='line' id='LC18'><br/></div><div class='line' id='LC19'><span class="c1">// For each methods not overriding any methods (new slot), </span></div><div class='line' id='LC20'><span class="c1">// let&#39;s check if it hides by name some methods defined in base classe.</span></div><div class='line' id='LC21'><span class="k">from</span> <span class="n">m</span> <span class="k">in</span> <span class="n">t</span><span class="p">.</span><span class="n">InstanceMethods</span></div><div class='line' id='LC22'><span class="k">where</span> <span class="n">m</span><span class="p">.</span><span class="n">IsNewSlot</span> <span class="p">&amp;&amp;</span> <span class="p">!</span><span class="n">m</span><span class="p">.</span><span class="n">IsExplicitInterfaceImpl</span> <span class="p">&amp;&amp;</span> <span class="p">!</span><span class="n">m</span><span class="p">.</span><span class="n">IsGeneratedByCompiler</span></div><div class='line' id='LC23'><br/></div><div class='line' id='LC24'><span class="c1">// Notice how lookup is used to quickly retrieve methods with same name as m.</span></div><div class='line' id='LC25'><span class="c1">// This makes the query 10 times faster than iterating each base methods to check their name.</span></div><div class='line' id='LC26'><span class="n">let</span> <span class="n">baseMethodsHidden</span> <span class="p">=</span> <span class="n">lookup</span><span class="p">[</span><span class="n">m</span><span class="p">.</span><span class="n">Name</span><span class="p">].</span><span class="n">Where</span><span class="p">(</span><span class="n">m1</span> <span class="p">=&gt;</span> <span class="n">m1</span> <span class="p">!=</span> <span class="n">m</span> <span class="p">&amp;&amp;</span> <span class="n">t</span><span class="p">.</span><span class="n">DeriveFrom</span><span class="p">(</span><span class="n">m1</span><span class="p">.</span><span class="n">ParentType</span><span class="p">))</span></div><div class='line' id='LC27'><br/></div><div class='line' id='LC28'><span class="k">where</span> <span class="n">baseMethodsHidden</span><span class="p">.</span><span class="n">Count</span><span class="p">()</span> <span class="p">&gt;</span> <span class="m">0</span></div><div class='line' id='LC29'><span class="k">select</span> <span class="k">new</span> <span class="p">{</span> <span class="n">m</span><span class="p">,</span> <span class="n">baseMethodsHidden</span> <span class="p">}</span></div></pre></div>
          </div>

          <div class="gist-meta">
            <a href="https://gist.github.com/raw/2869036/c00c0c97349effb3ec81bca5621e09768010c6ee/gistfile1.cs" style="float:right;">view raw</a>
            <a href="https://gist.github.com/2869036#file_gistfile1.cs" style="float:right;margin-right:10px;color:#666">gistfile1.cs</a>
            <a href="https://gist.github.com/2869036">This Gist</a> brought to you by <a href="http://github.com">GitHub</a>.
          </div>
        </div>
</div>
</noscript>
<p>Another case where HashSet&lt;T&gt; was the key to performance, is the rule <a href="http://www.ndepend.com/DefaultRules/webframe.html?Q_Avoid_naming_types_and_namespaces_with_the_same_identifier.html" target="_blank">Avoid naming types and namespaces with the same identifier</a>. Here we want to match types whose name is also a namespace <em>simple name</em> (for example the <em>simple name</em> of the namespace <em>System.Collections.Generic</em> is <em>Generic</em>) . The fastest approach is to first create a hashset containing all namespaces <em>simple name</em>, and then for each type, check if some namespace share the same name:</p>
<script src="http://gist.github.com/2869440.js"></script><noscript><link rel="stylesheet" href="https://gist.github.com/stylesheets/gist/embed.css"><div id="gist-2869440" class="gist">
    

        <div class="gist-file">
          <div class="gist-data gist-syntax">
              <div class="highlight"><pre><div class='line' id='LC1'><span class="c1">// &lt;Name&gt;Avoid naming types and namespaces with the same identifier&lt;/Name&gt;</span></div><div class='line' id='LC2'><br/></div><div class='line' id='LC3'><span class="c1">// Not only this can provoke compiler resolution collision,</span></div><div class='line' id='LC4'><span class="c1">// but also, this makes code less maintainable because</span></div><div class='line' id='LC5'><span class="c1">// concepts are not concisely identified.</span></div><div class='line' id='LC6'><br/></div><div class='line' id='LC7'><span class="n">warnif</span> <span class="n">count</span> <span class="p">&gt;</span> <span class="m">0</span></div><div class='line' id='LC8'><span class="n">let</span> <span class="n">hashsetShortNames</span> <span class="p">=</span> <span class="n">Namespaces</span><span class="p">.</span><span class="n">Where</span><span class="p">(</span><span class="n">n</span> <span class="p">=&gt;</span> <span class="n">n</span><span class="p">.</span><span class="n">Name</span><span class="p">.</span><span class="n">Length</span> <span class="p">&gt;</span> <span class="m">0</span><span class="p">).</span><span class="n">Select</span><span class="p">(</span><span class="n">n</span> <span class="p">=&gt;</span> <span class="n">n</span><span class="p">.</span><span class="n">SimpleName</span><span class="p">).</span><span class="n">ToHashSet</span><span class="p">()</span></div><div class='line' id='LC9'><br/></div><div class='line' id='LC10'><span class="k">from</span> <span class="n">t</span> <span class="k">in</span> <span class="n">JustMyCode</span><span class="p">.</span><span class="n">Types</span></div><div class='line' id='LC11'><span class="k">where</span> <span class="n">hashsetShortNames</span><span class="p">.</span><span class="n">Contains</span><span class="p">(</span><span class="n">t</span><span class="p">.</span><span class="n">Name</span><span class="p">)</span></div><div class='line' id='LC12'><span class="k">select</span> <span class="k">new</span> <span class="p">{</span> <span class="n">t</span><span class="p">,</span> <span class="n">namespaces</span> <span class="p">=</span> <span class="n">Namespaces</span><span class="p">.</span><span class="n">Where</span><span class="p">(</span><span class="n">n</span> <span class="p">=&gt;</span> <span class="n">n</span><span class="p">.</span><span class="n">SimpleName</span> <span class="p">==</span> <span class="n">t</span><span class="p">.</span><span class="n">Name</span><span class="p">)</span> <span class="p">}</span></div></pre></div>
          </div>

          <div class="gist-meta">
            <a href="https://gist.github.com/raw/2869440/4dfef122e32ee520995bbf9d786194134e349f2c/gistfile1.cs" style="float:right;">view raw</a>
            <a href="https://gist.github.com/2869440#file_gistfile1.cs" style="float:right;margin-right:10px;color:#666">gistfile1.cs</a>
            <a href="https://gist.github.com/2869440">This Gist</a> brought to you by <a href="http://github.com">GitHub</a>.
          </div>
        </div>
</div>
</noscript>
<h1>Tricky Performance Enhancement</h1>
<p>Some rules were pretty tricky to write to achieve acceptable performance. One of them is <a href="http://www.ndepend.com/DefaultRules/webframe.html?Q_Methods_should_be_declared_static_if_possible.html" target="_blank">Methods should be declared static if possible</a>. This rule is especially computation intensive since for each instance method we need to check if it is not using any other instance method or field of its parent type, or any of its base class. Here two optimisations were harnessed:</p>
<ul>
<li>First, we filter types that cannot have instance method to turn into static method (interface, static class, delegates&#8230;). Then we filter methods of selected types (static, abstract, virtual, access the this reference). <strong>Filtering first objects with trivial/<strong>fast-to-check</strong> criterias is the rule of thumb to optimize LINQ queries</strong>.</li>
<li>Second, we call the extension method <a href="http://msdn.microsoft.com/en-en/library/bb340482.aspx" target="_blank">FirstOrDefault()</a> to evaluate as fast as possible if the instance method is calling another instance member. This is a good example where <strong>FirstOrDefault()</strong> can replace and be faster than a call to <strong>Count()</strong> or <strong>Any()</strong>. Many approach were tried here, like first getting all base classes of the parent type and reuse this set accross all members. But the <em>query execution measurer</em> tells us without any doubt that this approach is the fastest one.</li>
</ul>
<script src="http://gist.github.com/2869469.js"></script><noscript><link rel="stylesheet" href="https://gist.github.com/stylesheets/gist/embed.css"><div id="gist-2869469" class="gist">
    

        <div class="gist-file">
          <div class="gist-data gist-syntax">
              <div class="highlight"><pre><div class='line' id='LC1'><span class="c1">// &lt;Name&gt;Methods should be declared static if possible&lt;/Name&gt;</span></div><div class='line' id='LC2'><span class="n">warnif</span> <span class="n">count</span> <span class="p">&gt;</span> <span class="m">0</span></div><div class='line' id='LC3'><br/></div><div class='line' id='LC4'><span class="c1">// When an instance method can be safely declared as static you should declare it as static.</span></div><div class='line' id='LC5'><span class="c1">// Since it doesn&#39;t use any instance data and method of its type and base-types,</span></div><div class='line' id='LC6'><span class="c1">// you should consider if such a method could be moved to a static utility class</span></div><div class='line' id='LC7'><span class="c1">// or if it is strongly related enough to its current declaring type to stay in it.</span></div><div class='line' id='LC8'><span class="c1">//</span></div><div class='line' id='LC9'><span class="c1">// Turning an instance method into a static method is a micro performance optimization</span></div><div class='line' id='LC10'><span class="c1">// since a static method is a bit cheaper to invoke than an instance method.</span></div><div class='line' id='LC11'><br/></div><div class='line' id='LC12'><span class="k">from</span> <span class="n">t</span> <span class="k">in</span> <span class="n">JustMyCode</span><span class="p">.</span><span class="n">Types</span><span class="p">.</span><span class="n">Where</span><span class="p">(</span><span class="n">t</span> <span class="p">=&gt;</span></div><div class='line' id='LC13'>&nbsp;&nbsp;&nbsp;<span class="p">!</span><span class="n">t</span><span class="p">.</span><span class="n">IsStatic</span> <span class="p">&amp;&amp;</span> <span class="p">!</span><span class="n">t</span><span class="p">.</span><span class="n">IsInterface</span> <span class="p">&amp;&amp;</span></div><div class='line' id='LC14'>&nbsp;&nbsp;&nbsp;<span class="p">!</span><span class="n">t</span><span class="p">.</span><span class="n">IsEnumeration</span> <span class="p">&amp;&amp;</span> <span class="p">!</span><span class="n">t</span><span class="p">.</span><span class="n">IsDelegate</span> <span class="p">&amp;&amp;</span></div><div class='line' id='LC15'>&nbsp;&nbsp;&nbsp;<span class="p">!</span><span class="n">t</span><span class="p">.</span><span class="n">IsGeneratedByCompiler</span><span class="p">)</span></div><div class='line' id='LC16'><br/></div><div class='line' id='LC17'><span class="n">let</span> <span class="n">methodsThatCanBeMadeStatic</span> <span class="p">=</span> </div><div class='line' id='LC18'>&nbsp;&nbsp;&nbsp;<span class="k">from</span> <span class="n">m</span> <span class="k">in</span> <span class="n">t</span><span class="p">.</span><span class="n">InstanceMethods</span></div><div class='line' id='LC19'><br/></div><div class='line' id='LC20'>&nbsp;&nbsp;&nbsp;<span class="c1">// An instance method can be turned to static if it is not virtual, </span></div><div class='line' id='LC21'>&nbsp;&nbsp;&nbsp;<span class="c1">// not using the this reference and also, not using</span></div><div class='line' id='LC22'>&nbsp;&nbsp;&nbsp;<span class="c1">// any of its class or base classes instance fields or instance methods.</span></div><div class='line' id='LC23'>&nbsp;&nbsp;&nbsp;<span class="k">where</span> <span class="p">!</span><span class="n">m</span><span class="p">.</span><span class="n">IsAbstract</span> <span class="p">&amp;&amp;</span> <span class="p">!</span><span class="n">m</span><span class="p">.</span><span class="n">IsVirtual</span> <span class="p">&amp;&amp;</span></div><div class='line' id='LC24'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="p">!</span><span class="n">m</span><span class="p">.</span><span class="n">AccessThis</span> <span class="p">&amp;&amp;</span> <span class="p">!</span><span class="n">m</span><span class="p">.</span><span class="n">IsExplicitInterfaceImpl</span> <span class="p">&amp;&amp;</span></div><div class='line' id='LC25'><br/></div><div class='line' id='LC26'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="c1">// Optimization: Using FirstOrDefault() avoid do check all members, </span></div><div class='line' id='LC27'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="c1">//               as soon as one member is found</span></div><div class='line' id='LC28'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="c1">//               we know the method m cannot be made static.</span></div><div class='line' id='LC29'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="n">m</span><span class="p">.</span><span class="n">MembersUsed</span><span class="p">.</span><span class="n">FirstOrDefault</span><span class="p">(</span></div><div class='line' id='LC30'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="n">mUsed</span> <span class="p">=&gt;</span> <span class="p">!</span><span class="n">mUsed</span><span class="p">.</span><span class="n">IsStatic</span> <span class="p">&amp;&amp;</span> </div><div class='line' id='LC31'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="p">(</span><span class="n">mUsed</span><span class="p">.</span><span class="n">ParentType</span> <span class="p">==</span> <span class="n">t</span> <span class="p">||</span> </div><div class='line' id='LC32'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="n">t</span><span class="p">.</span><span class="n">DeriveFrom</span><span class="p">(</span><span class="n">mUsed</span><span class="p">.</span><span class="n">ParentType</span><span class="p">))</span></div><div class='line' id='LC33'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="p">)</span> <span class="p">==</span> <span class="k">null</span> </div><div class='line' id='LC34'>&nbsp;&nbsp;&nbsp;<span class="k">select</span> <span class="n">m</span></div><div class='line' id='LC35'><br/></div><div class='line' id='LC36'><span class="k">from</span> <span class="n">m</span> <span class="k">in</span> <span class="n">methodsThatCanBeMadeStatic</span></div><div class='line' id='LC37'><span class="n">let</span> <span class="n">staticFieldsUsed</span> <span class="p">=</span> <span class="n">m</span><span class="p">.</span><span class="n">ParentType</span><span class="p">.</span><span class="n">StaticFields</span><span class="p">.</span><span class="n">UsedBy</span><span class="p">(</span><span class="n">m</span><span class="p">).</span><span class="n">Where</span><span class="p">(</span><span class="n">f</span> <span class="p">=&gt;</span> <span class="p">!</span><span class="n">f</span><span class="p">.</span><span class="n">IsGeneratedByCompiler</span><span class="p">)</span></div><div class='line' id='LC38'><span class="k">select</span> <span class="k">new</span> <span class="p">{</span> <span class="n">m</span><span class="p">,</span> <span class="n">staticFieldsUsed</span> <span class="p">}</span></div></pre></div>
          </div>

          <div class="gist-meta">
            <a href="https://gist.github.com/raw/2869469/19f40693bc36a28e80a73f29cf06d0e2b681a323/gistfile1.cs" style="float:right;">view raw</a>
            <a href="https://gist.github.com/2869469#file_gistfile1.cs" style="float:right;margin-right:10px;color:#666">gistfile1.cs</a>
            <a href="https://gist.github.com/2869469">This Gist</a> brought to you by <a href="http://github.com">GitHub</a>.
          </div>
        </div>
</div>
</noscript>
<h1>LINQ Expression and Performances</h1>
<p>Before compiling a CQLinq query with the C# compiler, we&#8217;ve included a smart preprocessor that solves in a variety of cases, the classic dilemma <em>readability vs. performance</em>. For example, if you wish to use a regular expression in your query, it is tedious to first create and compile your regular expression object, and then use it. It would be more readable to create, compile and use the regular expression in the same code spot, but it would be terrific for performance if this code spot is in a loop.</p>
<p>This is why when calling methods like <a href="http://www.ndepend.com/API/webframe.html?NDepend.API~NDepend.Reserved.CQLinq.ExtensionMethodsCQLinqNaming~NameLike.html" target="_blank">NameLike()</a> like for example, in the rule below, <a href="http://www.ndepend.com/DefaultRules/webframe.html?Q_Methods_name_should_begin_with_an_Upper_character.html" target="_blank">Methods name should begin with an Upper character</a>, the CQLinq preprocessor transforms the LINQ expression to:</p>
<ol>
<li>relieve the user from creating and compiling the regular expressions.</li>
<li>make sure that the regular expression is created and compiled just once.</li>
</ol>
<script src="http://gist.github.com/2869227.js"></script><noscript><link rel="stylesheet" href="https://gist.github.com/stylesheets/gist/embed.css"><div id="gist-2869227" class="gist">
    
        <div class="gist-file">
          <div class="gist-data gist-syntax">
              <div class="highlight"><pre><div class='line' id='LC1'><span class="c1">// &lt;Name&gt;Methods name should begin with an Upper character&lt;/Name&gt;</span></div><div class='line' id='LC2'><span class="n">warnif</span> <span class="n">count</span> <span class="p">&gt;</span> <span class="m">0</span> <span class="k">from</span> <span class="n">m</span> <span class="k">in</span> <span class="n">JustMyCode</span><span class="p">.</span><span class="n">Methods</span> <span class="k">where</span> </div><div class='line' id='LC3'>&nbsp;&nbsp;<span class="p">!</span><span class="n">m</span><span class="p">.</span><span class="n">NameLike</span> <span class="p">(</span><span class="s">@&quot;^[A-Z]&quot;</span><span class="p">)</span> <span class="p">&amp;&amp;</span> </div><div class='line' id='LC4'>&nbsp;&nbsp;<span class="p">!</span><span class="n">m</span><span class="p">.</span><span class="n">IsSpecialName</span> <span class="p">&amp;&amp;</span> </div><div class='line' id='LC5'>&nbsp;&nbsp;<span class="p">!</span><span class="n">m</span><span class="p">.</span><span class="n">IsGeneratedByCompiler</span></div><div class='line' id='LC6'><span class="k">select</span> <span class="n">m</span></div><div class='line' id='LC7'><br/></div><div class='line' id='LC8'><span class="c1">// The name of a regular method should </span></div><div class='line' id='LC9'><span class="c1">// begin with an Upper letter.</span></div></pre></div>
          </div>

          <div class="gist-meta">
            <a href="https://gist.github.com/raw/2869227/727134490c0e147e456f58deb9dcdc7474b36be3/gistfile1.cs" style="float:right;">view raw</a>
            <a href="https://gist.github.com/2869227#file_gistfile1.cs" style="float:right;margin-right:10px;color:#666">gistfile1.cs</a>
            <a href="https://gist.github.com/2869227">This Gist</a> brought to you by <a href="http://github.com">GitHub</a>.
          </div>
        </div>
</div>
</noscript>
<p>This particular <em>LINQ expression</em> <em>magic trick</em> has been used extensively to make many rules both more readable and more performant. This is why we&#8217;ve created the dedicated namespace <a href="http://www.ndepend.com/API/webframe.html?NDepend.API~NDepend.Reserved.CQLinq_namespace.html" target="_blank">NDepend.Reserved.CQLinq</a> that contains these methods whose calls are transformed by the CQLinq preprocessor. Obviously these methods shouldn&#8217;t be used from a program that relies on NDepend.API since in this situation, there is no CQLinq preprocessor.</p>
<h1>A Word on Time-Out</h1>
<p>On a related topic, we&#8217;ve also implemented a tunable time-out set to 2 seconds by default for CQLinq query execution. Internally, the time-out manager code is based on this <a href="https://github.com/Lokad/lokad-shared-libraries/blob/master/Source/Lokad.Shared/Threading/WaitFor.cs" target="_blank">great piece of OSS</a> code that is concise, elegant, efficient and AFAIK bug-free.</p>
<h1>Conclusion</h1>
<p>Clearly pretty much any <em>realistic</em> performance goal is reachable with a <em>sufficient </em>amount of effort. One more time, with a lot of effort we&#8217;ve verified this tenet.</p>
<p>We can observe the same gain on the Visual Studio side. VS2010 was so slower than VS2008 that personally, I never really upgraded to VS2010. But having used VS2012 Beta and RC for months, I can attest that the performance boost is huge. I can&#8217;t wait to upgrade all our dev from VS2008 to VS2012 RTM <img src='http://cdn1.codebetter.com/wp-includes/images/smilies/icon_smile.gif' alt=':)' class='wp-smiley' /> </p>
]]></content:encoded>
			<wfw:commentRss>http://codebetter.com/patricksmacchia/2012/06/05/linq-performance-some-case-studies-2/feed/</wfw:commentRss>
		<slash:comments>2</slash:comments>
		</item>
		<item>
		<title>Code Query and Rule over LINQ</title>
		<link>http://codebetter.com/patricksmacchia/2012/05/24/code-query-and-rule-over-linq/</link>
		<comments>http://codebetter.com/patricksmacchia/2012/05/24/code-query-and-rule-over-linq/#comments</comments>
		<pubDate>Thu, 24 May 2012 16:52:42 +0000</pubDate>
		<dc:creator>Patrick Smacchia</dc:creator>
				<category><![CDATA[Code Query]]></category>
		<category><![CDATA[Code Rule]]></category>
		<category><![CDATA[CQLinq]]></category>
		<category><![CDATA[NDepend]]></category>
		<category><![CDATA[Object oriented programming]]></category>
		<category><![CDATA[VS Integration]]></category>

		<guid isPermaLink="false">http://codebetter.com/patricksmacchia/?p=525</guid>
		<description><![CDATA[Yesterday, after two years of a relentless development effort, we finally released NDepend v4. Personally, I consider this version as the biggest milestone we&#8217;ve ever achieved. The three flagship features are: Code query and rule over LINQ (CQLinq) NDepend.API to&#160;&#8230; <a href="http://codebetter.com/patricksmacchia/2012/05/24/code-query-and-rule-over-linq/">Continue&#160;reading&#160;<span class="meta-nav">&#8594;</span></a>]]></description>
			<content:encoded><![CDATA[<p>Yesterday, after two years of a relentless development effort, we finally released NDepend v4. Personally, I consider this version as the biggest milestone we&#8217;ve ever achieved. The three flagship features are:</p>
<ul>
<li>Code query and rule over LINQ (<strong>CQLinq</strong>)</li>
<li><strong>NDepend.API</strong> to let user develop its own static analyzers (+14 OSS Power Tools proposed on top of NDepend.API)</li>
<li>VS11 addin support</li>
</ul>
<p>Developing these features by respecting the following drastic requirements was a real challenge:</p>
<ul>
<li><strong><a href="http://www.ndepend.com/Doc_CQLinq_Features.aspx" target="_blank">Features Richness</a></strong>: The code query features set was already rich in prior versions, but we wanted it to be even richer to be able to write easily all the code queries and rules that existing users asked us.</li>
<li><strong><a href="http://www.ndepend.com/Doc_CQLinq_Syntax.aspx" target="_blank">Syntax</a></strong>: Queries must be easy to write and to read. Hopefully most NDepend users are aware of the C# LINQ syntax, but the proposed code model API needs to be LINQ-friendly. We started with a three months research effort to define what was the cleanest syntax to express a few dozens of <em>essential</em> code queries. A few natural syntax enhancements were also developed (like the prefix <strong>warnif count &gt; 0</strong> to transform a code query into a code rule).</li>
<li><strong><a href="http://www.ndepend.com/Doc_CQLinq_Perf.aspx" target="_blank">Performance</a></strong>: We wanted something like a hundred of queries compiled and executed per second against a large real-world code base, because we want them to be run often in VS without slowing down the IDE.</li>
<li><strong>Usability</strong>: We wanted query edition to be seamless thanks to code completion, live tooltip documentation and detailed error reporting.  All this without the <a href="http://codebetter.com/patricksmacchia/2011/10/20/roslyn-ctp-is-available/" target="_blank">Roslyn</a> power that is not yet RTM. Also, for v3 users, we&#8217;ve developed a CQL to CQLinq automatic converter (and CQL is still supported).</li>
</ul>
<p>One simple CQLinq code rule that illustrates well all these, is the following one.</p>
<script src="http://gist.github.com/2781941.js"></script><noscript><link rel="stylesheet" href="https://gist.github.com/stylesheets/gist/embed.css"><div id="gist-2781941" class="gist">
    
        <div class="gist-file">
          <div class="gist-data gist-syntax">
              <div class="highlight"><pre><div class='line' id='LC1'><span class="c1">// &lt;Name&gt;Base class should not use derivatives&lt;/Name&gt;</span></div><div class='line' id='LC2'><span class="n">warnif</span> <span class="n">count</span> <span class="p">&gt;</span> <span class="m">0</span> </div><div class='line' id='LC3'><span class="k">from</span> <span class="n">baseClass</span> <span class="k">in</span> <span class="n">JustMyCode</span><span class="p">.</span><span class="n">Types</span></div><div class='line' id='LC4'><span class="k">where</span> <span class="n">baseClass</span><span class="p">.</span><span class="n">IsClass</span> <span class="p">&amp;&amp;</span> <span class="n">baseClass</span><span class="p">.</span><span class="n">NbChildren</span> <span class="p">&gt;</span> <span class="m">0</span> <span class="c1">// &lt;-- for optimization!</span></div><div class='line' id='LC5'><span class="n">let</span> <span class="n">derivedClassesUsed</span> <span class="p">=</span> <span class="n">baseClass</span><span class="p">.</span><span class="n">DerivedTypes</span><span class="p">.</span><span class="n">UsedBy</span><span class="p">(</span><span class="n">baseClass</span><span class="p">)</span></div><div class='line' id='LC6'><span class="k">where</span> <span class="n">derivedClassesUsed</span><span class="p">.</span><span class="n">Count</span><span class="p">()</span> <span class="p">&gt;</span> <span class="m">0</span></div><div class='line' id='LC7'><span class="k">select</span> <span class="k">new</span> <span class="p">{</span> <span class="n">baseClass</span><span class="p">,</span> <span class="n">derivedClassesUsed</span> <span class="p">}</span></div></pre></div>
          </div>

          <div class="gist-meta">
            <a href="https://gist.github.com/raw/2781941/fa8d3e10cfed53b924e5b04fe70b6d56f277c4b1/gistfile1.cs" style="float:right;">view raw</a>
            <a href="https://gist.github.com/2781941#file_gistfile1.cs" style="float:right;margin-right:10px;color:#666">gistfile1.cs</a>
            <a href="https://gist.github.com/2781941">This Gist</a> brought to you by <a href="http://github.com">GitHub</a>.
          </div>
        </div>
</div>
</noscript>
<p>Hopefully the syntax is simple enough to convey the underlying meaning to any .NET developer. Only the <a href="http://www.ndepend.com/Doc_CQLinq_Syntax.aspx#NotMyCode" target="_blank">JustMyCode</a> highlighted word might not be clear. It represents a facility proposed to avoid matching generated code elements, that often are pesky false positive matches for code rules.</p>
<p>After  an instantaneous compilation/execution phase (1 millisecond), the result is displayed with facilities for browsing it and exporting it:</p>
<p><a href="http://codebetter.com/patricksmacchia/files/2012/05/CQLinq_Overview1.png"><img class="alignnone size-full wp-image-542" src="http://codebetter.com/patricksmacchia/files/2012/05/CQLinq_Overview1.png" alt="" width="445" height="717" /></a></p>
<p>Today, I&#8217;d like to focus a bit more on the syntax aspect. Developing for LINQ and with LINQ during the last two years has been a great joy. Everybody agrees that LINQ is <em>very</em> elegant, but it is also a super-extensible technology.</p>
<p>We extended LINQ in several different ways. One way has been to develop a LINQ-friendly <a href="http://en.wikipedia.org/wiki/Fluent_interface" target="_blank">fluent API</a>. Often we found convenient to write default code rules with a mix of both <a href="http://www.ndepend.com/Doc_CQLinq_Syntax.aspx#OperatorsExpressions" target="_blank">Query Expression and Query Operator</a> syntaxes. Takes the following rule for example.</p>
<script src="http://gist.github.com/2781949.js"></script><noscript><link rel="stylesheet" href="https://gist.github.com/stylesheets/gist/embed.css"><div id="gist-2781949" class="gist">
    

        <div class="gist-file">
          <div class="gist-data gist-syntax">
              <div class="highlight"><pre><div class='line' id='LC1'>// &lt;Name&gt;UI layer shouldn&#39;t use directly DB types&lt;/Name&gt;</div><div class='line' id='LC2'>warnif count &gt; 0</div><div class='line' id='LC3'><br/></div><div class='line' id='LC4'>// UI layer is made of types in namespaces using a UI framework</div><div class='line' id='LC5'>let uiTypes = Application.Namespaces.UsingAny(</div><div class='line' id='LC6'>&nbsp;&nbsp;&nbsp;Assemblies.WithNameIn(&quot;PresentationFramework&quot;, &quot;System.Windows&quot;, </div><div class='line' id='LC7'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;System.Windows.Forms&quot;, &quot;System.Web&quot;)</div><div class='line' id='LC8'>).ChildTypes()</div><div class='line' id='LC9'><br/></div><div class='line' id='LC10'>// You can easily customize this line to define what are DB types.</div><div class='line' id='LC11'>let dbTypes = ThirdParty.Assemblies.WithNameIn(&quot;System.Data&quot;, &quot;EntityFramework&quot;, </div><div class='line' id='LC12'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;NHibernate&quot;).ChildTypes()</div><div class='line' id='LC13'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// Ideally even DataSet and associated, usage should be forbidden from UI layer: </div><div class='line' id='LC14'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// http://stackoverflow.com/questions/1708690/is-list-better-than-dataset-for-ui-layer-in-asp-net</div><div class='line' id='LC15'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.Except(Types.WithNameIn(&quot;DataSet&quot;, &quot;DataTable&quot;, &quot;DataRow&quot;))</div><div class='line' id='LC16'><br/></div><div class='line' id='LC17'>from uiType in uiTypes.UsingAny(dbTypes)</div><div class='line' id='LC18'>let dbTypesUsed = dbTypes.Intersect(uiType.TypesUsed)</div><div class='line' id='LC19'>select new { uiType, dbTypesUsed }</div></pre></div>
          </div>

          <div class="gist-meta">
            <a href="https://gist.github.com/raw/2781949/9eba86accad5cd4b914b104e57c63e36bbb8b38a/gistfile1.txt" style="float:right;">view raw</a>
            <a href="https://gist.github.com/2781949#file_gistfile1.txt" style="float:right;margin-right:10px;color:#666">gistfile1.txt</a>
            <a href="https://gist.github.com/2781949">This Gist</a> brought to you by <a href="http://github.com">GitHub</a>.
          </div>
        </div>
</div>
</noscript>
<ul>
<li>First, we define with two fluent sub-queries (<em>expressed with the operator syntax</em>)  the UI layer (<em>types in namespaces using any UI framework</em>) and the DB layer (<em>types in namespaces using any DB framework</em>)</li>
<li>Then we use more fluent query operator syntax to check if the UI layer is using the DB layer.</li>
<li>Finally the whole query is structured with the query expression syntax.</li>
</ul>
<p>In a few lines of code, we are expressing fluently a pretty complex and popular requirement, in a generic way adaptable to any situations.</p>
<p>For a few years now, the code metric C.R.A.P (Change Risk Analyzer and Predictor) became increasingly popular in the Java community thanks to the <a href="http://www.crap4j.org/" target="_blank">crap4J plugin</a>. The C.R.A.P metric has been exposed by <em>Alberto Savoia</em> in this <a href="http://www.artima.com/weblogs/viewpost.jsp?thread=215899" target="_blank">Artima article</a> dated from October 2007. The C.R.A.P metric is a mathematical formula that helps to determine which piece of code is <em>both</em> complex and poorly covered by tests. Since both <em>code coverage</em> and <em>cyclomatic complexity</em> code metrics are proposed by the NDepend.API code model, it is fairly easy to write a CQLinq code rule to match <em>crappy </em>code:</p>
<script src="http://gist.github.com/2781932.js"></script><noscript><link rel="stylesheet" href="https://gist.github.com/stylesheets/gist/embed.css"><div id="gist-2781932" class="gist">
    
        <div class="gist-file">
          <div class="gist-data gist-syntax">
              <div class="highlight"><pre><div class='line' id='LC1'><span class="c1">// &lt;Name&gt;C.R.A.P method code metric&lt;/Name&gt;</span></div><div class='line' id='LC2'><span class="c1">// Change Risk Analyzer and Predictor (i.e. CRAP) code metric</span></div><div class='line' id='LC3'><span class="c1">// This code metric helps in pinpointing overly complex and untested code.</span></div><div class='line' id='LC4'><span class="c1">// Reference: http://www.artima.com/weblogs/viewpost.jsp?thread=215899</span></div><div class='line' id='LC5'><span class="c1">// Formula:   CRAP(m) = comp(m)^2 * (1 – cov(m)/100)^3 + comp(m)</span></div><div class='line' id='LC6'><span class="n">warnif</span> <span class="n">count</span> <span class="p">&gt;</span> <span class="m">0</span></div><div class='line' id='LC7'><span class="k">from</span> <span class="n">m</span> <span class="k">in</span> <span class="n">JustMyCode</span><span class="p">.</span><span class="n">Methods</span></div><div class='line' id='LC8'><br/></div><div class='line' id='LC9'><span class="c1">// Don&#39;t match too short methods</span></div><div class='line' id='LC10'><span class="k">where</span> <span class="n">m</span><span class="p">.</span><span class="n">NbLinesOfCode</span> <span class="p">&gt;</span> <span class="m">10</span></div><div class='line' id='LC11'><br/></div><div class='line' id='LC12'><span class="n">let</span> <span class="n">CC</span> <span class="p">=</span> <span class="n">m</span><span class="p">.</span><span class="n">CyclomaticComplexity</span></div><div class='line' id='LC13'><span class="n">let</span> <span class="n">uncov</span> <span class="p">=</span> <span class="p">(</span><span class="m">100</span> <span class="p">-</span> <span class="n">m</span><span class="p">.</span><span class="n">PercentageCoverage</span><span class="p">)</span> <span class="p">/</span> <span class="m">100f</span></div><div class='line' id='LC14'><span class="n">let</span> <span class="n">CRAP</span> <span class="p">=</span> <span class="p">(</span><span class="n">CC</span> <span class="p">*</span> <span class="n">CC</span> <span class="p">*</span> <span class="n">uncov</span> <span class="p">*</span> <span class="n">uncov</span> <span class="p">*</span> <span class="n">uncov</span><span class="p">)</span> <span class="p">+</span> <span class="n">CC</span></div><div class='line' id='LC15'><span class="k">where</span> <span class="n">CRAP</span> <span class="p">!=</span> <span class="k">null</span> <span class="p">&amp;&amp;</span> <span class="n">CRAP</span> <span class="p">&gt;</span> <span class="m">30</span></div><div class='line' id='LC16'><span class="k">orderby</span> <span class="n">CRAP</span> <span class="k">descending</span><span class="p">,</span> <span class="n">m</span><span class="p">.</span><span class="n">NbLinesOfCode</span> <span class="k">descending</span></div><div class='line' id='LC17'><span class="k">select</span> <span class="k">new</span> <span class="p">{</span> <span class="n">m</span><span class="p">,</span> <span class="n">CRAP</span><span class="p">,</span> <span class="n">CC</span><span class="p">,</span> <span class="n">uncoveredPercentage</span> <span class="p">=</span> <span class="n">uncov</span><span class="p">*</span><span class="m">100</span><span class="p">,</span> <span class="n">m</span><span class="p">.</span><span class="n">NbLinesOfCode</span> <span class="p">}</span></div></pre></div>
          </div>

          <div class="gist-meta">
            <a href="https://gist.github.com/raw/2781932/7ca26f81ffbb9507eead9d06ca3271943feb923d/gistfile1.cs" style="float:right;">view raw</a>
            <a href="https://gist.github.com/2781932#file_gistfile1.cs" style="float:right;margin-right:10px;color:#666">gistfile1.cs</a>
            <a href="https://gist.github.com/2781932">This Gist</a> brought to you by <a href="http://github.com">GitHub</a>.
          </div>
        </div>
</div>
</noscript>
<p>A popular feature of NDepend is the ability to diff two snapshots of a code base to explore what was changed. This feature being completely integrated with CQLinq, it is now possible to write <em>simple</em> code queries that will match <em>complex</em> evolution requirements. One immediate requirement that comes to my mind, is that a class 100% covered by tests should remain 100% covered by tests, no matter whether it has been touched or not. The following CQLinq code rule detects classes that are not anymore 100% covered by tests (since the predefined <em>base-line</em>), and lists the <em>culprit</em> methods, i.e the method that are not 100% covered anymore:</p>
<script src="http://gist.github.com/2781961.js"></script><noscript><link rel="stylesheet" href="https://gist.github.com/stylesheets/gist/embed.css"><div id="gist-2781961" class="gist">
    

        <div class="gist-file">
          <div class="gist-data gist-syntax">
              <div class="highlight"><pre><div class='line' id='LC1'><span class="c1">// &lt;Name&gt;Types that used to be 100% covered but not anymore&lt;/Name&gt;</span></div><div class='line' id='LC2'><span class="n">warnif</span> <span class="n">count</span> <span class="p">&gt;</span> <span class="m">0</span></div><div class='line' id='LC3'><span class="k">from</span> <span class="n">t</span> <span class="k">in</span> <span class="n">JustMyCode</span><span class="p">.</span><span class="n">Types</span> <span class="k">where</span> </div><div class='line' id='LC4'>&nbsp;&nbsp;&nbsp;<span class="n">t</span><span class="p">.</span><span class="n">IsPresentInBothBuilds</span><span class="p">()</span> <span class="p">&amp;&amp;</span></div><div class='line' id='LC5'>&nbsp;&nbsp;&nbsp;<span class="n">t</span><span class="p">.</span><span class="n">OlderVersion</span><span class="p">().</span><span class="n">PercentageCoverage</span> <span class="p">==</span> <span class="m">100</span> <span class="p">&amp;&amp;</span></div><div class='line' id='LC6'>&nbsp;&nbsp;&nbsp;<span class="n">t</span><span class="p">.</span><span class="n">PercentageCoverage</span> <span class="p">&lt;</span> <span class="m">100</span></div><div class='line' id='LC7'><span class="n">let</span> <span class="n">culpritMethods</span> <span class="p">=</span> <span class="n">t</span><span class="p">.</span><span class="n">Methods</span><span class="p">.</span><span class="n">Where</span><span class="p">(</span><span class="n">m</span> <span class="p">=&gt;</span> <span class="n">m</span><span class="p">.</span><span class="n">PercentageCoverage</span> <span class="p">&lt;</span> <span class="m">100</span><span class="p">)</span></div><div class='line' id='LC8'><span class="k">select</span> <span class="k">new</span> <span class="p">{</span><span class="n">t</span><span class="p">,</span> <span class="n">t</span><span class="p">.</span><span class="n">PercentageCoverage</span><span class="p">,</span> <span class="n">culpritMethods</span> <span class="p">}</span></div></pre></div>
          </div>

          <div class="gist-meta">
            <a href="https://gist.github.com/raw/2781961/8f9a700ab6dddfd1083d21db38f7d082233de869/gistfile1.cs" style="float:right;">view raw</a>
            <a href="https://gist.github.com/2781961#file_gistfile1.cs" style="float:right;margin-right:10px;color:#666">gistfile1.cs</a>
            <a href="https://gist.github.com/2781961">This Gist</a> brought to you by <a href="http://github.com">GitHub</a>.
          </div>
        </div>
</div>
</noscript>
<p>Hopefully CQLinq is a simple answer to many requirements that formerly demanded significant efforts (imagine the effort to develop the tool crap4J compared to the effort of writing a single CQLinq query). You can <a href="http://www.ndepend.com/NDependV4.aspx" target="_blank">download freely and try</a> CQLinq live on your code base, and here you can browse all <a href="http://www.ndepend.com/DefaultRules/webframe.html" target="_blank">200 default code rules</a>.</p>
<p>In future posts I&#8217;ll dig into the low-level implementation tricks needed to implement all this.</p>
]]></content:encoded>
			<wfw:commentRss>http://codebetter.com/patricksmacchia/2012/05/24/code-query-and-rule-over-linq/feed/</wfw:commentRss>
		<slash:comments>2</slash:comments>
		</item>
		<item>
		<title>On Writing Unit Tests for C#</title>
		<link>http://codebetter.com/patricksmacchia/2012/03/19/on-writing-unit-tests-for-c/</link>
		<comments>http://codebetter.com/patricksmacchia/2012/03/19/on-writing-unit-tests-for-c/#comments</comments>
		<pubDate>Mon, 19 Mar 2012 13:15:06 +0000</pubDate>
		<dc:creator>Patrick Smacchia</dc:creator>
				<category><![CDATA[Uncategorized]]></category>

		<guid isPermaLink="false">http://codebetter.com/patricksmacchia/?p=523</guid>
		<description><![CDATA[My recent blog post Non-trivial and real-world feedbacks on writing Unit-Tests has been rewritten in depth with the help of the SimpleTalk team, and published on SimpleTalk as an article: On Writing Unit Tests for C# This article has been an opportunity&#160;&#8230; <a href="http://codebetter.com/patricksmacchia/2012/03/19/on-writing-unit-tests-for-c/">Continue&#160;reading&#160;<span class="meta-nav">&#8594;</span></a>]]></description>
			<content:encoded><![CDATA[<p>My recent blog post <a href="http://codebetter.com/patricksmacchia/2012/01/10/non-trivial-and-real-world-feedbacks-on-writing-unit-tests/" target="_blank">Non-trivial and real-world feedbacks on writing Unit-Tests</a> has been rewritten in depth with the help of the SimpleTalk team, and published on SimpleTalk as an article: <a href="http://www.simple-talk.com/dotnet/.net-framework/on-writing-unit-tests-for-c/" target="_blank">On Writing Unit Tests for C#</a></p>
<p>This article has been an opportunity for me to dig deeper into several aspects of my experience with real-world unit-testing, especially concerning the Test-First and code coverage sections. The critics and feedbacks I got from the initial post has helped also rewriting this as a more insightful content.</p>
<p>Enjoy!</p>
]]></content:encoded>
			<wfw:commentRss>http://codebetter.com/patricksmacchia/2012/03/19/on-writing-unit-tests-for-c/feed/</wfw:commentRss>
		<slash:comments>0</slash:comments>
		</item>
	</channel>
</rss>

<!-- Dynamic page generated in 22.100 seconds. -->
<!-- Cached page generated by WP-Super-Cache on 2012-11-09 23:21:34 -->
